<!DOCTYPE html>
<html class="no-js" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="浙江大学操作系统课程实验指导" name="description"/>
<meta content="浙江大学计算机科学与技术学院" name="author"/>
<link href="https://zju-os.github.io/doc/lab2/" rel="canonical"/>
<link href="../lab1/" rel="prev"/>
<link href="../lab3/" rel="next"/>
<link href="../assets/zjueagle.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.22" name="generator"/>
<title>Lab 2：抢占式内核线程调度 - ZJU OS</title>
<link href="../assets/stylesheets/main.84d31ad4.min.css" rel="stylesheet"/>
<link href="../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../css/timeago.css" rel="stylesheet"/>
<link href="../stylesheets/fonts.css" rel="stylesheet"/>
<link href="../stylesheets/counter.css" rel="stylesheet"/>
<link href="../stylesheets/neoteroi-v1.1.2.css" rel="stylesheet"/>
<script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<link href="../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><script src="../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
<body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#lab-2抢占式内核线程调度">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="ZJU OS" class="md-header__button md-logo" data-md-component="logo" href=".." title="ZJU OS">
<img alt="logo" src="../assets/zjueagle_white.svg"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            ZJU OS
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Lab 2：抢占式内核线程调度
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="indigo" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<a aria-label="Share" class="md-search__icon md-icon" data-clipboard="" data-clipboard-text="" data-md-component="search-share" href="javascript:void(0)" tabindex="-1" title="Share">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"></path></svg>
</a>
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/ZJU-OS/doc" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    ZJU-OS/doc
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="ZJU OS" class="md-nav__button md-logo" data-md-component="logo" href=".." title="ZJU OS">
<img alt="logo" src="../assets/zjueagle_white.svg"/>
</a>
    ZJU OS
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/ZJU-OS/doc" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    ZJU-OS/doc
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="..">
<span class="md-ellipsis">
    首页
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
<span class="md-ellipsis">
    实验文档
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            实验文档
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../manual/">
<span class="md-ellipsis">
    实验流程及工具讲解
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../lab0/">
<span class="md-ellipsis">
    Lab 0: Linux 内核调试
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../lab1/">
<span class="md-ellipsis">
    Lab 1：内核启动与时钟中断
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Lab 2：抢占式内核线程调度
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    Lab 2：抢占式内核线程调度
    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#实验简介">
<span class="md-ellipsis">
      实验简介
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#part-0环境配置">
<span class="md-ellipsis">
      Part 0：环境配置
    </span>
</a>
<nav aria-label="Part 0：环境配置" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#更新代码">
<span class="md-ellipsis">
      更新代码
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#更新镜像">
<span class="md-ellipsis">
      更新镜像
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#part-1内存管理">
<span class="md-ellipsis">
      Part 1：内存管理
    </span>
</a>
<nav aria-label="Part 1：内存管理" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#物理内存空间">
<span class="md-ellipsis">
      物理内存空间
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#buddy-system">
<span class="md-ellipsis">
      Buddy System
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#侵入式双向循环链表">
<span class="md-ellipsis">
      侵入式双向循环链表
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#task-1实现双向链表">
<span class="md-ellipsis">
      Task 1：实现双向链表
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#空闲链表缓存">
<span class="md-ellipsis">
      空闲链表缓存
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#part-2进程切换与-trap-处理">
<span class="md-ellipsis">
      Part 2：进程切换与 Trap 处理
    </span>
</a>
<nav aria-label="Part 2：进程切换与 Trap 处理" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#进程切换非抢占情况">
<span class="md-ellipsis">
      进程切换：非抢占情况
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#进程切换抢占与-trap-处理">
<span class="md-ellipsis">
      进程切换：抢占与 Trap 处理
    </span>
</a>
<nav aria-label="进程切换：抢占与 Trap 处理" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#切换调度trap-与抢占的关系">
<span class="md-ellipsis">
      切换、调度、Trap 与抢占的关系
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#内核中不能被-trap-的部分">
<span class="md-ellipsis">
      内核中不能被 Trap 的部分
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#抢占的时机">
<span class="md-ellipsis">
      抢占的时机
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#进程切换引入并发">
<span class="md-ellipsis">
      进程切换：引入并发
    </span>
</a>
<nav aria-label="进程切换：引入并发" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#例子-1内核数据结构">
<span class="md-ellipsis">
      例子 1：内核数据结构
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#例子-2进程切换过程">
<span class="md-ellipsis">
      例子 2：进程切换过程
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#讨论所有切换情况">
<span class="md-ellipsis">
      讨论所有切换情况
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#进程数据结构和内存布局">
<span class="md-ellipsis">
      进程数据结构和内存布局
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#task-2设置初始进程">
<span class="md-ellipsis">
      Task 2：设置初始进程
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#part-3进程生命周期">
<span class="md-ellipsis">
      Part 3：进程生命周期
    </span>
</a>
<nav aria-label="Part 3：进程生命周期" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#进程复制与加载">
<span class="md-ellipsis">
      进程复制与加载
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#task-3实现进程复制与加载">
<span class="md-ellipsis">
      Task 3：实现进程复制与加载
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#进程退出与销毁">
<span class="md-ellipsis">
      进程退出与销毁
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#part-4调度器">
<span class="md-ellipsis">
      Part 4：调度器
    </span>
</a>
<nav aria-label="Part 4：调度器" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#时间片轮转调度">
<span class="md-ellipsis">
      时间片轮转调度
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#task-4实现时间片轮转调度和抢占">
<span class="md-ellipsis">
      Task 4：实现时间片轮转调度和抢占
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#结语lab2-和-linux-调度器的历史">
<span class="md-ellipsis">
      结语：Lab2 和 Linux 调度器的历史
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../lab3/">
<span class="md-ellipsis">
    Lab 3：Sv39 分页式虚拟内存系统
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../z1-spike/">
<span class="md-ellipsis">
    附录 1：Spike 工具链
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
<span class="md-ellipsis">
    RISC-V 规范
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            RISC-V 规范
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../spec/riscv-privileged.html">
<span class="md-ellipsis">
    特权级规范
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../spec/riscv-unprivileged.html">
<span class="md-ellipsis">
    非特权级规范
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../spec/riscv-abi.pdf">
<span class="md-ellipsis">
    ELF ABI 规范
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../spec/riscv-sbi.pdf">
<span class="md-ellipsis">
    SBI 规范
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../spec/riscv-asm.pdf">
<span class="md-ellipsis">
    汇编规范
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="https://riscv-programming.org/">
<span class="md-ellipsis">
    汇编教程
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
<span class="md-ellipsis">
    工具文档
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            工具文档
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="https://www.qemu.org/docs/master/index.html">
<span class="md-ellipsis">
    QEMU
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="https://sourceware.org/gdb/current/onlinedocs/gdb">
<span class="md-ellipsis">
    GDB
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="https://gcc.gnu.org/onlinedocs/">
<span class="md-ellipsis">
    GCC
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="https://sourceware.org/binutils/docs/as">
<span class="md-ellipsis">
    as
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="https://sourceware.org/binutils/docs/ld">
<span class="md-ellipsis">
    ld
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="https://sourceware.org/binutils/docs/binutils">
<span class="md-ellipsis">
    binutils
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
<span class="md-ellipsis">
    源码仓库
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            源码仓库
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="https://github.com/torvalds/linux">
<span class="md-ellipsis">
    Linux (GitHub)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="https://elixir.bootlin.com/">
<span class="md-ellipsis">
    Linux (Cross Referencer)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="https://github.com/riscv-software-src/opensbi">
<span class="md-ellipsis">
    OpenSBI
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="https://github.com/qemu/qemu/">
<span class="md-ellipsis">
    QEMU
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
<span class="md-ellipsis">
    助教文档
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
            助教文档
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../ta/autograder/">
<span class="md-ellipsis">
    评测框架
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ta/dev/">
<span class="md-ellipsis">
    源代码管理
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ta/tool/">
<span class="md-ellipsis">
    辅助工具
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_6_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_6_4" id="__nav_6_4_label" tabindex="0">
<span class="md-ellipsis">
    blog
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_6_4">
<span class="md-nav__icon md-icon"></span>
            blog
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../ta/blog/1.pid0/">
<span class="md-ellipsis">
    操作系统小记（一）：从 PID 0 开始
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ta/blog/2.sync/">
<span class="md-ellipsis">
    操作系统小记（二）：内核同步方法
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ta/blog/3.stack_unwind/">
<span class="md-ellipsis">
    操作系统小记（三）：函数序言、调试器断点与堆栈回溯
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ta/blog/4.board/">
<span class="md-ellipsis">
    操作系统小记（四）：内核上板历险记
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#实验简介">
<span class="md-ellipsis">
      实验简介
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#part-0环境配置">
<span class="md-ellipsis">
      Part 0：环境配置
    </span>
</a>
<nav aria-label="Part 0：环境配置" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#更新代码">
<span class="md-ellipsis">
      更新代码
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#更新镜像">
<span class="md-ellipsis">
      更新镜像
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#part-1内存管理">
<span class="md-ellipsis">
      Part 1：内存管理
    </span>
</a>
<nav aria-label="Part 1：内存管理" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#物理内存空间">
<span class="md-ellipsis">
      物理内存空间
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#buddy-system">
<span class="md-ellipsis">
      Buddy System
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#侵入式双向循环链表">
<span class="md-ellipsis">
      侵入式双向循环链表
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#task-1实现双向链表">
<span class="md-ellipsis">
      Task 1：实现双向链表
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#空闲链表缓存">
<span class="md-ellipsis">
      空闲链表缓存
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#part-2进程切换与-trap-处理">
<span class="md-ellipsis">
      Part 2：进程切换与 Trap 处理
    </span>
</a>
<nav aria-label="Part 2：进程切换与 Trap 处理" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#进程切换非抢占情况">
<span class="md-ellipsis">
      进程切换：非抢占情况
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#进程切换抢占与-trap-处理">
<span class="md-ellipsis">
      进程切换：抢占与 Trap 处理
    </span>
</a>
<nav aria-label="进程切换：抢占与 Trap 处理" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#切换调度trap-与抢占的关系">
<span class="md-ellipsis">
      切换、调度、Trap 与抢占的关系
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#内核中不能被-trap-的部分">
<span class="md-ellipsis">
      内核中不能被 Trap 的部分
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#抢占的时机">
<span class="md-ellipsis">
      抢占的时机
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#进程切换引入并发">
<span class="md-ellipsis">
      进程切换：引入并发
    </span>
</a>
<nav aria-label="进程切换：引入并发" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#例子-1内核数据结构">
<span class="md-ellipsis">
      例子 1：内核数据结构
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#例子-2进程切换过程">
<span class="md-ellipsis">
      例子 2：进程切换过程
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#讨论所有切换情况">
<span class="md-ellipsis">
      讨论所有切换情况
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#进程数据结构和内存布局">
<span class="md-ellipsis">
      进程数据结构和内存布局
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#task-2设置初始进程">
<span class="md-ellipsis">
      Task 2：设置初始进程
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#part-3进程生命周期">
<span class="md-ellipsis">
      Part 3：进程生命周期
    </span>
</a>
<nav aria-label="Part 3：进程生命周期" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#进程复制与加载">
<span class="md-ellipsis">
      进程复制与加载
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#task-3实现进程复制与加载">
<span class="md-ellipsis">
      Task 3：实现进程复制与加载
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#进程退出与销毁">
<span class="md-ellipsis">
      进程退出与销毁
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#part-4调度器">
<span class="md-ellipsis">
      Part 4：调度器
    </span>
</a>
<nav aria-label="Part 4：调度器" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#时间片轮转调度">
<span class="md-ellipsis">
      时间片轮转调度
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#task-4实现时间片轮转调度和抢占">
<span class="md-ellipsis">
      Task 4：实现时间片轮转调度和抢占
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#结语lab2-和-linux-调度器的历史">
<span class="md-ellipsis">
      结语：Lab2 和 Linux 调度器的历史
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<a class="md-content__button md-icon" href="https://github.com/ZJU-OS/doc/blob/main/docs/lab2.md" rel="edit" title="Edit this page">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"></path></svg>
</a>
<h1 id="lab-2抢占式内核线程调度">Lab 2：抢占式内核线程调度<a class="headerlink" href="#lab-2抢占式内核线程调度" title="Permanent link">¶</a></h1><p style="color:#bdbdbd"><i>Estimated time to read: 15 minutes</i></p>

<div class="admonition danger">
<p class="admonition-title">DDL</p>
<ul>
<li>代码、报告：2025-11-04 23:59</li>
<li>验收：2025-11-11 实验课</li>
</ul>
</div>
<h2 id="实验简介">实验简介<a class="headerlink" href="#实验简介" title="Permanent link">¶</a></h2>
<div class="admonition tip">
<p class="admonition-title">术语：进程、线程与 Task（任务）</p>
<p>在理论课上，我们明确定义了进程和线程。而在工程中，实现并不会那么死板。请你阅读下面的文段，了解在 Linux 和本实验的语境中这些术语的含义：</p>
<blockquote>
<p>As you will see later, Linux has a unique implementation of threads: <strong>It does not differentiate between threads and processes.</strong>To Linux, a thread is just a special kind of process.</p>
<p>Another name for <strong>a process is a task</strong>. The Linux kernel internally refers to processes as tasks. In this book, <strong>I use the terms interchangeably</strong>, although when I say task I am generally referring to a process from the kernel’s point of view.</p>
</blockquote>
<p>上面的文段来自 <a href="https://www.oreilly.com/library/view/linux-kernel-development/9780768696974/">Linux Kernel Development</a>，一本经典的 Linux 内核开发入门书籍。</p>
<p>具体来说：</p>
<ul>
<li>Linux 系统调用 <code>clone()</code> 可以创建新的 Task，传入的参数将决定新 Task 具有怎样的性质：<ul>
<li><code>CLONE_FILES | CLONE_VM | CLONE_FS</code>：表示新 Task 与父 Task 共享文件系统、内存空间和文件描述符表，这样的 Task 符合我们对<strong>线程（Thread）</strong>的定义。</li>
<li>不使用上面的参数：表示新 Task 拥有独立的文件系统、内存空间和文件描述符表，这样的 Task 符合我们对<strong>进程（Process）</strong>的定义。</li>
</ul>
</li>
<li>在调度器看来，只有 Task，没有进程和线程的区别。</li>
</ul>
<p>那为什么本实验叫做「内核线程」不叫「内核任务」呢？因为历史上一直把运行在内核态的 Task 叫做<strong>内核线程（Kernel Thread）</strong>。</p>
<p>现在你已经理解在实验中这些术语的区分并没有那么严格，接下来阅读实验内容时就不用扣字眼了😉。</p>
</div>
<p>在 Lab1 中，我们已经让内核能够启动并处理时钟中断。但是如果没有进一步的机制，操作系统仍然只能在 CPU 上执行单个任务（即 <code>start_kernel</code> 函数）。本次实验的目标是：<strong>实现抢占式内核线程调度，让多个任务能够在一个 CPU 上通过时间复用的方式交替运行。</strong></p>
<p>要完成这一目标，我们需要逐步解决以下几个问题：</p>
<ol>
<li>
<p><strong>如何在内核中管理物理内存？</strong>（理论课第八章内容 - 主存）</p>
<p>在后续实验里，我们需要动态分配各类数据结构。但是操作系统无法使用 <code>malloc</code> 等标准库函数，那么问题来了：</p>
<ul>
<li><strong>操作系统如何在裸机环境下动态分配内存？</strong></li>
<li><strong>为什么我们不能直接线性地“挖一块”内存？碎片化如何解决？</strong></li>
</ul>
<p>实验框架提供了一个简化版 <strong>Buddy System 物理内存分配器</strong>。同学们需要理解它的基本原理，并学会通过接口分配和释放物理页。</p>
<p>Buddy System 仅能实现物理页分配，<strong>无法满足对象粒度的分配需求</strong>。因此，我们还需要实现一个<strong>空闲链表缓存（free list cache）</strong>，用于高效地分配内核对象。</p>
</li>
<li>
<p><strong>如何管理进程？</strong>（理论课第三章内容 - 进程）</p>
<p>任务交替运行的核心在于<strong>上下文切换（context switch）</strong>。要让任务 A 运行完一段时间后交出 CPU，再切换到任务 B，必须保存 A 的上下文，并在之后恢复它。</p>
<ul>
<li><strong>上下文具体包含哪些内容？</strong></li>
<li><strong>RISC-V 调用约定和中断机制如何影响上下文切换？</strong></li>
<li><strong>如何实现抢占？</strong></li>
</ul>
<p>解决完上下文切换的基本问题后，我们需要为每个 Task 设计一个数据结构（即理论课介绍的 PCB，Process Control Block），用于保存上下文和其他属性。并且还需要实现进程的创建和销毁机制，从而让内核能够动态地管理多个任务。</p>
</li>
<li>
<p><strong>调度器应该如何工作？</strong>（理论课第五章内容 - 调度算法）</p>
<p>有了内存和进程管理，接下来就能够实现调度器。调度器的任务是：</p>
<ol>
<li>根据调度算法选择下一个要运行的任务</li>
<li>调用上下文切换代码，将 CPU 控制权交给它</li>
</ol>
<p>本次实验中，我们将先实现一个简单的<strong>时间片轮转（Round Robin）调度器</strong>。</p>
</li>
</ol>
<h2 id="part-0环境配置">Part 0：环境配置<a class="headerlink" href="#part-0环境配置" title="Permanent link">¶</a></h2>
<h3 id="更新代码">更新代码<a class="headerlink" href="#更新代码" title="Permanent link">¶</a></h3>
<p>现在你位于 <code>lab1</code> 分支。你需要创建 <code>lab2</code> 分支，合并上游的代码：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>git<span class="w"> </span>checkout<span class="w"> </span>-b<span class="w"> </span>lab2
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>git<span class="w"> </span>fetch<span class="w"> </span>upstream
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>git<span class="w"> </span>merge<span class="w"> </span>upstream/lab2
</span></code></pre></div>
<p>下面的合并说明供同学们解决合并冲突时参考：</p>
<ul>
<li>新增实验相关：<ul>
<li>内存管理代码 <code>mm.h</code>，在 Part1.2 介绍</li>
<li>链表代码 <code>list.h</code>，在 Part1.3 介绍</li>
<li>空闲链表缓存代码 <code>cache.h</code>，在 Part1.4 介绍</li>
<li>进程管理相关实验代码 <code>proc.h</code>，在 Part1.5 介绍</li>
<li>内核线程代码 <code>kthread.h</code>，在 Part1.6 介绍</li>
<li>调度器代码 <code>sched.h</code>，在 Part4 介绍</li>
<li>几个测试样例 <code>test.h</code>、<code>test_*.c</code> 在对应的 Task 介绍</li>
</ul>
</li>
<li>
<p>新增其他：</p>
<ul>
<li>
<p>日志系统，见 <code>log.h</code></p>
<ul>
<li>自动识别并打印日志位置的<strong>文件名和行号</strong></li>
<li>支持<strong>日志级别</strong>（DEBUG、INFO、WARN、ERROR），可以通过修改 <code>log.h</code> 的 <code>LOG_LEVEL</code> 宏来控制输出的详细程度</li>
<li>
<p><strong>框架已经添加了部分调试日志</strong>，同学们可以将 <code>LOG_LEVEL</code> 设置到 <code>LOG_LEVEL_DEBUG</code> 来查看，例图如下：</p>
<p></p><figure markdown="span">
<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../lab2.assets/log_example.webp"><img alt="log_example.webp" src="../lab2.assets/log_example.webp"/></a>
<figcaption>
    日志输出示例
    </figcaption>
</figure><p></p>
<p>每行日志的前缀固定格式为：<code>[等级, 当前进程] 文件名:行号:函数名:</code>。</p>
</li>
<li>
<p><strong>建议同学们多用这一日志系统而不是 <code>printk</code></strong></p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>变更：</p>
<ul>
<li>CSR 相关内容从 <code>sbi.h</code> 移动到 <code>csr.h</code></li>
<li>时钟中断的间隔与调度算法有关，从 1s 改为 <code>kernel/arch/riscv/include/sched.h</code> 中定义的 <code>TIMER_INTERVAL</code></li>
<li><code>arch/riscv/kernel/include</code> 中的所有头文件现在都添加了 Doxygen 风格的<strong>详细的 API、数据结构、常量的注释，请同学们积极阅读和使用</strong>，文档不会再赘述。</li>
</ul>
</li>
</ul>
<h3 id="更新镜像">更新镜像<a class="headerlink" href="#更新镜像" title="Permanent link">¶</a></h3>
<p>本次镜像更新在 <code>/etc/gitconfig</code> 添加了 <code>safe.directory</code> 的配置，以解决代码库挂载到容器后的权限问题。这不是一个必要的修复，同学们可以视情况选择更新镜像。</p>
<h2 id="part-1内存管理">Part 1：内存管理<a class="headerlink" href="#part-1内存管理" title="Permanent link">¶</a></h2>
<h3 id="物理内存空间">物理内存空间<a class="headerlink" href="#物理内存空间" title="Permanent link">¶</a></h3>
<p>在学习如何管理物理内存之前，我们需要先弄清楚<strong>物理内存空间</strong>的概念。所谓内存空间，就是 <strong>CPU 可以直接寻址的地址范围</strong>，其大小通常由寄存器的位数决定。</p>
<ul>
<li>例如，在 <strong>RV32 架构</strong>中，通用寄存器宽度为 32 位。当执行指令 <code>ld x1, 0(x2)</code> 时，<code>x2</code> 中存放的就是一个内存地址，它决定了 <code>x1</code> 要从哪里取数据。由于寄存器只有 32 位，最多能寻址 <span class="arithmatex">\(2^{32}\)</span> 个字节，因此 RV32 的地址空间大小为 <span class="arithmatex">\(2^{32} \text{B} = 4 \text{GB}\)</span>。</li>
<li>而在 <strong>RV64 架构</strong>下，寄存器宽度扩展为 64 位，对应的寻址空间理论上可以达到 <span class="arithmatex">\(2^{64} \text{B} = 2^{34} \text{GB} = 16 \text{EB}\)</span>，远超当前实际硬件所能提供的内存容量。</li>
</ul>
<p>在真实机器上，CPU 不可能真的拥有 16 EB 的内存。<strong>系统只会映射其中的一小部分地址作为物理内存，其余地址范围通常保留给外设、固件、I/O 总线等。</strong>在 Lab0 中，我们已经使用过 <code>info mtree</code> 命令来查看 QEMU 模拟的内存映射，接下来基于该结果进行具体分析：</p>
<ul>
<li>
<p><strong>RV64 架构的地址空间</strong>：<code>0000000000000000</code> 到 <code>ffffffffffffffff</code>，总共 16 EB。</p>
<div class="language-text highlight"><span class="filename">(qemu) info mtree</span><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>address-space: cpu-memory-0
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>address-space: memory
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>  0000000000000000-ffffffffffffffff (prio 0, i/o): system
</span><span id="__span-1-4"><a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>    ...
</span></code></pre></div>
</li>
<li>
<p><strong>地址空间的具体划分</strong>：</p>
<ul>
<li>
<p>某些区域存放固件或测试寄存器（如 <code>mrom</code>, <code>sifive.test</code>）</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>0000000000001000-000000000000ffff (prio 0, rom): riscv_virt_board.mrom
</span><span id="__span-2-2"><a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>0000000000100000-0000000000100fff (prio 0, i/o): riscv.sifive.test
</span></code></pre></div>
</li>
<li>
<p>某些区域对应定时器、PLIC（中断控制器）、串口、virtio 设备等外设</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>000000000c000000-000000000c5fffff (prio 0, i/o): riscv.sifive.plic
</span><span id="__span-3-2"><a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>0000000010000000-0000000010000007 (prio 0, i/o): serial
</span><span id="__span-3-3"><a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>0000000000101000-0000000000101023 (prio 0, i/o): goldfish_rtc
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">要点：总线与内存映射 I/O</p>
<p>在计科的硬件课程中，大家可能还没有系统学习过<strong>总线 (Bus)</strong> 的概念。在这里我们只需要掌握最基本的理解：</p>
<ul>
<li><strong>总线是一种统一的通信通道</strong>，CPU、内存、外设都通过总线交互数据。</li>
<li>在现代计算机中，CPU 把一部分地址空间“划给”外设。当我们用普通的 <code>load/store</code> 指令访问这些地址时，看似在访问内存，实际上是通过总线把数据读写到某个外设寄存器上。</li>
<li>举个例子：当我们向串口地址空间写入一个字节，硬件就会把它输出到终端；当我们读取 RTC（实时时钟）的寄存器，就能获得当前时间。</li>
</ul>
<p>这就是所谓的 <strong>Memory-Mapped I/O（MMIO）</strong>：通过“内存地址空间”来操纵外设。</p>
</div>
</li>
<li>
<p>最关键的是，一部分地址范围被映射为 <strong>RAM</strong>，即实验中我们真正可以使用的物理内存。例如：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>0000000080000000-0000000087ffffff (prio 0, ram): riscv_virt_board.ram
</span></code></pre></div>
<p>这表示从 <code>0x80000000</code> 开始，有一段连续的物理内存区域被作为可用 RAM 提供给操作系统。</p>
</li>
</ul>
</li>
</ul>
<p>并且，在前述的实验中，我们也具体了解到 <code>0x80000000-0x87ffffff</code> 这 128MB 的物理内存的划分：</p>
<ul>
<li><code>0x80000000-0x801fffff</code>：OpenSBI 占用</li>
<li><code>0x80200000-_ekernel</code>：内核占用</li>
<li><code>_ekernel-0x87ffffff</code>：可以自由使用的物理内存</li>
</ul>
<div class="admonition note">
<p class="admonition-title">要点：物理内存空间</p>
<ul>
<li>RV64 的理论地址空间非常大，但实际可用的物理内存只是其中一小块。</li>
<li>QEMU 会在 <code>0x80000000</code> 起映射出一段 RAM，这是我们在实验中管理和使用的主要物理内存区域。</li>
<li>其他区域虽然也是“地址”，但对应的是固件或外设。CPU 通过读写这些地址，与硬件进行交互。</li>
</ul>
</div>
<h3 id="buddy-system">Buddy System<a class="headerlink" href="#buddy-system" title="Permanent link">¶</a></h3>
<p>在理解了“我们有哪些物理内存”之后，下一步要思考的就是：<strong>如何高效地管理这段有限的物理内存</strong>。如果没有一套规则来分配和回收内存，那么很快就会出现“要么分配不出去，要么浪费大片空间”的问题。</p>
<p>最常见的一个困难是 <strong>内存碎片</strong>：</p>
<ul>
<li>如果我们每次都按照请求大小直接分配，随着不断申请和释放，内存会被切得零零碎碎，即使总剩余空间很多，也可能无法满足一个大块内存的请求。</li>
<li>我们需要一种机制来让内存块尽量保持“规整”，方便回收和再次利用。</li>
</ul>
<p><strong>Buddy System</strong> 就是这样一种经典方案：</p>
<ol>
<li>
<p><strong>内存划分规则</strong></p>
<ul>
<li>假设我们有一段连续的物理内存，总大小是 <span class="arithmatex">\(2^n\)</span> 页。</li>
<li>系统按 <strong>2 的幂次方大小</strong>划分内存块：1 页、2 页、4 页……直到 <span class="arithmatex">\(2^n\)</span> 页。</li>
<li>每次分配时，如果需要的大小不是 2 的幂，会自动向上取整。</li>
</ul>
</li>
<li>
<p><strong>分配过程</strong></p>
<ul>
<li>找到能满足需求的最小块，如果没有，就从更大的块中“劈开一半”。</li>
<li>每劈一次，就会得到一对“伙伴块”（buddy）。</li>
</ul>
</li>
<li>
<p><strong>释放过程</strong></p>
<ul>
<li>当一个块被释放后，系统会检查它的伙伴是否空闲。</li>
<li>如果伙伴也空闲，就将两者合并成更大的块，并继续向上合并，直到不能合并为止。</li>
<li>这样可以减少碎片，使得大块空间能重新腾出来。</li>
</ul>
</li>
</ol>
<p>在实验框架里，我们已经为大家实现了一个简化版的 <strong>Buddy System 物理内存分配器</strong>（位于 <code>mm.c</code> / <code>mm.h</code>）。你无需从零开始写算法，只需要掌握它的使用方式。</p>
<p>请阅读 <code>kernel/arch/riscv/include/list.h</code>，了解 Buddy System 提供的接口。在实验里，你只需要通过这些接口申请或释放物理页，而不必关心内部具体是如何实现的。</p>
<p>例如：</p>
<div class="language-c highlight"><span class="filename">Buddy System 接口使用示例</span><pre><span></span><code><span id="__span-5-1"><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_page</span><span class="p">();</span><span class="w">      </span><span class="c1">// 分配一页</span>
</span><span id="__span-5-2"><a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_pages</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span><span class="w">    </span><span class="c1">// 分配 8 页</span>
</span><span id="__span-5-3"><a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="n">free_pages</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w">               </span><span class="c1">// 释放之前分配的一页</span>
</span></code></pre></div>
<p>通过这一套接口，我们的内核就能在后续实验（如进程调度、内存管理、虚拟内存）中，稳定地使用物理页作为底层资源。</p>
<div class="admonition note">
<p class="admonition-title">要点：Buddy System</p>
<ul>
<li>Buddy System 按 2 的幂次方划分内存块，方便合并和回收，减少碎片。</li>
<li>实验框架已经实现了简化版的 Buddy System，你只需通过 <code>alloc_page(s)</code> 和 <code>free_pages()</code> 接口来分配和释放物理页。</li>
</ul>
</div>
<h3 id="侵入式双向循环链表">侵入式双向循环链表<a class="headerlink" href="#侵入式双向循环链表" title="Permanent link">¶</a></h3>
<p>在内核中我们经常需要组织各种动态对象，例如空闲页链表、就绪任务队列、等待队列等。Linux 内核实现了<strong>侵入式双向循环链表（intrusive doubly-linked list）</strong>来高效地管理这些对象。</p>
<ul>
<li>
<p><strong>侵入式与泛型接口</strong>：</p>
<p>普通链表实现<strong>将数据嵌入在链表中</strong>，而侵入式实现<strong>将链表嵌入在数据中</strong>。前者<strong>每一种数据类型都需要单独定义链表节点结构体和相关的函数</strong>，导致代码重复且不易维护。后者<strong>不同类型可以复用同一套接口</strong>，这就是泛型（generic）。</p>
<div class="grid cards" markdown="">
<div class="language-c highlight"><span class="filename">侵入式链表</span><pre><span></span><code><span id="__span-6-1"><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-2"><a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span><span id="__span-6-3"><a href="#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="p">};</span>
</span><span id="__span-6-4"><a href="#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="cp">#define LIST_HEAD_INIT(name) { &amp;(name), &amp;(name) }</span>
</span><span id="__span-6-5"><a href="#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="cp">#define LIST_HEAD(name) struct list_head name = LIST_HEAD_INIT(name)</span>
</span><span id="__span-6-6"><a href="#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">list_add</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="o">*</span><span class="n">new</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="o">*</span><span class="n">head</span><span class="p">);</span>
</span><span id="__span-6-7"><a href="#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">list_del</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="o">*</span><span class="n">entry</span><span class="p">)</span>
</span><span id="__span-6-8"><a href="#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a>
</span><span id="__span-6-9"><a href="#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="c1">// 使用例</span>
</span><span id="__span-6-10"><a href="#__codelineno-6-10" id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="k">struct</span><span class="w"> </span><span class="nc">data_node_A</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-11"><a href="#__codelineno-6-11" id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
</span><span id="__span-6-12"><a href="#__codelineno-6-12" id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">list</span><span class="p">;</span>
</span><span id="__span-6-13"><a href="#__codelineno-6-13" id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="p">}</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
</span><span id="__span-6-14"><a href="#__codelineno-6-14" id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="k">struct</span><span class="w"> </span><span class="nc">data_node_B</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-15"><a href="#__codelineno-6-15" id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
</span><span id="__span-6-16"><a href="#__codelineno-6-16" id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">list</span><span class="p">;</span>
</span><span id="__span-6-17"><a href="#__codelineno-6-17" id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="p">}</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
</span><span id="__span-6-18"><a href="#__codelineno-6-18" id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">list_A</span><span class="p">);</span>
</span><span id="__span-6-19"><a href="#__codelineno-6-19" id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">list_B</span><span class="p">);</span>
</span><span id="__span-6-20"><a href="#__codelineno-6-20" id="__codelineno-6-20" name="__codelineno-6-20"></a><span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">.</span><span class="n">list</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">list_A</span><span class="p">);</span>
</span><span id="__span-6-21"><a href="#__codelineno-6-21" id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">.</span><span class="n">list</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">list_B</span><span class="p">);</span>
</span></code></pre></div>
<div class="language-c highlight"><span class="filename">普通链表</span><pre><span></span><code><span id="__span-7-1"><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">data_node_A</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-2"><a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="w">    </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
</span><span id="__span-7-3"><a href="#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">data_node_A</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span><span id="__span-7-4"><a href="#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="p">}</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">list_A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-7-5"><a href="#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="k">struct</span><span class="w"> </span><span class="nc">data_node_B</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-6"><a href="#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">    </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
</span><span id="__span-7-7"><a href="#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">data_node_B</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span><span id="__span-7-8"><a href="#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="p">}</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">list_B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-7-9"><a href="#__codelineno-7-9" id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">list_A_add</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">data_node_A</span><span class="w"> </span><span class="o">*</span><span class="n">new</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">data_node_A</span><span class="w"> </span><span class="o">*</span><span class="n">head</span><span class="p">);</span>
</span><span id="__span-7-10"><a href="#__codelineno-7-10" id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">list_B_add</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">data_node_B</span><span class="w"> </span><span class="o">*</span><span class="n">new</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">data_node_B</span><span class="w"> </span><span class="o">*</span><span class="n">head</span><span class="p">);</span>
</span><span id="__span-7-11"><a href="#__codelineno-7-11" id="__codelineno-7-11" name="__codelineno-7-11"></a>
</span><span id="__span-7-12"><a href="#__codelineno-7-12" id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="c1">// 使用例</span>
</span><span id="__span-7-13"><a href="#__codelineno-7-13" id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="n">list_A_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">list_A</span><span class="p">);</span>
</span><span id="__span-7-14"><a href="#__codelineno-7-14" id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="n">list_B_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">list_B</span><span class="p">);</span>
</span></code></pre></div>
</div>
</li>
<li>
<p><strong>访问数据</strong>：</p>
<p>理解了上面的代码，你会发现盲点：<code>list_head</code> 结构体并不包含数据字段。怎么通过 <code>list_A</code> 这样的链表头，访问到 <code>data_node_A</code> 结构体呢？</p>
<p>这就需要使用编译器魔法了：<code>container_of</code> 宏。它的定义如下：</p>
<div class="language-c highlight"><span class="filename">kernel/arch/riscv/include/list.h</span><pre><span></span><code><span id="__span-8-1"><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="cp">#define container_of(ptr, type, member) ({          \</span>
</span><span id="__span-8-2"><a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="cp">    const typeof( ((type *)0)-&gt;member ) *__mptr = (ptr); \</span>
</span><span id="__span-8-3"><a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="cp">    (type *)( (char *)__mptr - offsetof(type,member) );})</span>
</span></code></pre></div>
<p>编译器知道类型的大小，提供了 <code>typeof()</code> 和 <code>offestof()</code>。我们可以利用这些信息<strong>移动成员变量的指针，计算出包含该成员变量的结构体的起始地址</strong>。例如：</p>
<div class="language-c highlight"><span class="filename">container_of 使用示例</span><pre><span></span><code><span id="__span-9-1"><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">data_node_A</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
</span><span id="__span-9-2"><a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">a</span><span class="p">.</span><span class="n">list</span><span class="p">;</span>
</span><span id="__span-9-3"><a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="k">struct</span><span class="w"> </span><span class="nc">data_node_A</span><span class="w"> </span><span class="o">*</span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">container_of</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">data_node_A</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">);</span>
</span><span id="__span-9-4"><a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="n">assert</span><span class="p">(</span><span class="n">q</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">&amp;</span><span class="n">a</span><span class="p">);</span><span class="w"> </span><span class="c1">// q 恰好指向 a 的起始地址</span>
</span></code></pre></div>
</li>
</ul>
<figure>
<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../lab2.assets/list_head.drawio"><div class="mxgraph" data-mxgraph='{"toolbar": "zoom", "tooltips": "1", "border": 5, "resize": "1", "edit": "_blank", "highlight": null, "xml": "&lt;mxfile host=\"65bd71144e\"&gt;\n    &lt;diagram id=\"zt6Frfhi11MsrxubBEZP\" name=\"Page-1\"&gt;\n        &lt;mxGraphModel dx=\"1184\" dy=\"681\" grid=\"1\" gridSize=\"10\" guides=\"1\" tooltips=\"1\" connect=\"1\" arrows=\"1\" fold=\"1\" page=\"1\" pageScale=\"1\" pageWidth=\"850\" pageHeight=\"1100\" math=\"0\" shadow=\"0\"&gt;\n            &lt;root&gt;\n                &lt;mxCell id=\"0\"/&gt;\n                &lt;mxCell id=\"1\" parent=\"0\"/&gt;\n                &lt;mxCell id=\"2\" value=\"struct list_head\" style=\"rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;verticalAlign=top;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"120\" y=\"340\" width=\"120\" height=\"60\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"3\" value=\"Node 0\" style=\"rounded=0;whiteSpace=wrap;html=1;verticalAlign=top;fontSize=16;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"260\" y=\"270\" width=\"160\" height=\"150\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"4\" value=\"prev\" style=\"rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"130\" y=\"370\" width=\"50\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"15\" style=\"edgeStyle=orthogonalEdgeStyle;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;\" edge=\"1\" parent=\"1\" source=\"5\" target=\"6\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"5\" value=\"next\" style=\"rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"180\" y=\"370\" width=\"50\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"6\" value=\"struct list_head\" style=\"rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;verticalAlign=top;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"280\" y=\"340\" width=\"120\" height=\"60\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"17\" style=\"edgeStyle=orthogonalEdgeStyle;shape=connector;rounded=1;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;strokeColor=#82b366;align=center;verticalAlign=middle;fontFamily=Helvetica;fontSize=11;fontColor=default;labelBackgroundColor=default;endArrow=classic;fillColor=#d5e8d4;\" edge=\"1\" parent=\"1\" source=\"7\" target=\"2\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"7\" value=\"prev\" style=\"rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"290\" y=\"370\" width=\"50\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"8\" value=\"next\" style=\"rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"340\" y=\"370\" width=\"50\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"9\" value=\"data\" style=\"rounded=0;whiteSpace=wrap;html=1;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"280\" y=\"300\" width=\"120\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"10\" value=\"Node 1\" style=\"rounded=0;whiteSpace=wrap;html=1;verticalAlign=top;fontSize=16;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"440\" y=\"270\" width=\"160\" height=\"150\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"11\" value=\"struct list_head\" style=\"rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;verticalAlign=top;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"460\" y=\"340\" width=\"120\" height=\"60\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"18\" style=\"edgeStyle=orthogonalEdgeStyle;shape=connector;rounded=1;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;strokeColor=#82b366;align=center;verticalAlign=middle;fontFamily=Helvetica;fontSize=11;fontColor=default;labelBackgroundColor=default;endArrow=classic;fillColor=#d5e8d4;\" edge=\"1\" parent=\"1\" source=\"12\" target=\"6\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"12\" value=\"prev\" style=\"rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"470\" y=\"370\" width=\"50\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"22\" style=\"edgeStyle=orthogonalEdgeStyle;shape=connector;rounded=1;html=1;entryX=0.25;entryY=1;entryDx=0;entryDy=0;strokeColor=#6c8ebf;align=center;verticalAlign=middle;fontFamily=Helvetica;fontSize=11;fontColor=default;labelBackgroundColor=default;endArrow=classic;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fillColor=#dae8fc;\" edge=\"1\" parent=\"1\" source=\"13\" target=\"2\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"&gt;\n                        &lt;Array as=\"points\"&gt;\n                            &lt;mxPoint x=\"580\" y=\"380\"/&gt;\n                            &lt;mxPoint x=\"580\" y=\"430\"/&gt;\n                            &lt;mxPoint x=\"150\" y=\"430\"/&gt;\n                        &lt;/Array&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"13\" value=\"next\" style=\"rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"520\" y=\"370\" width=\"50\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"14\" value=\"data\" style=\"rounded=0;whiteSpace=wrap;html=1;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"460\" y=\"300\" width=\"120\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"19\" style=\"edgeStyle=orthogonalEdgeStyle;shape=connector;rounded=1;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;strokeColor=#6c8ebf;align=center;verticalAlign=middle;fontFamily=Helvetica;fontSize=11;fontColor=default;labelBackgroundColor=default;endArrow=classic;fillColor=#dae8fc;\" edge=\"1\" parent=\"1\" source=\"8\" target=\"11\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"21\" value=\"Head\" style=\"text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontFamily=Helvetica;fontSize=16;fontColor=default;labelBackgroundColor=default;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"150\" y=\"300\" width=\"60\" height=\"30\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"23\" style=\"edgeStyle=orthogonalEdgeStyle;shape=connector;rounded=1;html=1;entryX=1;entryY=0.5;entryDx=0;entryDy=0;strokeColor=#82b366;align=center;verticalAlign=middle;fontFamily=Helvetica;fontSize=11;fontColor=default;labelBackgroundColor=default;endArrow=classic;exitX=0;exitY=0.5;exitDx=0;exitDy=0;fillColor=#d5e8d4;\" edge=\"1\" parent=\"1\" source=\"4\" target=\"11\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"&gt;\n                        &lt;Array as=\"points\"&gt;\n                            &lt;mxPoint x=\"110\" y=\"380\"/&gt;\n                            &lt;mxPoint x=\"110\" y=\"250\"/&gt;\n                            &lt;mxPoint x=\"630\" y=\"250\"/&gt;\n                            &lt;mxPoint x=\"630\" y=\"370\"/&gt;\n                        &lt;/Array&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n            &lt;/root&gt;\n        &lt;/mxGraphModel&gt;\n    &lt;/diagram&gt;\n&lt;/mxfile&gt;"}' style="max-width:100%;border:1px solid transparent;"></div></a>
<figcaption>
    侵入式双向循环链表示意图
    </figcaption>
</figure>
<p>实现链表还给我们附带了一个惊喜：<strong>实现了队列</strong>。同学们在数据结构课上已经学过，<strong>双向循环链表实现了双端队列（deque）</strong>，它支持在头尾两端高效地插入和删除节点。于是我们有实现多级反馈队列调度器所需的工具了。</p>
<div class="admonition note">
<p class="admonition-title">要点：侵入式双向循环链表</p>
<ul>
<li>侵入式链表将链表节点嵌入数据结构中，支持泛型接口，代码复用性强。</li>
<li>通过 <code>container_of</code> 宏，可以从链表节点指针计算出包含它的结构体指针。</li>
</ul>
</div>
<div class="admonition info">
<p class="admonition-title">更多资料</p>
<ul>
<li><a href="https://www.data-structures-in-practice.com/intrusive-linked-lists/">Intrusive linked lists - Data structures in practice</a></li>
</ul>
</div>
<h3 id="task-1实现双向链表">Task 1：实现双向链表<a class="headerlink" href="#task-1实现双向链表" title="Permanent link">¶</a></h3>
<p>你应该早在大一的 C 语言课上就能秒杀双向链表了 😉。请补全 <code>kernel/arch/riscv/include/list.h</code>：</p>
<ul>
<li>提示：观察 <code>LIST_HEAD</code> 宏，你会发现这应该是一个<strong>带哨兵</strong>的双向链表。思考如果不带哨兵，它应当该如何实现？</li>
<li>补全 <code>list_empty()</code>。</li>
<li>补全 <code>list_add()</code>、<code>list_add_tail()</code> 和 <code>list_del()</code>。提示：一个优雅的做法是令 <code>list_add()</code> 和 <code>list_add_tail()</code> 都调用一个更底层的 <code>__list_add()</code>。</li>
<li>补全 <code>list_for_each</code> 宏。</li>
</ul>
<div class="admonition success">
<p class="admonition-title">完成条件</p>
<ul>
<li>通过评测框架的 <code>lab2 task1</code> 测试。</li>
</ul>
<p><code>kernel/arch/riscv/kernel/test_list.c</code> 中的 <code>test_list()</code> 函数用于测试你的链表实现。</p>
</div>
<h3 id="空闲链表缓存">空闲链表缓存<a class="headerlink" href="#空闲链表缓存" title="Permanent link">¶</a></h3>
<p>本节利用链表实现一个内核中非常常见的机制——<strong>对象缓存（object cache）</strong>。</p>
<p>在内核中，许多内核对象（如 <code>task_struct</code>、<code>inode</code>、<code>vm_area_struct</code> 等）会被<strong>频繁创建和销毁</strong>。如果动态创建都调用通用的内存分配器（如 Buddy System），会对性能产生较大影响，且容易引起内存碎片。</p>
<p>为了解决这些问题，Linux 内核引入了 <strong>Slab 分配器</strong>：它为每种类型的对象维护一个缓存池，将整页内存切分为多个固定大小的对象块，用链表管理这些空闲对象。换句话说，Slab 缓存层（<code>kmem_cache</code>）相当于物理页分配器（<code>alloc_page()</code>）之上的对象粒度的再分配层。</p>
<p>不过，Linux 的 Slab 实现更加复杂，感兴趣的同学可以阅读 <a href="https://litux.nl/mirror/kerneldevelopment/0672327201/ch11lev1sec6.html">Slab Layer - Linux Kernel Development Second Edition</a>。在我们的教学实验中，只保留了它的<strong>核心思想：用空闲链表（free list）预分配缓存对象。</strong></p>
<p><code>kernel/arch/riscv/include/cache.h</code> 和 <code>kernel/arch/riscv/include/cache.c</code> 实现了 Slab 分配器，要求同学们阅读代码并理解其工作原理。</p>
<div class="admonition example">
<p class="admonition-title">动手做：理解空闲链表</p>
<p>阅读 <code>cache.h</code> 和 <code>cache.c</code>，理解空闲链表缓存的实现。</p>
<p>画一幅图，展示相关的数据结构及其布局。</p>
</div>
<div class="admonition question">
<p class="admonition-title">考点：内存管理与基础数据结构</p>
<ul>
<li>Buddy System 与对象缓存（kmem_cache）的职责边界分别是什么？分别适用哪些场景？</li>
<li>释放页框时，Buddy 为什么能“向上合并”？伙伴块（buddy）的地址如何根据当前块大小计算？</li>
<li>侵入式双向循环链表为何能实现“泛型”？<code>container_of</code> 如何从 <code>list_head*</code> 还原到宿主结构体指针？</li>
<li>实现 <code>list_add</code>/<code>list_add_tail</code>/<code>list_del</code> 时，带哨兵循环链表有哪些易错点（例如自环、顺序、空表判断）？</li>
</ul>
</div>
<h2 id="part-2进程切换与-trap-处理">Part 2：进程切换与 Trap 处理<a class="headerlink" href="#part-2进程切换与-trap-处理" title="Permanent link">¶</a></h2>
<p>本节我们探究实现用于切换进程上下文的汇编函数 <code>__switch_to()</code>，以及进程切换与 Trap 处理的相互影响。</p>
<h3 id="进程切换非抢占情况">进程切换：非抢占情况<a class="headerlink" href="#进程切换非抢占情况" title="Permanent link">¶</a></h3>
<p>让我们从最简单的不考虑 Trap 的情况开始。这种情况下没有时钟中断，进程切换仅能依靠进程主动调用 <code>__switch_to()</code> 完成，内核是非抢占式的。</p>
<p>设想这样一个场景：CPU 上正在运行 Task1，Task1 想调用 <code>__switch_to()</code> 切换到 Task2，然后 Task2 运行一段时间后再切换回来继续执行 Task1。<code>__switch_to()</code> 应该怎么设计？</p>
<p>Lab 1 Trap 处理的场景与此类似：可以将 <code>_traps()</code> 看作 <code>__switch_to()</code>，将 <code>trap_handler()</code> 看作 Task2。<code>trap_handler()</code> 执行完毕后，恢复 Trap 上下文就相当于 Task2 切换回 Task1。<strong>但进程切换与 Trap 有一个重要区别：Trap 可以发生在任何时候</strong>，因此 Trap 上下文是所有寄存器的状态；而 <code>__switch_to()</code> 是一个函数，<strong>它的调用者一定是遵守 RISC-V 调用约定的</strong>，因此不需要保存所有寄存器。示意图如下：</p>
<figure>
<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../lab2.assets/switch.drawio"><div class="mxgraph" data-mxgraph='{"toolbar": "zoom", "tooltips": "1", "border": 5, "resize": "1", "edit": "_blank", "highlight": null, "xml": "&lt;mxfile host=\"65bd71144e\"&gt;\n    &lt;diagram id=\"MKEIpqsYV9xL4WX14Jkj\" name=\"Page-1\"&gt;\n        &lt;mxGraphModel dx=\"766\" dy=\"517\" grid=\"1\" gridSize=\"10\" guides=\"1\" tooltips=\"1\" connect=\"1\" arrows=\"1\" fold=\"1\" page=\"1\" pageScale=\"1\" pageWidth=\"850\" pageHeight=\"1100\" math=\"0\" shadow=\"0\"&gt;\n            &lt;root&gt;\n                &lt;mxCell id=\"0\"/&gt;\n                &lt;mxCell id=\"1\" parent=\"0\"/&gt;\n                &lt;mxCell id=\"67\" value=\"\" style=\"endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;\" edge=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"500\" y=\"380\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"500\" y=\"40\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"46\" value=\"\" style=\"endArrow=none;html=1;entryX=0;entryY=0;entryDx=0;entryDy=0;dashed=1;endFill=0;\" parent=\"1\" target=\"12\" edge=\"1\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"160\" y=\"140\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"225\" y=\"141\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"58\" value=\"call\" style=\"edgeStyle=orthogonalEdgeStyle;shape=connector;rounded=1;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;strokeColor=default;align=center;verticalAlign=middle;fontFamily=Helvetica;fontSize=11;fontColor=default;labelBackgroundColor=default;resizable=0;endArrow=classic;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endFill=1;\" parent=\"1\" source=\"8\" target=\"12\" edge=\"1\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"&gt;\n                        &lt;Array as=\"points\"&gt;\n                            &lt;mxPoint x=\"220\" y=\"130\"/&gt;\n                            &lt;mxPoint x=\"220\" y=\"150\"/&gt;\n                        &lt;/Array&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"8\" value=\"Task 1\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"245\" y=\"120\" width=\"70\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"60\" value=\"call\" style=\"edgeStyle=orthogonalEdgeStyle;shape=connector;rounded=1;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;strokeColor=default;align=center;verticalAlign=middle;fontFamily=Helvetica;fontSize=11;fontColor=default;labelBackgroundColor=default;resizable=0;endArrow=classic;endFill=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;\" parent=\"1\" source=\"12\" target=\"18\" edge=\"1\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"&gt;\n                        &lt;Array as=\"points\"&gt;\n                            &lt;mxPoint x=\"220\" y=\"150\"/&gt;\n                            &lt;mxPoint x=\"220\" y=\"170\"/&gt;\n                        &lt;/Array&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"12\" value=\"schedule()\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"245\" y=\"140\" width=\"70\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"49\" value=\"call\" style=\"edgeStyle=orthogonalEdgeStyle;rounded=1;html=1;strokeColor=default;align=center;verticalAlign=middle;fontFamily=Helvetica;fontSize=11;fontColor=default;labelBackgroundColor=default;resizable=0;endArrow=block;endFill=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;\" parent=\"1\" source=\"18\" target=\"48\" edge=\"1\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"18\" value=\"switch_to()\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"245\" y=\"160\" width=\"70\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"74\" style=\"edgeStyle=none;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;\" edge=\"1\" parent=\"1\" source=\"42\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"340\" y=\"180\" as=\"targetPoint\"/&gt;\n                        &lt;mxPoint x=\"315\" y=\"220\" as=\"sourcePoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"42\" value=\"&amp;lt;div&amp;gt;caller-saved&amp;lt;/div&amp;gt;&amp;lt;div&amp;gt;\u8c03\u7528\u8005\u81ea\u5df1\u4fdd\u5b58&amp;lt;/div&amp;gt;\" style=\"text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"235\" y=\"214\" width=\"90\" height=\"30\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"47\" value=\"\u5f00\u59cb\u5207\u6362\" style=\"text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"80\" y=\"130\" width=\"70\" height=\"30\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"69\" style=\"edgeStyle=orthogonalEdgeStyle;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;dashed=1;\" edge=\"1\" parent=\"1\" source=\"48\" target=\"68\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"48\" value=\"__switch_to()\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"435\" y=\"194.5\" width=\"130\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"61\" value=\"ret\" style=\"edgeStyle=orthogonalEdgeStyle;shape=connector;rounded=1;html=1;entryX=1;entryY=0.5;entryDx=0;entryDy=0;strokeColor=default;align=center;verticalAlign=middle;fontFamily=Helvetica;fontSize=11;fontColor=default;labelBackgroundColor=default;resizable=0;endArrow=classic;endFill=1;\" parent=\"1\" source=\"50\" target=\"57\" edge=\"1\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"315\" y=\"294\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"50\" value=\"__switch_to()\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"435\" y=\"265.5\" width=\"130\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"53\" value=\"\" style=\"endArrow=none;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;dashed=1;endFill=0;\" parent=\"1\" target=\"50\" edge=\"1\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"160\" y=\"264\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"245\" y=\"260\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"54\" value=\"\u5f00\u59cb\u6062\u590d\" style=\"text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"80\" y=\"244\" width=\"70\" height=\"30\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"55\" value=\"Task 1\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"245\" y=\"340\" width=\"70\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"62\" value=\"ret\" style=\"edgeStyle=orthogonalEdgeStyle;shape=connector;rounded=1;html=1;strokeColor=default;align=center;verticalAlign=middle;fontFamily=Helvetica;fontSize=11;fontColor=default;labelBackgroundColor=default;resizable=0;endArrow=classic;endFill=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;\" parent=\"1\" source=\"56\" target=\"55\" edge=\"1\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"240\" y=\"350\" as=\"targetPoint\"/&gt;\n                        &lt;Array as=\"points\"&gt;\n                            &lt;mxPoint x=\"220\" y=\"330\"/&gt;\n                            &lt;mxPoint x=\"220\" y=\"350\"/&gt;\n                        &lt;/Array&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"56\" value=\"schedule()\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"245\" y=\"320\" width=\"70\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"63\" value=\"ret\" style=\"edgeStyle=orthogonalEdgeStyle;shape=connector;rounded=1;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;strokeColor=default;align=center;verticalAlign=middle;fontFamily=Helvetica;fontSize=11;fontColor=default;labelBackgroundColor=default;resizable=0;endArrow=classic;endFill=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;\" parent=\"1\" source=\"57\" target=\"56\" edge=\"1\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"&gt;\n                        &lt;Array as=\"points\"&gt;\n                            &lt;mxPoint x=\"220\" y=\"310\"/&gt;\n                            &lt;mxPoint x=\"220\" y=\"330\"/&gt;\n                        &lt;/Array&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"57\" value=\"switch_to()\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"245\" y=\"300\" width=\"70\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"66\" value=\"\u539f\u8def\u8fd4\u56de\" style=\"endArrow=classic;html=1;rounded=1;strokeColor=#b85450;align=center;verticalAlign=middle;fontFamily=Helvetica;fontSize=11;fontColor=default;labelBackgroundColor=default;resizable=0;startArrow=classic;startFill=1;fillColor=#f8cecc;\" parent=\"1\" edge=\"1\"&gt;\n                    &lt;mxGeometry x=\"0.1175\" width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"210\" y=\"320\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"210\" y=\"160\" as=\"targetPoint\"/&gt;\n                        &lt;Array as=\"points\"&gt;\n                            &lt;mxPoint x=\"190\" y=\"230\"/&gt;\n                        &lt;/Array&gt;\n                        &lt;mxPoint as=\"offset\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"70\" style=\"edgeStyle=orthogonalEdgeStyle;html=1;entryX=1;entryY=0.5;entryDx=0;entryDy=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;dashed=1;\" edge=\"1\" parent=\"1\" source=\"68\" target=\"50\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"68\" value=\"Task2\" style=\"rounded=0;whiteSpace=wrap;html=1;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"575\" y=\"230\" width=\"70\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"71\" value=\"\" style=\"endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;\" edge=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"350\" y=\"380\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"350\" y=\"50\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"73\" value=\"&amp;lt;div&amp;gt;\u5230\u8fd9\u91cc\u4ec5\u5269&amp;lt;/div&amp;gt;&amp;lt;div&amp;gt;&amp;lt;span style=&amp;quot;background-color: transparent; color: rgb(63, 63, 63);&amp;quot;&amp;gt;callee-saved&amp;lt;/span&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div&amp;gt;\u5c5e\u4e8e Task1&amp;lt;/div&amp;gt;&amp;lt;div&amp;gt;\u9700\u8981\u4fdd\u5b58&amp;lt;/div&amp;gt;\" style=\"text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"410\" y=\"140\" width=\"90\" height=\"30\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"75\" value=\"C \u8bed\u8a00\" style=\"text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"280\" y=\"67\" width=\"60\" height=\"30\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"76\" value=\"\" style=\"endArrow=classic;html=1;\" edge=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"340\" y=\"97\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"280\" y=\"97\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"77\" value=\"\" style=\"endArrow=classic;html=1;\" edge=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"360\" y=\"97\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"420\" y=\"97\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"78\" value=\"\u6c47\u7f16\" style=\"text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"355\" y=\"67\" width=\"60\" height=\"30\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"83\" value=\"Task1\" style=\"text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"430\" y=\"35\" width=\"60\" height=\"30\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"84\" value=\"\" style=\"endArrow=classic;html=1;\" edge=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"490\" y=\"65\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"430\" y=\"65\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"85\" value=\"\" style=\"endArrow=classic;html=1;\" edge=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"510\" y=\"65\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"570\" y=\"65\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"86\" value=\"Task2\" style=\"text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"505\" y=\"35\" width=\"60\" height=\"30\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n            &lt;/root&gt;\n        &lt;/mxGraphModel&gt;\n    &lt;/diagram&gt;\n&lt;/mxfile&gt;"}' style="max-width:100%;border:1px solid transparent;"></div></a>
<figcaption>
<code>__switch_to()</code> 的调用和返回路径
    </figcaption>
</figure>
<p>理解了这些，我们容易设计出 <code>__switch_to()</code> 需要保存的进程上下文：</p>
<ul>
<li><code>ra</code>：函数返回地址，我们需要它来返回到调用 <code>__switch_to()</code> 的位置</li>
<li><code>sp</code>、<code>s0-s11</code>：调用约定中规定的 callee-saved 寄存器</li>
</ul>
<p>于是我们写出了进程上下文的数据结构：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-10-1"><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">thread_struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-2"><a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">ra</span><span class="p">;</span><span class="w">      </span><span class="c1">// return address</span>
</span><span id="__span-10-3"><a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">sp</span><span class="p">;</span><span class="w">      </span><span class="c1">// stack pointer</span>
</span><span id="__span-10-4"><a href="#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">s</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span><span class="w">   </span><span class="c1">// callee-saved registers</span>
</span><span id="__span-10-5"><a href="#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="p">};</span>
</span></code></pre></div>
<p>那么这个结构体应该存放在哪里呢？具体存放的位置暂且按下不表，留到设计进程数据结构时再说。先假设调用 <code>__switch_to()</code> 时 <code>a0</code> 和 <code>a1</code> 分别指向 Task1 和 Task2 的 <code>thread_struct</code> 结构体，那么 <code>__switch_to()</code> 的实现就很简单了：</p>
<div class="language-asm highlight"><span class="filename">第一版 __switch_to</span><pre><span></span><code><span id="__span-11-1"><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="w">    </span><span class="na">.globl</span><span class="w"> </span><span class="no">__switch_to</span>
</span><span id="__span-11-2"><a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="nl">__switch_to:</span>
</span><span id="__span-11-3"><a href="#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">ra</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span><span class="w">          </span><span class="c1">// 保存 Task1 上下文</span>
</span><span id="__span-11-4"><a href="#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
</span><span id="__span-11-5"><a href="#__codelineno-11-5" id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">s0</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
</span><span id="__span-11-6"><a href="#__codelineno-11-6" id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">    </span><span class="na">...</span>
</span><span id="__span-11-7"><a href="#__codelineno-11-7" id="__codelineno-11-7" name="__codelineno-11-7"></a>
</span><span id="__span-11-8"><a href="#__codelineno-11-8" id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">ra</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="no">a1</span><span class="p">)</span><span class="w">          </span><span class="c1">// 恢复 Task2 上下文</span>
</span><span id="__span-11-9"><a href="#__codelineno-11-9" id="__codelineno-11-9" name="__codelineno-11-9"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">(</span><span class="no">a1</span><span class="p">)</span>
</span><span id="__span-11-10"><a href="#__codelineno-11-10" id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">s0</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">(</span><span class="no">a1</span><span class="p">)</span>
</span><span id="__span-11-11"><a href="#__codelineno-11-11" id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="w">    </span><span class="na">...</span>
</span><span id="__span-11-12"><a href="#__codelineno-11-12" id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="w">    </span><span class="nf">ret</span><span class="w">                    </span><span class="c1">// 返回到 Task2</span>
</span></code></pre></div>
<blockquote>
<p>还能再换个角度：站在 Task1 的角度看，调用 <code>__switch_to()</code> <strong>就像调用了一个空函数</strong>。它遵守 RISC-V 调用约定，但什么都没做，原路返回了。</p>
</blockquote>
<p>但切换的目标 Task 2 的上下文从哪里来？对于目前不考虑 Trap 的场景来说，只有两种可能：</p>
<ol>
<li>Task 2 之前运行过，但主动调用 <code>__switch_to()</code> 切换到别的进程。这种情况<strong>保存过进程上下文</strong>，能够顺利恢复。</li>
<li>Task 2 是新创建的进程，尚未运行过。这种情况需要我们<strong>设计一个初始的进程上下文</strong>。</li>
</ol>
<p>初始进程上下文的设计也很简单：令 <code>ra</code> 指向进程的第一条指令，<code>__switch_to()</code> 就会跳过去开始执行。如果要考虑向进程传递参数，可以利用 <code>s0-s11</code> 这些寄存器，然后设置一个蹦床函数（trampoline）来将其移动到 <code>a0-a7</code> 作为参数。事实上 Linux 就是这么实现 kthread 的初始上下文的，这个蹦床函数如下所示：</p>
<div class="language-asm highlight"><span class="filename">(Linux)arch/riscv/kernel/entry.S</span><pre><span></span><code><span id="__span-12-1"><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="nf">SYM_CODE_START</span><span class="p">(</span><span class="no">ret_from_fork_kernel_asm</span><span class="p">)</span>
</span><span id="__span-12-2"><a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">    </span><span class="nf">call</span><span class="w"> </span><span class="no">schedule_tail</span>
</span><span id="__span-12-3"><a href="#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">    </span><span class="nf">move</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">s1</span><span class="w"> </span><span class="cm">/* fn_arg */</span>
</span><span id="__span-12-4"><a href="#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">    </span><span class="nf">move</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="no">s0</span><span class="w"> </span><span class="cm">/* fn */</span>
</span><span id="__span-12-5"><a href="#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">    </span><span class="nf">move</span><span class="w"> </span><span class="no">a2</span><span class="p">,</span><span class="w"> </span><span class="no">sp</span><span class="w"> </span><span class="cm">/* pt_regs */</span>
</span><span id="__span-12-6"><a href="#__codelineno-12-6" id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="w">    </span><span class="nf">call</span><span class="w"> </span><span class="no">ret_from_fork_kernel</span>
</span><span id="__span-12-7"><a href="#__codelineno-12-7" id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="w">    </span><span class="nf">j</span><span class="w"> </span><span class="no">ret_from_exception</span>
</span><span id="__span-12-8"><a href="#__codelineno-12-8" id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="nf">SYM_CODE_END</span><span class="p">(</span><span class="no">ret_from_fork_kernel_asm</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-c highlight"><span class="filename">(Linux)arch/riscv/kernel/process.c</span><pre><span></span><code><span id="__span-13-1"><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="n">asmlinkage</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">ret_from_fork_kernel</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">fn_arg</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w"> </span><span class="o">*</span><span class="n">regs</span><span class="p">)</span>
</span><span id="__span-13-2"><a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="p">{</span>
</span><span id="__span-13-3"><a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">    </span><span class="n">fn</span><span class="p">(</span><span class="n">fn_arg</span><span class="p">);</span>
</span><span id="__span-13-4"><a href="#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a>
</span><span id="__span-13-5"><a href="#__codelineno-13-5" id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">    </span><span class="n">syscall_exit_to_user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
</span><span id="__span-13-6"><a href="#__codelineno-13-6" id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="p">}</span>
</span></code></pre></div>
<p>从代码中可以看出，Linux 将 kthread 要运行的函数 <code>fn</code> 放在了初始进程上下文的 <code>s0</code> 寄存器中，将参数 <code>fn_arg</code> 放在了 <code>s1</code> 寄存器中。蹦床函数 <code>ret_from_fork_kernel_asm</code> 将它们分别移动到 <code>a1</code> 和 <code>a0</code>，然后调用 <code>ret_from_fork_kernel</code> 去具体执行。</p>
<h3 id="进程切换抢占与-trap-处理">进程切换：抢占与 Trap 处理<a class="headerlink" href="#进程切换抢占与-trap-处理" title="Permanent link">¶</a></h3>
<p>当我们希望实现<a href="https://kernelnewbies.org/FAQ/Preemption">内核抢占（Kernel preemption）</a>时，情况就变得复杂了起来，需要综合考虑时钟中断、系统调用等 Trap 情况。</p>
<h4 id="切换调度trap-与抢占的关系">切换、调度、Trap 与抢占的关系<a class="headerlink" href="#切换调度trap-与抢占的关系" title="Permanent link">¶</a></h4>
<p>先理清几个概念：</p>
<ul>
<li>
<p><strong>进程切换（context switch）</strong>：</p>
<p>由上文讨论的 <code>__switch_to()</code> 执行，完成进程上下文切换</p>
</li>
<li>
<p><strong>调度（schedule）</strong>：</p>
<p>由将在 Part 4 介绍的 <code>schedule()</code> 执行，使用调度算法选择要切换到的进程，并调用 <code>__switch_to()</code> 完成切换</p>
</li>
<li>
<p><strong>Trap</strong>：</p>
<p>CPU 异常和中断引发，可能发生在任何时候，由 <code>_traps()</code> 处理，负责保存和恢复 Trap 上下文</p>
</li>
<li>
<p><strong>抢占</strong>：</p>
<p>在进程不主动执行切换或调度的情况下，能够打断当前进程的执行触发<strong>调度</strong>，从而实现时间复用</p>
</li>
</ul>
<p>这几个概念的联系是：<strong>抢占</strong>是通过在 <strong>Trap</strong> 退出路径上视情况<strong>调度</strong>实现的。接下来的几节我们将分析这一关系。</p>
<h4 id="内核中不能被-trap-的部分">内核中不能被 Trap 的部分<a class="headerlink" href="#内核中不能被-trap-的部分" title="Permanent link">¶</a></h4>
<p>首先，我们要明确内核中不能被 Trap 的部分。回忆 RISC-V 中断机制，进入 Trap 处理时，CPU 会自动执行下面的操作禁用中断：</p>
<ul>
<li><code>sstatus.SPIE = sstatus.SIE</code></li>
<li><code>sstatus.SIE = 0</code></li>
</ul>
<p>此外，我们设计 <code>_traps()</code> 时会确保不触发异常。<strong>所以，Trap 处理过程是不会被 Trap 的。</strong></p>
<p>其他部分似乎都可以被 Trap，毕竟我们设计 <code>_traps()</code> 时就考虑到它随时可能发生，会将所有整数寄存器保存到 Trap 上下文中。</p>
<h4 id="抢占的时机">抢占的时机<a class="headerlink" href="#抢占的时机" title="Permanent link">¶</a></h4>
<p>要实现抢占，只能寄希望于（时钟）中断打断 Task1 的执行，才有机会切换到 Task2。接下来我们用<strong>排除法和反证法</strong>寻找这个机会在哪里：</p>
<ul>
<li><strong>Trap 上下文恢复过程</strong>显然不能切换，否则就破坏 Trap 上下文了。</li>
<li><strong>Trap 上下文恢复完成</strong>（离开 <code>_traps()</code>）后，就回到 Task 1 没机会切换进程了。</li>
<li>
<p><strong>Trap 处理过程（<code>trap_handler()</code>）</strong>不能 <code>__switch_to()</code>，因为中断还没处理完。</p>
<p>Trap 的处理过程指的是从 <code>xIP.i</code> 置 1、中断 Pending 开始，到该 Pending 位被置 0 为止。以 Lab1 涉及的 Trap 情况为例：</p>
<ul>
<li>时钟中断的处理从 SEE 发现 <code>stimecmp &gt; stime</code> 然后将 <code>STIP</code> 置 1 开始，到 <code>sbi_set_timer()</code> 将 <code>STIP</code> 置 0 结束</li>
<li>软件中断的处理从 <code>SSIP</code> 置 1 开始，到 <code>clear_ssip()</code> 将 <code>SSIP</code> 置 0 结束。</li>
</ul>
<p>如果 Trap 处理未完成就切换：</p>
<ul>
<li>因为切换不涉及 <code>SIE</code>，新的进程继续运行在中断禁用的状态，无法响应新的中断。</li>
<li>
<p>如果非要打开 <code>SIE</code>，那么 CPU 马上会再次触发该 Trap，再次进入 <code>_traps()</code>，重复循环下去导致栈 <code>sp</code> 溢出。</p>
<blockquote>
<p>你是否想起这一情况与 Lab1「动手做」探究的为什么能进入 <code>printk()</code> 类似。<code>printk()</code> 的情况比较幸运，<code>sp</code> 最初位于 OpenSBI 保护的地址，爆栈也没有破坏 OpenSBI 的代码和数据，最终走到了 <code>0x7???????</code> 之类的位置（并未探究这是什么地方，反正既不是内核也不是 OpenSBI）。但是当我们将 <code>sp</code> 设置为内核栈后，爆栈向下增长将直接破坏内核数据（data 段）和代码（text 段），导致系统崩溃。</p>
</blockquote>
</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>没有理解上面论述的同学，请仔细阅读 RISC-V 特权级手册 3.1.9. Machine Interrupt (mip and mie) Registers 部分，彻底理解中断触发和清除的机制。</p>
</div>
</li>
</ul>
<p>通过上面的讨论，我们只能将 <code>__switch_to()</code> 安排在 <code>trap_handler()</code> 的末尾。</p>
<h3 id="进程切换引入并发">进程切换：引入并发<a class="headerlink" href="#进程切换引入并发" title="Permanent link">¶</a></h3>
<p>在上两节的论述中，我们已经说明了进程切换的两种可能性：</p>
<ol>
<li><strong>非抢占式</strong>：发生时机确定，在进程主动调用 <code>__switch_to()</code> 时发生；</li>
<li><strong>抢占式</strong>：发生时机不确定，只要发生（时钟）中断，<code>trap_handler()</code> 就会调用 <code>__switch_to()</code>，发生进程切换。</li>
</ol>
<div class="admonition tip">
<p class="admonition-title">关于 <code>__switch_to()</code> 和 <code>schedule()</code> 关系的说明</p>
<p><strong>事实上，上面的论述不完全准确。</strong>同学们将在 Task 4 中实现<code>schedule()</code> 函数，我们并不会主动调用 <code>__switch_to()</code>，而是调用 <code>schedule()</code> ，让它来接管 <code>__switch_to()</code> 函数。同学们在这里只需要知道：在完整完成实验后，进程是否切换将由调度器控制。</p>
<p>因此，事实上，进程切换的可能性来自两个方面：</p>
<ol>
<li>（时钟）中断何时触发是未知的，它可能在代码运行的任意时刻发生；</li>
<li><code>schedule()</code> 是否会触发 <code>__switch_to()</code> 是未知的，调度器有可能在计算后决定不调度。</li>
</ol>
</div>
<p>既然进程切换在任意时刻都有可能发生，我们必须要考虑进程切换引入的新问题——<strong>并发 (Concurrency)</strong>。</p>
<p>在单核处理器上，虽然两个进程不能在同一时刻<strong>真正</strong>被执行，但由于调度器（尤其是抢占式调度）的存在，一个进程的执行可能在任意时刻被中断，切换到另一个进程。这种执行流交错进行，仿佛它们在同时运行，被称为<strong>伪并发 (pseudo-concurrency)</strong> 。</p>
<p>这种并发访问共享数据时可能导致问题。如果一个进程在访问某个共享资源（如全局变量、共享内存）的过程中被非自愿地抢占，而新调度的进程也去访问<strong>同一个</strong>资源，就可能导致数据损坏或不一致，这种情况被称为<strong>竞争条件 (Race Condition)</strong> 。</p>
<p>我们把访问共享资源的代码区域称为<strong>临界区 (Critical Region)</strong>。为了保证系统的稳定，我们必须识别出这些临界区，并使用保护机制来防止并发访问。那么，我们具体应该如何保护临界区呢？</p>
<div class="admonition note">
<p class="admonition-title">解决方案</p>
<p>我们在上面已经分析了进程切换的可能性，在单核操作系统中，内核并发的主要来源是<strong>中断</strong>（只有它可能导致抢占式调度）。因此，解决临界区问题最直接的方法就是<strong>关闭中断</strong>。</p>
<p>在单核环境中关闭中断，意味着当前执行的线程不能被（时钟）中断抢占。因此，如果我们能做到：</p>
<ul>
<li>在进入临界区之前关闭中断</li>
<li>在离开临界区时再开启中断</li>
</ul>
<p>便能够避免当前执行临界区代码的线程被打断，从而保证任意时刻只有一个线程在执行临界区内的代码。</p>
<details class="tip">
<summary>更严格的理由</summary>
<p>在理论课上，同学们将会学习<strong>临界区问题的三个条件</strong>（互斥访问、有限等待、空闲让进），大家可以思考在单核环境下关闭中断是否满足解决这三个条件。由于理论课的进度暂时滞后于实验内容，这里暂时不展开讨论。</p>
</details>
</div>
<details class="tip">
<summary>多核处理器 (SMP) 带来的新挑战</summary>
<p>在前面的讨论中，我们明确了在单核处理器上，关闭中断是解决内核并发（抢占）问题的有效手段。</p>
<p>然而，在<strong>多核处理器（Symmetrical Multiprocessing, SMP）</strong>上，我们就没有那么幸运了。</p>
<p>在 SMP 系统上，两个或多个处理器可以<strong>在完全相同的时间</strong>执行内核代码，这被称为<strong>“真正并发” (true concurrency)</strong>，而不再是单核上的“伪并发”。</p>
<p>请思考这种情况：</p>
<ol>
<li>CPU 0 进入了一个临界区。</li>
<li>CPU 0 为了防止被抢占，执行了“关闭中断”指令。</li>
<li><strong>与此同时</strong>，CPU 1 也在执行内核代码，并且它决定进入<em>同一个</em>临界区。</li>
</ol>
<p>此时，CPU 0 关闭中断只影响了 CPU 0 自己，它无法阻止 CPU 1 的运行。CPU 0 和 CPU 1 会同时访问和修改临界区中的内容，这同样会导致竞争条件。</p>
<p>因此，在多核环境中，关闭中断<strong>不是一个有效</strong>的同步机制。我们必须引入更强大的<strong>锁</strong>，例如<strong>自旋锁 (Spin Locks)</strong>，来确保在任何时刻只有一个 CPU 核心能进入特定的临界区。</p>
</details>
<h4 id="例子-1内核数据结构">例子 1：内核数据结构<a class="headerlink" href="#例子-1内核数据结构" title="Permanent link">¶</a></h4>
<p>让我们考虑一个具体的例子。在我们的内核中，所有进程的任务控制块（PCB）都可能通过一个全局的链表 <code>task_list</code> 来管理。当一个进程结束（例如调用 <code>do_exit</code>）时，我们需要将其从 <code>task_list</code> 中移除。这个移除操作（<code>list_del</code>）通常涉及多个指令（下面的代码仅作演示，实验框架中的真实实现可能不同）：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-14-1"><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="n">prev_task</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_task</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span><span id="__span-14-2"><a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="n">next_task</span><span class="o">-&gt;</span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_task</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
</span></code></pre></div>
<p>请你思考这种情况：</p>
<ul>
<li>当内核正在执行第 1 步时，突然发生了一个时钟中断。</li>
<li>中断处理程序 <code>trap_handler</code> 调用了 <code>schedule</code>，切换到了另一个进程。</li>
<li>如果这个新进程恰好也要遍历 <code>task_list</code>，它会读到一个处于“中间状态”、已经损坏的链表（<code>prev_task</code> 的 <code>next</code> 指针是对的，但 <code>next_task</code> 的 <code>prev</code> 指针还是错的），这可能带来非预期的行为，甚至导致系统崩溃。</li>
</ul>
<p>这就是一个典型的竞争条件：<code>task_list</code> 是共享数据，而修改 <code>task_list</code> 的代码（如 <code>list_del</code>）就是一个临界区。为了保护它，我们必须在修改链表之前关闭中断，并在修改完成后重新开启中断。</p>
<div class="admonition warning">
<p class="admonition-title">实现正确的临界区保护</p>
<p>我们在实验框架中已经为大家考虑所有可能的临界区并进行了保护。你可以阅读 <code>csr.h</code> 中的 <code>interrupt_save()</code> 和 <code>interrupt_restore()</code> 函数，理解它们是如何操作 <code>sstatus</code> 寄存器来开启和关闭中断的。</p>
<div class="language-c highlight"><span class="filename">csr.h</span><pre><span></span><code><span id="__span-15-1"><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">interrupt_save</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span id="__span-15-2"><a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">interrupt_restore</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span></code></pre></div>
<p>值得注意的有两点：</p>
<ul>
<li>我们在进入临界区前保存了中断状态，并在离开临界区时恢复原有状态，而不是简单地开启中断。这是为了防止嵌套临界区的问题。</li>
<li>临界区保护应该总是交给调用者来完成，而不是由被调用的函数（如 <code>list_del</code>）来完成。这样可以让调用者根据具体情况决定是否需要保护。</li>
</ul>
</div>
<h4 id="例子-2进程切换过程">例子 2：进程切换过程<a class="headerlink" href="#例子-2进程切换过程" title="Permanent link">¶</a></h4>
<p>一个更微妙的临界区是我们用于进程切换的 <code>__switch_to()</code> 函数本身。上文我们将 <code>__switch_to()</code> 放置在 <code>_traps()</code> 的末尾以实现抢占，那么它还能被 Trap 吗？请你思考这样的场景：</p>
<ul>
<li>Task 1 主动调用 <code>__switch_to()</code> 切换到其他任务，我们把这次调用称为 A</li>
<li>在这个 <code>__switch_to()</code> 过程中，时钟中断触发，进入 <code>_traps()</code> 处理</li>
<li>Trap 处理完成后，因为我们安排了时钟中断触发进程切换，于是又开始调用 <code>__switch_to()</code> 切换到其他任务，我们把这次调用称为 B</li>
</ul>
<p>请问 A 和 B 都能顺利完成吗？请你思考后再展开下面的答案。</p>
<details class="note">
<summary>答案</summary>
<p>B 保存的上下文覆盖了 A 保存的上下文，A 再也没办法恢复了。示意图如下：</p>
<p></p><figure markdown="span">
<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../lab2.assets/double_switch.drawio"><div class="mxgraph" data-mxgraph='{"toolbar": "zoom", "tooltips": "1", "border": 5, "resize": "1", "edit": "_blank", "highlight": null, "xml": "&lt;mxfile host=\"65bd71144e\"&gt;\n    &lt;diagram id=\"MKEIpqsYV9xL4WX14Jkj\" name=\"Page-1\"&gt;\n        &lt;mxGraphModel dx=\"534\" dy=\"542\" grid=\"1\" gridSize=\"10\" guides=\"1\" tooltips=\"1\" connect=\"1\" arrows=\"1\" fold=\"1\" page=\"1\" pageScale=\"1\" pageWidth=\"850\" pageHeight=\"1100\" math=\"0\" shadow=\"0\"&gt;\n            &lt;root&gt;\n                &lt;mxCell id=\"0\"/&gt;\n                &lt;mxCell id=\"1\" parent=\"0\"/&gt;\n                &lt;mxCell id=\"46\" value=\"\" style=\"endArrow=none;html=1;entryX=0;entryY=0;entryDx=0;entryDy=0;dashed=1;endFill=0;\" parent=\"1\" target=\"12\" edge=\"1\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"160\" y=\"140\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"225\" y=\"141\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"58\" value=\"call\" style=\"edgeStyle=orthogonalEdgeStyle;shape=connector;rounded=1;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;strokeColor=default;align=center;verticalAlign=middle;fontFamily=Helvetica;fontSize=11;fontColor=default;labelBackgroundColor=default;resizable=0;endArrow=classic;exitX=0;exitY=0.5;exitDx=0;exitDy=0;endFill=1;\" parent=\"1\" source=\"8\" target=\"12\" edge=\"1\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"&gt;\n                        &lt;Array as=\"points\"&gt;\n                            &lt;mxPoint x=\"220\" y=\"130\"/&gt;\n                            &lt;mxPoint x=\"220\" y=\"150\"/&gt;\n                        &lt;/Array&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"8\" value=\"Task 1\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"245\" y=\"120\" width=\"70\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"60\" value=\"call\" style=\"edgeStyle=orthogonalEdgeStyle;shape=connector;rounded=1;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;strokeColor=default;align=center;verticalAlign=middle;fontFamily=Helvetica;fontSize=11;fontColor=default;labelBackgroundColor=default;resizable=0;endArrow=classic;endFill=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;\" parent=\"1\" source=\"12\" target=\"18\" edge=\"1\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"&gt;\n                        &lt;Array as=\"points\"&gt;\n                            &lt;mxPoint x=\"220\" y=\"150\"/&gt;\n                            &lt;mxPoint x=\"220\" y=\"170\"/&gt;\n                        &lt;/Array&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"12\" value=\"schedule()\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"245\" y=\"140\" width=\"70\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"49\" value=\"call\" style=\"edgeStyle=orthogonalEdgeStyle;rounded=1;html=1;strokeColor=#6c8ebf;align=center;verticalAlign=middle;fontFamily=Helvetica;fontSize=11;fontColor=default;labelBackgroundColor=default;resizable=0;endArrow=block;endFill=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fillColor=#dae8fc;\" parent=\"1\" source=\"18\" target=\"48\" edge=\"1\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"18\" value=\"switch_to()\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"245\" y=\"160\" width=\"70\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"47\" value=\"\u5f00\u59cb\u5207\u6362\" style=\"text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"80\" y=\"130\" width=\"70\" height=\"30\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"89\" value=\"\u65f6\u949f\u4e2d\u65ad\u76f4\u63a5\u6253\u65ad\u6267\u884c\" style=\"edgeStyle=none;html=1;exitX=0.25;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;\" edge=\"1\" parent=\"1\" source=\"48\" target=\"88\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"440\" y=\"240\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"91\" value=\"\u5199\u5165 A\" style=\"edgeStyle=orthogonalEdgeStyle;html=1;exitX=0.25;exitY=0;exitDx=0;exitDy=0;entryX=0;entryY=0.25;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;\" edge=\"1\" parent=\"1\" source=\"48\" target=\"90\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"108\" value=\"\u56de\u4e0d\u53bb\u4e86\" style=\"edgeStyle=orthogonalEdgeStyle;html=1;exitX=0.75;exitY=0;exitDx=0;exitDy=0;entryX=1;entryY=0.25;entryDx=0;entryDy=0;fillColor=#f8cecc;strokeColor=#b85450;\" edge=\"1\" parent=\"1\" source=\"48\" target=\"18\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"48\" value=\"__switch_to()\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"435\" y=\"194.5\" width=\"130\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"71\" value=\"\" style=\"endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;\" parent=\"1\" edge=\"1\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"350\" y=\"380\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"350\" y=\"50\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"93\" style=\"edgeStyle=orthogonalEdgeStyle;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;exitX=0.25;exitY=1;exitDx=0;exitDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;\" edge=\"1\" parent=\"1\" source=\"88\" target=\"92\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"95\" style=\"edgeStyle=orthogonalEdgeStyle;html=1;exitX=0.75;exitY=1;exitDx=0;exitDy=0;entryX=0.25;entryY=0;entryDx=0;entryDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;\" edge=\"1\" parent=\"1\" source=\"88\" target=\"94\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"106\" value=\"\u8fd4\u56de\" style=\"edgeStyle=orthogonalEdgeStyle;html=1;entryX=1;entryY=0.5;entryDx=0;entryDy=0;exitX=1;exitY=0.25;exitDx=0;exitDy=0;fillColor=#d5e8d4;strokeColor=#82b366;\" edge=\"1\" parent=\"1\" source=\"88\" target=\"48\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"88\" value=\"_traps\" style=\"rounded=0;whiteSpace=wrap;html=1;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"428\" y=\"260\" width=\"80\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"104\" value=\"\u8fd4\u56de\u8bfb\u53d6 B\" style=\"edgeStyle=orthogonalEdgeStyle;html=1;exitX=0.75;exitY=1;exitDx=0;exitDy=0;entryX=1;entryY=0;entryDx=0;entryDy=0;fillColor=#d5e8d4;strokeColor=#82b366;\" edge=\"1\" parent=\"1\" source=\"90\" target=\"94\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"107\" value=\"&amp;lt;div&amp;gt;&amp;lt;font style=&amp;quot;color: rgb(204, 0, 0);&amp;quot;&amp;gt;\u8fd4\u56de\u8bfb\u53d6 B&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;font style=&amp;quot;color: rgb(204, 0, 0);&amp;quot;&amp;gt;\u7206\u4e86&amp;lt;/font&amp;gt;\" style=\"edgeStyle=orthogonalEdgeStyle;html=1;exitX=0;exitY=0.75;exitDx=0;exitDy=0;entryX=1;entryY=0;entryDx=0;entryDy=0;fillColor=#f8cecc;strokeColor=#b85450;fontSize=14;\" edge=\"1\" parent=\"1\" source=\"90\" target=\"48\"&gt;\n                    &lt;mxGeometry x=\"0.3374\" y=\"10\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint y=\"-1\" as=\"offset\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"90\" value=\"\u5b58\u653e Task1 \u8fdb\u7a0b\u4e0a\u4e0b\u6587\u7684\u5730\u65b9\" style=\"rounded=0;whiteSpace=wrap;html=1;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"600\" y=\"100\" width=\"130\" height=\"40\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"96\" value=\"\u5904\u7406\u5b8c\u4e86\uff0cSIE \u5904\u4e8e\u5f00\u542f\u72b6\u6001\" style=\"edgeStyle=none;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;\" edge=\"1\" parent=\"1\" source=\"92\" target=\"94\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"92\" value=\"trap_handler()\" style=\"rounded=0;whiteSpace=wrap;html=1;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"385\" y=\"310\" width=\"80\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"98\" value=\"\u5199\u5165 B&amp;lt;div&amp;gt;&amp;lt;font style=&amp;quot;color: rgb(204, 0, 0);&amp;quot;&amp;gt;A \u4e22\u5931\u4e86&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;\" style=\"edgeStyle=orthogonalEdgeStyle;html=1;entryX=0.167;entryY=1.066;entryDx=0;entryDy=0;entryPerimeter=0;fillColor=#dae8fc;strokeColor=#6c8ebf;\" edge=\"1\" parent=\"1\" source=\"94\" target=\"90\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"105\" value=\"\u8fd4\u56de\" style=\"edgeStyle=orthogonalEdgeStyle;html=1;exitX=0.75;exitY=0;exitDx=0;exitDy=0;entryX=1;entryY=0.75;entryDx=0;entryDy=0;fillColor=#d5e8d4;strokeColor=#82b366;\" edge=\"1\" parent=\"1\" source=\"94\" target=\"88\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"94\" value=\"__switch_to()\" style=\"rounded=0;whiteSpace=wrap;html=1;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"640\" y=\"310\" width=\"80\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"99\" style=\"edgeStyle=orthogonalEdgeStyle;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;dashed=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fillColor=#dae8fc;strokeColor=#6c8ebf;\" edge=\"1\" parent=\"1\" target=\"101\" source=\"94\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"740\" y=\"330\" as=\"sourcePoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"102\" value=\"\u8fd4\u56de\" style=\"edgeStyle=orthogonalEdgeStyle;html=1;exitX=0.75;exitY=0;exitDx=0;exitDy=0;entryX=1;entryY=0;entryDx=0;entryDy=0;dashed=1;fillColor=#d5e8d4;strokeColor=#82b366;\" edge=\"1\" parent=\"1\" source=\"101\" target=\"94\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"&gt;\n                        &lt;Array as=\"points\"&gt;\n                            &lt;mxPoint x=\"802\" y=\"310\"/&gt;\n                        &lt;/Array&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"101\" value=\"Task2\" style=\"rounded=0;whiteSpace=wrap;html=1;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"750\" y=\"355\" width=\"70\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n            &lt;/root&gt;\n        &lt;/mxGraphModel&gt;\n    &lt;/diagram&gt;\n&lt;/mxfile&gt;"}' style="max-width:100%;border:1px solid transparent;"></div></a>
<figcaption>
    抢占导致的双重进程切换
    </figcaption>
</figure><p></p>
<p>因此 <code>__switch_to()</code> 不能被抢占，进入 <code>__switch_to()</code> 时必须禁用中断。</p>
<blockquote>
<p>如果整个 <code>_traps()</code> 不会触发 <code>__switch_to()</code>，那么 <code>__switch_to()</code> 应当是可以抢占的。但如果 <code>_traps()</code> 不触发进程切换，时钟中断还有意义吗？还能实现抢占吗？这一点留给有兴趣的同学思考，助教也没有深入思考过，欢迎讨论。</p>
</blockquote>
</details>
<div class="admonition success">
<p class="admonition-title">恭喜你</p>
<p>至此，你已经彻底理解了<strong>内核抢占的原理</strong>（注意这与用户态抢占不同，仅用户态抢占的实现很容易）。Linux 在 2.6 版本才引入内核抢占。当其他班级还在 Linux 0.11 时，你已经领先了 12 年😉。</p>
</div>
<div class="admonition info">
<p class="admonition-title">更多资料</p>
<ul>
<li><a href="https://stackoverflow.com/questions/11779397/what-happens-to-preempted-interrupt-handler">linux kernel - What happens to preempted interrupt handler? - Stack Overflow</a></li>
<li><a href="https://kernelnewbies.org/FAQ/Preemption">FAQ/Preemption - Linux Kernel Newbies</a></li>
</ul>
</div>
<h4 id="讨论所有切换情况">讨论所有切换情况<a class="headerlink" href="#讨论所有切换情况" title="Permanent link">¶</a></h4>
<p>然而到这里，我们并没有解决所有的问题。请你注意：进程的切换可能带来中断状态的变化，如果新切换的进程并没有开启中断，那么它就无法响应时钟中断，进而无法被抢占。</p>
<p>下面，我们讨论<strong>抢占、主动切换、初始上下文</strong>共 <span class="arithmatex">\(2 \times 3 = 6\)</span> 种切换情况：</p>
<table>
<thead>
<tr>
<th>情况</th>
<th>Task 1 状态</th>
<th>Task 2 状态</th>
<th>用 <code>__switch_to()</code> 切换后 Task 2 会怎么样运行</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>抢占</td>
<td>抢占</td>
<td>通过 <code>_traps()</code> 返回，其中 <code>sret</code> 重新开启中断</td>
</tr>
<tr>
<td>2</td>
<td>抢占</td>
<td>主动切换</td>
<td>通过 <code>schedule</code> 返回，返回路径上手动开启中断</td>
</tr>
<tr>
<td>3</td>
<td>抢占</td>
<td>初始上下文</td>
<td>返回路径上没有其他地方开启中断</td>
</tr>
<tr>
<td>4</td>
<td>主动切换</td>
<td>抢占</td>
<td>通过 <code>_traps()</code> 返回，其中 <code>sret</code> 重新开启中断</td>
</tr>
<tr>
<td>5</td>
<td>主动切换</td>
<td>主动切换</td>
<td>通过 <code>schedule</code> 返回，返回路径上手动开启中断</td>
</tr>
<tr>
<td>6</td>
<td>主动切换</td>
<td>初始上下文</td>
<td>返回路径上没有其他地方开启中断</td>
</tr>
</tbody>
</table>
<ul>
<li>情况 1 和 4 没有问题，因为 <code>_traps()</code> 会重新开启中断。</li>
<li>情况 2 和 5 也没有问题，因为 <code>schedule</code> 是临界区，我们会在它的调用前后手动关闭和开启中断。</li>
<li>情况 3 和 6 有问题，因为初始上下文的蹦床函数中没有开启中断。因此我们需要<strong>在蹦床函数中手动开启中断</strong>以解决这一问题。</li>
</ul>
<p>至此，我们彻底完成了内核抢占情况下进程切换的设计。这一部分思维量较大，建议同学们现在阅读代码理解：</p>
<ul>
<li><code>kernel/arch/riscv/kernel/proc.c</code> 中的 <code>switch_to()</code> 实现</li>
<li><code>kernel/arch/riscv/kernel/entry.S</code> 中的 <code>__switch_to()</code> 和 <code>__kthread()</code> 实现</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">检查 <code>_traps()</code>的实现</p>
<p>在 Lab1 中，<code>_traps()</code> 必须要保存的仅有除 caller-saved 寄存器之外的所有整数寄存器。</p>
<p>但是看完上面的内容，同学们应该注意到，<strong>现在 <code>_traps()</code> 执行过程也会被打断</strong>，通过 <code>trap_handler()</code> 切换到其他进程。这时候，我们要思考<strong>还</strong>有哪些寄存器是必须要保存的。</p>
<p>请同学们思考后再打开下面的答案。</p>
<details class="note">
<summary>答案</summary>
<ul>
<li>
<p>CSR 寄存器。因为 <code>__switch_to()</code> 会开启中断，下一次中断触发就会导致相关 CSR 寄存器被修改。所以需要保存下列寄存器：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-16-1"><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a>sstatus sepc
</span></code></pre></div>
<p>进一步地，请同学们思考为什么 <code>scause</code>、<code>stval</code> 不需要保存。</p>
</li>
<li>
<p>其他寄存器依然不需要保存，因为仍有 RISC-V 调用约定为我们保驾护航。</p>
</li>
</ul>
</details>
</div>
<div class="admonition question">
<p class="admonition-title">考点：进程切换与 Trap</p>
<ul>
<li><code>__switch_to()</code> 为什么只需要保存 <code>ra</code>、<code>sp</code>、<code>s0–s11</code>？</li>
<li>蹦床函数（<code>__kthread</code>）是如何运行的？请说明 <code>ra</code>、<code>sp</code>、<code>s0/s1</code> 的设置意图。</li>
<li>为什么 <code>__switch_to()</code> 不能被抢占？</li>
<li>为什么调度点必须放在 <code>trap_handler()</code> 尾部？若在 Trap 处理中切换会导致哪些具体问题？</li>
<li>为什么 <code>_traps()</code> 需要额外保存 <code>sstatus</code>？<code>sret</code> 依据 <code>SPIE</code> 如何决定是否重新开启中断？</li>
<li>六种切换情形中，哪些路径上需要谁来“开启中断”？请逐一给出理由。</li>
</ul>
</div>
<h3 id="进程数据结构和内存布局">进程数据结构和内存布局<a class="headerlink" href="#进程数据结构和内存布局" title="Permanent link">¶</a></h3>
<p>理解完进程切换机制，我们终于可以开始设计进程的数据结构了。我们需要存储的信息包括：</p>
<ul>
<li><code>uint64_t pid</code> 进程 ID</li>
<li><code>struct thread_struct thread</code> 进程的上下文</li>
<li>
<p><code>void *stack</code> 进程的栈</p>
<p>如果不给每个进程独立的栈，则会产生下图所示的局面：</p>
<p></p><figure markdown="span">
<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../lab2.assets/no_stack.drawio"><div class="mxgraph" data-mxgraph='{"toolbar": "zoom", "tooltips": "1", "border": 5, "resize": "1", "edit": "_blank", "highlight": null, "xml": "&lt;mxfile host=\"65bd71144e\"&gt;\n    &lt;diagram id=\"CBWTxGyERXmDpSufS4Sj\" name=\"Page-1\"&gt;\n        &lt;mxGraphModel dx=\"362\" dy=\"368\" grid=\"1\" gridSize=\"10\" guides=\"1\" tooltips=\"1\" connect=\"1\" arrows=\"1\" fold=\"1\" page=\"1\" pageScale=\"1\" pageWidth=\"850\" pageHeight=\"1100\" math=\"0\" shadow=\"0\"&gt;\n            &lt;root&gt;\n                &lt;mxCell id=\"0\"/&gt;\n                &lt;mxCell id=\"1\" parent=\"0\"/&gt;\n                &lt;mxCell id=\"3\" value=\"Task2 \u6808\u6570\u636e\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"210\" y=\"180\" width=\"100\" height=\"40\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"6\" value=\"Task1 \u6808\u6570\u636e\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"210\" y=\"140\" width=\"100\" height=\"40\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"7\" value=\"\" style=\"endArrow=classic;html=1;\" parent=\"1\" edge=\"1\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"180\" y=\"179.46\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"210\" y=\"179.46\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"8\" value=\"Task1 \u88ab\u5207\u6362\u51fa\u53bb\" style=\"text;html=1;align=right;verticalAlign=middle;whiteSpace=wrap;rounded=0;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"60\" y=\"160\" width=\"110\" height=\"30\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"16\" value=\"&amp;lt;font style=&amp;quot;color: rgb(204, 0, 0);&amp;quot;&amp;gt;\u56de\u6765\u7684&amp;lt;/font&amp;gt;&amp;lt;div&amp;gt;&amp;lt;font style=&amp;quot;color: rgb(204, 0, 0);&amp;quot;&amp;gt;Task1 \u6808&amp;lt;/font&amp;gt;&amp;lt;div&amp;gt;&amp;lt;font color=&amp;quot;#cc0000&amp;quot;&amp;gt;\u5411\u4e0b\u589e\u957f&amp;lt;br&amp;gt;&amp;lt;/font&amp;gt;&amp;lt;div&amp;gt;&amp;lt;font style=&amp;quot;color: rgb(204, 0, 0);&amp;quot;&amp;gt;\u5c06\u7834\u574f Task2&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;/div&amp;gt;\" style=\"rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fillStyle=hatch;fontColor=#CC0000;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"300\" y=\"180\" width=\"80\" height=\"70\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"17\" value=\"\" style=\"endArrow=classic;html=1;\" edge=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"180\" y=\"219.46\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"210\" y=\"219.46\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"18\" value=\"Task1 \u88ab\u5207\u6362\u56de\u6765\" style=\"text;html=1;align=right;verticalAlign=middle;whiteSpace=wrap;rounded=0;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"60\" y=\"200\" width=\"110\" height=\"30\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n            &lt;/root&gt;\n        &lt;/mxGraphModel&gt;\n    &lt;/diagram&gt;\n&lt;/mxfile&gt;"}' style="max-width:100%;border:1px solid transparent;"></div></a>
<figcaption>
    多个进程复用同一栈会导致冲突
    </figcaption>
</figure><p></p>
<p>细心的同学会注意到，这样的设计也让不同进程的 Trap 上下文分离了，存储在各自的栈上。</p>
</li>
<li>
<p><code>struct sched_entity se</code> Part 4 实现的调度器使用</p>
</li>
<li><code>struct list_head list</code> 所有进程数据结构都组织成一个双向循环链表，方便调度器遍历</li>
</ul>
<p>于是我们设计出了 <code>struct task_struct</code> 结构体来保存这些信息：</p>
<div class="language-c highlight"><span class="filename">kernel/arch/riscv/include/proc.h</span><pre><span></span><code><span id="__span-17-1"><a href="#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-2"><a href="#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span>
</span><span id="__span-17-3"><a href="#__codelineno-17-3" id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>
</span><span id="__span-17-4"><a href="#__codelineno-17-4" id="__codelineno-17-4" name="__codelineno-17-4"></a>
</span><span id="__span-17-5"><a href="#__codelineno-17-5" id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_entity</span><span class="w"> </span><span class="n">se</span><span class="p">;</span>
</span><span id="__span-17-6"><a href="#__codelineno-17-6" id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">thread_struct</span><span class="w"> </span><span class="kr">thread</span><span class="p">;</span>
</span><span id="__span-17-7"><a href="#__codelineno-17-7" id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">list</span><span class="p">;</span>
</span><span id="__span-17-8"><a href="#__codelineno-17-8" id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="p">};</span>
</span></code></pre></div>
<p>内存布局如下所示：</p>
<figure>
<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../lab2.assets/task_struct.drawio"><div class="mxgraph" data-mxgraph='{"toolbar": "zoom", "tooltips": "1", "border": 5, "resize": "1", "edit": "_blank", "highlight": null, "xml": "&lt;mxfile host=\"65bd71144e\"&gt;\n    &lt;diagram id=\"vo0tkf5X_ReAiEvZ1G07\" name=\"Page-1\"&gt;\n        &lt;mxGraphModel dx=\"340\" dy=\"234\" grid=\"1\" gridSize=\"10\" guides=\"1\" tooltips=\"1\" connect=\"1\" arrows=\"1\" fold=\"1\" page=\"1\" pageScale=\"1\" pageWidth=\"850\" pageHeight=\"1100\" math=\"0\" shadow=\"0\"&gt;\n            &lt;root&gt;\n                &lt;mxCell id=\"0\"/&gt;\n                &lt;mxCell id=\"1\" parent=\"0\"/&gt;\n                &lt;mxCell id=\"2\" value=\"\" style=\"rounded=0;whiteSpace=wrap;html=1;movable=1;resizable=1;rotatable=1;deletable=1;editable=1;locked=0;connectable=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"170\" y=\"190\" width=\"120\" height=\"110\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"3\" value=\"\" style=\"endArrow=none;html=1;\" parent=\"1\" edge=\"1\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"150\" y=\"190\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"170\" y=\"190\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"4\" value=\"\" style=\"endArrow=none;html=1;\" parent=\"1\" edge=\"1\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"150\" y=\"300\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"170\" y=\"300\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"5\" value=\"PGSIZE\" style=\"endArrow=classic;startArrow=classic;html=1;horizontal=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;\" parent=\"1\" source=\"7\" edge=\"1\" target=\"6\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"160\" y=\"370\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"160\" y=\"160\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"6\" value=\"High\" style=\"text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"100\" y=\"174\" width=\"60\" height=\"30\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"7\" value=\"Low\" style=\"text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"100\" y=\"283\" width=\"60\" height=\"30\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"8\" value=\"Stack\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"170\" y=\"190\" width=\"120\" height=\"40\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"55\" value=\".stack\" style=\"edgeStyle=none;html=1;\" parent=\"1\" source=\"9\" target=\"2\" edge=\"1\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint as=\"offset\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"9\" value=\"task_struct\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"170\" y=\"340\" width=\"120\" height=\"40\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"10\" value=\"\u5411\u4e0b\u589e\u957f\" style=\"endArrow=classic;html=1;\" parent=\"1\" edge=\"1\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"229.76000000000002\" y=\"220\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"230\" y=\"270\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"11\" value=\"thread_struct\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"180\" y=\"375\" width=\"100\" height=\"30\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"56\" value=\".stack\" style=\"edgeStyle=none;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;\" parent=\"1\" source=\"43\" edge=\"1\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"370\" y=\"300\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"43\" value=\"task_struct\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"310\" y=\"340\" width=\"120\" height=\"40\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"57\" value=\".stack\" style=\"edgeStyle=none;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;\" parent=\"1\" source=\"44\" edge=\"1\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"510\" y=\"300\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"44\" value=\"task_struct\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"450\" y=\"340\" width=\"120\" height=\"40\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"45\" value=\"\" style=\"endArrow=classic;startArrow=classic;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;\" parent=\"1\" source=\"9\" target=\"43\" edge=\"1\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"330\" y=\"390\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"380\" y=\"340\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"46\" value=\"\" style=\"endArrow=classic;startArrow=classic;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;\" parent=\"1\" source=\"43\" target=\"44\" edge=\"1\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"420\" y=\"510\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"470\" y=\"460\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"47\" value=\"\" style=\"endArrow=classic;startArrow=classic;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;elbow=vertical;edgeStyle=orthogonalEdgeStyle;\" parent=\"1\" source=\"51\" target=\"44\" edge=\"1\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"240\" y=\"510\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"290\" y=\"460\" as=\"targetPoint\"/&gt;\n                        &lt;Array as=\"points\"&gt;\n                            &lt;mxPoint x=\"10\" y=\"360\"/&gt;\n                            &lt;mxPoint x=\"10\" y=\"430\"/&gt;\n                            &lt;mxPoint x=\"580\" y=\"430\"/&gt;\n                            &lt;mxPoint x=\"580\" y=\"360\"/&gt;\n                        &lt;/Array&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"51\" value=\"list_head\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"30\" y=\"345\" width=\"120\" height=\"30\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"52\" value=\"\" style=\"endArrow=classic;startArrow=classic;html=1;\" parent=\"1\" source=\"51\" target=\"9\" edge=\"1\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"170\" y=\"470\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"220\" y=\"420\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"53\" value=\"thread_struct\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"320\" y=\"375\" width=\"100\" height=\"30\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"54\" value=\"thread_struct\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"460\" y=\"375\" width=\"100\" height=\"30\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"59\" value=\"\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"310\" y=\"190\" width=\"120\" height=\"110\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"60\" value=\"Stack\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"310\" y=\"190\" width=\"120\" height=\"40\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"63\" value=\"\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"450\" y=\"190\" width=\"120\" height=\"110\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"64\" value=\"Stack\" style=\"rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"450\" y=\"190\" width=\"120\" height=\"40\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"68\" value=\"\u5411\u4e0b\u589e\u957f\" style=\"endArrow=classic;html=1;\" parent=\"1\" edge=\"1\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"370\" y=\"220\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"370.24\" y=\"270\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"71\" value=\"\u5411\u4e0b\u589e\u957f\" style=\"endArrow=classic;html=1;\" parent=\"1\" edge=\"1\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"510\" y=\"220\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"510.24\" y=\"270\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n            &lt;/root&gt;\n        &lt;/mxGraphModel&gt;\n    &lt;/diagram&gt;\n&lt;/mxfile&gt;"}' style="max-width:100%;border:1px solid transparent;"></div></a>
<figcaption>
    进程数据结构示意图
    </figcaption>
</figure>
<p>此外，我们令 <code>tp</code>（RISC-V 调用约定称为 Thread Pointer）寄存器始终指向当前 CPU 上运行的进程的 <code>task_struct</code> 结构体，这样内核就能轻松地通过 <code>tp</code> 访问当前进程的信息。我们运用 Lab1 中内联汇编的知识，将该寄存器绑定到变量 <code>current</code> 方便在 C 代码中使用：</p>
<div class="language-c highlight"><span class="filename">kernel/arch/riscv/include/proc.h</span><pre><span></span><code><span id="__span-18-1"><a href="#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="k">register</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">current</span><span class="w"> </span><span class="k">asm</span><span class="p">(</span><span class="s">"tp"</span><span class="p">);</span>
</span></code></pre></div>
<h3 id="task-2设置初始进程">Task 2：设置初始进程<a class="headerlink" href="#task-2设置初始进程" title="Permanent link">¶</a></h3>
<p>请补全 <code>kernel/arch/riscv/kernel/proc.c</code> 文件中的 <code>task_init()</code> 函数，实现初始化第一个内核进程（init 进程）的功能。具体要求如下：</p>
<ul>
<li>使用 <code>kmem_cache_create()</code> 创建 <code>task_struct</code> 对象缓存池，并分配一个新的 <code>task_struct</code> 结构体作为初始进程。</li>
<li>初始化该进程的各项字段，包括 <code>pid</code>、<code>stack</code>、<code>state</code>、<code>se</code>（调度实体，见 Part4）等。</li>
<li>将该进程设置为当前运行进程，并将其加入进程链表（<code>task_list</code>）。</li>
</ul>
<p>完成后，<code>start_kernel</code> 将作为第一个 Task，进而能够通过它切换到其他进程，为后续进程管理和调度打下基础。</p>
<div class="admonition success">
<p class="admonition-title">完成条件</p>
<ul>
<li>通过评测框架的 Lab2 Task2 测试。本 Task 涉及调度相关字段，同学们可能需要阅读 Part4 后再回来做才能通过测试。</li>
</ul>
<p>本测试会在进入 <code>start_kernel()</code> 时检查 <code>tp</code> 及其指向的 <code>task_struct</code> 结构体是否正确初始化。</p>
</div>
<h2 id="part-3进程生命周期">Part 3：进程生命周期<a class="headerlink" href="#part-3进程生命周期" title="Permanent link">¶</a></h2>
<p>本节我们实现 kthread 的创建、运行和退出，完成进程的生命周期管理。</p>
<h3 id="进程复制与加载">进程复制与加载<a class="headerlink" href="#进程复制与加载" title="Permanent link">¶</a></h3>
<p>Windows 使用 <a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa?redirectedfrom=MSDN"><code>CreateProcess()</code></a> <strong>创建进程</strong>，这个接口庞大且僵化，还有好几个衍生版本：</p>
<div class="language-cpp highlight"><span class="filename">processthreadsapi.h</span><pre><span></span><code><span id="__span-19-1"><a href="#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="n">BOOL</span><span class="w"> </span><span class="nf">CreateProcessA</span><span class="p">(</span>
</span><span id="__span-19-2"><a href="#__codelineno-19-2" id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="p">]</span><span class="w">      </span><span class="n">LPCSTR</span><span class="w">                </span><span class="n">lpApplicationName</span><span class="p">,</span>
</span><span id="__span-19-3"><a href="#__codelineno-19-3" id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="p">]</span><span class="w"> </span><span class="n">LPSTR</span><span class="w">                 </span><span class="n">lpCommandLine</span><span class="p">,</span>
</span><span id="__span-19-4"><a href="#__codelineno-19-4" id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="p">]</span><span class="w">      </span><span class="n">LPSECURITY_ATTRIBUTES</span><span class="w"> </span><span class="n">lpProcessAttributes</span><span class="p">,</span>
</span><span id="__span-19-5"><a href="#__codelineno-19-5" id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="p">]</span><span class="w">      </span><span class="n">LPSECURITY_ATTRIBUTES</span><span class="w"> </span><span class="n">lpThreadAttributes</span><span class="p">,</span>
</span><span id="__span-19-6"><a href="#__codelineno-19-6" id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">]</span><span class="w">                </span><span class="n">BOOL</span><span class="w">                  </span><span class="n">bInheritHandles</span><span class="p">,</span>
</span><span id="__span-19-7"><a href="#__codelineno-19-7" id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">]</span><span class="w">                </span><span class="n">DWORD</span><span class="w">                 </span><span class="n">dwCreationFlags</span><span class="p">,</span>
</span><span id="__span-19-8"><a href="#__codelineno-19-8" id="__codelineno-19-8" name="__codelineno-19-8"></a><span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="p">]</span><span class="w">      </span><span class="n">LPVOID</span><span class="w">                </span><span class="n">lpEnvironment</span><span class="p">,</span>
</span><span id="__span-19-9"><a href="#__codelineno-19-9" id="__codelineno-19-9" name="__codelineno-19-9"></a><span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="p">]</span><span class="w">      </span><span class="n">LPCSTR</span><span class="w">                </span><span class="n">lpCurrentDirectory</span><span class="p">,</span>
</span><span id="__span-19-10"><a href="#__codelineno-19-10" id="__codelineno-19-10" name="__codelineno-19-10"></a><span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">]</span><span class="w">                </span><span class="n">LPSTARTUPINFOA</span><span class="w">        </span><span class="n">lpStartupInfo</span><span class="p">,</span>
</span><span id="__span-19-11"><a href="#__codelineno-19-11" id="__codelineno-19-11" name="__codelineno-19-11"></a><span class="w">  </span><span class="p">[</span><span class="n">out</span><span class="p">]</span><span class="w">               </span><span class="n">LPPROCESS_INFORMATION</span><span class="w"> </span><span class="n">lpProcessInformation</span>
</span><span id="__span-19-12"><a href="#__codelineno-19-12" id="__codelineno-19-12" name="__codelineno-19-12"></a><span class="p">);</span>
</span></code></pre></div>
<p>而 Unix 进程模型将其分为两步：</p>
<ol>
<li><code>fork()</code>：<strong>复制</strong>当前进程，创建一个新进程</li>
<li><code>exec()</code>：在当前进程的上下文中<strong>加载</strong>并执行一个新的程序</li>
</ol>
<p>在 <code>fork()</code> 后 <code>exec()</code> 前，可以自由配置新的进程。当内核引入新的功能时，也无需修改 <code>fork</code>/<code>exec</code> 的接口。这样<strong>复制 + 加载</strong>的设计比<strong>直接创建</strong>更灵活，体现了<strong>组合优于复杂接口</strong>的 Unix 哲学。</p>
<p><code>fork()</code> 和 <code>exec()</code> 是提供给用户态程序的系统调用接口，将在 Lab4 进行封装。本次实验在内核态中实现相应的底层功能：</p>
<ul>
<li><code>copy_process()</code>：<strong>拷贝</strong>当前 Task</li>
<li><code>kernel_thread()</code>：修改前者创建的 Task，在其中<strong>运行新的函数</strong></li>
</ul>
<h3 id="task-3实现进程复制与加载">Task 3：实现进程复制与加载<a class="headerlink" href="#task-3实现进程复制与加载" title="Permanent link">¶</a></h3>
<p>请补全 <code>kernel/arch/riscv/kernel/proc.c</code> 文件中的 <code>copy_process()</code> 和 <code>kernel_thread()</code> 函数，实现内核线程的创建流程：</p>
<ul>
<li><code>copy_process(struct task_struct *old)</code>：复制当前进程的数据结构，分配新的内核栈，分配唯一的进程号，并初始化调度相关字段（见 Part4），将新进程加入进程链表。</li>
<li>
<p><code>kernel_thread(int (*fn)(void *), void *arg)</code>：</p>
<ul>
<li>回忆 Part2 非抢占情况，我们讨论了如何设计初始进程上下文，通过 <code>struct thread_struct</code> 向蹦床函数传递要运行的函数和参数。</li>
<li>
<p>和 Linux 一样，我们规定<strong>内核线程执行的函数的接口</strong>如下所示：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-20-1"><a href="#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">fn</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">);</span>
</span></code></pre></div>
<p>基于此规定，框架已经实现了用于内核线程的蹦床函数 <code>__kthread()</code>，请你理解它的工作原理。</p>
</li>
<li>
<p>请你在 <code>kernel_thread()</code> 中调用 <code>copy_process()</code> 创建新进程，并根据对 <code>__kthread()</code> 的理解设置新进程的初始上下文。</p>
</li>
</ul>
</li>
</ul>
<p>补全后，内核将能够通过 <code>kernel_thread()</code> 创建新的内核线程，并正确初始化其执行环境。</p>
<div class="admonition success">
<p class="admonition-title">完成条件</p>
<ul>
<li>通过评测框架的 <code>lab2 task3</code> 测试。与 Task2 一样，本 Task 涉及调度相关字段，同学们可能需要阅读 Part4 后再回来做才能通过测试。</li>
</ul>
<p>本测试会检查 <code>start_kernel</code> 中调用 <code>kernel_thread(kthreadd, NULL)</code> 创建的进程上下文是否正确。</p>
</div>
<h3 id="进程退出与销毁">进程退出与销毁<a class="headerlink" href="#进程退出与销毁" title="Permanent link">¶</a></h3>
<p>当一个内核线程结束任务、退出执行，与其相关的资源需要被销毁，这包括 <code>struct task_struct</code> 结构体及其通过指针引用的成员（如内核栈）等。</p>
<p><strong>进程没有办法析构自己</strong>，这一逻辑很容易理解。如果进程析构自身，那么析构工作也是进程运行的一部分。只要进程仍在运行状态，释放相关资源就可能导致悬空指针等问题。因此可以将进程的析构设计为退出和销毁两个阶段：</p>
<ul>
<li><code>do_exit()</code>：进程完成所有任务后调用该函数，将自身状态置为 <code>TASK_DEAD</code>，然后主动发起调度，此后它再也不会被调度运行，可以安全释放</li>
<li><code>release_task()</code>：调度离开上一步的进程后，随时可以释放其资源</li>
</ul>
<p>此外，我们还会实现一个辅助函数：</p>
<ul>
<li>
<p><code>kthread()</code>：内核线程的 <strong>Wrapper</strong>，只是为了帮助在每个内核线程结束后调用 <code>do_exit()</code>，这样就不用让所有工作函数都显式调用 <code>do_exit()</code> 了。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-21-1"><a href="#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="k">noreturn</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">kthread</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span>
</span><span id="__span-21-2"><a href="#__codelineno-21-2" id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="p">{</span>
</span><span id="__span-21-3"><a href="#__codelineno-21-3" id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kthread_create_info</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="p">;</span>
</span><span id="__span-21-4"><a href="#__codelineno-21-4" id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">threadfn</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">threadfn</span><span class="p">;</span>
</span><span id="__span-21-5"><a href="#__codelineno-21-5" id="__codelineno-21-5" name="__codelineno-21-5"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
</span><span id="__span-21-6"><a href="#__codelineno-21-6" id="__codelineno-21-6" name="__codelineno-21-6"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadfn</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</span><span id="__span-21-7"><a href="#__codelineno-21-7" id="__codelineno-21-7" name="__codelineno-21-7"></a><span class="w">    </span><span class="n">do_exit</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
</span><span id="__span-21-8"><a href="#__codelineno-21-8" id="__codelineno-21-8" name="__codelineno-21-8"></a><span class="p">}</span>
</span></code></pre></div>
<p>一个例外是 <code>kthreadd</code> 线程（在刚刚的 Task 中见过），<strong>它是第一个内核线程，负责创建其他内核线程</strong>。<strong>它永远不会退出</strong>，因此不需要 <code>kthread()</code> 包装。</p>
</li>
</ul>
<p>由于 <code>do_exit()</code> 依赖于调度器，这部分的任务留到 Part 4 一起完成。</p>
<div class="admonition question">
<p class="admonition-title">考点：进程数据结构与生命周期</p>
<ul>
<li>为什么每个任务必须有独立内核栈？</li>
<li><code>current</code> 与 <code>tp</code> 的绑定带来什么便利？在 C 代码中使用它时要注意什么？</li>
<li><code>task_init()</code> 至少需要初始化哪些关键字段，如何把它设为当前任务并加入 <code>task_list</code>？</li>
<li><code>copy_process()</code> 哪些字段应该“复制”，哪些必须“重新初始化”？</li>
<li><code>kernel_thread()</code> 如何构造新任务的初始上下文才能正确跳到 <code>__kthread</code> 并传参？</li>
</ul>
</div>
<h2 id="part-4调度器">Part 4：调度器<a class="headerlink" href="#part-4调度器" title="Permanent link">¶</a></h2>
<p>到本节，我们终于可以把<strong>进程切换</strong>这个词升级为<strong>调度</strong>了。我们将研究调度算法，由它选择要切换的进程。</p>
<h3 id="时间片轮转调度">时间片轮转调度<a class="headerlink" href="#时间片轮转调度" title="Permanent link">¶</a></h3>
<p>RR 调度算法已经在理论课上讲过了，这里把 PPT 内容再贴一遍：</p>
<blockquote>
<ul>
<li>
<p>基本思路：通过时间片轮转，提高进程并发性和响应时间特性，从而提高资源利用率。</p>
</li>
<li>
<p>RR 算法：</p>
<ul>
<li>将系统中所有的就绪进程按照 FCFS 原则，排成一个队列。</li>
<li>每次调度时将 CPU 分派给队首进程，让其执行一个时间片 (time slice) 。</li>
<li>在一个时间片结束时，暂停当前进程的执行，将其送到就绪队列的末尾，并通过上下文切换执行就绪队列的队首进程。</li>
<li>进程可以未使用完一个时间片，就出让 CPU（如阻塞）。</li>
</ul>
</li>
</ul>
</blockquote>
<p>考虑 <code>struct sched_entity</code> 的设计。对于 RR 调度来说，需要保存的信息就是进程的时间片（剩余多少时间）。此外下文提及的 <code>test_sched.c</code> 测例需要使用累计时间来安排进程的创建顺序，额外新增一个字段，但它并非调度算法所必需。</p>
<div class="language-c highlight"><span class="filename">kernel/arch/riscv/include/proc.h</span><pre><span></span><code><span id="__span-22-1"><a href="#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">sched_entity</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-2"><a href="#__codelineno-22-2" id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">runtime</span><span class="p">;</span><span class="w"> </span><span class="cm">/**&lt; 时间片 */</span>
</span><span id="__span-22-3"><a href="#__codelineno-22-3" id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">sum_exec_runtime</span><span class="p">;</span><span class="w"> </span><span class="cm">/**&lt; 已执行时间 */</span>
</span><span id="__span-22-4"><a href="#__codelineno-22-4" id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="p">};</span>
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">要点：RR 调度算法的实现</p>
<p>为了在我们的框架中正确实现 RR 调度算法，请注意以下几个要点：</p>
<ul>
<li><strong>调度顺序</strong>：<ul>
<li>进程的调度遵循 FCFS 的原则，因此在将进程加入任务队列时，应确保新进程被添加到<strong>队列的末尾</strong>。</li>
<li>当进程的时间片耗尽，应当以合适的方式确定下一个被调度的进程（可以通过修改队列或者设计恰当的遍历顺序实现）。</li>
</ul>
</li>
<li><strong>时间片管理</strong>：<ul>
<li>每个进程在被调度时，都会获得一个固定的时间片（<code>TIME_SLICE</code>）。</li>
<li>在每次 <code>schedule()</code> 调用时，应检查当前进程的剩余时间片并进行更新。（在计算消耗时间片的大小时，我们并没有严格地区分调度器执行的时间开销和进程执行的时间，因此你可以忽略非进程本身（<code>process()</code>函数）执行的部分，把“当前时间”同时作为上一进程的结束时间和下一进程的开始时间）</li>
</ul>
</li>
<li><strong>进程资源管理</strong>：<ul>
<li>在调度器中，应当确保已经退出的进程（<code>TASK_DEAD</code>）的资源被正确释放。</li>
</ul>
</li>
<li><strong>调度间隔</strong>：<ul>
<li>时钟中断的间隔与调度算法有关，我们依赖于时钟中断进行时间片管理和进程抢占，因此你需要修改时钟中断频率，从原来的 1s 改为 <code>kernel/arch/riscv/include/sched.h</code> 中定义的 <code>TIMER_INTERVAL</code></li>
</ul>
</li>
</ul>
</div>
<h3 id="task-4实现时间片轮转调度和抢占">Task 4：实现时间片轮转调度和抢占<a class="headerlink" href="#task-4实现时间片轮转调度和抢占" title="Permanent link">¶</a></h3>
<ul>
<li>请补全 <code>kernel/arch/riscv/kernel/sched.c</code> 文件中的 <code>schedule()</code> 函数，实现时间片轮转调度算法。</li>
<li>请补全 <code>kernel/arch/riscv/kernel/proc.c</code> 文件中的 <code>do_exit()</code> 和 <code>release_task()</code> 函数，实现内核线程的退出与销毁。</li>
<li>在 <code>trap_handler()</code> 的末尾调用 <code>schedule()</code>，从而启用内核抢占，彻底完成本次实验。</li>
</ul>
<div class="admonition success">
<p class="admonition-title">完成条件</p>
<ul>
<li>通过评测框架的 <code>lab2 task4</code> 测试。</li>
</ul>
<p>该测试会在 <code>release_task()</code> 处打断点，观测整个进程调度过程，检查进程的创建和退出是否符合上述时间片轮转调度算法计算的结果。</p>
<p>👿 评测场景可能与手动运行场景有所不同，因为 GDB 的存在可能改变程序运行的时序逻辑，触发隐藏的临界区问题，导致程序崩溃（当然也不排除单纯只是你的调度算法实现有问题）。同学们遇到问题时也可以查看 <code>tests/console.log</code> 日志，观察评测时的程序输出是否符合你的预期。</p>
</div>
<div class="admonition example">
<p class="admonition-title">动手做：计算响应比</p>
<p>除了基本的 RR 调度，实验框架还模仿了 Linux 的线程管理机制，引入了 <strong>异步内核线程创建</strong>。</p>
<p>具体流程如下：</p>
<ul>
<li>设置一个队列，用于存放待创建的内核线程请求；</li>
<li><code>kthreadd</code> 线程不断从该队列中取出请求，创建其他内核线程；</li>
<li>每次创建完成后，<code>kthreadd</code> 会<strong>立即让出 CPU</strong>（用完时间片），因此它几乎不占用调度时间；</li>
<li><code>kthread_create()</code> 用于提交创建请求，它会<strong>立即返回</strong>，不会等待线程真正启动（这点与 Linux 不同）。</li>
</ul>
<p></p><figure markdown="span">
<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../lab2.assets/kthreadd.drawio"><div class="mxgraph" data-mxgraph='{"toolbar": "zoom", "tooltips": "1", "border": 5, "resize": "1", "edit": "_blank", "highlight": null, "xml": "&lt;mxfile host=\"65bd71144e\"&gt;\n    &lt;diagram id=\"4BaiarvQKWnb2h1ZtwT6\" name=\"Page-1\"&gt;\n        &lt;mxGraphModel dx=\"2054\" dy=\"631\" grid=\"1\" gridSize=\"10\" guides=\"1\" tooltips=\"1\" connect=\"1\" arrows=\"1\" fold=\"1\" page=\"1\" pageScale=\"1\" pageWidth=\"850\" pageHeight=\"1100\" math=\"0\" shadow=\"0\"&gt;\n            &lt;root&gt;\n                &lt;mxCell id=\"0\"/&gt;\n                &lt;mxCell id=\"1\" parent=\"0\"/&gt;\n                &lt;mxCell id=\"3\" value=\"kthreadd()&amp;lt;div&amp;gt;PID 1&amp;lt;/div&amp;gt;\" style=\"rounded=0;whiteSpace=wrap;html=1;fontSize=12;fillColor=#dae8fc;strokeColor=#6c8ebf;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"130\" y=\"495\" width=\"180\" height=\"30\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"9\" value=\"kernel_thread()&amp;lt;div&amp;gt;\u7acb\u5373\u521b\u5efa&amp;lt;/div&amp;gt;\" style=\"edgeStyle=none;html=1;fillColor=#f8cecc;strokeColor=#b85450;labelBackgroundColor=none;\" parent=\"1\" source=\"8\" target=\"3\" edge=\"1\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"11\" value=\"kthread_create()&amp;lt;div&amp;gt;\u8bf7\u6c42\u521b\u5efa&amp;lt;/div&amp;gt;\" style=\"edgeStyle=none;html=1;fillColor=#d5e8d4;strokeColor=#82b366;labelBackgroundColor=none;\" parent=\"1\" source=\"8\" target=\"33\" edge=\"1\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"200\" y=\"611.4150943396227\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"8\" value=\"init_task()&amp;lt;div&amp;gt;PID 0&amp;lt;/div&amp;gt;\" style=\"rounded=0;whiteSpace=wrap;html=1;fontSize=12;fillColor=#dae8fc;strokeColor=#6c8ebf;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"-90\" y=\"625\" width=\"180\" height=\"30\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"16\" value=\"\" style=\"rounded=0;whiteSpace=wrap;html=1;fontSize=12;fillColor=#d5e8d4;strokeColor=#82b366;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"210\" y=\"610\" width=\"20\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"24\" value=\"&amp;lt;span style=&amp;quot;color: rgb(0, 0, 0);&amp;quot;&amp;gt;kthread_create()&amp;lt;/span&amp;gt;\" style=\"edgeStyle=none;html=1;fillColor=#d5e8d4;strokeColor=#82b366;labelBackgroundColor=none;\" parent=\"1\" source=\"18\" target=\"33\" edge=\"1\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"330\" y=\"620\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"18\" value=\"test_sched()&amp;lt;div&amp;gt;PID 2&amp;lt;/div&amp;gt;\" style=\"rounded=0;whiteSpace=wrap;html=1;fontSize=12;fillColor=#e1d5e7;strokeColor=#9673a6;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"460\" y=\"495\" width=\"90\" height=\"30\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"19\" value=\"for \u5faa\u73af\u8f6e\u8be2\u961f\u5217\" style=\"curved=1;endArrow=classic;html=1;fillColor=#d5e8d4;strokeColor=#82b366;\" parent=\"1\" edge=\"1\"&gt;\n                    &lt;mxGeometry y=\"-10\" width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"240\" y=\"540\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"200\" y=\"540\" as=\"targetPoint\"/&gt;\n                        &lt;Array as=\"points\"&gt;\n                            &lt;mxPoint x=\"290\" y=\"590\"/&gt;\n                            &lt;mxPoint x=\"150\" y=\"590\"/&gt;\n                        &lt;/Array&gt;\n                        &lt;mxPoint as=\"offset\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"20\" value=\"\" style=\"rounded=0;whiteSpace=wrap;html=1;fontSize=12;fillColor=#d5e8d4;strokeColor=#82b366;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"220\" y=\"620\" width=\"20\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"23\" value=\"process()&amp;lt;div&amp;gt;PID 3&amp;lt;/div&amp;gt;\" style=\"rounded=0;whiteSpace=wrap;html=1;fontSize=12;fillColor=#e1d5e7;strokeColor=#9673a6;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"410\" y=\"655\" width=\"85\" height=\"30\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"25\" value=\"kernel_thread(kthread)&amp;lt;div&amp;gt;\u7acb\u5373\u521b\u5efa&amp;lt;/div&amp;gt;&amp;lt;div&amp;gt;\u7531 kthread() wrap&amp;lt;/div&amp;gt;\" style=\"endArrow=classic;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;labelBackgroundColor=none;\" parent=\"1\" source=\"3\" target=\"18\" edge=\"1\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"280\" y=\"550\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"410\" y=\"500\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"26\" value=\"kernel_thread(kthread)\" style=\"endArrow=classic;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;labelBackgroundColor=none;\" parent=\"1\" source=\"3\" target=\"23\" edge=\"1\"&gt;\n                    &lt;mxGeometry x=\"0.0551\" y=\"-7\" width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"280\" y=\"550\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"450\" y=\"570\" as=\"targetPoint\"/&gt;\n                        &lt;mxPoint as=\"offset\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"28\" value=\"process()&amp;lt;div&amp;gt;PID 4&amp;lt;/div&amp;gt;\" style=\"rounded=0;whiteSpace=wrap;html=1;fontSize=12;fillColor=#e1d5e7;strokeColor=#9673a6;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"410\" y=\"685\" width=\"85\" height=\"30\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"29\" value=\"process()&amp;lt;div&amp;gt;PID ...&amp;lt;/div&amp;gt;\" style=\"rounded=0;whiteSpace=wrap;html=1;fontSize=12;fillColor=#e1d5e7;strokeColor=#9673a6;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"410\" y=\"715\" width=\"85\" height=\"30\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"30\" value=\"\" style=\"edgeStyle=none;html=1;fillColor=#d5e8d4;strokeColor=#82b366;labelBackgroundColor=none;\" parent=\"1\" source=\"23\" target=\"33\" edge=\"1\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"303\" y=\"590\" as=\"targetPoint\"/&gt;\n                        &lt;mxPoint x=\"468\" y=\"535\" as=\"sourcePoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"31\" value=\"\" style=\"rounded=0;whiteSpace=wrap;html=1;fontSize=12;fillColor=#d5e8d4;strokeColor=#82b366;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"230\" y=\"630\" width=\"20\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"32\" value=\"\" style=\"rounded=0;whiteSpace=wrap;html=1;fontSize=12;fillColor=#d5e8d4;strokeColor=#82b366;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"240\" y=\"640\" width=\"20\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"33\" value=\"kthread_create_list\" style=\"rounded=0;whiteSpace=wrap;html=1;fillColor=none;verticalAlign=top;labelPosition=center;verticalLabelPosition=bottom;align=center;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"200\" y=\"600\" width=\"70\" height=\"70\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"34\" value=\"\u539f\u751f\u8fdb\u7a0b&amp;lt;div&amp;gt;\u9700\u8981\u81ea\u5df1 do_exit()&amp;lt;/div&amp;gt;\" style=\"rounded=0;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;labelPosition=right;verticalLabelPosition=middle;align=left;verticalAlign=middle;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"-80\" y=\"495\" width=\"20\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"35\" value=\"kthreadd() \u521b\u5efa\u7684&amp;lt;div&amp;gt;kthread() wrap \u7684\u8fdb\u7a0b&amp;lt;/div&amp;gt;\" style=\"rounded=0;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;labelPosition=right;verticalLabelPosition=middle;align=left;verticalAlign=middle;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"-80\" y=\"525\" width=\"20\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"36\" value=\"kthread_create_info\" style=\"rounded=0;html=1;fillColor=#d5e8d4;strokeColor=#82b366;labelPosition=right;verticalLabelPosition=middle;align=left;verticalAlign=middle;\" parent=\"1\" vertex=\"1\"&gt;\n                    &lt;mxGeometry x=\"-80\" y=\"555\" width=\"20\" height=\"20\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"37\" value=\"\" style=\"endArrow=classic;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;labelBackgroundColor=none;\" parent=\"1\" source=\"3\" target=\"28\" edge=\"1\"&gt;\n                    &lt;mxGeometry x=\"0.0551\" y=\"-7\" width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"252\" y=\"535\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"441\" y=\"665\" as=\"targetPoint\"/&gt;\n                        &lt;mxPoint as=\"offset\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"38\" value=\"\" style=\"endArrow=classic;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;labelBackgroundColor=none;\" parent=\"1\" source=\"3\" target=\"29\" edge=\"1\"&gt;\n                    &lt;mxGeometry x=\"0.0551\" y=\"-7\" width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"262\" y=\"545\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"451\" y=\"675\" as=\"targetPoint\"/&gt;\n                        &lt;mxPoint as=\"offset\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"39\" value=\"&amp;lt;span style=&amp;quot;color: rgb(0, 0, 0);&amp;quot;&amp;gt;kthread_create()&amp;lt;/span&amp;gt;\" style=\"edgeStyle=none;html=1;fillColor=#d5e8d4;strokeColor=#82b366;labelBackgroundColor=none;\" parent=\"1\" source=\"28\" target=\"33\" edge=\"1\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"280\" y=\"645\" as=\"targetPoint\"/&gt;\n                        &lt;mxPoint x=\"420\" y=\"672\" as=\"sourcePoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"40\" value=\"\" style=\"edgeStyle=none;html=1;fillColor=#d5e8d4;strokeColor=#82b366;labelBackgroundColor=none;\" parent=\"1\" source=\"29\" target=\"33\" edge=\"1\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"290\" y=\"655\" as=\"targetPoint\"/&gt;\n                        &lt;mxPoint x=\"430\" y=\"682\" as=\"sourcePoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n            &lt;/root&gt;\n        &lt;/mxGraphModel&gt;\n    &lt;/diagram&gt;\n&lt;/mxfile&gt;"}' style="max-width:100%;border:1px solid transparent;"></div></a>
<figcaption>
    异步内核线程创建示意图
    </figcaption>
</figure><p></p>
<p>框架提供的 <code>test_sched.c</code> 模拟了理论课中的调度考题：</p>
<table>
<thead>
<tr>
<th>进程</th>
<th>请求创建时间</th>
<th>运行时间</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>0</td>
<td>10</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>4</td>
<td>2</td>
</tr>
<tr>
<td>4</td>
<td>5</td>
<td>1</td>
</tr>
<tr>
<td>5</td>
<td>8</td>
<td>5</td>
</tr>
</tbody>
</table>
<p>这里的“请求创建时间”指 <code>kthread_create()</code> 被调用的时刻，<strong>并不代表线程立即进入就绪队列</strong>。</p>
<p>当你完成所有任务后，运行内核，观察该测例的输出结果，<strong>计算 5 个进程的平均周转时间、平均等待时间和响应比</strong>。</p>
<p>值得一提的是，<strong>本「动手做」的运行结果在不同平台（x86、arm）、甚至同一平台上都会有所不同</strong>。同学们做完下一个「动手做」后应该能理解其原因，当你理解了这一点才算是抓住了现实中的调度算法的精髓。</p>
</div>
<div class="admonition example">
<p class="admonition-title">动手做：探究时间片对调度结果的影响</p>
<p>同学们可能会发现，开启/不开启调试时的调度结果不同。这是因为 GDB 在单步执行或频繁检查寄存器、内存状态时，会显著拖慢模拟器运行，导致所有指令变慢，用体系结构的术语说就是 IPC 变低了。<strong>请你解释为什么 IPC 变低会影响调度结果</strong>。</p>
<p>此外，也很容易想到 <code>TIME_SLICE</code>、<code>TIMER_INTERVAL</code> 两个宏的值如果设置不当，可能会导致调度结果发生各种各样的变化。<strong>请你思考可能发生的各种情况，然后尝试调整这两个宏的值，观察日志验证你的猜想。</strong></p>
<p>提示：这些问题本质上是在比较：</p>
<ul>
<li><strong>现实世界的时间（wall-clock time）</strong>：对应 RISC-V 架构中的 <code>time</code> 寄存器，QEMU 会保证其始终按 10MHz 的速率增长</li>
<li><strong>内核的逻辑时间</strong>：与调度算法的设计有关，在 RR 调度中它体现在时间片的消耗上</li>
</ul>
</div>
<div class="admonition question">
<p class="admonition-title">考点：调度与抢占</p>
<ul>
<li>RR 调度中时间片如何消耗与补充？当时间片耗尽时如何选择下一个任务？此选择与进程链表遍历顺序的关系是什么？</li>
<li>抢占从哪里触发？进入和离开 <code>__switch_to()</code> 前后，对中断位（<code>SIE/SPIE</code>）分别有什么要求？为什么？</li>
<li><code>do_exit()</code> 与 <code>release_task()</code> 分别在何处调用、各自职责是什么？为什么不能让进程“自我销毁”？</li>
<li><code>kthreadd</code> 有何特殊性？为什么几乎不占用调度时间？异步创建对公平性/饥饿有什么影响？</li>
</ul>
</div>
<h2 id="结语lab2-和-linux-调度器的历史">结语：Lab2 和 Linux 调度器的历史<a class="headerlink" href="#结语lab2-和-linux-调度器的历史" title="Permanent link">¶</a></h2>
<p>其实，实验框架最开始实现的是优先级调度，但是优先级调度算法很容易造成饥饿（Starvation），与 <code>kthreadd</code> 的异步创建机制冲突。举例：</p>
<ul>
<li>新的创建请求放入队列</li>
<li><code>kthreadd</code> 线程从队列中取出请求，创建新线程</li>
<li>默认情况下新线程与 <code>kthreadd</code> 线程<strong>优先级相同</strong>，但 PID 较大</li>
<li>在优先级相同的情况下，<code>schedule()</code> 的调度算法<strong>始终选择 PID 较小的进程</strong>（因为是从进程链表头开始遍历的）</li>
<li>新线程永远无法被调度运行</li>
</ul>
<p>使用理论课上讲的老化（动态优先级）可以解决饥饿问题，但不公平（Fairness）的问题仍然十分严重，难以平衡各个进程的响应时间。比如 <code>kthreadd</code> 可能需要很长的累积等待时间才能被调度运行，严重影响内核进程异步创建的能力。最终实验框架选用了 RR 调度，<strong>至少能平衡各个进程的响应时间</strong>。但由于没有实现阻塞和唤醒机制，RR 调度的优势也无法体现出来。</p>
<p>总的来说，Lab2 的内核抢占和进程管理已经成功改革到 Linux 2.6 时代，但调度算法和同步机制还没跟上，所以同学们做 Lab 时可能会觉得有些地方的实现不够合理，欢迎你来找助教讨论。</p>
<p>要想让 <code>kthreadd</code> 真正发挥作用，需要实现与 Linux 的<strong><a href="https://docs.kernel.org/scheduler/sched-design-CFS.html">完全公平调度器（Completely Fair Scheduler, CFS）</a></strong>类似的调度算法。感兴趣的同学可以自行阅读相关资料，它最终应该会在 Bonus B 中实现。</p>
<p>最后简单介绍一下 <a href="https://codemia.io/blog/path/The-Evolution-of-Linux-CPU-Schedulers-From-O1-to-CFS-to-UserSpace-Scheduling">Linux 的调度算法演进史</a>：</p>
<table>
<thead>
<tr>
<th>版本</th>
<th>调度算法</th>
<th>参考链接</th>
</tr>
</thead>
<tbody>
<tr>
<td>2.6 前</td>
<td><span class="arithmatex">\(O(n)\)</span> 调度器（其他班级实现的）</td>
<td><a href="https://elixir.bootlin.com/linux/0.11/source/kernel/sched.c#L122">sched.c - kernel/sched.c - Linux source code 0.11 - Bootlin Elixir Cross Referencer</a></td>
</tr>
<tr>
<td>2.6.0-2.6.22</td>
<td><span class="arithmatex">\(O(1)\)</span> 调度器</td>
<td><a href="https://litux.nl/mirror/kerneldevelopment/0672327201/ch04lev1sec2.html">The Linux Scheduling Algorithm - Linux Kernel Development Second Edition</a></td>
</tr>
<tr>
<td>2.6.23 - 6.6</td>
<td>CFS 调度器</td>
<td><a href="https://docs.kernel.org/scheduler/sched-design-CFS.html">CFS Scheduler — The Linux Kernel documentation</a></td>
</tr>
<tr>
<td>6.6 - 今</td>
<td>EEVDF 调度器</td>
<td><a href="https://docs.kernel.org/scheduler/sched-eevdf.html">EEVDF Scheduler — The Linux Kernel documentation</a></td>
</tr>
<tr>
<td>开发中</td>
<td><code>sched_ext</code> 通过 BPF 程序定制任意调度算法</td>
<td><a href="https://docs.kernel.org/scheduler/sched-ext.html">Extensible Scheduler Class — The Linux Kernel documentation</a></td>
</tr>
</tbody>
</table>
<aside class="md-source-file">
<span class="md-source-file__fact">
<span class="md-icon" title="Last update">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"></path></svg>
</span>
<span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="2025年11月1日 06:37:47 UTC"><span class="timeago" datetime="2025-11-01T06:37:47+00:00" locale="zh"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="2025年11月1日 06:37:47 UTC">2025-11-01</span>
</span>
<span class="md-source-file__fact">
<span class="md-icon" title="Created">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"></path></svg>
</span>
<span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="2025年10月7日 10:26:33 UTC"><span class="timeago" datetime="2025-10-07T10:26:33+00:00" locale="zh"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="2025年10月7日 10:26:33 UTC">2025-10-07</span>
</span>
<span class="md-source-file__fact">
<span class="md-icon" title="Contributors">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path></svg>
</span>
<span>GitHub</span>
<nav>
<a class="md-author" href="https://github.com/bowling233" title="@bowling233">
<img alt="bowling233" src="https://avatars.githubusercontent.com/u/35755846?v=4&amp;size=72"/>
</a>
<a class="md-author" href="https://github.com/hharryz" title="@hharryz">
<img alt="hharryz" src="https://avatars.githubusercontent.com/u/122276274?v=4&amp;size=72"/>
</a>
</nav>
</span>
</aside>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<nav aria-label="Footer" class="md-footer__inner md-grid">
<a aria-label="Previous: Lab 1：内核启动与时钟中断" class="md-footer__link md-footer__link--prev" href="../lab1/">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</div>
<div class="md-footer__title">
<span class="md-footer__direction">
                Previous
              </span>
<div class="md-ellipsis">
                Lab 1：内核启动与时钟中断
              </div>
</div>
</a>
<a aria-label="Next: Lab 3：Sv39 分页式虚拟内存系统" class="md-footer__link md-footer__link--next" href="../lab3/">
<div class="md-footer__title">
<span class="md-footer__direction">
                Next
              </span>
<div class="md-ellipsis">
                Lab 3：Sv39 分页式虚拟内存系统
              </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
<div class="md-copyright__highlight">
      浙江大学计算机科学与技术学院
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "content.code.select", "content.code.annotate", "navigation.footer", "navigation.sections", "navigation.expand", "navigation.indexes", "navigation.tracking", "navigation.path", "navigation.top", "toc.follow", "content.action.edit", "search.suggest", "search.highlight", "search.share"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
<script src="../js/timeago.min.js"></script>
<script src="../js/timeago_mkdocs_material.js"></script>
<script src="../javascripts/mathjax.js"></script>
<script src="https://cdn.jsdelivr.net/npm/polyfill/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tablesort/dist/tablesort.min.js"></script>
<script src="../javascripts/tablesort.js"></script>
<script src="../javascripts/mermaid.mjs" type="module"></script>
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script><script src="https://viewer.diagrams.net/js/viewer-static.min.js"></script></body></html>