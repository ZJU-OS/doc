{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"\u9996\u9875","text":""},{"location":"#\u6d59\u6c5f\u5927\u5b66\u64cd\u4f5c\u7cfb\u7edf\u8bfe\u7a0b\u4ed3\u5e93\u6587\u6863","title":"\u6d59\u6c5f\u5927\u5b66\u64cd\u4f5c\u7cfb\u7edf\u8bfe\u7a0b\u4ed3\u5e93\uff1a\u6587\u6863","text":"<p>\u672c\u6587\u6863\u9002\u7528\u4e8e \u5b63\u6c5f\u660e\u3001\u738b\u6d77\u5e05 \u8001\u5e08\u6388\u8bfe\u7684\u73ed\u7ea7\uff0c\u52a9\u6559\u4e3a \u6731\u5b9d\u6797\u3001\u5f20\u6052\u658c\u3002</p>"},{"location":"#\u5f15\u8a00","title":"\u5f15\u8a00","text":"<p>\u6b22\u8fce\u6765\u5230\u300a\u64cd\u4f5c\u7cfb\u7edf\u300b\u8bfe\u7a0b\u5b9e\u9a8c\u3002\u6309\u7167\u57f9\u517b\u65b9\u6848\uff0c\u4f60\u5df2\u7ecf\u5b8c\u6210\u4e86\u300a\u6570\u5b57\u903b\u8f91\u8bbe\u8ba1\u300b\u300a\u8ba1\u7b97\u673a\u7ec4\u6210\u300b\u300a\u8ba1\u7b97\u673a\u4f53\u7cfb\u7ed3\u6784\u300b\u7b49\u786c\u4ef6\u8bfe\u7a0b\u7684\u5b66\u4e60\uff0c\u4e86\u89e3\u4e86 RISC-V \u6307\u4ee4\u96c6\u67b6\u6784\u548c\u8ba1\u7b97\u673a\u7cfb\u7edf\u7684\u57fa\u672c\u7ec4\u6210\u3002\u73b0\u5728\uff0c\u6211\u4eec\u5c06\u8fdb\u5165\u8f6f\u4ef6\u90e8\u5206\uff0c\u52a8\u624b\u5b9e\u73b0\u4e00\u4e2a\u8fd0\u884c\u5728 RISC-V \u67b6\u6784\u4e0b\u7684\u7b80\u6613\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u3002</p> <p>OS \u5b9e\u9a8c\u4e3b\u8981\u8003\u5bdf\u5de5\u7a0b\u5b9e\u8df5\u80fd\u529b\uff0c\u6838\u5fc3\u8981\u70b9\u662f\u6309\u7167 RISC-V \u6307\u4ee4\u96c6\u89c4\u8303\uff0c\u4ee5 Linux \u4e3a\u53c2\u8003\u5b8c\u6210\u81ea\u5df1\u7684\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u3002\u8fd9\u9700\u8981\u4f60\u5177\u5907\u9605\u8bfb\u5927\u578b\u9879\u76ee\u7684\u82f1\u6587\u6587\u6863\u548c\u6e90\u4ee3\u7801\uff0c\u7406\u89e3\u76f8\u5173\u5185\u5bb9\u5e76\u52a8\u624b\u5b9e\u73b0\u7684\u80fd\u529b\u3002\u5de6\u4fa7\u5bfc\u822a\u680f\u4e2d\u5217\u51fa\u7684\u89c4\u8303\u3001\u6587\u6863\u548c\u6e90\u7801\u5c06\u4f34\u968f\u4f60\u7684\u6574\u4e2a\u5b9e\u9a8c\u8fc7\u7a0b\uff0c\u5b83\u4eec\u4f1a\u89e3\u7b54\u4f60\u6240\u6709\u7684\u56f0\u60d1\u3002</p> <p>\u540e\u7eed\u7684\u5b9e\u9a8c\u6587\u6863\u4f1a\u6307\u5f15\u540c\u5b66\u4eec\u53bb\u9605\u8bfb\u76f8\u5e94\u539f\u59cb\u8d44\u6599\uff0c\u800c\u4e0d\u4f1a\u8fdb\u884c\u7ffb\u8bd1\u548c\u590d\u8ff0\uff0c\u8fd9\u662f\u4e3a\u4e86\u907f\u514d\u4e0a\u6e38\u66f4\u65b0\u5bfc\u81f4\u5b9e\u9a8c\u6587\u6863\u8fc7\u65f6\u3001\u7b14\u8005\u6c34\u5e73\u6709\u9650\u4ea7\u751f\u6b67\u4e49\u548c\u8bef\u5bfc\u7b49\u60c5\u51b5\u3002\u6211\u4eec\u4f1a\u5728\u6bcf\u4e2a\u6587\u6863\u6307\u5f15\u4e0b\u653e\u7f6e\u4e00\u4e2a\u6298\u53e0\u7684\u8981\u70b9\uff0c\u5f3a\u70c8\u5efa\u8bae\u540c\u5b66\u4eec\u5728\u81ea\u884c\u9605\u8bfb\u539f\u59cb\u8d44\u6599\u540e\u518d\u5bf9\u7167\u603b\u7ed3\u8fdb\u884c\u81ea\u6d4b\u3002\u5982\u679c\u4f60\u5b9e\u5728\u4e0d\u613f\u610f\u3001\u6ca1\u65f6\u95f4\u6216\u770b\u4e0d\u61c2\u539f\u59cb\u8d44\u6599\uff0c\u53ef\u4ee5\u76f4\u63a5\u770b\u8981\u70b9\u3002\u4f46\u9047\u5230\u4e0d\u660e\u767d\u7684\u70b9\u6216\u8005\u4ea7\u751f\u95ee\u9898\u65f6\uff0c\u8fd8\u662f\u8981\u56de\u53bb\u8ba4\u771f\u770b\u539f\u59cb\u8d44\u6599\u3002</p> <p>\u4f60\u53ef\u4ee5\u901a\u8fc7\u524d\u4eba\u7684\u7b14\u8bb0\u5feb\u901f\u5165\u95e8\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>RISC-V ISA - \u9e64\u7fd4\u4e07\u91cc\u7684\u7b14\u8bb0\u672c</li> </ul> <p>\u4f46\u7b14\u8bb0\u5b58\u5728\u4e0a\u8ff0\u7684\u95ee\u9898\uff0c\u800c\u4e14\u5b83\u4eec\u5c31\u50cf Cache\uff0c\u867d\u7136\u5feb\u4f46\u603b\u4f1a Miss\uff0c\u5b9e\u9a8c\u8fc7\u7a0b\u4e2d\u4e00\u5b9a\u8981\u5e38\u770b\u539f\u59cb\u8d44\u6599\u3002</p> <p>\u4e0b\u9762\u662f\u5b9e\u9a8c\u6587\u6863\u7684\u683c\u5f0f\u4ecb\u7ecd\uff1a</p> <p>\u8003\u70b9</p> <p>\u5e0c\u671b\u540c\u5b66\u4eec\u80fd\u638c\u63e1\u7684\u77e5\u8bc6\u70b9\uff0c\u4f1a\u5728\u9a8c\u6536\u65f6\u63d0\u95ee\u3002</p> <p>\u52a8\u624b\u505a</p> <p>\u9700\u8981\u4f60\u52a8\u624b\u505a\u7684\u5185\u5bb9\uff0c\u8981\u6c42\u5b8c\u6210\u5e76\u8bb0\u5f55\u5230\u5b9e\u9a8c\u62a5\u544a\u4e2d\uff0c\u4e5f\u4f1a\u5728\u9a8c\u6536\u65f6\u63d0\u95ee\u3002</p>"},{"location":"#\u5b9e\u9a8c","title":"\u5b9e\u9a8c","text":""},{"location":"#\u5b89\u6392\u548c\u5206\u6570\u5360\u6bd4","title":"\u5b89\u6392\u548c\u5206\u6570\u5360\u6bd4","text":"<ul> <li>\u672a\u53d1\u5e03\u7684\u5b9e\u9a8c\u5b89\u6392\u53ef\u80fd\u8c03\u6574</li> <li>\u5c06\u9f20\u6807\u60ac\u505c\u5728\u8fdb\u5ea6\u6761\u4e0a\u53ef\u67e5\u770b\u5177\u4f53\u8d77\u6b62\u65e5\u671f</li> </ul> <p>\u6d59\u6c5f\u5927\u5b66 2025\u20142026 \u5b66\u5e74\u6821\u5386</p> 2025 Q3 Q4 Sep Oct Nov Dec W36W37W38W39W40W41W42W43W44W45W46W47W48W49W50W51W52W1 <p>Lab0 - Linux \u5185\u6838\u8c03\u8bd5\uff085%\uff09</p> \u9a8c\u6536 <p>Lab1 - \u542f\u52a8\u5f15\u5bfc\u4e0e\u65f6\u949f\u4e2d\u65ad\uff0815%\uff09</p> \u4ee3\u7801\u3001\u62a5\u544a \u9a8c\u6536 <p>Lab2 - \u62a2\u5360\u5f0f\u5185\u6838\u7ebf\u7a0b\u8c03\u5ea6\uff0815%\uff09</p> \u4ee3\u7801\u3001\u62a5\u544a \u9a8c\u6536 <p>Lab3 - \u865a\u62df\u5185\u5b58\uff0815%\uff09</p> \u4ee3\u7801\u3001\u62a5\u544a \u9a8c\u6536 <p>Lab4 - \u7528\u6237\u6a21\u5f0f\u4e0e\u7cfb\u7edf\u8c03\u7528\uff0820%\uff09</p> \u4ee3\u7801\u3001\u62a5\u544a \u9a8c\u6536 <p>Lab5 - \u7f3a\u9875\u5f02\u5e38\u4e0e\u8fdb\u7a0b\u521b\u5efa\uff0830%\uff09</p> \u4ee3\u7801\u3001\u62a5\u544a \u9a8c\u6536 <p>BonusA - \u78c1\u76d8\u4e0e\u6587\u4ef6\u7cfb\u7edf\uff0810%\uff09</p> \u4ee3\u7801\u3001\u62a5\u544a \u9a8c\u6536 <p>BonusB - \u591a\u6838\u5904\u7406\u5668\u4e0e\u8c03\u5ea6\u7b97\u6cd5\uff0810%\uff09</p> \u4ee3\u7801\u3001\u62a5\u544a \u9a8c\u6536 <p>Lab3-5 \u5141\u8bb8\u4e24\u4eba\u7ec4\u961f\u5b8c\u6210\uff0c\u7ec4\u961f\u653f\u7b56\u5982\u4e0b\uff1a</p> <ul> <li>\u4e3b\u8981\u76ee\u7684\u662f\u9632\u6b62\u53ea\u6709\u4e00\u4e2a\u4eba\u5e72\u6d3b\u7684\u60c5\u51b5\uff0c\u8981\u6c42\u7ec4\u961f\u7684\u540c\u5b66\u53c2\u4e0e\u5230\u6bcf\u4e2a\u5b9e\u9a8c\u4e2d</li> <li>\u4ee3\u7801\uff1a<ul> <li>\u8981\u6c42\u4e24\u4f4d\u540c\u5b66\u90fd\u6709\u63d0\u4ea4\u8bb0\u5f55\u3002\u6839\u636e Git Commit \u4e2d\u7684\u90ae\u7bb1\u5224\u5b9a\uff0c\u8bf7\u5c06\u63d0\u4ea4\u90ae\u7bb1\u8bbe\u7f6e\u4e3a\u81ea\u5df1\u7684\u5b66\u53f7\u90ae\u7bb1\u3002</li> <li>\u82e5\u65e0\u63d0\u4ea4\u8bb0\u5f55\u5219\u89c6\u4e3a\u672a\u5b8c\u6210\u8be5\u5b9e\u9a8c\u3002</li> </ul> </li> <li>\u9a8c\u6536\uff1a<ul> <li>\u8981\u6c42\u4e24\u4f4d\u540c\u5b66\u540c\u65f6\u5230\u573a\u3002\u9700\u8981\u8bf4\u660e\u5206\u5de5\u60c5\u51b5\uff0c\u8bb2\u6e05\u695a\u5404\u81ea\u8d1f\u8d23\u7684\u90e8\u5206\u3002</li> <li>\u82e5\u65e0\u6cd5\u8bb2\u6e05\u695a\u4ee3\u7801\u5728\u5e72\u4ec0\u4e48\u5219\u89c6\u4e3a\u672a\u5b8c\u6210\u8be5\u5b9e\u9a8c\u3002</li> </ul> </li> <li>\u62a5\u544a\uff1a\u8981\u6c42\u4e24\u4f4d\u540c\u5b66\u5404\u81ea\u64b0\u5199\u3002\u9700\u8981\u8bf4\u660e\u5206\u5de5\u60c5\u51b5\uff0c\u8bb2\u6e05\u695a\u81ea\u5df1\u8d1f\u8d23\u7684\u90e8\u5206\uff0c\u7531\u961f\u53cb\u8d1f\u8d23\u7684\u90e8\u5206\u53ef\u4ee5\u7b80\u5355\u63cf\u8ff0\u3002</li> </ul> <p>BonusA \u548c Bonus B \u4efb\u9009\u5176\u4e00\uff0c\u4e24\u4e2a\u90fd\u505a\u4e5f\u53ea\u80fd\u62ff\u6700\u9ad8\u7684\u4e00\u4e2a\u5206\u6570</p>"},{"location":"#\u8981\u6c42\u548c\u8bc4\u5206\u6807\u51c6","title":"\u8981\u6c42\u548c\u8bc4\u5206\u6807\u51c6","text":"\u90e8\u5206 \u5360\u6bd4 \u57fa\u672c\u8981\u6c42 \u6ee1\u5206 \u4ee3\u7801 25% \u63d0\u4ea4\uff1aZJU Git\u901a\u8fc7\u6d41\u6c34\u7ebf\u8bc4\u6d4b\u548c\u67e5\u91cd \u7f16\u8bd1\u65e0 Error \u548c Warning \u62a5\u544a 50% \u63d0\u4ea4\uff1a\u5b66\u5728\u6d59\u5927\u683c\u5f0f\uff1a\u63d0\u4ea4 PDF \u6587\u4ef6\u5185\u5bb9\uff1a\u662f\u4eba\u5199\u7684\u4e14\u4eba\u80fd\u8bfb\u61c2\u8bed\u8a00\uff1a\u4e2d\u6587 \u683c\u5f0f\uff1a\u63a8\u8350\u4f7f\u7528\u6807\u8bb0\u8bed\u8a00\u7f16\u5199\u4f8b\u5982 LaTeX\u3001Typst\u3001MarkDown\u5185\u5bb9\uff1a\u5c55\u793a\u51fa\u5206\u6790\u5b9e\u9a8c\u4efb\u52a1\u3001\u601d\u8003\u5b9e\u73b0\u65b9\u6cd5\u7684\u8fc7\u7a0b \u9a8c\u6536 25% \u80fd\u8bb2\u6e05\u695a\u4ee3\u7801\u5728\u5e72\u4ec0\u4e48 \uff08\u7ecf\u8fc7\u63d0\u793a\uff09\u80fd\u6b63\u786e\u56de\u7b54\u52a9\u6559\u7684\u95ee\u9898 <ul> <li>\u62a5\u544a\uff1a<ul> <li>\u5e94\u5f53\u4e14\u4ec5\u5e94\u5f53\u5305\u542b\u7684\u5185\u5bb9\uff1a<ul> <li>\u5404 Task\uff08\u5b9e\u9a8c\u4efb\u52a1\uff09\u7684\u5b9e\u73b0\u601d\u8def\u4e0e\u8fc7\u7a0b</li> <li>\u300c\u52a8\u624b\u505a\u300d\u90e8\u5206\u7684\u5b9e\u9a8c\u8fc7\u7a0b\u548c\u95ee\u9898\u89e3\u7b54</li> <li>\u4f60\u7684\u5b9e\u73b0\u4eae\u70b9\uff08\u5982\u6709\uff09</li> <li>\u5fc3\u5f97\u4e0e\u5410\u69fd\uff08\u5982\u6709\uff09</li> </ul> </li> <li>\u4e0d\u9700\u8981\u7684\u5185\u5bb9\uff1a\u5b9e\u9a8c\u76ee\u6807\uff08\u5b9e\u9a8c\u6587\u6863\u5df2\u63cf\u8ff0\u6e05\u695a\uff09\u3001\u5b9e\u9a8c\u73af\u5883\uff08\u5df2\u7edf\u4e00\u4e3a\u5bb9\u5668\u73af\u5883\uff09\u3001\u5b9e\u9a8c\u7ed3\u679c\uff08\u5df2\u4f7f\u7528\u81ea\u52a8\u5316\u6d4b\u8bd5\uff09</li> <li>\u5efa\u8bae\uff1a\u5c3d\u53ef\u80fd\u7cbe\u7b80\uff0c\u6bd4\u5982\u4e0d\u8981\u6574\u7247\u8d34\u4ee3\u7801\uff0c\u5c55\u793a\u5173\u952e\u8bed\u53e5\u5373\u53ef</li> <li>\u63a8\u8350\u4f5c\u4e1a\uff1a\u5982\u679c\u4f60\u8ba4\u4e3a\u81ea\u5df1\u7684\u5b9e\u73b0\u6709\u72ec\u5230\u4e4b\u5904\uff0c\u8bf7\u5728\u62a5\u544a\u4e2d\u8bf4\u660e\uff0c\u6216\u8bb8\u4f1a\u88ab\u9009\u4e3a\u63a8\u8350\u4f5c\u4e1a</li> </ul> </li> <li>\u8bf7\u5047\uff1a     \u5982\u679c\u4f60\u56e0\u75be\u75c5\u3001\u7ade\u8d5b\u3001\u4e0d\u53ef\u6297\u529b\u56e0\u7d20\u7b49\u539f\u56e0\u65e0\u6cd5\u6309\u65f6\u5b8c\u6210\u5b9e\u9a8c\u7684\u5404\u4e2a\u73af\u8282\uff0c\u8bf7\u5411\u4efb\u8bfe\u6559\u5e08\u8bf7\u5047\u5e76\u83b7\u5f97\u6279\u51c6\u3002\u7136\u540e\u5411\u52a9\u6559\u5c55\u793a\u8bf7\u5047\u8bc1\u660e\uff0c\u52a9\u6559\u4f1a\u5e2e\u4f60\u5ef6\u540e\u622a\u6b62\u65e5\u671f\uff0c\u4e0d\u5f71\u54cd\u5206\u6570\u3002</li> <li>\u8865\u4ea4\uff1a<ul> <li>\u5206\u6570\uff1a\u5728\u622a\u6b62\u65e5\u671f\u540e\uff0c\u6bcf\u8fdf\u4e00\u5929\u6263 10%\uff0c\u6263\u5b8c\u4e3a\u6b62\u3002\u4ee3\u7801\u3001\u62a5\u544a\u3001\u9a8c\u6536\u5206\u522b\u8ba1\u7b97\u6263\u9664\u6bd4\u4f8b\u3002</li> <li>\u4ee3\u7801\uff1a\u5728\u622a\u6b62\u65e5\u671f\u540e\uff0c\u5bf9\u5e94\u5206\u652f\u7684 Push \u6743\u9650\u5173\u95ed\u3002\u8bf7\u5728\u5b8c\u6210\u5b9e\u9a8c\u540e\u53ca\u65f6\u63a8\u9001\u5230\u8fdc\u7a0b\u4ed3\u5e93\u7684\u5bf9\u5e94\u5206\u652f\u3002\u8865\u4ea4\u4ee3\u7801\u8bf7\u63a8\u9001\u5230\u8865\u4ea4\u5206\u652f\uff0c\u4ee5\u8865\u4ea4\u5206\u652f\u6700\u540e\u4e00\u6b21\u63d0\u4ea4\u4e3a\u51c6\u3002</li> <li>\u62a5\u544a\uff1a\u5728\u622a\u6b62\u65e5\u671f\u540e\uff0c\u8054\u7cfb\u52a9\u6559\u5f00\u901a\u5b66\u5728\u6d59\u5927\u7684\u8865\u4ea4\u901a\u9053\u3002</li> </ul> </li> </ul> <p>\u9f13\u52b1\u540c\u5b66\u4eec\u4f7f\u7528 AI \u8f85\u52a9\u7f16\u7a0b\uff0c\u826f\u597d\u7684\u4f7f\u7528\u65b9\u5f0f\u6709\uff1a</p> <ul> <li>AI \u8f85\u52a9\uff0c\u6211\u4e3b\u5bfc\u7f16\u5199\uff1a\u6211\u81ea\u5df1\u5199\u5927\u90e8\u5206\u4ee3\u7801\uff0c\u53ea\u5728\u9047\u5230 bug \u6216\u4e0d\u61c2\u7684\u5730\u65b9\u624d\u8bf7 AI \u5e2e\u5fd9\u3002</li> <li>\u7528 AI \u5b66\u4e60\u7f16\u7a0b\u6982\u5ff5\uff1a\u6211\u4e3b\u8981\u7528 AI \u6765\u5b66\u4e60\u8bed\u6cd5\u3001\u6982\u5ff5\u3001\u7b97\u6cd5\u539f\u7406\uff0c\u800c\u4e0d\u662f\u76f4\u63a5\u5199\u9879\u76ee\u3002</li> <li>\u548c AI \u534f\u540c\u8c03\u8bd5\uff1a\u6211\u8ba9 AI \u5e2e\u6211\u5206\u6790\u62a5\u9519\u4fe1\u606f\uff0c\u63d0\u4f9b\u89e3\u51b3\u601d\u8def\uff0c\u81ea\u5df1\u6765\u4fee\u6539\u4ee3\u7801\u3002</li> <li>\u4ee3\u7801\u4f18\u5316\u548c\u91cd\u6784\uff1a\u6211\u4f1a\u8ba9 AI \u5e2e\u6211\u68c0\u67e5\u5df2\u6709\u4ee3\u7801\u7684\u6027\u80fd\u3001\u53ef\u8bfb\u6027\uff0c\u5e76\u63d0\u51fa\u4f18\u5316\u5efa\u8bae\u3002</li> <li>\u751f\u6210\u6587\u6863\u6216\u6ce8\u91ca\uff1a\u6211\u8ba9 AI \u5e2e\u6211\u4e3a\u4ee3\u7801\u5199\u6ce8\u91ca\u3001\u751f\u6210\u6587\u6863\u3001\u8865\u5145\u4f7f\u7528\u8bf4\u660e\u3002</li> </ul>"},{"location":"#\u4e0e\u8003\u8bd5\u7684\u8054\u7cfb","title":"\u4e0e\u8003\u8bd5\u7684\u8054\u7cfb","text":"<p>\u8003\u8bd5\u91cd\u5728\u539f\u7406\u800c\u4e0d\u4f1a\u8003\u5bdf\u6280\u672f\u7ec6\u8282\u3002\u4e0b\u9762\u8fd9\u4e9b Lab \u7684\u6574\u4f53\u6d41\u7a0b\u5e0c\u671b\u4f60\u901a\u8fc7\u5b9e\u9a8c\u7262\u7262\u638c\u63e1\uff0c\u5176\u4ed6\u5185\u5bb9\u7528\u8fc7\u5c31\u5fd8\u4e5f\u6ca1\u5173\u7cfb\uff1a</p> <ul> <li>Lab3 Sv39 \u865a\u62df\u5185\u5b58\u7cfb\u7edf</li> <li>Lab4 \u7528\u6237\u6001\u4e0e\u7cfb\u7edf\u8c03\u7528</li> <li>Lab5 \u7f3a\u9875\u5f02\u5e38\u4e0e Fork</li> </ul> <p>Example</p> <p>24 \u79cb\u51ac\u300a\u64cd\u4f5c\u7cfb\u7edf\u300b\u8003\u8bd5\u7684\u6700\u540e\u4e00\u9053\u5927\u9898\u662f\uff1a\u624b\u5de5\u5b8c\u6210 Sv39 \u865a\u62df\u5185\u5b58\u5230\u7269\u7406\u5185\u5b58\u7684\u7ffb\u8bd1\u6d41\u7a0b\u3002\u5982\u679c\u4f60\u8ba4\u771f\u5b9e\u73b0\u4e86 Lab3\uff0c\u90a3\u4e48\u8fd9\u9053\u9898\u975e\u5e38\u7b80\u5355\u3002</p>"},{"location":"#\u5bfb\u6c42\u5e2e\u52a9","title":"\u5bfb\u6c42\u5e2e\u52a9","text":"<p>\u5982\u679c\u5728\u8bfe\u7a0b\u5b9e\u9a8c\u8fc7\u7a0b\u4e2d\u9047\u5230\u4e86\u56f0\u96be\uff0c\u8bf7\u6309\u4ee5\u4e0b\u987a\u5e8f\u5bfb\u6c42\u5e2e\u52a9\uff1a</p> <ul> <li>\u8eab\u8fb9\u7684\u540c\u5b66</li> <li>AI</li> <li>\u52a9\u6559</li> </ul> <p>\u5bfb\u6c42\u5e2e\u52a9\u65f6\u7684\u4e00\u4e9b\u5efa\u8bae\uff1a</p> <ul> <li>\u63d0\u4f9b\u65e5\u5fd7/\u8f93\u51fa\uff1a\u5efa\u8bae\u4e0d\u8981\u4f7f\u7528\u622a\u56fe\uff0c\u800c\u662f\u7c98\u8d34\u6587\u672c\uff0c\u8fd9\u6837\u53ef\u4ee5\u65b9\u4fbf\u4ed6\u4eba\u590d\u5236\u5176\u4e2d\u7684\u5185\u5bb9\u3002\u5982\u679c\u9700\u8981\u63d0\u4f9b\u7684\u65e5\u5fd7/\u8f93\u51fa\u5185\u5bb9\u6bd4\u8f83\u591a\uff0c\u5efa\u8bae\u5c06\u5176\u4fdd\u5b58\u4e3a\u6587\u4ef6\u53d1\u9001\uff0c\u6bd4\u5982\u901a\u8fc7 Shell \u7684 <code>&gt;log.txt 2&gt;&amp;1</code> \u5c06\u8f93\u51fa\u91cd\u5b9a\u5411\u4fdd\u5b58\u5230\u6587\u4ef6\u4e2d\u3002</li> <li>\u63a8\u9001\u4ee3\u7801\u5e76\u9644\u5e26\u94fe\u63a5\uff1a\u5982\u679c\u662f\u4ee3\u7801\u76f8\u5173\u7684\u95ee\u9898\uff0c\u5efa\u8bae\u5c06\u4ee3\u7801\u63a8\u9001\u5230\u8fdc\u7a0b\u4ed3\u5e93\uff0c\u5e76\u9644\u5e26\u94fe\u63a5\uff0c\u8fd9\u6837\u4ed6\u4eba\u53ef\u4ee5\u65b9\u4fbf\u5730\u67e5\u770b\u4f60\u7684\u5b8c\u6574\u4ee3\u7801\u3002</li> </ul>"},{"location":"#\u53cd\u9988\u4e0e\u8d21\u732e","title":"\u53cd\u9988\u4e0e\u8d21\u732e","text":"<p>\u5982\u679c\u4f60\u53d1\u73b0\u8bfe\u7a0b\u6587\u6863\u3001\u4ee3\u7801\u6709\u9519\u8bef\u3001\u7f3a\u9677\u3001\u503c\u5f97\u8fdb\u4e00\u6b65\u5b8c\u5584\u7684\u5730\u65b9\u7b49\uff0c\u8bf7\u5411\u52a9\u6559\u53cd\u9988\u3002\u5982\u679c\u4f60\u6709\u6539\u8fdb\u7684\u60f3\u6cd5\uff0c\u6b22\u8fce\u4f60\u5728 ZJUGit \u4e0a\u5411\u8bfe\u7a0b\u4ed3\u5e93\u63d0\u4ea4 Merge Request\uff0c\u6ce8\u610f\u4e0d\u8981\u63d0\u4ea4\u81ea\u5df1\u7684\u79c1\u6709\u4ee3\u7801\u3002</p>"},{"location":"#\u5bfc\u822a","title":"\u5bfc\u822a","text":"<p>\u672c\u6559\u5b66\u73ed\u8d44\u6e90\uff1a</p> GitHub ZJU Git \u5728\u7ebf\u6587\u6863 ZJU-OS/doc os/doc \u6587\u6863\u4ed3\u5e93 ZJU-OS/doc os/doc \u4ee3\u7801\u4ed3\u5e93 ZJU-OS/code os/code \u52a9\u6559\u5de5\u5177 ZJU-OS/tool os/tool <p>\u672c\u8bfe\u7a0b\u5176\u4ed6\u6559\u5b66\u73ed\uff1a</p> <ul> <li>\u5bff\u9ece\u4f46\uff1azju-os-sld/os-25fall</li> </ul> <p>\u672c\u6821\u8bfe\u7a0b\uff1a</p> <ul> <li>\u7f16\u8bd1\u539f\u7406\u8bfe\u7a0b\u5b9e\u9a8c</li> <li>\u7f16\u8bd1\u539f\u7406\u52a9\u6559\u5de5\u5177</li> <li>\u9996\u9875 - \u6d59\u6c5f\u5927\u5b66 25 \u6625\u590f\u8ba1\u7b97\u673a\u4f53\u7cfb\u7ed3\u6784\u5b9e\u9a8c</li> <li>\u8ba1\u7b97\u673a\u7cfb\u7edf \u7cfb\u5217\u8bfe\u7a0b</li> </ul> <p>\u5176\u4ed6\uff1a</p> <ul> <li>(NJU) \u64cd\u4f5c\u7cfb\u7edf\uff1a\u8bbe\u8ba1\u4e0e\u5b9e\u73b0 (2024 \u6625\u5b63\u5b66\u671f)</li> <li>(THU) THU CS Lab</li> <li>(USTC) Vlab \u5b9e\u9a8c\u4e2d\u5fc3</li> <li>rCore-Tutorial-Book \u6587\u6863</li> </ul>"},{"location":"#\u5386\u53f2","title":"\u5386\u53f2","text":"<p>\u64cd\u4f5c\u7cfb\u7edf\u8bfe\u7a0b\u5b9e\u9a8c\u7684\u5386\u53f2\u60c5\u51b5\u5982\u4e0b\uff1a</p> \u5b66\u671f \u60c5\u51b5 23 \u79cb\u51ac JuniorSNy/os24fall-stu-full 24 \u79cb\u51ac \u90e8\u5206\u6559\u5b66\u73ed\u7edf\u4e00\u4f7f\u7528 ZJU-SEC/os24fall-stu 25 \u79cb\u51ac \u56e0\u4e3a\u5404\u6559\u5b66\u73ed\u53d8\u66f4\u65b9\u5411\u4e0d\u540c\uff0c\u5404\u81ea fork \u4e86 <p>25 \u5e74\u79cb\u51ac\u5b66\u671f\uff0c\u672c\u6559\u5b66\u73ed\u5411 \u300a\u7f16\u8bd1\u539f\u7406\u300b\u8bfe\u7a0b\u5b9e\u9a8c \u770b\u9f50\uff0c\u76f8\u6bd4\u4e4b\u524d\u7684\u7248\u672c\u3001\u5176\u4ed6\u6559\u5b66\u73ed\u4e3b\u8981\u6709\u4ee5\u4e0b\u6539\u52a8\uff1a</p> <ul> <li>\u62c6\u5206\u8bfe\u7a0b\u6587\u6863\u548c\u4ee3\u7801\u4ed3\u5e93</li> <li>\u5b66\u751f\u7edf\u4e00\u4f7f\u7528 ZJU Git \u4e0a\u5206\u914d\u7684\u4ed3\u5e93\u8fdb\u884c\u5b9e\u9a8c</li> <li>\u4f7f\u7528\u5bb9\u5668\u5316\u7684\u5b9e\u9a8c\u73af\u5883</li> <li>\u4f7f\u7528\u81ea\u52a8\u5316\u8bc4\u6d4b</li> </ul>"},{"location":"#\u672c\u5730\u6784\u5efa","title":"\u672c\u5730\u6784\u5efa","text":"<p>\u672c\u4ed3\u5e93\u4f7f\u7528 <code>uv</code> \u7ba1\u7406 Python \u4f9d\u8d56\uff0c\u5b89\u88c5 <code>uv</code> \u540e\u53ef\u4ee5\u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u5728\u672c\u5730\u6e32\u67d3\u6587\u6863\uff1a</p> <pre><code>uv run mkdocs serve\n</code></pre>"},{"location":"#\u81f4\u8c22","title":"\u81f4\u8c22","text":"<p>\u611f\u8c22\u4ee5\u4e0b\u5404\u4f4d\u8001\u5e08\u548c\u52a9\u6559\u7684\u8f9b\u52e4\u4ed8\u51fa\uff01</p> <p>\u7533\u6587\u535a\u3001\u5468\u4e9a\u91d1\u3001\u5f90\u91d1\u7131\u3001\u5468\u4fa0\u3001\u7ba1\u7ae0\u8f89\u3001\u5f20\u6587\u9f99\u3001\u5218\u5f3a\u3001\u5b59\u5bb6\u680b\u3001\u5468\u5929\u6631\u3001\u5e84\u963f\u5f97\u3001\u738b\u7428\u3001\u6c88\u97ec\u7acb\u3001\u738b\u661f\u5b87\u3001\u6731\u749f\u68ee\u3001\u8c22\u6d35\u3001\u6f58\u5b50\u66f0\u3001\u6731\u82e5\u51e1\u3001\u5b63\u9ad8\u5f3a\u3001\u90ed\u82e5\u5bb9\u3001\u675c\u4e91\u6f47\u3001\u5434\u9038\u98de\u3001\u674e\u7a0b\u6d69\u3001\u6731\u5bb6\u8fc5\u3001\u738b\u884c\u6977\u3001\u9648\u6de6\u8c6a\u3001\u8d75\u7d2b\u5bb8\u3001\u738b\u9e64\u7fd4\u3001\u8bb8\u660a\u745e\u3001\u6768\u6c9b\u5c71\u3001\u6731\u5b9d\u6797\u3001\u5f20\u6052\u658c\u3002</p>"},{"location":"lab0/","title":"Lab 0: Linux \u5185\u6838\u8c03\u8bd5","text":""},{"location":"lab0/#lab-0-linux-\u5185\u6838\u8c03\u8bd5","title":"Lab 0: Linux \u5185\u6838\u8c03\u8bd5","text":"<p>DDL</p> <ul> <li>\u9a8c\u6536\uff1a2025-09-30</li> </ul>"},{"location":"lab0/#\u5b9e\u9a8c\u7b80\u4ecb","title":"\u5b9e\u9a8c\u7b80\u4ecb","text":"<p>\u5728 Lab 0 \u4e2d\uff0c\u6211\u4eec\u5c06\u5b66\u4e60\u4e0b\u5217\u5185\u5bb9\uff0c\u5b8c\u6210\u73af\u5883\u642d\u5efa\uff1a</p> <ul> <li>\u4f7f\u7528 Docker \u5bb9\u5668\uff1a\u4e3a\u4e86\u907f\u514d\u540c\u5b66\u4eec\u5728\u4e0d\u540c\u64cd\u4f5c\u7cfb\u7edf\u548c\u73af\u5883\u4e0b\u9047\u5230\u5404\u79cd\u5404\u6837\u7684\u95ee\u9898\uff0c\u6211\u4eec\u5c06\u5b9e\u9a8c\u73af\u5883\u6253\u5305\u6210 Docker \u5bb9\u5668\u955c\u50cf\uff0c\u514d\u53bb\u540c\u5b66\u4eec\u81ea\u884c\u642d\u5efa\u73af\u5883\u7684\u9ebb\u70e6\u3002</li> <li>\u4f7f\u7528 QEMU \u6a21\u62df\u5668\uff1a\u540c\u5b66\u4eec\u4f7f\u7528\u7684\u4e00\u822c\u662f x86-64 \u6216 Arm \u67b6\u6784\u7684\u8bbe\u5907\uff0c\u800c\u672c\u8bfe\u7a0b\u5b9e\u73b0\u7684\u5185\u6838\u4f7f\u7528 RISC-V \u6c47\u7f16\u6307\u4ee4\u548c C \u8bed\u8a00\u7f16\u5199\u3002\u6211\u4eec\u5c06\u4f7f\u7528 QEMU\u3001Spike \u7b49\u865a\u62df\u673a\u3001\u6a21\u62df\u5668\u6765\u6a21\u62df RISC-V \u67b6\u6784\u7684\u8ba1\u7b97\u673a\u7cfb\u7edf\uff0c\u7531\u5b83\u4eec\u63d0\u4f9b\u5bf9\u5e94\u7684 CPU\u3001\u5185\u5b58\u3001\u5916\u8bbe\u7b49\u73af\u5883\uff0c\u4f9b\u6211\u4eec\u8fd0\u884c\u548c\u8c03\u8bd5\u5185\u6838\u3002</li> <li>\u4f7f\u7528\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\uff1a\u7279\u5b9a\u67b6\u6784\u4e0a\u7684\u7f16\u8bd1\u5668\u7b49\u5de5\u5177\u4e00\u822c\u53ea\u751f\u6210\u5bf9\u5e94\u67b6\u6784\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u751f\u6210\u5176\u4ed6\u67b6\u6784\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u7684\u8fc7\u7a0b\u79f0\u4e3a\u4ea4\u53c9\u7f16\u8bd1\u3002RISC-V GNU Compiler Toolchain \u652f\u6301\u5728 x86-64 \u6216 Arm \u67b6\u6784\u7684\u673a\u5668\u4e0a\u7f16\u8bd1\u3001\u8c03\u8bd5 RISC-V \u67b6\u6784\u7684\u7a0b\u5e8f\u3002</li> <li>\u4f7f\u7528 GDB \u8c03\u8bd5\u5668\uff1a\u5728\u5185\u6838\u5f00\u53d1\u8fc7\u7a0b\u4e2d\uff0c\u8c03\u8bd5\u662f\u5fc5\u4e0d\u53ef\u5c11\u7684\u73af\u8282\u3002\u6211\u4eec\u5c06\u4f7f\u7528 GDB \u6765\u8c03\u8bd5\u5185\u6838\u4ee3\u7801\uff0c\u5b9a\u4f4d\u548c\u4fee\u590d\u95ee\u9898\u3002</li> </ul>"},{"location":"lab0/#\u5b9e\u9a8c\u8981\u6c42","title":"\u5b9e\u9a8c\u8981\u6c42","text":"<p>\u672c\u5b9e\u9a8c\u975e\u5e38\u7b80\u5355\uff0c\u65e0\u9700\u5199\u4ee3\u7801\uff0c\u65e0\u9700\u63d0\u4ea4\u62a5\u544a\u3002\u672c\u6b21\u5b9e\u9a8c\u7684\u91cd\u70b9\u662f\u638c\u63e1 QEMU\u3001GDB \u7b49\u5de5\u5177\u7684\u4f7f\u7528\uff0c\u8fd9\u5bf9\u540e\u7eed\u5b9e\u9a8c\u975e\u5e38\u91cd\u8981\u3002</p> <p>\u9a8c\u6536\u65f6\uff0c\u8bf7\u4f60\u73b0\u573a\u6f14\u793a\u4f7f\u7528 QEMU \u542f\u52a8\u5185\u6838\uff0c\u5e76\u4f7f\u7528 GDB \u6253\u65ad\u70b9\u3001\u67e5\u770b\u5404\u7c7b\u4fe1\u606f\u3002</p> <p>\u5982\u679c\u4f60\u6709\u5174\u8da3\uff0c\u8bf7\u9605\u8bfb \u9644\u5f55 1\uff1aSpike \u5de5\u5177\u94fe\uff0c\u5728\u9a8c\u6536\u65f6\u5c55\u793a\u4f7f\u7528 Spike \u8fd0\u884c\u7684\u7ed3\u679c\u3002</p>"},{"location":"lab0/#part-1\u73af\u5883\u914d\u7f6e","title":"Part 1\uff1a\u73af\u5883\u914d\u7f6e","text":""},{"location":"lab0/#\u5b89\u88c5-docker","title":"\u5b89\u88c5 Docker","text":"<p>\u5982\u679c\u4f60\u5c1a\u672a\u5b89\u88c5 Docker\uff1a</p> <ul> <li>Linux \u548c WSL \u73af\u5883\u8bf7\u53c2\u8003 Docker CE | ZJU Mirror</li> <li>macOS \u63a8\u8350\u4f7f\u7528 Docker Desktop \u6216 OrbStack (\u53ef\u4ee5\u7528 Homebrew \u76f4\u63a5\u5b89\u88c5)</li> </ul>"},{"location":"lab0/#\u62c9\u53d6\u4ee3\u7801","title":"\u62c9\u53d6\u4ee3\u7801","text":"<p>\u8bf7\u786e\u4fdd\u4f60\u5df2\u7ecf\u9605\u8bfb \u5b9e\u9a8c\u6d41\u7a0b\u53ca\u5de5\u5177\u8bb2\u89e3 \uff0c\u5e76\u4e86\u89e3\u57fa\u672c\u7684 Git \u5de5\u4f5c\u6d41\uff0c\u73b0\u5728\u8bf7\u4f60\u5c06\u4ee3\u7801\u4ed3\u5e93\u514b\u9686\u4e0b\u6765\u3002\u52a9\u6559\u5df2\u7ecf\u4e3a\u6240\u6709\u5b66\u751f\u521b\u5efa\u4e86\u79c1\u6709\u4ed3\u5e93\uff0c\u4f60\u53ef\u4ee5\u4ece ZJU Git \u76f4\u63a5\u62c9\u53d6\u81ea\u5df1\u7684\u79c1\u6709\u4ed3\u5e93 <code>git@git.zju.edu.cn:os/fa25/jijiangming/os-&lt;\u4f60\u7684\u5b66\u53f7&gt;.git</code>\u3002\u8bf7\u6ce8\u610f\u4f60\u6240\u5728\u7684\u5206\u652f\u5e94\u4e3a <code>lab0</code>\uff0c\u5982\u679c\u4e0d\u662f\uff0c\u8bf7\u5c1d\u8bd5\u901a\u8fc7\u5982\u4e0b\u64cd\u4f5c\u8fdb\u884c\u5207\u6362\uff1a</p> <pre><code>git fetch origin\ngit checkout -b lab0 origin/lab0\n</code></pre>"},{"location":"lab0/#\u542f\u52a8\u5f00\u53d1\u5bb9\u5668","title":"\u542f\u52a8\u5f00\u53d1\u5bb9\u5668","text":"<p>\u5173\u4e8e\u672c\u8bfe\u7a0b\u4f7f\u7528\u7684\u5bb9\u5668\uff0c\u8bf7\u540c\u5b66\u4eec\u4e86\u89e3\u4e00\u4e0b\u51e0\u70b9\uff1a</p> <ul> <li> <p>\u57fa\u672c\u6982\u5ff5\uff1a\u6211\u4eec\u53d1\u5e03\u955c\u50cf\uff08image\uff09\uff0c\u540c\u5b66\u4eec\u5728\u672c\u5730\u62c9\u53d6\uff08pull\uff09\u955c\u50cf\uff0c\u7136\u540e\u7528\u955c\u50cf\u521b\u5efa\u5bb9\u5668\uff08container\uff09\uff0c\u5bb9\u5668\u662f\u955c\u50cf\u7684\u4e00\u4e2a\u8fd0\u884c\u5b9e\u4f8b\u3002</p> <p>\u5bb9\u5668\u53ef\u4ee5\u770b\u4f5c\u4e00\u4e2a\u8f7b\u91cf\u7ea7\u7684\u865a\u62df\u673a\uff0c\u53ef\u4ee5\u542f\u52a8\u3001\u505c\u6b62\u3001\u5220\u9664\u3002\u5bb9\u5668\u5185\u7684\u6587\u4ef6\u7cfb\u7edf\u548c\u8fd0\u884c\u72b6\u6001\u662f\u72ec\u7acb\u7684\uff0c\u5220\u9664\u5bb9\u5668\u4f1a\u4e22\u5931\u5bb9\u5668\u5185\u7684\u6587\u4ef6\u548c\u72b6\u6001\u3002</p> </li> <li> <p>\u4ee3\u7801\u6302\u8f7d\uff1a\u4ee3\u7801\u5e93\u4f1a\u88ab\u6302\u8f7d\uff08mount\uff09\u5230\u5bb9\u5668\u5185\u7684 <code>/zju-os/code</code> \u76ee\u5f55\u4e0b\u3002\u8fd9\u610f\u5473\u7740\u5bbf\u4e3b\u673a\u548c\u5bb9\u5668\u5171\u4eab\u4ee3\u7801\u5e93\u7684\u6587\u4ef6\uff0c\u5bb9\u5668\u5185\u5bf9\u4ee3\u7801\u7684\u4fee\u6539\u4f1a\u76f4\u63a5\u53cd\u6620\u5230\u5bbf\u4e3b\u673a\u4e0a\uff0c\u53cd\u4e4b\u4ea6\u7136\u3002\u6587\u4ef6\u4fdd\u5b58\u5728\u5bbf\u4e3b\u673a\uff0c\u6240\u4ee5\u4e0d\u4f1a\u56e0\u4e3a\u5bb9\u5668\u88ab\u5220\u9664\u800c\u4e22\u5931\u3002</p> </li> <li> <p>\u7528\u6237\u4e0e\u6587\u4ef6\u6743\u9650\uff1a\u5bb9\u5668\u5185\u7684\u7528\u6237\u662f <code>root</code>\uff0c\u800c\u5bbf\u4e3b\u673a\u4e0a\u4f60\u4e00\u822c\u4f7f\u7528\u7684\u662f\u666e\u901a\u7528\u6237\u3002\u5bb9\u5668\u5185\u521b\u5efa\u7684\u6587\u4ef6\uff08\u6bd4\u5982\u7f16\u8bd1\u4ea7\u7269\u7b49\uff09\u5c5e\u4e8e <code>root</code>\uff0c\u5728\u5bbf\u4e3b\u673a\u4e0a\u64cd\u4f5c\u65f6\u53ef\u80fd\u9047\u5230\u6743\u9650\u95ee\u9898\u3002\u6b64\u65f6\u53ef\u4ee5\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u5c06\u6587\u4ef6\u6240\u6709\u8005\u8f6c\u4ea4\u56de\u666e\u901a\u7528\u6237\uff1a</p> <pre><code>sudo chown -R &lt;username&gt;:&lt;username&gt; .\n</code></pre> </li> <li> <p>Git \u548c SSH \u914d\u7f6e\u6620\u5c04\uff1a</p> <p>\u7279\u522b\u5730\uff0c\u6267\u884c\u4e00\u4e9b Git \u64cd\u4f5c\u4e5f\u4f1a\u4ea7\u751f\u6587\u4ef6\uff0c\u56e0\u6b64\u4f1a\u4ea7\u751f\u8fd9\u6837\u7684\u60c5\u51b5\uff1a\u5728\u5bb9\u5668\u5185\u6267\u884c Git \u64cd\u4f5c\u540e\uff0c\u5728\u5bbf\u4e3b\u673a\u6267\u884c Git \u64cd\u4f5c\u9047\u5230 Permission Denied\u3002\u6240\u4ee5\u6211\u4eec\u5c06\u5bbf\u4e3b\u673a\u7684 Git \u548c SSH \u914d\u7f6e\u6620\u5c04\u5230\u5bb9\u5668\u5185\uff0c\u8fd9\u6837\u540c\u5b66\u4eec\u7684\u5f00\u53d1\u3001Git \u64cd\u4f5c\u90fd\u5728\u5bb9\u5668\u5185\u8fdb\u884c\uff0c\u4e0d\u7528\u56de\u5230\u5bbf\u4e3b\u673a\u4e86\u3002</p> <p>\u914d\u7f6e\u6620\u5c04\u662f\u901a\u8fc7\u6302\u8f7d\u5bbf\u4e3b\u673a\u7684 <code>~/.gitconfig</code>\u3001<code>~/.ssh</code> \u7b49\u6587\u4ef6\u5b9e\u73b0\u7684\u3002\u56e0\u6b64\u8bf7\u5148\u5728\u5bbf\u4e3b\u673a\u4e0a\u914d\u7f6e\u597d Git \u548c SSH\uff08\u5728\u4e0a\u9762\u4f60\u62c9\u53d6\u4ed3\u5e93\u7684\u65f6\u5019\u5e94\u8be5\u5df2\u7ecf\u914d\u7f6e\u597d\u4e86\uff09\uff0c\u5426\u5219\u6211\u4eec\u7684\u68c0\u6d4b\u811a\u672c\u4f1a\u62a5\u9519\u3002</p> </li> </ul> <p>\u4f60\u6709\u4ee5\u4e0b\u51e0\u79cd\u65b9\u5f0f\u4f7f\u7528\u5f00\u53d1\u5bb9\u5668\uff1a</p> VSCode DevContainer\uff08\u63a8\u8350\uff09Makefile\uff08\u9700\u8981\u638c\u63e1\uff09 <p>VSCode\u3001CLion \u7b49\u73b0\u4ee3\u7f16\u8f91\u5668/IDE \u5927\u591a\u652f\u6301 DevContainer\u3002\u901a\u8fc7\u4ee3\u7801\u4ed3\u5e93\u4e0b\u7684 <code>.devcontainer</code> \u76ee\u5f55\u4e2d\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u7f16\u8f91\u5668/IDE \u53ef\u4ee5\u81ea\u52a8\u521b\u5efa\u5e76\u8fde\u63a5\u5230\u5bb9\u5668\uff0c\u4fdd\u8bc1\u6240\u6709\u5f00\u53d1\u8005\u4f7f\u7528\u76f8\u540c\u7684\u5bb9\u5668\u73af\u5883\u3002</p> <p>\u4e0b\u9762\u4ee5 VSCode \u4e3a\u4f8b\u4ecb\u7ecd\u4f7f\u7528\u6d41\u7a0b\uff1a</p> <ul> <li>VSCode \u5b89\u88c5 Dev Containers \u63d2\u4ef6</li> <li>VSCode \u6253\u5f00\u5b9e\u9a8c\u4ed3\u5e93</li> <li> <p>\u53f3\u4e0b\u89d2\u53ef\u80fd\u4f1a\u51fa\u73b0\u5f00\u53d1\u5bb9\u5668\uff08Dev Container\uff09\u76f8\u5173\u7684\u5f39\u7a97\uff0c\u70b9\u51fb\u5728\u5f00\u53d1\u5bb9\u5668\u4e2d\u6253\u5f00</p> <p>\u5982\u679c\u6ca1\u6709\u5f39\u7a97\uff0c\u5219\u6309 Ctrl+Shift+P \u6253\u5f00\u547d\u4ee4\u7a97\u53e3\uff0c\u8f93\u5165 <code>reopen</code> \u627e\u5230 <code>Dev Containers: Reopen in Container</code> \u9009\u9879\uff0c\u9009\u62e9\u5b83</p> <p>Tip</p> <p>VSCode \u662f\u4ece\u5f53\u524d\u6253\u5f00\u7684\u6587\u4ef6\u5939\u627e <code>.devcontainer</code> \u7684\uff0c\u6240\u4ee5\u8bf7\u786e\u4fdd VSCode \u5f53\u524d\u6253\u5f00\u4e86\u5b9e\u9a8c\u4ed3\u5e93\u7684\u6839\u76ee\u5f55\u3002</p> <p>\u5982\u679c\u9009\u62e9 <code>Reopen in Container</code> \u540e VSCode \u5f39\u51fa\u4e86\u9009\u62e9\u5bb9\u5668\u4e4b\u7c7b\u7684\u7a97\u53e3\uff0c\u8bf4\u660e\u4f60\u6ca1\u6709\u6253\u5f00\u6b63\u786e\u7684\u76ee\u5f55\u3002\u8bf7\u5c1d\u8bd5\u5173\u95ed VSCode \u91cd\u65b0\u6253\u5f00\u3002</p> </li> <li> <p>VSCode \u5c06\u91cd\u8f7d\u7a97\u53e3\uff0c\u542f\u52a8\u5e76\u8fde\u63a5\u5230\u5bb9\u5668\uff0c\u81ea\u52a8\u5b8c\u6210\u63d2\u4ef6\u5b89\u88c5\u7b49\u914d\u7f6e\u6b65\u9aa4</p> <p>Tip</p> <p>\u5b9e\u9a8c\u955c\u50cf\u6bd4\u8f83\u5927\uff08\u7ea6 10G\uff09\uff0c\u4f60\u53ef\u4ee5\u7ed3\u5408\u81ea\u5df1\u7684\u7f51\u901f\u8bc4\u4f30\u4e00\u4e0b\u9700\u8981\u7684\u62c9\u53d6\u65f6\u95f4\uff0c\u8010\u5fc3\u7b49\u5f85\u3002</p> <p>\u53f3\u4e0b\u89d2\u5e94\u8be5\u4f1a\u6709\u5f39\u7a97\u8868\u793a\u5f00\u53d1\u5bb9\u5668\u6b63\u5728\u542f\u52a8\uff0c\u4f60\u53ef\u4ee5\u70b9\u51fb\u67e5\u770b\u65e5\u5fd7\u4e86\u89e3\u542f\u52a8\u8fdb\u5ea6\u3002</p> </li> </ul> <p>\u5b9e\u9a8c\u4ee3\u7801\u5e93\u6839\u76ee\u5f55\u4e0b\u7684 <code>Makefile</code> \u5c06\u76f8\u5173 Docker \u547d\u4ee4\u5c01\u88c5\u6210\u4e86 Makefile \u76ee\u6807\uff1a</p> <ul> <li> <p><code>make</code>\uff1a\u521b\u5efa\u5e76\u542f\u52a8\u5bb9\u5668</p> <p>Ctrl+D \u9000\u51fa\u5e76\u5173\u95ed\u5bb9\u5668\uff0c\u6b64\u65f6\u4f60\u5728\u5bb9\u5668\u5185\u7684\u66f4\u6539\u4f1a\u88ab\u4fdd\u5b58\uff0c\u4e0b\u6b21 <code>make</code> \u8fdb\u5165\u5bb9\u5668\u65f6\u53ef\u4ee5\u7ee7\u7eed\u4f7f\u7528</p> </li> <li> <p><code>make clean</code>\uff1a\u5220\u9664\u5bb9\u5668</p> <p>\u5982\u679c\u4f60\u4e0d\u5c0f\u5fc3\u641e\u574f\u4e86\u5bb9\u5668\u5185\u7684\u73af\u5883\uff0c\u8fd0\u884c\u8be5\u547d\u4ee4\u6e05\u9664\uff0c\u7136\u540e\u91cd\u65b0 <code>make</code> \u8fd0\u884c\u4e00\u4e2a\u65b0\u7684\u5bb9\u5668</p> </li> <li> <p><code>make update</code>\uff1a\u62c9\u53d6\u6700\u65b0\u7684\u955c\u50cf</p> <p>\u5982\u679c\u8bfe\u7a0b\u7fa4\u6709\u901a\u77e5\u5bb9\u5668\u66f4\u65b0\uff0c\u8fd0\u884c\u8be5\u547d\u4ee4\uff0c\u6ce8\u610f\u5b83\u4f1a\u5148\u6267\u884c <code>make clean</code> \u5220\u9664\u65e7\u5bb9\u5668</p> </li> </ul> <pre><code>$ make\ndocker compose create\ndocker compose start\n[+] Running 1/1\n\u2714 Container zju-os  Started               0.3s\ndocker compose exec -it zju-os /usr/bin/fish\nWelcome to fish, the friendly interactive shell\nType help for instructions on how to use fish\nroot@zju-os /zju-os/code#\n</code></pre> <p>Tip</p> <p>\u5c06 Docker \u547d\u4ee4\u5c01\u88c5\u4e3a Makefile \u76ee\u6807\u4ec5\u4ec5\u662f\u4e3a\u4e86\u8ba9\u5e38\u7528\u64cd\u4f5c\u66f4\u7b80\u4fbf\uff0c\u4e0d\u7528\u6253\u4e00\u957f\u4e32\u547d\u4ee4\u3002\u5efa\u8bae\u4f60\u81ea\u884c\u5b66\u4e60 Makefile \u4e2d\u7684\u547d\u4ee4\u542b\u4e49\uff0c\u4ee5\u4fbf\u65e5\u540e\u9047\u5230\u95ee\u9898\u65f6\u77e5\u9053\u8be5\u600e\u4e48\u505a\u3002</p> <p>\u8003\u70b9</p> <ul> <li>\u5bb9\u5668\u548c\u955c\u50cf\u662f\u4ec0\u4e48\u5173\u7cfb\uff1f</li> </ul> <p>\u66f4\u591a\u8d44\u6599</p> <ul> <li>\u5982\u679c\u4f60\u4e0d\u4e86\u89e3 Docker\uff1aWhat is a Container? | Docker</li> <li><code>compose.yml</code> \u63cf\u8ff0\u4e86\u5bb9\u5668\u7684\u8fd0\u884c\u53c2\u6570\uff1aCompose file reference | Docker Docs</li> <li><code>Dockerfile</code> \u63cf\u8ff0\u4e86\u5bb9\u5668\u955c\u50cf\u662f\u5982\u4f55\u6784\u5efa\u7684\uff1aDockerfile reference | Docker Docs</li> <li>\u672c\u8bfe\u7a0b\u7684 <code>Dockerfile</code>\uff1atool/container/Dockerfile at main \u00b7 ZJU-OS/tool</li> <li>\u5bb9\u5668\u5185\u9ed8\u8ba4\u4f7f\u7528 <code>fish</code>\uff0c\u8fd9\u662f\u4e00\u4e2a\u6bd4 <code>bash</code> \u66f4\u53cb\u597d\u7684 shell\uff0c\u63d0\u4f9b\u5f00\u7bb1\u5373\u7528\u7684\u5386\u53f2\u7eaa\u5f55\u3001\u81ea\u52a8\u8865\u5168\u663e\u793a\u7b49\u529f\u80fd\uff1afish shell</li> </ul>"},{"location":"lab0/#part-2linux-\u5185\u6838\u7f16\u8bd1\u4e0e\u8c03\u8bd5","title":"Part 2\uff1aLinux \u5185\u6838\u7f16\u8bd1\u4e0e\u8c03\u8bd5","text":""},{"location":"lab0/#\u4f7f\u7528\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe","title":"\u4f7f\u7528\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe","text":"<p>\u4e5f\u8bb8\u4f60\u63a5\u89e6\u8fc7\u4e0b\u5217\u5de5\u5177\uff1a</p> <pre><code>gcc gdb objdump readelf as ...\n</code></pre> <p>\u5b83\u4eec\u5bf9\u5e94\u7684\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u5e26\u6709\u683c\u5f0f\u4e3a <code>&lt;\u76ee\u6807\u67b6\u6784&gt;-&lt;\u7cfb\u7edf&gt;-&lt;\u5957\u4ef6\u540d&gt;-</code> \u7684\u524d\u7f00\u3002\u6bd4\u5982 Linux \u7cfb\u7edf\u4e0a\u7528\u4e8e\u4ea4\u53c9\u7f16\u8bd1 RISC-V 64 \u67b6\u6784\u7684 GNU \u5de5\u5177\u524d\u7f00\u4e3a <code>riscv64-linux-gnu-</code>\uff0c\u4f7f\u7528\u65b9\u5f0f\u4e0e\u539f\u7248\u76f8\u540c\u3002\u4ee5 GCC \u4e3a\u4f8b\uff1a</p> <pre><code>root@zju-os-code /z/code# riscv64-linux-gnu-gcc hello.c -o hello\nroot@zju-os-code /z/code# file hello\nhello: ELF 64-bit LSB pie executable, UCB RISC-V, RVC, double-float ABI, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux-riscv64-lp64d.so.1, BuildID[sha1]=963fa6ea0ba96c8e9b928927d0e0306355e326d5, for GNU/Linux 4.15.0, not stripped\n</code></pre> <p>\u8bf7\u4f60\u7528 C \u5199\u4e00\u4e2a Hello World \u7a0b\u5e8f\uff0c\u7136\u540e\u6267\u884c\u4e0b\u9762\u7684\u6b65\u9aa4\uff1a</p> <ul> <li>\u751f\u6210\u5b83\u7684 RISC-V \u6c47\u7f16\u4ee3\u7801</li> <li>\u5c06\u5176\u7f16\u8bd1\u4e3a RISC-V \u53ef\u6267\u884c\u7a0b\u5e8f</li> <li>\u5c06 RISC-V \u53ef\u6267\u884c\u7a0b\u5e8f\u53cd\u6c47\u7f16</li> </ul> <p>\u8003\u70b9</p> <p>\u4e0a\u9762\u7684\u6b65\u9aa4\u5206\u522b\u4f7f\u7528\u4e86\u54ea\u51e0\u4e2a\u5de5\u5177\uff1f</p> <p>\u66f4\u591a\u8d44\u6599</p> <ul> <li>GNU \u4e8c\u8fdb\u5236\u5de5\u5177\u6587\u6863\uff0c\u4ecb\u7ecd\u4e86\u5b9e\u9a8c\u4e2d\u4f1a\u7528\u5230\u7684\u76f8\u5173\u5de5\u5177\uff1aBinutils - GNU Project - Free Software Foundation</li> <li>Coreutils - GNU core utilities</li> </ul>"},{"location":"lab0/#\u7f16\u8bd1\u672c\u5730\u67b6\u6784\u5185\u6838","title":"\u7f16\u8bd1\u672c\u5730\u67b6\u6784\u5185\u6838","text":"<p>\u5bb9\u5668\u5185\u7684 <code>/zju-os/linux-source-*</code> \u662f\u9884\u5148\u653e\u7f6e\u597d\u7684 Linux \u5185\u6838\u6e90\u7801\uff1a</p> <pre><code>root@zju-os /zju-os# ls\ncode/  linux-source-6.16/\n</code></pre> <p>\u5728\u5bb9\u5668\u4e2d\u7f16\u8bd1\u5185\u6838\u7684\u57fa\u672c\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <pre><code>root@zju-os /zju-os# cd linux-source-6.16\nroot@zju-os /z/linux-source-6.16# make defconfig\nroot@zju-os /z/linux-source-6.16# make -j$(nproc)\n  ...\n  LD      vmlinux\n  NM      System.map\n  ...\n  BUILD   arch/x86/boot/bzImage\nKernel: arch/x86/boot/bzImage is ready  (#1)\nroot@zju-os /z/linux-source-6.16# make distclean\n</code></pre> <p>\u4e0a\u9762\u7684\u65e5\u5fd7\u662f x86-64 \u67b6\u6784\u7684\u5185\u6838\u7f16\u8bd1\u8f93\u51fa\u3002\u5176\u4ed6\u67b6\u6784\u7684\u8f93\u51fa\u53ef\u80fd\u4e0d\u4e00\u6837\uff0c\u6bd4\u5982\u7b14\u8005\u7684 macOS\uff08arm64\uff09\u4e0a\u8f93\u51fa\u7ed3\u5c3e\u5982\u4e0b\uff1a</p> <pre><code>  LD [M]  net/qrtr/qrtr-tun.ko\nmake[1]: Leaving directory '/zju-os/linux-source-6.16'\n</code></pre> <p>\u603b\u4e4b\uff0c\u53ea\u8981 Make \u6ca1\u6709\u62a5 Error\uff0c\u4e00\u822c\u5c31\u8bf4\u660e\u6784\u5efa\u6210\u529f\u4e86\u3002\u6b64\u65f6\u6587\u4ef6\u5939\u4e2d\u5e94\u8be5\u6709\u6211\u4eec\u9700\u8981\u4e24\u4e2a\u91cd\u8981\u7684\u4ea7\u7269\uff1a</p> <ul> <li><code>arch/&lt;arch&gt;/boot/Image</code></li> <li><code>vmlinux</code></li> </ul> <p>\u6211\u4eec\u5c06\u5728 Lab1 \u4e2d\u4e86\u89e3\u8fd9\u4e24\u4e2a\u6587\u4ef6\u662f\u4ec0\u4e48\uff0c\u4ee5\u53ca\u5b83\u4eec\u7684\u5f02\u540c\u3002</p> <p>\u8003\u70b9</p> <ul> <li>\u8fd0\u884c <code>make help</code>\uff0c\u4e86\u89e3\u4e0a\u9762\u8fd0\u884c\u7684 <code>defconfig</code>\u3001<code>distclean</code> \u7b49 target \u7684\u542b\u4e49</li> <li>\u5f53\u6784\u5efa\u5931\u8d25\u65f6\uff0c\u4f60\u5f88\u53ef\u80fd\u9700\u8981\u67e5\u770b\u8be6\u7ec6\u7684\u7f16\u8bd1\u547d\u4ee4\u3002\u5982\u4f55\u5f00\u542f\u6784\u5efa\u8fc7\u7a0b\u7684\u8be6\u7ec6\u8f93\u51fa\uff1f</li> </ul> <p>\u66f4\u591a\u8d44\u6599</p> <ul> <li>\u5185\u6838\u53d1\u884c\u8bf4\u660e\uff1akernel.org/doc/Documentation/admin-guide/README.rst</li> <li>Debian \u53d1\u884c\u7248\u5185\u6838\u624b\u518c\uff1aChapter\u00a04.\u00a0Common kernel-related tasks</li> <li>Linux \u5185\u6838\u7684\u6784\u5efa\u7cfb\u7edf\u5341\u5206\u590d\u6742\uff0c\u5982\u679c\u4f60\u6709\u5174\u8da3\u4e86\u89e3\uff1aLinux Kernel Makefiles \u2014 The Linux Kernel documentation</li> </ul>"},{"location":"lab0/#\u4ea4\u53c9\u7f16\u8bd1-risc-v-\u67b6\u6784\u5185\u6838","title":"\u4ea4\u53c9\u7f16\u8bd1 RISC-V \u67b6\u6784\u5185\u6838","text":"<p>\u8bf7\u9605\u8bfb\u8fd9\u7bc7\u7b80\u660e\u7684\u6587\u6863 Embedded Handbook/General/Cross-compiling the kernel - Gentoo wiki\uff0c\u4e86\u89e3\u5185\u6838\u4ea4\u53c9\u7f16\u8bd1\u7684\u6b65\u9aa4\u3002</p> <p>\u8003\u70b9</p> <ul> <li>\u4f7f\u7528\u54ea\u4e24\u4e2a\u53d8\u91cf\u6765\u6307\u5b9a\u76ee\u6807\u67b6\u6784\uff1f\u8fd9\u4e24\u4e2a\u53d8\u91cf\u7684\u503c\u5728\u54ea\u91cc\u627e\uff1f</li> <li>\u5982\u4f55\u5728\u547d\u4ee4\u884c\u4e2d\u4e3a <code>make</code> \u6307\u5b9a\u53d8\u91cf\u7684\u503c\uff1f</li> </ul> <p>\u8bf7\u4f60\u6e05\u7406\u4e0a\u4e00\u6b21\u6784\u5efa\u7684\u4ea7\u7269\uff0c\u7136\u540e\u4f7f\u7528\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\u7f16\u8bd1 RISC-V \u67b6\u6784\u7684\u5185\u6838\u3002\u7f16\u8bd1\u6210\u529f\u5e94\u5f53\u5f97\u5230\u5982\u4e0a\u8282\u6240\u8ff0\u7684\u4e24\u4e2a\u4ea7\u7269\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528 <code>file</code> \u547d\u4ee4\u6765\u9a8c\u8bc1\u5b83\u662f\u5426\u4e3a RISC-V \u67b6\u6784\u7684\u5185\u6838\uff1a</p> <pre><code>root@zju-os /z/linux-source-6.16# file arch/riscv/boot/Image\narch/riscv/boot/Image: Linux kernel RISC-V boot executable Image, little-endian\nroot@zju-os /z/linux-source-6.16# file vmlinux\nvmlinux: ELF 64-bit LSB executable, UCB RISC-V, RVC, soft-float ABI, version 1 (SYSV), statically linked, BuildID[sha1]=657ad614b9ebd9723a2d5ee0a25505df3a43b918, not stripped\n</code></pre>"},{"location":"lab0/#\u4f7f\u7528-qemu-\u8fd0\u884c-risc-v-\u5185\u6838","title":"\u4f7f\u7528 QEMU \u8fd0\u884c RISC-V \u5185\u6838","text":"<p>\u56de\u5230\u4ee3\u7801\u4ed3\u5e93\uff0c\u4f7f\u7528 <code>make run</code> \u542f\u52a8 QEMU\uff0c\u8fd0\u884c\u6784\u5efa\u597d\u7684\u5185\u6838\uff1a</p> <pre><code>root@zju-os /zju-os/code# make run\n...\nWelcome to Buildroot\nbuildroot login:\n</code></pre> <p>\u9ed8\u8ba4\u7528\u6237\u4e3a <code>root</code>\uff0c\u5bc6\u7801\u4e3a\u7a7a\u3002\u4f60\u53ef\u4ee5\u767b\u5f55 Shell\uff0c\u8bd5\u8bd5\u8fd9\u4e2a\u6781\u7b80\u7684 RISC-V \u7cfb\u7edf\u80fd\u5e72\u4e9b\u4ec0\u4e48\uff08\u5b83\u5e94\u8be5\u80fd\u8054\u7f51\uff09\uff1a</p> <pre><code>buildroot login: root\n# pwd\n/root\n# uname -a\nLinux buildroot 6.16.3 #1 SMP Fri Sep 12 03:45:12 UTC 2025 riscv64 GNU/Linux\n# wget http://www.baidu.com\nConnecting to www.baidu.com (223.109.82.16:80)\nsaving to 'index.html'\nindex.html           100% |********************************|  2381  0:00:00 ETA\n'index.html' saved\n</code></pre> <p>\u63a5\u4e0b\u6765\u5b66\u4e60 QEMU \u64cd\u4f5c\uff1a</p> <ul> <li> <p>\u73b0\u5728\u4e0e\u4f60\u4ea4\u4e92\u7684\u662f QEMU \u81ea\u5e26\u7684\u7ec8\u7aef\u590d\u7528\u5668\uff08Terminal Multiplexer\uff09</p> <ul> <li>\u5b83\u8fde\u63a5\u7740 QEMU Monitor \u548c\u865a\u62df\u673a\u7684\u63a7\u5236\u53f0\uff08Console\uff09\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u8fde\u63a5\u540e\u8005\u3002</li> <li>Ctrl+A \u518d\u6309 C \u53ef\u4ee5\u5728\u4e24\u8005\u95f4\u5207\u6362\u3002</li> <li>Ctrl+A \u518d\u6309 H \u53ef\u4ee5\u67e5\u770b\u5e2e\u52a9\u3002</li> <li>Ctrl+A \u518d\u6309 X \u53ef\u4ee5\u9000\u51fa QEMU\u3002</li> </ul> <p>\u50cf\u8fd9\u91cc\u7684 Ctrl+A \u8fd9\u6837\u7684\u524d\u5bfc\u7ec4\u5408\u952e\u5728\u7ec8\u7aef\u590d\u7528\u5668\uff08\u5982 tmux\uff09\u4e2d\u88ab\u79f0\u4e3a\u9003\u9038\u952e\uff08escape key\uff09\u3002\u521d\u59cb\u72b6\u6001\u4e0b\uff0c\u5176\u4ed6\u6240\u6709\u6309\u952e\u90fd\u4f1a\u88ab\u76f4\u63a5\u4f20\u9012\u7ed9\u5f53\u524d\u8fde\u63a5\u7684\u7ec8\u7aef\u3002\u5f53\u4f60\u6309\u4e0b\u9003\u9038\u952e\u65f6\uff0c\u7ec8\u7aef\u590d\u7528\u5668\u4f1a\u8fdb\u5165\u300c\u5176\u81ea\u8eab\u7684\u300d\u547d\u4ee4\u6a21\u5f0f\uff0c\u7b49\u5f85\u4f60\u8f93\u5165\u540e\u7eed\u7684\u547d\u4ee4\u952e\u3002</p> <p>\u8981\u70b9\uff1a\u7ec8\u7aef\u590d\u7528\u5668</p> <p>\u8bf7\u540c\u5b66\u4eec\u91cd\u70b9\u7406\u89e3\u7ec8\u7aef\u590d\u7528\u5668\u8fd9\u4e00\u6982\u5ff5\u3002\u5728\u4e4b\u540e\u7684\u5b9e\u9a8c\u4e2d\uff0c\u4f60\u53ef\u80fd\u9047\u5230 QEMU \u4e2d\u865a\u62df\u673a\u5361\u4f4f\u63a7\u5236\u53f0\u65e0\u8f93\u51fa\u3001\u865a\u62df\u673a\u6b7b\u5faa\u73af\u63a7\u5236\u53f0\u75af\u72c2\u8f93\u51fa\u7b49\u60c5\u51b5\uff0c\u4f46\u8fd9\u90fd\u662f\u865a\u62df\u673a\u63a7\u5236\u53f0\u7684\u95ee\u9898\uff0c\u5e76\u4e0d\u5f71\u54cd\u7ec8\u7aef\u590d\u7528\u5668\u7684\u4f7f\u7528\u3002\u53ea\u8981\u4f60\u542f\u52a8\u4e86 QEMU\uff0c\u5c31\u53ef\u4ee5\u901a\u8fc7\u7ec8\u7aef\u590d\u7528\u5668\u5207\u6362\u5230 QEMU Monitor\uff0c\u5e76\u4e0e QEMU Monitor \u4ea4\u4e92\u3002</p> </li> <li> <p>QEMU Monitor \u53ef\u4ee5\u63a7\u5236\u3001\u67e5\u770b\u3001\u8c03\u8bd5\u865a\u62df\u673a\u3002</p> <p>\u5b83\u4e0e\u4e0b\u6587\u4ecb\u7ecd\u7684 GDB \u5404\u6709\u6240\u957f\uff1aQEMU Monitor \u53ef\u4ee5\u67e5\u770b\u5185\u5b58\u6620\u5c04\u3001TLB \u7b49\u5404\u7c7b\u7cfb\u7edf\u4fe1\u606f\uff0c\u800c GDB \u4e13\u6ce8\u4e8e\u7a0b\u5e8f\u8c03\u8bd5\uff0c\u4e3b\u8981\u662f\u67e5\u770b\u548c\u63a7\u5236\u4ee3\u7801\u8fd0\u884c\u3002\u5728\u540e\u7eed\u5b9e\u9a8c\u4e2d\uff0c\u5982\u679c\u4f60\u7684\u4ee3\u7801\u6709\u95ee\u9898\uff0c\u53ef\u80fd\u5bfc\u81f4 GDB \u65e0\u6cd5\u8c03\u8bd5\uff0c\u800c QEMU Monitor \u4ecd\u7136\u53ef\u4ee5\u4f7f\u7528\u3002</p> <p>\u4f60\u53ef\u4ee5\u5728 Monitor \u4e2d\u8fd0\u884c <code>help</code> \u67e5\u770b\u652f\u6301\u7684\u547d\u4ee4\u3002</p> <pre><code>QEMU 10.1.0 monitor - type 'help' for more information\n(qemu) help\n...\nx /fmt addr -- virtual memory dump starting at 'addr'\n(qemu) info mem\nvaddr            paddr            size             attr\n---------------- ---------------- ---------------- -------\n000055556ae09000 0000000081055000 0000000000001000 r-xu-a-\n(qemu) info registers\n\nCPU#0\nV      =   0\npc       ffffffff80b57780\nmhartid  0000000000000000\nmstatus  0000000a000000a0\nhstatus  0000000200000000\n</code></pre> </li> </ul> <p>\u8003\u70b9</p> <p>\u4f7f\u7528 QEMU Monitor \u8fdb\u884c\u4e0b\u5217\u64cd\u4f5c\uff1a</p> <ul> <li>\u67e5\u770b\u5bc4\u5b58\u5668\u3001\u5185\u5b58\u6811\u3001\u8bbe\u5907\u6811\u3001\u7269\u7406\u5185\u5b58\u4e2d\u7684\u503c</li> <li>Linux \u7b2c\u4e00\u6761\u6307\u4ee4\u4f4d\u4e8e\u7269\u7406\u5185\u5b58 <code>0x80200000</code>\uff0c\u6253\u5370\u8fd9\u6761\u6307\u4ee4</li> </ul> <p>Tip</p> <p>\u4ec5\u6709\u4e00\u4e2a\u5185\u6838\u955c\u50cf\u662f\u65e0\u6cd5\u8fd0\u884c\u7cfb\u7edf\u7684\uff0c\u4f60\u8fd8\u9700\u8981\u4e00\u4e2a\u6839\u6587\u4ef6\u7cfb\u7edf\uff08root filesystem\uff09\uff0c\u5176\u4e2d\u5305\u542b\u4e86 Linux \u542f\u52a8\u540e\u9700\u8981\u7684\u5404\u79cd\u6587\u4ef6\uff0c\u4f8b\u5982\u6267\u884c\u4f60\u8f93\u5165\u7684\u6307\u4ee4\u7684 Shell \u7a0b\u5e8f\u3002\u5bb9\u5668\u5185\u9884\u7f6e\u7684 <code>/zju-os/rootfs.ext2</code> \u5c31\u662f\u4e00\u4e2a\u5df2\u7ecf\u6784\u5efa\u597d\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u955c\u50cf\u3002</p> <p>\u66f4\u591a\u8d44\u6599</p> <ul> <li>QEMU System \u624b\u518c\uff1aQEMU User Documentation \u2014 QEMU documentation</li> <li>QEMU Monitor \u624b\u518c\uff1aQEMU Monitor Commands \u2014 QEMU documentation</li> <li><code>rootfs.ext2</code> \u5236\u4f5c\u65b9\u6cd5\uff1aFOSDEM 2019 - Buildroot for RISC-V</li> </ul>"},{"location":"lab0/#qemu-\u542f\u52a8\u8fc7\u7a0b","title":"QEMU \u542f\u52a8\u8fc7\u7a0b","text":"<p>\u5f53\u4f60\u6309\u4e0b\u7535\u8111\u7684\u7535\u6e90\u952e\uff0c\u8ba1\u7b97\u673a\u5f00\u59cb\u6309\u7167\u4e0b\u9762\u7684\u6d41\u7a0b\u542f\u52a8\uff1a</p> <ol> <li> <p>\u56fa\u4ef6\u52a0\u8f7d\uff08Firmware\uff09</p> <ul> <li>\u5728\u4e3b\u677f ROM \u4e2d\u70e7\u5f55\u7684\u56fa\u4ef6\uff08\u5982 BIOS \u6216 UEFI\uff09\u4f1a\u9996\u5148\u88ab\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d\u6267\u884c\u3002</li> <li>\u56fa\u4ef6\u4f1a\u5b8c\u6210 \u786c\u4ef6\u81ea\u68c0\uff08Power-On Self Test\uff0cPOST\uff09\uff0c\u68c0\u6d4b CPU\u3001\u5185\u5b58\u3001\u5916\u8bbe\u7b49\u662f\u5426\u53ef\u7528\uff0c\u5e76\u8fdb\u884c\u57fa\u7840\u521d\u59cb\u5316\u3002</li> <li>\u63a5\u7740\uff0c\u5b83\u4f1a\u5bfb\u627e\u5408\u9002\u7684\u542f\u52a8\u8bbe\u5907\uff08\u5982\u786c\u76d8\u3001U \u76d8\u3001\u7f51\u7edc\u7b49\uff09\uff0c\u7136\u540e\u5c06 \u5f15\u5bfc\u7a0b\u5e8f\uff08Bootloader\uff09\u52a0\u8f7d\u5230\u5185\u5b58\u5e76\u6267\u884c\u3002</li> </ul> </li> <li> <p>\u5f15\u5bfc\u7a0b\u5e8f\uff08Bootloader\uff09\u9636\u6bb5</p> <p>\u8be5\u9636\u6bb5\u4e0d\u662f\u5fc5\u8981\u7684\uff0c\u56fa\u4ef6\u53ef\u4ee5\u76f4\u63a5\u5f15\u5bfc\u8fdb\u5165\u5185\u6838\u3002\u5982\u679c\u6709\u591a\u4e2a\u64cd\u4f5c\u7cfb\u7edf\uff0c\u5219\u5f15\u5bfc\u7a0b\u5e8f\u53ef\u4ee5\u63d0\u4f9b\u9009\u62e9\u754c\u9762\u3002</p> <ul> <li>\u5f15\u5bfc\u7a0b\u5e8f\u7684\u4efb\u52a1\u662f\u628a\u7cfb\u7edf\u5e26\u5165\u53ef\u4ee5\u8fd0\u884c\u5185\u6838\u7684\u72b6\u6001\u3002</li> <li>\u5178\u578b\u7684\u5f15\u5bfc\u7a0b\u5e8f\u5982 GRUB \u6216 U-Boot \u4f1a\u52a0\u8f7d\u5185\u6838\u955c\u50cf\uff08Kernel Image\uff09\u548c \u6839\u6587\u4ef6\u7cfb\u7edf\uff08Root File System\uff09\u3002</li> <li>\u52a0\u8f7d\u5b8c\u6210\u540e\uff0c\u63a7\u5236\u6743\u4f1a\u88ab\u8f6c\u4ea4\u7ed9\u5185\u6838\uff0c\u5f00\u59cb\u6267\u884c\u5185\u6838\u5165\u53e3\u70b9\u7684\u4ee3\u7801\u3002</li> </ul> </li> <li> <p>\u5185\u6838\u542f\u52a8\uff08Kernel Boot\uff09</p> <ul> <li>\u5185\u6838\u4f1a\u521d\u59cb\u5316\u5185\u5b58\u7ba1\u7406\u3001\u8bbe\u5907\u9a71\u52a8\u3001\u8fdb\u7a0b\u8c03\u5ea6\u7b49\u6838\u5fc3\u529f\u80fd\u3002</li> <li>\u521d\u59cb\u5316\u5b8c\u6210\u540e\uff0c\u5185\u6838\u4f1a\u542f\u52a8 \u7b2c\u4e00\u4e2a\u7528\u6237\u7a7a\u95f4\u8fdb\u7a0b\uff08\u901a\u5e38\u662f <code>/sbin/init</code> \u6216 <code>systemd</code>\uff09\uff0c\u8fdb\u4e00\u6b65\u5b8c\u6210\u7cfb\u7edf\u670d\u52a1\u548c\u767b\u5f55\u754c\u9762\u7684\u542f\u52a8\u3002</li> <li>\u6700\u7ec8\uff0c\u7528\u6237\u53ef\u4ee5\u767b\u5f55\u7cfb\u7edf\uff0c\u8fdb\u5165\u6b63\u5e38\u7684\u64cd\u4f5c\u73af\u5883\u3002</li> </ul> </li> </ol> <p>\u5177\u4f53\u5230\u672c\u8bfe\u7a0b\uff1a</p> <ul> <li>QEMU \u63d0\u4f9b\u6a21\u62df\u7684 RISC-V \u786c\u4ef6\u73af\u5883\uff08CPU\u3001\u5185\u5b58\u3001\u5916\u8bbe\u7b49\uff09</li> <li>OpenSBI \u5185\u7f6e\u5728 QEMU \u4e2d\uff0c\u4f5c\u4e3a RISC-V \u67b6\u6784\u7684\u9ed8\u8ba4\u56fa\u4ef6\uff0c\u5b83\u8fd0\u884c\u5728 RISC-V M-Mode</li> <li>\u56e0\u4e3a\u7cfb\u7edf\u7b80\u5355\u6ca1\u6709\u5f15\u5bfc\u7a0b\u5e8f\uff0c\u56fa\u4ef6\u76f4\u63a5\u542f\u52a8\u5185\u6838\uff0c\u5185\u6838\u8fd0\u884c\u5728 RISC-V S-Mode</li> </ul> <p>\u6574\u4f53\u6d41\u7a0b\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> OpenSBI Deep Dive - RISC-V International <p>\u8ba9\u6211\u4eec\u7ed3\u5408\u8f93\u51fa\u4fe1\u606f\u6765\u770b</p> <pre><code>...\n   ____                    _____ ____ _____\n  / __ \\                  / ____|  _ \\_   _|\n | |  | |_ __   ___ _ __ | (___ | |_) || |\n | |  | | '_ \\ / _ \\ '_ \\ \\___ \\|  _ &lt; | |\n | |__| | |_) |  __/ | | |____) | |_) || |_\n  \\____/| .__/ \\___|_| |_|_____/|____/_____|\n        | |\n        |_|\nFirmware Base               : 0x80000000\nDomain0 Next Address        : 0x0000000080200000\nDomain0 Next Arg1           : 0x0000000087e00000\nDomain0 Next Mode           : S-mode\n...\n[    0.000000] Booting Linux on hartid 0\n[    0.000000] Linux version 6.16.3 (root@zju-os-code) (riscv64-linux-gnu-gcc (Debian 15.2.0-3) 15.2.0, GNU ld (GNU Binutils for Debian) 2.45) #1 SMP Fri Sep 12 03:45:12 UTC 2025\n</code></pre> <ul> <li>QEMU \u4f5c\u4e3a Loader<ul> <li>\u5c06 OpenSBI \u52a0\u8f7d\u5230\u5185\u5b58\u4e2d\u7684 <code>0x80000000</code></li> <li>\u5c06 Linux \u5185\u6838\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d\u7684 <code>0x80200000</code></li> </ul> </li> <li>QEMU \u5185\u7f6e\u7684 OpenSBI \u4f7f\u7528 <code>FW_DYNAMIC</code> \u6a21\u5f0f<ul> <li>QEMU \u5c06 <code>next_addr</code> \u7b49\u4fe1\u606f\u653e\u5728 <code>struct fw_dynamic_info</code> \u7ed3\u6784\u4f53\u4e2d\uff0c\u5c06\u8be5\u7ed3\u6784\u4f53\u7684\u5730\u5740\u5b58\u653e\u5728 <code>a2</code> \u5bc4\u5b58\u5668\u4e2d</li> <li>OpenSBI \u8bfb\u53d6\u8be5\u4fe1\u606f\uff0c\u4e86\u89e3\u4e0b\u4e00\u6b65\u8981\u600e\u4e48\u505a\uff0c\u4ece\u65e5\u5fd7\u4e2d\u53ef\u4ee5\u770b\u5230\u5b83\u4e0b\u4e00\u6b65\u8df3\u8f6c\u5230 <code>next_addr</code> \u5373\u5185\u6838\u5165\u53e3\u70b9\u5730\u5740\uff0c\u5e76\u8c03\u6574\u7279\u6743\u7ea7\u4e3a <code>next_mode</code> \u5373 S-Mode</li> </ul> </li> <li><code>Booting Linux on hartid 0</code> \u662f\u5185\u6838 <code>start_kernel()</code> \u6253\u5370\u51fa\u7684\u7b2c\u4e00\u6761\u65e5\u5fd7</li> </ul> <p>\u66f4\u591a\u4fe1\u606f</p> <ul> <li>QEMU RISC-V \u542f\u52a8\u5b9e\u73b0\uff1aqemu/hw/riscv/boot.c at master \u00b7 qemu/qemu</li> <li>OpenSBI \u8be6\u89e3\uff1aOpenSBI Deep Dive - RISC-V International</li> </ul>"},{"location":"lab0/#risc-v-\u89c4\u8303\u5bfc\u8bfb","title":"RISC-V \u89c4\u8303\u5bfc\u8bfb","text":"<p>\u73b0\u5728\u540c\u5b66\u4eec\u77e5\u9053 QEMU \u548c OpenSBI \u5728\u542f\u52a8\u8fc7\u7a0b\u4e2d\u7684\u89d2\u8272\uff0c\u63a5\u4e0b\u6765\u4e00\u8d77\u8bfb\u4e00\u8bfb RISC-V \u89c4\u8303\u3002</p> <p>RISC-V \u975e\u7279\u6743\u7ea7\u89c4\u8303\u4e2d\u7684\u5185\u5bb9\u60f3\u5fc5\u540c\u5b66\u4eec\u5df2\u7ecf\u5728\u786c\u4ef6\u8bfe\u7a0b\u4e2d\u5403\u900f\u4e86\uff1a</p> <ul> <li>Chapter 2. RV32I Base Integer Instruction Set</li> <li>Chapter 3. RV32E and RV64E Base Integer Instruction Sets</li> <li>Chapter 4. RV64I Base Integer Instruction Set</li> <li>Chapter 6. \"Zicsr\", Extension for Control and Status Register  (CSR) Instructions</li> </ul> <p>Zicsr \u6269\u5c55\u4e3b\u8981\u7528\u4e8e\u64cd\u4f5c\u7279\u6743\u7ea7\u5bc4\u5b58\u5668\uff0c\u4f46\u5728\u975e\u7279\u6743\u7ea7\u4e5f\u6709\u7528\u6cd5\uff0c\u56e0\u6b64\u6ca1\u6709\u653e\u7f6e\u5728\u7279\u6743\u7ea7\u624b\u518c\u4e2d\u3002\u6211\u4eec\u5c06\u5728 Lab1 \u5b66\u4e60\u8be5\u6269\u5c55\u3002</p> <p>\u7ffb\u5f00 RISC-V \u7279\u6743\u7ea7\u624b\u518c\uff0c\u5f00\u7bc7\u4ecb\u7ecd\u7684 RISC-V Privileged Software Stack \u6b63\u662f\u672c\u8bfe\u7a0b\u8981\u5b9e\u73b0\u7684\u5185\u5bb9\u3002\u8bf7\u6ce8\u610f\u4e0b\u56fe\u4e2d\u4f60\u7684OS\u5728\u4ec0\u4e48\u4f4d\u7f6e\uff1a</p> <p></p> <p>\u56fe\u4e2d\u767d\u8272\u65b9\u6846\u662f\u5177\u4f53\u5b9e\u73b0\uff0c\u9ed1\u8272\u65b9\u6846\u662f\u62bd\u8c61\u63a5\u53e3\u3002\u53ea\u8981\u7b26\u5408\u63a5\u53e3\u89c4\u8303\uff0c\u5404\u4e2a\u7ec4\u4ef6\u5c31\u80fd\u534f\u540c\u5de5\u4f5c\uff0c\u7ec4\u6210\u5b8c\u6574\u7684\u7cfb\u7edf\u3002\u672c\u8bfe\u7a0b\u5b9e\u73b0\u7684 OS \u5411\u4e0b\u5bf9\u63a5 RISC-V \u6307\u4ee4\u96c6\u548c SBI \u89c4\u8303\uff0c\u5411\u4e0a\u5bf9\u63a5 Linux \u98ce\u683c\u7684 ABI \u548c\u7cfb\u7edf\u8c03\u7528\u63a5\u53e3\u3002</p> <p>\u8bf7\u6253\u5f00 RISC-V \u975e\u7279\u6743\u7ea7\u624b\u518c\uff0c\u9605\u8bfb\uff1a</p> <ul> <li>1.2. RISC-V Software Execution Environments and Harts</li> </ul> <p>\u4f60\u5e94\u8be5\u7406\u89e3\u4e0b\u5217\u6982\u5ff5\uff1a</p> <ul> <li> <p>Hart\uff08hardware thread\uff09\u662f\u62bd\u8c61\u7684\u6267\u884c\u8d44\u6e90\uff0c\u72ec\u7acb\u83b7\u53d6\u548c\u6267\u884c\u6307\u4ee4\u3002</p> <p>\u56e0\u4e3a\u6709 Hart \u8fd9\u4e00\u5c42\u62bd\u8c61\uff0c\u64cd\u4f5c\u7cfb\u7edf\u770b\u5230\u7684\u60c5\u51b5\u4e5f\u6709\u53ef\u80fd\u4e0e\u771f\u5b9e\u7684\u786c\u4ef6\u4e0d\u540c\u3002\u6bd4\u5982\uff0c\u5373\u4f7f CPU \u53ea\u6709\u5355\u4e2a\u7269\u7406\u6838\u5fc3\uff0cOpenSBI \u8fd9\u6837\u7684 SEE \u4e5f\u53ef\u4ee5\u901a\u8fc7\u65f6\u95f4\u590d\u7528\u7684\u65b9\u5f0f\uff0c\u5411\u4e0a\u5c42\u63d0\u4f9b\u591a\u4e2a Hart\u3002</p> </li> <li> <p>RISC-V \u6267\u884c\u73af\u5883\u63a5\u53e3\uff08Execution Environment Interface, EEI\uff09</p> <ul> <li>\u63cf\u8ff0\u7a0b\u5e8f\u8fd0\u884c\u7684\u73af\u5883\uff0c\u5305\u62ec\uff1a\u7a0b\u5e8f\u521d\u59cb\u72b6\u6001\u3001\u5f02\u5e38\u3001\u4e2d\u65ad\u53ca\u73af\u5883\u8c03\u7528\u7684\u5904\u7406\u65b9\u5f0f</li> <li>\u4f8b\u5b50\uff1aLinux ABI\u3001RISC-V Supervisor Binary Interface (SBI)</li> <li>\u5b9e\u73b0\u65b9\u5f0f\uff1a\u7eaf\u786c\u4ef6\u3001\u7eaf\u8f6f\u4ef6\u6216\u8f6f\u786c\u4ef6\u7ed3\u5408\u3002<ul> <li>Bare-metal \u5e73\u53f0\uff1ahart \u76f4\u63a5\u7531\u7269\u7406\u5904\u7406\u5668\u7ebf\u7a0b\u5b9e\u73b0\uff0c\u6307\u4ee4\u76f4\u63a5\u8bbf\u95ee\u7269\u7406\u5730\u5740\u3002</li> <li>RISC-V \u64cd\u4f5c\u7cfb\u7edf\uff1a\u901a\u8fc7\u865a\u62df\u5185\u5b58\u548c\u65f6\u95f4\u590d\u7528\uff0c\u4e3a\u7528\u6237\u63d0\u4f9b\u591a\u4e2a\u7528\u6237\u7ea7\u6267\u884c\u73af\u5883\u3002</li> <li>RISC-V Hypervisor\uff1a\u4e3a\u5ba2\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u591a\u4e2a supervisor \u7ea7\u6267\u884c\u73af\u5883\u3002</li> <li>\u6a21\u62df\u5668\uff1a\u5982 Spike\u3001QEMU\u3001rv8\uff0c\u53ef\u5728 x86 \u7cfb\u7edf\u4e0a\u6a21\u62df RISC-V harts\u3002</li> </ul> </li> </ul> </li> </ul> <p>\u5e76\u4e14\u80fd\u7406\u89e3\u4e0a\u4e00\u8282\u4ecb\u7ecd\u7684 QEMU \u542f\u52a8\u8fc7\u7a0b\u4e2d\uff0c\u5404\u4e2a\u7ec4\u4ef6\u7684\u89d2\u8272\uff1a</p> <ul> <li>QEMU \u4f5c\u4e3a\u6a21\u62df\u5668\uff0c\u5b9e\u73b0 RISC-V ISA\uff0c\u63d0\u4f9b RISC-V hart</li> <li>OpenSBI \u4f5c\u4e3a\u56fa\u4ef6\uff0c\u5b9e\u73b0 SBI\uff0c\u63d0\u4f9b SEE</li> <li>Linux \u4f5c\u4e3a\u64cd\u4f5c\u7cfb\u7edf\uff0c\u5b9e\u73b0 Linux ABI\uff0c\u63d0\u4f9b AEE</li> </ul> <p>\u8fd9\u4e9b\u62bd\u8c61\u5c42\u6b21\u5960\u5b9a\u4e86\u540e\u7eed\u5b9e\u9a8c\u7684\u6574\u4f53\u6846\u67b6\uff0c\u8bf7\u52a1\u5fc5\u7406\u89e3\u3002</p> <p>\u8003\u70b9</p> <ul> <li>\u4f60\u5b9e\u73b0\u7684\u64cd\u4f5c\u7cfb\u7edf\u9700\u8981 SEE\uff0c\u4f60\u5e94\u8be5\u53bb\u67e5\u770b\u54ea\u4e2a\u89c4\u8303\u4e86\u89e3 SEE \u7684\u63a5\u53e3\uff1f</li> </ul>"},{"location":"lab0/#gdb-\u8c03\u8bd5\u5185\u6838","title":"GDB \u8c03\u8bd5\u5185\u6838","text":"<p>\u73b0\u5728\u9700\u8981\u6253\u5f00\u4e24\u4e2a\u7ec8\u7aef\uff0c\u4e00\u4e2a\u8fd0\u884c QEMU\uff0c\u53e6\u4e00\u4e2a\u8fd0\u884c GDB \u8fdb\u884c\u8c03\u8bd5\u3002\u6253\u5f00\u591a\u4e2a\u7ec8\u7aef\u6709\u5f88\u591a\u65b9\u5f0f\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>\u7528 VSCode \u6253\u5f00\u591a\u4e2a\u7ec8\u7aef</li> <li>\u5728\u5bb9\u5668\u5185\u4f7f\u7528 tmux \u7b49\u7ec8\u7aef\u590d\u7528\u5de5\u5177\u3002\u53ef\u53c2\u8003 Tmux \u4f7f\u7528\u6559\u7a0b - \u962e\u4e00\u5cf0\u7684\u7f51\u7edc\u65e5\u5fd7 \u6216 Home \u00b7 tmux/tmux Wiki</li> </ul> <p>\u5728\u5176\u4e2d\u4e00\u4e2a\u7ec8\u7aef\u8fd0\u884c <code>make debug</code>\uff0c\u4f1a\u770b\u5230 QEMU \u547d\u4ee4\u6267\u884c\u540e\u5c31\u505c\u4f4f\u4e86\u3002\u5728\u53e6\u4e00\u4e2a\u7ec8\u7aef\u8fd0\u884c <code>make gdb</code>\uff0cGDB \u81ea\u52a8\u8fde\u63a5\u5230 QEMU \u4e0a\uff0c\u4f46\u56e0\u4e3a\u4ec0\u4e48\u547d\u4ee4\u90fd\u6ca1\u6267\u884c\uff0cGDB \u663e\u793a\u7684\u5185\u5bb9\u5168\u7a7a\uff1a</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                                                             \u2502\n\u2502                    [ No Source Available ]                  \u2502\n\u2502                                                             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                                                             \u2502\n\u2502                    [ No Assembly Available ]                \u2502\n\u2502                                                             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nremote Thread 1.1 (src) In:                     L??   PC: 0x1000\n(gdb)\n</code></pre> <p>\u63a5\u4e0b\u6765\uff0c\u8bf7\u4f60\u4efb\u9009\u8d44\u6599\u9605\u8bfb\uff1a</p> <ul> <li>GDB Command Reference - Index page</li> <li>Debugging with GDB</li> <li>100\u4e2agdb\u5c0f\u6280\u5de7</li> <li>gdb \u76f8\u5173\u4f7f\u7528\u5907\u5fd8 - \u9e64\u7fd4\u4e07\u91cc\u7684\u7b14\u8bb0\u672c</li> </ul> <p>\u4e86\u89e3\u4e0b\u5217\u547d\u4ee4\u7684\u542b\u4e49\uff0c\u5e76\u8fdb\u884c\u5b9e\u64cd\uff1a</p> <pre><code>layout [Name]\nstart [Arguments]\nbreak [Function Name]\nbreak *[Address]\nbreak [...] if [Condition]\ncontinue [Repeat count]\nstepi [Repeat count]\nbacktrace\nfinish\ninfo register [Register name]\nprint [Expression]\nx /[Length][Format] [Address expression]\nquit\n</code></pre> <p>\u5173\u4e8e gdb \u811a\u672c</p> <p>\u5f53\u4f60\u8fd0\u884c <code>make gdb</code> \u542f\u52a8\u8c03\u8bd5\u65f6\uff0c\u5b83\u4f1a\u9996\u5148\u6267\u884c <code>gdbinit</code> \u811a\u672c\uff0c\u8fdb\u884c\u4e00\u4e9b\u521d\u59cb\u5316\u8bbe\u7f6e\uff0c\u8fd9\u907f\u514d\u4e86\u6211\u4eec\u6bcf\u6b21\u624b\u52a8\u8f93\u5165\u4e00\u4e9b\u91cd\u590d\u7684\u547d\u4ee4\u3002\u5982\u679c\u4f60\u60f3\u5c1d\u8bd5\u66f4\u52a0\u201c\u73b0\u4ee3\u201d\u7684 gdb \u8c03\u8bd5\uff0c\u73b0\u5728\u7684 gdb \u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86 Python API\uff0c\u6211\u4eec\u53ef\u4ee5\u66f4\u52a0\u65b9\u4fbf\u5730\u5b9e\u73b0\u4e8b\u4ef6\u56de\u8c03\u3001\u8c03\u8bd5\u72b6\u6001\u8bbf\u95ee\u3001\u81ea\u5b9a\u4e49\u6253\u5370\u7b49\u529f\u80fd\uff0c\u4e5f\u53ef\u4ee5\u501f\u52a9 Python \u751f\u6001\u5b9e\u73b0\u66f4\u4e30\u5bcc\u7684\u81ea\u52a8\u5316\u6d41\u7a0b\u3002\u672a\u6765\u7684\u5185\u6838\u8c03\u8bd5\u53ef\u80fd\u8d8a\u6765\u8d8a\u590d\u6742\uff0c\u4f60\u53ef\u4ee5\u79ef\u6781\u63a2\u7d22\u66f4\u591a\u66f4\u597d\u7684\u8c03\u8bd5\u65b9\u5f0f\u3002</p> <p>\u5728\u4ee3\u7801\u4ed3\u5e93\u4e2d\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539 <code>GDB_INIT_SCRIPT</code> \u53d8\u91cf\u9009\u62e9\u4f7f\u7528 <code>gdbinit.py</code> \u66ff\u4ee3 <code>gdbinit</code> \u811a\u672c\uff1a</p> Makefile<pre><code># GDB_INIT_SCRIPT := gdbinit\nGDB_INIT_SCRIPT := gdbinit.py\n</code></pre> <p>\u8003\u70b9</p> <p>\u9605\u8bfb <code>Makefile</code> \u548c <code>gdbinit</code>\uff1a</p> <ul> <li><code>make run</code> \u548c <code>make debug</code> \u6709\u4ec0\u4e48\u4e0d\u540c\uff1f\u65b0\u589e\u7684\u9009\u9879\u542b\u4e49\u662f\u4ec0\u4e48\uff1f</li> <li>\u4f60\u8fd0\u884c <code>make gdb</code> \u65f6\uff0c\u811a\u672c\u5bf9 GDB \u505a\u4e86\u54ea\u4e9b\u8bbe\u7f6e\uff1f</li> </ul> <p>\u4f7f\u7528 GDB \u8fdb\u884c\u4e0b\u5217\u64cd\u4f5c\uff1a</p> <ul> <li>\u65ad\u70b9\uff1a\u8bbe\u7f6e\u65ad\u70b9\u3001\u67e5\u770b\u65ad\u70b9\u3001\u5220\u9664\u65ad\u70b9</li> <li>\u8c03\u8bd5\uff1a\u5355\u6307\u4ee4\u6267\u884c\u3001\u9010\u8fc7\u7a0b\u6267\u884c\u3001\u7ed3\u675f\u5f53\u524d\u51fd\u6570\u3001\u7ee7\u7eed\u6267\u884c</li> <li>\u67e5\u770b\uff1a\u6c47\u7f16\u4ee3\u7801\u3001\u51fd\u6570\u8c03\u7528\u6808\u3001\u53d8\u91cf\u3001\u5bc4\u5b58\u5668\u503c\u3001\u5185\u5b58\u4e2d\u7684\u5185\u5bb9</li> <li>\u5206\u5c4f\uff1a\u5982\u4f55\u5728\u6c47\u7f16\u4ee3\u7801\u548c\u4ea4\u4e92\u547d\u4ee4\u884c\u7a97\u683c\u4e4b\u95f4\u5207\u6362</li> </ul> <p>\u4e0a\u4e00\u8282\u6211\u4eec\u4e86\u89e3\u4e86\u542f\u52a8\u7684\u8be6\u7ec6\u8fc7\u7a0b\uff0c\u8981\u6c42\u4f60\u4f7f\u7528 GDB \u8fdb\u4e00\u6b65\u4e86\u89e3\uff1a</p> <ul> <li>\u5728 OpenSBI \u7684\u8d77\u59cb\u5904\u6253\u65ad\u70b9\uff0c\u770b\u770b\u8fd9\u65f6\u5019 <code>a2</code> \u5bc4\u5b58\u5668\u7684\u503c\u662f\u591a\u5c11\uff1b\u8fdb\u4e00\u6b65\uff0c\u67e5\u770b\u5bf9\u5e94\u5185\u5b58\u4f4d\u7f6e\u7684\u503c</li> <li>\u5728\u5185\u6838\u8d77\u59cb\u5904\u6253\u65ad\u70b9\uff0c\u770b\u770b\u8fd9\u65f6\u5019 Next Arg1 \u5904\u7684\u5185\u5b58\u5b58\u653e\u4e86\u4ec0\u4e48\u5185\u5bb9</li> </ul> <p>\u66f4\u591a\u8d44\u6599</p> <ul> <li>GDB \u63d2\u4ef6\uff1agdb-dashboard</li> </ul>"},{"location":"lab1/","title":"Lab 1\uff1a\u5185\u6838\u542f\u52a8\u4e0e\u65f6\u949f\u4e2d\u65ad","text":""},{"location":"lab1/#lab-1\u5185\u6838\u542f\u52a8\u4e0e\u65f6\u949f\u4e2d\u65ad","title":"Lab 1\uff1a\u5185\u6838\u542f\u52a8\u4e0e\u65f6\u949f\u4e2d\u65ad","text":"<p>DDL</p> <ul> <li>\u4ee3\u7801\u3001\u62a5\u544a\uff1a2025-10-13 23:59</li> <li>\u9a8c\u6536\uff1a2025-10-21 \u5b9e\u9a8c\u8bfe</li> </ul>"},{"location":"lab1/#\u5b9e\u9a8c\u7b80\u4ecb","title":"\u5b9e\u9a8c\u7b80\u4ecb","text":"<p>\u5728 Lab 1 \u4e2d\u6211\u4eec\u5c06\u5f00\u59cb\u6784\u5efa\u81ea\u5df1\u7684\u5185\u6838\u3002\u68b3\u7406\u4e00\u4e0b\u76ee\u524d\u7684\u601d\u8def\uff1a</p> <ul> <li> <p>\u5728\u5b9e\u9a8c\u5bfc\u8bfb\u548c Lab0 \u4e2d\uff0c\u6211\u4eec\u5df2\u7ecf\u4e86\u89e3\u4e86\u542f\u52a8\u8fc7\u7a0b\uff1a</p> <ul> <li>OpenSBI \u8df3\u8f6c\u5230\u5185\u6838\u7b2c\u4e00\u6761\u6307\u4ee4\u5904\u3002</li> <li><code>arch/riscv/head.S</code> \u662f\u5185\u6838\u6700\u5f00\u59cb\u6267\u884c\u7684\u6c47\u7f16\u4ee3\u7801\u3002\u67e5\u770b\u5b83\uff0c\u4f60\u4f1a\u53d1\u73b0\u5b83\u6700\u7ec8\u6267\u884c\u4e86 <code>tail start_kernel</code> \u8df3\u8f6c\u5230\u4f4d\u4e8e <code>arch/riscv/init/main.c</code> \u7684 C \u8bed\u8a00\u4ee3\u7801\u3002</li> </ul> <p>\u90a3\u4e48\u6709\u5982\u4e0b\u95ee\u9898\uff1a</p> <ul> <li>\u4ece OpenSBI \u8df3\u5230\u5185\u6838\u65f6\uff0c\u7cfb\u7edf\u7684\u72b6\u6001\uff08\u5bc4\u5b58\u5668\u3001\u5185\u5b58\u7b49\uff09\u662f\u4ec0\u4e48\u6837\u7684\uff1f\u8fd9\u9700\u8981\u4f60\u52a8\u624b\u8c03\u8bd5\uff0c\u7528 Lab0 \u5b66\u4e60\u7684 QEMU Monitor \u548c GDB \u81ea\u884c\u67e5\u770b\u3002</li> <li>\u4ece\u6c47\u7f16\u4ee3\u7801\u8df3\u5230 C \u51fd\u6570\uff0c\u8c03\u7528\u8005\u3001\u88ab\u8c03\u7528\u8005\u5404\u9700\u8981\u505a\u4ec0\u4e48\u5de5\u4f5c\uff1f\u56de\u5fc6\u300a\u8ba1\u7b97\u673a\u7ec4\u6210\u300b\u8bfe\u7a0b\uff0c\u6211\u4eec\u5b66\u4e60\u8fc7\u6c47\u7f16\u4e0e C \u8bed\u8a00\u7684\u5173\u7cfb\u3002\u8fd9\u9700\u8981\u4f60\u5b66\u4e60RISC-V \u8c03\u7528\u7ea6\u5b9a\uff0c\u7136\u540e\u8865\u5168 <code>arch/riscv/boot.S</code>\u3002</li> <li>\u5982\u4f55\u63a7\u5236\u5185\u6838\u4ee3\u7801\u3001\u6570\u636e\u653e\u7f6e\u7684\u4f4d\u7f6e\uff1f\u8fd9\u9700\u8981\u4f60\u5b66\u4e60\u94fe\u63a5\u5668\u811a\u672c\uff0c\u7136\u540e\u7406\u89e3 <code>arch/riscv/kernel/vmlinux.lds</code>\u3002</li> <li>\u6ca1\u6709\u4e86\u6807\u51c6\u5e93\uff0c\u6253\u5370\u5b57\u7b26\u7b49\u57fa\u672c\u529f\u80fd\u5982\u4f55\u5b9e\u73b0\uff1f\u8fd9\u9700\u8981\u4f60\u5b66\u4e60SBI \u89c4\u8303\uff0c\u7136\u540e\u8865\u5168 <code>arch/riscv/kernel/sbi.c</code>\u3002</li> </ul> </li> </ul> <p>\u5b8c\u6210\u8fd9\u4e9b\uff0c\u4f60\u5c31\u80fd\u591f\u542f\u52a8\u81ea\u5df1\u7684\u5185\u6838\uff0c\u5e76\u6253\u5370 <code>Hello, ZJU-OS!</code> \u4e86\u3002</p> <ul> <li> <p>\u6211\u4eec\u7684\u4e0b\u4e00\u4e2a\u76ee\u6807\u662f\u4e3a Lab2 \u7ebf\u7a0b\u8c03\u5ea6\u505a\u51c6\u5907\uff1a</p> <p>\u6211\u4eec\u5728\u7406\u8bba\u8bfe\u4e0a\u5b66\u4e60\u4e86\u64cd\u4f5c\u7cfb\u7edf\u662f\u4e8b\u4ef6\u9a71\u52a8\u7684\uff0c\u610f\u5473\u7740\u7cfb\u7edf\u7684\u6267\u884c\u6d41\u662f\u7531\u5404\u79cd\u4e8b\u4ef6\u89e6\u53d1\u7684\uff0c\u4f8b\u5982 I/O \u5b8c\u6210\u3001\u8fdb\u7a0b\u521b\u5efa\u3001\u7528\u6237\u8f93\u5165\u7b49\u3002\u65f6\u949f\u4e2d\u65ad\u662f\u5176\u4e2d\u6700\u57fa\u7840\u3001\u6700\u91cd\u8981\u7684\u4e8b\u4ef6\u6e90\u4e4b\u4e00\u3002\u5982\u679c\u6ca1\u6709\u65f6\u949f\u4e2d\u65ad\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5c06\u65e0\u6cd5\u611f\u77e5\u65f6\u95f4\u7684\u6d41\u901d\uff0c\u65e0\u6cd5\u5728\u5408\u9002\u7684\u65f6\u673a\u8fdb\u884c\u8fdb\u7a0b\u5207\u6362\u3001\u8c03\u5ea6\u3001\u8d85\u65f6\u5904\u7406\u6216\u5b9e\u73b0\u5ef6\u65f6\u7b49\u5f85\u3002\u901a\u8fc7\u5468\u671f\u6027\u89e6\u53d1\u7684\u65f6\u949f\u4e2d\u65ad\uff0c\u5185\u6838\u53ef\u4ee5\u88ab\u52a8\u5730\u8f6c\u53d8\u4e3a\u4e3b\u52a8\uff1a\u4e0d\u518d\u4f9d\u8d56\u8fdb\u7a0b\u81ea\u613f\u4ea4\u51fa CPU\uff0c\u800c\u662f\u80fd\u5728\u4e2d\u65ad\u5230\u6765\u65f6\u6253\u65ad\u5f53\u524d\u6267\u884c\u6d41\uff0c\u68c0\u67e5\u662f\u5426\u6709\u66f4\u9ad8\u4f18\u5148\u7ea7\u7684\u4efb\u52a1\u6216\u7b49\u5f85\u8d85\u65f6\u7684\u4e8b\u4ef6\u9700\u8981\u5904\u7406\uff0c\u4ece\u800c\u4fdd\u8bc1\u591a\u4efb\u52a1\u7cfb\u7edf\u7684\u516c\u5e73\u6027\u548c\u54cd\u5e94\u6027\u3002</p> <p>\u90a3\u4e48\u6709\u5982\u4e0b\u95ee\u9898\uff1a</p> <ul> <li>RISC-V \u662f\u5982\u4f55\u8bbe\u8ba1\u4e2d\u65ad\u4e0e\u5f02\u5e38\u7684\uff1f\u600e\u4e48\u5f00\u542f\u65f6\u949f\u4e2d\u65ad\uff1f\u8fd9\u9700\u8981\u4f60\u5b66\u4e60RISC-V \u7279\u6743\u7ea7\u3001\u4e2d\u65ad\u4e0e\u5f02\u5e38\u3001CSR \u5bc4\u5b58\u5668\u3002</li> <li>\u4e2d\u65ad\u3001\u5f02\u5e38\u53ef\u80fd\u5728\u4efb\u4f55\u65f6\u5019\u53d1\u751f\u3002\u5e94\u8be5\u5982\u4f55\u5b9e\u73b0 Trap \u5904\u7406\u7a0b\u5e8f\uff0c\u4fdd\u5b58\u548c\u6062\u590d\u73b0\u573a\uff0c\u4ece\u800c\u4fdd\u8bc1\u5185\u6838\u548c\u7528\u6237\u7a0b\u5e8f\u7684\u6b63\u786e\u6267\u884c\uff1f\u8fd9\u9700\u8981\u4f60\u5b66\u4e60RISC-V \u4e2d\u65ad\u5f02\u5e38\u59d4\u6d3e\u3001\u4e2d\u65ad\u5904\u7406\uff0c\u7136\u540e\u8865\u5168 <code>arch/riscv/kernel/entry.S</code>\u3002</li> </ul> </li> </ul> <p>\u5b8c\u6210\u8fd9\u4e9b\uff0c\u4f60\u5c31\u80fd\u505a Lab2 \u4e86\u3002</p>"},{"location":"lab1/#\u5b9e\u9a8c\u8981\u6c42","title":"\u5b9e\u9a8c\u8981\u6c42","text":"<p>\u89c1 \u9996\u9875#\u8981\u6c42\u548c\u8bc4\u5206\u6807\u51c6</p>"},{"location":"lab1/#part-0\u73af\u5883\u914d\u7f6e","title":"Part 0\uff1a\u73af\u5883\u914d\u7f6e","text":""},{"location":"lab1/#linux-\u5185\u6838\u6e90\u7801\u548c\u8bfe\u7a0b\u4ed3\u5e93\u7ed3\u6784","title":"Linux \u5185\u6838\u6e90\u7801\u548c\u8bfe\u7a0b\u4ed3\u5e93\u7ed3\u6784","text":"<p>\u8be6\u89c1 Linux source code layout \u2014 The Linux Kernel documentation\u3002\u4f60\u53ef\u4ee5\u6253\u5f00\u5de6\u4fa7\u7684 Linux \u6e90\u7801\u94fe\u63a5\uff0c\u8fb9\u8bfb\u8fb9\u770b\u3002</p> <p>\u8bfe\u7a0b\u4ed3\u5e93\u76ee\u5f55\u7684\u7ec4\u7ec7\u7ed3\u6784\u4e0e Linux \u6e90\u7801\u4fdd\u6301\u4e00\u81f4\u3002</p> <ul> <li><code>arch</code>\uff1a\u7279\u5b9a\u67b6\u6784\u7684\u4ee3\u7801\uff0c\u5b9e\u73b0\u542f\u52a8\u3001\u5f02\u5e38\u5904\u7406\u7b49\u6838\u5fc3\u529f\u80fd\uff0c\u90fd\u53d7\u5230\u6307\u4ee4\u96c6\u67b6\u6784\u7684\u7ea6\u675f</li> <li><code>arch/riscv/kernel/head.S</code>\uff1a\u5185\u6838\u6700\u5f00\u59cb\u6267\u884c\u7684\u4ee3\u7801</li> <li><code>lib</code>\uff1a\u5185\u6838\u65e0\u6cd5\u4f7f\u7528\u6807\u51c6\u5e93\uff0c<code>printk</code> \u7b49\u8f85\u52a9\u51fd\u6570\u5b9e\u73b0\u5728\u8fd9\u91cc</li> </ul> <p>\u5176\u4e2d <code>arch/riscv</code> \u76ee\u5f55\u6700\u4e3a\u91cd\u8981\uff0c\u8bfe\u7a0b\u5b9e\u9a8c\u5927\u90e8\u5206\u7684\u4ee3\u7801\u5de5\u4f5c\u90fd\u5c06\u53d1\u751f\u5728\u8fd9\u91cc\u3002</p>"},{"location":"lab1/#\u66f4\u65b0\u4ee3\u7801","title":"\u66f4\u65b0\u4ee3\u7801","text":"<p>\u73b0\u5728\u4f60\u4f4d\u4e8e <code>lab0</code> \u5206\u652f\u3002\u4f60\u9700\u8981\u521b\u5efa <code>lab1</code> \u5206\u652f\uff0c\u5408\u5e76\u4e0a\u6e38\u7684\u4ee3\u7801\uff1a</p> <pre><code>git checkout -b lab1\ngit fetch upstream\ngit merge upstream/lab1\n</code></pre> <p>\u4e0b\u9762\u7684\u5408\u5e76\u8bf4\u660e\u4f9b\u540c\u5b66\u4eec\u89e3\u51b3\u5408\u5e76\u51b2\u7a81\u65f6\u53c2\u8003\uff1a</p> <ul> <li>\u65b0\u589e <code>kernel</code> \u76ee\u5f55\u4e0b\u7684\u5b9e\u9a8c\u4ee3\u7801</li> </ul>"},{"location":"lab1/#part-1\u542f\u52a8\u5de5\u4f5c","title":"Part 1\uff1a\u542f\u52a8\u5de5\u4f5c","text":""},{"location":"lab1/#risc-v-\u6c47\u7f16\u4e0e\u8c03\u7528\u7ea6\u5b9a","title":"RISC-V \u6c47\u7f16\u4e0e\u8c03\u7528\u7ea6\u5b9a","text":"<p>\u540c\u5b66\u4eec\u4e0a\u6b21\u719f\u6089 RISC-V \u6c47\u7f16\u4e0e C \u8bed\u8a00\u7684\u5173\u7cfb\uff0c\u5e94\u8be5\u662f\u5728\u300a\u8ba1\u7b97\u673a\u7ec4\u6210\u300b\u8bfe\u7a0b\u4e2d\u3002\u4e0a\u300a\u8ba1\u7b97\u673a\u4f53\u7cfb\u7ed3\u6784\u300b\u7684\u65f6\u5019\uff0c\u540c\u5b66\u4eec\u53ea\u70e7\u4e8c\u8fdb\u5236 Bit \u6587\u4ef6\uff0c\u5e94\u8be5\u5df2\u7ecf\u628a\u76f8\u5173\u5185\u5bb9\u5fd8\u5f97\u5dee\u4e0d\u591a\u4e86\u3002\u672c\u8282\u6211\u4eec\u6765\u56de\u987e\u4e00\u4e0b\u3002</p>      \u300a\u8ba1\u7b97\u673a\u7ec4\u6210\u300b\u8bfe\u7a0b PPT      <p>Compiler Explorer \u53ef\u4ee5\u65b9\u4fbf\u5730\u63a2\u7d22\u4e0d\u540c\u7f16\u8bd1\u5668\u3001\u4e0d\u540c\u7248\u672c\u3001\u4e0d\u540c\u4f18\u5316\u9009\u9879\u4e0b\u7684\u6c47\u7f16\u4ee3\u7801\u3002\u6211\u4eec\u7528\u5b83\u6765\u770b\u770b\uff0cC \u4e0e RISC-V \u6c47\u7f16\u662f\u5982\u4f55\u5bf9\u5e94\u7684\uff1a</p> <p>\u4e0b\u9762\u662f\u4e00\u4e2a\u53ef\u4ee5\u4ea4\u4e92\u7684\u5b50\u9875\u9762\uff0c\u8bf7\u70b9\u51fb\u8fd9\u4e2a\u94fe\u63a5 \u653e\u5927\u67e5\u770b</p> <p>\u8bf7\u56de\u5fc6\u4f60\u5728\u300a\u8ba1\u7b97\u673a\u7ec4\u6210\u300b\u8bfe\u7a0b\u4e2d\u5b66\u4e60\u7684\u76f8\u5173\u5185\u5bb9\uff0c\u56de\u7b54\u4e0b\u9762\u7684\u95ee\u9898\u3002\u5982\u679c\u6709\u60f3\u4e0d\u8d77\u6765\u7684\u5730\u65b9\uff0c\u8bf7\u9605\u8bfb RISC-V ELF psABI Document \u7684\u4ee5\u4e0b\u7ae0\u8282\uff1a</p> <ul> <li>1.1. Integer Register Convention</li> <li>2.1. Integer Calling Convention</li> </ul> <p>\u8003\u70b9</p> <ul> <li>\u6bcf\u4e2a\u51fd\u6570\u7684\u5f00\u5934\u90fd\u64cd\u4f5c\u4e86 <code>sp</code>\uff0c\u8fd9\u662f\u5728\u5e72\u4ec0\u4e48\uff1f</li> <li>\u5c1d\u8bd5\u4fee\u6539 C \u8bed\u8a00\u4ee3\u7801\uff0c\u4f60\u4f1a\u53d1\u73b0 <code>sp</code> \u7684\u5dee\u503c\u603b\u662f 16 \u7684\u500d\u6570\uff0c\u8fd9\u662f\u4e3a\u4ec0\u4e48\uff1f</li> <li>\u8c03\u7528\u51fd\u6570\u524d\u540e\u505a\u4e86\u4ec0\u4e48\uff1f</li> </ul> \u8981\u70b9\uff1aRISC-V \u8c03\u7528\u7ea6\u5b9a <ul> <li> <p>\u53c2\u6570\u5bc4\u5b58\u5668\u4e0e\u8fd4\u56de\u503c</p> <ul> <li>RISC-V \u63d0\u4f9b 8 \u4e2a\u53c2\u6570\u5bc4\u5b58\u5668 a0\u2013a7\uff1a<ul> <li>a0\u3001a1\uff1a\u7528\u4e8e\u8fd4\u56de\u503c</li> <li>a2\u2013a7\uff1a\u7528\u4e8e\u4f20\u9012\u53c2\u6570\uff0c\u8d85\u51fa\u90e8\u5206\u653e\u5728\u6808\u4e0a</li> </ul> </li> <li>\u8d85\u8fc7\u5bc4\u5b58\u5668\u6570\u91cf\u7684\u53c2\u6570\u4f1a\u901a\u8fc7\u6808\u4f20\u9012</li> </ul> </li> <li> <p>\u53c2\u6570\u4f20\u9012\u89c4\u5219</p> <p>\u6807\u91cf\uff08Scalars\uff09</p> <ul> <li>\u2264 XLEN \u4f4d\uff1a\u653e\u5728\u4e00\u4e2a\u5bc4\u5b58\u5668\u6216\u6808\u4e0a\u4f20\u9012<ul> <li>\u5c0f\u4e8e XLEN \u7684\u6574\u6570\u4f1a\u7b26\u53f7\u6269\u5c55\uff08sign-extend\uff09\u5230 XLEN \u4f4d</li> <li>\u5c0f\u4e8e XLEN \u7684\u6d6e\u70b9\u6570\u4f1a\u96f6\u6269\u5c55\u5230 XLEN \u4f4d\uff0c\u9ad8\u4f4d\u4e0d\u5b9a\u4e49</li> </ul> </li> <li>2 \u00d7 XLEN \u4f4d\uff1a\u7528\u8fde\u7eed\u4e24\u4e2a\u5bc4\u5b58\u5668\u4f20\u9012\uff0c\u9ad8\u4f4d\u5728\u7f16\u53f7\u5927\u7684\u5bc4\u5b58\u5668\u4e2d</li> <li>&gt; 2 \u00d7 XLEN \u4f4d\uff1a\u901a\u8fc7\u5f15\u7528\uff08\u5730\u5740\uff09\u4f20\u9012</li> </ul> <p>\u7ed3\u6784\u4f53\u548c\u8054\u5408\u4f53\uff08Aggregates\uff09</p> <ul> <li>\u2264 XLEN \u4f4d\uff1a\u5355\u5bc4\u5b58\u5668\u4f20\u9012</li> <li>\u2264 2 \u00d7 XLEN \u4f4d\uff1a\u53cc\u5bc4\u5b58\u5668\u4f20\u9012\uff0c\u82e5\u5bc4\u5b58\u5668\u4e0d\u8db3\uff0c\u5269\u4f59\u90e8\u5206\u653e\u6808\u4e0a</li> <li>&gt; 2 \u00d7 XLEN \u4f4d\uff1a\u6309\u5f15\u7528\u4f20\u9012\uff08\u4f20\u5730\u5740\uff09</li> </ul> </li> <li> <p>\u6808\u5bf9\u9f50\u548c\u6808\u4f20\u53c2</p> <ul> <li>\u6808\u6307\u9488\uff08SP\uff09\u5fc5\u987b\u5728\u51fd\u6570\u5165\u53e3\u65f6 128-bit \u5bf9\u9f50</li> <li>\u53c2\u6570\u5728\u6808\u4e0a\u7684\u5e03\u5c40\u6309 \u2265 type alignment \u548c XLEN \u5bf9\u9f50\uff0c\u4f46\u4e0d\u4f1a\u8d85\u8fc7\u6808\u672c\u8eab\u7684\u5bf9\u9f50\u8981\u6c42</li> <li>\u4f20\u6808\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\u5728 SP + 0 \u4f4d\u7f6e\uff0c\u4e4b\u540e\u4f9d\u6b21\u9012\u589e</li> </ul> </li> <li> <p>\u53d8\u53c2\u51fd\u6570\uff08Variadic Functions\uff09</p> <ul> <li>\u53d8\u53c2\u4e0e\u547d\u540d\u53c2\u6570\u4f20\u9012\u65b9\u5f0f\u76f8\u540c</li> <li>\u7279\u6b8a\u89c4\u5219\uff1a<ul> <li>2 \u00d7 XLEN \u4f4d\u5bf9\u9f50\u7684\u53c2\u6570\u5fc5\u987b\u4f7f\u7528\u5076\u6570\u53f7\u5bc4\u5b58\u5668\u5bf9</li> <li>\u4e00\u65e6\u6709\u53c2\u6570\u88ab\u4f20\u5230\u6808\u4e0a\uff0c\u4e4b\u540e\u7684\u53c2\u6570\u90fd\u5fc5\u987b\u653e\u6808\u4e0a</li> </ul> </li> </ul> </li> <li> <p>\u8fd4\u56de\u503c</p> <ul> <li>\u8fd4\u56de\u503c\u7684\u4f20\u9012\u65b9\u5f0f = \u8be5\u7c7b\u578b\u7b2c\u4e00\u4e2a\u547d\u540d\u53c2\u6570\u7684\u4f20\u9012\u65b9\u5f0f</li> <li>\u5982\u679c\u662f\u6309\u5f15\u7528\u4f20\u9012\u7684\uff0c\u8c03\u7528\u8005\u5206\u914d\u7a7a\u95f4\uff0c\u4f20\u5730\u5740\uff0ccallee \u5199\u7ed3\u679c</li> </ul> </li> <li> <p>\u7ed3\u6784\u4f53\u5bf9\u9f50\u4e0e\u4f4d\u57df\u89c4\u5219</p> <ul> <li>\u5c0f\u4e8e\u4e00\u4e2a XLEN \u7684\u7ed3\u6784\u4f53\u76f4\u63a5\u653e\u5728\u5bc4\u5b58\u5668\u91cc\uff0c\u6309\u5185\u5b58\u5e03\u5c40\u6392\u5217\u5b57\u6bb5</li> <li>\u4f4d\u57df\u6309\u5c0f\u7aef\u5e8f\uff08little-endian\uff09\u6253\u5305\uff1a<ul> <li>\u5982\u679c\u8de8\u8d8a\u5bf9\u9f50\u8fb9\u754c\uff0c\u8df3\u5230\u4e0b\u4e00\u4e2a\u5bf9\u9f50\u8fb9\u754c</li> <li>\u591a\u4f59\u4f4d\u6309 padding \u5904\u7406</li> </ul> </li> </ul> </li> <li> <p>\u5bc4\u5b58\u5668\u4fdd\u5b58\u89c4\u5219</p> <ul> <li>s0\u2013s11 \u5fc5\u987b\u5728\u51fd\u6570\u8c03\u7528\u95f4\u4fdd\u6301\uff08callee-save\uff09</li> <li>\u4e34\u65f6\u5bc4\u5b58\u5668 t0\u2013t6\u3001a0\u2013a7 \u8c03\u7528\u4e0d\u4fdd\u8bc1\u4fdd\u5b58\uff08caller-save\uff09</li> </ul> </li> </ul> <p>\u6b64\u5916\uff0c\u9664\u4e86\u57fa\u672c\u7684 I \u6307\u4ee4\u96c6\uff0c\u6211\u4eec\u5728\u6c47\u7f16\u65f6\u8fd8\u7ecf\u5e38\u4f7f\u7528\u4e00\u4e9b\u4f2a\u6307\u4ee4\uff08pseudo-instruction\uff09\u3002\u5b83\u4eec\u5e76\u4e0d\u662f RISC-V ISA \u4e2d\u771f\u5b9e\u7684\u6307\u4ee4\uff0c\u800c\u662f\u6c47\u7f16\u8bed\u8a00\u7684\u8bed\u6cd5\u7cd6\u3002\u4f2a\u6307\u4ee4\u4f1a\u88ab\u6c47\u7f16\u5668\u7ffb\u8bd1\u6210\u4e00\u4e2a\u6216\u591a\u4e2a\u771f\u5b9e\u7684\u6307\u4ee4\u3002</p> <p>\u8bf7\u9605\u8bfb RISC-V \u6c47\u7f16\u624b\u518c \u7684\u4ee5\u4e0b\u7ae0\u8282\uff0c\u5b66\u4e60\u5e38\u7528\u7684\u4f2a\u6307\u4ee4\uff1a</p> <ul> <li>Chapter 29. A listing of standard RISC-V pseudoinstructions</li> </ul> <p>\u8003\u70b9</p> <ul> <li> <p>\u4e0b\u5217\u4f2a\u6307\u4ee4\u5206\u522b\u5bf9\u5e94\u4ec0\u4e48\u771f\u5b9e\u6307\u4ee4\uff1f</p> <pre><code>la nop li mv j ret call tail\n</code></pre> </li> <li> <p><code>call</code> \u4f2a\u6307\u4ee4\u505a\u4e86\u4ec0\u4e48\u5de5\u4f5c\uff1f\u5b83\u4e0e <code>tail</code> \u6307\u4ee4\u6709\u4ec0\u4e48\u533a\u522b\uff1f</p> </li> </ul>"},{"location":"lab1/#\u6c47\u7f16\u5668\u6307\u4ee4","title":"\u6c47\u7f16\u5668\u6307\u4ee4","text":"<p>\u4f60\u5df2\u7ecf\u719f\u6089 RISC-V \u6c47\u7f16\u6307\u4ee4\u3002\u4f46\u662f\u4e3a\u4e86\u5199\u6c47\u7f16\u4ee3\u7801\uff0c\u8fd8\u8981\u4e86\u89e3\u4e00\u4e9b\u6c47\u7f16\u5668\u6307\u4ee4\uff08assembler directive\uff09\uff0c\u8fd9\u5c31\u50cf C \u8bed\u8a00\u4e2d\u7684\u9884\u5904\u7406\u6307\u4ee4\u4e00\u6837\u3002</p> <p>\u9605\u8bfb <code>arch/riscv/head.S</code>\uff0c\u5c1d\u8bd5\u7406\u89e3\u5b83\u7684\u5185\u5bb9\u3002\u5982\u679c\u6709\u4e0d\u61c2\u7684\u5730\u65b9\uff0c\u53ef\u4ee5\u67e5\u9605 <code>as</code> \u6c47\u7f16\u5668\u624b\u518c\u7684\u4e0b\u5217\u7ae0\u8282\uff1a</p> <ul> <li>5 Symbols\uff1a\u9605\u8bfb 5.1-5.4 \u5373\u53ef</li> <li>7.3 .align [abs-expr[, abs-expr[, abs-expr]]]</li> <li>7.43 .global symbol, .globl symbol</li> <li>7.87 .section name - ELF Version</li> <li>7.65 .macro</li> <li>7.94 .space size [,fill]</li> </ul> \u8981\u70b9\uff1a\u6c47\u7f16\u5668\u6307\u4ee4 <ul> <li> <p>Symbols \u57fa\u7840\u6982\u5ff5</p> <ul> <li>\u7a0b\u5e8f\u5458\u7528\u7b26\u53f7\u547d\u540d\uff1b\u94fe\u63a5\u5668\u7528\u7b26\u53f7\u505a\u94fe\u63a5\uff1b\u8c03\u8bd5\u5668\u7528\u7b26\u53f7\u8c03\u8bd5\u3002</li> <li>\u7b26\u53f7\u7528\u4e8e\u547d\u540d\u7a0b\u5e8f\u4e2d\u7684\u5730\u5740\u6216\u6570\u636e\u4f4d\u7f6e\u3002</li> <li>\u53ef\u4ee5\u4ee3\u8868\u4f4d\u7f6e\u8ba1\u6570\u5668\u3001\u5e38\u91cf\u503c\u6216\u7a0b\u5e8f\u4e2d\u5b9a\u4e49\u7684\u6807\u7b7e\u3002</li> <li>\u652f\u6301\u591a\u79cd\u7c7b\u578b\uff1a\u5168\u5c40\u7b26\u53f7\u3001\u672c\u5730\u7b26\u53f7\u3001\u5c40\u90e8\u6807\u7b7e\uff08Label\uff09\u7b49\u3002</li> </ul> </li> <li> <p>Labels</p> <ul> <li> <p>\u6807\u7b7e\u7684\u5b9a\u4e49</p> <ul> <li><code>symbol:</code> \u5b9a\u4e49\u6807\u7b7e\uff0c\u8868\u793a\u5f53\u524d\u4f4d\u7f6e\u8ba1\u6570\u5668\u7684\u503c\u3002</li> <li>\u76f8\u540c\u7b26\u53f7\u591a\u6b21\u5b9a\u4e49\u65f6\uff0c\u4ee5\u7b2c\u4e00\u6b21\u4e3a\u51c6\uff0c\u540e\u7eed\u4f1a\u6536\u5230\u8b66\u544a\u3002</li> </ul> </li> <li> <p>\u672c\u5730\u6807\u7b7e\uff08Local Labels\uff09</p> <ul> <li>\u5f62\u5f0f\uff1a<code>N:</code> \u5b9a\u4e49\u6807\u7b7e\uff0c<code>Nb</code> \u5f15\u7528\u6700\u8fd1\u7684\u524d\u4e00\u4e2a\uff0c<code>Nf</code> \u5f15\u7528\u6700\u8fd1\u7684\u4e0b\u4e00\u4e2a\u3002</li> <li>\u7f16\u8bd1\u5668\u4f1a\u5c06\u672c\u5730\u6807\u7b7e\u8f6c\u6362\u6210\u552f\u4e00\u7684\u7b26\u53f7\u540d\uff0c\u907f\u514d\u51b2\u7a81\u3002</li> </ul> </li> <li> <p>\u7f8e\u5143\u6807\u7b7e\uff08Dollar Labels\uff09</p> <ul> <li>\u5f62\u5f0f\u5982 <code>55$:</code>\uff0c\u4f5c\u7528\u8303\u56f4\u66f4\u5c0f\uff0c\u9047\u5230\u975e\u672c\u5730\u6807\u7b7e\u5c31\u5931\u6548\u3002</li> </ul> </li> </ul> </li> <li> <p>\u7b26\u53f7\u8d4b\u503c</p> <ul> <li>\u5f62\u5f0f\uff1a<code>symbol = expression</code> \u7b49\u4ef7\u4e8e <code>.set</code>\uff0c<code>symbol == expression</code> \u7b49\u4ef7\u4e8e <code>.eqv</code>\u3002</li> <li>\u53ef\u4ee5\u628a\u7b26\u53f7\u8d4b\u503c\u4e3a\u4efb\u610f\u8868\u8fbe\u5f0f\u7ed3\u679c\u3002</li> </ul> </li> <li> <p>\u7b26\u53f7\u547d\u540d\u89c4\u5219</p> <ul> <li>\u4ee5\u5b57\u6bcd\u6216 <code>._</code> \u5f00\u5934\uff0c\u652f\u6301 <code>$</code>\uff0c\u5927\u5c0f\u5199\u654f\u611f\u3002</li> <li>\u4e0d\u4ee5\u6570\u5b57\u5f00\u5934\uff0c\u9664\u975e\u662f\u672c\u5730\u6807\u7b7e\u3002</li> <li>\u652f\u6301\u591a\u5b57\u8282\u5b57\u7b26\uff0c\u4f46\u53ef\u80fd\u53d7\u7f16\u8bd1\u5668\u6216\u7cfb\u7edf\u9650\u5236\u3002</li> </ul> </li> <li> <p><code>.</code> \u7b26\u53f7</p> <ul> <li>\u8868\u793a\u5f53\u524d\u4f4d\u7f6e\u8ba1\u6570\u5668\u3002</li> <li><code>melvin: .long .</code> \u2192 \u5b9a\u4e49 <code>melvin</code> \u4e3a\u5176\u81ea\u8eab\u5730\u5740\u3002</li> <li>\u8d4b\u503c <code>.=.+4</code> \u7b49\u4ef7\u4e8e <code>.org</code> \u6307\u4ee4\uff0c\u8df3\u8fc7 4 \u5b57\u8282\u3002</li> </ul> </li> <li> <p>\u5e38\u89c1\u6c47\u7f16\u5668\u6307\u4ee4</p> <ul> <li><code>.align n</code>\uff1a\u5c06\u4f4d\u7f6e\u8ba1\u6570\u5668\u5bf9\u9f50\u5230 n \u5b57\u8282\u8fb9\u754c\u3002</li> <li><code>.global symbol</code> / <code>.globl symbol</code>\uff1a\u5bfc\u51fa\u7b26\u53f7\u7ed9\u94fe\u63a5\u5668 <code>ld</code> \u4f7f\u7528\u3002</li> <li><code>.section name</code>\uff1a\u5207\u6362\u5230\u6307\u5b9a\u8282\uff0c\u652f\u6301 ELF \u7279\u5b9a\u53c2\u6570\u3002</li> <li><code>.macro</code> / <code>.endm</code>\uff1a\u5b8f\u5b9a\u4e49\uff0c\u53ef\u751f\u6210\u91cd\u590d\u4ee3\u7801\u3002</li> <li><code>.space size[,fill]</code>\uff1a\u5206\u914d size \u5b57\u8282\u7a7a\u95f4\uff0c\u586b\u5145\u503c\u4e3a fill\uff08\u9ed8\u8ba4\u4e3a 0\uff09\u3002</li> </ul> </li> </ul>"},{"location":"lab1/#\u94fe\u63a5\u5668\u811a\u672c\u4e0e\u5185\u6838\u5185\u5b58\u5e03\u5c40","title":"\u94fe\u63a5\u5668\u811a\u672c\u4e0e\u5185\u6838\u5185\u5b58\u5e03\u5c40","text":"<p>\u5728 C \u8bed\u8a00\u7f16\u7a0b\u8bfe\u4e0a\uff0c\u6211\u4eec\u4e86\u89e3\u8fc7\u7f16\u8bd1\u5668\u7684\u57fa\u672c\u6d41\u7a0b\uff1a\u9884\u5904\u7406\u3001\u7f16\u8bd1\u3001\u6c47\u7f16\u3001\u94fe\u63a5\uff0c<code>gcc</code> \u9ed8\u8ba4\u5e2e\u4f60\u5b8c\u6210\u4e86\u6240\u6709\u6d41\u7a0b\u3002\u5047\u8bbe\u7a0b\u5e8f\u7531\u4e24\u4e2a\u6e90\u6587\u4ef6 <code>main.c</code> \u548c <code>func.c</code> \u7ec4\u6210\uff0c\u62c6\u5206\u540e\u7684\u6d41\u7a0b\u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>riscv64-linux-gnu-cpp main.c -o main.i\nriscv64-linux-gnu-gcc -S main.i -o main.S\nriscv64-linux-gnu-as main.S -o main.o\nriscv64-linux-gnu-cpp func.c -o func.i\nriscv64-linux-gnu-gcc -S func.i -o func.S\nriscv64-linux-gnu-as func.S -o func.o\nriscv64-linux-gnu-ld main.o func.o -o main\n</code></pre> <p>\u94fe\u63a5\u8fc7\u7a0b\u5408\u5e76\u591a\u4e2a\u76ee\u6807\u6587\u4ef6\uff0c\u5e76\u91cd\u5b9a\u4f4d\u5b83\u4eec\u7684\u6570\u636e\uff0c\u94fe\u63a5\u5404\u7c7b\u7b26\u53f7\uff08\u51fd\u6570\u540d\u3001\u53d8\u91cf\u540d\u7b49\uff09\u3002\u94fe\u63a5\u5668 <code>ld</code> \u901a\u8fc7\u94fe\u63a5\u811a\u672c\u6765\u63a7\u5236\u6700\u7ec8\u7684\u751f\u6210\u7684\u6587\u4ef6\uff0c\u9ed8\u8ba4\u4f7f\u7528\u5185\u7f6e\u7684\u811a\u672c\u751f\u6210 ELF \u683c\u5f0f\u7684\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u67e5\u770b\u8fd9\u4e2a\u811a\u672c\uff1a</p> <pre><code>riscv64-linux-gnu-ld --verbose\n</code></pre> <p>\u8bf7\u9605\u8bfb 3 Linker Scripts - LD \u7684\u4ee5\u4e0b\u7ae0\u8282\uff0c\u5b66\u4e60\u57fa\u672c\u7684\u94fe\u63a5\u5668\u811a\u672c\u8bed\u6cd5\uff1a</p> <ul> <li>3.1 Basic Linker Script Concepts</li> <li>3.3 Simple Linker Script Example</li> <li>3.5 Assigning Values to Symbols</li> <li>3.6.1 Output Section Description</li> </ul> \u8981\u70b9\uff1a\u94fe\u63a5\u5668\u811a\u672c <p>\u4e0b\u9762\u7684\u8981\u70b9\u4e2d\uff0c\u6e90\u7801\u4e2d\u7684\u7b26\u53f7\u5f15\u7528\u975e\u5e38\u91cd\u8981\uff0c\u5728\u540e\u7eed\u5199 C \u4ee3\u7801\u65f6\u4f1a\u7528\u5230\u3002</p> <ul> <li> <p>Linker Script \u57fa\u7840\u6982\u5ff5</p> <ol> <li> <p>\u76ee\u6807\u6587\u4ef6\uff08Object File\uff09</p> <ul> <li>GCC \u6216\u5176\u4ed6\u7f16\u8bd1\u5668\u751f\u6210\u7684 <code>.o</code> \u6587\u4ef6\u3002</li> <li>\u6bcf\u4e2a\u76ee\u6807\u6587\u4ef6\u5305\u542b\u82e5\u5e72 \u8f93\u5165\u8282\uff08Input Section\uff09\uff0c\u4f8b\u5982 <code>.text</code>, <code>.data</code>, <code>.bss</code>\u3002</li> <li>\u6bcf\u8282\u6709\u540d\u5b57\u3001\u5927\u5c0f\u548c\u6570\u636e\u5185\u5bb9\u3002</li> </ul> </li> <li> <p>\u8f93\u51fa\u6587\u4ef6\uff08Output File\uff09</p> <ul> <li>\u94fe\u63a5\u5668\u5c06\u591a\u4e2a\u8f93\u5165\u6587\u4ef6\u5408\u5e76\u751f\u6210\u5355\u4e00\u8f93\u51fa\u6587\u4ef6\u3002</li> <li>\u8f93\u51fa\u6587\u4ef6\u4e5f\u6709\u82e5\u5e72 \u8f93\u51fa\u8282\uff08Output Section\uff09\u3002</li> <li>\u8f93\u51fa\u8282\u662f\u7531\u8f93\u5165\u8282\u7ec4\u6210\u7684\uff0c\u5b83\u4eec\u53ef\u4ee5\u88ab\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d\u6216\u53ea\u5206\u914d\u7a7a\u95f4\u3002</li> </ul> </li> <li> <p>\u8282\u7684\u5c5e\u6027</p> <ul> <li>Loadable\uff08\u53ef\u52a0\u8f7d\uff09\uff1a\u8282\u5185\u5bb9\u9700\u8981\u52a0\u8f7d\u5230\u5185\u5b58\uff0c\u4f8b\u5982\u4ee3\u7801\u548c\u521d\u59cb\u5316\u6570\u636e\u3002</li> <li>Allocatable\uff08\u53ef\u5206\u914d\uff09\uff1a\u8282\u4e0d\u5305\u542b\u6570\u636e\uff0c\u4f46\u9700\u8981\u5728\u5185\u5b58\u4e2d\u4fdd\u7559\u7a7a\u95f4\uff0c\u4f8b\u5982 <code>.bss</code>\u3002</li> <li>\u975e\u52a0\u8f7d\u975e\u5206\u914d\uff1a\u8282\u901a\u5e38\u7528\u4e8e\u8c03\u8bd5\u4fe1\u606f\uff0c\u4f8b\u5982 <code>.debug_*</code>\u3002</li> </ul> </li> <li> <p>\u7b26\u53f7\uff08Symbol\uff09</p> <ul> <li>\u6bcf\u4e2a\u76ee\u6807\u6587\u4ef6\u4e2d\u5b9a\u4e49\u6216\u5f15\u7528\u7684\u51fd\u6570\u3001\u5168\u5c40\u53d8\u91cf\u90fd\u662f\u7b26\u53f7\u3002</li> <li>\u94fe\u63a5\u5668\u4f1a\u89e3\u6790\u7b26\u53f7\u7684\u5730\u5740\uff0c\u672a\u5b9a\u4e49\u7b26\u53f7\u9700\u8981\u5728\u94fe\u63a5\u65f6\u627e\u5230\u5b9a\u4e49\u3002</li> </ul> </li> <li> <p>VMA \u548c LMA</p> <ul> <li>VMA\uff08Virtual Memory Address\uff09\uff1a\u7a0b\u5e8f\u8fd0\u884c\u65f6\u7684\u865a\u62df\u5730\u5740\u3002</li> <li>LMA\uff08Load Memory Address\uff09\uff1a\u7a0b\u5e8f\u52a0\u8f7d\u5230\u5185\u5b58\u65f6\u7684\u5730\u5740\u3002</li> <li>\u4f8b\u5982\uff0cROM \u52a0\u8f7d\u5230 RAM \u65f6 LMA \u2260 VMA\u3002</li> </ul> </li> <li> <p>\u4f4d\u7f6e\u8ba1\u6570\u5668 <code>.</code></p> <ul> <li>\u94fe\u63a5\u5668\u4f7f\u7528 <code>.</code> \u6765\u8868\u793a\u5f53\u524d\u5185\u5b58\u4f4d\u7f6e\u3002</li> <li>\u6bcf\u5b9a\u4e49\u4e00\u4e2a\u8f93\u51fa\u8282\uff0c<code>.</code> \u4f1a\u81ea\u52a8\u589e\u52a0\u8282\u5927\u5c0f\u3002</li> </ul> </li> </ol> </li> <li> <p>Linker Script \u6587\u4ef6\u683c\u5f0f</p> <ul> <li>LD Script \u662f\u6587\u672c\u6587\u4ef6\u3002</li> <li> <p>\u652f\u6301 \u6ce8\u91ca\uff1a</p> <pre><code>/* \u8fd9\u662f\u6ce8\u91ca */\n</code></pre> </li> <li> <p>\u8bed\u6cd5\u7ed3\u6784\uff1a</p> <ul> <li>\u5173\u952e\u5b57 + \u53c2\u6570\uff0c\u4f8b\u5982 <code>OUTPUT_ARCH(\"riscv\")</code></li> <li>\u7b26\u53f7\u8d4b\u503c\uff0c\u4f8b\u5982 <code>BASE_ADDR = 0x80000000</code></li> <li>\u4f7f\u7528 <code>SECTIONS</code> \u5b9a\u4e49\u8f93\u51fa\u8282\u5e03\u5c40\u3002</li> </ul> </li> </ul> </li> <li> <p>SECTIONS \u6307\u4ee4</p> <p><code>SECTIONS</code> \u662f\u6700\u6838\u5fc3\u7684\u547d\u4ee4\uff0c\u7528\u4e8e\u63cf\u8ff0\u8f93\u51fa\u6587\u4ef6\u7684\u5185\u5b58\u5e03\u5c40\u3002\u793a\u4f8b\uff1a</p> <pre><code>SECTIONS\n{\n    . = 0x10000;        /* \u8bbe\u7f6e\u4f4d\u7f6e\u8ba1\u6570\u5668 */\n    .text : { *(.text) } /* \u5c06\u6240\u6709\u8f93\u5165\u6587\u4ef6\u7684 .text \u8282\u653e\u5165\u8f93\u51fa\u8282 .text */\n    . = 0x8000000;\n    .data : { *(.data) }\n    .bss : { *(.bss) }\n}\n</code></pre> <p>\u89e3\u91ca\uff1a</p> <ul> <li><code>. = 0x10000</code>\uff1a\u5c06\u4f4d\u7f6e\u8ba1\u6570\u5668\u8bbe\u7f6e\u4e3a 0x10000\u3002</li> <li><code>.text : { *(.text) }</code>\uff1a\u8f93\u51fa\u8282 <code>.text</code> \u5305\u542b\u6240\u6709\u8f93\u5165\u8282 <code>.text</code>\u3002</li> <li><code>.data</code> \u548c <code>.bss</code> \u540c\u7406\u3002</li> <li>\u94fe\u63a5\u5668\u4f1a\u4fdd\u8bc1\u8f93\u51fa\u8282\u6309\u9700\u5bf9\u9f50\uff0c\u5982\u679c\u5730\u5740\u4e0d\u7b26\u5408\u8981\u6c42\uff0c\u4f1a\u5728\u8282\u4e4b\u95f4\u63d2\u5165\u95f4\u9699\u3002</li> </ul> </li> <li> <p>\u7b26\u53f7\u8d4b\u503c</p> <ul> <li> <p>\u7b26\u53f7\u8d4b\u503c\u7684\u57fa\u672c\u6982\u5ff5</p> <ul> <li>\u5728\u94fe\u63a5\u811a\u672c\uff08linker script\uff09\u4e2d\u53ef\u4ee5\u7ed9\u7b26\u53f7\uff08symbol\uff09\u8d4b\u503c\uff0c\u5b9a\u4e49\u5b83\u5e76\u628a\u5b83\u52a0\u5165\u7b26\u53f7\u8868\uff0c\u4f5c\u7528\u57df\u4e3a\u5168\u5c40\u3002</li> <li> <p>\u8d4b\u503c\u8bed\u53e5\u5f62\u5f0f\uff1a</p> <pre><code>symbol = expression;      // \u5b9a\u4e49\u7b26\u53f7\u503c\nsymbol += expression;     // \u5728\u539f\u503c\u57fa\u7840\u4e0a\u52a0\nsymbol -= expression;     // \u5728\u539f\u503c\u57fa\u7840\u4e0a\u51cf\n...\nsymbol |= expression;     // \u6309\u4f4d\u6216\n</code></pre> </li> <li> <p>\u7b2c\u4e00\u6b21\u8d4b\u503c\u4f1a\u5b9a\u4e49\u7b26\u53f7\uff0c\u540e\u7eed\u7684 +=, -= \u7b49\u64cd\u4f5c\u8981\u6c42\u7b26\u53f7\u5df2\u5b58\u5728\u3002</p> </li> <li><code>.</code> \u8868\u793a\u4f4d\u7f6e\u8ba1\u6570\u5668\uff08location counter\uff09\uff0c\u53ea\u80fd\u5728 <code>SECTIONS</code> \u4e2d\u4f7f\u7528\u3002</li> </ul> </li> <li> <p>\u4e09\u79cd\u8d4b\u503c\u4f4d\u7f6e</p> <p>\u7b26\u53f7\u8d4b\u503c\u53ef\u4ee5\u51fa\u73b0\u5728\uff1a</p> <ol> <li>\u5355\u72ec\u4f5c\u4e3a\u547d\u4ee4</li> <li><code>SECTIONS</code> \u547d\u4ee4\u5185\u90e8</li> <li>\u8f93\u51fa\u6bb5\uff08output section\uff09\u63cf\u8ff0\u5185\u90e8</li> </ol> <p>\u793a\u4f8b\uff1a</p> <pre><code>floating_point = 0;\nSECTIONS\n{\n  .text :\n    {\n      *(.text)\n      _etext = .;\n    }\n  _bdata = (. + 3) &amp; ~ 3;\n  .data : { *(.data) }\n}\n</code></pre> <ul> <li><code>floating_point = 0</code> \u2192 \u5b9a\u4e49\u4e3a 0</li> <li><code>_etext = .</code> \u2192 \u5b9a\u4e49\u4e3a <code>.text</code> \u672b\u5c3e\u5730\u5740</li> <li><code>_bdata = (. + 3) &amp; ~3</code> \u2192 \u5b9a\u4e49\u4e3a 4 \u5b57\u8282\u5bf9\u9f50\u7684 <code>.text</code> \u672b\u5c3e\u5730\u5740</li> </ul> </li> <li> <p>PROVIDE</p> <ul> <li><code>PROVIDE(symbol = expression)</code></li> <li>\u4ec5\u5728\u7b26\u53f7\u88ab\u5f15\u7528\u4e14\u672a\u88ab\u5b9a\u4e49\u65f6\u624d\u5b9a\u4e49\uff0c\u907f\u514d\u4e0e\u7528\u6237\u4ee3\u7801\u51b2\u7a81\u3002</li> <li>\u5e38\u7528\u4e8e\u4f20\u7edf\u7b26\u53f7\u5982 <code>etext</code>\uff0c\u7528\u6237\u53ef\u8986\u76d6\u5b9a\u4e49\u3002</li> </ul> <p>\u793a\u4f8b\uff1a</p> <pre><code>SECTIONS {\n  .text : {\n    PROVIDE(etext = .);\n  }\n}\n</code></pre> </li> <li> <p>\u6e90\u7801\u4e2d\u7684\u7b26\u53f7\u5f15\u7528</p> <ul> <li>\u94fe\u63a5\u811a\u672c\u7b26\u53f7 \u2260 C \u8bed\u8a00\u53d8\u91cf\uff0c\u6ca1\u6709\u5b9e\u9645\u5185\u5b58\u5206\u914d\uff0c\u53ea\u662f\u4e00\u4e2a\u5730\u5740\u3002</li> <li> <p>\u5728\u6c47\u7f16\u4ee3\u7801\u4e2d\u76f4\u63a5\u4f5c\u4e3a\u5730\u5740\u4f7f\u7528\uff1a</p> <pre><code>la a0, symbol_name  # \u52a0\u8f7d\u7b26\u53f7\u5730\u5740\u5230 a0\n</code></pre> </li> <li> <p>\u5728 C \u4ee3\u7801\u4e2d\u4f7f\u7528\u65f6\uff1a</p> <pre><code>extern char start_of_ROM, end_of_ROM, start_of_FLASH;\nmemcpy(&amp;start_of_FLASH, &amp;start_of_ROM, &amp;end_of_ROM - &amp;start_of_ROM);\n</code></pre> </li> <li> <p>\u4e5f\u53ef\u4ee5\u76f4\u63a5\u58f0\u660e\u4e3a\u6570\u7ec4\uff1a</p> <pre><code>extern char start_of_ROM[], end_of_ROM[], start_of_FLASH[];\nmemcpy(start_of_FLASH, start_of_ROM, end_of_ROM - start_of_ROM);\n</code></pre> </li> <li> <p>\u5fc5\u987b\u53d6\u5730\u5740\uff0c\u4e0d\u80fd\u76f4\u63a5\u5f53\u4f5c\u6570\u503c\u4f7f\u7528\u3002</p> </li> </ul> </li> </ul> </li> </ul> <p>\u73b0\u5728\uff0c\u6211\u4eec\u6765\u7b80\u5355\u5bf9\u6bd4\u4e00\u4e0b Linux \u5185\u6838\u548c <code>ld</code> \u5185\u7f6e\uff08\u666e\u901a\u5e94\u7528\u7a0b\u5e8f\uff09\u7684\u94fe\u63a5\u811a\u672c\u7684\u533a\u522b\uff1a</p> linux/arch/riscv/kernel/vmlinux.lds<pre><code>ENTRY(_start)\nSECTIONS\n{\n . = ((((-1))) - 0x80000000 + 1);\n _start = .;\n . = ALIGN((1 &lt;&lt; 12));\n . = ALIGN((1 &lt;&lt; 21));\n . = ALIGN(4);\n</code></pre> riscv64-linux-gnu-ld --verbose<pre><code>ENTRY(_start)\nSECTIONS\n{\n  . = SEGMENT_START(\"text-segment\", 0x10000) + SIZEOF_HEADERS;\n  .dynsym         : { *(.dynsym) }\n  .rela.dyn       :\n    {\n      *(.rela.init)\n      *(.rela.text .rela.text.* .rela.gnu.linkonce.t.*)\n</code></pre> <ul> <li>\u8d77\u59cb\u4f4d\u7f6e\uff1a\u5e94\u7528\u7a0b\u5e8f\u4e3a <code>0x10000 + SIZEOF_HEADERS</code>\uff0c\u800c\u5185\u6838\u662f <code>0xffffffff80000000</code>\u3002\u5b66\u4e60\u865a\u62df\u5185\u5b58\u540e\u4f60\u4f1a\u7406\u89e3\u8fd9\u4e9b\u5730\u5740\u53d7\u64cd\u4f5c\u7cfb\u7edf\u5185\u5b58\u5e03\u5c40\u5f71\u54cd\u3002</li> <li>\u5bf9\u9f50\uff1a\u5185\u6838\u5bf9\u9f50\u8981\u6c42\u5341\u5206\u4e25\u683c\uff0c\u901a\u5e38\u4f7f\u7528\u9875\u9762\u5bf9\u9f50\uff084KB \u6216 2MB \u7b49\uff09\u3001\u7f13\u5b58\u884c\u5bf9\u9f50\uff0864B\uff09\u7b49\uff0c\u9700\u8981\u8003\u8651\u5185\u5b58\u5206\u9875\u3001NUMA \u67b6\u6784 Cache \u4e00\u81f4\u6027\u7b49\u95ee\u9898\uff08\u56de\u5fc6\u4f60\u5728\u300a\u8ba1\u7b97\u673a\u4f53\u7cfb\u7ed3\u6784\u300b\u8bfe\u7a0b\u4e2d\u5b66\u4e60\u7684\u76f8\u5173\u77e5\u8bc6\uff09\u3002</li> <li>\u8282\u7684\u9009\u62e9\uff1a\u5185\u6838\u4e0d\u4f7f\u7528\u52a8\u6001\u94fe\u63a5\u3001\u91cd\u5b9a\u4f4d\uff0c\u8fd9\u4e9b\u6280\u672f\u662f\u4e3a\u4e86\u5e94\u7528\u7a0b\u5e8f\u8bbe\u8ba1\u7684\u3002\u56e0\u6b64\u6ca1\u6709 <code>.dynsym</code>\u3001<code>.rela.dyn</code> \u7b49\u8282\u3002</li> <li> <p><code>_start</code> \u7b26\u53f7\uff1a\u4e24\u8005\u90fd\u5b9a\u4e49\u4e86 <code>_start</code> \u4f5c\u4e3a\u7a0b\u5e8f\u5165\u53e3\uff0c\u4f46\u5185\u6838\u7684 <code>_start</code> \u5b9a\u4e49\u5728\u811a\u672c\u4e2d\uff0c\u800c\u5e94\u7528\u7a0b\u5e8f\u7684 <code>_start</code> \u7531\u6807\u51c6\u5e93\u5b9a\u4e49\uff08\u6807\u51c6\u5e93\u9700\u8981\u505a\u4e00\u4e9b\u521d\u59cb\u5316\u5de5\u4f5c\uff09\uff0c\u5e76\u4e0d\u5728\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\u4e2d\u3002</p> <p>\u4f60\u53ef\u4ee5\u5c1d\u8bd5\u7f16\u8bd1\u4e00\u4e2a\u7b80\u5355\u7684\u7a0b\u5e8f\u800c\u4e0d\u5e26\u4e0a\u6807\u51c6\u5e93\uff0c<code>ld</code> \u5c31\u4f1a\u627e\u4e0d\u5230 <code>_start</code> \u7b26\u53f7\uff1a</p> <pre><code>$ riscv64-linux-gnu-gcc -nostdlib test.c\n/usr/lib/gcc-cross/riscv64-linux-gnu/15/../../../../riscv64-linux-gnu/bin/ld: warning: cannot find entry symbol _start; defaulting to 000000000000030a\n</code></pre> </li> </ul> <p>\u8981\u70b9\uff1a\u5185\u6838\u94fe\u63a5\u811a\u672c</p> <p><code>vmlinux</code> \u4e0e\u666e\u901a\u5e94\u7528\u7a0b\u5e8f\u7684\u5f02\u540c\uff1a</p> <ul> <li>\u76f8\u540c\u70b9\uff1a\u90fd\u662f ELF \u683c\u5f0f\u7684\u53ef\u6267\u884c\u6587\u4ef6\u3002</li> <li>\u4e0d\u540c\u70b9\uff1a\u4e0e\u666e\u901a\u7684\u5e94\u7528\u7a0b\u5e8f\u76f8\u6bd4\uff0c\u64cd\u4f5c\u7cfb\u7edf\u7684\u94fe\u63a5\u9700\u8981\u7cbe\u7ec6\u63a7\u5236\u5185\u5b58\u5e03\u5c40\uff0c\u5305\u62ec\u6570\u636e\u6bb5\u7684\u653e\u7f6e\u548c\u5bf9\u9f50\u7b49\u3002</li> </ul> <p>\u94fe\u63a5\u5668\u7684\u8f93\u5165\u548c\u8f93\u51fa\u90fd\u662f\u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u53d7\u5230 ABI \u89c4\u8303 \u7684\u7ea6\u675f\u3002ELF \u683c\u5f0f\u5c31\u662f ABI \u89c4\u8303\u7684\u4e00\u90e8\u5206\u3002</p> <p>\u94fe\u63a5\u5668\u811a\u672c\u7684\u5177\u4f53\u8bed\u6cd5\u5e76\u4e0d\u91cd\u8981\uff0c\u80fd\u5927\u81f4\u770b\u61c2\u5c31\u884c\u3002\u63a5\u4e0b\u6765\uff0c\u8bf7\u9605\u8bfb\u5e76\u7406\u89e3\u5b9e\u9a8c\u4ee3\u7801\u4ed3\u4e2d\u7684 <code>arch/riscv/kernel/vmlinux.lds</code>\uff0c\u56de\u7b54\u4e0b\u9762\u7684\u95ee\u9898\uff1a</p> <p>\u8003\u70b9</p> <ul> <li>\u8fd9\u4e2a\u94fe\u63a5\u811a\u672c\u63cf\u8ff0\u7684\u5c31\u662f\u6574\u4e2a\u5185\u6838\u7684\u5185\u5b58\u5e03\u5c40\u3002\u5b83\u4ece\u54ea\u91cc\u5f00\u59cb\uff0c\u6709\u591a\u5927\uff1f</li> <li>\u5176\u4e2d\u7684\u5404\u4e2a\u6bb5\uff08<code>.text</code>\u3001<code>.rodata</code>\u3001<code>.data</code>\u3001<code>.bss</code>\uff09\u5206\u522b\u5b58\u653e\u4ec0\u4e48\u6570\u636e\uff1f</li> <li><code>_skernel</code> \u8fd9\u4e9b\u7b26\u53f7\u662f\u4ec0\u4e48\uff1f\u4f60\u8981\u5982\u4f55\u5728\u6c47\u7f16\u548c C \u4ee3\u7801\u4e2d\u4f7f\u7528\u5b83\u4eec\uff1f</li> </ul> <p>ABI \u89c4\u8303\u53ca\u5176\u5386\u53f2</p> <p>RISC-V ABI \u624b\u518c\u4e2d\u6ca1\u6709 <code>.text</code>\u3001<code>.rodata</code> \u7b49\u7684\u5b9a\u4e49\uff0c\u56e0\u4e3a\u5b83\u662f\u5386\u53f2\u4f20\u627f\u4e0b\u6765\u7684\u3002RISC-V ABI \u624b\u518c\u7684\u53c2\u8003\u6587\u732e\u6307\u5411\u4e86 System V Application Binary Interface - DRAFT\uff0c\u4f60\u53ef\u4ee5\u5728\u8fd9\u91cc\u627e\u5230\u76f8\u5173\u5b9a\u4e49\u3002</p> <p>\u64cd\u4f5c\u7cfb\u7edf\u6709\u6bd4\u8f83\u4e45\u8fdc\u7684\u5386\u53f2\u6c89\u6dc0\uff0c\u56e0\u6b64 ABI \u5c42\u7684\u89c4\u8303\u4e0d\u50cf SBI \u90a3\u6837\u552f\u4e00\u3002\u611f\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u9605\u8bfb The UNIX System -- History and Timeline -- UNIX History\u3002</p> <p><code>vmlinux.lds</code> \u7528\u4e8e\u751f\u6210 <code>vmlinux</code>\uff0c\u4f46 <code>Image</code> \u53c8\u662f\u600e\u4e48\u751f\u6210\u7684\u5462\uff1f\u8bf7\u4f60\uff1a</p> <ul> <li>\u9605\u8bfb <code>Makefile</code>\uff0c\u627e\u5230\u76f8\u5173\u547d\u4ee4</li> <li>\u9605\u8bfb objcopy (GNU Binary Utilities) \u7684\u7b80\u4ecb\u90e8\u5206\uff0c\u7406\u89e3\u5b83\u751f\u6210 binary \u65f6\u505a\u4e86\u4ec0\u4e48\u5de5\u4f5c</li> </ul> <p>\u8981\u70b9\uff1a\u56fa\u4ef6\u52a0\u8f7d\u5185\u5b58\u955c\u50cf</p> <p><code>objcopy -O binary</code> \u4ece ELF \u683c\u5f0f\u7684\u53ef\u6267\u884c\u6587\u4ef6\u4e2d\u76f4\u63a5\u628a\u7a0b\u5e8f\u8981\u8fd0\u884c\u7684\u90a3\u90e8\u5206\u6307\u4ee4\u548c\u6570\u636e\uff0c\u539f\u5c01\u4e0d\u52a8\u62f7\u8d1d\u51fa\u6765\uff0c\u5f97\u5230\u4e00\u4e2a\u5185\u5b58\u5e03\u5c40\u548c\u8fd0\u884c\u65f6\u5b8c\u5168\u4e00\u81f4\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u79f0\u4e3a\u5185\u5b58\u955c\u50cf\uff08memory dump\uff09\u3002</p> <p>\u56fa\u4ef6\uff08\u5982 OpenSBI\uff09\u975e\u5e38\u7b80\u5355\uff0c\u5728\u542f\u52a8\u65f6\u53ea\u8d1f\u8d23\u628a\u8fd9\u6bb5\u4e8c\u8fdb\u5236\u6587\u4ef6\u642c\u5230\u4e00\u4e2a\u56fa\u5b9a\u7684\u5185\u5b58\u5730\u5740\uff0c\u7136\u540e\u76f4\u63a5\u8df3\u8fc7\u53bb\u6267\u884c\uff0c\u5e76\u4e0d\u652f\u6301\u89e3\u6790 ELF \u7b49\u683c\u5f0f\u3002</p> <p>\u4f60\u5c06\u5728 Lab4 \u4e2d\u5b8c\u6210 ELF \u6587\u4ef6\u7684\u89e3\u6790\u548c\u52a0\u8f7d\uff0c\u4ee5\u8fd0\u884c\u7528\u6237\u6001\u7a0b\u5e8f\u3002</p> <p>\u6b64\u5916\uff0c\u6784\u5efa\u8fc7\u7a0b\u8fd8\u4f1a\u751f\u6210\u51e0\u4e2a\u6587\u4ef6\u7528\u4e8e\u8f85\u52a9\u8c03\u8bd5\uff0c\u9047\u5230\u95ee\u9898\u65f6\u597d\u597d\u5229\u7528\u5b83\u4eec\uff1a</p> <ul> <li><code>vmlinux.asm</code>\uff1a\u53cd\u6c47\u7f16\u7ed3\u679c\uff0c\u5305\u542b\u6e90\u4ee3\u7801\u6ce8\u91ca</li> <li><code>System.map</code>\uff1a\u7b26\u53f7\u8868\uff0c\u5305\u542b\u6240\u6709\u7b26\u53f7\u7684\u5730\u5740</li> </ul> <p>\u52a8\u624b\u505a</p> <p>\u8fd0\u884c <code>make</code> \u6784\u5efa\u5185\u6838\u3002</p> <p>\u7528 VSCode \u6253\u5f00 <code>kernel/vmlinux</code>\uff08\u5df2\u9ed8\u8ba4\u7ed1\u5b9a\u5230 ElfPreview \u63d2\u4ef6\uff09\uff0c\u67e5\u770b\u5b83\u7684\u5185\u5bb9\u3002</p> <p>\u8fd9\u4e9b\u4fe1\u606f\u4e5f\u53ef\u4ee5\u901a\u8fc7 <code>readelf</code> \u5de5\u5177\u67e5\u770b\uff0c\u8bf7\u4f60\u81ea\u884c\u5c1d\u8bd5\u3002</p>"},{"location":"lab1/#opensbi-\u8c03\u8bd5","title":"OpenSBI \u8c03\u8bd5","text":"<p>\u672c\u8282\u8ba9\u6211\u4eec\u52a8\u624b\u63a2\u7a76 OpenSBI \u8df3\u8f6c\u5230\u5185\u6838\u65f6\uff0c\u7cfb\u7edf\u7684\u72b6\u6001\uff08\u5bc4\u5b58\u5668\u3001\u5185\u5b58\u7b49\uff09\u662f\u4ec0\u4e48\u6837\u7684\u3002</p> <p>\u6ce8\u610f\u5230 OpenSBI \u6709\u5982\u4e0b\u8f93\u51fa\u3002\u8fd9\u662f OpenSBI \u5728\u901a\u8fc7\u7269\u7406\u5185\u5b58\u4fdd\u62a4\uff08Physical Memory Protection, PMP\uff09\u673a\u5236\u8bbe\u7f6e\u7269\u7406\u5185\u5b58\u7684\u6743\u9650\uff1a</p> <pre><code>Domain0 Region00            : 0x0000000000100000-0x0000000000100fff M: (I,R,W) S/U: (R,W)\nDomain0 Region01            : 0x0000000010000000-0x0000000010000fff M: (I,R,W) S/U: (R,W)\nDomain0 Region02            : 0x0000000002000000-0x000000000200ffff M: (I,R,W) S/U: ()\nDomain0 Region03            : 0x0000000080040000-0x000000008005ffff M: (R,W) S/U: ()\nDomain0 Region04            : 0x0000000080000000-0x000000008003ffff M: (R,X) S/U: ()\nDomain0 Region05            : 0x000000000c400000-0x000000000c5fffff M: (I,R,W) S/U: (R,W)\nDomain0 Region06            : 0x000000000c000000-0x000000000c3fffff M: (I,R,W) S/U: (R,W)\nDomain0 Region07            : 0x0000000000000000-0xffffffffffffffff M: () S/U: (R,W,X)\n</code></pre> <p>\u52a8\u624b\u505a</p> <p>\u6309 Lab0 \u4e2d\u7684\u6b65\u9aa4\u542f\u52a8 QEMU \u548c GDB \u8c03\u8bd5\u3002</p> <ol> <li> <p>GDB \u5728 OpenSBI \u8df3\u8f6c\u5230\u7684\u5730\u5740\uff08Next Addr\uff09\u5904\u8bbe\u7f6e\u65ad\u70b9\uff0c\u67e5\u770b\u6b64\u65f6\uff1a</p> <ul> <li><code>sp</code> \u5bc4\u5b58\u5668\u7684\u503c\u662f\u591a\u5c11\uff1f</li> <li>\u8fd9\u5c5e\u4e8e\u54ea\u4e2a\u533a\u57df\uff0c\u8be5\u533a\u57df\u5404\u4e2a\u7279\u6743\u7ea7\u7684\u6743\u9650\u662f\u4ec0\u4e48\uff1f</li> </ul> </li> <li> <p>\u7528 VSCode \u6253\u5f00 <code>kernel/arch/riscv/boot/Image</code>\uff08\u5df2\u9ed8\u8ba4\u7ed1\u5b9a\u5230 Hex Editor \u63d2\u4ef6\uff09\uff0c\u7136\u540e\u62c9\u5230\u6700\u5e95\u4e0b\uff0c\u89c2\u5bdf Hex Editor \u5de6\u4fa7\u663e\u793a\u7684\u6587\u4ef6\u504f\u79fb\u5730\u5740\uff0c\u5b83\u7684\u5927\u5c0f\u662f\u591a\u5c11\uff1f\u63a5\u4e0b\u6765\uff0c\u8bf7\u4f60\u5bf9\u7167 <code>vmlinux.lds</code> \u548c <code>System.map</code>\uff0c\u67e5\u770b\u8d77\u59cb\u548c\u672b\u5c3e\u7b26\u53f7\uff08<code>_skernel</code> \u548c <code>_ebss</code>\uff09\u5bf9\u5e94\u7684\u5730\u5740\u4e4b\u5dee\u662f\u591a\u5c11\uff1f\uff08\u5728\u8fd9\u91cc\uff0c\u6211\u4eec\u6682\u65f6\u4e0d\u8003\u8651 <code>_ekernel</code>\uff0c\u56e0\u6b64\u5b58\u5728\u5185\u5b58\u5bf9\u9f50\u7684\u56e0\u7d20\uff09</p> <p>\u8bf7\u4f60\u601d\u8003\uff1a\u4e3a\u4ec0\u4e48 <code>Image</code> \u6587\u4ef6\u7684\u5927\u5c0f\u4f1a\u5c0f\u4e8e\u94fe\u63a5\u811a\u672c\u4e2d\u5b9a\u4e49\u7684\u5185\u6838\u5927\u5c0f\uff1f\u5728\u4e0a\u9762\uff0c\u6211\u4eec\u5df2\u7ecf\u77e5\u9053 <code>Image</code> \u6587\u4ef6\u7684\u5185\u5b58\u5e03\u5c40\u548c\u8fd0\u884c\u65f6\u662f\u4e00\u81f4\u7684\uff0c\u7406\u8bba\u4e0a\u5b83\u5e94\u5f53\u7b26\u5408\u94fe\u63a5\u811a\u672c\u548c\u7b26\u53f7\u8868\u4e2d\u7684\u5b9a\u4e49\u3002\uff08\u63d0\u793a\uff1a\u4f60\u9700\u8981\u7406\u89e3\u94fe\u63a5\u811a\u672c\u4e2d\u5404\u4e2a\u6bb5\u5b58\u653e\u7684\u6570\u636e\u7c7b\u578b\uff09</p> <p>\u4e8b\u5b9e\u4e0a\uff0c\u7531\u4e8e <code>.data</code> \u6bb5\u5b58\u653e\u6709\u521d\u59cb\u503c\u7684\u53d8\u91cf\uff0c\u8fd9\u4e9b\u521d\u59cb\u503c\u672c\u8eab\u5fc5\u987b\u88ab\u4fdd\u5b58\u5728\u955c\u50cf\u4e2d\uff0c\u800c <code>.bss</code> \u6bb5\u5b58\u653e\u672a\u521d\u59cb\u5316\u7684\u53d8\u91cf\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5728\u955c\u50cf\u4e2d\u8bb0\u5f55\u8fd9\u4e2a\u6bb5\u7684\u5927\u5c0f\uff0c\u800c\u4e0d\u9700\u8981\u5b58\u50a8\u5176\u5b9e\u9645\u5185\u5bb9\u3002\u5185\u6838\u542f\u52a8\u65f6\uff0c\u52a0\u8f7d\u5668\u4f1a\u4e3a\u5b83\u5206\u914d\u7a7a\u95f4\u5e76\u76f4\u63a5\u6e05\u96f6\u5185\u5b58\u3002\u56e0\u6b64\uff0c<code>.bss</code> \u6bb5\u7684\u5927\u5c0f\u4e0d\u4f1a\u53cd\u6620\u5728 <code>Image</code> \u6587\u4ef6\u4e2d\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u8bf7\u4f60\u5bfb\u627e <code>vmlinux.lds</code> \u4e2d\u6808\u7a7a\u95f4\u5728\u54ea\u91cc\u88ab\u5b9a\u4e49\uff0c\u5e76\u6307\u51fa\u5177\u4f53\u7684\u4ee3\u7801\u3002\u6211\u4eec\u4e3a\u4ec0\u4e48\u9009\u62e9\u5728 <code>.bss</code> \u6bb5\u5f00\u8f9f\u6808\u7a7a\u95f4\uff0c\u800c\u4e0d\u662f <code>.data</code> \u6bb5\u5462\uff1f</p> </li> </ol> <p>\u66f4\u591a\u8d44\u6599</p> <ul> <li>Physical Memory Protection (PMP) \u673a\u5236\uff1aRISC-V \u7279\u6743\u7ea7\u624b\u518c 3.7. Physical Memory Protection</li> <li>OpenSBI \u76f8\u5173\u6e90\u7801\u76f8\u5173\u6e90\u7801\u4f4d\u4e8e <code>lib/sbi/sbi_domain.c</code> \u4e2d\u7684 <code>sbi_domain_init()</code></li> <li>\u611f\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u4f7f\u7528 QEMU Monitor \u6253\u5370\u5185\u5b58\u6811\uff08<code>info mtree</code>\uff09\uff0c\u5bf9\u6bd4\u4e86\u89e3 OpenSBI \u4e3a\u4ec0\u4e48\u8981\u8bbe\u7f6e\u8fd9\u4e9b PMP \u533a\u57df</li> </ul>"},{"location":"lab1/#task-1\u4e3a-start_kernel-\u51c6\u5907\u8fd0\u884c\u73af\u5883","title":"Task 1\uff1a\u4e3a <code>start_kernel()</code> \u51c6\u5907\u8fd0\u884c\u73af\u5883","text":"<p>\u73b0\u5728\u4f60\u5df2\u7ecf\u77e5\u9053\uff1a</p> <ul> <li>OpenSBI \u8df3\u8f6c\u5230\u5185\u6838\u65f6\uff0c<code>sp</code> \u6307\u5411 OpenSBI \u4fdd\u62a4\u7684\u533a\u57df\uff0c\u65e0\u6cd5\u4f7f\u7528</li> <li>\u6211\u4eec\u5728\u5185\u6838\u4e2d\u5f00\u8f9f\u4e86\u4e00\u6bb5\u6808\u7a7a\u95f4</li> <li>\u6c47\u7f16\u4ee3\u7801\u4e2d\u53ef\u4ee5\u5f15\u7528\u94fe\u63a5\u811a\u672c\u5b9a\u4e49\u7684\u7b26\u53f7</li> </ul> <p>\u4f60\u7684\u4efb\u52a1\u662f\u4fee\u6539 <code>arch/riscv/head.S</code>\uff0c\u4f7f\u5f97\u80fd\u591f\u6210\u529f\u8fdb\u5165 <code>start_kernel()</code> \u51fd\u6570\uff0c\u5e76\u8fdb\u5165\u5230 <code>printk()</code> \u51fd\u6570\u3002</p> <p>\u5b8c\u6210\u6761\u4ef6</p> <ul> <li> <p>GDB \u65ad\u70b9\u6253\u5728 <code>printk()</code> \u5904\uff0c\u80fd\u6210\u529f\u8fdb\u5165 <code>printk()</code> \u51fd\u6570\u3002\u8fd9\u91cc\u6210\u529f\u7684\u6761\u4ef6\u662f\uff1a\u5230\u8fbe <code>printk()</code> \u65ad\u70b9\u65f6\uff0c<code>scause</code> \u5bc4\u5b58\u5668\u7684\u503c\u4e3a 0\uff0c\u8868\u660e\u6ca1\u6709\u5f02\u5e38\u3002</p> <pre><code>(gdb) b printk\nBreakpoint 1 at ...\n(gdb) c\nContinuing.\nBreakpoint 1, printk ...\n(gdb) i r scause\nscause        0x0    0\n</code></pre> </li> <li> <p>\u53ef\u4ee5\u901a\u8fc7\u8bc4\u6d4b\u6846\u67b6\u7684 <code>lab1-task1</code> \u6d4b\u8bd5\u3002</p> </li> </ul>"},{"location":"lab1/#c-\u5185\u8054\u6c47\u7f16","title":"C \u5185\u8054\u6c47\u7f16","text":"<p>C++ \u6807\u51c6\u652f\u6301\u5185\u8054\u6c47\u7f16\uff0c\u4f46 C \u6807\u51c6\u5e76\u4e0d\u652f\u6301\u3002GCC \u63d0\u4f9b\u4e86\u5185\u8054\u6c47\u7f16\u7684\u6269\u5c55\u8bed\u6cd5\uff0c\u5141\u8bb8\u5728 C \u4ee3\u7801\u4e2d\u5d4c\u5165\u6c47\u7f16\u6307\u4ee4\u3002</p> <p>\u8bf7\u9605\u8bfb GCC \u7f16\u8bd1\u5668\u624b\u518c\u4e2d\u7684\u4e0b\u5217\u7ae0\u8282\uff0c\u5b66\u4e60\u5185\u8054\u6c47\u7f16\u7684\u8bed\u6cd5\uff1a</p> <ul> <li>Extended Asm (Using the GNU Compiler Collection (GCC))</li> <li>Local Register Variables (Using the GNU Compiler Collection (GCC))</li> </ul> \u8981\u70b9\uff1aC \u5185\u8054\u6c47\u7f16 <ul> <li> <p>Extended Asm</p> <ul> <li> <p>\u57fa\u672c\u6982\u5ff5</p> <ul> <li>Extended asm \u5141\u8bb8\u5728 C \u4ee3\u7801\u4e2d\u5d4c\u5165\u6c47\u7f16\u6307\u4ee4\uff0c\u5e76\u53ef\u8bfb\u5199 C \u53d8\u91cf\u3001\u4f7f\u7528 C \u6807\u7b7e\u8df3\u8f6c\u3002</li> <li> <p>\u8bed\u6cd5\u683c\u5f0f\uff1a</p> <pre><code>asm asm-qualifiers (\n    AssemblerTemplate\n    : OutputOperands\n    [ : InputOperands\n    [ : Clobbers\n    [ : GotoLabels ]]]\n)\n</code></pre> </li> <li> <p><code>asm</code> \u662f GNU \u6269\u5c55\u3002\u82e5\u9700\u517c\u5bb9 <code>-ansi</code> \u548c <code>-std</code>\uff0c\u5e94\u4f7f\u7528 <code>__asm__</code>\u3002</p> </li> </ul> </li> <li> <p>\u5173\u952e\u9650\u5b9a\u7b26</p> <ul> <li>volatile<ul> <li>\u9632\u6b62\u7f16\u8bd1\u5668\u4f18\u5316\u6389 asm \u8bed\u53e5\u6216\u79fb\u52a8\u5176\u4f4d\u7f6e\u3002</li> <li>\u5fc5\u987b\u7528\u4e8e\u6709\u526f\u4f5c\u7528\u3001\u6216\u7ed3\u679c\u4e0d\u53ef\u9884\u6d4b\u7684\u6307\u4ee4\uff08\u5982 <code>rdtsc</code>\uff09\u3002</li> </ul> </li> <li>inline<ul> <li>\u544a\u8bc9\u7f16\u8bd1\u5668 asm \u8bed\u53e5\u53ef\u88ab\u5185\u8054\u3002</li> </ul> </li> <li>goto<ul> <li>\u5141\u8bb8\u4ece asm \u8df3\u8f6c\u5230\u6307\u5b9a\u7684 C \u6807\u7b7e\u3002</li> </ul> </li> </ul> </li> <li> <p>\u53c2\u6570\u7c7b\u578b</p> <ol> <li> <p>AssemblerTemplate</p> <ul> <li>\u5b57\u7b26\u4e32\u6a21\u677f\uff0c\u6df7\u5408\u6c47\u7f16\u6307\u4ee4\u548c\u53c2\u6570\u5360\u4f4d\u7b26\uff08\u5982 <code>%0</code>, <code>%1</code> \u6216\u7b26\u53f7\u540d <code>%[name]</code>\uff09\u3002</li> </ul> </li> <li> <p>OutputOperands</p> <ul> <li>C \u53d8\u91cf\uff0c\u88ab\u6c47\u7f16\u4ee3\u7801\u4fee\u6539\u3002\u683c\u5f0f\uff1a<code>[symbol] \"constraint\" (variable)</code></li> <li>\u7ea6\u675f\u7b26\u5fc5\u987b\u4ee5 <code>=</code>\uff08\u53ea\u5199\uff09\u6216 <code>+</code>\uff08\u8bfb\u5199\uff09\u5f00\u5934\u3002</li> <li>\u53ef\u7528 <code>&amp;</code> \u9632\u6b62\u8f93\u51fa\u4e0e\u8f93\u5165\u91cd\u53e0\u3002</li> </ul> </li> <li> <p>InputOperands</p> <ul> <li>C \u8868\u8fbe\u5f0f\uff0c\u88ab\u6c47\u7f16\u4ee3\u7801\u8bfb\u53d6\u3002\u683c\u5f0f\uff1a<code>[symbol] \"constraint\" (expression)</code></li> <li>\u7ea6\u675f\u4e0d\u80fd\u4ee5 <code>=</code> \u6216 <code>+</code> \u5f00\u5934\u3002\u53ef\u7528\u6570\u5b57/\u7b26\u53f7\u540d\u6307\u5b9a\u4e0e\u8f93\u51fa\u5171\u4eab\u5bc4\u5b58\u5668\u3002</li> </ul> </li> <li> <p>Clobbers</p> <ul> <li>\u6c47\u7f16\u4f1a\u4fee\u6539\u7684\u989d\u5916\u5bc4\u5b58\u5668\u6216\u72b6\u6001\uff0c\u5982 <code>\"cc\"</code>\uff08\u6807\u5fd7\u5bc4\u5b58\u5668\uff09\u3001<code>\"memory\"</code>\uff08\u5185\u5b58\u5c4f\u969c\uff09\u3001<code>\"redzone\"</code>\u3002</li> <li>\u4e0d\u53ef\u4e0e\u8f93\u5165\u8f93\u51fa\u5bc4\u5b58\u5668\u91cd\u53e0\uff0c\u4e0d\u5e94\u5305\u542b\u6808\u6307\u9488\u3002</li> </ul> </li> <li> <p>GotoLabels</p> <ul> <li>\u6c47\u7f16\u4e2d\u53ef\u80fd\u8df3\u8f6c\u7684 C \u6807\u7b7e\u3002\u7981\u6b62\u8de8\u8d8a asm \u8bed\u53e5\u8df3\u8f6c\u3002</li> </ul> </li> </ol> </li> <li> <p>\u5e38\u89c1\u7528\u6cd5\u793a\u4f8b</p> <ul> <li> <p>\u57fa\u672c\u7528\u6cd5\uff1a</p> <pre><code>int src = 1, dst;\nasm (\"mov %1, %0\\n\\t\"\n    \"add $1, %0\"\n    : \"=r\"(dst)      // \u8f93\u51fa\n    : \"r\"(src));     // \u8f93\u5165\n</code></pre> </li> <li> <p>\u5e26 clobber\uff1a</p> <pre><code>asm volatile (\"movc3 %0, %1, %2\"\n    : /* no outputs */\n    : \"g\"(from), \"g\"(to), \"g\"(count)\n    : \"r0\",\"r1\",\"r2\",\"r3\",\"r4\",\"r5\",\"memory\");\n</code></pre> </li> <li> <p>\u7b26\u53f7\u540d\u8f93\u5165\u8f93\u51fa\uff1a</p> <pre><code>uint32_t Mask = 1234, Index;\nasm (\"bsfl %[aMask], %[aIndex]\"\n    : [aIndex] \"=r\"(Index)\n    : [aMask] \"r\"(Mask)\n    : \"cc\");\n</code></pre> </li> </ul> </li> <li> <p>\u7f16\u8bd1\u5668\u4e0e\u4f18\u5316\u6ce8\u610f\u4e8b\u9879</p> <ul> <li>\u82e5\u8f93\u51fa\u672a\u4f7f\u7528\uff0c\u7f16\u8bd1\u5668\u53ef\u80fd\u5220\u9664 asm\uff0c\u9700\u52a0 <code>volatile</code>\u3002</li> <li>\u8f93\u5165\u5bc4\u5b58\u5668\u4e0d\u53ef\u5728 asm \u5185\u4fee\u6539\uff0c\u9664\u975e\u4e0e\u8f93\u51fa\u7ed1\u5b9a\u3002</li> <li><code>memory</code> clobber \u5f62\u6210\u7f16\u8bd1\u5668\u7ea7\u522b\u5185\u5b58\u5c4f\u969c\uff0c\u4f46\u4e0d\u80fd\u963b\u6b62 CPU \u63a8\u6d4b\u6267\u884c\u3002</li> <li>\u5bc4\u5b58\u5668\u5206\u914d\u907f\u514d clobber \u4e2d\u7684\u5bc4\u5b58\u5668\u3002</li> <li>\u8f93\u51fa\u7ea6\u675f <code>+</code> \u540c\u65f6\u7b97\u8f93\u5165\u548c\u8f93\u51fa\uff0c\u5f71\u54cd 30 \u4e2a\u64cd\u4f5c\u6570\u4e0a\u9650\u3002</li> </ul> </li> <li> <p>\u6027\u80fd\u4e0e\u5b89\u5168</p> <ul> <li>\u4f7f\u7528\u65e9\u671f clobber (<code>&amp;</code>) \u6216\u7ed1\u5b9a\u8f93\u51fa - \u8f93\u5165\u907f\u514d\u5bc4\u5b58\u5668\u51b2\u7a81\u3002</li> <li>\u8c28\u614e\u4f7f\u7528 <code>memory</code>\uff0c\u4f1a\u5bfc\u81f4\u5bc4\u5b58\u5668\u5237\u65b0\uff0c\u5f71\u54cd\u6027\u80fd\u3002</li> <li>\u907f\u514d\u76f4\u63a5\u4fee\u6539\u6808\u6307\u9488\u5bc4\u5b58\u5668\u3002</li> </ul> </li> </ul> </li> <li> <p>Specifying Registers for Local Variables</p> <ul> <li> <p>\u57fa\u672c\u6982\u5ff5</p> <ul> <li> <p>\u53ef\u4ee5\u5728\u51fd\u6570\u5185\u5b9a\u4e49\u5c40\u90e8\u5bc4\u5b58\u5668\u53d8\u91cf\uff0c\u5e76\u5c06\u5176\u7ed1\u5b9a\u5230\u7279\u5b9a\u5bc4\u5b58\u5668\uff1a</p> <pre><code>register int *foo asm(\"r12\");\n</code></pre> </li> <li> <p><code>register</code> \u5173\u952e\u5b57\u5fc5\u9700\uff0c\u4e0d\u80fd\u4e0e <code>static</code> \u4e00\u8d77\u4f7f\u7528\u3002</p> </li> <li>\u5bc4\u5b58\u5668\u540d\u79f0\u5fc5\u987b\u662f\u76ee\u6807\u5e73\u53f0\u4e0a\u6709\u6548\u7684\u5bc4\u5b58\u5668\u540d\u3002</li> </ul> </li> <li> <p>\u9650\u5236\u4e0e\u6ce8\u610f\u4e8b\u9879</p> <ul> <li>\u7981\u6b62\u4f7f\u7528 <code>const</code> \u548c <code>volatile</code>\uff1a<ul> <li><code>const</code> \u53ef\u80fd\u5bfc\u81f4\u7f16\u8bd1\u5668\u7528\u521d\u59cb\u503c\u66ff\u6362\u53d8\u91cf\uff0c\u4f7f\u64cd\u4f5c\u6570\u5206\u914d\u5230\u4e0d\u540c\u5bc4\u5b58\u5668\u3002</li> <li><code>volatile</code> \u884c\u4e3a\u53ef\u80fd\u4e0e\u9884\u671f\u4e0d\u7b26\u3002</li> </ul> </li> <li>\u4ec5\u5728\u8c03\u7528 Extended asm \u6307\u5b9a\u8f93\u5165/\u8f93\u51fa\u5bc4\u5b58\u5668\u65f6\u624d\u652f\u6301\u6b64\u529f\u80fd\u3002</li> <li>\u5efa\u8bae\u9009\u62e9\u5728\u51fd\u6570\u8c03\u7528\u65f6 \u81ea\u52a8\u4fdd\u5b58\u548c\u6062\u590d \u7684\u5bc4\u5b58\u5668\uff0c\u4ee5\u907f\u514d\u5e93\u51fd\u6570\u8c03\u7528\u7834\u574f\u5176\u503c\u3002</li> </ul> </li> <li> <p>\u7528\u6cd5\u793a\u4f8b</p> <pre><code>register int *p1 asm(\"r0\") = ...;\nregister int *p2 asm(\"r1\") = ...;\nregister int *result asm(\"r0\");\nasm(\"sysint\" : \"=r\"(result) : \"0\"(p1), \"r\"(p2));\n</code></pre> <ul> <li>\u4e0a\u4f8b\u4e2d\uff0c<code>p1</code> \u548c <code>p2</code> \u7684\u503c\u5728 <code>asm</code> \u8c03\u7528\u4e2d\u7ed1\u5b9a\u5230 <code>r0</code> \u548c <code>r1</code>\u3002</li> </ul> </li> <li> <p>\u5e38\u89c1\u95ee\u9898\u4e0e\u89e3\u51b3</p> <ul> <li>\u5bc4\u5b58\u5668\u53ef\u80fd\u88ab\u540e\u7eed\u4ee3\u7801\u6216\u5e93\u51fd\u6570\u8c03\u7528\u7834\u574f\uff0c\u5305\u62ec\u7b97\u672f\u8fd0\u7b97\u65f6\u7684\u4e34\u65f6\u8c03\u7528\u3002</li> <li> <p>\u89e3\u51b3\u65b9\u6cd5\uff1a\u5bf9\u4e2d\u95f4\u8868\u8fbe\u5f0f\u4f7f\u7528\u4e34\u65f6\u53d8\u91cf\uff0c\u907f\u514d\u76f4\u63a5\u5728\u5bc4\u5b58\u5668\u53d8\u91cf\u521d\u59cb\u5316\u4e2d\u505a\u8ba1\u7b97\uff1a</p> <pre><code>int t1 = ...;\nregister int *p1 asm(\"r0\") = ...;\nregister int *p2 asm(\"r1\") = t1;\nregister int *result asm(\"r0\");\nasm(\"sysint\" : \"=r\"(result) : \"0\"(p1), \"r\"(p2));\n</code></pre> </li> </ul> </li> </ul> </li> </ul> <p>\u52a8\u624b\u505a</p> <p>\u4e0b\u9762\u8fd9\u6bb5 C \u5185\u8054\u6c47\u7f16\u5b58\u5728\u95ee\u9898\uff1a</p> <p></p> <ol> <li>\u8bf7\u4f60\u89c2\u5bdf\u53f3\u4fa7\u6c47\u7f16\u7ed3\u679c\uff0c\u6307\u51fa\u95ee\u9898\u6240\u5728\uff0c\u5e76\u5206\u6790\u4ea7\u751f\u95ee\u9898\u7684\u539f\u56e0\u3002</li> <li>\u7ed9\u51fa\u4f60\u4fee\u6b63\u540e\u7684\u4ee3\u7801\u3002</li> </ol>"},{"location":"lab1/#sbi-\u4e0e-ecall","title":"SBI \u4e0e ECALL","text":"<p>\u8bf7\u9605\u8bfb\u4ee5\u4e0b\u6750\u6599\uff1a</p> <ul> <li> <p>\u975e\u7279\u6743\u7ea7\u624b\u518c 2.8. Environment Call and Breakpoints</p> <p>\u8003\u70b9</p> <ul> <li>ECALL \u6307\u4ee4\u7684\u4f5c\u7528\u662f\u4ec0\u4e48\uff1f</li> <li>\u5bf9\u4e8e\u6211\u4eec\u5b9e\u73b0\u7684\u64cd\u4f5c\u7cfb\u7edf\u6765\u8bf4\uff0c\u670d\u52a1\u8bf7\u6c42\u7684\u53c2\u6570\u4f20\u9012\u7531\u8c01\u5b9a\u4e49\uff1f</li> </ul> </li> <li> <p>SBI \u624b\u518c</p> <ul> <li> <p>Chapter 1. Introduction</p> <p>\u8003\u70b9</p> <ul> <li>\u4ec0\u4e48\u662f SBI\uff1f\u5b83\u4e3a\u8c01\u63d0\u4f9b\u670d\u52a1\uff1f</li> </ul> </li> <li> <p>Chapter 3. Binary Encoding \u7684\u7ae0\u8282\u5bfc\u8a00</p> <p>\u8003\u70b9</p> <ul> <li>\u5728\u672c\u8bfe\u7a0b\u4e2d\uff0c\u8c01\u662f Supervisor\uff1f\u8c01\u662f SEE\uff1f</li> <li>\u5982\u4f55\u6807\u8bc6\u4e00\u4e2a\u7279\u5b9a\u7684 SBI \u8c03\u7528\uff1f</li> <li>SBI \u8c03\u7528\u7684\u53c2\u6570\u548c\u8fd4\u56de\u503c\u662f\u5982\u4f55\u4f20\u9012\u7684\uff1f</li> <li>SBI \u8c03\u7528\u65f6\uff0c\u54ea\u4e9b\u5bc4\u5b58\u5668\u7684\u503c\u4e0d\u4f1a\u88ab\u4fdd\u5b58\uff1f</li> <li>\u5982\u4f55\u5224\u65ad SBI \u8c03\u7528\u662f\u5426\u6210\u529f\uff1f</li> </ul> </li> <li> <p>Chapter 12. Debug Console Extension (EID #0x4442434E \"DBCN\")</p> <p>\u8003\u70b9</p> <ul> <li>Debug Console Extension \u63d0\u4f9b\u4e86\u4ec0\u4e48\u529f\u80fd\uff1f</li> <li><code>sbi_debug_console_write</code> \u51fd\u6570\u7684\u53c2\u6570\u548c\u8fd4\u56de\u503c\u5206\u522b\u662f\u4ec0\u4e48\uff1f</li> </ul> </li> </ul> </li> </ul>"},{"location":"lab1/#task-2\u4f7f\u7528-sbi-\u5b9e\u73b0-printk","title":"Task 2\uff1a\u4f7f\u7528 SBI \u5b9e\u73b0 <code>printk()</code>","text":"<p>\u73b0\u5728\u4f60\u5df2\u7ecf\u77e5\u9053\uff1a</p> <ul> <li>\u600e\u4e48\u5199 C \u5185\u8054\u6c47\u7f16</li> <li>\u600e\u4e48\u4f7f\u7528 ECALL \u6307\u4ee4\u53d1\u8d77 SBI \u8c03\u7528</li> <li><code>sbi_debug_console_write</code> \u51fd\u6570\u7684\u53c2\u6570\u548c\u8fd4\u56de\u503c</li> </ul> <p>\u4f60\u7684\u4efb\u52a1\u662f\uff1a</p> <ul> <li>\u5728 <code>arch/riscv/sbi.c</code> \u4e2d\u4f7f\u7528\u5185\u8054\u6c47\u7f16\u5b9e\u73b0 <code>sbi_ecall()</code>\u3002</li> <li>\u5728 <code>arch/riscv/sbi.c</code> \u4e2d\u8865\u5168 <code>sbi_debug_console_*()</code> \u51e0\u4e2a\u51fd\u6570\uff0c\u4e5f\u5c31\u662f\u5411 <code>sbi_ecall()</code> \u4f20\u9012\u6b63\u786e\u7684\u53c2\u6570\u3002</li> </ul> <p>\u5b8c\u6210\u6761\u4ef6</p> <ul> <li>\u6210\u529f\u770b\u5230 <code>Hello, ZJU OS 2025!</code>\u3002</li> <li>\u901a\u8fc7\u8bc4\u6d4b\u6846\u67b6\u7684 <code>lab1-task2</code> \u6d4b\u8bd5\u3002</li> </ul> <p>\u66f4\u591a\u8d44\u6599</p> <p>Linux \u5185\u6838\u7684 <code>printk()</code> \u4e0e\u6211\u4eec\u7684\u7b80\u5355\u8f93\u51fa\u4e0d\u540c\uff0c\u5b83\u5b9e\u9645\u4e0a\u662f\u6253\u5370\u5230\u5185\u6838\u65e5\u5fd7\u7f13\u51b2\u533a\uff08ring buffer\uff09\u4e2d\uff0c\u7136\u540e\u7531\u4e13\u95e8\u7684\u5185\u6838\u7ebf\u7a0b <code>klogd</code> \u8d1f\u8d23\u5c06\u65e5\u5fd7\u8f93\u51fa\u5230\u63a7\u5236\u53f0\u6216\u4fdd\u5b58\u5230\u6587\u4ef6\u4e2d\u3002</p> <p>\u611f\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u9605\u8bfb Linux kernel printk new implementation - huang weiliang\u3002</p>"},{"location":"lab1/#part-2\u65f6\u949f\u4e2d\u65ad\u53ca\u5176\u5904\u7406","title":"Part 2\uff1a\u65f6\u949f\u4e2d\u65ad\u53ca\u5176\u5904\u7406","text":""},{"location":"lab1/#\u7279\u6743\u7ea7\u4e2d\u65ad\u4e0e\u5f02\u5e38","title":"\u7279\u6743\u7ea7\u3001\u4e2d\u65ad\u4e0e\u5f02\u5e38","text":"<p>\u9996\u5148\uff0c\u8ba9\u6211\u4eec\u4e86\u89e3\u7279\u6743\u7ea7\u3001\u4e2d\u65ad\u4e0e\u5f02\u5e38\u7684\u6982\u5ff5\uff1a</p> <ul> <li> <p>\u7279\u6743\u7ea7\u624b\u518c 1.2. Privilege Levels\uff1a</p> <p>\u8003\u70b9</p> <ul> <li>\u7279\u6743\u7ea7\u662f\u7528\u6765\u5e72\u4ec0\u4e48\u7684\uff1f</li> <li>\u6267\u884c\u5f53\u524d\u7279\u6743\u7ea7\u4e0d\u5141\u8bb8\u7684\u64cd\u4f5c\u4f1a\u53d1\u751f\u4ec0\u4e48\uff1f</li> <li>M\u3001U\u3001S \u6a21\u5f0f\u5206\u522b\u662f\u4e3a\u4e86\u4ec0\u4e48\u8bbe\u8ba1\u7684\uff1f</li> </ul> </li> <li> <p>\u975e\u7279\u6743\u7ea7\u624b\u518c 1.6. Exceptions, Traps, and Interrupts \u7684\u7b2c\u4e00\u6bb5\uff08\u76f4\u63a5\u8d34\u5728\u4e0b\u9762\u4e86\uff09\uff1a</p> <p>We use the term exception to refer to an unusual condition occurring at run time associated with an instruction in the current RISC-V hart. We use the term interrupt to refer to an external asynchronous event that may cause a RISC-V hart to experience an unexpected transfer of control. We use the term trap to refer to the transfer of control to a trap handler caused by either an exception or an interrupt.</p> <p>\u8003\u70b9</p> <ul> <li>RISC-V \u4e2d exception\u3001interrupt \u6709\u4f55\u5f02\u540c\uff1f</li> <li>Trap \u662f\u4ec0\u4e48\u610f\u601d\uff1f\u4e3e\u4e24\u4e2a Trap \u7684\u4f8b\u5b50</li> </ul> </li> </ul>"},{"location":"lab1/#csr-\u5bc4\u5b58\u5668","title":"CSR \u5bc4\u5b58\u5668","text":"<p>\u63a5\u4e0b\u6765\u8ba9\u6211\u4eec\u4e86\u89e3 CSR \u5bc4\u5b58\u5668\u3002\u5b83\u4eec\u662f RISC-V CPU \u4e2d\u7684\u4e00\u7cfb\u5217\u7279\u6b8a\u5bc4\u5b58\u5668\uff0c\u80fd\u591f\u53cd\u6620\u548c\u63a7\u5236 CPU \u5f53\u524d\u7684\u72b6\u6001\u548c\u6267\u884c\u673a\u5236\u3002\u6211\u4eec\u5148\u4e86\u89e3 M \u6a21\u5f0f\u7684 CSR \u5bc4\u5b58\u5668\uff1a</p> <ul> <li> <p>Chapter 2. Control and Status Registers (CSRs) \u7684\u7ae0\u8282\u5bfc\u8a00</p> <p>\u8003\u70b9</p> <ul> <li>\u8bfb\u53d6\u3001\u4fee\u6539\u3001\u5199\u5165 CSR \u7684\u6307\u4ee4\u5b9a\u4e49\u5728\u54ea\u4e2a\u6269\u5c55\uff1f</li> <li>S \u6a21\u5f0f\u7684 CSR \u80fd\u88ab M \u6a21\u5f0f\u8bbf\u95ee\u5417\uff1f\u53cd\u4e4b\u5462\uff1f</li> </ul> </li> <li> <p>3.1.6.1. Privilege and Global Interrupt-Enable Stack in mstatus register</p> <p>\u8003\u70b9</p> <ul> <li>mstatus \u5bc4\u5b58\u5668\u7684\u4f5c\u7528\u662f\u4ec0\u4e48\uff1f</li> <li>xIE bit \u7684\u4f5c\u7528\u662f\u4ec0\u4e48\uff1f</li> <li>\u8fd0\u884c\u5728 S \u6a21\u5f0f\u4e14 mstatus.SIE=0\uff0cmstatus.MIE=0 \u65f6\uff0c\u53d1\u751f\u4e2d\u65ad\u4f1a\u8fdb\u5165\u54ea\u4e2a\u6a21\u5f0f\uff1f</li> <li>\u4ece\u7279\u6743\u7ea7 y \u9677\u5165\u5230\u66f4\u9ad8\u7684\u7279\u6743\u7ea7 x \u65f6\uff0cxPIE\u3001xIE \u548c xPP \u4f1a\u5982\u4f55\u53d8\u5316\uff1f</li> <li>xRET \u6307\u4ee4\u8fd4\u56de\u65f6\uff0c\u7279\u6743\u7ea7\u548c\u4e2d\u65ad\u4f7f\u80fd\u4f4d\u4f1a\u5982\u4f55\u6062\u590d\uff1fxPP \u4f1a\u8bbe\u7f6e\u4e3a\u4ec0\u4e48\uff1f</li> </ul> \u8981\u70b9\uff1amstatus <ol> <li> <p>\u5168\u5c40\u4e2d\u65ad\u4f7f\u80fd\u4f4d (Global Interrupt-Enable Bits)</p> <ul> <li><code>MIE</code> \u2192 \u63a7\u5236 M-mode \u4e2d\u65ad\u7684\u5168\u5c40\u4f7f\u80fd\u3002</li> <li><code>SIE</code> \u2192 \u63a7\u5236 S-mode \u4e2d\u65ad\u7684\u5168\u5c40\u4f7f\u80fd\uff08\u5982\u679c S-mode \u672a\u5b9e\u73b0\uff0c\u5219\u4e3a\u53ea\u8bfb 0\uff09\u3002</li> <li>\u5f53\u5728\u7279\u6743\u7ea7 x \u4e0b\u6267\u884c\u65f6\uff1a<ul> <li><code>xIE = 1</code> \u2192 \u8be5\u7279\u6743\u7ea7\u7684\u4e2d\u65ad\u5168\u5c40\u4f7f\u80fd\u3002</li> <li><code>xIE = 0</code> \u2192 \u8be5\u7279\u6743\u7ea7\u7684\u4e2d\u65ad\u5168\u5c40\u5173\u95ed\u3002</li> </ul> </li> <li>\u66f4\u9ad8\u7279\u6743\u7ea7\u7684\u4e2d\u65ad\u59cb\u7ec8\u4f7f\u80fd\uff1b\u66f4\u4f4e\u7279\u6743\u7ea7\u7684\u4e2d\u65ad\u59cb\u7ec8\u5173\u95ed\u3002</li> </ul> </li> <li> <p>\u539f\u5b50\u6027\u4fdd\u969c</p> <ul> <li><code>xIE</code> \u4f4d\u4f4d\u4e8e <code>mstatus</code> \u4f4e\u4f4d\uff0c\u53ef\u7528\u5355\u6761 CSR \u6307\u4ee4\u539f\u5b50\u5730\u5f00/\u5173\u4e2d\u65ad\uff0c\u786e\u4fdd\u4e2d\u65ad\u5904\u7406\u7684\u539f\u5b50\u6027\u3002</li> </ul> </li> <li> <p>\u4e24\u7ea7\u4e2d\u65ad\u4e0e\u7279\u6743\u6808 (Two-Level Stack)</p> <ul> <li>xPIE\uff1a\u4fdd\u5b58\u9677\u5165\u524d <code>xIE</code> \u7684\u503c\u3002</li> <li>xPP\uff1a\u4fdd\u5b58\u9677\u5165\u524d\u7684\u7279\u6743\u7ea7\uff0cM-mode \u662f 2 \u4f4d\uff0cS-mode \u662f 1 \u4f4d\u3002</li> <li>\u9677\u5165\u65f6\uff1a<ul> <li><code>xPIE \u2190 xIE</code></li> <li><code>xIE \u2190 0</code>\uff08\u8fdb\u5165\u9677\u5165\u65f6\u4e2d\u65ad\u4f1a\u88ab\u5173\u95ed\uff09</li> <li><code>xPP \u2190 y</code>\uff08\u4fdd\u5b58\u4e4b\u524d\u7684\u7279\u6743\u7ea7 y\uff09</li> </ul> </li> </ul> </li> <li> <p>\u8fd4\u56de\u6307\u4ee4 xRET \u7684\u884c\u4e3a</p> <ul> <li>\u4ece\u9677\u5165\u8fd4\u56de\u65f6\uff1a<ul> <li><code>xIE \u2190 xPIE</code></li> <li>\u7279\u6743\u7ea7 \u2190 <code>xPP</code></li> <li><code>xPIE \u2190 1</code></li> <li><code>xPP \u2190 \u6700\u4f4e\u652f\u6301\u7684\u7279\u6743\u7ea7</code>\uff08\u5e2e\u52a9\u68c0\u6d4b\u8f6f\u4ef6\u7ba1\u7406\u9519\u8bef\uff09</li> </ul> </li> <li>\u5982\u679c\u8fd4\u56de\u7684\u7279\u6743\u7ea7 \u2260 M\uff0c<code>MPRV</code> \u88ab\u6e05\u96f6\u3002</li> </ul> </li> <li> <p>\u9677\u5165\u5904\u7406\u7684\u5b89\u5168\u6027\u8981\u6c42</p> <ul> <li>\u9677\u5165\u5904\u7406\u5fc5\u987b\u907f\u514d\u5728\u5173\u952e\u72b6\u6001\u4fdd\u5b58\u9636\u6bb5\u5f00\u542f\u4e2d\u65ad\u6216\u5f15\u53d1\u5f02\u5e38\uff0c\u907f\u514d\uff1a<ul> <li>\u8986\u76d6\u5173\u952e\u72b6\u6001\uff0c\u5bfc\u81f4\u6062\u590d\u5931\u8d25\u3002</li> <li>\u9677\u5165\u5904\u7406\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u65e0\u9650\u9012\u5f52\u9677\u5165\u3002</li> </ul> </li> <li>\u9700\u8981\u5c0f\u5fc3\u8bbe\u8ba1\uff0c\u786e\u4fdd\u5f02\u5e38\u5728\u5b89\u5168\u7684\u9636\u6bb5\u88ab\u6b63\u786e\u5904\u7406\u3002</li> </ul> </li> </ol> </li> <li> <p>3.1.9. Machine Interrupt (mip and mie) Registers</p> <p>\u8003\u70b9</p> <ul> <li>mip \u548c mie \u5bc4\u5b58\u5668\u7684\u4f5c\u7528\u5206\u522b\u662f\u4ec0\u4e48\uff1f</li> <li>\u5728\u4ec0\u4e48\u6761\u4ef6\u4e0b\uff0c\u4e2d\u65ad\u4f1a\u9677\u5165 M \u6a21\u5f0f\uff1f</li> <li>\u4e3a\u4ec0\u4e48\u8f6f\u4ef6\u4e2d\u65ad\u7684\u4f18\u5148\u7ea7\u9ad8\u4e8e\u5b9a\u65f6\u5668\u4e2d\u65ad\uff1f</li> </ul> \u8981\u70b9\uff1amip \u548c mie <ul> <li> <p>\u57fa\u672c\u529f\u80fd</p> <ul> <li>mip (Machine Interrupt Pending)\uff1a\u4fdd\u5b58\u6302\u8d77\u4e2d\u65ad\u7684\u4fe1\u606f</li> <li>mie (Machine Interrupt Enable)\uff1a\u63a7\u5236\u5404\u7c7b\u4e2d\u65ad\u662f\u5426\u88ab\u4f7f\u80fd</li> <li>\u4f4d i \u5bf9\u5e94\u4e2d\u65ad\u539f\u56e0\u7f16\u53f7 i\uff08\u4e0e <code>mcause</code> \u5bc4\u5b58\u5668\u4e2d\u7684\u4e2d\u65ad\u539f\u56e0\u7f16\u53f7\u5bf9\u5e94\uff09</li> <li>\u6807\u51c6\u4e2d\u65ad\u4f4d\uff1a\u53ea\u5360\u7528 bits 15:0\uff0cbit 16 \u53ca\u4ee5\u4e0a\u4e3a\u5e73\u53f0\u81ea\u5b9a\u4e49</li> </ul> </li> <li> <p>\u4e2d\u65ad\u89e6\u53d1\u6761\u4ef6</p> <p>\u4e00\u4e2a\u4e2d\u65ad i \u4f1a\u5bfc\u81f4\u9677\u5165 M \u6a21\u5f0f\uff0c\u9700\u6ee1\u8db3\u4ee5\u4e0b\u6761\u4ef6\uff1a</p> <ol> <li>\u5f53\u524d\u7279\u6743\u6a21\u5f0f\u662f M \u4e14 mstatus.MIE = 1\uff0c\u6216\u5f53\u524d\u7279\u6743\u6a21\u5f0f &lt; M</li> <li>mip[i] = 1 \u4e14 mie[i] = 1</li> <li>\u5982\u679c\u5b58\u5728 mideleg\uff0c\u5219 mideleg[i] = 0</li> </ol> <p>\u8fd9\u4e9b\u6761\u4ef6\u5728\u4ee5\u4e0b\u60c5\u51b5\u4e0b\u5fc5\u987b\u53ca\u65f6\u91cd\u65b0\u8bc4\u4f30\uff1a</p> <ul> <li>\u4e2d\u65ad\u6302\u8d77\u72b6\u6001\u53d8\u5316</li> <li>\u6267\u884c <code>xRET</code> \u6307\u4ee4</li> <li>\u663e\u5f0f\u5199\u5165 mip/mie/mstatus/mideleg</li> </ul> </li> <li> <p>\u4e2d\u65ad\u4f18\u5148\u7ea7\u4e0e\u53ef\u5199\u6027</p> <ul> <li>M \u6a21\u5f0f\u4e2d\u65ad\u4f18\u5148\u7ea7\u6700\u9ad8</li> <li>\u6bcf\u4e2a mip \u4f4d\u53ef\u80fd\u662f \u53ea\u8bfb \u6216 \u53ef\u5199\uff1a<ul> <li>\u82e5\u53ef\u5199\uff0c\u4e2d\u65ad\u53ef\u901a\u8fc7\u5199 0 \u6e05\u9664\u6302\u8d77\u72b6\u6001</li> <li>\u82e5\u53ea\u8bfb\uff0c\u5fc5\u987b\u901a\u8fc7\u5176\u4ed6\u673a\u5236\u6e05\u9664\u6302\u8d77\u72b6\u6001</li> </ul> </li> <li>mie \u4e2d\u53ef\u5199\u4f4d\uff1a\u53ea\u6709\u80fd\u6302\u8d77\u7684\u4e2d\u65ad\u624d\u80fd\u5728 mie \u4e2d\u88ab\u8bbe\u7f6e\uff1b\u4e0d\u53ef\u5199\u7684\u5fc5\u987b\u4e3a 0</li> </ul> </li> <li> <p>\u6807\u51c6\u4e2d\u65ad\u4f4d\u5206\u914d\uff08bits 15:0\uff09</p> \u4e2d\u65ad\u7c7b\u578b Pending \u4f4d Enable \u4f4d \u53ef\u5199\u6027 / \u6765\u6e90 \u5916\u90e8\u4e2d\u65ad (M \u7ea7) mip.MEIP mie.MEIE MEIP \u53ea\u8bfb\uff0c\u5e73\u53f0\u4e2d\u65ad\u63a7\u5236\u5668\u7ba1\u7406 \u5b9a\u65f6\u5668\u4e2d\u65ad (M \u7ea7) mip.MTIP mie.MTIE MTIP \u53ea\u8bfb\uff0c\u901a\u8fc7\u5199 mtimecmp \u6e05\u9664 \u8f6f\u4ef6\u4e2d\u65ad (M \u7ea7) mip.MSIP mie.MSIE MSIP \u53ea\u8bfb\uff0c\u901a\u8fc7\u5185\u5b58\u6620\u5c04\u5bc4\u5b58\u5668\u8bbe\u7f6e \u5916\u90e8\u4e2d\u65ad (S \u7ea7) mip.SEIP mie.SEIE SEIP \u53ef\u5199\uff0c\u7528\u4e8e S \u6a21\u62df\u5916\u90e8\u4e2d\u65ad \u5b9a\u65f6\u5668\u4e2d\u65ad (S \u7ea7) mip.STIP mie.STIE STIP \u53ef\u5199\uff0c\u7528\u4e8e S \u6a21\u62df\u5b9a\u65f6\u5668\u4e2d\u65ad \u8f6f\u4ef6\u4e2d\u65ad (S \u7ea7) mip.SSIP mie.SSIE SSIP \u53ef\u5199\uff0c\u53ef\u7531\u5e73\u53f0\u4e2d\u65ad\u63a7\u5236\u5668\u8bbe\u7f6e \u672c\u5730\u8ba1\u6570\u6ea2\u51fa\u4e2d\u65ad mip.LCOFIP mie.LCOFIE Sscofpmf \u6269\u5c55\u652f\u6301\uff0cR/W\uff1b\u5426\u5219\u6052\u4e3a 0 </li> <li> <p>\u4e2d\u65ad\u4f18\u5148\u7ea7\u987a\u5e8f\uff08\u9ad8 \u2192 \u4f4e\uff09</p> <ol> <li>MEI (Machine External Interrupt)</li> <li>MSI (Machine Software Interrupt)</li> <li>MTI (Machine Timer Interrupt)</li> <li>SEI (Supervisor External Interrupt)</li> <li>SSI (Supervisor Software Interrupt)</li> <li>STI (Supervisor Timer Interrupt)</li> <li>LCOFI (Local Counter Overflow Interrupt)</li> </ol> <p>\u8bbe\u8ba1\u539f\u5219\uff1a</p> <ul> <li>\u9ad8\u7279\u6743\u7ea7\u4e2d\u65ad\u4f18\u5148\u4e8e\u4f4e\u7279\u6743\u7ea7\u4e2d\u65ad\uff08\u652f\u6301\u62a2\u5360\uff09</li> <li>\u5916\u90e8\u4e2d\u65ad\u4f18\u5148\u4e8e\u5185\u90e8\u4e2d\u65ad\uff08\u8bbe\u5907\u54cd\u5e94\u8981\u6c42\u9ad8\uff09</li> <li>\u8f6f\u4ef6\u4e2d\u65ad\u4f18\u5148\u4e8e\u5b9a\u65f6\u5668\u4e2d\u65ad\uff08\u7528\u4e8e\u591a\u6838\u6d88\u606f\u4f20\u9012\uff09</li> </ul> </li> <li> <p>S \u6a21\u5f0f\u76f8\u5173\uff08\u5728\u4e0b\u4e00\u8282\u5b66\u4e60\uff09</p> <ul> <li>S \u6a21\u5f0f\u901a\u8fc7 sip / sie \u5bc4\u5b58\u5668\u770b\u5230\u59d4\u6d3e\u8fc7\u6765\u7684\u4e2d\u65ad</li> <li>\u5982\u679c mideleg[i] = 1\uff0c\u4e2d\u65ad i \u88ab\u59d4\u6d3e\u5230 S \u6a21\u5f0f\uff0c\u5426\u5219 sip/sie \u4e2d\u5bf9\u5e94\u4f4d\u4e3a 0</li> </ul> </li> </ul> </li> <li> <p>3.1.7. Machine Trap-Vector Base-Address (mtvec) Register</p> <p>\u8003\u70b9</p> <ul> <li>mtvec \u5bc4\u5b58\u5668\u7684\u4f5c\u7528\u662f\u4ec0\u4e48\uff1f</li> <li>\u4e3a\u4ec0\u4e48\u8fd9\u4e2a\u5bc4\u5b58\u5668\u7684\u4f4e\u4e24\u4f4d\u53ef\u4ee5\u5206\u914d\u7ed9 MODE \u5b57\u6bb5\uff1f</li> <li>\u5411\u91cf\u4e2d\u65ad\u6a21\u5f0f\u4e0b\uff0c\u53d1\u751f\u4e2d\u65ad\u540e PC \u4f1a\u88ab\u8bbe\u7f6e\u6210\u591a\u5c11\uff1f</li> </ul> </li> <li> <p>3.1.8. Machine Trap Delegation (medeleg and mideleg) Registers</p> <p>\u8003\u70b9</p> <ul> <li>\u4e3a\u4ec0\u4e48\u9700\u8981\u59d4\u6d3e\u673a\u5236\uff1f</li> <li>medeleg \u548c mideleg \u5bc4\u5b58\u5668\u7684\u4f5c\u7528\u5206\u522b\u662f\u4ec0\u4e48\uff1f</li> <li>\u5f53\u4e00\u4e2a trap \u88ab\u59d4\u6d3e\u5230 S \u6a21\u5f0f\u540e\uff0c\u4e0b\u9762\u8fd9\u4e9b\u5730\u65b9\u7684\u503c\u4f1a\u5982\u4f55\u53d8\u5316\uff1f<ul> <li>scause</li> <li>stval</li> <li>sepc</li> <li>mstatus.SPP</li> <li>mstatus.SPIE</li> <li>mstatus.SIE</li> </ul> </li> <li>\u5982\u679c\u4e00\u4e2a trap \u662f\u5728 M \u6a21\u5f0f\u4e0b\u53d1\u751f\u7684\uff0c\u4f46\u5b83\u5728 medeleg \u4e2d\u5df2\u88ab\u8bbe\u7f6e\u59d4\u6d3e\u7ed9 S \u6a21\u5f0f\uff0c\u4f1a\u5728\u54ea\u91cc\u5904\u7406\uff1f</li> <li>mideleg \u4e2d\u7684\u67d0\u4e00\u4f4d\u88ab\u8bbe\u7f6e\u540e\uff0c\u8fd9\u4e2a\u4e2d\u65ad\u5728 M \u6a21\u5f0f\u4e0b\u4f1a\u88ab\u89e6\u53d1\u5417\uff1f</li> </ul> </li> <li> <p>3.1.14. Machine Exception Program Counter (mepc) Register \u548c 3.1.15. Machine Cause (mcause) Register \u548c 3.1.16. Machine Trap Value (mtval) Register</p> <p>\u8003\u70b9</p> <ul> <li>mepc\u3001mcause\u3001mtval \u5bc4\u5b58\u5668\u7684\u4f5c\u7528\u662f\u4ec0\u4e48\uff1f</li> <li>mcause \u5bc4\u5b58\u5668\u4e2d\uff0c\u4e2d\u65ad\u548c\u5f02\u5e38\u7684\u533a\u522b\u662f\u4ec0\u4e48\uff1f</li> </ul> </li> </ul> <p>\u603b\u7ed3\u4e00\u4e0b\uff0c\u6211\u4eec\u5b66\u4e60\u4e86 M \u6a21\u5f0f\u7684\u51e0\u4e2a\u5173\u952e CSR \u5bc4\u5b58\u5668\uff1a</p> <pre><code>mstatus mip mie mtvec medeleg mideleg mepc mcause mtval\n</code></pre> <p>S \u6a21\u5f0f\u4e5f\u6709\u51e0\u4e2a\u5bf9\u5e94\u7684 CSR \u5bc4\u5b58\u5668\uff1a</p> <pre><code>sstatus sip sie stvec scause sepc stval\n</code></pre> <p>\u5b83\u4eec\u7684\u4f5c\u7528\u548c M \u6a21\u5f0f\u7c7b\u4f3c\uff0c\u8bf7\u540c\u5b66\u4eec\u5728\u540e\u7eed\u5b9e\u9a8c\u7528\u5230\u65f6\u81ea\u884c\u9605\u8bfb 12.1. Supervisor CSRs\u3002</p> <p>\u52a8\u624b\u505a</p> <p>\u65ad\u70b9\u6253\u5728\u5185\u6838\u7b2c\u4e00\u6761\u6307\u4ee4\u5904\uff0c\u4f7f\u7528 QEMU Monitor \u67e5\u770b\u6b64\u65f6 CSR \u5bc4\u5b58\u5668\u7684\u72b6\u6001\u3002\u89e3\u91ca\u672c\u8282\u5b66\u4e60\u7684\u6240\u6709 M\u3001S \u6a21\u5f0f CSR \u5bc4\u5b58\u5668\u7684\u503c\u7684\u542b\u4e49\u3002\u4f60\u4f1a\u53d1\u73b0\u6709\u4e9b S \u6a21\u5f0f\u5bc4\u5b58\u5668\u6ca1\u6709\u5728 QEMU \u4e2d\u5c55\u793a\uff0c\u8fd9\u5e76\u4e0d\u662f\u4e00\u4e2a Bug\uff0c\u8bf7\u67e5\u770b RISC-V sstatus register is missing in qemu console / gdb (#1260) \u00b7 Issue \u00b7 qemu-project/qemu \u4e86\u89e3\u539f\u56e0\u3002</p> <p>\u52a8\u624b\u505a</p> <p>\u79fb\u9664\u4f60\u5728 Task1 \u505a\u7684\u5de5\u4f5c\uff0c\u7136\u540e\uff1a</p> <ul> <li>\u5728 <code>_start()</code> \u6253\u65ad\u70b9\uff0c\u7136\u540e\u5355\u6b65\u8c03\u8bd5\uff0c\u8fdb\u5165 <code>start_kernel()</code> \u540e\u7a0b\u5e8f\u80fd\u987a\u5229\u8df3\u8f6c\u5230 <code>printk()</code> \u5417\uff1f\u5982\u679c\u4e0d\u987a\u5229\uff0c\u68c0\u67e5\u5408\u9002\u7684 CSR \u5bc4\u5b58\u5668\uff0c\u770b\u770b\u53d1\u751f\u4e86\u4ec0\u4e48\u5f02\u5e38\uff1f</li> <li>\u5220\u6389\u5728 <code>_start()</code> \u6253\u7684\u65ad\u70b9\uff0c\u5728 <code>printk()</code> \u5165\u53e3\u5904\u6253\u65ad\u70b9\uff0c\u7136\u540e\u7ee7\u7eed\u8fd0\u884c\uff08continue\uff09\uff0c\u4f60\u4f1a\u53d1\u73b0\u6700\u7ec8\u80fd\u591f\u5230\u8fbe <code>printk()</code> \u505c\u4e0b\u6765\uff0c\u8fd9\u662f\u4e3a\u4ec0\u4e48\uff1f</li> </ul> <p>\uff08\u63a2\u7a76\u7ed3\u675f\u540e\u8bb0\u5f97 Task1 \u7684\u5de5\u4f5c\u8fd8\u539f\u56de\u53bb\uff09</p>"},{"location":"lab1/#\u7279\u6743\u6307\u4ee4","title":"\u7279\u6743\u6307\u4ee4","text":"<p>\u7136\u540e\uff0c\u7279\u6743\u7ea7\u6709\u51e0\u4e2a\u7279\u6743\u6307\u4ee4\uff0c\u73b0\u5728\u6211\u4eec\u53ea\u5173\u6ce8 xRET\u3002\u8bf7\u9605\u8bfb 3.3.2. Trap-Return Instructions\u3002</p> <p>\u8003\u70b9</p> <ul> <li>xRET \u6307\u4ee4\u7684\u4f5c\u7528\u662f\u4ec0\u4e48\uff1f</li> <li>xRET \u6307\u4ee4\u6267\u884c\u540e\uff0cCSR \u5bc4\u5b58\u5668\u4f1a\u5982\u4f55\u53d8\u5316\uff1fPC \u7684\u503c\u4f1a\u5982\u4f55\u53d8\u5316\uff1f</li> </ul>"},{"location":"lab1/#zicsr-\u6269\u5c55","title":"Zicsr \u6269\u5c55","text":"<p>\u6700\u540e\uff0c\u6211\u4eec\u5c06\u9605\u8bfb Zicsr \u6269\u5c55\uff0c\u4e86\u89e3\u5982\u4f55\u64cd\u63a7 CSR \u5bc4\u5b58\u5668\u3002</p> <ul> <li> <p>\u975e\u7279\u6743\u7ea7\u624b\u518c 6. \"Zicsr\", Extension for Control and Status Register (CSR) Instructions, Version 2.0</p> \u8981\u70b9 <ul> <li>\u638c\u63e1\u56db\u4e2a\u6807\u51c6 CSR \u6307\u4ee4\u7684\u7528\u6cd5\uff1a<ul> <li>RW: Read/Write</li> <li>RS: Read and Set bits</li> <li>RC: Read and Clear bits</li> <li>RWI/RSI/RCI: Immediate versions</li> </ul> </li> <li>\u638c\u63e1\u56db\u4e2a CSR \u4f2a\u6307\u4ee4\u7684\u7528\u6cd5\uff1a<ul> <li>R: Read</li> <li>W: Write</li> <li>S: Set bits</li> <li>C: Clear bits</li> <li>WI/SI/CI: Immediate versions</li> </ul> </li> </ul> </li> </ul>"},{"location":"lab1/#task3-trap-handler","title":"Task3: Trap Handler","text":"<p>\u73b0\u5728\u4f60\u5df2\u7ecf\u5168\u9762\u4e86\u89e3\u4e86 RISC-V \u7684\u4e2d\u65ad\u4e0e\u5f02\u5e38\u673a\u5236\u4ee5\u53ca CSR \u5728\u5176\u4e2d\u626e\u6f14\u7684\u91cd\u8981\u89d2\u8272\u3002\u8ba9\u6211\u4eec\u7528\u7b80\u5355\u7684 S \u6a21\u5f0f\u8f6f\u4ef6\u4e2d\u65ad\u6765\u5b9e\u8df5\u8fd9\u4e9b\u77e5\u8bc6\u3002</p> <p>\u4f60\u7684\u4efb\u52a1\u662f\uff1a</p> <ul> <li> <p>\u8865\u5168 <code>arch/riscv/include/sbi.h</code> \u4e2d\u7684 <code>csr_*()</code> \u5b8f\u51fd\u6570\u3002</p> <p>\u5b8f\u51fd\u6570\u7684\u8bed\u6cd5\u5e94\u8be5\u5728\u5927\u4e00\u7684 C \u8bed\u8a00\u8bfe\u7a0b\u4e2d\u5b66\u4e60\u8fc7\uff0c\u5982\u679c\u4f60\u5fd8\u8bb0\u4e86\uff0c\u53ef\u4ee5\u9605\u8bfb Replacing text macros - cppreference.com\u3002</p> </li> <li> <p>\u5728 <code>start_kernel()</code> \u4e2d\uff1a</p> <ul> <li>\u6253\u5370 <code>sstatus</code>\u3001<code>sie</code> \u548c <code>sip</code> \u7684\u503c</li> <li>\u5c06 <code>sie</code> \u8bbe\u7f6e\u4e3a\u5408\u9002\u7684\u503c\uff0c\u4f7f\u5f97\u53ea\u6709\u8f6f\u4ef6\u4e2d\u65ad\u88ab\u4f7f\u80fd</li> <li>\u5c06 <code>sstatus</code> \u8bbe\u7f6e\u4e3a\u5408\u9002\u7684\u503c\uff0c\u4f7f\u80fd S \u6a21\u5f0f\u4e2d\u65ad</li> <li>\u5c06 <code>sip</code> \u8bbe\u7f6e\u4e3a\u5408\u9002\u7684\u503c\uff0c\u7acb\u523b\u89e6\u53d1\u4e00\u4e2a\u8f6f\u4ef6\u4e2d\u65ad</li> </ul> </li> <li> <p>\u5728 <code>head.S</code> \u4e2d\uff0c\u5199\u5165\u5408\u9002\u7684 CSR \u5bc4\u5b58\u5668\uff0c\u5c06\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\u8bbe\u7f6e\u4e3a <code>_traps</code></p> </li> <li>\u5728 <code>entry.S</code> \u4e2d\uff0c\u8865\u5168 <code>_traps()</code></li> <li> <p>\u5728 <code>trap.c</code> \u4e2d\uff0c\u5b8c\u6210\u8f6f\u4ef6\u4e2d\u65ad\u7684\u5904\u7406</p> <ul> <li>\u6ce8\u610f\uff0c\u6211\u4eec\u603b\u662f\u628a\u5177\u4f53\u7684\u4e2d\u65ad\u5904\u7406\u5305\u88c5\u4e3a\u4e00\u4e2a\u51fd\u6570\uff0c\u7136\u540e\u5728 <code>trap_handler()</code> \u7684 <code>switch</code> \u8bed\u53e5\u4e2d\u8c03\u7528\u3002\u8fd9\u662f\u56e0\u4e3a C \u8bed\u8a00\u4e0d\u592a\u597d\u76f4\u63a5\u5728 <code>switch</code> \u8bed\u53e5\u91cc\u58f0\u660e\u53d8\u91cf\u7b49\uff0c\u4f1a\u5f15\u8d77\u5b9a\u4e49\u57df\u95ee\u9898\uff0c\u6240\u4ee5\u603b\u662f\u7528\u4e00\u4e2a\u51fd\u6570\u8fdb\u884c\u5305\u88c5\u3002\u8f6f\u4ef6\u4e2d\u65ad\u7684\u5904\u7406\u51fd\u6570\u662f <code>clear_ssip()</code>\u3002</li> <li>\u5728 <code>trap.c</code> \u7684\u524d\u534a\u90e8\u5206\uff0c\u6846\u67b6\u5df2\u7ecf\u5e2e\u540c\u5b66\u4eec\u51c6\u5907\u597d\u4e86\u5404\u79cd <code>scause</code> \u7684\u5b8f\u5b9a\u4e49\uff0c\u540c\u5b66\u4eec\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u3002</li> </ul> </li> </ul> <p>\u8bf7\u4f60\u601d\u8003\u4ee5\u4e0b\u95ee\u9898\uff0c\u518d\u8865\u5168 <code>_traps()</code>\uff1a</p> <ul> <li> <p>Trap \u968f\u65f6\u53ef\u80fd\u53d1\u751f\u3002\u56e0\u6b64\uff0cTrap Handler \u7684\u9996\u8981\u5de5\u4f5c\u662f\u4fdd\u5b58\u73b0\u573a\uff0c\u5e76\u5728\u5b8c\u6210 Trap \u5904\u7406\u540e\u6062\u590d\u73b0\u573a\uff0c\u4fdd\u8bc1\u88ab\u4e2d\u65ad\u7684\u7a0b\u5e8f\u7684\u6267\u884c\u4e0d\u53d7\u5f71\u54cd\u3002</p> <p>\u4e3a\u4ec0\u4e48\u9700\u8981\u4fdd\u5b58\u73b0\u573a\u5462\uff1f\u56e0\u4e3a\u63a5\u4e0b\u6765 Trap \u5904\u7406\u7a0b\u5e8f\u4e5f\u4f1a\u4f7f\u7528\u4e00\u4e9b\u5bc4\u5b58\u5668\uff0c\u5982\u679c\u8fd9\u4e9b\u5bc4\u5b58\u5668\u6b63\u5728\u88ab\u88ab\u4e2d\u65ad\u7684\u7a0b\u5e8f\u4f7f\u7528\uff0c\u6570\u636e\u5c31\u4e22\u5931\u4e86\uff0c\u5bfc\u81f4\u88ab\u4e2d\u65ad\u7684\u7a0b\u5e8f\u65e0\u6cd5\u6b63\u786e\u6062\u590d\u6267\u884c\u3002</p> <p>\u4e3a\u6b64\uff0c\u6709\u54ea\u4e9b\u5185\u5bb9\u9700\u8981\u4fdd\u5b58\uff1f\u4fdd\u5b58\u5230\u54ea\u91cc\uff1f</p> <ul> <li>\u56de\u987e RISC-V \u8c03\u7528\u7ea6\u5b9a\uff0c\u5b83\u4e3a\u4e86\u4fdd\u5b58 caller \u7684\u4e0a\u4e0b\u6587\uff0c\u662f\u600e\u4e48\u505a\u7684\uff1f</li> <li><code>mtvec</code> \u6307\u5411\u4e86 OpenSBI \u7684\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 Lab0 \u4e2d\u5b66\u4e60\u7684\u8c03\u8bd5\u77e5\u8bc6\uff0c\u5c06\u5b83\u7684\u6c47\u7f16\u6253\u5370\u51fa\u6765\uff0c\u5206\u6790\u5b83\u662f\u5982\u4f55\u5de5\u4f5c\u7684\u3002</li> </ul> </li> <li> <p><code>_traps()</code> \u7684\u7b2c\u4e8c\u4e2a\u4f5c\u7528\u662f\u8df3\u8f6c\u5230 <code>trap.c</code> \u4e2d\u7684 <code>trap_handler()</code> \u51fd\u6570\uff0c\u56e0\u4e3a C \u8bed\u8a00\u7f16\u7a0b\u66f4\u65b9\u4fbf\uff0c\u6211\u4eec\u5f53\u7136\u60f3\u7528 C \u8bed\u8a00\u5b8c\u6210\u5177\u4f53\u7684 Trap \u5904\u7406\u5de5\u4f5c\u3002\u4f60\u9700\u8981\u5411 <code>trap_handler()</code> \u4f20\u9012\u54ea\u4e9b\u53c2\u6570\uff1f</p> </li> <li><code>_traps()</code> \u975e\u5f97\u7528\u6c47\u7f16\u5199\u5417\uff1f\u76f4\u63a5\u6307\u5411 <code>trap_handler()</code> \u53ef\u4ee5\u5417\uff1f</li> </ul> <p>\u5b8c\u6210\u6761\u4ef6</p> <ul> <li>\u6210\u529f\u8fdb\u5165\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\uff0c\u5e76\u4e14\u6b63\u786e\u8bc6\u522b\u5230\u8f6f\u4ef6\u4e2d\u65ad\u3002</li> <li>\u6210\u529f\u4ece\u4e2d\u65ad\u7a0b\u5e8f\u9000\u51fa\uff0c\u8fd4\u56de <code>start_kernel()</code> \u5e76\u7ee7\u7eed\u6267\u884c\u540e\u7eed\u7684\u8f93\u51fa\u3002</li> <li>\u901a\u8fc7\u8bc4\u6d4b\u6846\u67b6\u7684 Lab1 Task3 \u6d4b\u8bd5\u3002</li> </ul>"},{"location":"lab1/#\u65f6\u949f\u4e2d\u65ad","title":"\u65f6\u949f\u4e2d\u65ad","text":"<p>\u9605\u8bfb 3.2.1. Machine Timer (mtime and mtimecmp) Registers\uff0c\u4e86\u89e3 RISC-V \u7684\u65f6\u949f\u4e2d\u65ad\u673a\u5236\uff1a</p> <p>\u8003\u70b9</p> <ul> <li>mtime \u548c mtimecmp \u5bc4\u5b58\u5668\u7684\u4f5c\u7528\u5206\u522b\u662f\u4ec0\u4e48\uff1f</li> <li>mtime \u8bb0\u5f55\u7684\u6570\u503c\u662f CPU \u65f6\u949f\u5468\u671f\u5417\uff1f</li> <li>M \u6a21\u5f0f\u65f6\u949f\u4e2d\u65ad\u6302\u8d77\u7684\u6761\u4ef6\u662f\u4ec0\u4e48\uff1f</li> <li>\u8981\u8ba9 CPU \u54cd\u5e94 M \u6a21\u5f0f\u65f6\u949f\u4e2d\u65ad\uff0c\u9700\u8981\u5982\u4f55\u8bbe\u7f6e CSR \u5bc4\u5b58\u5668\uff1f</li> </ul> \u8981\u70b9\uff1amtime \u548c mtimecmp <ul> <li> <p>mtime \u5bc4\u5b58\u5668</p> <ul> <li>\u5e73\u53f0\u63d0\u4f9b\u4e00\u4e2a\u5185\u5b58\u6620\u5c04\u7684\u673a\u5668\u6a21\u5f0f\u8bfb\u5199\u5bc4\u5b58\u5668 <code>mtime</code>\uff0c\u4f5c\u4e3a\u5b9e\u65f6\u65f6\u949f</li> <li><code>mtime</code> \u4ee5\u56fa\u5b9a\u9891\u7387\u9012\u589e\uff0c\u63d0\u4f9b\u673a\u5236\u786e\u5b9a\u5176\u5468\u671f</li> <li><code>mtime</code> \u6ea2\u51fa\u540e\u4f1a\u56de\u7ed5</li> <li>\u6240\u6709 RV32 \u548c RV64 \u7cfb\u7edf\u4e2d\uff0c<code>mtime</code> \u90fd\u662f 64 \u4f4d\u7cbe\u5ea6</li> </ul> </li> <li> <p>mtimecmp \u5bc4\u5b58\u5668\u4e0e\u4e2d\u65ad</p> <ul> <li><code>mtimecmp</code> \u4e5f\u662f 64 \u4f4d\u5185\u5b58\u6620\u5c04\u673a\u5668\u6a21\u5f0f\u5b9a\u65f6\u5668\u6bd4\u8f83\u5bc4\u5b58\u5668</li> <li>\u5f53 <code>mtime \u2265 mtimecmp</code> \u65f6\uff0c\u673a\u5668\u5b9a\u65f6\u5668\u4e2d\u65ad\u6302\u8d77</li> <li>\u4e2d\u65ad\u4f1a\u4e00\u76f4\u6302\u8d77\uff0c\u76f4\u5230 <code>mtimecmp &gt; mtime</code>\uff08\u901a\u5e38\u901a\u8fc7\u5199\u5165\u65b0\u7684 mtimecmp \u503c\u5b9e\u73b0\uff09</li> <li>\u4e2d\u65ad\u9700 \u542f\u7528\u5168\u5c40\u4e2d\u65ad \u4e14 mie \u5bc4\u5b58\u5668\u4e2d MTIE \u4f4d\u7f6e 1 \u624d\u4f1a\u88ab\u54cd\u5e94</li> </ul> </li> <li> <p>\u8bbe\u8ba1\u539f\u56e0\u4e0e\u786c\u4ef6\u7279\u6027</p> <ul> <li>\u5b9a\u65f6\u5668\u57fa\u4e8e\u6302\u949f\u65f6\u95f4\uff08wall-clock time\uff09\uff0c\u652f\u6301\u52a8\u6001\u7535\u538b\u548c\u9891\u7387\u8c03\u6574\u7684\u5904\u7406\u5668</li> <li>\u5b9e\u65f6\u65f6\u949f\uff08RTC\uff09\u6210\u672c\u9ad8\uff0c\u901a\u5e38\u7cfb\u7edf\u4e2d\u53ea\u6709\u4e00\u4e2a\uff0c\u4e14\u4e0e CPU \u4e0d\u5728\u540c\u4e00\u7535\u538b/\u9891\u7387\u57df</li> <li>\u901a\u8fc7\u5185\u5b58\u6620\u5c04\u800c\u975e CSR \u66b4\u9732 mtime\uff0c\u4fbf\u4e8e\u591a\u4e2a hart \u5171\u4eab RTC</li> </ul> </li> <li> <p>\u4f4e\u7279\u6743\u7ea7\u4e0e\u865a\u62df\u5b9a\u65f6\u5668</p> <ul> <li>\u4f4e\u7279\u6743\u7ea7\u6ca1\u6709\u81ea\u5df1\u7684 timecmp \u5bc4\u5b58\u5668</li> <li>\u673a\u5668\u6a21\u5f0f\u8f6f\u4ef6\u53ef\u901a\u8fc7\u590d\u7528 <code>mtimecmp</code> \u5b9e\u73b0\u591a\u4e2a\u865a\u62df\u5b9a\u65f6\u5668</li> </ul> </li> <li> <p>\u6bd4\u8f83\u4e0e\u4e2d\u65ad\u884c\u4e3a</p> <ul> <li><code>mtime</code> \u4e0e <code>mtimecmp</code> \u6bd4\u8f83\u7ed3\u679c\u7684\u53d8\u5316\u4f1a\u6700\u7ec8\u53cd\u6620\u5230 MTIP\uff0c\u4f46\u53ef\u80fd\u6709\u5ef6\u8fdf</li> <li>\u53ef\u80fd\u51fa\u73b0\u4f2a\u4e2d\u65ad\uff1a\u5904\u7406\u7a0b\u5e8f\u521a\u5199\u5165 <code>mtimecmp</code> \u540e\u7acb\u5373\u8fd4\u56de\u65f6\uff0c\u4e2d\u65ad\u53ef\u80fd\u8fd8\u672a\u6e05\u9664</li> </ul> </li> <li> <p>RV32 \u548c RV64 \u7684\u533a\u522b</p> <ul> <li>RV32\uff1a\u5199\u5165 <code>mtimecmp</code> \u65f6\u9700\u5206\u4e24\u6b21\u5199 32 \u4f4d\u503c\uff0c\u907f\u514d\u56e0\u4e2d\u95f4\u503c\u8fc7\u5c0f\u800c\u89e6\u53d1\u4f2a\u4e2d\u65ad</li> <li>RV64\uff1a\u652f\u6301\u81ea\u7136\u5bf9\u9f50\u7684 64 \u4f4d\u539f\u5b50\u8bbf\u95ee\uff0c\u7b80\u5316\u5199\u5165\u64cd\u4f5c</li> </ul> </li> <li> <p>time \u4e0e timeh CSR</p> <ul> <li><code>time</code> \u662f <code>mtime</code> \u7684\u53ea\u8bfb\u5f71\u5b50\u5bc4\u5b58\u5668</li> <li>RV32 \u4e0b\uff0c<code>timeh</code> \u5f71\u5c04\u9ad8 32 \u4f4d\uff0c<code>time</code> \u5f71\u5c04\u4f4e 32 \u4f4d</li> <li><code>mtime</code> \u53d8\u5316\u4f1a\u6700\u7ec8\u53cd\u6620\u5728 <code>time</code>/<code>timeh</code>\uff0c\u4f46\u53ef\u80fd\u6709\u5ef6\u8fdf</li> </ul> </li> </ul> <p>\u5f88\u53ef\u60dc <code>mtime</code> \u548c <code>mtimecmp</code> \u4ec5\u4f9b M \u6a21\u5f0f\u4f7f\u7528\uff0c\u8ba9 OpenSBI \u7b49 M \u6a21\u5f0f\u8f6f\u4ef6\u80fd\u591f\u611f\u77e5\u65f6\u95f4\u6d41\u901d\u3002\u90a3\u6211\u4eec\u7684 S \u6a21\u5f0f\u5185\u6838\u5462\uff1f\u9996\u5148\u60f3\u5230 SBI \u662f\u5426\u6709\u63d0\u4f9b\u76f8\u5173\u670d\u52a1\u3002\u8bf7\u4f60\u9605\u8bfb SBI \u624b\u518c \u4e2d\u7684 Chapter 6. Timer Extension (EID #0x54494D45 \"TIME\")\uff0c\u4e86\u89e3\u5982\u4f55\u4f7f\u7528 SBI \u63d0\u4f9b\u7684\u5b9a\u65f6\u5668\u670d\u52a1\u3002</p> <p>\u8981\u70b9\uff1aSBI Timer Extension</p> <p>\u6838\u5fc3\u51fd\u6570\uff1a<code>sbi_set_timer</code> (FID #0)</p> <ul> <li>\u529f\u80fd\uff1a\u8bbe\u7f6e\u4e0b\u4e00\u6b21\u5b9a\u65f6\u5668\u4e8b\u4ef6\u7684\u89e6\u53d1\u65f6\u95f4\uff0c\u53c2\u6570\u4e3a \u7edd\u5bf9\u65f6\u95f4\uff08<code>stime_value</code>\uff09\u3002</li> <li> <p>\u6e05\u9664\u5b9a\u65f6\u5668\u4e2d\u65ad\u7684\u4e24\u79cd\u65b9\u6cd5\uff1a</p> <ol> <li>\u8bbe\u7f6e <code>stime_value = (uint64_t)-1</code> \u2192 \u5b9a\u65f6\u5668\u4e2d\u65ad\u89e6\u53d1\u5728\u201c\u65e0\u9650\u672a\u6765\u201d\u3002</li> <li>\u901a\u8fc7\u6e05\u9664 <code>sie.STIE</code> \u4f4d \u2192 \u5c4f\u853d\u5b9a\u65f6\u5668\u4e2d\u65ad\u3002</li> </ol> </li> <li> <p>\u81ea\u52a8\u6e05\u4e2d\u65ad\uff1a</p> <p>\u65e0\u8bba\u662f\u5426\u5c4f\u853d\u5b9a\u65f6\u5668\u4e2d\u65ad\uff0c\u53ea\u8981\u8bbe\u7f6e\u4e86\u672a\u6765\u7684\u65f6\u95f4\uff0c\u51fd\u6570\u90fd\u4f1a\u6e05\u9664\u5f53\u524d\u6302\u8d77\u7684\u5b9a\u65f6\u5668\u4e2d\u65ad\u3002</p> </li> </ul> <p>\u6211\u4eec\u4ece\u6807\u51c6\u4e2d\u4e86\u89e3\u5230 SBI \u7684\u5b9a\u65f6\u5668\u670d\u52a1\u662f M \u6a21\u5f0f\u8f6f\u4ef6\uff08\u5982 OpenSBI\uff09\u901a\u8fc7\u590d\u7528 <code>mtimecmp</code> \u6a21\u62df\u5b9e\u73b0\u7684\uff0c\u6548\u7387\u592a\u4f4e\u4e86\u3002\u56e0\u6b64 RISC-V \u5b9a\u4e49\u4e86 SSTC \u6269\u5c55\u89e3\u51b3\u8fd9\u4e00\u95ee\u9898\u3002\u8bf7\u4f60\u9605\u8bfb 20. \"Sstc\" Extension for Supervisor-mode Timer Interrupts, Version 1.0 \u7684\u7b2c\u4e00\u8282 20.1. Machine and Supervisor Level Additions\uff0c\u5177\u4f53\u4e86\u89e3\u65b0\u589e SSTC \u6269\u5c55\u540e\u7684\u65f6\u949f\u4e2d\u65ad\u673a\u5236\u3002</p> <p>\u8981\u70b9\uff1aSSTC \u6269\u5c55</p> <p>\u8be5\u6269\u5c55\u63d0\u9ad8\u4e86 S \u6a21\u5f0f\u5b9a\u65f6\u5668\u4e2d\u65ad\u7684\u6027\u80fd\u3002\u672a\u63d0\u4f9b\u8be5\u6269\u5c55\u65f6\uff0cS/HS \u6a21\u5f0f\u7684\u65f6\u949f\u4e2d\u65ad\u673a\u5236\u662f\u7531 M \u6a21\u5f0f\u8f6f\u4ef6\uff08\u5982 OpenSBI\uff09\u901a\u8fc7\u590d\u7528 <code>mtimecmp</code> \u6a21\u62df\u5b9e\u73b0\u7684\u3002</p> <p>\u8be5\u6269\u5c55\u4e3b\u8981\u5185\u5bb9\u5305\u62ec\uff1a</p> <ul> <li> <p>\u65b0\u589e CSR \u5bc4\u5b58\u5668</p> <ul> <li><code>smtimecmp</code>\uff1aS \u6a21\u5f0f\u5b9a\u65f6\u5668\u6bd4\u8f83\u5bc4\u5b58\u5668</li> <li>S \u6a21\u5f0f\u65f6\u949f\u4e2d\u65ad\u6302\u8d77\u6761\u4ef6\uff1a<code>time</code> \u2265 <code>smtimecmp</code>\uff08\u8fd8\u8bb0\u5f97 <code>time</code> \u5bf9\u5e94\u54ea\u4e2a M \u6a21\u5f0f\u5bc4\u5b58\u5668\u5417\uff1f\uff09</li> </ul> </li> <li> <p>\u4fee\u6539\u76f8\u5173\u5bc4\u5b58\u5668\u63cf\u8ff0</p> <ul> <li><code>mip/mie</code>\uff1a\u5b9a\u4e49 S \u7ea7\u5b9a\u65f6\u5668\u4e2d\u65ad\u6302\u8d77\u4e0e\u4f7f\u80fd\u4f4d\uff08STIP/STIE\uff09\u3002</li> <li><code>sip/sie</code>\uff1a\u53cd\u6620 S \u7ea7\u5b9a\u65f6\u5668\u4e2d\u65ad\u72b6\u6001\uff0c\u76f4\u63a5\u7531 <code>stimecmp</code> \u63a7\u5236\u3002</li> <li><code>mcounteren</code>\uff1a\u5141\u8bb8\u6216\u7981\u6b62 S \u6a21\u5f0f\u8bbf\u95ee <code>stimecmp</code> / <code>vstimecmp</code>\u3002</li> </ul> </li> </ul> <p>QEMU \u5df2\u7ecf\u652f\u6301 SSTC \u6269\u5c55\uff0c\u56e0\u6b64\u4f60\u53ef\u4ee5\u901a\u8fc7\u76f4\u63a5\u5199 <code>csrw smtimecmp, a0</code> \u6765\u8bbe\u7f6e S \u6a21\u5f0f\u7684\u5b9a\u65f6\u5668\u4e2d\u65ad\u4e86\u3002\u4f46\u662f\uff0c\u4e3a\u4e86\u517c\u5bb9\u6027\u8003\u8651\uff0c\u6211\u4eec\u4ecd\u7136\u5e94\u5f53\u4f7f\u7528 SBI \u63d0\u4f9b\u7684\u5b9a\u65f6\u5668\u670d\u52a1\u3002</p> <p>\u52a8\u624b\u505a</p> <p>\u9605\u8bfb OpenSBI \u6e90\u7801\uff0c\u4e86\u89e3 OpenSBI \u662f\u5982\u4f55\u5b9e\u73b0 <code>sbi_set_timer()</code> \u51fd\u6570\u7684\uff1a</p> <ul> <li><code>lib/sbi/sbi_ecall_time.c</code></li> </ul> <p>\u8bf7\u4f60\u6307\u51fa\uff1a</p> <ul> <li>\u5f53\u5e73\u53f0\u652f\u6301 SSTC \u6269\u5c55\u65f6\uff0cOpenSBI \u4f1a\u5982\u4f55\u8bbe\u7f6e\u5b9a\u65f6\u5668\uff1f</li> <li>\u5f53\u5e73\u53f0\u4e0d\u652f\u6301 SSTC \u6269\u5c55\u65f6\uff0cOpenSBI \u5982\u4f55\u8fdb\u884c\u5b9a\u65f6\u5668\u591a\u8def\u590d\u7528\uff1f</li> </ul> <p>\u66f4\u591a\u8d44\u6599</p> <ul> <li>riscv timer \u7684\u57fa\u672c\u903b\u8f91 | Sherlock's blog\uff1a\u5bf9 RISC-V \u89c4\u8303\u3001QEMU \u548c Linux \u5185\u6838\u7684\u5b9e\u73b0\u8fdb\u884c\u4e86\u6574\u4f53\u5206\u6790\u3002</li> </ul>"},{"location":"lab1/#task4\u5f00\u542f\u5e76\u5904\u7406-s-\u6a21\u5f0f\u65f6\u949f\u4e2d\u65ad","title":"Task4\uff1a\u5f00\u542f\u5e76\u5904\u7406 S \u6a21\u5f0f\u65f6\u949f\u4e2d\u65ad","text":"<p>\u5173\u4e8e\u65f6\u95f4\uff1a</p> <ul> <li> <p>\u5bf9\u4e8e QEMU RISC-V virt \u673a\u5668\uff0c<code>time</code> \u7684\u9891\u7387\u662f 10MHz\uff0cOpenSBI \u5e2e\u4f60\u901a\u8fc7\u8bbe\u5907\u63a5\u53e3\u67e5\u8be2\u4e86\uff1a</p> <pre><code>Platform Timer Device       : aclint-mtimer @ 10000000Hz\n</code></pre> </li> <li> <p>POSIX \u6807\u51c6 \u5b9a\u4e49\u4e86\uff1a</p> <ul> <li><code>CLOCKS_PER_SEC</code> \u5e38\u91cf\uff1a\u8868\u793a\u6bcf\u79d2\u7684\u65f6\u949f\u6ef4\u7b54\u6570\uff08Clocks\uff09\uff0c\u5728 POSIX \u6807\u51c6\u4e2d\u8981\u6c42\u4e3a 1000000\uff081M\uff09</li> <li><code>clock()</code> \u51fd\u6570\uff1a\u8fd4\u56de\u81ea\u8fdb\u7a0b\u542f\u52a8\u4ee5\u6765\uff0c\u8fc7\u53bb\u7684\u65f6\u949f\u6ef4\u7b54\u6570</li> <li>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8981\u5c06 <code>clock()</code> \u8fd4\u56de\u7684\u503c\u8f6c\u6362\u4e3a\u79d2\uff0c\u9700\u8981\u7528\u8fd4\u56de\u503c\u9664\u4ee5 <code>CLOCKS_PER_SEC</code> \u5b8f\u7684\u503c</li> </ul> </li> <li>\u601d\u8003\uff1a\u7ecf\u8fc7\u591a\u4e45\u65f6\u95f4 <code>time</code> \u4f1a\u56de\u7ed5\uff1f</li> </ul> <p>\u4f60\u7684\u4efb\u52a1\uff1a</p> <ul> <li> <p>\u5728 <code>start_kernel()</code> \u4e2d\uff1a</p> <ul> <li>\u5c06 <code>sie</code> \u8bbe\u7f6e\u4e3a\u5408\u9002\u7684\u503c\uff0c\u4f7f\u5f97\u65f6\u949f\u4e2d\u65ad\u4e5f\u88ab\u4f7f\u80fd</li> <li>\u4f7f\u7528 <code>sbi_set_timer()</code> \u5c06\u5b9a\u65f6\u5668\u8bbe\u7f6e\u4e3a <code>0</code>\uff0c\u8fd9\u6837\u4f1a\u7acb\u523b\u89e6\u53d1\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad</li> </ul> <p>\u56e0\u4e3a\u6ca1\u6709\u91cd\u65b0\u8bbe\u7f6e <code>stimecmp</code>\uff0c\u6240\u4ee5\u65f6\u949f\u4e2d\u65ad\u4f1a\u4e00\u76f4\u89e6\u53d1\u3002\u4f60\u4f1a\u770b\u5230\u63a7\u5236\u53f0\u4e0d\u505c\u5730\u6253\u5370\u3002</p> </li> <li> <p>\u5728 <code>trap_handler()</code> \u4e2d\uff0c\u6dfb\u52a0\u65f6\u949f\u4e2d\u65ad\u7684\u5904\u7406</p> <p>\u5728 <code>clock_set_next_event()</code> \u4e2d\u7528 <code>sbi_set_timer()</code> \u8bbe\u7f6e\u4e0b\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\u5230\u4e00\u79d2\u540e\uff0c\u73b0\u5728\u4f60\u4f1a\u770b\u5230\u63a7\u5236\u53f0\u6bcf\u79d2\u6253\u5370\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\u3002</p> </li> <li> <p>\u5728 <code>clock.c</code> \u4e2d\u5b9e\u73b0 POSIX \u6807\u51c6\u7684 <code>clock()</code> \u51fd\u6570</p> <p>\u73b0\u5728 <code>start_kernel()</code> \u5e94\u8be5\u80fd\u6b63\u786e\u5bf9\u5faa\u73af\u8fdb\u884c\u8ba1\u65f6\u4e86</p> </li> </ul> <p>\u5b8c\u6210\u6761\u4ef6</p> <ul> <li>\u901a\u8fc7\u8bc4\u6d4b\u6846\u67b6\u7684 Lab1 Task4 \u6d4b\u8bd5\u3002</li> </ul> <p>\u5185\u6838\u7981\u7528\u6d6e\u70b9\u6570</p> <p>\u4e5f\u8bb8\u4f60\u4f1a\u95ee\uff0c\u4e0a\u9762\u7684 <code>start_kernel()</code> \u4e2d\u4e3a\u4ec0\u4e48\u4e0d\u7528 <code>(double)(time_end - time_start) / CLOCKS_PER_SEC</code> \u6253\u5370\u79d2\u6570\u5462\uff1f</p> <p>\u4e8b\u5b9e\u4e0a\u6211\u4eec\u7684 <code>printk()</code> \u5b9e\u73b0\u5e76\u4e0d\u652f\u6301\u6d6e\u70b9\u6570\u7684\u8f93\u51fa\uff08Linux \u7684\u4e5f\u662f\uff09\u3002\u5982\u679c\u8981\u652f\u6301\u6d6e\u70b9\u6570\u6253\u5370\uff0c\u5c31\u9700\u8981\u4f7f\u7528\u6d6e\u70b9\u6570\u53ca\u5176\u8fd0\u7b97\uff0c\u7136\u800c\u8fd9\u5728\u5185\u6838\u662f\u7981\u7528\u7684\u3002\u539f\u56e0\u6709\u4e8c\uff1a</p> <ul> <li>\u6ca1\u5fc5\u8981\uff1a\u6211\u4eec\u5b66\u5230\u73b0\u5728\u90fd\u6ca1\u63a5\u89e6\u8fc7 RISC-V \u7684\u6574\u6570\u4e58\u9664\u6cd5\uff08M \u6307\u4ee4\u96c6\uff09\uff0c\u66f4\u522b\u8bf4\u6d6e\u70b9\u6570\u4e86\uff08F\u3001D \u6307\u4ee4\u96c6\uff09\uff0c\u53ef\u89c1\u6d6e\u70b9\u6570\u7684\u590d\u6742\u6027\u3002\u5185\u6838\u5b8c\u5168\u53ef\u4ee5\u6452\u5f03\u8fd9\u4e00\u590d\u6742\u6027\uff0c\u4f7f\u7528\u6574\u6570\u5b8c\u6210\u6240\u6709\u5de5\u4f5c\u3002</li> <li>\u4e2d\u65ad\u4e0e\u5f02\u5e38\uff1a\u73b0\u5728\u6211\u4eec\u7684 Trap Handler \u4ec5\u4fdd\u5b58\u4e86 I \u6307\u4ee4\u96c6\u7684\u5bc4\u5b58\u5668\u3002\u5982\u679c\u4f7f\u7528\u6d6e\u70b9\u6570\uff0c\u5c31\u9700\u8981\u4fdd\u5b58 F \u6307\u4ee4\u96c6\u7684\u5bc4\u5b58\u5668\uff0c\u589e\u52a0\u4e86\u5f00\u9500\u3002\u6b64\u5916\uff0c\u6d6e\u70b9\u6570\u8fd0\u7b97\u53ef\u80fd\u5f15\u53d1\u6d6e\u70b9\u5f02\u5e38\uff08\u5982\u65e0\u6548\u64cd\u4f5c\u3001\u9664\u96f6\u7b49\uff09\uff0c\u8fd9\u4e9b\u5f02\u5e38\u901a\u8fc7\u65b0\u7684\u6d6e\u70b9 CSR\uff08FCSR\uff09\u6765\u8bb0\u5f55\uff0c\u5e76\uff08\u5728\u76ee\u524d\u7684 RISC-V \u89c4\u8303\u4e0b\uff09\u9700\u8981\u8f6f\u4ef6\u5728\u6bcf\u6b21\u6d6e\u70b9\u8ba1\u7b97\u540e\u8fdb\u884c\u5904\u7406\u3002</li> </ul> <p>\u5bf9\u6d6e\u70b9\u6570\u611f\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u8fdb\u4e00\u6b65\u9605\u8bfb\uff1a</p> <ul> <li>Floating-point API \u2014 The Linux Kernel documentation</li> <li>Use of floating point in the Linux kernel - Stack Overflow</li> <li>RISC-V \u6307\u4ee4\u96c6\u67b6\u69cb\u4ecb\u7d39 - F Standard Extension | Jim's Dev Blog</li> </ul>"},{"location":"lab2/","title":"Lab 2\uff1a\u62a2\u5360\u5f0f\u5185\u6838\u7ebf\u7a0b\u8c03\u5ea6","text":""},{"location":"lab2/#lab-2\u62a2\u5360\u5f0f\u5185\u6838\u7ebf\u7a0b\u8c03\u5ea6","title":"Lab 2\uff1a\u62a2\u5360\u5f0f\u5185\u6838\u7ebf\u7a0b\u8c03\u5ea6","text":"<p>DDL</p> <ul> <li>\u4ee3\u7801\u3001\u62a5\u544a\uff1a2025-11-04 23:59</li> <li>\u9a8c\u6536\uff1a2025-11-11 \u5b9e\u9a8c\u8bfe</li> </ul>"},{"location":"lab2/#\u5b9e\u9a8c\u7b80\u4ecb","title":"\u5b9e\u9a8c\u7b80\u4ecb","text":"<p>\u672f\u8bed\uff1a\u8fdb\u7a0b\u3001\u7ebf\u7a0b\u4e0e Task\uff08\u4efb\u52a1\uff09</p> <p>\u5728\u7406\u8bba\u8bfe\u4e0a\uff0c\u6211\u4eec\u660e\u786e\u5b9a\u4e49\u4e86\u8fdb\u7a0b\u548c\u7ebf\u7a0b\u3002\u800c\u5728\u5de5\u7a0b\u4e2d\uff0c\u5b9e\u73b0\u5e76\u4e0d\u4f1a\u90a3\u4e48\u6b7b\u677f\u3002\u8bf7\u4f60\u9605\u8bfb\u4e0b\u9762\u7684\u6587\u6bb5\uff0c\u4e86\u89e3\u5728 Linux \u548c\u672c\u5b9e\u9a8c\u7684\u8bed\u5883\u4e2d\u8fd9\u4e9b\u672f\u8bed\u7684\u542b\u4e49\uff1a</p> <p>As you will see later, Linux has a unique implementation of threads: It does not differentiate between threads and processes.To Linux, a thread is just a special kind of process.</p> <p>Another name for a process is a task. The Linux kernel internally refers to processes as tasks. In this book, I use the terms interchangeably, although when I say task I am generally referring to a process from the kernel\u2019s point of view.</p> <p>\u4e0a\u9762\u7684\u6587\u6bb5\u6765\u81ea Linux Kernel Development\uff0c\u4e00\u672c\u7ecf\u5178\u7684 Linux \u5185\u6838\u5f00\u53d1\u5165\u95e8\u4e66\u7c4d\u3002</p> <p>\u5177\u4f53\u6765\u8bf4\uff1a</p> <ul> <li>Linux \u7cfb\u7edf\u8c03\u7528 <code>clone()</code> \u53ef\u4ee5\u521b\u5efa\u65b0\u7684 Task\uff0c\u4f20\u5165\u7684\u53c2\u6570\u5c06\u51b3\u5b9a\u65b0 Task \u5177\u6709\u600e\u6837\u7684\u6027\u8d28\uff1a<ul> <li><code>CLONE_FILES | CLONE_VM | CLONE_FS</code>\uff1a\u8868\u793a\u65b0 Task \u4e0e\u7236 Task \u5171\u4eab\u6587\u4ef6\u7cfb\u7edf\u3001\u5185\u5b58\u7a7a\u95f4\u548c\u6587\u4ef6\u63cf\u8ff0\u7b26\u8868\uff0c\u8fd9\u6837\u7684 Task \u7b26\u5408\u6211\u4eec\u5bf9\u7ebf\u7a0b\uff08Thread\uff09\u7684\u5b9a\u4e49\u3002</li> <li>\u4e0d\u4f7f\u7528\u4e0a\u9762\u7684\u53c2\u6570\uff1a\u8868\u793a\u65b0 Task \u62e5\u6709\u72ec\u7acb\u7684\u6587\u4ef6\u7cfb\u7edf\u3001\u5185\u5b58\u7a7a\u95f4\u548c\u6587\u4ef6\u63cf\u8ff0\u7b26\u8868\uff0c\u8fd9\u6837\u7684 Task \u7b26\u5408\u6211\u4eec\u5bf9\u8fdb\u7a0b\uff08Process\uff09\u7684\u5b9a\u4e49\u3002</li> </ul> </li> <li>\u5728\u8c03\u5ea6\u5668\u770b\u6765\uff0c\u53ea\u6709 Task\uff0c\u6ca1\u6709\u8fdb\u7a0b\u548c\u7ebf\u7a0b\u7684\u533a\u522b\u3002</li> </ul> <p>\u90a3\u4e3a\u4ec0\u4e48\u672c\u5b9e\u9a8c\u53eb\u505a\u300c\u5185\u6838\u7ebf\u7a0b\u300d\u4e0d\u53eb\u300c\u5185\u6838\u4efb\u52a1\u300d\u5462\uff1f\u56e0\u4e3a\u5386\u53f2\u4e0a\u4e00\u76f4\u628a\u8fd0\u884c\u5728\u5185\u6838\u6001\u7684 Task \u53eb\u505a\u5185\u6838\u7ebf\u7a0b\uff08Kernel Thread\uff09\u3002</p> <p>\u73b0\u5728\u4f60\u5df2\u7ecf\u7406\u89e3\u5728\u5b9e\u9a8c\u4e2d\u8fd9\u4e9b\u672f\u8bed\u7684\u533a\u5206\u5e76\u6ca1\u6709\u90a3\u4e48\u4e25\u683c\uff0c\u63a5\u4e0b\u6765\u9605\u8bfb\u5b9e\u9a8c\u5185\u5bb9\u65f6\u5c31\u4e0d\u7528\u6263\u5b57\u773c\u4e86\ud83d\ude09\u3002</p> <p>\u5728 Lab1 \u4e2d\uff0c\u6211\u4eec\u5df2\u7ecf\u8ba9\u5185\u6838\u80fd\u591f\u542f\u52a8\u5e76\u5904\u7406\u65f6\u949f\u4e2d\u65ad\u3002\u4f46\u662f\u5982\u679c\u6ca1\u6709\u8fdb\u4e00\u6b65\u7684\u673a\u5236\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4ecd\u7136\u53ea\u80fd\u5728 CPU \u4e0a\u6267\u884c\u5355\u4e2a\u4efb\u52a1\uff08\u5373 <code>start_kernel</code> \u51fd\u6570\uff09\u3002\u672c\u6b21\u5b9e\u9a8c\u7684\u76ee\u6807\u662f\uff1a\u5b9e\u73b0\u62a2\u5360\u5f0f\u5185\u6838\u7ebf\u7a0b\u8c03\u5ea6\uff0c\u8ba9\u591a\u4e2a\u4efb\u52a1\u80fd\u591f\u5728\u4e00\u4e2a CPU \u4e0a\u901a\u8fc7\u65f6\u95f4\u590d\u7528\u7684\u65b9\u5f0f\u4ea4\u66ff\u8fd0\u884c\u3002</p> <p>\u8981\u5b8c\u6210\u8fd9\u4e00\u76ee\u6807\uff0c\u6211\u4eec\u9700\u8981\u9010\u6b65\u89e3\u51b3\u4ee5\u4e0b\u51e0\u4e2a\u95ee\u9898\uff1a</p> <ol> <li> <p>\u5982\u4f55\u5728\u5185\u6838\u4e2d\u7ba1\u7406\u7269\u7406\u5185\u5b58\uff1f\uff08\u7406\u8bba\u8bfe\u7b2c\u516b\u7ae0\u5185\u5bb9 - \u4e3b\u5b58\uff09</p> <p>\u5728\u540e\u7eed\u5b9e\u9a8c\u91cc\uff0c\u6211\u4eec\u9700\u8981\u52a8\u6001\u5206\u914d\u5404\u7c7b\u6570\u636e\u7ed3\u6784\u3002\u4f46\u662f\u64cd\u4f5c\u7cfb\u7edf\u65e0\u6cd5\u4f7f\u7528 <code>malloc</code> \u7b49\u6807\u51c6\u5e93\u51fd\u6570\uff0c\u90a3\u4e48\u95ee\u9898\u6765\u4e86\uff1a</p> <ul> <li>\u64cd\u4f5c\u7cfb\u7edf\u5982\u4f55\u5728\u88f8\u673a\u73af\u5883\u4e0b\u52a8\u6001\u5206\u914d\u5185\u5b58\uff1f</li> <li>\u4e3a\u4ec0\u4e48\u6211\u4eec\u4e0d\u80fd\u76f4\u63a5\u7ebf\u6027\u5730\u201c\u6316\u4e00\u5757\u201d\u5185\u5b58\uff1f\u788e\u7247\u5316\u5982\u4f55\u89e3\u51b3\uff1f</li> </ul> <p>\u5b9e\u9a8c\u6846\u67b6\u63d0\u4f9b\u4e86\u4e00\u4e2a\u7b80\u5316\u7248 Buddy System \u7269\u7406\u5185\u5b58\u5206\u914d\u5668\u3002\u540c\u5b66\u4eec\u9700\u8981\u7406\u89e3\u5b83\u7684\u57fa\u672c\u539f\u7406\uff0c\u5e76\u5b66\u4f1a\u901a\u8fc7\u63a5\u53e3\u5206\u914d\u548c\u91ca\u653e\u7269\u7406\u9875\u3002</p> <p>Buddy System \u4ec5\u80fd\u5b9e\u73b0\u7269\u7406\u9875\u5206\u914d\uff0c\u65e0\u6cd5\u6ee1\u8db3\u5bf9\u8c61\u7c92\u5ea6\u7684\u5206\u914d\u9700\u6c42\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u5b9e\u73b0\u4e00\u4e2a\u7a7a\u95f2\u94fe\u8868\u7f13\u5b58\uff08free list cache\uff09\uff0c\u7528\u4e8e\u9ad8\u6548\u5730\u5206\u914d\u5185\u6838\u5bf9\u8c61\u3002</p> </li> <li> <p>\u5982\u4f55\u7ba1\u7406\u8fdb\u7a0b\uff1f\uff08\u7406\u8bba\u8bfe\u7b2c\u4e09\u7ae0\u5185\u5bb9 - \u8fdb\u7a0b\uff09</p> <p>\u4efb\u52a1\u4ea4\u66ff\u8fd0\u884c\u7684\u6838\u5fc3\u5728\u4e8e\u4e0a\u4e0b\u6587\u5207\u6362\uff08context switch\uff09\u3002\u8981\u8ba9\u4efb\u52a1 A \u8fd0\u884c\u5b8c\u4e00\u6bb5\u65f6\u95f4\u540e\u4ea4\u51fa CPU\uff0c\u518d\u5207\u6362\u5230\u4efb\u52a1 B\uff0c\u5fc5\u987b\u4fdd\u5b58 A \u7684\u4e0a\u4e0b\u6587\uff0c\u5e76\u5728\u4e4b\u540e\u6062\u590d\u5b83\u3002</p> <ul> <li>\u4e0a\u4e0b\u6587\u5177\u4f53\u5305\u542b\u54ea\u4e9b\u5185\u5bb9\uff1f</li> <li>RISC-V \u8c03\u7528\u7ea6\u5b9a\u548c\u4e2d\u65ad\u673a\u5236\u5982\u4f55\u5f71\u54cd\u4e0a\u4e0b\u6587\u5207\u6362\uff1f</li> <li>\u5982\u4f55\u5b9e\u73b0\u62a2\u5360\uff1f</li> </ul> <p>\u89e3\u51b3\u5b8c\u4e0a\u4e0b\u6587\u5207\u6362\u7684\u57fa\u672c\u95ee\u9898\u540e\uff0c\u6211\u4eec\u9700\u8981\u4e3a\u6bcf\u4e2a Task \u8bbe\u8ba1\u4e00\u4e2a\u6570\u636e\u7ed3\u6784\uff08\u5373\u7406\u8bba\u8bfe\u4ecb\u7ecd\u7684 PCB\uff0cProcess Control Block\uff09\uff0c\u7528\u4e8e\u4fdd\u5b58\u4e0a\u4e0b\u6587\u548c\u5176\u4ed6\u5c5e\u6027\u3002\u5e76\u4e14\u8fd8\u9700\u8981\u5b9e\u73b0\u8fdb\u7a0b\u7684\u521b\u5efa\u548c\u9500\u6bc1\u673a\u5236\uff0c\u4ece\u800c\u8ba9\u5185\u6838\u80fd\u591f\u52a8\u6001\u5730\u7ba1\u7406\u591a\u4e2a\u4efb\u52a1\u3002</p> </li> <li> <p>\u8c03\u5ea6\u5668\u5e94\u8be5\u5982\u4f55\u5de5\u4f5c\uff1f\uff08\u7406\u8bba\u8bfe\u7b2c\u4e94\u7ae0\u5185\u5bb9 - \u8c03\u5ea6\u7b97\u6cd5\uff09</p> <p>\u6709\u4e86\u5185\u5b58\u548c\u8fdb\u7a0b\u7ba1\u7406\uff0c\u63a5\u4e0b\u6765\u5c31\u80fd\u591f\u5b9e\u73b0\u8c03\u5ea6\u5668\u3002\u8c03\u5ea6\u5668\u7684\u4efb\u52a1\u662f\uff1a</p> <ol> <li>\u6839\u636e\u8c03\u5ea6\u7b97\u6cd5\u9009\u62e9\u4e0b\u4e00\u4e2a\u8981\u8fd0\u884c\u7684\u4efb\u52a1</li> <li>\u8c03\u7528\u4e0a\u4e0b\u6587\u5207\u6362\u4ee3\u7801\uff0c\u5c06 CPU \u63a7\u5236\u6743\u4ea4\u7ed9\u5b83</li> </ol> <p>\u672c\u6b21\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u5148\u5b9e\u73b0\u4e00\u4e2a\u7b80\u5355\u7684\u65f6\u95f4\u7247\u8f6e\u8f6c\uff08Round Robin\uff09\u8c03\u5ea6\u5668\u3002</p> </li> </ol>"},{"location":"lab2/#part-0\u73af\u5883\u914d\u7f6e","title":"Part 0\uff1a\u73af\u5883\u914d\u7f6e","text":""},{"location":"lab2/#\u66f4\u65b0\u4ee3\u7801","title":"\u66f4\u65b0\u4ee3\u7801","text":"<p>\u73b0\u5728\u4f60\u4f4d\u4e8e <code>lab1</code> \u5206\u652f\u3002\u4f60\u9700\u8981\u521b\u5efa <code>lab2</code> \u5206\u652f\uff0c\u5408\u5e76\u4e0a\u6e38\u7684\u4ee3\u7801\uff1a</p> <pre><code>git checkout -b lab2\ngit fetch upstream\ngit merge upstream/lab2\n</code></pre> <p>\u4e0b\u9762\u7684\u5408\u5e76\u8bf4\u660e\u4f9b\u540c\u5b66\u4eec\u89e3\u51b3\u5408\u5e76\u51b2\u7a81\u65f6\u53c2\u8003\uff1a</p> <ul> <li>\u65b0\u589e\u5b9e\u9a8c\u76f8\u5173\uff1a<ul> <li>\u5185\u5b58\u7ba1\u7406\u4ee3\u7801 <code>mm.h</code>\uff0c\u5728 Part1.2 \u4ecb\u7ecd</li> <li>\u94fe\u8868\u4ee3\u7801 <code>list.h</code>\uff0c\u5728 Part1.3 \u4ecb\u7ecd</li> <li>\u7a7a\u95f2\u94fe\u8868\u7f13\u5b58\u4ee3\u7801 <code>cache.h</code>\uff0c\u5728 Part1.4 \u4ecb\u7ecd</li> <li>\u8fdb\u7a0b\u7ba1\u7406\u76f8\u5173\u5b9e\u9a8c\u4ee3\u7801 <code>proc.h</code>\uff0c\u5728 Part1.5 \u4ecb\u7ecd</li> <li>\u5185\u6838\u7ebf\u7a0b\u4ee3\u7801 <code>kthread.h</code>\uff0c\u5728 Part1.6 \u4ecb\u7ecd</li> <li>\u8c03\u5ea6\u5668\u4ee3\u7801 <code>sched.h</code>\uff0c\u5728 Part4 \u4ecb\u7ecd</li> <li>\u51e0\u4e2a\u6d4b\u8bd5\u6837\u4f8b <code>test.h</code>\u3001<code>test_*.c</code> \u5728\u5bf9\u5e94\u7684 Task \u4ecb\u7ecd</li> </ul> </li> <li> <p>\u65b0\u589e\u5176\u4ed6\uff1a</p> <ul> <li> <p>\u65e5\u5fd7\u7cfb\u7edf\uff0c\u89c1 <code>log.h</code></p> <ul> <li>\u81ea\u52a8\u8bc6\u522b\u5e76\u6253\u5370\u65e5\u5fd7\u4f4d\u7f6e\u7684\u6587\u4ef6\u540d\u548c\u884c\u53f7</li> <li>\u652f\u6301\u65e5\u5fd7\u7ea7\u522b\uff08DEBUG\u3001INFO\u3001WARN\u3001ERROR\uff09\uff0c\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539 <code>log.h</code> \u7684 <code>LOG_LEVEL</code> \u5b8f\u6765\u63a7\u5236\u8f93\u51fa\u7684\u8be6\u7ec6\u7a0b\u5ea6</li> <li> <p>\u6846\u67b6\u5df2\u7ecf\u6dfb\u52a0\u4e86\u90e8\u5206\u8c03\u8bd5\u65e5\u5fd7\uff0c\u540c\u5b66\u4eec\u53ef\u4ee5\u5c06 <code>LOG_LEVEL</code> \u8bbe\u7f6e\u5230 <code>LOG_LEVEL_DEBUG</code> \u6765\u67e5\u770b\uff0c\u4f8b\u56fe\u5982\u4e0b\uff1a</p> <p></p>      \u65e5\u5fd7\u8f93\u51fa\u793a\u4f8b      <p></p> <p>\u6bcf\u884c\u65e5\u5fd7\u7684\u524d\u7f00\u56fa\u5b9a\u683c\u5f0f\u4e3a\uff1a<code>[\u7b49\u7ea7, \u5f53\u524d\u8fdb\u7a0b] \u6587\u4ef6\u540d:\u884c\u53f7:\u51fd\u6570\u540d:</code>\u3002</p> </li> <li> <p>\u5efa\u8bae\u540c\u5b66\u4eec\u591a\u7528\u8fd9\u4e00\u65e5\u5fd7\u7cfb\u7edf\u800c\u4e0d\u662f <code>printk</code></p> </li> </ul> </li> </ul> </li> <li> <p>\u53d8\u66f4\uff1a</p> <ul> <li>CSR \u76f8\u5173\u5185\u5bb9\u4ece <code>sbi.h</code> \u79fb\u52a8\u5230 <code>csr.h</code></li> <li>\u65f6\u949f\u4e2d\u65ad\u7684\u95f4\u9694\u4e0e\u8c03\u5ea6\u7b97\u6cd5\u6709\u5173\uff0c\u4ece 1s \u6539\u4e3a <code>kernel/arch/riscv/include/sched.h</code> \u4e2d\u5b9a\u4e49\u7684 <code>TIMER_INTERVAL</code></li> <li><code>arch/riscv/kernel/include</code> \u4e2d\u7684\u6240\u6709\u5934\u6587\u4ef6\u73b0\u5728\u90fd\u6dfb\u52a0\u4e86 Doxygen \u98ce\u683c\u7684\u8be6\u7ec6\u7684 API\u3001\u6570\u636e\u7ed3\u6784\u3001\u5e38\u91cf\u7684\u6ce8\u91ca\uff0c\u8bf7\u540c\u5b66\u4eec\u79ef\u6781\u9605\u8bfb\u548c\u4f7f\u7528\uff0c\u6587\u6863\u4e0d\u4f1a\u518d\u8d58\u8ff0\u3002</li> </ul> </li> </ul>"},{"location":"lab2/#\u66f4\u65b0\u955c\u50cf","title":"\u66f4\u65b0\u955c\u50cf","text":"<p>\u672c\u6b21\u955c\u50cf\u66f4\u65b0\u5728 <code>/etc/gitconfig</code> \u6dfb\u52a0\u4e86 <code>safe.directory</code> \u7684\u914d\u7f6e\uff0c\u4ee5\u89e3\u51b3\u4ee3\u7801\u5e93\u6302\u8f7d\u5230\u5bb9\u5668\u540e\u7684\u6743\u9650\u95ee\u9898\u3002\u8fd9\u4e0d\u662f\u4e00\u4e2a\u5fc5\u8981\u7684\u4fee\u590d\uff0c\u540c\u5b66\u4eec\u53ef\u4ee5\u89c6\u60c5\u51b5\u9009\u62e9\u66f4\u65b0\u955c\u50cf\u3002</p>"},{"location":"lab2/#part-1\u5185\u5b58\u7ba1\u7406","title":"Part 1\uff1a\u5185\u5b58\u7ba1\u7406","text":""},{"location":"lab2/#\u7269\u7406\u5185\u5b58\u7a7a\u95f4","title":"\u7269\u7406\u5185\u5b58\u7a7a\u95f4","text":"<p>\u5728\u5b66\u4e60\u5982\u4f55\u7ba1\u7406\u7269\u7406\u5185\u5b58\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u5148\u5f04\u6e05\u695a\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u7684\u6982\u5ff5\u3002\u6240\u8c13\u5185\u5b58\u7a7a\u95f4\uff0c\u5c31\u662f CPU \u53ef\u4ee5\u76f4\u63a5\u5bfb\u5740\u7684\u5730\u5740\u8303\u56f4\uff0c\u5176\u5927\u5c0f\u901a\u5e38\u7531\u5bc4\u5b58\u5668\u7684\u4f4d\u6570\u51b3\u5b9a\u3002</p> <ul> <li>\u4f8b\u5982\uff0c\u5728 RV32 \u67b6\u6784\u4e2d\uff0c\u901a\u7528\u5bc4\u5b58\u5668\u5bbd\u5ea6\u4e3a 32 \u4f4d\u3002\u5f53\u6267\u884c\u6307\u4ee4 <code>ld x1, 0(x2)</code> \u65f6\uff0c<code>x2</code> \u4e2d\u5b58\u653e\u7684\u5c31\u662f\u4e00\u4e2a\u5185\u5b58\u5730\u5740\uff0c\u5b83\u51b3\u5b9a\u4e86 <code>x1</code> \u8981\u4ece\u54ea\u91cc\u53d6\u6570\u636e\u3002\u7531\u4e8e\u5bc4\u5b58\u5668\u53ea\u6709 32 \u4f4d\uff0c\u6700\u591a\u80fd\u5bfb\u5740 \\(2^{32}\\) \u4e2a\u5b57\u8282\uff0c\u56e0\u6b64 RV32 \u7684\u5730\u5740\u7a7a\u95f4\u5927\u5c0f\u4e3a \\(2^{32} \\text{B} = 4 \\text{GB}\\)\u3002</li> <li>\u800c\u5728 RV64 \u67b6\u6784\u4e0b\uff0c\u5bc4\u5b58\u5668\u5bbd\u5ea6\u6269\u5c55\u4e3a 64 \u4f4d\uff0c\u5bf9\u5e94\u7684\u5bfb\u5740\u7a7a\u95f4\u7406\u8bba\u4e0a\u53ef\u4ee5\u8fbe\u5230 \\(2^{64} \\text{B} = 2^{34} \\text{GB} = 16 \\text{EB}\\)\uff0c\u8fdc\u8d85\u5f53\u524d\u5b9e\u9645\u786c\u4ef6\u6240\u80fd\u63d0\u4f9b\u7684\u5185\u5b58\u5bb9\u91cf\u3002</li> </ul> <p>\u5728\u771f\u5b9e\u673a\u5668\u4e0a\uff0cCPU \u4e0d\u53ef\u80fd\u771f\u7684\u62e5\u6709 16 EB \u7684\u5185\u5b58\u3002\u7cfb\u7edf\u53ea\u4f1a\u6620\u5c04\u5176\u4e2d\u7684\u4e00\u5c0f\u90e8\u5206\u5730\u5740\u4f5c\u4e3a\u7269\u7406\u5185\u5b58\uff0c\u5176\u4f59\u5730\u5740\u8303\u56f4\u901a\u5e38\u4fdd\u7559\u7ed9\u5916\u8bbe\u3001\u56fa\u4ef6\u3001I/O \u603b\u7ebf\u7b49\u3002\u5728 Lab0 \u4e2d\uff0c\u6211\u4eec\u5df2\u7ecf\u4f7f\u7528\u8fc7 <code>info mtree</code> \u547d\u4ee4\u6765\u67e5\u770b QEMU \u6a21\u62df\u7684\u5185\u5b58\u6620\u5c04\uff0c\u63a5\u4e0b\u6765\u57fa\u4e8e\u8be5\u7ed3\u679c\u8fdb\u884c\u5177\u4f53\u5206\u6790\uff1a</p> <ul> <li> <p>RV64 \u67b6\u6784\u7684\u5730\u5740\u7a7a\u95f4\uff1a<code>0000000000000000</code> \u5230 <code>ffffffffffffffff</code>\uff0c\u603b\u5171 16 EB\u3002</p> (qemu) info mtree<pre><code>address-space: cpu-memory-0\naddress-space: memory\n  0000000000000000-ffffffffffffffff (prio 0, i/o): system\n    ...\n</code></pre> </li> <li> <p>\u5730\u5740\u7a7a\u95f4\u7684\u5177\u4f53\u5212\u5206\uff1a</p> <ul> <li> <p>\u67d0\u4e9b\u533a\u57df\u5b58\u653e\u56fa\u4ef6\u6216\u6d4b\u8bd5\u5bc4\u5b58\u5668\uff08\u5982 <code>mrom</code>, <code>sifive.test</code>\uff09</p> <pre><code>0000000000001000-000000000000ffff (prio 0, rom): riscv_virt_board.mrom\n0000000000100000-0000000000100fff (prio 0, i/o): riscv.sifive.test\n</code></pre> </li> <li> <p>\u67d0\u4e9b\u533a\u57df\u5bf9\u5e94\u5b9a\u65f6\u5668\u3001PLIC\uff08\u4e2d\u65ad\u63a7\u5236\u5668\uff09\u3001\u4e32\u53e3\u3001virtio \u8bbe\u5907\u7b49\u5916\u8bbe</p> <pre><code>000000000c000000-000000000c5fffff (prio 0, i/o): riscv.sifive.plic\n0000000010000000-0000000010000007 (prio 0, i/o): serial\n0000000000101000-0000000000101023 (prio 0, i/o): goldfish_rtc\n</code></pre> <p>\u8981\u70b9\uff1a\u603b\u7ebf\u4e0e\u5185\u5b58\u6620\u5c04 I/O</p> <p>\u5728\u8ba1\u79d1\u7684\u786c\u4ef6\u8bfe\u7a0b\u4e2d\uff0c\u5927\u5bb6\u53ef\u80fd\u8fd8\u6ca1\u6709\u7cfb\u7edf\u5b66\u4e60\u8fc7\u603b\u7ebf (Bus) \u7684\u6982\u5ff5\u3002\u5728\u8fd9\u91cc\u6211\u4eec\u53ea\u9700\u8981\u638c\u63e1\u6700\u57fa\u672c\u7684\u7406\u89e3\uff1a</p> <ul> <li>\u603b\u7ebf\u662f\u4e00\u79cd\u7edf\u4e00\u7684\u901a\u4fe1\u901a\u9053\uff0cCPU\u3001\u5185\u5b58\u3001\u5916\u8bbe\u90fd\u901a\u8fc7\u603b\u7ebf\u4ea4\u4e92\u6570\u636e\u3002</li> <li>\u5728\u73b0\u4ee3\u8ba1\u7b97\u673a\u4e2d\uff0cCPU \u628a\u4e00\u90e8\u5206\u5730\u5740\u7a7a\u95f4\u201c\u5212\u7ed9\u201d\u5916\u8bbe\u3002\u5f53\u6211\u4eec\u7528\u666e\u901a\u7684 <code>load/store</code> \u6307\u4ee4\u8bbf\u95ee\u8fd9\u4e9b\u5730\u5740\u65f6\uff0c\u770b\u4f3c\u5728\u8bbf\u95ee\u5185\u5b58\uff0c\u5b9e\u9645\u4e0a\u662f\u901a\u8fc7\u603b\u7ebf\u628a\u6570\u636e\u8bfb\u5199\u5230\u67d0\u4e2a\u5916\u8bbe\u5bc4\u5b58\u5668\u4e0a\u3002</li> <li>\u4e3e\u4e2a\u4f8b\u5b50\uff1a\u5f53\u6211\u4eec\u5411\u4e32\u53e3\u5730\u5740\u7a7a\u95f4\u5199\u5165\u4e00\u4e2a\u5b57\u8282\uff0c\u786c\u4ef6\u5c31\u4f1a\u628a\u5b83\u8f93\u51fa\u5230\u7ec8\u7aef\uff1b\u5f53\u6211\u4eec\u8bfb\u53d6 RTC\uff08\u5b9e\u65f6\u65f6\u949f\uff09\u7684\u5bc4\u5b58\u5668\uff0c\u5c31\u80fd\u83b7\u5f97\u5f53\u524d\u65f6\u95f4\u3002</li> </ul> <p>\u8fd9\u5c31\u662f\u6240\u8c13\u7684 Memory-Mapped I/O\uff08MMIO\uff09\uff1a\u901a\u8fc7\u201c\u5185\u5b58\u5730\u5740\u7a7a\u95f4\u201d\u6765\u64cd\u7eb5\u5916\u8bbe\u3002</p> </li> <li> <p>\u6700\u5173\u952e\u7684\u662f\uff0c\u4e00\u90e8\u5206\u5730\u5740\u8303\u56f4\u88ab\u6620\u5c04\u4e3a RAM\uff0c\u5373\u5b9e\u9a8c\u4e2d\u6211\u4eec\u771f\u6b63\u53ef\u4ee5\u4f7f\u7528\u7684\u7269\u7406\u5185\u5b58\u3002\u4f8b\u5982\uff1a</p> <pre><code>0000000080000000-0000000087ffffff (prio 0, ram): riscv_virt_board.ram\n</code></pre> <p>\u8fd9\u8868\u793a\u4ece <code>0x80000000</code> \u5f00\u59cb\uff0c\u6709\u4e00\u6bb5\u8fde\u7eed\u7684\u7269\u7406\u5185\u5b58\u533a\u57df\u88ab\u4f5c\u4e3a\u53ef\u7528 RAM \u63d0\u4f9b\u7ed9\u64cd\u4f5c\u7cfb\u7edf\u3002</p> </li> </ul> </li> </ul> <p>\u5e76\u4e14\uff0c\u5728\u524d\u8ff0\u7684\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u4e5f\u5177\u4f53\u4e86\u89e3\u5230 <code>0x80000000-0x87ffffff</code> \u8fd9 128MB \u7684\u7269\u7406\u5185\u5b58\u7684\u5212\u5206\uff1a</p> <ul> <li><code>0x80000000-0x801fffff</code>\uff1aOpenSBI \u5360\u7528</li> <li><code>0x80200000-_ekernel</code>\uff1a\u5185\u6838\u5360\u7528</li> <li><code>_ekernel-0x87ffffff</code>\uff1a\u53ef\u4ee5\u81ea\u7531\u4f7f\u7528\u7684\u7269\u7406\u5185\u5b58</li> </ul> <p>\u8981\u70b9\uff1a\u7269\u7406\u5185\u5b58\u7a7a\u95f4</p> <ul> <li>RV64 \u7684\u7406\u8bba\u5730\u5740\u7a7a\u95f4\u975e\u5e38\u5927\uff0c\u4f46\u5b9e\u9645\u53ef\u7528\u7684\u7269\u7406\u5185\u5b58\u53ea\u662f\u5176\u4e2d\u4e00\u5c0f\u5757\u3002</li> <li>QEMU \u4f1a\u5728 <code>0x80000000</code> \u8d77\u6620\u5c04\u51fa\u4e00\u6bb5 RAM\uff0c\u8fd9\u662f\u6211\u4eec\u5728\u5b9e\u9a8c\u4e2d\u7ba1\u7406\u548c\u4f7f\u7528\u7684\u4e3b\u8981\u7269\u7406\u5185\u5b58\u533a\u57df\u3002</li> <li>\u5176\u4ed6\u533a\u57df\u867d\u7136\u4e5f\u662f\u201c\u5730\u5740\u201d\uff0c\u4f46\u5bf9\u5e94\u7684\u662f\u56fa\u4ef6\u6216\u5916\u8bbe\u3002CPU \u901a\u8fc7\u8bfb\u5199\u8fd9\u4e9b\u5730\u5740\uff0c\u4e0e\u786c\u4ef6\u8fdb\u884c\u4ea4\u4e92\u3002</li> </ul>"},{"location":"lab2/#buddy-system","title":"Buddy System","text":"<p>\u5728\u7406\u89e3\u4e86\u201c\u6211\u4eec\u6709\u54ea\u4e9b\u7269\u7406\u5185\u5b58\u201d\u4e4b\u540e\uff0c\u4e0b\u4e00\u6b65\u8981\u601d\u8003\u7684\u5c31\u662f\uff1a\u5982\u4f55\u9ad8\u6548\u5730\u7ba1\u7406\u8fd9\u6bb5\u6709\u9650\u7684\u7269\u7406\u5185\u5b58\u3002\u5982\u679c\u6ca1\u6709\u4e00\u5957\u89c4\u5219\u6765\u5206\u914d\u548c\u56de\u6536\u5185\u5b58\uff0c\u90a3\u4e48\u5f88\u5feb\u5c31\u4f1a\u51fa\u73b0\u201c\u8981\u4e48\u5206\u914d\u4e0d\u51fa\u53bb\uff0c\u8981\u4e48\u6d6a\u8d39\u5927\u7247\u7a7a\u95f4\u201d\u7684\u95ee\u9898\u3002</p> <p>\u6700\u5e38\u89c1\u7684\u4e00\u4e2a\u56f0\u96be\u662f \u5185\u5b58\u788e\u7247\uff1a</p> <ul> <li>\u5982\u679c\u6211\u4eec\u6bcf\u6b21\u90fd\u6309\u7167\u8bf7\u6c42\u5927\u5c0f\u76f4\u63a5\u5206\u914d\uff0c\u968f\u7740\u4e0d\u65ad\u7533\u8bf7\u548c\u91ca\u653e\uff0c\u5185\u5b58\u4f1a\u88ab\u5207\u5f97\u96f6\u96f6\u788e\u788e\uff0c\u5373\u4f7f\u603b\u5269\u4f59\u7a7a\u95f4\u5f88\u591a\uff0c\u4e5f\u53ef\u80fd\u65e0\u6cd5\u6ee1\u8db3\u4e00\u4e2a\u5927\u5757\u5185\u5b58\u7684\u8bf7\u6c42\u3002</li> <li>\u6211\u4eec\u9700\u8981\u4e00\u79cd\u673a\u5236\u6765\u8ba9\u5185\u5b58\u5757\u5c3d\u91cf\u4fdd\u6301\u201c\u89c4\u6574\u201d\uff0c\u65b9\u4fbf\u56de\u6536\u548c\u518d\u6b21\u5229\u7528\u3002</li> </ul> <p>Buddy System \u5c31\u662f\u8fd9\u6837\u4e00\u79cd\u7ecf\u5178\u65b9\u6848\uff1a</p> <ol> <li> <p>\u5185\u5b58\u5212\u5206\u89c4\u5219</p> <ul> <li>\u5047\u8bbe\u6211\u4eec\u6709\u4e00\u6bb5\u8fde\u7eed\u7684\u7269\u7406\u5185\u5b58\uff0c\u603b\u5927\u5c0f\u662f \\(2^n\\) \u9875\u3002</li> <li>\u7cfb\u7edf\u6309 2 \u7684\u5e42\u6b21\u65b9\u5927\u5c0f\u5212\u5206\u5185\u5b58\u5757\uff1a1 \u9875\u30012 \u9875\u30014 \u9875\u2026\u2026\u76f4\u5230 \\(2^n\\) \u9875\u3002</li> <li>\u6bcf\u6b21\u5206\u914d\u65f6\uff0c\u5982\u679c\u9700\u8981\u7684\u5927\u5c0f\u4e0d\u662f 2 \u7684\u5e42\uff0c\u4f1a\u81ea\u52a8\u5411\u4e0a\u53d6\u6574\u3002</li> </ul> </li> <li> <p>\u5206\u914d\u8fc7\u7a0b</p> <ul> <li>\u627e\u5230\u80fd\u6ee1\u8db3\u9700\u6c42\u7684\u6700\u5c0f\u5757\uff0c\u5982\u679c\u6ca1\u6709\uff0c\u5c31\u4ece\u66f4\u5927\u7684\u5757\u4e2d\u201c\u5288\u5f00\u4e00\u534a\u201d\u3002</li> <li>\u6bcf\u5288\u4e00\u6b21\uff0c\u5c31\u4f1a\u5f97\u5230\u4e00\u5bf9\u201c\u4f19\u4f34\u5757\u201d\uff08buddy\uff09\u3002</li> </ul> </li> <li> <p>\u91ca\u653e\u8fc7\u7a0b</p> <ul> <li>\u5f53\u4e00\u4e2a\u5757\u88ab\u91ca\u653e\u540e\uff0c\u7cfb\u7edf\u4f1a\u68c0\u67e5\u5b83\u7684\u4f19\u4f34\u662f\u5426\u7a7a\u95f2\u3002</li> <li>\u5982\u679c\u4f19\u4f34\u4e5f\u7a7a\u95f2\uff0c\u5c31\u5c06\u4e24\u8005\u5408\u5e76\u6210\u66f4\u5927\u7684\u5757\uff0c\u5e76\u7ee7\u7eed\u5411\u4e0a\u5408\u5e76\uff0c\u76f4\u5230\u4e0d\u80fd\u5408\u5e76\u4e3a\u6b62\u3002</li> <li>\u8fd9\u6837\u53ef\u4ee5\u51cf\u5c11\u788e\u7247\uff0c\u4f7f\u5f97\u5927\u5757\u7a7a\u95f4\u80fd\u91cd\u65b0\u817e\u51fa\u6765\u3002</li> </ul> </li> </ol> <p>\u5728\u5b9e\u9a8c\u6846\u67b6\u91cc\uff0c\u6211\u4eec\u5df2\u7ecf\u4e3a\u5927\u5bb6\u5b9e\u73b0\u4e86\u4e00\u4e2a\u7b80\u5316\u7248\u7684 Buddy System \u7269\u7406\u5185\u5b58\u5206\u914d\u5668\uff08\u4f4d\u4e8e <code>mm.c</code> / <code>mm.h</code>\uff09\u3002\u4f60\u65e0\u9700\u4ece\u96f6\u5f00\u59cb\u5199\u7b97\u6cd5\uff0c\u53ea\u9700\u8981\u638c\u63e1\u5b83\u7684\u4f7f\u7528\u65b9\u5f0f\u3002</p> <p>\u8bf7\u9605\u8bfb <code>kernel/arch/riscv/include/list.h</code>\uff0c\u4e86\u89e3 Buddy System \u63d0\u4f9b\u7684\u63a5\u53e3\u3002\u5728\u5b9e\u9a8c\u91cc\uff0c\u4f60\u53ea\u9700\u8981\u901a\u8fc7\u8fd9\u4e9b\u63a5\u53e3\u7533\u8bf7\u6216\u91ca\u653e\u7269\u7406\u9875\uff0c\u800c\u4e0d\u5fc5\u5173\u5fc3\u5185\u90e8\u5177\u4f53\u662f\u5982\u4f55\u5b9e\u73b0\u7684\u3002</p> <p>\u4f8b\u5982\uff1a</p> Buddy System \u63a5\u53e3\u4f7f\u7528\u793a\u4f8b<pre><code>void *a = alloc_page();      // \u5206\u914d\u4e00\u9875\nvoid *b = alloc_pages(8);    // \u5206\u914d 8 \u9875\nfree_pages(a);               // \u91ca\u653e\u4e4b\u524d\u5206\u914d\u7684\u4e00\u9875\n</code></pre> <p>\u901a\u8fc7\u8fd9\u4e00\u5957\u63a5\u53e3\uff0c\u6211\u4eec\u7684\u5185\u6838\u5c31\u80fd\u5728\u540e\u7eed\u5b9e\u9a8c\uff08\u5982\u8fdb\u7a0b\u8c03\u5ea6\u3001\u5185\u5b58\u7ba1\u7406\u3001\u865a\u62df\u5185\u5b58\uff09\u4e2d\uff0c\u7a33\u5b9a\u5730\u4f7f\u7528\u7269\u7406\u9875\u4f5c\u4e3a\u5e95\u5c42\u8d44\u6e90\u3002</p> <p>\u8981\u70b9\uff1aBuddy System</p> <ul> <li>Buddy System \u6309 2 \u7684\u5e42\u6b21\u65b9\u5212\u5206\u5185\u5b58\u5757\uff0c\u65b9\u4fbf\u5408\u5e76\u548c\u56de\u6536\uff0c\u51cf\u5c11\u788e\u7247\u3002</li> <li>\u5b9e\u9a8c\u6846\u67b6\u5df2\u7ecf\u5b9e\u73b0\u4e86\u7b80\u5316\u7248\u7684 Buddy System\uff0c\u4f60\u53ea\u9700\u901a\u8fc7 <code>alloc_page(s)</code> \u548c <code>free_pages()</code> \u63a5\u53e3\u6765\u5206\u914d\u548c\u91ca\u653e\u7269\u7406\u9875\u3002</li> </ul>"},{"location":"lab2/#\u4fb5\u5165\u5f0f\u53cc\u5411\u5faa\u73af\u94fe\u8868","title":"\u4fb5\u5165\u5f0f\u53cc\u5411\u5faa\u73af\u94fe\u8868","text":"<p>\u5728\u5185\u6838\u4e2d\u6211\u4eec\u7ecf\u5e38\u9700\u8981\u7ec4\u7ec7\u5404\u79cd\u52a8\u6001\u5bf9\u8c61\uff0c\u4f8b\u5982\u7a7a\u95f2\u9875\u94fe\u8868\u3001\u5c31\u7eea\u4efb\u52a1\u961f\u5217\u3001\u7b49\u5f85\u961f\u5217\u7b49\u3002Linux \u5185\u6838\u5b9e\u73b0\u4e86\u4fb5\u5165\u5f0f\u53cc\u5411\u5faa\u73af\u94fe\u8868\uff08intrusive doubly-linked list\uff09\u6765\u9ad8\u6548\u5730\u7ba1\u7406\u8fd9\u4e9b\u5bf9\u8c61\u3002</p> <ul> <li> <p>\u4fb5\u5165\u5f0f\u4e0e\u6cdb\u578b\u63a5\u53e3\uff1a</p> <p>\u666e\u901a\u94fe\u8868\u5b9e\u73b0\u5c06\u6570\u636e\u5d4c\u5165\u5728\u94fe\u8868\u4e2d\uff0c\u800c\u4fb5\u5165\u5f0f\u5b9e\u73b0\u5c06\u94fe\u8868\u5d4c\u5165\u5728\u6570\u636e\u4e2d\u3002\u524d\u8005\u6bcf\u4e00\u79cd\u6570\u636e\u7c7b\u578b\u90fd\u9700\u8981\u5355\u72ec\u5b9a\u4e49\u94fe\u8868\u8282\u70b9\u7ed3\u6784\u4f53\u548c\u76f8\u5173\u7684\u51fd\u6570\uff0c\u5bfc\u81f4\u4ee3\u7801\u91cd\u590d\u4e14\u4e0d\u6613\u7ef4\u62a4\u3002\u540e\u8005\u4e0d\u540c\u7c7b\u578b\u53ef\u4ee5\u590d\u7528\u540c\u4e00\u5957\u63a5\u53e3\uff0c\u8fd9\u5c31\u662f\u6cdb\u578b\uff08generic\uff09\u3002</p> \u4fb5\u5165\u5f0f\u94fe\u8868<pre><code>struct list_head {\n    struct list_head *next, *prev;\n};\n#define LIST_HEAD_INIT(name) { &amp;(name), &amp;(name) }\n#define LIST_HEAD(name) struct list_head name = LIST_HEAD_INIT(name)\nstatic inline void list_add(struct list_head *new, struct list_head *head);\nstatic inline void list_del(struct list_head *entry)\n\n// \u4f7f\u7528\u4f8b\nstruct data_node_A {\n    int data;\n    struct list_head list;\n} a;\nstruct data_node_B {\n    char data;\n    struct list_head list;\n} x;\nLIST_HEAD(list_A);\nLIST_HEAD(list_B);\nlist_add(&amp;a.list, &amp;list_A);\nlist_add(&amp;x.list, &amp;list_B);\n</code></pre> \u666e\u901a\u94fe\u8868<pre><code>struct data_node_A {\n    int* data;\n    struct data_node_A *next, *prev;\n} a, *list_A = NULL;\nstruct data_node_B {\n    char* data;\n    struct data_node_B *next, *prev;\n} x, *list_B = NULL;\nstatic inline void list_A_add(struct data_node_A *new, struct data_node_A *head);\nstatic inline void list_B_add(struct data_node_B *new, struct data_node_B *head);\n\n// \u4f7f\u7528\u4f8b\nlist_A_add(&amp;a, list_A);\nlist_B_add(&amp;x, list_B);\n</code></pre> </li> <li> <p>\u8bbf\u95ee\u6570\u636e\uff1a</p> <p>\u7406\u89e3\u4e86\u4e0a\u9762\u7684\u4ee3\u7801\uff0c\u4f60\u4f1a\u53d1\u73b0\u76f2\u70b9\uff1a<code>list_head</code> \u7ed3\u6784\u4f53\u5e76\u4e0d\u5305\u542b\u6570\u636e\u5b57\u6bb5\u3002\u600e\u4e48\u901a\u8fc7 <code>list_A</code> \u8fd9\u6837\u7684\u94fe\u8868\u5934\uff0c\u8bbf\u95ee\u5230 <code>data_node_A</code> \u7ed3\u6784\u4f53\u5462\uff1f</p> <p>\u8fd9\u5c31\u9700\u8981\u4f7f\u7528\u7f16\u8bd1\u5668\u9b54\u6cd5\u4e86\uff1a<code>container_of</code> \u5b8f\u3002\u5b83\u7684\u5b9a\u4e49\u5982\u4e0b\uff1a</p> kernel/arch/riscv/include/list.h<pre><code>#define container_of(ptr, type, member) ({          \\\n    const typeof( ((type *)0)-&gt;member ) *__mptr = (ptr); \\\n    (type *)( (char *)__mptr - offsetof(type,member) );})\n</code></pre> <p>\u7f16\u8bd1\u5668\u77e5\u9053\u7c7b\u578b\u7684\u5927\u5c0f\uff0c\u63d0\u4f9b\u4e86 <code>typeof()</code> \u548c <code>offestof()</code>\u3002\u6211\u4eec\u53ef\u4ee5\u5229\u7528\u8fd9\u4e9b\u4fe1\u606f\u79fb\u52a8\u6210\u5458\u53d8\u91cf\u7684\u6307\u9488\uff0c\u8ba1\u7b97\u51fa\u5305\u542b\u8be5\u6210\u5458\u53d8\u91cf\u7684\u7ed3\u6784\u4f53\u7684\u8d77\u59cb\u5730\u5740\u3002\u4f8b\u5982\uff1a</p> container_of \u4f7f\u7528\u793a\u4f8b<pre><code>struct data_node_A a;\nstruct list_head *p = &amp;a.list;\nstruct data_node_A *q = container_of(p, struct data_node_A, list);\nassert(q == &amp;a); // q \u6070\u597d\u6307\u5411 a \u7684\u8d77\u59cb\u5730\u5740\n</code></pre> </li> </ul>      \u4fb5\u5165\u5f0f\u53cc\u5411\u5faa\u73af\u94fe\u8868\u793a\u610f\u56fe      <p>\u5b9e\u73b0\u94fe\u8868\u8fd8\u7ed9\u6211\u4eec\u9644\u5e26\u4e86\u4e00\u4e2a\u60ca\u559c\uff1a\u5b9e\u73b0\u4e86\u961f\u5217\u3002\u540c\u5b66\u4eec\u5728\u6570\u636e\u7ed3\u6784\u8bfe\u4e0a\u5df2\u7ecf\u5b66\u8fc7\uff0c\u53cc\u5411\u5faa\u73af\u94fe\u8868\u5b9e\u73b0\u4e86\u53cc\u7aef\u961f\u5217\uff08deque\uff09\uff0c\u5b83\u652f\u6301\u5728\u5934\u5c3e\u4e24\u7aef\u9ad8\u6548\u5730\u63d2\u5165\u548c\u5220\u9664\u8282\u70b9\u3002\u4e8e\u662f\u6211\u4eec\u6709\u5b9e\u73b0\u591a\u7ea7\u53cd\u9988\u961f\u5217\u8c03\u5ea6\u5668\u6240\u9700\u7684\u5de5\u5177\u4e86\u3002</p> <p>\u8981\u70b9\uff1a\u4fb5\u5165\u5f0f\u53cc\u5411\u5faa\u73af\u94fe\u8868</p> <ul> <li>\u4fb5\u5165\u5f0f\u94fe\u8868\u5c06\u94fe\u8868\u8282\u70b9\u5d4c\u5165\u6570\u636e\u7ed3\u6784\u4e2d\uff0c\u652f\u6301\u6cdb\u578b\u63a5\u53e3\uff0c\u4ee3\u7801\u590d\u7528\u6027\u5f3a\u3002</li> <li>\u901a\u8fc7 <code>container_of</code> \u5b8f\uff0c\u53ef\u4ee5\u4ece\u94fe\u8868\u8282\u70b9\u6307\u9488\u8ba1\u7b97\u51fa\u5305\u542b\u5b83\u7684\u7ed3\u6784\u4f53\u6307\u9488\u3002</li> </ul> <p>\u66f4\u591a\u8d44\u6599</p> <ul> <li>Intrusive linked lists - Data structures in practice</li> </ul>"},{"location":"lab2/#task-1\u5b9e\u73b0\u53cc\u5411\u94fe\u8868","title":"Task 1\uff1a\u5b9e\u73b0\u53cc\u5411\u94fe\u8868","text":"<p>\u4f60\u5e94\u8be5\u65e9\u5728\u5927\u4e00\u7684 C \u8bed\u8a00\u8bfe\u4e0a\u5c31\u80fd\u79d2\u6740\u53cc\u5411\u94fe\u8868\u4e86 \ud83d\ude09\u3002\u8bf7\u8865\u5168 <code>kernel/arch/riscv/include/list.h</code>\uff1a</p> <ul> <li>\u63d0\u793a\uff1a\u89c2\u5bdf <code>LIST_HEAD</code> \u5b8f\uff0c\u4f60\u4f1a\u53d1\u73b0\u8fd9\u5e94\u8be5\u662f\u4e00\u4e2a\u5e26\u54e8\u5175\u7684\u53cc\u5411\u94fe\u8868\u3002\u601d\u8003\u5982\u679c\u4e0d\u5e26\u54e8\u5175\uff0c\u5b83\u5e94\u5f53\u8be5\u5982\u4f55\u5b9e\u73b0\uff1f</li> <li>\u8865\u5168 <code>list_empty()</code>\u3002</li> <li>\u8865\u5168 <code>list_add()</code>\u3001<code>list_add_tail()</code> \u548c <code>list_del()</code>\u3002\u63d0\u793a\uff1a\u4e00\u4e2a\u4f18\u96c5\u7684\u505a\u6cd5\u662f\u4ee4 <code>list_add()</code> \u548c <code>list_add_tail()</code> \u90fd\u8c03\u7528\u4e00\u4e2a\u66f4\u5e95\u5c42\u7684 <code>__list_add()</code>\u3002</li> <li>\u8865\u5168 <code>list_for_each</code> \u5b8f\u3002</li> </ul> <p>\u5b8c\u6210\u6761\u4ef6</p> <ul> <li>\u901a\u8fc7\u8bc4\u6d4b\u6846\u67b6\u7684 <code>lab2 task1</code> \u6d4b\u8bd5\u3002</li> </ul> <p><code>kernel/arch/riscv/kernel/test_list.c</code> \u4e2d\u7684 <code>test_list()</code> \u51fd\u6570\u7528\u4e8e\u6d4b\u8bd5\u4f60\u7684\u94fe\u8868\u5b9e\u73b0\u3002</p>"},{"location":"lab2/#\u7a7a\u95f2\u94fe\u8868\u7f13\u5b58","title":"\u7a7a\u95f2\u94fe\u8868\u7f13\u5b58","text":"<p>\u672c\u8282\u5229\u7528\u94fe\u8868\u5b9e\u73b0\u4e00\u4e2a\u5185\u6838\u4e2d\u975e\u5e38\u5e38\u89c1\u7684\u673a\u5236\u2014\u2014\u5bf9\u8c61\u7f13\u5b58\uff08object cache\uff09\u3002</p> <p>\u5728\u5185\u6838\u4e2d\uff0c\u8bb8\u591a\u5185\u6838\u5bf9\u8c61\uff08\u5982 <code>task_struct</code>\u3001<code>inode</code>\u3001<code>vm_area_struct</code> \u7b49\uff09\u4f1a\u88ab\u9891\u7e41\u521b\u5efa\u548c\u9500\u6bc1\u3002\u5982\u679c\u52a8\u6001\u521b\u5efa\u90fd\u8c03\u7528\u901a\u7528\u7684\u5185\u5b58\u5206\u914d\u5668\uff08\u5982 Buddy System\uff09\uff0c\u4f1a\u5bf9\u6027\u80fd\u4ea7\u751f\u8f83\u5927\u5f71\u54cd\uff0c\u4e14\u5bb9\u6613\u5f15\u8d77\u5185\u5b58\u788e\u7247\u3002</p> <p>\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e9b\u95ee\u9898\uff0cLinux \u5185\u6838\u5f15\u5165\u4e86 Slab \u5206\u914d\u5668\uff1a\u5b83\u4e3a\u6bcf\u79cd\u7c7b\u578b\u7684\u5bf9\u8c61\u7ef4\u62a4\u4e00\u4e2a\u7f13\u5b58\u6c60\uff0c\u5c06\u6574\u9875\u5185\u5b58\u5207\u5206\u4e3a\u591a\u4e2a\u56fa\u5b9a\u5927\u5c0f\u7684\u5bf9\u8c61\u5757\uff0c\u7528\u94fe\u8868\u7ba1\u7406\u8fd9\u4e9b\u7a7a\u95f2\u5bf9\u8c61\u3002\u6362\u53e5\u8bdd\u8bf4\uff0cSlab \u7f13\u5b58\u5c42\uff08<code>kmem_cache</code>\uff09\u76f8\u5f53\u4e8e\u7269\u7406\u9875\u5206\u914d\u5668\uff08<code>alloc_page()</code>\uff09\u4e4b\u4e0a\u7684\u5bf9\u8c61\u7c92\u5ea6\u7684\u518d\u5206\u914d\u5c42\u3002</p> <p>\u4e0d\u8fc7\uff0cLinux \u7684 Slab \u5b9e\u73b0\u66f4\u52a0\u590d\u6742\uff0c\u611f\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u9605\u8bfb Slab Layer - Linux Kernel Development Second Edition\u3002\u5728\u6211\u4eec\u7684\u6559\u5b66\u5b9e\u9a8c\u4e2d\uff0c\u53ea\u4fdd\u7559\u4e86\u5b83\u7684\u6838\u5fc3\u601d\u60f3\uff1a\u7528\u7a7a\u95f2\u94fe\u8868\uff08free list\uff09\u9884\u5206\u914d\u7f13\u5b58\u5bf9\u8c61\u3002</p> <p><code>kernel/arch/riscv/include/cache.h</code> \u548c <code>kernel/arch/riscv/include/cache.c</code> \u5b9e\u73b0\u4e86 Slab \u5206\u914d\u5668\uff0c\u8981\u6c42\u540c\u5b66\u4eec\u9605\u8bfb\u4ee3\u7801\u5e76\u7406\u89e3\u5176\u5de5\u4f5c\u539f\u7406\u3002</p> <p>\u52a8\u624b\u505a\uff1a\u7406\u89e3\u7a7a\u95f2\u94fe\u8868</p> <p>\u9605\u8bfb <code>cache.h</code> \u548c <code>cache.c</code>\uff0c\u7406\u89e3\u7a7a\u95f2\u94fe\u8868\u7f13\u5b58\u7684\u5b9e\u73b0\u3002</p> <p>\u753b\u4e00\u5e45\u56fe\uff0c\u5c55\u793a\u76f8\u5173\u7684\u6570\u636e\u7ed3\u6784\u53ca\u5176\u5e03\u5c40\u3002</p> <p>\u8003\u70b9\uff1a\u5185\u5b58\u7ba1\u7406\u4e0e\u57fa\u7840\u6570\u636e\u7ed3\u6784</p> <ul> <li>Buddy System \u4e0e\u5bf9\u8c61\u7f13\u5b58\uff08kmem_cache\uff09\u7684\u804c\u8d23\u8fb9\u754c\u5206\u522b\u662f\u4ec0\u4e48\uff1f\u5206\u522b\u9002\u7528\u54ea\u4e9b\u573a\u666f\uff1f</li> <li>\u91ca\u653e\u9875\u6846\u65f6\uff0cBuddy \u4e3a\u4ec0\u4e48\u80fd\u201c\u5411\u4e0a\u5408\u5e76\u201d\uff1f\u4f19\u4f34\u5757\uff08buddy\uff09\u7684\u5730\u5740\u5982\u4f55\u6839\u636e\u5f53\u524d\u5757\u5927\u5c0f\u8ba1\u7b97\uff1f</li> <li>\u4fb5\u5165\u5f0f\u53cc\u5411\u5faa\u73af\u94fe\u8868\u4e3a\u4f55\u80fd\u5b9e\u73b0\u201c\u6cdb\u578b\u201d\uff1f<code>container_of</code> \u5982\u4f55\u4ece <code>list_head*</code> \u8fd8\u539f\u5230\u5bbf\u4e3b\u7ed3\u6784\u4f53\u6307\u9488\uff1f</li> <li>\u5b9e\u73b0 <code>list_add</code>/<code>list_add_tail</code>/<code>list_del</code> \u65f6\uff0c\u5e26\u54e8\u5175\u5faa\u73af\u94fe\u8868\u6709\u54ea\u4e9b\u6613\u9519\u70b9\uff08\u4f8b\u5982\u81ea\u73af\u3001\u987a\u5e8f\u3001\u7a7a\u8868\u5224\u65ad\uff09\uff1f</li> </ul>"},{"location":"lab2/#part-2\u8fdb\u7a0b\u5207\u6362\u4e0e-trap-\u5904\u7406","title":"Part 2\uff1a\u8fdb\u7a0b\u5207\u6362\u4e0e Trap \u5904\u7406","text":"<p>\u672c\u8282\u6211\u4eec\u63a2\u7a76\u5b9e\u73b0\u7528\u4e8e\u5207\u6362\u8fdb\u7a0b\u4e0a\u4e0b\u6587\u7684\u6c47\u7f16\u51fd\u6570 <code>__switch_to()</code>\uff0c\u4ee5\u53ca\u8fdb\u7a0b\u5207\u6362\u4e0e Trap \u5904\u7406\u7684\u76f8\u4e92\u5f71\u54cd\u3002</p>"},{"location":"lab2/#\u8fdb\u7a0b\u5207\u6362\u975e\u62a2\u5360\u60c5\u51b5","title":"\u8fdb\u7a0b\u5207\u6362\uff1a\u975e\u62a2\u5360\u60c5\u51b5","text":"<p>\u8ba9\u6211\u4eec\u4ece\u6700\u7b80\u5355\u7684\u4e0d\u8003\u8651 Trap \u7684\u60c5\u51b5\u5f00\u59cb\u3002\u8fd9\u79cd\u60c5\u51b5\u4e0b\u6ca1\u6709\u65f6\u949f\u4e2d\u65ad\uff0c\u8fdb\u7a0b\u5207\u6362\u4ec5\u80fd\u4f9d\u9760\u8fdb\u7a0b\u4e3b\u52a8\u8c03\u7528 <code>__switch_to()</code> \u5b8c\u6210\uff0c\u5185\u6838\u662f\u975e\u62a2\u5360\u5f0f\u7684\u3002</p> <p>\u8bbe\u60f3\u8fd9\u6837\u4e00\u4e2a\u573a\u666f\uff1aCPU \u4e0a\u6b63\u5728\u8fd0\u884c Task1\uff0cTask1 \u60f3\u8c03\u7528 <code>__switch_to()</code> \u5207\u6362\u5230 Task2\uff0c\u7136\u540e Task2 \u8fd0\u884c\u4e00\u6bb5\u65f6\u95f4\u540e\u518d\u5207\u6362\u56de\u6765\u7ee7\u7eed\u6267\u884c Task1\u3002<code>__switch_to()</code> \u5e94\u8be5\u600e\u4e48\u8bbe\u8ba1\uff1f</p> <p>Lab 1 Trap \u5904\u7406\u7684\u573a\u666f\u4e0e\u6b64\u7c7b\u4f3c\uff1a\u53ef\u4ee5\u5c06 <code>_traps()</code> \u770b\u4f5c <code>__switch_to()</code>\uff0c\u5c06 <code>trap_handler()</code> \u770b\u4f5c Task2\u3002<code>trap_handler()</code> \u6267\u884c\u5b8c\u6bd5\u540e\uff0c\u6062\u590d Trap \u4e0a\u4e0b\u6587\u5c31\u76f8\u5f53\u4e8e Task2 \u5207\u6362\u56de Task1\u3002\u4f46\u8fdb\u7a0b\u5207\u6362\u4e0e Trap \u6709\u4e00\u4e2a\u91cd\u8981\u533a\u522b\uff1aTrap \u53ef\u4ee5\u53d1\u751f\u5728\u4efb\u4f55\u65f6\u5019\uff0c\u56e0\u6b64 Trap \u4e0a\u4e0b\u6587\u662f\u6240\u6709\u5bc4\u5b58\u5668\u7684\u72b6\u6001\uff1b\u800c <code>__switch_to()</code> \u662f\u4e00\u4e2a\u51fd\u6570\uff0c\u5b83\u7684\u8c03\u7528\u8005\u4e00\u5b9a\u662f\u9075\u5b88 RISC-V \u8c03\u7528\u7ea6\u5b9a\u7684\uff0c\u56e0\u6b64\u4e0d\u9700\u8981\u4fdd\u5b58\u6240\u6709\u5bc4\u5b58\u5668\u3002\u793a\u610f\u56fe\u5982\u4e0b\uff1a</p> <code>__switch_to()</code> \u7684\u8c03\u7528\u548c\u8fd4\u56de\u8def\u5f84      <p>\u7406\u89e3\u4e86\u8fd9\u4e9b\uff0c\u6211\u4eec\u5bb9\u6613\u8bbe\u8ba1\u51fa <code>__switch_to()</code> \u9700\u8981\u4fdd\u5b58\u7684\u8fdb\u7a0b\u4e0a\u4e0b\u6587\uff1a</p> <ul> <li><code>ra</code>\uff1a\u51fd\u6570\u8fd4\u56de\u5730\u5740\uff0c\u6211\u4eec\u9700\u8981\u5b83\u6765\u8fd4\u56de\u5230\u8c03\u7528 <code>__switch_to()</code> \u7684\u4f4d\u7f6e</li> <li><code>sp</code>\u3001<code>s0-s11</code>\uff1a\u8c03\u7528\u7ea6\u5b9a\u4e2d\u89c4\u5b9a\u7684 callee-saved \u5bc4\u5b58\u5668</li> </ul> <p>\u4e8e\u662f\u6211\u4eec\u5199\u51fa\u4e86\u8fdb\u7a0b\u4e0a\u4e0b\u6587\u7684\u6570\u636e\u7ed3\u6784\uff1a</p> <pre><code>struct thread_struct {\n    uint64 ra;      // return address\n    uint64 sp;      // stack pointer\n    uint64 s[12];   // callee-saved registers\n};\n</code></pre> <p>\u90a3\u4e48\u8fd9\u4e2a\u7ed3\u6784\u4f53\u5e94\u8be5\u5b58\u653e\u5728\u54ea\u91cc\u5462\uff1f\u5177\u4f53\u5b58\u653e\u7684\u4f4d\u7f6e\u6682\u4e14\u6309\u4e0b\u4e0d\u8868\uff0c\u7559\u5230\u8bbe\u8ba1\u8fdb\u7a0b\u6570\u636e\u7ed3\u6784\u65f6\u518d\u8bf4\u3002\u5148\u5047\u8bbe\u8c03\u7528 <code>__switch_to()</code> \u65f6 <code>a0</code> \u548c <code>a1</code> \u5206\u522b\u6307\u5411 Task1 \u548c Task2 \u7684 <code>thread_struct</code> \u7ed3\u6784\u4f53\uff0c\u90a3\u4e48 <code>__switch_to()</code> \u7684\u5b9e\u73b0\u5c31\u5f88\u7b80\u5355\u4e86\uff1a</p> \u7b2c\u4e00\u7248 __switch_to<pre><code>    .globl __switch_to\n__switch_to:\n    sd ra, 0(a0)          // \u4fdd\u5b58 Task1 \u4e0a\u4e0b\u6587\n    sd sp, 8(a0)\n    sd s0, 16(a0)\n    ...\n\n    ld ra, 0(a1)          // \u6062\u590d Task2 \u4e0a\u4e0b\u6587\n    ld sp, 8(a1)\n    ld s0, 16(a1)\n    ...\n    ret                    // \u8fd4\u56de\u5230 Task2\n</code></pre> <p>\u8fd8\u80fd\u518d\u6362\u4e2a\u89d2\u5ea6\uff1a\u7ad9\u5728 Task1 \u7684\u89d2\u5ea6\u770b\uff0c\u8c03\u7528 <code>__switch_to()</code> \u5c31\u50cf\u8c03\u7528\u4e86\u4e00\u4e2a\u7a7a\u51fd\u6570\u3002\u5b83\u9075\u5b88 RISC-V \u8c03\u7528\u7ea6\u5b9a\uff0c\u4f46\u4ec0\u4e48\u90fd\u6ca1\u505a\uff0c\u539f\u8def\u8fd4\u56de\u4e86\u3002</p> <p>\u4f46\u5207\u6362\u7684\u76ee\u6807 Task 2 \u7684\u4e0a\u4e0b\u6587\u4ece\u54ea\u91cc\u6765\uff1f\u5bf9\u4e8e\u76ee\u524d\u4e0d\u8003\u8651 Trap \u7684\u573a\u666f\u6765\u8bf4\uff0c\u53ea\u6709\u4e24\u79cd\u53ef\u80fd\uff1a</p> <ol> <li>Task 2 \u4e4b\u524d\u8fd0\u884c\u8fc7\uff0c\u4f46\u4e3b\u52a8\u8c03\u7528 <code>__switch_to()</code> \u5207\u6362\u5230\u522b\u7684\u8fdb\u7a0b\u3002\u8fd9\u79cd\u60c5\u51b5\u4fdd\u5b58\u8fc7\u8fdb\u7a0b\u4e0a\u4e0b\u6587\uff0c\u80fd\u591f\u987a\u5229\u6062\u590d\u3002</li> <li>Task 2 \u662f\u65b0\u521b\u5efa\u7684\u8fdb\u7a0b\uff0c\u5c1a\u672a\u8fd0\u884c\u8fc7\u3002\u8fd9\u79cd\u60c5\u51b5\u9700\u8981\u6211\u4eec\u8bbe\u8ba1\u4e00\u4e2a\u521d\u59cb\u7684\u8fdb\u7a0b\u4e0a\u4e0b\u6587\u3002</li> </ol> <p>\u521d\u59cb\u8fdb\u7a0b\u4e0a\u4e0b\u6587\u7684\u8bbe\u8ba1\u4e5f\u5f88\u7b80\u5355\uff1a\u4ee4 <code>ra</code> \u6307\u5411\u8fdb\u7a0b\u7684\u7b2c\u4e00\u6761\u6307\u4ee4\uff0c<code>__switch_to()</code> \u5c31\u4f1a\u8df3\u8fc7\u53bb\u5f00\u59cb\u6267\u884c\u3002\u5982\u679c\u8981\u8003\u8651\u5411\u8fdb\u7a0b\u4f20\u9012\u53c2\u6570\uff0c\u53ef\u4ee5\u5229\u7528 <code>s0-s11</code> \u8fd9\u4e9b\u5bc4\u5b58\u5668\uff0c\u7136\u540e\u8bbe\u7f6e\u4e00\u4e2a\u8e66\u5e8a\u51fd\u6570\uff08trampoline\uff09\u6765\u5c06\u5176\u79fb\u52a8\u5230 <code>a0-a7</code> \u4f5c\u4e3a\u53c2\u6570\u3002\u4e8b\u5b9e\u4e0a Linux \u5c31\u662f\u8fd9\u4e48\u5b9e\u73b0 kthread \u7684\u521d\u59cb\u4e0a\u4e0b\u6587\u7684\uff0c\u8fd9\u4e2a\u8e66\u5e8a\u51fd\u6570\u5982\u4e0b\u6240\u793a\uff1a</p> (Linux)arch/riscv/kernel/entry.S<pre><code>SYM_CODE_START(ret_from_fork_kernel_asm)\n    call schedule_tail\n    move a0, s1 /* fn_arg */\n    move a1, s0 /* fn */\n    move a2, sp /* pt_regs */\n    call ret_from_fork_kernel\n    j ret_from_exception\nSYM_CODE_END(ret_from_fork_kernel_asm)\n</code></pre> (Linux)arch/riscv/kernel/process.c<pre><code>asmlinkage void ret_from_fork_kernel(void *fn_arg, int (*fn)(void *), struct pt_regs *regs)\n{\n    fn(fn_arg);\n\n    syscall_exit_to_user_mode(regs);\n}\n</code></pre> <p>\u4ece\u4ee3\u7801\u4e2d\u53ef\u4ee5\u770b\u51fa\uff0cLinux \u5c06 kthread \u8981\u8fd0\u884c\u7684\u51fd\u6570 <code>fn</code> \u653e\u5728\u4e86\u521d\u59cb\u8fdb\u7a0b\u4e0a\u4e0b\u6587\u7684 <code>s0</code> \u5bc4\u5b58\u5668\u4e2d\uff0c\u5c06\u53c2\u6570 <code>fn_arg</code> \u653e\u5728\u4e86 <code>s1</code> \u5bc4\u5b58\u5668\u4e2d\u3002\u8e66\u5e8a\u51fd\u6570 <code>ret_from_fork_kernel_asm</code> \u5c06\u5b83\u4eec\u5206\u522b\u79fb\u52a8\u5230 <code>a1</code> \u548c <code>a0</code>\uff0c\u7136\u540e\u8c03\u7528 <code>ret_from_fork_kernel</code> \u53bb\u5177\u4f53\u6267\u884c\u3002</p>"},{"location":"lab2/#\u8fdb\u7a0b\u5207\u6362\u62a2\u5360\u4e0e-trap-\u5904\u7406","title":"\u8fdb\u7a0b\u5207\u6362\uff1a\u62a2\u5360\u4e0e Trap \u5904\u7406","text":"<p>\u5f53\u6211\u4eec\u5e0c\u671b\u5b9e\u73b0\u5185\u6838\u62a2\u5360\uff08Kernel preemption\uff09\u65f6\uff0c\u60c5\u51b5\u5c31\u53d8\u5f97\u590d\u6742\u4e86\u8d77\u6765\uff0c\u9700\u8981\u7efc\u5408\u8003\u8651\u65f6\u949f\u4e2d\u65ad\u3001\u7cfb\u7edf\u8c03\u7528\u7b49 Trap \u60c5\u51b5\u3002</p>"},{"location":"lab2/#\u5207\u6362\u8c03\u5ea6trap-\u4e0e\u62a2\u5360\u7684\u5173\u7cfb","title":"\u5207\u6362\u3001\u8c03\u5ea6\u3001Trap \u4e0e\u62a2\u5360\u7684\u5173\u7cfb","text":"<p>\u5148\u7406\u6e05\u51e0\u4e2a\u6982\u5ff5\uff1a</p> <ul> <li> <p>\u8fdb\u7a0b\u5207\u6362\uff08context switch\uff09\uff1a</p> <p>\u7531\u4e0a\u6587\u8ba8\u8bba\u7684 <code>__switch_to()</code> \u6267\u884c\uff0c\u5b8c\u6210\u8fdb\u7a0b\u4e0a\u4e0b\u6587\u5207\u6362</p> </li> <li> <p>\u8c03\u5ea6\uff08schedule\uff09\uff1a</p> <p>\u7531\u5c06\u5728 Part 4 \u4ecb\u7ecd\u7684 <code>schedule()</code> \u6267\u884c\uff0c\u4f7f\u7528\u8c03\u5ea6\u7b97\u6cd5\u9009\u62e9\u8981\u5207\u6362\u5230\u7684\u8fdb\u7a0b\uff0c\u5e76\u8c03\u7528 <code>__switch_to()</code> \u5b8c\u6210\u5207\u6362</p> </li> <li> <p>Trap\uff1a</p> <p>CPU \u5f02\u5e38\u548c\u4e2d\u65ad\u5f15\u53d1\uff0c\u53ef\u80fd\u53d1\u751f\u5728\u4efb\u4f55\u65f6\u5019\uff0c\u7531 <code>_traps()</code> \u5904\u7406\uff0c\u8d1f\u8d23\u4fdd\u5b58\u548c\u6062\u590d Trap \u4e0a\u4e0b\u6587</p> </li> <li> <p>\u62a2\u5360\uff1a</p> <p>\u5728\u8fdb\u7a0b\u4e0d\u4e3b\u52a8\u6267\u884c\u5207\u6362\u6216\u8c03\u5ea6\u7684\u60c5\u51b5\u4e0b\uff0c\u80fd\u591f\u6253\u65ad\u5f53\u524d\u8fdb\u7a0b\u7684\u6267\u884c\u89e6\u53d1\u8c03\u5ea6\uff0c\u4ece\u800c\u5b9e\u73b0\u65f6\u95f4\u590d\u7528</p> </li> </ul> <p>\u8fd9\u51e0\u4e2a\u6982\u5ff5\u7684\u8054\u7cfb\u662f\uff1a\u62a2\u5360\u662f\u901a\u8fc7\u5728 Trap \u9000\u51fa\u8def\u5f84\u4e0a\u89c6\u60c5\u51b5\u8c03\u5ea6\u5b9e\u73b0\u7684\u3002\u63a5\u4e0b\u6765\u7684\u51e0\u8282\u6211\u4eec\u5c06\u5206\u6790\u8fd9\u4e00\u5173\u7cfb\u3002</p>"},{"location":"lab2/#\u5185\u6838\u4e2d\u4e0d\u80fd\u88ab-trap-\u7684\u90e8\u5206","title":"\u5185\u6838\u4e2d\u4e0d\u80fd\u88ab Trap \u7684\u90e8\u5206","text":"<p>\u9996\u5148\uff0c\u6211\u4eec\u8981\u660e\u786e\u5185\u6838\u4e2d\u4e0d\u80fd\u88ab Trap \u7684\u90e8\u5206\u3002\u56de\u5fc6 RISC-V \u4e2d\u65ad\u673a\u5236\uff0c\u8fdb\u5165 Trap \u5904\u7406\u65f6\uff0cCPU \u4f1a\u81ea\u52a8\u6267\u884c\u4e0b\u9762\u7684\u64cd\u4f5c\u7981\u7528\u4e2d\u65ad\uff1a</p> <ul> <li><code>sstatus.SPIE = sstatus.SIE</code></li> <li><code>sstatus.SIE = 0</code></li> </ul> <p>\u6b64\u5916\uff0c\u6211\u4eec\u8bbe\u8ba1 <code>_traps()</code> \u65f6\u4f1a\u786e\u4fdd\u4e0d\u89e6\u53d1\u5f02\u5e38\u3002\u6240\u4ee5\uff0cTrap \u5904\u7406\u8fc7\u7a0b\u662f\u4e0d\u4f1a\u88ab Trap \u7684\u3002</p> <p>\u5176\u4ed6\u90e8\u5206\u4f3c\u4e4e\u90fd\u53ef\u4ee5\u88ab Trap\uff0c\u6bd5\u7adf\u6211\u4eec\u8bbe\u8ba1 <code>_traps()</code> \u65f6\u5c31\u8003\u8651\u5230\u5b83\u968f\u65f6\u53ef\u80fd\u53d1\u751f\uff0c\u4f1a\u5c06\u6240\u6709\u6574\u6570\u5bc4\u5b58\u5668\u4fdd\u5b58\u5230 Trap \u4e0a\u4e0b\u6587\u4e2d\u3002</p>"},{"location":"lab2/#\u62a2\u5360\u7684\u65f6\u673a","title":"\u62a2\u5360\u7684\u65f6\u673a","text":"<p>\u8981\u5b9e\u73b0\u62a2\u5360\uff0c\u53ea\u80fd\u5bc4\u5e0c\u671b\u4e8e\uff08\u65f6\u949f\uff09\u4e2d\u65ad\u6253\u65ad Task1 \u7684\u6267\u884c\uff0c\u624d\u6709\u673a\u4f1a\u5207\u6362\u5230 Task2\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u7528\u6392\u9664\u6cd5\u548c\u53cd\u8bc1\u6cd5\u5bfb\u627e\u8fd9\u4e2a\u673a\u4f1a\u5728\u54ea\u91cc\uff1a</p> <ul> <li>Trap \u4e0a\u4e0b\u6587\u6062\u590d\u8fc7\u7a0b\u663e\u7136\u4e0d\u80fd\u5207\u6362\uff0c\u5426\u5219\u5c31\u7834\u574f Trap \u4e0a\u4e0b\u6587\u4e86\u3002</li> <li>Trap \u4e0a\u4e0b\u6587\u6062\u590d\u5b8c\u6210\uff08\u79bb\u5f00 <code>_traps()</code>\uff09\u540e\uff0c\u5c31\u56de\u5230 Task 1 \u6ca1\u673a\u4f1a\u5207\u6362\u8fdb\u7a0b\u4e86\u3002</li> <li> <p>Trap \u5904\u7406\u8fc7\u7a0b\uff08<code>trap_handler()</code>\uff09\u4e0d\u80fd <code>__switch_to()</code>\uff0c\u56e0\u4e3a\u4e2d\u65ad\u8fd8\u6ca1\u5904\u7406\u5b8c\u3002</p> <p>Trap \u7684\u5904\u7406\u8fc7\u7a0b\u6307\u7684\u662f\u4ece <code>xIP.i</code> \u7f6e 1\u3001\u4e2d\u65ad Pending \u5f00\u59cb\uff0c\u5230\u8be5 Pending \u4f4d\u88ab\u7f6e 0 \u4e3a\u6b62\u3002\u4ee5 Lab1 \u6d89\u53ca\u7684 Trap \u60c5\u51b5\u4e3a\u4f8b\uff1a</p> <ul> <li>\u65f6\u949f\u4e2d\u65ad\u7684\u5904\u7406\u4ece SEE \u53d1\u73b0 <code>stimecmp &gt; stime</code> \u7136\u540e\u5c06 <code>STIP</code> \u7f6e 1 \u5f00\u59cb\uff0c\u5230 <code>sbi_set_timer()</code> \u5c06 <code>STIP</code> \u7f6e 0 \u7ed3\u675f</li> <li>\u8f6f\u4ef6\u4e2d\u65ad\u7684\u5904\u7406\u4ece <code>SSIP</code> \u7f6e 1 \u5f00\u59cb\uff0c\u5230 <code>clear_ssip()</code> \u5c06 <code>SSIP</code> \u7f6e 0 \u7ed3\u675f\u3002</li> </ul> <p>\u5982\u679c Trap \u5904\u7406\u672a\u5b8c\u6210\u5c31\u5207\u6362\uff1a</p> <ul> <li>\u56e0\u4e3a\u5207\u6362\u4e0d\u6d89\u53ca <code>SIE</code>\uff0c\u65b0\u7684\u8fdb\u7a0b\u7ee7\u7eed\u8fd0\u884c\u5728\u4e2d\u65ad\u7981\u7528\u7684\u72b6\u6001\uff0c\u65e0\u6cd5\u54cd\u5e94\u65b0\u7684\u4e2d\u65ad\u3002</li> <li> <p>\u5982\u679c\u975e\u8981\u6253\u5f00 <code>SIE</code>\uff0c\u90a3\u4e48 CPU \u9a6c\u4e0a\u4f1a\u518d\u6b21\u89e6\u53d1\u8be5 Trap\uff0c\u518d\u6b21\u8fdb\u5165 <code>_traps()</code>\uff0c\u91cd\u590d\u5faa\u73af\u4e0b\u53bb\u5bfc\u81f4\u6808 <code>sp</code> \u6ea2\u51fa\u3002</p> <p>\u4f60\u662f\u5426\u60f3\u8d77\u8fd9\u4e00\u60c5\u51b5\u4e0e Lab1\u300c\u52a8\u624b\u505a\u300d\u63a2\u7a76\u7684\u4e3a\u4ec0\u4e48\u80fd\u8fdb\u5165 <code>printk()</code> \u7c7b\u4f3c\u3002<code>printk()</code> \u7684\u60c5\u51b5\u6bd4\u8f83\u5e78\u8fd0\uff0c<code>sp</code> \u6700\u521d\u4f4d\u4e8e OpenSBI \u4fdd\u62a4\u7684\u5730\u5740\uff0c\u7206\u6808\u4e5f\u6ca1\u6709\u7834\u574f OpenSBI \u7684\u4ee3\u7801\u548c\u6570\u636e\uff0c\u6700\u7ec8\u8d70\u5230\u4e86 <code>0x7???????</code> \u4e4b\u7c7b\u7684\u4f4d\u7f6e\uff08\u5e76\u672a\u63a2\u7a76\u8fd9\u662f\u4ec0\u4e48\u5730\u65b9\uff0c\u53cd\u6b63\u65e2\u4e0d\u662f\u5185\u6838\u4e5f\u4e0d\u662f OpenSBI\uff09\u3002\u4f46\u662f\u5f53\u6211\u4eec\u5c06 <code>sp</code> \u8bbe\u7f6e\u4e3a\u5185\u6838\u6808\u540e\uff0c\u7206\u6808\u5411\u4e0b\u589e\u957f\u5c06\u76f4\u63a5\u7834\u574f\u5185\u6838\u6570\u636e\uff08data \u6bb5\uff09\u548c\u4ee3\u7801\uff08text \u6bb5\uff09\uff0c\u5bfc\u81f4\u7cfb\u7edf\u5d29\u6e83\u3002</p> </li> </ul> <p>Tip</p> <p>\u6ca1\u6709\u7406\u89e3\u4e0a\u9762\u8bba\u8ff0\u7684\u540c\u5b66\uff0c\u8bf7\u4ed4\u7ec6\u9605\u8bfb RISC-V \u7279\u6743\u7ea7\u624b\u518c 3.1.9. Machine Interrupt (mip and mie) Registers \u90e8\u5206\uff0c\u5f7b\u5e95\u7406\u89e3\u4e2d\u65ad\u89e6\u53d1\u548c\u6e05\u9664\u7684\u673a\u5236\u3002</p> </li> </ul> <p>\u901a\u8fc7\u4e0a\u9762\u7684\u8ba8\u8bba\uff0c\u6211\u4eec\u53ea\u80fd\u5c06 <code>__switch_to()</code> \u5b89\u6392\u5728 <code>trap_handler()</code> \u7684\u672b\u5c3e\u3002</p>"},{"location":"lab2/#\u8fdb\u7a0b\u5207\u6362\u5f15\u5165\u5e76\u53d1","title":"\u8fdb\u7a0b\u5207\u6362\uff1a\u5f15\u5165\u5e76\u53d1","text":"<p>\u5728\u4e0a\u4e24\u8282\u7684\u8bba\u8ff0\u4e2d\uff0c\u6211\u4eec\u5df2\u7ecf\u8bf4\u660e\u4e86\u8fdb\u7a0b\u5207\u6362\u7684\u4e24\u79cd\u53ef\u80fd\u6027\uff1a</p> <ol> <li>\u975e\u62a2\u5360\u5f0f\uff1a\u53d1\u751f\u65f6\u673a\u786e\u5b9a\uff0c\u5728\u8fdb\u7a0b\u4e3b\u52a8\u8c03\u7528 <code>__switch_to()</code> \u65f6\u53d1\u751f\uff1b</li> <li>\u62a2\u5360\u5f0f\uff1a\u53d1\u751f\u65f6\u673a\u4e0d\u786e\u5b9a\uff0c\u53ea\u8981\u53d1\u751f\uff08\u65f6\u949f\uff09\u4e2d\u65ad\uff0c<code>trap_handler()</code> \u5c31\u4f1a\u8c03\u7528 <code>__switch_to()</code>\uff0c\u53d1\u751f\u8fdb\u7a0b\u5207\u6362\u3002</li> </ol> <p>\u5173\u4e8e <code>__switch_to()</code> \u548c <code>schedule()</code> \u5173\u7cfb\u7684\u8bf4\u660e</p> <p>\u4e8b\u5b9e\u4e0a\uff0c\u4e0a\u9762\u7684\u8bba\u8ff0\u4e0d\u5b8c\u5168\u51c6\u786e\u3002\u540c\u5b66\u4eec\u5c06\u5728 Task 4 \u4e2d\u5b9e\u73b0<code>schedule()</code> \u51fd\u6570\uff0c\u6211\u4eec\u5e76\u4e0d\u4f1a\u4e3b\u52a8\u8c03\u7528 <code>__switch_to()</code>\uff0c\u800c\u662f\u8c03\u7528 <code>schedule()</code> \uff0c\u8ba9\u5b83\u6765\u63a5\u7ba1 <code>__switch_to()</code> \u51fd\u6570\u3002\u540c\u5b66\u4eec\u5728\u8fd9\u91cc\u53ea\u9700\u8981\u77e5\u9053\uff1a\u5728\u5b8c\u6574\u5b8c\u6210\u5b9e\u9a8c\u540e\uff0c\u8fdb\u7a0b\u662f\u5426\u5207\u6362\u5c06\u7531\u8c03\u5ea6\u5668\u63a7\u5236\u3002</p> <p>\u56e0\u6b64\uff0c\u4e8b\u5b9e\u4e0a\uff0c\u8fdb\u7a0b\u5207\u6362\u7684\u53ef\u80fd\u6027\u6765\u81ea\u4e24\u4e2a\u65b9\u9762\uff1a</p> <ol> <li>\uff08\u65f6\u949f\uff09\u4e2d\u65ad\u4f55\u65f6\u89e6\u53d1\u662f\u672a\u77e5\u7684\uff0c\u5b83\u53ef\u80fd\u5728\u4ee3\u7801\u8fd0\u884c\u7684\u4efb\u610f\u65f6\u523b\u53d1\u751f\uff1b</li> <li><code>schedule()</code> \u662f\u5426\u4f1a\u89e6\u53d1 <code>__switch_to()</code> \u662f\u672a\u77e5\u7684\uff0c\u8c03\u5ea6\u5668\u6709\u53ef\u80fd\u5728\u8ba1\u7b97\u540e\u51b3\u5b9a\u4e0d\u8c03\u5ea6\u3002</li> </ol> <p>\u65e2\u7136\u8fdb\u7a0b\u5207\u6362\u5728\u4efb\u610f\u65f6\u523b\u90fd\u6709\u53ef\u80fd\u53d1\u751f\uff0c\u6211\u4eec\u5fc5\u987b\u8981\u8003\u8651\u8fdb\u7a0b\u5207\u6362\u5f15\u5165\u7684\u65b0\u95ee\u9898\u2014\u2014\u5e76\u53d1 (Concurrency)\u3002</p> <p>\u5728\u5355\u6838\u5904\u7406\u5668\u4e0a\uff0c\u867d\u7136\u4e24\u4e2a\u8fdb\u7a0b\u4e0d\u80fd\u5728\u540c\u4e00\u65f6\u523b\u771f\u6b63\u88ab\u6267\u884c\uff0c\u4f46\u7531\u4e8e\u8c03\u5ea6\u5668\uff08\u5c24\u5176\u662f\u62a2\u5360\u5f0f\u8c03\u5ea6\uff09\u7684\u5b58\u5728\uff0c\u4e00\u4e2a\u8fdb\u7a0b\u7684\u6267\u884c\u53ef\u80fd\u5728\u4efb\u610f\u65f6\u523b\u88ab\u4e2d\u65ad\uff0c\u5207\u6362\u5230\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u3002\u8fd9\u79cd\u6267\u884c\u6d41\u4ea4\u9519\u8fdb\u884c\uff0c\u4eff\u4f5b\u5b83\u4eec\u5728\u540c\u65f6\u8fd0\u884c\uff0c\u88ab\u79f0\u4e3a\u4f2a\u5e76\u53d1 (pseudo-concurrency) \u3002</p> <p>\u8fd9\u79cd\u5e76\u53d1\u8bbf\u95ee\u5171\u4eab\u6570\u636e\u65f6\u53ef\u80fd\u5bfc\u81f4\u95ee\u9898\u3002\u5982\u679c\u4e00\u4e2a\u8fdb\u7a0b\u5728\u8bbf\u95ee\u67d0\u4e2a\u5171\u4eab\u8d44\u6e90\uff08\u5982\u5168\u5c40\u53d8\u91cf\u3001\u5171\u4eab\u5185\u5b58\uff09\u7684\u8fc7\u7a0b\u4e2d\u88ab\u975e\u81ea\u613f\u5730\u62a2\u5360\uff0c\u800c\u65b0\u8c03\u5ea6\u7684\u8fdb\u7a0b\u4e5f\u53bb\u8bbf\u95ee\u540c\u4e00\u4e2a\u8d44\u6e90\uff0c\u5c31\u53ef\u80fd\u5bfc\u81f4\u6570\u636e\u635f\u574f\u6216\u4e0d\u4e00\u81f4\uff0c\u8fd9\u79cd\u60c5\u51b5\u88ab\u79f0\u4e3a\u7ade\u4e89\u6761\u4ef6 (Race Condition) \u3002</p> <p>\u6211\u4eec\u628a\u8bbf\u95ee\u5171\u4eab\u8d44\u6e90\u7684\u4ee3\u7801\u533a\u57df\u79f0\u4e3a\u4e34\u754c\u533a (Critical Region)\u3002\u4e3a\u4e86\u4fdd\u8bc1\u7cfb\u7edf\u7684\u7a33\u5b9a\uff0c\u6211\u4eec\u5fc5\u987b\u8bc6\u522b\u51fa\u8fd9\u4e9b\u4e34\u754c\u533a\uff0c\u5e76\u4f7f\u7528\u4fdd\u62a4\u673a\u5236\u6765\u9632\u6b62\u5e76\u53d1\u8bbf\u95ee\u3002\u90a3\u4e48\uff0c\u6211\u4eec\u5177\u4f53\u5e94\u8be5\u5982\u4f55\u4fdd\u62a4\u4e34\u754c\u533a\u5462\uff1f</p> <p>\u89e3\u51b3\u65b9\u6848</p> <p>\u6211\u4eec\u5728\u4e0a\u9762\u5df2\u7ecf\u5206\u6790\u4e86\u8fdb\u7a0b\u5207\u6362\u7684\u53ef\u80fd\u6027\uff0c\u5728\u5355\u6838\u64cd\u4f5c\u7cfb\u7edf\u4e2d\uff0c\u5185\u6838\u5e76\u53d1\u7684\u4e3b\u8981\u6765\u6e90\u662f\u4e2d\u65ad\uff08\u53ea\u6709\u5b83\u53ef\u80fd\u5bfc\u81f4\u62a2\u5360\u5f0f\u8c03\u5ea6\uff09\u3002\u56e0\u6b64\uff0c\u89e3\u51b3\u4e34\u754c\u533a\u95ee\u9898\u6700\u76f4\u63a5\u7684\u65b9\u6cd5\u5c31\u662f\u5173\u95ed\u4e2d\u65ad\u3002</p> <p>\u5728\u5355\u6838\u73af\u5883\u4e2d\u5173\u95ed\u4e2d\u65ad\uff0c\u610f\u5473\u7740\u5f53\u524d\u6267\u884c\u7684\u7ebf\u7a0b\u4e0d\u80fd\u88ab\uff08\u65f6\u949f\uff09\u4e2d\u65ad\u62a2\u5360\u3002\u56e0\u6b64\uff0c\u5982\u679c\u6211\u4eec\u80fd\u505a\u5230\uff1a</p> <ul> <li>\u5728\u8fdb\u5165\u4e34\u754c\u533a\u4e4b\u524d\u5173\u95ed\u4e2d\u65ad</li> <li>\u5728\u79bb\u5f00\u4e34\u754c\u533a\u65f6\u518d\u5f00\u542f\u4e2d\u65ad</li> </ul> <p>\u4fbf\u80fd\u591f\u907f\u514d\u5f53\u524d\u6267\u884c\u4e34\u754c\u533a\u4ee3\u7801\u7684\u7ebf\u7a0b\u88ab\u6253\u65ad\uff0c\u4ece\u800c\u4fdd\u8bc1\u4efb\u610f\u65f6\u523b\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\u5728\u6267\u884c\u4e34\u754c\u533a\u5185\u7684\u4ee3\u7801\u3002</p> \u66f4\u4e25\u683c\u7684\u7406\u7531 <p>\u5728\u7406\u8bba\u8bfe\u4e0a\uff0c\u540c\u5b66\u4eec\u5c06\u4f1a\u5b66\u4e60\u4e34\u754c\u533a\u95ee\u9898\u7684\u4e09\u4e2a\u6761\u4ef6\uff08\u4e92\u65a5\u8bbf\u95ee\u3001\u6709\u9650\u7b49\u5f85\u3001\u7a7a\u95f2\u8ba9\u8fdb\uff09\uff0c\u5927\u5bb6\u53ef\u4ee5\u601d\u8003\u5728\u5355\u6838\u73af\u5883\u4e0b\u5173\u95ed\u4e2d\u65ad\u662f\u5426\u6ee1\u8db3\u89e3\u51b3\u8fd9\u4e09\u4e2a\u6761\u4ef6\u3002\u7531\u4e8e\u7406\u8bba\u8bfe\u7684\u8fdb\u5ea6\u6682\u65f6\u6ede\u540e\u4e8e\u5b9e\u9a8c\u5185\u5bb9\uff0c\u8fd9\u91cc\u6682\u65f6\u4e0d\u5c55\u5f00\u8ba8\u8bba\u3002</p> \u591a\u6838\u5904\u7406\u5668 (SMP) \u5e26\u6765\u7684\u65b0\u6311\u6218 <p>\u5728\u524d\u9762\u7684\u8ba8\u8bba\u4e2d\uff0c\u6211\u4eec\u660e\u786e\u4e86\u5728\u5355\u6838\u5904\u7406\u5668\u4e0a\uff0c\u5173\u95ed\u4e2d\u65ad\u662f\u89e3\u51b3\u5185\u6838\u5e76\u53d1\uff08\u62a2\u5360\uff09\u95ee\u9898\u7684\u6709\u6548\u624b\u6bb5\u3002</p> <p>\u7136\u800c\uff0c\u5728\u591a\u6838\u5904\u7406\u5668\uff08Symmetrical Multiprocessing, SMP\uff09\u4e0a\uff0c\u6211\u4eec\u5c31\u6ca1\u6709\u90a3\u4e48\u5e78\u8fd0\u4e86\u3002</p> <p>\u5728 SMP \u7cfb\u7edf\u4e0a\uff0c\u4e24\u4e2a\u6216\u591a\u4e2a\u5904\u7406\u5668\u53ef\u4ee5\u5728\u5b8c\u5168\u76f8\u540c\u7684\u65f6\u95f4\u6267\u884c\u5185\u6838\u4ee3\u7801\uff0c\u8fd9\u88ab\u79f0\u4e3a\u201c\u771f\u6b63\u5e76\u53d1\u201d (true concurrency)\uff0c\u800c\u4e0d\u518d\u662f\u5355\u6838\u4e0a\u7684\u201c\u4f2a\u5e76\u53d1\u201d\u3002</p> <p>\u8bf7\u601d\u8003\u8fd9\u79cd\u60c5\u51b5\uff1a</p> <ol> <li>CPU 0 \u8fdb\u5165\u4e86\u4e00\u4e2a\u4e34\u754c\u533a\u3002</li> <li>CPU 0 \u4e3a\u4e86\u9632\u6b62\u88ab\u62a2\u5360\uff0c\u6267\u884c\u4e86\u201c\u5173\u95ed\u4e2d\u65ad\u201d\u6307\u4ee4\u3002</li> <li>\u4e0e\u6b64\u540c\u65f6\uff0cCPU 1 \u4e5f\u5728\u6267\u884c\u5185\u6838\u4ee3\u7801\uff0c\u5e76\u4e14\u5b83\u51b3\u5b9a\u8fdb\u5165\u540c\u4e00\u4e2a\u4e34\u754c\u533a\u3002</li> </ol> <p>\u6b64\u65f6\uff0cCPU 0 \u5173\u95ed\u4e2d\u65ad\u53ea\u5f71\u54cd\u4e86 CPU 0 \u81ea\u5df1\uff0c\u5b83\u65e0\u6cd5\u963b\u6b62 CPU 1 \u7684\u8fd0\u884c\u3002CPU 0 \u548c CPU 1 \u4f1a\u540c\u65f6\u8bbf\u95ee\u548c\u4fee\u6539\u4e34\u754c\u533a\u4e2d\u7684\u5185\u5bb9\uff0c\u8fd9\u540c\u6837\u4f1a\u5bfc\u81f4\u7ade\u4e89\u6761\u4ef6\u3002</p> <p>\u56e0\u6b64\uff0c\u5728\u591a\u6838\u73af\u5883\u4e2d\uff0c\u5173\u95ed\u4e2d\u65ad\u4e0d\u662f\u4e00\u4e2a\u6709\u6548\u7684\u540c\u6b65\u673a\u5236\u3002\u6211\u4eec\u5fc5\u987b\u5f15\u5165\u66f4\u5f3a\u5927\u7684\u9501\uff0c\u4f8b\u5982\u81ea\u65cb\u9501 (Spin Locks)\uff0c\u6765\u786e\u4fdd\u5728\u4efb\u4f55\u65f6\u523b\u53ea\u6709\u4e00\u4e2a CPU \u6838\u5fc3\u80fd\u8fdb\u5165\u7279\u5b9a\u7684\u4e34\u754c\u533a\u3002</p>"},{"location":"lab2/#\u4f8b\u5b50-1\u5185\u6838\u6570\u636e\u7ed3\u6784","title":"\u4f8b\u5b50 1\uff1a\u5185\u6838\u6570\u636e\u7ed3\u6784","text":"<p>\u8ba9\u6211\u4eec\u8003\u8651\u4e00\u4e2a\u5177\u4f53\u7684\u4f8b\u5b50\u3002\u5728\u6211\u4eec\u7684\u5185\u6838\u4e2d\uff0c\u6240\u6709\u8fdb\u7a0b\u7684\u4efb\u52a1\u63a7\u5236\u5757\uff08PCB\uff09\u90fd\u53ef\u80fd\u901a\u8fc7\u4e00\u4e2a\u5168\u5c40\u7684\u94fe\u8868 <code>task_list</code> \u6765\u7ba1\u7406\u3002\u5f53\u4e00\u4e2a\u8fdb\u7a0b\u7ed3\u675f\uff08\u4f8b\u5982\u8c03\u7528 <code>do_exit</code>\uff09\u65f6\uff0c\u6211\u4eec\u9700\u8981\u5c06\u5176\u4ece <code>task_list</code> \u4e2d\u79fb\u9664\u3002\u8fd9\u4e2a\u79fb\u9664\u64cd\u4f5c\uff08<code>list_del</code>\uff09\u901a\u5e38\u6d89\u53ca\u591a\u4e2a\u6307\u4ee4\uff08\u4e0b\u9762\u7684\u4ee3\u7801\u4ec5\u4f5c\u6f14\u793a\uff0c\u5b9e\u9a8c\u6846\u67b6\u4e2d\u7684\u771f\u5b9e\u5b9e\u73b0\u53ef\u80fd\u4e0d\u540c\uff09\uff1a</p> <pre><code>prev_task-&gt;next = current_task-&gt;next;\nnext_task-&gt;prev = current_task-&gt;prev;\n</code></pre> <p>\u8bf7\u4f60\u601d\u8003\u8fd9\u79cd\u60c5\u51b5\uff1a</p> <ul> <li>\u5f53\u5185\u6838\u6b63\u5728\u6267\u884c\u7b2c 1 \u6b65\u65f6\uff0c\u7a81\u7136\u53d1\u751f\u4e86\u4e00\u4e2a\u65f6\u949f\u4e2d\u65ad\u3002</li> <li>\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f <code>trap_handler</code> \u8c03\u7528\u4e86 <code>schedule</code>\uff0c\u5207\u6362\u5230\u4e86\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u3002</li> <li>\u5982\u679c\u8fd9\u4e2a\u65b0\u8fdb\u7a0b\u6070\u597d\u4e5f\u8981\u904d\u5386 <code>task_list</code>\uff0c\u5b83\u4f1a\u8bfb\u5230\u4e00\u4e2a\u5904\u4e8e\u201c\u4e2d\u95f4\u72b6\u6001\u201d\u3001\u5df2\u7ecf\u635f\u574f\u7684\u94fe\u8868\uff08<code>prev_task</code> \u7684 <code>next</code> \u6307\u9488\u662f\u5bf9\u7684\uff0c\u4f46 <code>next_task</code> \u7684 <code>prev</code> \u6307\u9488\u8fd8\u662f\u9519\u7684\uff09\uff0c\u8fd9\u53ef\u80fd\u5e26\u6765\u975e\u9884\u671f\u7684\u884c\u4e3a\uff0c\u751a\u81f3\u5bfc\u81f4\u7cfb\u7edf\u5d29\u6e83\u3002</li> </ul> <p>\u8fd9\u5c31\u662f\u4e00\u4e2a\u5178\u578b\u7684\u7ade\u4e89\u6761\u4ef6\uff1a<code>task_list</code> \u662f\u5171\u4eab\u6570\u636e\uff0c\u800c\u4fee\u6539 <code>task_list</code> \u7684\u4ee3\u7801\uff08\u5982 <code>list_del</code>\uff09\u5c31\u662f\u4e00\u4e2a\u4e34\u754c\u533a\u3002\u4e3a\u4e86\u4fdd\u62a4\u5b83\uff0c\u6211\u4eec\u5fc5\u987b\u5728\u4fee\u6539\u94fe\u8868\u4e4b\u524d\u5173\u95ed\u4e2d\u65ad\uff0c\u5e76\u5728\u4fee\u6539\u5b8c\u6210\u540e\u91cd\u65b0\u5f00\u542f\u4e2d\u65ad\u3002</p> <p>\u5b9e\u73b0\u6b63\u786e\u7684\u4e34\u754c\u533a\u4fdd\u62a4</p> <p>\u6211\u4eec\u5728\u5b9e\u9a8c\u6846\u67b6\u4e2d\u5df2\u7ecf\u4e3a\u5927\u5bb6\u8003\u8651\u6240\u6709\u53ef\u80fd\u7684\u4e34\u754c\u533a\u5e76\u8fdb\u884c\u4e86\u4fdd\u62a4\u3002\u4f60\u53ef\u4ee5\u9605\u8bfb <code>csr.h</code> \u4e2d\u7684 <code>interrupt_save()</code> \u548c <code>interrupt_restore()</code> \u51fd\u6570\uff0c\u7406\u89e3\u5b83\u4eec\u662f\u5982\u4f55\u64cd\u4f5c <code>sstatus</code> \u5bc4\u5b58\u5668\u6765\u5f00\u542f\u548c\u5173\u95ed\u4e2d\u65ad\u7684\u3002</p> csr.h<pre><code>void interrupt_save(void);\nvoid interrupt_restore(void);\n</code></pre> <p>\u503c\u5f97\u6ce8\u610f\u7684\u6709\u4e24\u70b9\uff1a</p> <ul> <li>\u6211\u4eec\u5728\u8fdb\u5165\u4e34\u754c\u533a\u524d\u4fdd\u5b58\u4e86\u4e2d\u65ad\u72b6\u6001\uff0c\u5e76\u5728\u79bb\u5f00\u4e34\u754c\u533a\u65f6\u6062\u590d\u539f\u6709\u72b6\u6001\uff0c\u800c\u4e0d\u662f\u7b80\u5355\u5730\u5f00\u542f\u4e2d\u65ad\u3002\u8fd9\u662f\u4e3a\u4e86\u9632\u6b62\u5d4c\u5957\u4e34\u754c\u533a\u7684\u95ee\u9898\u3002</li> <li>\u4e34\u754c\u533a\u4fdd\u62a4\u5e94\u8be5\u603b\u662f\u4ea4\u7ed9\u8c03\u7528\u8005\u6765\u5b8c\u6210\uff0c\u800c\u4e0d\u662f\u7531\u88ab\u8c03\u7528\u7684\u51fd\u6570\uff08\u5982 <code>list_del</code>\uff09\u6765\u5b8c\u6210\u3002\u8fd9\u6837\u53ef\u4ee5\u8ba9\u8c03\u7528\u8005\u6839\u636e\u5177\u4f53\u60c5\u51b5\u51b3\u5b9a\u662f\u5426\u9700\u8981\u4fdd\u62a4\u3002</li> </ul>"},{"location":"lab2/#\u4f8b\u5b50-2\u8fdb\u7a0b\u5207\u6362\u8fc7\u7a0b","title":"\u4f8b\u5b50 2\uff1a\u8fdb\u7a0b\u5207\u6362\u8fc7\u7a0b","text":"<p>\u4e00\u4e2a\u66f4\u5fae\u5999\u7684\u4e34\u754c\u533a\u662f\u6211\u4eec\u7528\u4e8e\u8fdb\u7a0b\u5207\u6362\u7684 <code>__switch_to()</code> \u51fd\u6570\u672c\u8eab\u3002\u4e0a\u6587\u6211\u4eec\u5c06 <code>__switch_to()</code> \u653e\u7f6e\u5728 <code>_traps()</code> \u7684\u672b\u5c3e\u4ee5\u5b9e\u73b0\u62a2\u5360\uff0c\u90a3\u4e48\u5b83\u8fd8\u80fd\u88ab Trap \u5417\uff1f\u8bf7\u4f60\u601d\u8003\u8fd9\u6837\u7684\u573a\u666f\uff1a</p> <ul> <li>Task 1 \u4e3b\u52a8\u8c03\u7528 <code>__switch_to()</code> \u5207\u6362\u5230\u5176\u4ed6\u4efb\u52a1\uff0c\u6211\u4eec\u628a\u8fd9\u6b21\u8c03\u7528\u79f0\u4e3a A</li> <li>\u5728\u8fd9\u4e2a <code>__switch_to()</code> \u8fc7\u7a0b\u4e2d\uff0c\u65f6\u949f\u4e2d\u65ad\u89e6\u53d1\uff0c\u8fdb\u5165 <code>_traps()</code> \u5904\u7406</li> <li>Trap \u5904\u7406\u5b8c\u6210\u540e\uff0c\u56e0\u4e3a\u6211\u4eec\u5b89\u6392\u4e86\u65f6\u949f\u4e2d\u65ad\u89e6\u53d1\u8fdb\u7a0b\u5207\u6362\uff0c\u4e8e\u662f\u53c8\u5f00\u59cb\u8c03\u7528 <code>__switch_to()</code> \u5207\u6362\u5230\u5176\u4ed6\u4efb\u52a1\uff0c\u6211\u4eec\u628a\u8fd9\u6b21\u8c03\u7528\u79f0\u4e3a B</li> </ul> <p>\u8bf7\u95ee A \u548c B \u90fd\u80fd\u987a\u5229\u5b8c\u6210\u5417\uff1f\u8bf7\u4f60\u601d\u8003\u540e\u518d\u5c55\u5f00\u4e0b\u9762\u7684\u7b54\u6848\u3002</p> \u7b54\u6848 <p>B \u4fdd\u5b58\u7684\u4e0a\u4e0b\u6587\u8986\u76d6\u4e86 A \u4fdd\u5b58\u7684\u4e0a\u4e0b\u6587\uff0cA \u518d\u4e5f\u6ca1\u529e\u6cd5\u6062\u590d\u4e86\u3002\u793a\u610f\u56fe\u5982\u4e0b\uff1a</p> <p></p>      \u62a2\u5360\u5bfc\u81f4\u7684\u53cc\u91cd\u8fdb\u7a0b\u5207\u6362      <p></p> <p>\u56e0\u6b64 <code>__switch_to()</code> \u4e0d\u80fd\u88ab\u62a2\u5360\uff0c\u8fdb\u5165 <code>__switch_to()</code> \u65f6\u5fc5\u987b\u7981\u7528\u4e2d\u65ad\u3002</p> <p>\u5982\u679c\u6574\u4e2a <code>_traps()</code> \u4e0d\u4f1a\u89e6\u53d1 <code>__switch_to()</code>\uff0c\u90a3\u4e48 <code>__switch_to()</code> \u5e94\u5f53\u662f\u53ef\u4ee5\u62a2\u5360\u7684\u3002\u4f46\u5982\u679c <code>_traps()</code> \u4e0d\u89e6\u53d1\u8fdb\u7a0b\u5207\u6362\uff0c\u65f6\u949f\u4e2d\u65ad\u8fd8\u6709\u610f\u4e49\u5417\uff1f\u8fd8\u80fd\u5b9e\u73b0\u62a2\u5360\u5417\uff1f\u8fd9\u4e00\u70b9\u7559\u7ed9\u6709\u5174\u8da3\u7684\u540c\u5b66\u601d\u8003\uff0c\u52a9\u6559\u4e5f\u6ca1\u6709\u6df1\u5165\u601d\u8003\u8fc7\uff0c\u6b22\u8fce\u8ba8\u8bba\u3002</p> <p>\u606d\u559c\u4f60</p> <p>\u81f3\u6b64\uff0c\u4f60\u5df2\u7ecf\u5f7b\u5e95\u7406\u89e3\u4e86\u5185\u6838\u62a2\u5360\u7684\u539f\u7406\uff08\u6ce8\u610f\u8fd9\u4e0e\u7528\u6237\u6001\u62a2\u5360\u4e0d\u540c\uff0c\u4ec5\u7528\u6237\u6001\u62a2\u5360\u7684\u5b9e\u73b0\u5f88\u5bb9\u6613\uff09\u3002Linux \u5728 2.6 \u7248\u672c\u624d\u5f15\u5165\u5185\u6838\u62a2\u5360\u3002\u5f53\u5176\u4ed6\u73ed\u7ea7\u8fd8\u5728 Linux 0.11 \u65f6\uff0c\u4f60\u5df2\u7ecf\u9886\u5148\u4e86 12 \u5e74\ud83d\ude09\u3002</p> <p>\u66f4\u591a\u8d44\u6599</p> <ul> <li>linux kernel - What happens to preempted interrupt handler? - Stack Overflow</li> <li>FAQ/Preemption - Linux Kernel Newbies</li> </ul>"},{"location":"lab2/#\u8ba8\u8bba\u6240\u6709\u5207\u6362\u60c5\u51b5","title":"\u8ba8\u8bba\u6240\u6709\u5207\u6362\u60c5\u51b5","text":"<p>\u7136\u800c\u5230\u8fd9\u91cc\uff0c\u6211\u4eec\u5e76\u6ca1\u6709\u89e3\u51b3\u6240\u6709\u7684\u95ee\u9898\u3002\u8bf7\u4f60\u6ce8\u610f\uff1a\u8fdb\u7a0b\u7684\u5207\u6362\u53ef\u80fd\u5e26\u6765\u4e2d\u65ad\u72b6\u6001\u7684\u53d8\u5316\uff0c\u5982\u679c\u65b0\u5207\u6362\u7684\u8fdb\u7a0b\u5e76\u6ca1\u6709\u5f00\u542f\u4e2d\u65ad\uff0c\u90a3\u4e48\u5b83\u5c31\u65e0\u6cd5\u54cd\u5e94\u65f6\u949f\u4e2d\u65ad\uff0c\u8fdb\u800c\u65e0\u6cd5\u88ab\u62a2\u5360\u3002</p> <p>\u4e0b\u9762\uff0c\u6211\u4eec\u8ba8\u8bba\u62a2\u5360\u3001\u4e3b\u52a8\u5207\u6362\u3001\u521d\u59cb\u4e0a\u4e0b\u6587\u5171 \\(2 \\times 3 = 6\\) \u79cd\u5207\u6362\u60c5\u51b5\uff1a</p> \u60c5\u51b5 Task 1 \u72b6\u6001 Task 2 \u72b6\u6001 \u7528 <code>__switch_to()</code> \u5207\u6362\u540e Task 2 \u4f1a\u600e\u4e48\u6837\u8fd0\u884c 1 \u62a2\u5360 \u62a2\u5360 \u901a\u8fc7 <code>_traps()</code> \u8fd4\u56de\uff0c\u5176\u4e2d <code>sret</code> \u91cd\u65b0\u5f00\u542f\u4e2d\u65ad 2 \u62a2\u5360 \u4e3b\u52a8\u5207\u6362 \u901a\u8fc7 <code>schedule</code> \u8fd4\u56de\uff0c\u8fd4\u56de\u8def\u5f84\u4e0a\u624b\u52a8\u5f00\u542f\u4e2d\u65ad 3 \u62a2\u5360 \u521d\u59cb\u4e0a\u4e0b\u6587 \u8fd4\u56de\u8def\u5f84\u4e0a\u6ca1\u6709\u5176\u4ed6\u5730\u65b9\u5f00\u542f\u4e2d\u65ad 4 \u4e3b\u52a8\u5207\u6362 \u62a2\u5360 \u901a\u8fc7 <code>_traps()</code> \u8fd4\u56de\uff0c\u5176\u4e2d <code>sret</code> \u91cd\u65b0\u5f00\u542f\u4e2d\u65ad 5 \u4e3b\u52a8\u5207\u6362 \u4e3b\u52a8\u5207\u6362 \u901a\u8fc7 <code>schedule</code> \u8fd4\u56de\uff0c\u8fd4\u56de\u8def\u5f84\u4e0a\u624b\u52a8\u5f00\u542f\u4e2d\u65ad 6 \u4e3b\u52a8\u5207\u6362 \u521d\u59cb\u4e0a\u4e0b\u6587 \u8fd4\u56de\u8def\u5f84\u4e0a\u6ca1\u6709\u5176\u4ed6\u5730\u65b9\u5f00\u542f\u4e2d\u65ad <ul> <li>\u60c5\u51b5 1 \u548c 4 \u6ca1\u6709\u95ee\u9898\uff0c\u56e0\u4e3a <code>_traps()</code> \u4f1a\u91cd\u65b0\u5f00\u542f\u4e2d\u65ad\u3002</li> <li>\u60c5\u51b5 2 \u548c 5 \u4e5f\u6ca1\u6709\u95ee\u9898\uff0c\u56e0\u4e3a <code>schedule</code> \u662f\u4e34\u754c\u533a\uff0c\u6211\u4eec\u4f1a\u5728\u5b83\u7684\u8c03\u7528\u524d\u540e\u624b\u52a8\u5173\u95ed\u548c\u5f00\u542f\u4e2d\u65ad\u3002</li> <li>\u60c5\u51b5 3 \u548c 6 \u6709\u95ee\u9898\uff0c\u56e0\u4e3a\u521d\u59cb\u4e0a\u4e0b\u6587\u7684\u8e66\u5e8a\u51fd\u6570\u4e2d\u6ca1\u6709\u5f00\u542f\u4e2d\u65ad\u3002\u56e0\u6b64\u6211\u4eec\u9700\u8981\u5728\u8e66\u5e8a\u51fd\u6570\u4e2d\u624b\u52a8\u5f00\u542f\u4e2d\u65ad\u4ee5\u89e3\u51b3\u8fd9\u4e00\u95ee\u9898\u3002</li> </ul> <p>\u81f3\u6b64\uff0c\u6211\u4eec\u5f7b\u5e95\u5b8c\u6210\u4e86\u5185\u6838\u62a2\u5360\u60c5\u51b5\u4e0b\u8fdb\u7a0b\u5207\u6362\u7684\u8bbe\u8ba1\u3002\u8fd9\u4e00\u90e8\u5206\u601d\u7ef4\u91cf\u8f83\u5927\uff0c\u5efa\u8bae\u540c\u5b66\u4eec\u73b0\u5728\u9605\u8bfb\u4ee3\u7801\u7406\u89e3\uff1a</p> <ul> <li><code>kernel/arch/riscv/kernel/proc.c</code> \u4e2d\u7684 <code>switch_to()</code> \u5b9e\u73b0</li> <li><code>kernel/arch/riscv/kernel/entry.S</code> \u4e2d\u7684 <code>__switch_to()</code> \u548c <code>__kthread()</code> \u5b9e\u73b0</li> </ul> <p>\u68c0\u67e5 <code>_traps()</code>\u7684\u5b9e\u73b0</p> <p>\u5728 Lab1 \u4e2d\uff0c<code>_traps()</code> \u5fc5\u987b\u8981\u4fdd\u5b58\u7684\u4ec5\u6709\u9664 caller-saved \u5bc4\u5b58\u5668\u4e4b\u5916\u7684\u6240\u6709\u6574\u6570\u5bc4\u5b58\u5668\u3002</p> <p>\u4f46\u662f\u770b\u5b8c\u4e0a\u9762\u7684\u5185\u5bb9\uff0c\u540c\u5b66\u4eec\u5e94\u8be5\u6ce8\u610f\u5230\uff0c\u73b0\u5728 <code>_traps()</code> \u6267\u884c\u8fc7\u7a0b\u4e5f\u4f1a\u88ab\u6253\u65ad\uff0c\u901a\u8fc7 <code>trap_handler()</code> \u5207\u6362\u5230\u5176\u4ed6\u8fdb\u7a0b\u3002\u8fd9\u65f6\u5019\uff0c\u6211\u4eec\u8981\u601d\u8003\u8fd8\u6709\u54ea\u4e9b\u5bc4\u5b58\u5668\u662f\u5fc5\u987b\u8981\u4fdd\u5b58\u7684\u3002</p> <p>\u8bf7\u540c\u5b66\u4eec\u601d\u8003\u540e\u518d\u6253\u5f00\u4e0b\u9762\u7684\u7b54\u6848\u3002</p> \u7b54\u6848 <ul> <li> <p>CSR \u5bc4\u5b58\u5668\u3002\u56e0\u4e3a <code>__switch_to()</code> \u4f1a\u5f00\u542f\u4e2d\u65ad\uff0c\u4e0b\u4e00\u6b21\u4e2d\u65ad\u89e6\u53d1\u5c31\u4f1a\u5bfc\u81f4\u76f8\u5173 CSR \u5bc4\u5b58\u5668\u88ab\u4fee\u6539\u3002\u6240\u4ee5\u9700\u8981\u4fdd\u5b58\u4e0b\u5217\u5bc4\u5b58\u5668\uff1a</p> <pre><code>sstatus sepc\n</code></pre> <p>\u8fdb\u4e00\u6b65\u5730\uff0c\u8bf7\u540c\u5b66\u4eec\u601d\u8003\u4e3a\u4ec0\u4e48 <code>scause</code>\u3001<code>stval</code> \u4e0d\u9700\u8981\u4fdd\u5b58\u3002</p> </li> <li> <p>\u5176\u4ed6\u5bc4\u5b58\u5668\u4f9d\u7136\u4e0d\u9700\u8981\u4fdd\u5b58\uff0c\u56e0\u4e3a\u4ecd\u6709 RISC-V \u8c03\u7528\u7ea6\u5b9a\u4e3a\u6211\u4eec\u4fdd\u9a7e\u62a4\u822a\u3002</p> </li> </ul> <p>\u8003\u70b9\uff1a\u8fdb\u7a0b\u5207\u6362\u4e0e Trap</p> <ul> <li><code>__switch_to()</code> \u4e3a\u4ec0\u4e48\u53ea\u9700\u8981\u4fdd\u5b58 <code>ra</code>\u3001<code>sp</code>\u3001<code>s0\u2013s11</code>\uff1f</li> <li>\u8e66\u5e8a\u51fd\u6570\uff08<code>__kthread</code>\uff09\u662f\u5982\u4f55\u8fd0\u884c\u7684\uff1f\u8bf7\u8bf4\u660e <code>ra</code>\u3001<code>sp</code>\u3001<code>s0/s1</code> \u7684\u8bbe\u7f6e\u610f\u56fe\u3002</li> <li>\u4e3a\u4ec0\u4e48 <code>__switch_to()</code> \u4e0d\u80fd\u88ab\u62a2\u5360\uff1f</li> <li>\u4e3a\u4ec0\u4e48\u8c03\u5ea6\u70b9\u5fc5\u987b\u653e\u5728 <code>trap_handler()</code> \u5c3e\u90e8\uff1f\u82e5\u5728 Trap \u5904\u7406\u4e2d\u5207\u6362\u4f1a\u5bfc\u81f4\u54ea\u4e9b\u5177\u4f53\u95ee\u9898\uff1f</li> <li>\u4e3a\u4ec0\u4e48 <code>_traps()</code> \u9700\u8981\u989d\u5916\u4fdd\u5b58 <code>sstatus</code>\uff1f<code>sret</code> \u4f9d\u636e <code>SPIE</code> \u5982\u4f55\u51b3\u5b9a\u662f\u5426\u91cd\u65b0\u5f00\u542f\u4e2d\u65ad\uff1f</li> <li>\u516d\u79cd\u5207\u6362\u60c5\u5f62\u4e2d\uff0c\u54ea\u4e9b\u8def\u5f84\u4e0a\u9700\u8981\u8c01\u6765\u201c\u5f00\u542f\u4e2d\u65ad\u201d\uff1f\u8bf7\u9010\u4e00\u7ed9\u51fa\u7406\u7531\u3002</li> </ul>"},{"location":"lab2/#\u8fdb\u7a0b\u6570\u636e\u7ed3\u6784\u548c\u5185\u5b58\u5e03\u5c40","title":"\u8fdb\u7a0b\u6570\u636e\u7ed3\u6784\u548c\u5185\u5b58\u5e03\u5c40","text":"<p>\u7406\u89e3\u5b8c\u8fdb\u7a0b\u5207\u6362\u673a\u5236\uff0c\u6211\u4eec\u7ec8\u4e8e\u53ef\u4ee5\u5f00\u59cb\u8bbe\u8ba1\u8fdb\u7a0b\u7684\u6570\u636e\u7ed3\u6784\u4e86\u3002\u6211\u4eec\u9700\u8981\u5b58\u50a8\u7684\u4fe1\u606f\u5305\u62ec\uff1a</p> <ul> <li><code>uint64_t pid</code> \u8fdb\u7a0b ID</li> <li><code>struct thread_struct thread</code> \u8fdb\u7a0b\u7684\u4e0a\u4e0b\u6587</li> <li> <p><code>void *stack</code> \u8fdb\u7a0b\u7684\u6808</p> <p>\u5982\u679c\u4e0d\u7ed9\u6bcf\u4e2a\u8fdb\u7a0b\u72ec\u7acb\u7684\u6808\uff0c\u5219\u4f1a\u4ea7\u751f\u4e0b\u56fe\u6240\u793a\u7684\u5c40\u9762\uff1a</p> <p></p>      \u591a\u4e2a\u8fdb\u7a0b\u590d\u7528\u540c\u4e00\u6808\u4f1a\u5bfc\u81f4\u51b2\u7a81      <p></p> <p>\u7ec6\u5fc3\u7684\u540c\u5b66\u4f1a\u6ce8\u610f\u5230\uff0c\u8fd9\u6837\u7684\u8bbe\u8ba1\u4e5f\u8ba9\u4e0d\u540c\u8fdb\u7a0b\u7684 Trap \u4e0a\u4e0b\u6587\u5206\u79bb\u4e86\uff0c\u5b58\u50a8\u5728\u5404\u81ea\u7684\u6808\u4e0a\u3002</p> </li> <li> <p><code>struct sched_entity se</code> Part 4 \u5b9e\u73b0\u7684\u8c03\u5ea6\u5668\u4f7f\u7528</p> </li> <li><code>struct list_head list</code> \u6240\u6709\u8fdb\u7a0b\u6570\u636e\u7ed3\u6784\u90fd\u7ec4\u7ec7\u6210\u4e00\u4e2a\u53cc\u5411\u5faa\u73af\u94fe\u8868\uff0c\u65b9\u4fbf\u8c03\u5ea6\u5668\u904d\u5386</li> </ul> <p>\u4e8e\u662f\u6211\u4eec\u8bbe\u8ba1\u51fa\u4e86 <code>struct task_struct</code> \u7ed3\u6784\u4f53\u6765\u4fdd\u5b58\u8fd9\u4e9b\u4fe1\u606f\uff1a</p> kernel/arch/riscv/include/proc.h<pre><code>struct task_struct {\n    uint64_t pid;\n    uint64_t state;\n\n    struct sched_entity se;\n    struct thread_struct thread;\n    struct list_head list;\n};\n</code></pre> <p>\u5185\u5b58\u5e03\u5c40\u5982\u4e0b\u6240\u793a\uff1a</p>      \u8fdb\u7a0b\u6570\u636e\u7ed3\u6784\u793a\u610f\u56fe      <p>\u6b64\u5916\uff0c\u6211\u4eec\u4ee4 <code>tp</code>\uff08RISC-V \u8c03\u7528\u7ea6\u5b9a\u79f0\u4e3a Thread Pointer\uff09\u5bc4\u5b58\u5668\u59cb\u7ec8\u6307\u5411\u5f53\u524d CPU \u4e0a\u8fd0\u884c\u7684\u8fdb\u7a0b\u7684 <code>task_struct</code> \u7ed3\u6784\u4f53\uff0c\u8fd9\u6837\u5185\u6838\u5c31\u80fd\u8f7b\u677e\u5730\u901a\u8fc7 <code>tp</code> \u8bbf\u95ee\u5f53\u524d\u8fdb\u7a0b\u7684\u4fe1\u606f\u3002\u6211\u4eec\u8fd0\u7528 Lab1 \u4e2d\u5185\u8054\u6c47\u7f16\u7684\u77e5\u8bc6\uff0c\u5c06\u8be5\u5bc4\u5b58\u5668\u7ed1\u5b9a\u5230\u53d8\u91cf <code>current</code> \u65b9\u4fbf\u5728 C \u4ee3\u7801\u4e2d\u4f7f\u7528\uff1a</p> kernel/arch/riscv/include/proc.h<pre><code>register struct task_struct *current asm(\"tp\");\n</code></pre>"},{"location":"lab2/#task-2\u8bbe\u7f6e\u521d\u59cb\u8fdb\u7a0b","title":"Task 2\uff1a\u8bbe\u7f6e\u521d\u59cb\u8fdb\u7a0b","text":"<p>\u8bf7\u8865\u5168 <code>kernel/arch/riscv/kernel/proc.c</code> \u6587\u4ef6\u4e2d\u7684 <code>task_init()</code> \u51fd\u6570\uff0c\u5b9e\u73b0\u521d\u59cb\u5316\u7b2c\u4e00\u4e2a\u5185\u6838\u8fdb\u7a0b\uff08init \u8fdb\u7a0b\uff09\u7684\u529f\u80fd\u3002\u5177\u4f53\u8981\u6c42\u5982\u4e0b\uff1a</p> <ul> <li>\u4f7f\u7528 <code>kmem_cache_create()</code> \u521b\u5efa <code>task_struct</code> \u5bf9\u8c61\u7f13\u5b58\u6c60\uff0c\u5e76\u5206\u914d\u4e00\u4e2a\u65b0\u7684 <code>task_struct</code> \u7ed3\u6784\u4f53\u4f5c\u4e3a\u521d\u59cb\u8fdb\u7a0b\u3002</li> <li>\u521d\u59cb\u5316\u8be5\u8fdb\u7a0b\u7684\u5404\u9879\u5b57\u6bb5\uff0c\u5305\u62ec <code>pid</code>\u3001<code>stack</code>\u3001<code>state</code>\u3001<code>se</code>\uff08\u8c03\u5ea6\u5b9e\u4f53\uff0c\u89c1 Part4\uff09\u7b49\u3002</li> <li>\u5c06\u8be5\u8fdb\u7a0b\u8bbe\u7f6e\u4e3a\u5f53\u524d\u8fd0\u884c\u8fdb\u7a0b\uff0c\u5e76\u5c06\u5176\u52a0\u5165\u8fdb\u7a0b\u94fe\u8868\uff08<code>task_list</code>\uff09\u3002</li> </ul> <p>\u5b8c\u6210\u540e\uff0c<code>start_kernel</code> \u5c06\u4f5c\u4e3a\u7b2c\u4e00\u4e2a Task\uff0c\u8fdb\u800c\u80fd\u591f\u901a\u8fc7\u5b83\u5207\u6362\u5230\u5176\u4ed6\u8fdb\u7a0b\uff0c\u4e3a\u540e\u7eed\u8fdb\u7a0b\u7ba1\u7406\u548c\u8c03\u5ea6\u6253\u4e0b\u57fa\u7840\u3002</p> <p>\u5b8c\u6210\u6761\u4ef6</p> <ul> <li>\u901a\u8fc7\u8bc4\u6d4b\u6846\u67b6\u7684 Lab2 Task2 \u6d4b\u8bd5\u3002\u672c Task \u6d89\u53ca\u8c03\u5ea6\u76f8\u5173\u5b57\u6bb5\uff0c\u540c\u5b66\u4eec\u53ef\u80fd\u9700\u8981\u9605\u8bfb Part4 \u540e\u518d\u56de\u6765\u505a\u624d\u80fd\u901a\u8fc7\u6d4b\u8bd5\u3002</li> </ul> <p>\u672c\u6d4b\u8bd5\u4f1a\u5728\u8fdb\u5165 <code>start_kernel()</code> \u65f6\u68c0\u67e5 <code>tp</code> \u53ca\u5176\u6307\u5411\u7684 <code>task_struct</code> \u7ed3\u6784\u4f53\u662f\u5426\u6b63\u786e\u521d\u59cb\u5316\u3002</p>"},{"location":"lab2/#part-3\u8fdb\u7a0b\u751f\u547d\u5468\u671f","title":"Part 3\uff1a\u8fdb\u7a0b\u751f\u547d\u5468\u671f","text":"<p>\u672c\u8282\u6211\u4eec\u5b9e\u73b0 kthread \u7684\u521b\u5efa\u3001\u8fd0\u884c\u548c\u9000\u51fa\uff0c\u5b8c\u6210\u8fdb\u7a0b\u7684\u751f\u547d\u5468\u671f\u7ba1\u7406\u3002</p>"},{"location":"lab2/#\u8fdb\u7a0b\u590d\u5236\u4e0e\u52a0\u8f7d","title":"\u8fdb\u7a0b\u590d\u5236\u4e0e\u52a0\u8f7d","text":"<p>Windows \u4f7f\u7528 <code>CreateProcess()</code> \u521b\u5efa\u8fdb\u7a0b\uff0c\u8fd9\u4e2a\u63a5\u53e3\u5e9e\u5927\u4e14\u50f5\u5316\uff0c\u8fd8\u6709\u597d\u51e0\u4e2a\u884d\u751f\u7248\u672c\uff1a</p> processthreadsapi.h<pre><code>BOOL CreateProcessA(\n  [in, optional]      LPCSTR                lpApplicationName,\n  [in, out, optional] LPSTR                 lpCommandLine,\n  [in, optional]      LPSECURITY_ATTRIBUTES lpProcessAttributes,\n  [in, optional]      LPSECURITY_ATTRIBUTES lpThreadAttributes,\n  [in]                BOOL                  bInheritHandles,\n  [in]                DWORD                 dwCreationFlags,\n  [in, optional]      LPVOID                lpEnvironment,\n  [in, optional]      LPCSTR                lpCurrentDirectory,\n  [in]                LPSTARTUPINFOA        lpStartupInfo,\n  [out]               LPPROCESS_INFORMATION lpProcessInformation\n);\n</code></pre> <p>\u800c Unix \u8fdb\u7a0b\u6a21\u578b\u5c06\u5176\u5206\u4e3a\u4e24\u6b65\uff1a</p> <ol> <li><code>fork()</code>\uff1a\u590d\u5236\u5f53\u524d\u8fdb\u7a0b\uff0c\u521b\u5efa\u4e00\u4e2a\u65b0\u8fdb\u7a0b</li> <li><code>exec()</code>\uff1a\u5728\u5f53\u524d\u8fdb\u7a0b\u7684\u4e0a\u4e0b\u6587\u4e2d\u52a0\u8f7d\u5e76\u6267\u884c\u4e00\u4e2a\u65b0\u7684\u7a0b\u5e8f</li> </ol> <p>\u5728 <code>fork()</code> \u540e <code>exec()</code> \u524d\uff0c\u53ef\u4ee5\u81ea\u7531\u914d\u7f6e\u65b0\u7684\u8fdb\u7a0b\u3002\u5f53\u5185\u6838\u5f15\u5165\u65b0\u7684\u529f\u80fd\u65f6\uff0c\u4e5f\u65e0\u9700\u4fee\u6539 <code>fork</code>/<code>exec</code> \u7684\u63a5\u53e3\u3002\u8fd9\u6837\u590d\u5236 + \u52a0\u8f7d\u7684\u8bbe\u8ba1\u6bd4\u76f4\u63a5\u521b\u5efa\u66f4\u7075\u6d3b\uff0c\u4f53\u73b0\u4e86\u7ec4\u5408\u4f18\u4e8e\u590d\u6742\u63a5\u53e3\u7684 Unix \u54f2\u5b66\u3002</p> <p><code>fork()</code> \u548c <code>exec()</code> \u662f\u63d0\u4f9b\u7ed9\u7528\u6237\u6001\u7a0b\u5e8f\u7684\u7cfb\u7edf\u8c03\u7528\u63a5\u53e3\uff0c\u5c06\u5728 Lab4 \u8fdb\u884c\u5c01\u88c5\u3002\u672c\u6b21\u5b9e\u9a8c\u5728\u5185\u6838\u6001\u4e2d\u5b9e\u73b0\u76f8\u5e94\u7684\u5e95\u5c42\u529f\u80fd\uff1a</p> <ul> <li><code>copy_process()</code>\uff1a\u62f7\u8d1d\u5f53\u524d Task</li> <li><code>kernel_thread()</code>\uff1a\u4fee\u6539\u524d\u8005\u521b\u5efa\u7684 Task\uff0c\u5728\u5176\u4e2d\u8fd0\u884c\u65b0\u7684\u51fd\u6570</li> </ul>"},{"location":"lab2/#task-3\u5b9e\u73b0\u8fdb\u7a0b\u590d\u5236\u4e0e\u52a0\u8f7d","title":"Task 3\uff1a\u5b9e\u73b0\u8fdb\u7a0b\u590d\u5236\u4e0e\u52a0\u8f7d","text":"<p>\u8bf7\u8865\u5168 <code>kernel/arch/riscv/kernel/proc.c</code> \u6587\u4ef6\u4e2d\u7684 <code>copy_process()</code> \u548c <code>kernel_thread()</code> \u51fd\u6570\uff0c\u5b9e\u73b0\u5185\u6838\u7ebf\u7a0b\u7684\u521b\u5efa\u6d41\u7a0b\uff1a</p> <ul> <li><code>copy_process(struct task_struct *old)</code>\uff1a\u590d\u5236\u5f53\u524d\u8fdb\u7a0b\u7684\u6570\u636e\u7ed3\u6784\uff0c\u5206\u914d\u65b0\u7684\u5185\u6838\u6808\uff0c\u5206\u914d\u552f\u4e00\u7684\u8fdb\u7a0b\u53f7\uff0c\u5e76\u521d\u59cb\u5316\u8c03\u5ea6\u76f8\u5173\u5b57\u6bb5\uff08\u89c1 Part4\uff09\uff0c\u5c06\u65b0\u8fdb\u7a0b\u52a0\u5165\u8fdb\u7a0b\u94fe\u8868\u3002</li> <li> <p><code>kernel_thread(int (*fn)(void *), void *arg)</code>\uff1a</p> <ul> <li>\u56de\u5fc6 Part2 \u975e\u62a2\u5360\u60c5\u51b5\uff0c\u6211\u4eec\u8ba8\u8bba\u4e86\u5982\u4f55\u8bbe\u8ba1\u521d\u59cb\u8fdb\u7a0b\u4e0a\u4e0b\u6587\uff0c\u901a\u8fc7 <code>struct thread_struct</code> \u5411\u8e66\u5e8a\u51fd\u6570\u4f20\u9012\u8981\u8fd0\u884c\u7684\u51fd\u6570\u548c\u53c2\u6570\u3002</li> <li> <p>\u548c Linux \u4e00\u6837\uff0c\u6211\u4eec\u89c4\u5b9a\u5185\u6838\u7ebf\u7a0b\u6267\u884c\u7684\u51fd\u6570\u7684\u63a5\u53e3\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>int fn(void *arg);\n</code></pre> <p>\u57fa\u4e8e\u6b64\u89c4\u5b9a\uff0c\u6846\u67b6\u5df2\u7ecf\u5b9e\u73b0\u4e86\u7528\u4e8e\u5185\u6838\u7ebf\u7a0b\u7684\u8e66\u5e8a\u51fd\u6570 <code>__kthread()</code>\uff0c\u8bf7\u4f60\u7406\u89e3\u5b83\u7684\u5de5\u4f5c\u539f\u7406\u3002</p> </li> <li> <p>\u8bf7\u4f60\u5728 <code>kernel_thread()</code> \u4e2d\u8c03\u7528 <code>copy_process()</code> \u521b\u5efa\u65b0\u8fdb\u7a0b\uff0c\u5e76\u6839\u636e\u5bf9 <code>__kthread()</code> \u7684\u7406\u89e3\u8bbe\u7f6e\u65b0\u8fdb\u7a0b\u7684\u521d\u59cb\u4e0a\u4e0b\u6587\u3002</p> </li> </ul> </li> </ul> <p>\u8865\u5168\u540e\uff0c\u5185\u6838\u5c06\u80fd\u591f\u901a\u8fc7 <code>kernel_thread()</code> \u521b\u5efa\u65b0\u7684\u5185\u6838\u7ebf\u7a0b\uff0c\u5e76\u6b63\u786e\u521d\u59cb\u5316\u5176\u6267\u884c\u73af\u5883\u3002</p> <p>\u5b8c\u6210\u6761\u4ef6</p> <ul> <li>\u901a\u8fc7\u8bc4\u6d4b\u6846\u67b6\u7684 <code>lab2 task3</code> \u6d4b\u8bd5\u3002\u4e0e Task2 \u4e00\u6837\uff0c\u672c Task \u6d89\u53ca\u8c03\u5ea6\u76f8\u5173\u5b57\u6bb5\uff0c\u540c\u5b66\u4eec\u53ef\u80fd\u9700\u8981\u9605\u8bfb Part4 \u540e\u518d\u56de\u6765\u505a\u624d\u80fd\u901a\u8fc7\u6d4b\u8bd5\u3002</li> </ul> <p>\u672c\u6d4b\u8bd5\u4f1a\u68c0\u67e5 <code>start_kernel</code> \u4e2d\u8c03\u7528 <code>kernel_thread(kthreadd, NULL)</code> \u521b\u5efa\u7684\u8fdb\u7a0b\u4e0a\u4e0b\u6587\u662f\u5426\u6b63\u786e\u3002</p>"},{"location":"lab2/#\u8fdb\u7a0b\u9000\u51fa\u4e0e\u9500\u6bc1","title":"\u8fdb\u7a0b\u9000\u51fa\u4e0e\u9500\u6bc1","text":"<p>\u5f53\u4e00\u4e2a\u5185\u6838\u7ebf\u7a0b\u7ed3\u675f\u4efb\u52a1\u3001\u9000\u51fa\u6267\u884c\uff0c\u4e0e\u5176\u76f8\u5173\u7684\u8d44\u6e90\u9700\u8981\u88ab\u9500\u6bc1\uff0c\u8fd9\u5305\u62ec <code>struct task_struct</code> \u7ed3\u6784\u4f53\u53ca\u5176\u901a\u8fc7\u6307\u9488\u5f15\u7528\u7684\u6210\u5458\uff08\u5982\u5185\u6838\u6808\uff09\u7b49\u3002</p> <p>\u8fdb\u7a0b\u6ca1\u6709\u529e\u6cd5\u6790\u6784\u81ea\u5df1\uff0c\u8fd9\u4e00\u903b\u8f91\u5f88\u5bb9\u6613\u7406\u89e3\u3002\u5982\u679c\u8fdb\u7a0b\u6790\u6784\u81ea\u8eab\uff0c\u90a3\u4e48\u6790\u6784\u5de5\u4f5c\u4e5f\u662f\u8fdb\u7a0b\u8fd0\u884c\u7684\u4e00\u90e8\u5206\u3002\u53ea\u8981\u8fdb\u7a0b\u4ecd\u5728\u8fd0\u884c\u72b6\u6001\uff0c\u91ca\u653e\u76f8\u5173\u8d44\u6e90\u5c31\u53ef\u80fd\u5bfc\u81f4\u60ac\u7a7a\u6307\u9488\u7b49\u95ee\u9898\u3002\u56e0\u6b64\u53ef\u4ee5\u5c06\u8fdb\u7a0b\u7684\u6790\u6784\u8bbe\u8ba1\u4e3a\u9000\u51fa\u548c\u9500\u6bc1\u4e24\u4e2a\u9636\u6bb5\uff1a</p> <ul> <li><code>do_exit()</code>\uff1a\u8fdb\u7a0b\u5b8c\u6210\u6240\u6709\u4efb\u52a1\u540e\u8c03\u7528\u8be5\u51fd\u6570\uff0c\u5c06\u81ea\u8eab\u72b6\u6001\u7f6e\u4e3a <code>TASK_DEAD</code>\uff0c\u7136\u540e\u4e3b\u52a8\u53d1\u8d77\u8c03\u5ea6\uff0c\u6b64\u540e\u5b83\u518d\u4e5f\u4e0d\u4f1a\u88ab\u8c03\u5ea6\u8fd0\u884c\uff0c\u53ef\u4ee5\u5b89\u5168\u91ca\u653e</li> <li><code>release_task()</code>\uff1a\u8c03\u5ea6\u79bb\u5f00\u4e0a\u4e00\u6b65\u7684\u8fdb\u7a0b\u540e\uff0c\u968f\u65f6\u53ef\u4ee5\u91ca\u653e\u5176\u8d44\u6e90</li> </ul> <p>\u6b64\u5916\uff0c\u6211\u4eec\u8fd8\u4f1a\u5b9e\u73b0\u4e00\u4e2a\u8f85\u52a9\u51fd\u6570\uff1a</p> <ul> <li> <p><code>kthread()</code>\uff1a\u5185\u6838\u7ebf\u7a0b\u7684 Wrapper\uff0c\u53ea\u662f\u4e3a\u4e86\u5e2e\u52a9\u5728\u6bcf\u4e2a\u5185\u6838\u7ebf\u7a0b\u7ed3\u675f\u540e\u8c03\u7528 <code>do_exit()</code>\uff0c\u8fd9\u6837\u5c31\u4e0d\u7528\u8ba9\u6240\u6709\u5de5\u4f5c\u51fd\u6570\u90fd\u663e\u5f0f\u8c03\u7528 <code>do_exit()</code> \u4e86\u3002</p> <pre><code>noreturn int kthread(void *arg)\n{\n    struct kthread_create_info *info = arg;\n    int (*threadfn)(void *) = info-&gt;threadfn;\n    void *data = info-&gt;data;\n    int ret = threadfn(data);\n    do_exit(ret);\n}\n</code></pre> <p>\u4e00\u4e2a\u4f8b\u5916\u662f <code>kthreadd</code> \u7ebf\u7a0b\uff08\u5728\u521a\u521a\u7684 Task \u4e2d\u89c1\u8fc7\uff09\uff0c\u5b83\u662f\u7b2c\u4e00\u4e2a\u5185\u6838\u7ebf\u7a0b\uff0c\u8d1f\u8d23\u521b\u5efa\u5176\u4ed6\u5185\u6838\u7ebf\u7a0b\u3002\u5b83\u6c38\u8fdc\u4e0d\u4f1a\u9000\u51fa\uff0c\u56e0\u6b64\u4e0d\u9700\u8981 <code>kthread()</code> \u5305\u88c5\u3002</p> </li> </ul> <p>\u7531\u4e8e <code>do_exit()</code> \u4f9d\u8d56\u4e8e\u8c03\u5ea6\u5668\uff0c\u8fd9\u90e8\u5206\u7684\u4efb\u52a1\u7559\u5230 Part 4 \u4e00\u8d77\u5b8c\u6210\u3002</p> <p>\u8003\u70b9\uff1a\u8fdb\u7a0b\u6570\u636e\u7ed3\u6784\u4e0e\u751f\u547d\u5468\u671f</p> <ul> <li>\u4e3a\u4ec0\u4e48\u6bcf\u4e2a\u4efb\u52a1\u5fc5\u987b\u6709\u72ec\u7acb\u5185\u6838\u6808\uff1f</li> <li><code>current</code> \u4e0e <code>tp</code> \u7684\u7ed1\u5b9a\u5e26\u6765\u4ec0\u4e48\u4fbf\u5229\uff1f\u5728 C \u4ee3\u7801\u4e2d\u4f7f\u7528\u5b83\u65f6\u8981\u6ce8\u610f\u4ec0\u4e48\uff1f</li> <li><code>task_init()</code> \u81f3\u5c11\u9700\u8981\u521d\u59cb\u5316\u54ea\u4e9b\u5173\u952e\u5b57\u6bb5\uff0c\u5982\u4f55\u628a\u5b83\u8bbe\u4e3a\u5f53\u524d\u4efb\u52a1\u5e76\u52a0\u5165 <code>task_list</code>\uff1f</li> <li><code>copy_process()</code> \u54ea\u4e9b\u5b57\u6bb5\u5e94\u8be5\u201c\u590d\u5236\u201d\uff0c\u54ea\u4e9b\u5fc5\u987b\u201c\u91cd\u65b0\u521d\u59cb\u5316\u201d\uff1f</li> <li><code>kernel_thread()</code> \u5982\u4f55\u6784\u9020\u65b0\u4efb\u52a1\u7684\u521d\u59cb\u4e0a\u4e0b\u6587\u624d\u80fd\u6b63\u786e\u8df3\u5230 <code>__kthread</code> \u5e76\u4f20\u53c2\uff1f</li> </ul>"},{"location":"lab2/#part-4\u8c03\u5ea6\u5668","title":"Part 4\uff1a\u8c03\u5ea6\u5668","text":"<p>\u5230\u672c\u8282\uff0c\u6211\u4eec\u7ec8\u4e8e\u53ef\u4ee5\u628a\u8fdb\u7a0b\u5207\u6362\u8fd9\u4e2a\u8bcd\u5347\u7ea7\u4e3a\u8c03\u5ea6\u4e86\u3002\u6211\u4eec\u5c06\u7814\u7a76\u8c03\u5ea6\u7b97\u6cd5\uff0c\u7531\u5b83\u9009\u62e9\u8981\u5207\u6362\u7684\u8fdb\u7a0b\u3002</p>"},{"location":"lab2/#\u65f6\u95f4\u7247\u8f6e\u8f6c\u8c03\u5ea6","title":"\u65f6\u95f4\u7247\u8f6e\u8f6c\u8c03\u5ea6","text":"<p>RR \u8c03\u5ea6\u7b97\u6cd5\u5df2\u7ecf\u5728\u7406\u8bba\u8bfe\u4e0a\u8bb2\u8fc7\u4e86\uff0c\u8fd9\u91cc\u628a PPT \u5185\u5bb9\u518d\u8d34\u4e00\u904d\uff1a</p> <ul> <li> <p>\u57fa\u672c\u601d\u8def\uff1a\u901a\u8fc7\u65f6\u95f4\u7247\u8f6e\u8f6c\uff0c\u63d0\u9ad8\u8fdb\u7a0b\u5e76\u53d1\u6027\u548c\u54cd\u5e94\u65f6\u95f4\u7279\u6027\uff0c\u4ece\u800c\u63d0\u9ad8\u8d44\u6e90\u5229\u7528\u7387\u3002</p> </li> <li> <p>RR \u7b97\u6cd5\uff1a</p> <ul> <li>\u5c06\u7cfb\u7edf\u4e2d\u6240\u6709\u7684\u5c31\u7eea\u8fdb\u7a0b\u6309\u7167 FCFS \u539f\u5219\uff0c\u6392\u6210\u4e00\u4e2a\u961f\u5217\u3002</li> <li>\u6bcf\u6b21\u8c03\u5ea6\u65f6\u5c06 CPU \u5206\u6d3e\u7ed9\u961f\u9996\u8fdb\u7a0b\uff0c\u8ba9\u5176\u6267\u884c\u4e00\u4e2a\u65f6\u95f4\u7247 (time slice) \u3002</li> <li>\u5728\u4e00\u4e2a\u65f6\u95f4\u7247\u7ed3\u675f\u65f6\uff0c\u6682\u505c\u5f53\u524d\u8fdb\u7a0b\u7684\u6267\u884c\uff0c\u5c06\u5176\u9001\u5230\u5c31\u7eea\u961f\u5217\u7684\u672b\u5c3e\uff0c\u5e76\u901a\u8fc7\u4e0a\u4e0b\u6587\u5207\u6362\u6267\u884c\u5c31\u7eea\u961f\u5217\u7684\u961f\u9996\u8fdb\u7a0b\u3002</li> <li>\u8fdb\u7a0b\u53ef\u4ee5\u672a\u4f7f\u7528\u5b8c\u4e00\u4e2a\u65f6\u95f4\u7247\uff0c\u5c31\u51fa\u8ba9 CPU\uff08\u5982\u963b\u585e\uff09\u3002</li> </ul> </li> </ul> <p>\u8003\u8651 <code>struct sched_entity</code> \u7684\u8bbe\u8ba1\u3002\u5bf9\u4e8e RR \u8c03\u5ea6\u6765\u8bf4\uff0c\u9700\u8981\u4fdd\u5b58\u7684\u4fe1\u606f\u5c31\u662f\u8fdb\u7a0b\u7684\u65f6\u95f4\u7247\uff08\u5269\u4f59\u591a\u5c11\u65f6\u95f4\uff09\u3002\u6b64\u5916\u4e0b\u6587\u63d0\u53ca\u7684 <code>test_sched.c</code> \u6d4b\u4f8b\u9700\u8981\u4f7f\u7528\u7d2f\u8ba1\u65f6\u95f4\u6765\u5b89\u6392\u8fdb\u7a0b\u7684\u521b\u5efa\u987a\u5e8f\uff0c\u989d\u5916\u65b0\u589e\u4e00\u4e2a\u5b57\u6bb5\uff0c\u4f46\u5b83\u5e76\u975e\u8c03\u5ea6\u7b97\u6cd5\u6240\u5fc5\u9700\u3002</p> kernel/arch/riscv/include/proc.h<pre><code>struct sched_entity {\n    uint64_t runtime; /**&lt; \u65f6\u95f4\u7247 */\n    uint64_t sum_exec_runtime; /**&lt; \u5df2\u6267\u884c\u65f6\u95f4 */\n};\n</code></pre> <p>\u8981\u70b9\uff1aRR \u8c03\u5ea6\u7b97\u6cd5\u7684\u5b9e\u73b0</p> <p>\u4e3a\u4e86\u5728\u6211\u4eec\u7684\u6846\u67b6\u4e2d\u6b63\u786e\u5b9e\u73b0 RR \u8c03\u5ea6\u7b97\u6cd5\uff0c\u8bf7\u6ce8\u610f\u4ee5\u4e0b\u51e0\u4e2a\u8981\u70b9\uff1a</p> <ul> <li>\u8c03\u5ea6\u987a\u5e8f\uff1a<ul> <li>\u8fdb\u7a0b\u7684\u8c03\u5ea6\u9075\u5faa FCFS \u7684\u539f\u5219\uff0c\u56e0\u6b64\u5728\u5c06\u8fdb\u7a0b\u52a0\u5165\u4efb\u52a1\u961f\u5217\u65f6\uff0c\u5e94\u786e\u4fdd\u65b0\u8fdb\u7a0b\u88ab\u6dfb\u52a0\u5230\u961f\u5217\u7684\u672b\u5c3e\u3002</li> <li>\u5f53\u8fdb\u7a0b\u7684\u65f6\u95f4\u7247\u8017\u5c3d\uff0c\u5e94\u5f53\u4ee5\u5408\u9002\u7684\u65b9\u5f0f\u786e\u5b9a\u4e0b\u4e00\u4e2a\u88ab\u8c03\u5ea6\u7684\u8fdb\u7a0b\uff08\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539\u961f\u5217\u6216\u8005\u8bbe\u8ba1\u6070\u5f53\u7684\u904d\u5386\u987a\u5e8f\u5b9e\u73b0\uff09\u3002</li> </ul> </li> <li>\u65f6\u95f4\u7247\u7ba1\u7406\uff1a<ul> <li>\u6bcf\u4e2a\u8fdb\u7a0b\u5728\u88ab\u8c03\u5ea6\u65f6\uff0c\u90fd\u4f1a\u83b7\u5f97\u4e00\u4e2a\u56fa\u5b9a\u7684\u65f6\u95f4\u7247\uff08<code>TIME_SLICE</code>\uff09\u3002</li> <li>\u5728\u6bcf\u6b21 <code>schedule()</code> \u8c03\u7528\u65f6\uff0c\u5e94\u68c0\u67e5\u5f53\u524d\u8fdb\u7a0b\u7684\u5269\u4f59\u65f6\u95f4\u7247\u5e76\u8fdb\u884c\u66f4\u65b0\u3002\uff08\u5728\u8ba1\u7b97\u6d88\u8017\u65f6\u95f4\u7247\u7684\u5927\u5c0f\u65f6\uff0c\u6211\u4eec\u5e76\u6ca1\u6709\u4e25\u683c\u5730\u533a\u5206\u8c03\u5ea6\u5668\u6267\u884c\u7684\u65f6\u95f4\u5f00\u9500\u548c\u8fdb\u7a0b\u6267\u884c\u7684\u65f6\u95f4\uff0c\u56e0\u6b64\u4f60\u53ef\u4ee5\u5ffd\u7565\u975e\u8fdb\u7a0b\u672c\u8eab\uff08<code>process()</code>\u51fd\u6570\uff09\u6267\u884c\u7684\u90e8\u5206\uff0c\u628a\u201c\u5f53\u524d\u65f6\u95f4\u201d\u540c\u65f6\u4f5c\u4e3a\u4e0a\u4e00\u8fdb\u7a0b\u7684\u7ed3\u675f\u65f6\u95f4\u548c\u4e0b\u4e00\u8fdb\u7a0b\u7684\u5f00\u59cb\u65f6\u95f4\uff09</li> </ul> </li> <li>\u8fdb\u7a0b\u8d44\u6e90\u7ba1\u7406\uff1a<ul> <li>\u5728\u8c03\u5ea6\u5668\u4e2d\uff0c\u5e94\u5f53\u786e\u4fdd\u5df2\u7ecf\u9000\u51fa\u7684\u8fdb\u7a0b\uff08<code>TASK_DEAD</code>\uff09\u7684\u8d44\u6e90\u88ab\u6b63\u786e\u91ca\u653e\u3002</li> </ul> </li> <li>\u8c03\u5ea6\u95f4\u9694\uff1a<ul> <li>\u65f6\u949f\u4e2d\u65ad\u7684\u95f4\u9694\u4e0e\u8c03\u5ea6\u7b97\u6cd5\u6709\u5173\uff0c\u6211\u4eec\u4f9d\u8d56\u4e8e\u65f6\u949f\u4e2d\u65ad\u8fdb\u884c\u65f6\u95f4\u7247\u7ba1\u7406\u548c\u8fdb\u7a0b\u62a2\u5360\uff0c\u56e0\u6b64\u4f60\u9700\u8981\u4fee\u6539\u65f6\u949f\u4e2d\u65ad\u9891\u7387\uff0c\u4ece\u539f\u6765\u7684 1s \u6539\u4e3a <code>kernel/arch/riscv/include/sched.h</code> \u4e2d\u5b9a\u4e49\u7684 <code>TIMER_INTERVAL</code></li> </ul> </li> </ul>"},{"location":"lab2/#task-4\u5b9e\u73b0\u65f6\u95f4\u7247\u8f6e\u8f6c\u8c03\u5ea6\u548c\u62a2\u5360","title":"Task 4\uff1a\u5b9e\u73b0\u65f6\u95f4\u7247\u8f6e\u8f6c\u8c03\u5ea6\u548c\u62a2\u5360","text":"<ul> <li>\u8bf7\u8865\u5168 <code>kernel/arch/riscv/kernel/sched.c</code> \u6587\u4ef6\u4e2d\u7684 <code>schedule()</code> \u51fd\u6570\uff0c\u5b9e\u73b0\u65f6\u95f4\u7247\u8f6e\u8f6c\u8c03\u5ea6\u7b97\u6cd5\u3002</li> <li>\u8bf7\u8865\u5168 <code>kernel/arch/riscv/kernel/proc.c</code> \u6587\u4ef6\u4e2d\u7684 <code>do_exit()</code> \u548c <code>release_task()</code> \u51fd\u6570\uff0c\u5b9e\u73b0\u5185\u6838\u7ebf\u7a0b\u7684\u9000\u51fa\u4e0e\u9500\u6bc1\u3002</li> <li>\u5728 <code>trap_handler()</code> \u7684\u672b\u5c3e\u8c03\u7528 <code>schedule()</code>\uff0c\u4ece\u800c\u542f\u7528\u5185\u6838\u62a2\u5360\uff0c\u5f7b\u5e95\u5b8c\u6210\u672c\u6b21\u5b9e\u9a8c\u3002</li> </ul> <p>\u5b8c\u6210\u6761\u4ef6</p> <ul> <li>\u901a\u8fc7\u8bc4\u6d4b\u6846\u67b6\u7684 <code>lab2 task4</code> \u6d4b\u8bd5\u3002</li> </ul> <p>\u8be5\u6d4b\u8bd5\u4f1a\u5728 <code>release_task()</code> \u5904\u6253\u65ad\u70b9\uff0c\u89c2\u6d4b\u6574\u4e2a\u8fdb\u7a0b\u8c03\u5ea6\u8fc7\u7a0b\uff0c\u68c0\u67e5\u8fdb\u7a0b\u7684\u521b\u5efa\u548c\u9000\u51fa\u662f\u5426\u7b26\u5408\u4e0a\u8ff0\u65f6\u95f4\u7247\u8f6e\u8f6c\u8c03\u5ea6\u7b97\u6cd5\u8ba1\u7b97\u7684\u7ed3\u679c\u3002</p> <p>\ud83d\udc7f \u8bc4\u6d4b\u573a\u666f\u53ef\u80fd\u4e0e\u624b\u52a8\u8fd0\u884c\u573a\u666f\u6709\u6240\u4e0d\u540c\uff0c\u56e0\u4e3a GDB \u7684\u5b58\u5728\u53ef\u80fd\u6539\u53d8\u7a0b\u5e8f\u8fd0\u884c\u7684\u65f6\u5e8f\u903b\u8f91\uff0c\u89e6\u53d1\u9690\u85cf\u7684\u4e34\u754c\u533a\u95ee\u9898\uff0c\u5bfc\u81f4\u7a0b\u5e8f\u5d29\u6e83\uff08\u5f53\u7136\u4e5f\u4e0d\u6392\u9664\u5355\u7eaf\u53ea\u662f\u4f60\u7684\u8c03\u5ea6\u7b97\u6cd5\u5b9e\u73b0\u6709\u95ee\u9898\uff09\u3002\u540c\u5b66\u4eec\u9047\u5230\u95ee\u9898\u65f6\u4e5f\u53ef\u4ee5\u67e5\u770b <code>tests/console.log</code> \u65e5\u5fd7\uff0c\u89c2\u5bdf\u8bc4\u6d4b\u65f6\u7684\u7a0b\u5e8f\u8f93\u51fa\u662f\u5426\u7b26\u5408\u4f60\u7684\u9884\u671f\u3002</p> <p>\u52a8\u624b\u505a\uff1a\u8ba1\u7b97\u54cd\u5e94\u6bd4</p> <p>\u9664\u4e86\u57fa\u672c\u7684 RR \u8c03\u5ea6\uff0c\u5b9e\u9a8c\u6846\u67b6\u8fd8\u6a21\u4eff\u4e86 Linux \u7684\u7ebf\u7a0b\u7ba1\u7406\u673a\u5236\uff0c\u5f15\u5165\u4e86 \u5f02\u6b65\u5185\u6838\u7ebf\u7a0b\u521b\u5efa\u3002</p> <p>\u5177\u4f53\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <ul> <li>\u8bbe\u7f6e\u4e00\u4e2a\u961f\u5217\uff0c\u7528\u4e8e\u5b58\u653e\u5f85\u521b\u5efa\u7684\u5185\u6838\u7ebf\u7a0b\u8bf7\u6c42\uff1b</li> <li><code>kthreadd</code> \u7ebf\u7a0b\u4e0d\u65ad\u4ece\u8be5\u961f\u5217\u4e2d\u53d6\u51fa\u8bf7\u6c42\uff0c\u521b\u5efa\u5176\u4ed6\u5185\u6838\u7ebf\u7a0b\uff1b</li> <li>\u6bcf\u6b21\u521b\u5efa\u5b8c\u6210\u540e\uff0c<code>kthreadd</code> \u4f1a\u7acb\u5373\u8ba9\u51fa CPU\uff08\u7528\u5b8c\u65f6\u95f4\u7247\uff09\uff0c\u56e0\u6b64\u5b83\u51e0\u4e4e\u4e0d\u5360\u7528\u8c03\u5ea6\u65f6\u95f4\uff1b</li> <li><code>kthread_create()</code> \u7528\u4e8e\u63d0\u4ea4\u521b\u5efa\u8bf7\u6c42\uff0c\u5b83\u4f1a\u7acb\u5373\u8fd4\u56de\uff0c\u4e0d\u4f1a\u7b49\u5f85\u7ebf\u7a0b\u771f\u6b63\u542f\u52a8\uff08\u8fd9\u70b9\u4e0e Linux \u4e0d\u540c\uff09\u3002</li> </ul> <p></p>      \u5f02\u6b65\u5185\u6838\u7ebf\u7a0b\u521b\u5efa\u793a\u610f\u56fe      <p></p> <p>\u6846\u67b6\u63d0\u4f9b\u7684 <code>test_sched.c</code> \u6a21\u62df\u4e86\u7406\u8bba\u8bfe\u4e2d\u7684\u8c03\u5ea6\u8003\u9898\uff1a</p> \u8fdb\u7a0b \u8bf7\u6c42\u521b\u5efa\u65f6\u95f4 \u8fd0\u884c\u65f6\u95f4 1 0 10 2 1 1 3 4 2 4 5 1 5 8 5 <p>\u8fd9\u91cc\u7684\u201c\u8bf7\u6c42\u521b\u5efa\u65f6\u95f4\u201d\u6307 <code>kthread_create()</code> \u88ab\u8c03\u7528\u7684\u65f6\u523b\uff0c\u5e76\u4e0d\u4ee3\u8868\u7ebf\u7a0b\u7acb\u5373\u8fdb\u5165\u5c31\u7eea\u961f\u5217\u3002</p> <p>\u5f53\u4f60\u5b8c\u6210\u6240\u6709\u4efb\u52a1\u540e\uff0c\u8fd0\u884c\u5185\u6838\uff0c\u89c2\u5bdf\u8be5\u6d4b\u4f8b\u7684\u8f93\u51fa\u7ed3\u679c\uff0c\u8ba1\u7b97 5 \u4e2a\u8fdb\u7a0b\u7684\u5e73\u5747\u5468\u8f6c\u65f6\u95f4\u3001\u5e73\u5747\u7b49\u5f85\u65f6\u95f4\u548c\u54cd\u5e94\u6bd4\u3002</p> <p>\u503c\u5f97\u4e00\u63d0\u7684\u662f\uff0c\u672c\u300c\u52a8\u624b\u505a\u300d\u7684\u8fd0\u884c\u7ed3\u679c\u5728\u4e0d\u540c\u5e73\u53f0\uff08x86\u3001arm\uff09\u3001\u751a\u81f3\u540c\u4e00\u5e73\u53f0\u4e0a\u90fd\u4f1a\u6709\u6240\u4e0d\u540c\u3002\u540c\u5b66\u4eec\u505a\u5b8c\u4e0b\u4e00\u4e2a\u300c\u52a8\u624b\u505a\u300d\u540e\u5e94\u8be5\u80fd\u7406\u89e3\u5176\u539f\u56e0\uff0c\u5f53\u4f60\u7406\u89e3\u4e86\u8fd9\u4e00\u70b9\u624d\u7b97\u662f\u6293\u4f4f\u4e86\u73b0\u5b9e\u4e2d\u7684\u8c03\u5ea6\u7b97\u6cd5\u7684\u7cbe\u9ad3\u3002</p> <p>\u52a8\u624b\u505a\uff1a\u63a2\u7a76\u65f6\u95f4\u7247\u5bf9\u8c03\u5ea6\u7ed3\u679c\u7684\u5f71\u54cd</p> <p>\u540c\u5b66\u4eec\u53ef\u80fd\u4f1a\u53d1\u73b0\uff0c\u5f00\u542f/\u4e0d\u5f00\u542f\u8c03\u8bd5\u65f6\u7684\u8c03\u5ea6\u7ed3\u679c\u4e0d\u540c\u3002\u8fd9\u662f\u56e0\u4e3a GDB \u5728\u5355\u6b65\u6267\u884c\u6216\u9891\u7e41\u68c0\u67e5\u5bc4\u5b58\u5668\u3001\u5185\u5b58\u72b6\u6001\u65f6\uff0c\u4f1a\u663e\u8457\u62d6\u6162\u6a21\u62df\u5668\u8fd0\u884c\uff0c\u5bfc\u81f4\u6240\u6709\u6307\u4ee4\u53d8\u6162\uff0c\u7528\u4f53\u7cfb\u7ed3\u6784\u7684\u672f\u8bed\u8bf4\u5c31\u662f IPC \u53d8\u4f4e\u4e86\u3002\u8bf7\u4f60\u89e3\u91ca\u4e3a\u4ec0\u4e48 IPC \u53d8\u4f4e\u4f1a\u5f71\u54cd\u8c03\u5ea6\u7ed3\u679c\u3002</p> <p>\u6b64\u5916\uff0c\u4e5f\u5f88\u5bb9\u6613\u60f3\u5230 <code>TIME_SLICE</code>\u3001<code>TIMER_INTERVAL</code> \u4e24\u4e2a\u5b8f\u7684\u503c\u5982\u679c\u8bbe\u7f6e\u4e0d\u5f53\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u8c03\u5ea6\u7ed3\u679c\u53d1\u751f\u5404\u79cd\u5404\u6837\u7684\u53d8\u5316\u3002\u8bf7\u4f60\u601d\u8003\u53ef\u80fd\u53d1\u751f\u7684\u5404\u79cd\u60c5\u51b5\uff0c\u7136\u540e\u5c1d\u8bd5\u8c03\u6574\u8fd9\u4e24\u4e2a\u5b8f\u7684\u503c\uff0c\u89c2\u5bdf\u65e5\u5fd7\u9a8c\u8bc1\u4f60\u7684\u731c\u60f3\u3002</p> <p>\u63d0\u793a\uff1a\u8fd9\u4e9b\u95ee\u9898\u672c\u8d28\u4e0a\u662f\u5728\u6bd4\u8f83\uff1a</p> <ul> <li>\u73b0\u5b9e\u4e16\u754c\u7684\u65f6\u95f4\uff08wall-clock time\uff09\uff1a\u5bf9\u5e94 RISC-V \u67b6\u6784\u4e2d\u7684 <code>time</code> \u5bc4\u5b58\u5668\uff0cQEMU \u4f1a\u4fdd\u8bc1\u5176\u59cb\u7ec8\u6309 10MHz \u7684\u901f\u7387\u589e\u957f</li> <li>\u5185\u6838\u7684\u903b\u8f91\u65f6\u95f4\uff1a\u4e0e\u8c03\u5ea6\u7b97\u6cd5\u7684\u8bbe\u8ba1\u6709\u5173\uff0c\u5728 RR \u8c03\u5ea6\u4e2d\u5b83\u4f53\u73b0\u5728\u65f6\u95f4\u7247\u7684\u6d88\u8017\u4e0a</li> </ul> <p>\u8003\u70b9\uff1a\u8c03\u5ea6\u4e0e\u62a2\u5360</p> <ul> <li>RR \u8c03\u5ea6\u4e2d\u65f6\u95f4\u7247\u5982\u4f55\u6d88\u8017\u4e0e\u8865\u5145\uff1f\u5f53\u65f6\u95f4\u7247\u8017\u5c3d\u65f6\u5982\u4f55\u9009\u62e9\u4e0b\u4e00\u4e2a\u4efb\u52a1\uff1f\u6b64\u9009\u62e9\u4e0e\u8fdb\u7a0b\u94fe\u8868\u904d\u5386\u987a\u5e8f\u7684\u5173\u7cfb\u662f\u4ec0\u4e48\uff1f</li> <li>\u62a2\u5360\u4ece\u54ea\u91cc\u89e6\u53d1\uff1f\u8fdb\u5165\u548c\u79bb\u5f00 <code>__switch_to()</code> \u524d\u540e\uff0c\u5bf9\u4e2d\u65ad\u4f4d\uff08<code>SIE/SPIE</code>\uff09\u5206\u522b\u6709\u4ec0\u4e48\u8981\u6c42\uff1f\u4e3a\u4ec0\u4e48\uff1f</li> <li><code>do_exit()</code> \u4e0e <code>release_task()</code> \u5206\u522b\u5728\u4f55\u5904\u8c03\u7528\u3001\u5404\u81ea\u804c\u8d23\u662f\u4ec0\u4e48\uff1f\u4e3a\u4ec0\u4e48\u4e0d\u80fd\u8ba9\u8fdb\u7a0b\u201c\u81ea\u6211\u9500\u6bc1\u201d\uff1f</li> <li><code>kthreadd</code> \u6709\u4f55\u7279\u6b8a\u6027\uff1f\u4e3a\u4ec0\u4e48\u51e0\u4e4e\u4e0d\u5360\u7528\u8c03\u5ea6\u65f6\u95f4\uff1f\u5f02\u6b65\u521b\u5efa\u5bf9\u516c\u5e73\u6027/\u9965\u997f\u6709\u4ec0\u4e48\u5f71\u54cd\uff1f</li> </ul>"},{"location":"lab2/#\u7ed3\u8bedlab2-\u548c-linux-\u8c03\u5ea6\u5668\u7684\u5386\u53f2","title":"\u7ed3\u8bed\uff1aLab2 \u548c Linux \u8c03\u5ea6\u5668\u7684\u5386\u53f2","text":"<p>\u5176\u5b9e\uff0c\u5b9e\u9a8c\u6846\u67b6\u6700\u5f00\u59cb\u5b9e\u73b0\u7684\u662f\u4f18\u5148\u7ea7\u8c03\u5ea6\uff0c\u4f46\u662f\u4f18\u5148\u7ea7\u8c03\u5ea6\u7b97\u6cd5\u5f88\u5bb9\u6613\u9020\u6210\u9965\u997f\uff08Starvation\uff09\uff0c\u4e0e <code>kthreadd</code> \u7684\u5f02\u6b65\u521b\u5efa\u673a\u5236\u51b2\u7a81\u3002\u4e3e\u4f8b\uff1a</p> <ul> <li>\u65b0\u7684\u521b\u5efa\u8bf7\u6c42\u653e\u5165\u961f\u5217</li> <li><code>kthreadd</code> \u7ebf\u7a0b\u4ece\u961f\u5217\u4e2d\u53d6\u51fa\u8bf7\u6c42\uff0c\u521b\u5efa\u65b0\u7ebf\u7a0b</li> <li>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u65b0\u7ebf\u7a0b\u4e0e <code>kthreadd</code> \u7ebf\u7a0b\u4f18\u5148\u7ea7\u76f8\u540c\uff0c\u4f46 PID \u8f83\u5927</li> <li>\u5728\u4f18\u5148\u7ea7\u76f8\u540c\u7684\u60c5\u51b5\u4e0b\uff0c<code>schedule()</code> \u7684\u8c03\u5ea6\u7b97\u6cd5\u59cb\u7ec8\u9009\u62e9 PID \u8f83\u5c0f\u7684\u8fdb\u7a0b\uff08\u56e0\u4e3a\u662f\u4ece\u8fdb\u7a0b\u94fe\u8868\u5934\u5f00\u59cb\u904d\u5386\u7684\uff09</li> <li>\u65b0\u7ebf\u7a0b\u6c38\u8fdc\u65e0\u6cd5\u88ab\u8c03\u5ea6\u8fd0\u884c</li> </ul> <p>\u4f7f\u7528\u7406\u8bba\u8bfe\u4e0a\u8bb2\u7684\u8001\u5316\uff08\u52a8\u6001\u4f18\u5148\u7ea7\uff09\u53ef\u4ee5\u89e3\u51b3\u9965\u997f\u95ee\u9898\uff0c\u4f46\u4e0d\u516c\u5e73\uff08Fairness\uff09\u7684\u95ee\u9898\u4ecd\u7136\u5341\u5206\u4e25\u91cd\uff0c\u96be\u4ee5\u5e73\u8861\u5404\u4e2a\u8fdb\u7a0b\u7684\u54cd\u5e94\u65f6\u95f4\u3002\u6bd4\u5982 <code>kthreadd</code> \u53ef\u80fd\u9700\u8981\u5f88\u957f\u7684\u7d2f\u79ef\u7b49\u5f85\u65f6\u95f4\u624d\u80fd\u88ab\u8c03\u5ea6\u8fd0\u884c\uff0c\u4e25\u91cd\u5f71\u54cd\u5185\u6838\u8fdb\u7a0b\u5f02\u6b65\u521b\u5efa\u7684\u80fd\u529b\u3002\u6700\u7ec8\u5b9e\u9a8c\u6846\u67b6\u9009\u7528\u4e86 RR \u8c03\u5ea6\uff0c\u81f3\u5c11\u80fd\u5e73\u8861\u5404\u4e2a\u8fdb\u7a0b\u7684\u54cd\u5e94\u65f6\u95f4\u3002\u4f46\u7531\u4e8e\u6ca1\u6709\u5b9e\u73b0\u963b\u585e\u548c\u5524\u9192\u673a\u5236\uff0cRR \u8c03\u5ea6\u7684\u4f18\u52bf\u4e5f\u65e0\u6cd5\u4f53\u73b0\u51fa\u6765\u3002</p> <p>\u603b\u7684\u6765\u8bf4\uff0cLab2 \u7684\u5185\u6838\u62a2\u5360\u548c\u8fdb\u7a0b\u7ba1\u7406\u5df2\u7ecf\u6210\u529f\u6539\u9769\u5230 Linux 2.6 \u65f6\u4ee3\uff0c\u4f46\u8c03\u5ea6\u7b97\u6cd5\u548c\u540c\u6b65\u673a\u5236\u8fd8\u6ca1\u8ddf\u4e0a\uff0c\u6240\u4ee5\u540c\u5b66\u4eec\u505a Lab \u65f6\u53ef\u80fd\u4f1a\u89c9\u5f97\u6709\u4e9b\u5730\u65b9\u7684\u5b9e\u73b0\u4e0d\u591f\u5408\u7406\uff0c\u6b22\u8fce\u4f60\u6765\u627e\u52a9\u6559\u8ba8\u8bba\u3002</p> <p>\u8981\u60f3\u8ba9 <code>kthreadd</code> \u771f\u6b63\u53d1\u6325\u4f5c\u7528\uff0c\u9700\u8981\u5b9e\u73b0\u4e0e Linux \u7684\u5b8c\u5168\u516c\u5e73\u8c03\u5ea6\u5668\uff08Completely Fair Scheduler, CFS\uff09\u7c7b\u4f3c\u7684\u8c03\u5ea6\u7b97\u6cd5\u3002\u611f\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u81ea\u884c\u9605\u8bfb\u76f8\u5173\u8d44\u6599\uff0c\u5b83\u6700\u7ec8\u5e94\u8be5\u4f1a\u5728 Bonus B \u4e2d\u5b9e\u73b0\u3002</p> <p>\u6700\u540e\u7b80\u5355\u4ecb\u7ecd\u4e00\u4e0b Linux \u7684\u8c03\u5ea6\u7b97\u6cd5\u6f14\u8fdb\u53f2\uff1a</p> \u7248\u672c \u8c03\u5ea6\u7b97\u6cd5 \u53c2\u8003\u94fe\u63a5 2.6 \u524d \\(O(n)\\) \u8c03\u5ea6\u5668\uff08\u5176\u4ed6\u73ed\u7ea7\u5b9e\u73b0\u7684\uff09 sched.c - kernel/sched.c - Linux source code 0.11 - Bootlin Elixir Cross Referencer 2.6.0-2.6.22 \\(O(1)\\) \u8c03\u5ea6\u5668 The Linux Scheduling Algorithm - Linux Kernel Development Second Edition 2.6.23 - 6.6 CFS \u8c03\u5ea6\u5668 CFS Scheduler \u2014 The Linux Kernel documentation 6.6 - \u4eca EEVDF \u8c03\u5ea6\u5668 EEVDF Scheduler \u2014 The Linux Kernel documentation \u5f00\u53d1\u4e2d <code>sched_ext</code> \u901a\u8fc7 BPF \u7a0b\u5e8f\u5b9a\u5236\u4efb\u610f\u8c03\u5ea6\u7b97\u6cd5 Extensible Scheduler Class \u2014 The Linux Kernel documentation"},{"location":"lab3/","title":"Lab 3\uff1aSv39 \u5206\u9875\u5f0f\u865a\u62df\u5185\u5b58\u7cfb\u7edf","text":""},{"location":"lab3/#lab-3sv39-\u5206\u9875\u5f0f\u865a\u62df\u5185\u5b58\u7cfb\u7edf","title":"Lab 3\uff1aSv39 \u5206\u9875\u5f0f\u865a\u62df\u5185\u5b58\u7cfb\u7edf","text":"<p>DDL</p> <ul> <li>\u4ee3\u7801\u3001\u62a5\u544a\uff1a2025-11-11 23:59</li> <li>\u9a8c\u6536\uff1a2025-11-18 \u5b9e\u9a8c\u8bfe</li> </ul>"},{"location":"lab3/#\u5b9e\u9a8c\u7b80\u4ecb","title":"\u5b9e\u9a8c\u7b80\u4ecb","text":"<p>\u5728\u524d\u4e24\u4e2a\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u7684\u5185\u6838\u4e00\u76f4\u8fd0\u884c\u5728\u7269\u7406\u5730\u5740\u7a7a\u95f4\u4e2d\u3002\u672c\u6b21\u5b9e\u9a8c\u7684\u76ee\u6807\uff0c\u662f\u8ba9\u5185\u6838\u6b63\u5f0f\u8fdb\u5165\u201c\u865a\u62df\u4e16\u754c\u201d\u2014\u2014\u5b9e\u73b0 RISC-V \u7684 Sv39 \u5206\u9875\u5f0f\u865a\u62df\u5185\u5b58\u7cfb\u7edf\u3002</p> <p>\u5728\u7406\u8bba\u8bfe\u7b2c\u516b\u3001\u4e5d\u7ae0\u4e2d\uff0c\u6211\u4eec\u5df2\u7ecf\u5b66\u4e60\u4e86\u865a\u62df\u5185\u5b58\u7684\u6982\u5ff5\u4e0e\u8bbe\u8ba1\u601d\u60f3\u3002\u73b0\u5728\uff0c\u8ba9\u6211\u4eec\u4ece\u201c\u4e3a\u4ec0\u4e48\u201d\u51fa\u53d1\uff0c\u91cd\u65b0\u7406\u4e00\u7406\u5b83\u7684\u6f14\u8fdb\u8109\u7edc\uff1a</p> <ul> <li>\u5728\u65e9\u671f\u7cfb\u7edf\u4e2d\uff0c\u7a0b\u5e8f\u5458\u9700\u8981\u624b\u52a8\u7ba1\u7406\u7269\u7406\u5185\u5b58\uff0c\u5bb9\u6613\u51fa\u9519\uff0c\u4e5f\u96be\u4ee5\u5b9e\u73b0\u9694\u79bb\u548c\u4fdd\u62a4\u3002</li> <li> <p>\u968f\u7740\u7cfb\u7edf\u590d\u6742\u5ea6\u63d0\u5347\uff0c\u5185\u5b58\u7ba1\u7406\u7ecf\u5386\u4e86\u4ece\u5355\u4e00\u8fde\u7eed\u5206\u914d \u2192 \u9759\u6001\u5206\u6bb5\uff08Base and Bound\uff09 \u2192 \u52a8\u6001\u5206\u6bb5\uff08Segmentation\uff09\u2192 \u5206\u9875\uff08Paging\uff09\u7684\u6f14\u5316\u3002\u6bcf\u79cd\u65b9\u5f0f\u90fd\u6709\u4f18\u7f3a\u70b9\uff1a\u5206\u6bb5\u5bb9\u6613\u4ea7\u751f\u5916\u90e8\u788e\u7247\uff0c\u5206\u9875\u5219\u53ef\u80fd\u5e26\u6765\u5185\u90e8\u788e\u7247\u3002</p> <p></p>      \u5185\u5b58\u7ba1\u7406\u7684\u53d1\u5c55\u5386\u7a0b \u56fe\u7247\u6765\u6e90\uff1aLinux Kernel Development (3rd)      <p></p> </li> <li> <p>\u5206\u9875\u673a\u5236\u7684\u5173\u952e\u601d\u60f3\u662f\uff1a\u7528\u201c\u865a\u62df\u5730\u5740\u201d\u7edf\u4e00\u62bd\u8c61\u5185\u5b58\uff0c\u8ba9\u7a0b\u5e8f\u8ba4\u4e3a\u81ea\u5df1\u72ec\u5360\u6574\u4e2a\u5730\u5740\u7a7a\u95f4\u3002</p> </li> </ul> <p>\u5b9e\u73b0\u865a\u62df\u5185\u5b58\u9700\u8981\u8f6f\u786c\u4ef6\u534f\u4f5c\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p>      \u865a\u62df\u5185\u5b58\u7684\u8f6f\u786c\u4ef6\u534f\u4f5c \u56fe\u7247\u6765\u6e90\uff1aPiyush Itankar on X: \"Here is how MMU (memory management unit) works!\" <ul> <li>CPU \u5185\u90e8\u7684 MMU\uff08Memory Management Unit\uff09 \u8d1f\u8d23\u89e3\u6790\u9875\u8868\u3001\u6267\u884c\u5730\u5740\u8f6c\u6362\u548c\u6743\u9650\u68c0\u67e5\u3002\u6211\u4eec\u7684\u6240\u6709\u786c\u4ef6\u90fd\u662f QEMU \u6a21\u62df\u7684\uff0c\u5b83\u4e5f\u4f1a\u5b9e\u73b0 MMU \u7684\u529f\u80fd\u3002</li> <li>\u6211\u4eec\u5b9e\u73b0\u7684\u64cd\u4f5c\u7cfb\u7edf\u9700\u8981\u8d1f\u8d23\u6784\u5efa\u4e0e\u7ef4\u62a4\u9875\u8868\u3001\u5904\u7406\u7f3a\u9875\u5f02\u5e38\u3002</li> </ul> <p>\u672c\u5b9e\u9a8c\u8981\u5b9e\u73b0 RISC-V \u89c4\u8303\u4e2d\u7684 Sv39 \u591a\u7ea7\u9875\u8868\u673a\u5236\uff0c\u4f60\u5c06\u5b8c\u6210\u4ee5\u4e0b\u5173\u952e\u6b65\u9aa4\uff1a</p> <ol> <li>\u7406\u89e3\u5e76\u638c\u63e1\u9875\u8868\u7ed3\u6784\uff1a\u5b66\u4e60 Sv39 \u7684\u4e09\u7ea7\u9875\u8868\u683c\u5f0f\uff0c\u5f04\u6e05\u6bcf\u7ea7\u7d22\u5f15\u3001PTE \u5404\u5b57\u6bb5\u7684\u610f\u4e49\u3002</li> <li>\u6784\u5efa\u5185\u6838\u9875\u8868\uff1a\u4e3a\u5185\u6838\u955c\u50cf\u7684\u5404\u4e2a\u6bb5\uff08<code>.text</code>\u3001<code>.rodata</code>\u3001<code>.data</code>\u3001<code>.bss</code>\uff09\u5efa\u7acb\u6620\u5c04\uff0c\u5e76\u914d\u7f6e\u6b63\u786e\u7684\u8bbf\u95ee\u6743\u9650\uff1b\u540c\u65f6\u5b9e\u73b0\u5185\u6838\u7a7a\u95f4\u7684\u76f4\u63a5\u6620\u5c04\u533a\u57df\u3002</li> <li>\u5207\u6362\u81f3\u865a\u62df\u5730\u5740\u6267\u884c\uff1a\u914d\u7f6e <code>satp</code> \u5bc4\u5b58\u5668\uff0c\u6267\u884c <code>sfence.vma</code>\uff0c\u5b8c\u6210\u4ece\u7269\u7406\u5730\u5740\u5230\u865a\u62df\u5730\u5740\u7684\u5b89\u5168\u8fc7\u6e21\u3002</li> </ol> <p>\u5b8c\u6210\u672c\u5b9e\u9a8c\u540e\uff0c\u4f60\u7684\u64cd\u4f5c\u7cfb\u7edf\u5c06\u7b2c\u4e00\u6b21\u5177\u5907\u5b8c\u6574\u7684\u5730\u5740\u7a7a\u95f4\u62bd\u8c61\u80fd\u529b\uff0c\u4e3a Lab4 \u5b9e\u73b0\u7528\u6237\u6001\u8fdb\u7a0b\u5960\u5b9a\u57fa\u7840\u3002</p>"},{"location":"lab3/#\u5b9e\u9a8c\u8981\u6c42","title":"\u5b9e\u9a8c\u8981\u6c42","text":"<p>\u89c1 \u9996\u9875#\u8981\u6c42\u548c\u8bc4\u5206\u6807\u51c6</p>"},{"location":"lab3/#part-0\u73af\u5883\u914d\u7f6e","title":"Part 0\uff1a\u73af\u5883\u914d\u7f6e","text":""},{"location":"lab3/#\u66f4\u65b0\u4ee3\u7801","title":"\u66f4\u65b0\u4ee3\u7801","text":"<p>\u73b0\u5728\u4f60\u4f4d\u4e8e <code>lab2</code> \u5206\u652f\u3002\u4f60\u9700\u8981\u521b\u5efa <code>lab3</code> \u5206\u652f\uff0c\u5408\u5e76\u4e0a\u6e38\u7684\u4ee3\u7801\uff1a</p> <pre><code>git checkout -b lab3\ngit fetch upstream\ngit merge upstream/lab3\n</code></pre> <p>\u4e0b\u9762\u7684\u5408\u5e76\u8bf4\u660e\u4f9b\u540c\u5b66\u4eec\u89e3\u51b3\u5408\u5e76\u51b2\u7a81\u65f6\u53c2\u8003\uff1alab3: init (!21) \u00b7 Merge requests \u00b7 OS / Code \u00b7 GitLab</p> <ul> <li>\u65b0\u589e\u5b9e\u9a8c\u76f8\u5173\uff1a<ul> <li>\u865a\u62df\u5185\u5b58\u4ee3\u7801 <code>vm.h</code>\u3001<code>vm.c</code></li> <li>\u5934\u6587\u4ef6\u4e2d\u65b0\u589e\u4e86\u4e00\u4e9b\u5b8f\u5b9a\u4e49</li> <li><code>vmlinux.lds</code> \u6dfb\u52a0\u865a\u62df\u5185\u5b58\u914d\u7f6e</li> <li>\u9700\u8981\u7269\u7406\u5730\u5740\u7684\u4f4d\u7f6e\u6dfb\u52a0\u4e86 <code>PA2VA</code>\u3001<code>VA2PA</code> \u5b8f</li> </ul> </li> <li>\u53d8\u66f4\uff1a<ul> <li><code>vmlinux.lds</code>\uff1a\u94fe\u63a5\u5668\u811a\u672c\u4fee\u6539\uff0c\u5176\u4e2d <code>_sbss</code> \u79fb\u52a8\u5230 <code>.bss</code> \u6bb5\u6700\u5f00\u59cb\u7684\u4f4d\u7f6e\uff08\u56e0\u4e3a\u5f85\u4f1a\u8981\u7528\uff09\uff0c\u73b0\u5728\u4e0d\u662f\u6808\u5e95\u4e86\u3002\u91cd\u65b0\u5f04\u4e86\u4fe9\u7b26\u53f7 <code>_sstack</code> \u548c <code>_estack</code> \u4f5c\u4e3a\u5185\u6838\u6808\u7684\u8fb9\u754c\u3002\u4e4b\u524d\u4f7f\u7528 <code>_sbss</code> \u4f5c\u4e3a\u5185\u6838\u6808\u7684\u540c\u5b66\u9700\u8981\u4fee\u6539 <code>head.S</code>\uff0c\u800c\u5728 <code>head.S</code> \u4e2d\u81ea\u884c\u5b9a\u4e49\u6808\u8fb9\u754c\u7684\u540c\u5b66\u5219\u4e0d\u53d7\u5f71\u54cd\u3002</li> <li><code>head.S</code> \u4e2d Lab1 Task3\uff08<code>stvec</code> \u7684\u8bbe\u7f6e\uff09\u5411\u524d\u79fb\u52a8\uff0c\u7d27\u63a5\u5728 Lab1 Task1\uff08\u6808\u7684\u8bbe\u7f6e\uff09\u4e4b\u540e\u3002\u8fd9\u6837\u80fd\u66f4\u65e9\u5730\u6355\u83b7\u5f02\u5e38\u3002</li> </ul> </li> </ul>"},{"location":"lab3/#part-1\u4ece\u7269\u7406\u5730\u5740\u5230\u865a\u62df\u5730\u5740","title":"Part 1\uff1a\u4ece\u7269\u7406\u5730\u5740\u5230\u865a\u62df\u5730\u5740","text":""},{"location":"lab3/#\u865a\u62df\u4e0e\u52a0\u8f7d\u5730\u5740","title":"\u865a\u62df\u4e0e\u52a0\u8f7d\u5730\u5740","text":"<p>\u540c\u5b66\u4eec\u5408\u5e76 <code>vmlinux.lds</code> \u7684\u66f4\u6539\u65f6\uff0c\u5e94\u8be5\u6ce8\u610f\u5230\u5176\u4e2d\u53d1\u751f\u4e86\u8fd9\u6837\u7684\u53d8\u66f4\uff1a</p> <pre><code>diff --git a/kernel/arch/riscv/kernel/vmlinux.lds b/kernel/arch/riscv/kernel/vmlinux.lds\nindex 6ede8c0..24c9f07 100644\n--- a/kernel/arch/riscv/kernel/vmlinux.lds\n+++ b/kernel/arch/riscv/kernel/vmlinux.lds\n@@ -7,12 +7,15 @@ PHY_SIZE     = (128 * 1024 * 1024);\n PHY_END      = (PHY_START + PHY_SIZE);\n PGSIZE       = 0x1000;\n OPENSBI_SIZE = (0x200000);\n+VM_DIRECT_START = 0xffffffd600000000;\n+VM_DIRECT_END = (VM_DIRECT_START + PHY_SIZE);\n\n MEMORY {\n     ram  (wxa!ri): ORIGIN = PHY_START + OPENSBI_SIZE, LENGTH = PHY_SIZE - OPENSBI_SIZE\n+    ramv (wxa!ri): ORIGIN = VM_DIRECT_START + OPENSBI_SIZE, LENGTH = PHY_SIZE - OPENSBI_SIZE\n }\n\n-BASE_ADDR = PHY_START + OPENSBI_SIZE;\n+BASE_ADDR = VM_DIRECT_START + OPENSBI_SIZE;\n\n SECTIONS\n {\n@@ -28,7 +31,7 @@ SECTIONS\n         *(.text .text.*)\n\n         _etext = .;\n-    } AT&gt;ram\n+    } &gt;ramv AT&gt;ram\n\n     .rodata : ALIGN(0x1000) {\n         _srodata = .;\n</code></pre> <p>\u8bf7\u7f16\u8bd1\u5185\u6838\uff0c\u5e76\u89c2\u5bdf\u4e0a\u8ff0\u4fee\u6539\u5f15\u8d77\u7684\u53d8\u5316\uff1a</p> <ul> <li> <p>\u4fee\u6539\uff1a<code>BASE_ADDR</code> \u4ece\u7269\u7406\u5730\u5740 <code>0x80000000</code> \u53d8\u4e3a\u865a\u62df\u5730\u5740 <code>0xffffffd600000000</code>\u3002</p> <p>\u53d8\u5316\uff1a\u6253\u5f00 <code>System.map</code>\uff0c\u770b\u770b\u5185\u6838\u7b26\u53f7\u4eec\u7684\u5730\u5740\u53d1\u751f\u4e86\u4ec0\u4e48\u53d8\u5316\uff1f</p> <p>\u6240\u6709\u7b26\u53f7\u7684\u5730\u5740\u90fd\u4ece\u539f\u6765\u7684 <code>0x80000000</code> \u5f00\u5934\u53d8\u4e3a <code>0xffffffd600000000</code> \u5f00\u5934\u3002Part 2 \u5185\u5b58\u5e03\u5c40\u4e00\u8282\u4f1a\u89e3\u91ca\u4e3a\u4ec0\u4e48\u9009\u62e9\u8fd9\u4e2a\u5730\u5740\u3002</p> </li> <li> <p>\u4fee\u6539\uff1a\u5404 Section \u7684\u5730\u5740\u53d1\u751f\u4e86\u53d8\u5316\uff0c\u76f8\u5173\u7684\u94fe\u63a5\u5668\u811a\u672c\u8bed\u6cd5\u89c1 3.6.8.2 Output Section LMA - LD\u3002</p> <p>Every section has a virtual address (VMA) and a load address (LMA); see Basic Linker Script Concepts. The virtual address is specified by the see Output Section Address described earlier. The load address is specified by the AT or AT&gt; keywords. Specifying a load address is optional.</p> <p>The AT keyword takes an expression as an argument. This specifies the exact load address of the section. The AT&gt; keyword takes the name of a memory region as an argument. See MEMORY Command. The load address of the section is set to the next free address in the region, aligned to the section\u2019s alignment requirements.</p> <p>\u53d8\u5316\uff1a\u94fe\u63a5\u5668\u5728\u6267\u884c\u7b26\u53f7\u89e3\u6790\u3001\u91cd\u5b9a\u4f4d\u7b49\u94fe\u63a5\u64cd\u4f5c\u65f6\uff0c\u73b0\u5728\u4f1a\u4f7f\u7528 VMA \u5730\u5740\uff08\u865a\u62df\u5730\u5740\uff09\uff0c\u800c\u5728\u751f\u6210\u6700\u7ec8\u7684\u5185\u6838\u955c\u50cf\u65f6\uff0c\u4ecd\u7136\u4f7f\u7528\u7684\u662f LMA \u5730\u5740\uff08\u7269\u7406\u5730\u5740\uff09\u3002</p> <p>\u6ce8\u610f\u5230\u94fe\u63a5\u5668\u811a\u672c\u4e2d\u7684\u6bcf\u4e2a\u6bb5\u540e\u90fd\u6709 <code>AT&gt;ram</code>\uff0c\u8fd9\u4fdd\u8bc1\u4e86\u5185\u6838\u955c\u50cf\u4ecd\u7136\u4f1a\u88ab\u52a0\u8f7d\u5230 <code>0x80200000</code> \u5f00\u59cb\u7684\u7269\u7406\u5185\u5b58\u4e2d\u3002</p> <p>\u52a8\u624b\u505a\uff1a\u9a8c\u8bc1\u5185\u6838\u52a0\u8f7d\u7684\u4ecd\u662f\u7269\u7406\u5730\u5740</p> <p>\u52a8\u624b\u8c03\u8bd5\u4e00\u4e0b\u521a\u7f16\u8bd1\u7684\u5185\u6838\uff1a</p> <ul> <li>\u5728 <code>0x80200000</code> \u5904\u6253\u65ad\u70b9\uff0c\u8ba9 GDB \u8fd0\u884c\u5230\u65ad\u70b9\u5904\u505c\u4e0b\u6765\uff1b</li> <li>\u4f60\u4f1a\u53d1\u73b0 GDB \u73b0\u5728\u6ca1\u6cd5\u89e3\u6790\u6e90\u7801\u4f4d\u7f6e\uff08\u6bd4\u5982\u65ad\u70b9\u5904\u505c\u4e0b\u6765\u7684\u65f6\u5019\u663e\u793a <code>0x80200000 in ??()</code>\uff09\u3002\u8fd9\u662f\u56e0\u4e3a GDB \u662f\u6839\u636e\u7b26\u53f7\u7684\u4f4d\u7f6e\u6765\u63a8\u7b97\u5f53\u524d\u4f4d\u4e8e\u54ea\u4e2a\u51fd\u6570\u7684\uff0c\u73b0\u5728\u6240\u6709\u7b26\u53f7\u90fd\u53d8\u6210\u4e86\u865a\u62df\u5730\u5740\uff0c\u5b83\u73b0\u5728\u627e\u4e0d\u5230 <code>0x80200000</code> \u5bf9\u5e94\u54ea\u4e2a\u51fd\u6570\uff1b</li> <li>\u4f7f\u7528 GDB \u6216 QEMU Monitor\uff0c\u5c06\u4ece <code>0x80200000</code> \u5f00\u59cb\u7684\u5185\u5b58\u6253\u5370\u4e3a\u6307\u4ee4\uff0c\u4e0e <code>vmlinux.asm</code> \u4e2d\u7684\u53cd\u6c47\u7f16\u7ed3\u679c\u5bf9\u6bd4\uff0c\u5b83\u4eec\u662f\u5426\u4e00\u81f4\uff1f</li> </ul> </li> </ul>"},{"location":"lab3/#\u5bfb\u5740\u65b9\u5f0f","title":"\u5bfb\u5740\u65b9\u5f0f","text":"<p>\u5728\u521a\u624d\u7684\u52a8\u624b\u505a\u4e2d\uff0c\u4f60\u5e94\u8be5\u53d1\u73b0\u4e86\u7ed3\u679c\u5b58\u5728\u4e00\u4e9b\u4e0d\u4e00\u81f4\u3002\u8fd9\u91cc\u4ee5 <code>mm_init()</code> \u51fd\u6570\u7684\u8c03\u7528\u4e3a\u4f8b\uff1a</p> vmlinux.asm \u4e2d\u7684\u53cd\u6c47\u7f16\u7ed3\u679c<pre><code>    call mm_init\nffffffd600200018: 3f9000ef           jal ffffffd600200c10 &lt;mm_init&gt;\n</code></pre> GDB \u4e2d\u7684\u53cd\u6c47\u7f16\u7ed3\u679c<pre><code>(gdb) x/10i 0x80200018\n   0x80200018:  jal     0x80200c10\n(gdb) x/10xw 0x80200018\n0x80200018:     0x3f9000ef\n</code></pre> <p><code>objdump</code> \u53cd\u6c47\u7f16\u7ed3\u679c\u663e\u793a <code>jal</code> \u6307\u4ee4\u8df3\u8f6c\u5230 <code>0xffffffd600200c10</code>\uff0c\u800c GDB \u663e\u793a\u8df3\u8f6c\u5230 <code>0x80200c10</code>\u3002\u4f46\u662f\uff0c\u4e24\u8fb9\u7684\u673a\u5668\u7801\u90fd\u662f <code>0x3f9000ef</code>\uff0c\u8bf4\u660e\u5b83\u4eec\u5b9e\u9645\u4e0a\u662f\u540c\u4e00\u6761\u6307\u4ee4\u3002\u4f60\u80fd\u89e3\u91ca\u8fd9\u662f\u4e3a\u4ec0\u4e48\u5417\uff1f</p> <p>\u52a8\u624b\u505a\uff1a\u89e3\u91ca\u540c\u4e00\u6761\u6307\u4ee4\u7684\u4e0d\u540c\u7ffb\u8bd1\u7ed3\u679c</p> <p>\u63d0\u793a\uff1a</p> <ul> <li>\u628a\u673a\u5668\u7801\uff08\u7528\u4f60\u81ea\u5df1\u7684\u673a\u5668\u7801\uff0c\u548c\u6587\u6863\u4e0d\u4e00\u5b9a\u76f8\u540c\uff09\u8f93\u5165\u5230 rvcodec.js \u00b7 RISC-V Instruction Encoder/Decoder \u4e2d\uff0c\u770b\u770b\u89e3\u7801\u51fa\u6765\u662f\u4ec0\u4e48\u3002</li> <li><code>jal</code> \u6307\u4ee4\u7684\u5bfb\u5740\u65b9\u5f0f\u662f\u4ec0\u4e48\uff1f</li> <li>\u5728 <code>vmlinux.asm</code> \u548c GDB \u4e2d\uff0c\u5f53\u524d\u6307\u4ee4\u5730\u5740\uff08PC\uff09\u5206\u522b\u662f\u4ec0\u4e48\uff1f\u4f60\u80fd\u7b97\u7b97\u8df3\u8f6c\u76ee\u6807\u5730\u5740\u662f\u5426\u548c\u7ffb\u8bd1\u7ed3\u679c\u4e00\u81f4\u5417\uff1f</li> </ul> <p>\u518d\u770b\u770b\u5176\u4ed6\u6307\u4ee4\u3002\u5728 Lab1 \u4e2d\u6211\u4eec\u8bbe\u7f6e\u4e86\u6808\uff0c\u4e00\u822c\u662f\u901a\u8fc7 <code>la</code> \u67d0\u4e2a\u7b26\u53f7\u5730\u5740\u5b9e\u73b0\u7684\uff0c\u770b\u770b\u770b\u5b83\u7ffb\u8bd1\u6210\u4e86\u4ec0\u4e48\uff1a</p> vmlinux.asm \u4e2d\u7684\u53cd\u6c47\u7f16\u7ed3\u679c<pre><code>    /* Lab1 Task1 */\n    # need to setup sp for C function\n    # s0 is callee-saved, so we can use it as a temporary register\n    la sp, _estack\nffffffd600200004: 00009117           auipc sp,0x9\nffffffd600200008: ffc10113           addi sp,sp,-4 # ffffffd600209000 &lt;kthread_create_info_cache&gt;\n</code></pre> <p>\u901a\u8fc7\u4e0a\u8ff0\u63a2\u7a76\uff0c\u540c\u5b66\u4eec\u5e94\u8be5\u80fd\u60f3\u8d77\u300a\u8ba1\u7b97\u673a\u7ec4\u6210\u300b\u8bfe\u4e0a\u5b66\u4e60\u8fc7\u7684 RISC-V \u5bfb\u5740\u65b9\u5f0f\uff1a</p>      RISC-V \u7684\u5bfb\u5740\u65b9\u5f0f \u56fe\u7247\u6765\u6e90\uff1a\u300a\u8ba1\u7b97\u673a\u7ec4\u6210\u300b\u8bfe\u7a0b PPT <p>\u73b0\u5728\u6211\u4eec\u77e5\u9053\uff0c\u94fe\u63a5\u5668\u5728\u89e3\u6790\u51fd\u6570\u3001\u5168\u5c40\u53d8\u91cf\u7b49\u7b26\u53f7\u65f6\uff0c\u4f7f\u7528\u7684\u90fd\u662f PC \u76f8\u5bf9\u5bfb\u5740\u3002\u8bb0\u4f4f\u8fd9\u4e00\u70b9\uff0c\u5b83\u4e3a\u4e0b\u6587\u7684\u91cd\u5b9a\u4f4d\u5960\u5b9a\u4e86\u57fa\u7840\u3002</p>"},{"location":"lab3/#\u865a\u62df\u4e0e\u7269\u7406\u5730\u5740\u7684\u8f6c\u6362","title":"\u865a\u62df\u4e0e\u7269\u7406\u5730\u5740\u7684\u8f6c\u6362","text":"<p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u6709\u4e9b\u5730\u65b9\u4ecd\u7136\u4f7f\u7528\u7269\u7406\u5730\u5740\u3002\u4f8b\u5982\uff1a</p> <ul> <li><code>sbi_debug_console_write()</code> \u51fd\u6570\u4ecd\u7136\u63a5\u6536\u7269\u7406\u5730\u5740\u53c2\u6570</li> <li>Buddy System \u4ecd\u7136\u4f7f\u7528\u7269\u7406\u9875\u5e27\uff08PFN\uff09\u7ba1\u7406\u5185\u5b58</li> <li>\u4e0b\u6587\u5b66\u4e60\u7684 SATP\u3001PTE \u4e2d\u7684 PPN \u4e5f\u662f\u7269\u7406\u9875\u53f7</li> </ul> <p>\u8fd9\u4e9b\u4f4d\u7f6e\u4f7f\u7528 <code>VA2PA</code>\u3001<code>PA2VA</code> \u7b49\u5b8f\u8fdb\u884c\u8f6c\u6362\u3002\u5728\u5408\u5e76\u3001\u7f16\u5199\u4ee3\u7801\u65f6\uff0c\u8bf7\u52a1\u5fc5\u533a\u5206\u6e05\u695a\u865a\u62df\u5730\u5740\u4e0e\u7269\u7406\u5730\u5740\uff0c\u907f\u514d\u6df7\u6dc6\u3002</p>"},{"location":"lab3/#part-2\u6784\u9020-sv39-\u9875\u8868","title":"Part 2\uff1a\u6784\u9020 Sv39 \u9875\u8868","text":""},{"location":"lab3/#risc-v-sv39-\u89c4\u8303\u9605\u8bfb","title":"RISC-V Sv39 \u89c4\u8303\u9605\u8bfb","text":"<p>\u672c\u8282\u8981\u6c42\u540c\u5b66\u4eec\u5b8c\u6574\u9605\u8bfb\u7279\u6743\u7ea7\u624b\u518c\u4e2d\u7684\u4ee5\u4e0b\u4e24\u8282\uff1a</p> <ul> <li>12.3. Sv32: Page-Based 32-bit Virtual-Memory Systems</li> <li>12.4. Sv39: Page-Based 39-bit Virtual-Memory System</li> </ul> <p>\u4e0d\u53ef\u8df3\u8fc7\u89c4\u8303\u9605\u8bfb</p> <p>Sv39 \u662f\u5206\u9875\u673a\u5236\u7684\u6838\u5fc3\uff0c\u5386\u5e74\u8003\u8bd5\u51e0\u4e4e\u5fc5\u8003\u3002\u4e0d\u8bfb\u6807\u51c6\uff0c\u4f60\u4f1a\u5728\u4f4d\u5bbd\u3001\u6743\u9650\u4f4d\u3001\u7ffb\u8bd1\u6d41\u7a0b\u4e0a\u51fa\u73b0\u7406\u89e3\u504f\u5dee\u3002\u8bf7\u52a1\u5fc5\u8ba4\u771f\u901a\u8bfb\u5e76\u7ed3\u5408\u56fe\u8868\u7406\u89e3\u3002</p> <p>\u5bfc\u8bfb\uff1a</p> <ul> <li>\u9605\u8bfb\u76ee\u6807\u662f\u638c\u63e1 RISC-V \u7684\u865a\u62df\u5730\u5740\u7ed3\u6784\u3001\u9875\u8868\u5c42\u7ea7\u4e0e\u7ffb\u8bd1\u7b97\u6cd5\u3002\u9605\u8bfb Sv32 \u4e86\u89e3\u673a\u5236\uff0c\u9605\u8bfb Sv39 \u660e\u786e\u5dee\u5f02\u3002</li> <li>Sv32 \u662f\u7ed9 32 \u4f4d\u7cfb\u7edf\u8bbe\u8ba1\u7684\uff0c\u5b83\u8be6\u7ec6\u63cf\u8ff0\u4e86\u201c\u5730\u5740\u7ffb\u8bd1\u7684\u5168\u8fc7\u7a0b\u201d\uff0c\u662f\u5b66\u4e60\u6d41\u7a0b\u7684\u6a21\u677f\u3002</li> <li> <p>Sv39 \u9762\u5411 64 \u4f4d\u7cfb\u7edf\uff0c\u53ea\u5728 Sv32 \u7684\u57fa\u7840\u4e0a\u8bf4\u660e\u201c\u6709\u4f55\u4e0d\u540c\u201d\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>\u9875\u8868\u5c42\u7ea7\u4ece 2 \u7ea7\u53d8\u4e3a 3 \u7ea7\uff1b</li> <li>\u865a\u62df\u5730\u5740\u957f\u5ea6\u4ece 32 \u4f4d\u53d8\u4e3a 39 \u4f4d\uff1b</li> <li>\u9875\u8868\u9879\uff08PTE\uff09\u6269\u5c55\u4e3a 8 \u5b57\u8282\uff1b</li> <li>\u652f\u6301 2 MiB\u30011 GiB \u7684\u5927\u9875\uff08megapage/gigapage\uff09\u3002</li> </ul> </li> </ul> <p>\u9605\u8bfb\u8fc7\u7a0b\u4e2d\u753b\u56fe\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u4e60\u60ef\u3002\u4e0b\u9762\u8fd9\u4e9b\u56fe\u6765\u81ea RISC-V Sv32,Sv39 \u3092\u7406\u89e3\u3059\u308b\uff0c\u6709\u52a9\u4e8e\u540c\u5b66\u4eec\u7406\u89e3 Sv32/Sv39 \u7684\u5404\u79cd\u9875\u7c7b\u578b\u4e0e\u5730\u5740\u8f6c\u6362\u6d41\u7a0b\uff1a</p>      Sv32 \u5730\u5740\u8f6c\u6362\u4e0e 2MiB \u5927\u9875 RISC-V Sv32,Sv39 \u3092\u7406\u89e3\u3059\u308b          Sv39 \u5730\u5740\u8f6c\u6362\u4e0e 2MiB\u30011GiB \u5927\u9875 RISC-V Sv32,Sv39 \u3092\u7406\u89e3\u3059\u308b \u8981\u70b9\uff1aSv39 \u5206\u9875\u865a\u62df\u5185\u5b58\u7cfb\u7edf \u7c7b\u522b \u5173\u952e\u8981\u70b9 \u5730\u5740\u7ed3\u6784 Sv39 \u865a\u62df\u5730\u5740 39 \u4f4d\uff1aVPN[2:0] \u5404 9 \u4f4d\uff0c\u9875\u5185\u504f\u79fb 12 \u4f4d\u3002CPU \u8bbf\u95ee\u65f6\u68c0\u67e5\u7b26\u53f7\u6269\u5c55\uff1abit 63\u201339 \u5fc5\u987b\u4e0e bit 38 \u76f8\u540c\u3002 \u9875\u8868\u7ed3\u6784 \u4e09\u7ea7\u9875\u8868\uff0c\u6bcf\u5c42 512 \u9879\u3001\u6bcf\u9879 8 B\u3002\u9875\u8868\u9875\u5927\u5c0f 4 KiB\uff1b\u6839\u9875\u7269\u7406\u57fa\u5740\u5728 <code>satp.PPN</code>\u3002 \u9875\u8868\u9879\uff08PTE\uff09\u683c\u5f0f \u4f4e 10 \u4f4d\u542b V/R/W/X/U/G/A/D\uff1b\u5176\u4f59\u4e3a PPN\u3002R=0 \u4e14 W=1 \u975e\u6cd5\uff1bA/D \u7531\u786c\u4ef6\u5728\u8bbf\u95ee\u65f6\u66f4\u65b0\u3002 \u6811\u5f62\u7ed3\u6784 \u53f6\u5b50\u8868\u9879\uff1aR/W/X \u4efb\u4e00\u4e3a 1\u3002\u4e2d\u95f4\u8868\u9879\uff1aV=1 \u4e14 R/W/X=0\u3002 \u6743\u9650\u63a7\u5236 V\uff1a\u6709\u6548\u4f4d\u3002R/W/X\uff1a\u8bfb/\u5199/\u6267\u884c\u8bb8\u53ef\u3002U\uff1a\u7528\u6237\u53ef\u8bbf\u95ee\u3002G\uff1a\u5168\u5c40\u6620\u5c04\u3002A/D\uff1a\u8bbf\u95ee/\u4fee\u6539\u6807\u8bb0\u3002\u975e\u6cd5\u7ec4\u5408\u4f1a\u89e6\u53d1\u9875\u9519\u8bef\u3002 \u5730\u5740\u8f6c\u6362\u6d41\u7a0b \u81ea <code>satp.PPN</code> \u9010\u7ea7\u7d22\u5f15\uff1aVPN[2] \u2192 VPN[1] \u2192 VPN[0]\u3002\u9047\u53f6\u5b50\u5373\u505c\u6b62\uff1b\u65e0\u6548/\u8d8a\u6743/\u672a\u5bf9\u9f50\u89e6\u53d1\u9875\u9519\u8bef\u3002 \u5173\u952e\u5bc4\u5b58\u5668 <code>satp.MODE</code>=8\uff1aSv39\u3002<code>satp.ASID</code>\uff1a\u533a\u5206\u5730\u5740\u7a7a\u95f4\u3002 \u5173\u952e\u6307\u4ee4 <code>sfence.vma</code>\uff1a\u5237\u65b0 TLB\uff0c\u907f\u514d\u65e7\u6620\u5c04\u3002 \u8bbf\u5b58\u884c\u4e3a\u63a7\u5236 <code>sstatus.SUM</code>\uff1a\u5141\u8bb8\u5185\u6838\u8bbf\u95ee U=1 \u9875\u3002<code>sstatus.MXR</code>\uff1a\u5141\u8bb8\u4ece\u53ef\u6267\u884c\u9875\u8bfb\u3002"},{"location":"lab3/#\u5185\u5b58\u5c4f\u969c\u4e0e-tlb\u7f13\u5b58\u5237\u65b0","title":"\u5185\u5b58\u5c4f\u969c\u4e0e TLB\u3001\u7f13\u5b58\u5237\u65b0","text":"<p>\u521a\u624d\u9605\u8bfb\u7684\u7ae0\u8282\u672b\u5c3e\u6709\u8fd9\u4e48\u4e00\u6bb5\u8bdd\uff1a</p> <p>Note that writing satp does not imply any ordering constraints between page-table updates and subsequent address translations, nor does it imply any invalidation of address-translation caches. If the new address space\u2019s page tables have been modified, or if an ASID is reused, it may be necessary to execute an SFENCE.VMA instruction (see Section 12.2.1) after, or in some cases before, writing satp.</p> <p>\u672c\u8282\u5c31\u6765\u770b\u770b <code>sfence.vma</code>\u3002\u8bf7\u540c\u5b66\u4eec\u9605\u8bfb\u7279\u6743\u7ea7\u624b\u518c\u7684 12.2.1. Supervisor Memory-Management Fence Instruction \u4e00\u8282\u3002\u9605\u8bfb\u65f6\uff0c\u4f60\u9700\u8981\u56de\u5fc6\u300a\u8ba1\u7b97\u673a\u7ec4\u6210\u300b\u4e2d\u5b66\u4e60\u7684 TLB\u3001\u300a\u8ba1\u7b97\u673a\u4f53\u7cfb\u7ed3\u6784\u300b\u4e2d\u5b66\u4e60\u7684\u7f13\u5b58\u4e00\u81f4\u6027\u7b49\u76f8\u5173\u77e5\u8bc6\u3002</p> <p>\u5bfc\u8bfb\uff1a</p> <ul> <li> <p>The supervisor memory-management fence instruction SFENCE.VMA is used to synchronize updates to in-memory memory-management data structures with current execution. Instruction execution causes implicit reads and writes to these data structures; however, these implicit references are ordinarily not ordered with respect to explicit loads and stores.</p> <p>\u8fd9\u91cc\u7684 in-memory memory-management data structures \u6307\u7684\u5c31\u662f\u653e\u5728\u5185\u5b58\u4e2d\u7684\u9875\u8868\u3002</p> </li> <li> <p>The SFENCE.VMA is used to flush any local hardware caches related to address translation. It is specified as a fence rather than a TLB flush to provide cleaner semantics with respect to which instructions are affected by the flush operation and to support a wider variety of dynamic caching structures and memory-management schemes. SFENCE.VMA is also used by higher privilege levels to synchronize page table writes and the address translation hardware.</p> <p>\u8fd9\u91cc\u89e3\u91ca\u4e86 <code>sfence.vma</code> \u4e3a\u4ec0\u4e48\u88ab\u8bbe\u8ba1\u6210\u5185\u5b58\u5c4f\u969c\uff08fence\uff09\u800c\u4e0d\u662f\u7b80\u5355\u7684 TLB \u5237\u65b0\u6307\u4ee4\u3002\u300a\u8ba1\u7b97\u673a\u4f53\u7cfb\u7ed3\u6784\u300b\u8bfe\u4e0a\u6211\u4eec\u5b66\u4e60\u4e86 CPU \u5728 L1 \u4f1a\u6709 i Cache \u548c d Cache\uff0c\u8fd9\u540c\u6837\u6d89\u53ca\u865a\u62df\u5185\u5b58\u3002<code>sfence.vma</code> \u7684\u8bed\u4e49\u66f4\u5bbd\u6cdb\uff0c\u80fd\u591f\u6db5\u76d6\u6240\u6709\u4e0e\u5730\u5740\u8f6c\u6362\u76f8\u5173\u7684\u7f13\u5b58\u7ed3\u6784\u3002</p> </li> <li> <p>Changes to the sstatus fields SUM and MXR take effect immediately, without the need to execute an SFENCE.VMA instruction. Changing satp.MODE from Bare to other modes and vice versa also takes effect immediately, without the need to execute an SFENCE.VMA instruction. Likewise, changes to satp.ASID take effect immediately.</p> <p>\u8fd9\u91cc\u8bf4\u660e\u4e86\u9996\u6b21\u542f\u7528\u5206\u9875\u673a\u5236\u65f6\uff0c\u4e0d\u9700\u8981 <code>sfence.vma</code>\u3002\u4f46\u662f\uff0c\u5982\u679c\u9875\u8868\u53d1\u751f\u53d8\u5316\uff0c\u6216\u8005 ASID \u88ab\u91cd\u7528\uff0c\u5c31\u9700\u8981\u6267\u884c <code>sfence.vma</code>\u3002</p> </li> <li> <p>\u8be5\u8282\u5269\u4f59\u7684\u90e8\u5206\u6d89\u53ca\u300a\u8ba1\u7b97\u673a\u4f53\u7cfb\u7ed3\u6784\u300b\u4e2d\u7684\u5185\u5b58\u4e00\u81f4\u6027\u6a21\u578b\uff08RVWMO\uff0c\u5bf9\u5e94\u4f53\u7cfb\u7ed3\u6784\u8bfe\u4e0a\u5b66\u4e60\u7684 Weak Ordering\uff09\u3002\u5185\u5b58\u4e00\u81f4\u6027\u5728\u4f53\u7cfb\u7ed3\u6784\u4e2d\u4e5f\u7b97\u6bd4\u8f83\u96be\u7684\u5185\u5bb9\uff0c\u8fd9\u91cc\u5c31\u4e0d\u5c55\u5f00\u4e86\u3002\u611f\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u81ea\u884c\u9605\u8bfb\uff0c\u5728\u62a5\u544a\u4e2d\u8bb2\u8bb2\u4f60\u8bfb\u5b8c\u540e\u89c9\u5f97 <code>sfence.vma</code> \u6709\u4ec0\u4e48\u6709\u610f\u601d\u7684\u5730\u65b9\u3002\u8fd9\u91cc\u63d0\u4f9b\u4e00\u7bc7\u53c2\u8003\u8d44\u6599\uff1a\u7ec6\u8bf4 RVWMO\uff1aRISC-V \u6307\u4ee4\u96c6\u624b\u518c Appendix A\uff08\u4e00\uff09 - \u77e5\u4e4e\u3002</p> <p></p>      \u5185\u5b58\u4e00\u81f4\u6027\u6a21\u578b\u6982\u89c8 \u56fe\u7247\u6765\u6e90\uff1a\u300a\u8ba1\u7b97\u673a\u4f53\u7cfb\u7ed3\u6784\u300b\u8bfe\u7a0b PPT      <p></p> </li> </ul>"},{"location":"lab3/#\u5185\u6838\u5185\u5b58\u5e03\u5c40","title":"\u5185\u6838\u5185\u5b58\u5e03\u5c40","text":"<p>RISC-V \u67b6\u6784\u4e0b\u7684 Linux \u5185\u6838\u7684\u5185\u5b58\u5e03\u5c40\u89c1 Virtual Memory Layout on RISC-V Linux \u2014 The Linux Kernel documentation\u3002\u6211\u4eec\u91c7\u53d6\u7b80\u5316\u7684\u6a21\u578b\u3002</p> <ul> <li> <p>\u5185\u6838\u4e0e\u7528\u6237\u7a7a\u95f4\uff1a</p> <p>\u540c\u5b66\u4eec\u5df2\u7ecf\u4e86\u89e3\u5230\uff0cSv39 \u5206\u9875\u5f0f\u865a\u62df\u5185\u5b58\u7cfb\u7edf\u4e2d\uff0c64b \u7684\u865a\u62df\u5730\u5740\u5b9e\u9645\u6709\u6548\u7684\u53ea\u6709 39b\uff0c\u5176\u4f59\u9ad8\u4f4d\u5fc5\u987b\u4e0e bit 38 \u4fdd\u6301\u7b26\u53f7\u6269\u5c55\u4e00\u81f4\u3002\u8fd9\u610f\u5473\u7740\u6574\u4e2a \\(2^{64}\\text{B}\\) \u7684\u5730\u5740\u7a7a\u95f4\u88ab\u5212\u5206\u4e3a\u4e24\u4e2a\u5bf9\u79f0\u7684\u533a\u57df\uff1a</p> <ul> <li>\u7528\u6237\u7a7a\u95f4\uff1a<code>0x0000000000000000</code> ~ <code>0x0000003fffffffff</code>\uff08\u4f4e\u5730\u5740\u534a\u533a\uff09</li> <li>\u65e0\u6548\u5730\u5740\uff1a\u591a\u8fbe 16M TB\u3002</li> <li>\u5185\u6838\u7a7a\u95f4\uff1a<code>0xffffffc000000000</code> ~ <code>0xffffffffffffffff</code>\uff08\u9ad8\u5730\u5740\u534a\u533a\uff09</li> </ul> <p>\u5728\u672c\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u53ea\u5b9e\u73b0\u5185\u6838\u7a7a\u95f4\u7684\u6620\u5c04\uff0c\u7528\u6237\u7a7a\u95f4\u7684\u6620\u5c04\u5c06\u5728 Lab4 \u5b9e\u73b0\u3002</p> </li> <li> <p>\u5185\u6838\u7a7a\u95f4\uff1a</p> <p>Linux \u7684\u5185\u6838\u7a7a\u95f4\u5e03\u5c40\u8f83\u4e3a\u590d\u6742\uff0c\u5305\u542b\u8bbe\u5907 I/O\u3001\u5185\u6838\u5806\u6808\u7b49\u533a\u57df\uff0c\u6211\u4eec\u5168\u90e8\u5f03\u7528\u3002\u672c\u5b9e\u9a8c\u53ea\u5b9e\u73b0\u76f4\u63a5\u6620\u5c04\uff0c\u4e5f\u5c31\u662f\u5c06 Lab2 \u4e2d\u4ecb\u7ecd\u7684\u4ece <code>0x80000000</code> \u5f00\u59cb\u7684\u7269\u7406\u5185\u5b58\u5168\u90e8\u6620\u5c04\u5230 <code>0xffffffd600000000</code> \u5f00\u59cb\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u3002</p> </li> </ul>"},{"location":"lab3/#\u91cd\u5b9a\u4f4d","title":"\u91cd\u5b9a\u4f4d","text":"<p>\u5185\u6838\u542f\u52a8\u521d\u671f\u8fd0\u884c\u5728\u7269\u7406\u5730\u5740\u4e0a\uff0c\u5b83\u8981\u600e\u4e48\u5207\u6362\u5230\u865a\u62df\u5730\u5740\u7a7a\u95f4\u5462\uff1f</p> <p>\u6700\u91cd\u8981\u7684\u95ee\u9898\u662f PC \u8981\u4ece\u7269\u7406\u5730\u5740\u8df3\u8f6c\u5230\u865a\u62df\u5730\u5740\u3002\u56de\u5fc6\u76ee\u524d\u4e3a\u6b62\u5b66\u4e60\u7684\u6240\u6709 RISC-V \u77e5\u8bc6\uff0c\u6709\u54ea\u4e9b\u5730\u65b9\u53ef\u4ee5\u4fee\u6539 PC\uff1f</p> <ul> <li>\u8df3\u8f6c\uff1a<code>jal</code>\u3001<code>jalr</code>\u3001<code>ret</code> \u6307\u4ee4\uff08\u672c\u8d28\u4e0a\u662f <code>jalr</code>\uff09</li> <li>Trap\uff1a\u9677\u5165\u3001xRET \u8fd4\u56de</li> </ul> <p>Linux \u9009\u62e9\u4e86\u901a\u8fc7 Trap \u5b9e\u73b0\uff0c\u7559\u7ed9\u540c\u5b66\u4eec\u63a2\u7a76\u3002\u8fd9\u91cc\u4ecb\u7ecd\u4e00\u4e0b\u901a\u8fc7\u8df3\u8f6c\u5b9e\u73b0\u91cd\u5b9a\u4f4d\u7684\u601d\u8def\uff1a</p> <ul> <li>\u5199\u4e00\u4e2a\u6c47\u7f16\u51fd\u6570 <code>relocate()</code></li> <li>\u5728\u5176\u4e2d\u7ed9\u67d0\u4e9b\u5bc4\u5b58\u5668\u52a0\u4e0a\u504f\u79fb\u91cf <code>PA2VA_OFFSET</code></li> <li><code>ret</code> \u8fd4\u56de\uff0cPC \u548c\u67d0\u4e9b\u5bc4\u5b58\u5668\u5c31\u5b8c\u6210\u4e86\u91cd\u5b9a\u4f4d\uff0c\u5207\u6362\u5230\u4e86\u865a\u62df\u5730\u5740</li> <li>\u56e0\u4e3a\u51fd\u6570\u3001\u5168\u5c40\u53d8\u91cf\u90fd\u662f PC \u76f8\u5bf9\u5bfb\u5740\u7684\uff0c\u6240\u4ee5\u6574\u4e2a\u5185\u6838\u955c\u50cf\u90fd\u5b8c\u6210\u4e86\u91cd\u5b9a\u4f4d</li> </ul> <p>\u8fd9\u91cc\u7684\u67d0\u4e9b\u5bc4\u5b58\u5668\u8bf7\u540c\u5b66\u4eec\u81ea\u5df1\u601d\u8003\u3002</p> <p>\u52a8\u624b\u505a\uff1a\u4e2d\u65ad\u5b9e\u73b0\u91cd\u5b9a\u4f4d</p> <p>\u9605\u8bfb Linux \u5185\u6838\u6e90\u7801 <code>arch/riscv/kernel/head.S</code> \u7684 <code>relocate_enable_mmu()</code> \u51fd\u6570\uff0c\u89e3\u91ca\u5b83\u662f\u600e\u4e48\u5b9e\u73b0\u91cd\u5b9a\u4f4d\u7684\u3002</p> <p>\u5b8c\u6210 Task 1 \u540e\uff0c\u8bf7\u4f60\u5206\u6790\u8fd9\u4e24\u79cd\u91cd\u5b9a\u4f4d\u65b9\u5f0f\u662f\u5426\u90fd\u9700\u8981\u6052\u7b49\u6620\u5c04\uff1f\u4e3a\u4ec0\u4e48\uff1f</p>"},{"location":"lab3/#task-1\u5927\u9875\u8868\u53cc\u91cd\u6620\u5c04\u548c\u91cd\u5b9a\u4f4d","title":"Task 1\uff1a\u5927\u9875\u8868\u53cc\u91cd\u6620\u5c04\u548c\u91cd\u5b9a\u4f4d","text":"<p>\u672f\u8bed\uff1a\u6620\u5c04</p> <p>\u6620\u5c04\uff08mapping\uff09\uff1a\u5c06\u865a\u62df\u5730\u5740\u7a7a\u95f4\u7684\u4e00\u6bb5\u8fde\u7eed\u533a\u57df\u5bf9\u5e94\u5230\u7269\u7406\u5730\u5740\u7a7a\u95f4\u7684\u4e00\u6bb5\u8fde\u7eed\u533a\u57df\u7684\u8fc7\u7a0b\u3002</p> <p>\u5728 RISC-V \u4e2d\uff0c\u6620\u5c04\u662f\u901a\u8fc7\u9875\u8868\u5b9e\u73b0\u7684\u3002\u9875\u8868\u5c06\u865a\u62df\u5730\u5740\u8f6c\u6362\u4e3a\u7269\u7406\u5730\u5740\uff0c\u5e76\u63d0\u4f9b\u6743\u9650\u63a7\u5236\u3002</p> <p>\u6240\u4ee5\uff0c\u5f53\u6211\u4eec\u8bf4\u201c\u5efa\u7acb\u6620\u5c04\u201d\u65f6\uff0c\u5b9e\u9645\u4e0a\u662f\u6307\u5728\u9875\u8868\u4e2d\u521b\u5efa\u76f8\u5e94\u7684\u9875\u8868\u9879\uff08PTE\uff09\uff0c\u4ee5\u5b9e\u73b0\u865a\u62df\u5730\u5740\u5230\u7269\u7406\u5730\u5740\u7684\u8f6c\u6362\u3002</p> <p><code>setup_vm()</code> \u7528\u4e8e\u6784\u9020\u5185\u6838\u542f\u52a8\u521d\u671f\u7684\u9875\u8868 <code>early_pg_dir</code>\u3002\u8fd9\u662f\u4e00\u4e2a\u4ec5\u6709 Gigapage \u7684 Sv39 \u9875\u8868\uff0c\u5176\u4e2d\u5305\u542b\u4e24\u4e2a\u6620\u5c04\u5173\u7cfb\uff1a</p> <ul> <li>\u6620\u5c04\u5927\u5c0f\uff1a\u7269\u7406\u5185\u5b58\u6709\u591a\u5c11\uff0c\u5c31\u6620\u5c04\u591a\u5927\u3002QEMU \u9ed8\u8ba4\u5206\u914d 128 MiB \u5185\u5b58\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>-m</code> \u53c2\u6570\u8c03\u6574\u3002\u4e0b\u6587\u4ee5 128 MiB \u4e3a\u4f8b\u3002</li> <li>\u6052\u7b49\u6620\u5c04\uff1a\u865a\u62df\u5730\u5740 <code>0x80000000~0x88000000</code> \u6620\u5c04\u5230\u7269\u7406\u5730\u5740 <code>0x80000000~0x88000000</code>\u3002</li> <li>\u5185\u6838\u6620\u5c04\uff1a\u865a\u62df\u5730\u5740 <code>0xffffffd600000000~0xffffffd600800000</code> \u6620\u5c04\u5230\u7269\u7406\u5730\u5740 <code>0x80000000~0x88000000</code>\u3002</li> </ul>      early_pg_dir \u7684\u6620\u5c04\u5173\u7cfb\u793a\u610f\u56fe      <p>\u4f60\u7684\u4efb\u52a1\u662f\uff1a</p> <ul> <li> <p>\u5728 <code>setup_vm()</code> \u4e2d\uff0c\u5b8c\u6210\u5bf9 <code>early_pg_dir</code> \u7684\u521d\u59cb\u5316\uff0c\u5efa\u7acb\u5305\u542b\u4e0a\u8ff0\u6620\u5c04\u5173\u7cfb\u7684\u5927\u9875\u8868\u3002\u9875\u8868\u9879\u7684\u5404\u4e2a\u4f4d\u5e94\u5f53\u6839\u636e\u5b58\u653e\u7684\u5185\u5bb9\u548c\u6807\u51c6\u7684\u8981\u6c42\u8bbe\u7f6e\u3002</p> <p>\u8be5\u51fd\u6570\u7684\u8fd4\u56de\u503c\u662f\u5f85\u5199\u5165 <code>satp</code> \u5bc4\u5b58\u5668\u7684\u503c\uff0c\u4e5f\u5c31\u662f\u8bf4\u5b83\u53ef\u4ee5\u8fd9\u4e48\u7528\uff1a</p> <pre><code>call setup_vm\ncsrw satp, a0\n</code></pre> <p>\u9009\u62e9\u8ba9 <code>setup_vm()</code> \u8fd4\u56de <code>satp</code> \u503c\uff0c\u662f\u56e0\u4e3a\u5728 C \u8bed\u8a00\u4e2d\u7528\u8fd0\u7b97\u7b26\u6784\u9020 <code>satp</code> \u7684\u503c\u4f1a\u6bd4\u5199\u6c47\u7f16\u66f4\u65b9\u4fbf\u4e00\u4e9b\u3002\u8bf7\u540c\u5b66\u4eec\u5584\u7528\u5934\u6587\u4ef6\u4e2d\u63d0\u4f9b\u7684\u5b8f \ud83d\ude09\u3002</p> </li> <li> <p>\u5728 <code>head.S</code> \u4e2d\uff0c\u8c03\u7528 <code>setup_vm()</code>\uff0c\u7136\u540e\u7528\u6c47\u7f16\u5f00\u542f Sv39 \u5206\u9875\u865a\u62df\u5185\u5b58\u3002</p> </li> <li>\u5728 <code>head.S</code> \u4e2d\u5b9e\u73b0 <code>relocate()</code> \u6c47\u7f16\u51fd\u6570\uff0c\u5b8c\u6210\u91cd\u5b9a\u4f4d\u3002\u5177\u4f53\u5b9e\u73b0\u65b9\u5f0f\u81ea\u7531\u9009\u62e9\uff0c\u8df3\u8f6c\u6216\u6a21\u4eff Linux \u7684 Trap \u65b9\u5f0f\u90fd\u884c\u3002</li> </ul> <p>\u4f60\u9700\u8981\u60f3\u6e05\u695a\u4e0b\u5217\u95ee\u9898\uff1a</p> <ul> <li>\u8981\u6620\u5c04\u7684\u533a\u57df\u5927\u5c0f\u662f\u591a\u5c11\uff1fGigapage \u5927\u9875\u7684\u5927\u5c0f\u662f\u591a\u5c11\uff1f\u4f60\u9700\u8981\u521b\u5efa\u591a\u5c11\u4e2a\u9875\u8868\u9879\uff1f</li> </ul> <p>\u5b8c\u6210\u6761\u4ef6</p> <ul> <li>\u5f00\u542f\u865a\u62df\u5185\u5b58\u540e\u6ca1\u6709\u5f02\u5e38\uff0c\u5185\u6838\u548c Lab2 \u4e00\u6837\u6b63\u5e38\u8fd0\u884c</li> <li> <p>\u5199\u5165 SATP \u5bc4\u5b58\u5668\u540e\uff0cQEMU Monitor \u80fd\u591f\u6b63\u786e\u6267\u884c\u4e0b\u9762\u7684\u6307\u4ee4\uff1a</p> <pre><code>(qemu) gva2gpa 0x80000000\ngpa: 0x80000000\n(qemu) gva2gpa 0xffffffd600000000\ngpa: 0x80000000\n</code></pre> </li> <li> <p>\u901a\u8fc7 Lab3 Task1 \u6d4b\u8bd5</p> </li> </ul>"},{"location":"lab3/#task-2\u591a\u7ea7\u9875\u8868","title":"Task 2\uff1a\u591a\u7ea7\u9875\u8868","text":"<p>\u521a\u624d\u5b9e\u73b0\u7684\u9875\u8868\u6bd4\u8f83\u7c97\u66b4\uff1a</p> <ul> <li>\u7528 Gigapage \u7c97\u7c92\u5ea6\u5730\u6620\u5c04\u4e86\u6574\u7247\u7a7a\u95f4</li> <li>\u6ca1\u6709\u5b8c\u5168\u5207\u6362\u5230\u865a\u62df\u5730\u5740\u7a7a\u95f4\uff0c\u4ecd\u80fd\u901a\u8fc7\u6052\u7b49\u6620\u5c04\u8bbf\u95ee\u7269\u7406\u5730\u5740</li> </ul> <p>\u4f46\u901a\u8fc7\u521a\u624d\u7684\u7b80\u5355\u9875\u8868\uff0c\u6211\u4eec\u6210\u529f\u5207\u6362\u5230\u4e86\u865a\u62df\u5730\u5740\u7a7a\u95f4\uff0c\u73b0\u5728 Buddy System \u8fd4\u56de\u7684\u5185\u5b58\u5c31\u90fd\u662f\u865a\u62df\u5730\u5740\u4e86\u3002\u6709\u4e86 Buddy System \u7684\u652f\u6301\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u6784\u9020\u66f4\u7cbe\u7ec6\u7684\u591a\u7ea7\u9875\u8868\u6620\u5c04\u4e86\u3002</p> <p>\u4f60\u7684\u4efb\u52a1\u662f\uff1a</p> <ul> <li> <p>\u8865\u5168 <code>setup_vm_final()</code></p> <p>\u8be5\u51fd\u6570\u6784\u9020 Sv39 \u4e09\u7ea7\u9875\u8868 <code>swapper_pg_dir</code>\uff0c\u5e76\u8fd4\u56de\u5f85\u5199\u5165 <code>satp</code> \u5bc4\u5b58\u5668\u7684\u503c\u3002</p> <p>\u8be5\u9875\u8868\u9700\u8981\u4e3a <code>vmlinux.lds</code> \u4e2d\u5b9a\u4e49\u7684\u5404\u4e2a\u6bb5\u5efa\u7acb\u6620\u5c04\u5173\u7cfb\uff0c\u9875\u8868\u9879\u7684\u5404\u4e2a\u4f4d\u5e94\u5f53\u6839\u636e\u5b58\u653e\u7684\u5185\u5bb9\u548c\u6807\u51c6\u7684\u8981\u6c42\u8bbe\u7f6e\u3002</p> <ul> <li><code>.text</code>\uff1a\u4ee3\u7801</li> <li><code>.rodata</code>\uff1a\u53ea\u8bfb\u6570\u636e</li> <li><code>.data</code>\u3001<code>.bss</code> \u548c\u5269\u4f59\u7684\u6240\u6709\u7269\u7406\u5185\u5b58\uff1a\u8bfb\u5199\u6570\u636e</li> </ul> <p>\u6ce8\u610f\u6700\u540e\u4e00\u6bb5\u6620\u5c04\u8981\u5305\u62ec\u5269\u4f59\u7684\u6240\u6709\u7269\u7406\u5185\u5b58\uff0c\u5b83\u4eec\u8981\u7ed9 Buddy System \u4f7f\u7528\u3002</p> <p>\u8981\u6c42\u8be5\u51fd\u6570\u8c03\u7528 <code>create_mapping()</code> \u6765\u5b8c\u6210\u5177\u4f53\u7684\u6620\u5c04\u5de5\u4f5c\u3002</p> </li> <li> <p>\u8865\u5168 <code>create_mapping()</code></p> <p>\u8be5\u51fd\u6570\u8d1f\u8d23\u5728\u7ed9\u5b9a\u7684\u9875\u8868\u4e2d\uff0c\u5efa\u7acb\u4ece <code>pa</code> \u5230 <code>va</code> \u7684\u6620\u5c04\uff0c\u957f\u5ea6\u4e3a <code>size</code> \u5b57\u8282\uff0c\u6743\u9650\u4e3a <code>perm</code>\u3002</p> <p>\u8be5\u51fd\u6570\u6709\u975e\u5e38\u591a\u79cd\u5b9e\u73b0\u65b9\u6cd5\uff1a</p> <ul> <li>\u5355\u5c42\u5faa\u73af</li> <li>\u591a\u5c42\u5faa\u73af</li> <li>\u9012\u5f52</li> </ul> <p>\u8bf7\u81ea\u7531\u53d1\u6325\u3002</p> </li> <li> <p>\u5728 <code>head.S</code> \u4e2d\uff0c\u8c03\u7528 <code>setup_vm_final()</code>\uff0c\u7136\u540e\u7528\u6c47\u7f16\u5207\u6362\u5230\u6700\u7ec8\u7684\u9875\u8868 <code>swapper_pg_dir</code>\u3002</p> </li> </ul> <p>\u5b8c\u6210\u6761\u4ef6</p> <ul> <li>\u5f00\u542f\u865a\u62df\u5185\u5b58\u540e\u6ca1\u6709\u5f02\u5e38\uff0c\u5185\u6838\u548c Lab2 \u4e00\u6837\u6b63\u5e38\u8fd0\u884c</li> <li> <p>\u5199\u5165 SATP \u5bc4\u5b58\u5668\u540e\uff0cQEMU Monitor \u80fd\u591f\u6b63\u786e\u6267\u884c\u4e0b\u9762\u7684\u6307\u4ee4\uff1a</p> <pre><code>(qemu) gva2gpa 0xffffffd600200000\ngpa: 0x80200000\n</code></pre> </li> <li> <p>\u901a\u8fc7 Lab3 Task2 \u6d4b\u8bd5\u3002</p> </li> </ul>"},{"location":"lab3/#\u6269\u5c55\u9605\u8bfbqemu-\u7684-tlb-\u5b9e\u73b0","title":"\u6269\u5c55\u9605\u8bfb\uff1aQEMU \u7684 TLB \u5b9e\u73b0","text":"<p>\u672c\u8282\u6211\u4eec\u7814\u7a76\u4e00\u4e2a\u95ee\u9898\uff1a\u4fee\u6539 <code>satp</code> \u5bc4\u5b58\u5668\u548c <code>sfence.vma</code> \u8fd9\u4e24\u4e2a\u64cd\u4f5c\u7684\u5148\u540e\u987a\u5e8f\u5e94\u8be5\u662f\u600e\u6837\u7684\uff1f</p> <p>\u6211\u4eec\u77e5\u9053 <code>sfence.vma</code> \u7684\u4e00\u5927\u4f5c\u7528\u662f\u5237\u65b0 TLB \u548c\u7f13\u5b58\uff0c\u4ee5\u907f\u514d\u4f7f\u7528\u65e7\u7684\u5730\u5740\u6620\u5c04\uff0c\u5e94\u8be5\u5728\u5199\u5165 <code>satp</code> \u4e4b\u540e\u6267\u884c\u3002\u4f46\u662f\u5982\u679c\u53bb\u770b Linux \u7684 <code>arch/riscv/kernel/head.S</code>\uff0c\u4f1a\u53d1\u73b0\u5b83\u662f\u5728\u5199\u5165 <code>satp</code> \u4e4b\u524d\u6267\u884c\u7684\uff1a</p> arch/riscv/kernel/head.S<pre><code>    /*\n     * Load trampoline page directory, which will cause us to trap to\n     * stvec if VA != PA, or simply fall through if VA == PA.  We need a\n     * full fence here because setup_vm() just wrote these PTEs and we need\n     * to ensure the new translations are in use.\n     */\n    sfence.vma\n    csrw CSR_SATP, a0\n</code></pre> <p>\u8fd9\u662f\u56e0\u4e3a Linux \u91c7\u7528 Trap \u7684\u65b9\u5f0f\u5b8c\u6210\u91cd\u5b9a\u4f4d\u3002\u7406\u7531\u5df2\u7ecf\u5728\u6ce8\u91ca\u4e2d\u8bf4\u660e\u4e86\uff0c\u8fd9\u91cc\u4e3b\u8981\u662f\u7528\u5b83\u7684\u5185\u5b58\u5c4f\u969c\uff08fence\uff09\u8bed\u4e49\uff0c\u786e\u4fdd\u5728\u5199\u5165 <code>satp</code> \u4e4b\u540e\u786c\u4ef6\u80fd\u7acb\u523b\u770b\u5230\u5185\u5b58\u4e2d\u7684\u9875\u8868\uff0c\u4ece\u800c\u7acb\u523b\u89e6\u53d1 Trap \u8df3\u8f6c\u5230\u91cd\u5b9a\u4f4d\u4ee3\u7801\u3002\u800c\u5237\u65b0 TLB \u548c\u7f13\u5b58\u5e76\u4e0d\u662f\u4e3b\u8981\u76ee\u7684\uff0c\u56e0\u4e3a\u8fd9\u91cc\u662f\u7b2c\u4e00\u6b21\u5f00\u542f MMU\uff0c\u524d\u6587\u5f15\u7528\u7684 RISC-V \u89c4\u8303\u5df2\u7ecf\u8bf4\u660e\u4e86\u8fd9\u79cd\u60c5\u51b5\uff08Bare \u5230\u5176\u4ed6\u6a21\u5f0f\uff09\u4e0d\u9700\u8981 <code>sfence.vma</code>\u3002</p> <p>\u9664\u53bb\u8fd9\u4e00\u7279\u6b8a\u60c5\u51b5\uff0c\u4e00\u822c <code>sfence.vma</code> \u90fd\u4f1a\u653e\u7f6e\u5728 <code>satp</code> \u5199\u5165\u4e4b\u540e\u3002SFENCE.VMA Before or After SATP Write \u00b7 Issue #226 \u00b7 riscv/riscv-isa-manual \u5bf9\u6b64\u8fdb\u884c\u4e86\u8ba8\u8bba\uff1a</p> <ul> <li>SFENCE before SATP may be necessary: The concern is, what if the mapping for the instruction immediately after SFENCE.VMA has been modified? In the Linux kernel, this mapping is fixed (regardless of address space) so the concern does not apply.</li> <li>SFENCE after SATP write is definitely necessary, though. In general, you need to SFENCE after you\u2019ve recycled an ASID. Since we don\u2019t use ASIDs in the Linux kernel yet, every context switch is effectively an ASID reuse, hence the full TLB flush.</li> </ul> <p>\u559c\u6b22\u52a8\u624b\u7684\u540c\u5b66\u53ef\u80fd\u8fd8\u4f1a\u5c1d\u8bd5\u5220\u53bb <code>sfence.vma</code>\uff0c\u7ed3\u679c\u53d1\u73b0\u5185\u6838\u4f9d\u7136\u80fd\u6b63\u5e38\u8fd0\u884c\u3002\u96be\u9053 QEMU \u6ca1\u6709\u5b9e\u73b0 TLB\uff1f\u6211\u4eec\u53ef\u4ee5\u8bbe\u8ba1\u4e00\u4e2a\u5c0f\u5b9e\u9a8c\u9a8c\u8bc1\u4e00\u4e0b\uff1a</p> <pre><code>// create old TLB entry\nasm volatile(\"li t0, 0x80200000\");\nasm volatile(\"ld t1, 0(t0)\");\n// set satp with swapper_pg_dir\nasm volatile(\"csrw satp, %0\" :: \"r\"(new_satp_value));\n// try to hit old TLB entry\nasm volatile(\"li t0, 0x80200000\");\nasm volatile(\"ld t1, 0(t0)\");\n</code></pre> <p>\u5982\u679c QEMU \u5b9e\u73b0\u4e86 TLB\uff0c\u90a3\u4e48\u7b2c\u4e8c\u6b21 <code>ld</code> \u6307\u4ee4\u5e94\u8be5\u4f1a\u547d\u4e2d\u65e7\u7684 TLB \u6761\u76ee\u3002\u4f46\u8fd9\u6761\u6307\u4ee4\u89e6\u53d1\u4e86 page fault\uff0c\u8bf4\u660e\u6ca1\u6709\u547d\u4e2d TLB\u3002</p> <p>QEMU \u662f\u5f00\u6e90\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u8bfb\u6e90\u7801\u4e00\u63a2\u7a76\u7adf\u3002qemu tlb \u5b9e\u73b0\u5206\u6790 | Sherlock's blog \u662f\u4e00\u7bc7\u5f88\u597d\u7684\u535a\u5ba2\uff08\u4f5c\u8005\u8fd8\u5199\u4e86 QEMU \u7684\u5176\u4ed6\u90e8\u5206\u5206\u6790\uff09\uff0c\u867d\u7136\u76f8\u5e94\u7684\u6e90\u7801\u7248\u672c\u4e3a v5.0\uff0c\u4f46\u6574\u4f53\u601d\u8def\u6ca1\u6709\u592a\u5927\u53d8\u5316\u3002\u6211\u4eec\u627e\u5230 QEMU \u5904\u7406 <code>satp</code> \u5199\u5165\u90e8\u5206\u7684\u4ee3\u7801\uff1a</p> target/riscv/csr.c<pre><code>static target_ulong legalize_xatp(CPURISCVState *env, target_ulong old_xatp,\n                                  target_ulong val)\n{\n    target_ulong mask;\n    bool vm;\n    if (riscv_cpu_mxl(env) == MXL_RV32) {\n        vm = validate_vm(env, get_field(val, SATP32_MODE));\n        mask = (val ^ old_xatp) &amp; (SATP32_MODE | SATP32_ASID | SATP32_PPN);\n    } else {\n        vm = validate_vm(env, get_field(val, SATP64_MODE));\n        mask = (val ^ old_xatp) &amp; (SATP64_MODE | SATP64_ASID | SATP64_PPN);\n    }\n\n    if (vm &amp;&amp; mask) {\n        /*\n         * The ISA defines SATP.MODE=Bare as \"no translation\", but we still\n         * pass these through QEMU's TLB emulation as it improves\n         * performance.  Flushing the TLB on SATP writes with paging\n         * enabled avoids leaking those invalid cached mappings.\n         */\n        tlb_flush(env_cpu(env));\n        return val;\n    }\n    return old_xatp;\n}\n</code></pre> <p>QEMU \u5148\u9a8c\u8bc1\u5f85\u5199\u5165\u7684\u503c\u7684\u5408\u6cd5\u6027\uff0c\u5982\u679c\u5408\u6cd5\uff0c\u4e14\u548c\u65e7\u503c\u4e0d\u540c\uff0c\u90a3\u4e48\u5c31\u8c03\u7528 <code>tlb_flush()</code> \u5237\u65b0 TLB\u3002\u6e90\u7801\u6ce8\u91ca\u8bf4\u660e\u8fd9\u662f\u4e3a\u4e86\u907f\u514d\u6cc4\u6f0f\u65e7\u7684\u6620\u5c04\u3002\u7136\u800c\u5728\u771f\u5b9e\u7684\u786c\u4ef6\u5b9e\u73b0\u4e2d\uff0c\u5e76\u4e0d\u4f1a\u6709\u8fd9\u4e00\u4fdd\u8bc1\uff0c\u6240\u4ee5\u6211\u4eec\u5728\u5b9e\u9a8c\u4e2d\u4ecd\u7136\u9700\u8981 <code>sfence.vma</code>\u3002</p>"},{"location":"lab4/","title":"Lab 4\uff1a\u7528\u6237\u6001","text":""},{"location":"lab4/#lab-4\u7528\u6237\u6001","title":"Lab 4\uff1a\u7528\u6237\u6001","text":"<p>DDL</p> <p>\u672c\u5b9e\u9a8c\u5c1a\u672a\u53d1\u5e03\u3002</p>"},{"location":"lab4/#\u5b9e\u9a8c\u7b80\u4ecb","title":"\u5b9e\u9a8c\u7b80\u4ecb","text":"<p>\u7ecf\u8fc7 Lab2\uff08\u8c03\u5ea6\uff09\u548c Lab3\uff08\u865a\u62df\u5185\u5b58\uff09\u7684\u94fa\u57ab\uff0c\u6211\u4eec\u7684\u5185\u6838\u5df2\u7ecf\u5177\u5907\u4e86\u591a\u4efb\u52a1\u548c\u5730\u5740\u7a7a\u95f4\u9694\u79bb\u7684\u57fa\u672c\u80fd\u529b\u3002\u73b0\u5728\uff0c\u662f\u65f6\u5019\u8ba9\u6211\u4eec\u7684\u64cd\u4f5c\u7cfb\u7edf\u8fc8\u51fa\u5173\u952e\u4e00\u6b65 \u2014\u2014 \u8fd0\u884c\u771f\u6b63\u7684\u7528\u6237\u6001\u7a0b\u5e8f\u3002</p> <p>\u7136\u800c\u5b9e\u73b0\u7528\u6237\u6001\u5e76\u4e0d\u5bb9\u6613\uff0c\u672c\u6b21\u5b9e\u9a8c\u7684\u5185\u5bb9\u91cf\u8f83\u5927\uff0c\u8bf7\u540c\u5b66\u4eec\u5408\u7406\u5b89\u6392\u65f6\u95f4\u3002\u6211\u4eec\u9700\u8981\u89e3\u51b3\u4e0b\u5217\u95ee\u9898\uff1a</p> <ul> <li> <p>\u5982\u4f55\u8fd0\u884c\u7528\u6237\u6001\u7a0b\u5e8f\uff1f</p> <p>\u5728 Lab1 \u5b66\u4e60\u94fe\u63a5\u5668\u811a\u672c\u65f6\uff0c\u6211\u4eec\u77e5\u9053\u666e\u901a\u5e94\u7528\u7a0b\u5e8f\u662f ELF \u683c\u5f0f\u7684\u53ef\u6267\u884c\u6587\u4ef6\u3002\u6240\u4ee5\u6211\u4eec\u8981\u5199\u4e00\u4e2a ELF \u52a0\u8f7d\u5668\uff0c\u89e3\u6790 ELF \u6587\u4ef6\uff0c\u5e76\u5c06\u5176\u52a0\u8f7d\u5230\u7528\u6237\u6001\u8fdb\u7a0b\u7684\u5730\u5740\u7a7a\u95f4\u4e2d\u3002</p> <p>\u65e2\u7136\u8981\u52a0\u8f7d\u5230\u7528\u6237\u6001\u8fdb\u7a0b\u7684\u5730\u5740\u7a7a\u95f4\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u8bbe\u8ba1\u7528\u6237\u6001\u7a0b\u5e8f\u7684\u5185\u5b58\u5e03\u5c40\uff0c\u5305\u62ec\u4ee3\u7801\u6bb5\u3001\u6570\u636e\u6bb5\u3001\u5806\u6808\u7b49\u3002</p> </li> <li> <p>\u7528\u6237\u6001\u7a0b\u5e8f\u5982\u4f55\u8c03\u7528\u5185\u6838\u670d\u52a1\uff1f</p> <p>\u5728\u7406\u8bba\u8bfe\u4e0a\u6211\u4eec\u5b66\u4e60\u4e86\u7cfb\u7edf\u8c03\u7528\u7684\u6982\u5ff5\u3002\u7528\u6237\u6001\u7a0b\u5e8f\u4e0d\u80fd\u76f4\u63a5\u8fdb\u884c\u548c\u654f\u611f\u8d44\u6e90\uff08\u5982\u786c\u4ef6\u8bbe\u5907\u3001\u5185\u5b58\u7ba1\u7406\u5355\u5143\u7b49\uff09\u76f8\u5173\u7684\u64cd\u4f5c\uff0c\u800c\u662f\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528\u8bf7\u6c42\u5185\u6838\u4ee3\u4e3a\u6267\u884c\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u9700\u8981\u8fdb\u4e00\u6b65\u589e\u5f3a <code>trap_handler()</code>\uff0c\u5b9e\u73b0\u7cfb\u7edf\u8c03\u7528\u673a\u5236\uff0c\u5904\u7406\u6765\u81ea\u7528\u6237\u6001\u7684 ecall \u5f02\u5e38\u3002</p> </li> </ul>"},{"location":"lab4/#part-0\u51c6\u5907\u5de5\u4f5c","title":"Part 0\uff1a\u51c6\u5907\u5de5\u4f5c","text":""},{"location":"lab4/#\u66f4\u65b0\u4ee3\u7801","title":"\u66f4\u65b0\u4ee3\u7801","text":"<p>\u73b0\u5728\u4f60\u4f4d\u4e8e <code>lab3</code> \u5206\u652f\u3002\u4f60\u9700\u8981\u521b\u5efa <code>lab4</code> \u5206\u652f\uff0c\u5408\u5e76\u4e0a\u6e38\u7684\u4ee3\u7801\uff1a</p> <pre><code>git checkout -b lab4\ngit fetch upstream\ngit merge upstream/lab4\n</code></pre> <p>\u4e0b\u9762\u7684\u5408\u5e76\u8bf4\u660e\u4f9b\u540c\u5b66\u4eec\u89e3\u51b3\u5408\u5e76\u51b2\u7a81\u65f6\u53c2\u8003\uff1a</p> <p>TODO</p>"},{"location":"lab4/#part-1\u7528\u6237\u6001\u4e0e\u5185\u6838\u6001\u7684\u4ea4\u4e92","title":"Part 1\uff1a\u7528\u6237\u6001\u4e0e\u5185\u6838\u6001\u7684\u4ea4\u4e92","text":"<p>\u4f5c\u4e3a\u672c\u6b21\u5b9e\u9a8c\u7684\u7b2c\u4e00\u6b65\uff0c\u6211\u4eec\u9996\u5148\u8981\u589e\u5f3a Trap \u5904\u7406\u548c <code>task_struct</code> \u7ed3\u6784\u4f53\uff0c\u4e3a\u7528\u6237\u6001\u7a0b\u5e8f\u548c\u5185\u6838\u6001\u7a0b\u5e8f\u7684\u4ea4\u4e92\u6253\u4e0b\u57fa\u7840\u3002\u6211\u4eec\u5148\u4e0d\u7ba1\u7528\u6237\u6001\u7a0b\u5e8f\u662f\u4ec0\u4e48\u6837\u5b50\uff0c\u4ece\u5185\u6838\u7684\u89c6\u89d2\u51fa\u53d1\uff0c\u8bbe\u8ba1\u548c\u5b9e\u73b0\u5185\u6838\u5bf9\u7528\u6237\u6001\u7a0b\u5e8f\u7684\u652f\u6301\u3002</p>"},{"location":"lab4/#\u6539\u8fdb-trap-handler","title":"\u6539\u8fdb Trap Handler","text":"<p>\u7ecf\u5386\u8fc7\u524d\u51e0\u4e2a\u5b9e\u9a8c\uff0c\u540c\u5b66\u4eec\u5e94\u8be5\u5bf9\u8fdb\u5165 Trap \u65f6\u4fdd\u5b58\u4e0a\u4e0b\u6587\u5f88\u719f\u6089\u4e86\u3002\u7cfb\u7edf\u8c03\u7528\u6b63\u662f\u5229\u7528 ecall \u4f5c\u4e3a\u4e00\u79cd\u5f02\u5e38\uff0c\u901a\u8fc7 Trap \u4e0a\u4e0b\u6587\u4e0e\u5185\u6838\u4f20\u9012\u53c2\u6570\u548c\u8fd4\u56de\u503c\u7684\u3002\u73b0\u5728\uff0c\u6211\u4eec\u8981\u628a\u4ee5\u524d\u4fdd\u5b58\u7684\u4e0a\u4e0b\u6587\u5b9a\u4e49\u4e3a\u4e00\u4e2a\u7ed3\u6784\u4f53 <code>struct pt_regs</code>\uff0c\u65b9\u4fbf\u4e0b\u4e00\u8282\u5b9e\u73b0\u7cfb\u7edf\u8c03\u7528\u4f7f\u7528\u3002</p> kernel/arch/riscv/include/proc.h<pre><code>struct pt_regs {\n    uint64_t ra;\n    uint64_t sp;\n    //...\n};\n</code></pre>"},{"location":"lab4/#\u7cfb\u7edf\u8c03\u7528","title":"\u7cfb\u7edf\u8c03\u7528","text":""},{"location":"lab4/#\u5185\u6838\u6808\u4e0e-sscratch","title":"\u5185\u6838\u6808\u4e0e sscratch","text":""},{"location":"lab4/#task1\u5b9e\u73b0\u7cfb\u7edf\u8c03\u7528","title":"Task1\uff1a\u5b9e\u73b0\u7cfb\u7edf\u8c03\u7528","text":"<p>\u4f60\u7684\u4efb\u52a1\u662f\uff1a</p> <ol> <li>\u6539\u8fdb <code>_traps()</code> \u7684\u5b9e\u73b0\uff1a\u4e0a\u4e0b\u6587\u4fdd\u5b58\u5230\u5185\u6838\u6808\u6808\u9876\uff0c\u5e03\u5c40\u4e0e <code>struct pt_regs</code> \u5b9a\u4e49\u4e00\u81f4\u3002</li> </ol>"},{"location":"lab4/#part-2\u8fd0\u884c\u7528\u6237\u6001\u7a0b\u5e8f","title":"Part 2\uff1a\u8fd0\u884c\u7528\u6237\u6001\u7a0b\u5e8f","text":""},{"location":"lab4/#\u7528\u6237\u6001\u7a0b\u5e8f\u5d4c\u5165\u5185\u6838","title":"\u7528\u6237\u6001\u7a0b\u5e8f\u5d4c\u5165\u5185\u6838","text":"<p>\u56e0\u4e3a\u6211\u4eec\u8fd8\u6ca1\u6709\u5b9e\u73b0\u6587\u4ef6\u7cfb\u7edf\uff0c\u6240\u4ee5\u65e0\u6cd5\u4ece\u78c1\u76d8\u52a0\u8f7d\u7528\u6237\u6001\u7a0b\u5e8f\u3002\u5f85\u8fd0\u884c\u7684\u7528\u6237\u6001\u7a0b\u5e8f\u88ab\u7f16\u8bd1\u4e3a ELF \u683c\u5f0f\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u5d4c\u5165\u5230\u5185\u6838\u955c\u50cf\u4e2d\u3002</p> <p>src/*.c -&gt; OBJ -&gt; LD -T uapp.lds -&gt; uapp.elf -&gt; OBJCOPY -&gt; uapp.bin -&gt; uapp.S (incbin) -&gt; uapp.o (ELF)</p> <p>\u8bf7\u4f60\u9605\u8bfb <code>vmlinux.lds</code>\uff0c\u4e86\u89e3 ELF \u683c\u5f0f\u7684\u7528\u6237\u6001\u7a0b\u5e8f\u88ab\u5d4c\u5728\u4e86\u54ea\u4e2a\u5730\u65b9\uff0c\u4ee5\u4fbf\u540e\u7eed\u5b9e\u73b0 ELF \u7684\u89e3\u6790\u548c\u52a0\u8f7d\u3002</p>"},{"location":"lab4/#\u7528\u6237\u6001\u7a0b\u5e8f\u7684\u5185\u5b58\u5e03\u5c40","title":"\u7528\u6237\u6001\u7a0b\u5e8f\u7684\u5185\u5b58\u5e03\u5c40","text":""},{"location":"lab4/#elf-\u52a0\u8f7d\u5668","title":"ELF \u52a0\u8f7d\u5668","text":""},{"location":"lab4/#part-3\u5b9e\u73b0\u7cfb\u7edf\u8c03\u7528","title":"Part 3\uff1a\u5b9e\u73b0\u7cfb\u7edf\u8c03\u7528","text":""},{"location":"manual/","title":"\u5b9e\u9a8c\u6d41\u7a0b\u53ca\u5de5\u5177\u8bb2\u89e3","text":""},{"location":"manual/#\u5b9e\u9a8c\u6d41\u7a0b\u53ca\u5de5\u5177\u8bb2\u89e3","title":"\u5b9e\u9a8c\u6d41\u7a0b\u53ca\u5de5\u5177\u8bb2\u89e3","text":"<p>Quote</p> <p></p>     \u5de5\u6b32\u5584\u5176\u4e8b\uff0c\u5fc5\u5148\u5229\u5176\u5668\u3002 <p></p> <p>\u5728\u8ba1\u7b97\u673a\u4e13\u4e1a\u7684\u5b66\u4e60\u4e2d\uff0c\u8fd9\u53e5\u53e4\u8bdd\u540c\u6837\u9002\u7528\u3002\u9057\u61be\u7684\u662f\uff0c\u8bb8\u591a\u540c\u5b66\u5728\u9762\u5bf9 Git\u3001Linux\u3001Docker\u3001GDB\u3001VSCode \u7b49\u5de5\u5177\u65f6\uff0c\u5f80\u5f80\u7f3a\u4e4f\u7cfb\u7edf\u7684\u4e86\u89e3\u4e0e\u5b9e\u8df5\u7ecf\u9a8c\u3002\u7406\u8bba\u8bfe\u6559\u4f1a\u4e86\u6211\u4eec\u64cd\u4f5c\u7cfb\u7edf\u7684\u6838\u5fc3\u539f\u7406\uff0c\u4f46\u5728\u5b9e\u8df5\u73af\u8282\uff0c\u8bb8\u591a\u4eba\u5374\u88ab\u8fd9\u4e9b\u57fa\u7840\u5de5\u5177\u7eca\u4f4f\u4e86\u811a\u6b65\u3002</p> <p>\u7136\u800c\uff0c\u8fd9\u4e9b\u5de5\u5177\u4e0d\u4ec5\u4ec5\u662f\u5b8c\u6210\u5b9e\u9a8c\u7684\u5fc5\u9700\u54c1\uff0c\u66f4\u5c06\u4f34\u968f\u4f60\u6574\u4e2a\u804c\u4e1a\u751f\u6daf\u2014\u2014\u65e0\u8bba\u662f\u505a\u79d1\u7814\u3001\u5b9e\u4e60\u8fd8\u662f\u672a\u6765\u7684\u5de5\u7a0b\u5de5\u4f5c\uff0c\u90fd\u4f1a\u9891\u7e41\u5730\u4e0e\u5b83\u4eec\u6253\u4ea4\u9053\u3002\u638c\u63e1\u5b83\u4eec\uff0c\u5c31\u50cf\u4e3a\u672a\u6765\u6253\u5f00\u4e86\u4e00\u628a\u4e07\u80fd\u94a5\u5319\u3002</p> <p>\u4e3a\u4e86\u5e2e\u52a9\u5927\u5bb6\u66f4\u987a\u5229\u5730\u5b8c\u6210\u300a\u64cd\u4f5c\u7cfb\u7edf\u300b\u8bfe\u7a0b\u7684\u5b9e\u9a8c\uff0c\u4e5f\u8ba9\u4f60\u4eec\u80fd\u66f4\u81ea\u4fe1\u5730\u8fc8\u5411\u540e\u7eed\u7684\u5b66\u4e60\u4e0e\u5de5\u4f5c\uff0c\u6211\u6574\u7406\u4e86\u672c\u7bc7\u6587\u6863\uff0c\u5bf9\u5b9e\u9a8c\u6240\u9700\u7684\u5de5\u5177\u8fdb\u884c\u8be6\u7ec6\u7684\u8bb2\u89e3\u4e0e\u4e32\u8054\uff0c\u6db5\u76d6\u4ece\u73af\u5883\u642d\u5efa\u5230\u8c03\u8bd5\u7684\u5b8c\u6574\u6d41\u7a0b\u3002\u540c\u65f6\uff0c\u6211\u8fd8\u4e3a\u8fd9\u7bc7\u6587\u7ae0\u5f55\u5236\u4e86\u914d\u5957\u7684\u8bb2\u89e3\u89c6\u9891\uff0c\u65b9\u4fbf\u5927\u5bb6\u8fb9\u770b\u8fb9\u64cd\u4f5c\uff0c\u5faa\u5e8f\u6e10\u8fdb\u5730\u638c\u63e1\u6bcf\u4e00\u4e2a\u73af\u8282\u3002</p> <p></p> <p></p>"},{"location":"manual/#\u5b9e\u9a8c\u6d41\u7a0b\u6982\u89c8","title":"\u5b9e\u9a8c\u6d41\u7a0b\u6982\u89c8","text":"<p>\u5728\u6b63\u5f0f\u5f00\u59cb\u5b9e\u9a8c\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u5148\u7406\u6e05\u6574\u4e2a\u5f00\u53d1\u4e0e\u8c03\u8bd5\u7684\u6d41\u7a0b\u3002\u64cd\u4f5c\u7cfb\u7edf\u5b9e\u9a8c\u5927\u81f4\u5206\u4e3a\u4e24\u4e2a\u9636\u6bb5\uff1a</p> <ol> <li> <p>\u672c\u5730\u73af\u5883\u51c6\u5907\uff1a\u5728\u81ea\u5df1\u7684\u7535\u8111\u4e0a\u5b8c\u6210 Git \u914d\u7f6e\u3001\u6e90\u7801\u62c9\u53d6\u4ee5\u53ca\u5b89\u88c5 Docker \u5bb9\u5668\u5e73\u53f0\u3002\u8fd9\u4e00\u9636\u6bb5\u7684\u76ee\u6807\u662f\u786e\u4fdd\u5927\u5bb6\u80fd\u5728\u672c\u5730\u987a\u5229\u542f\u52a8\u8bfe\u7a0b\u63d0\u4f9b\u7684\u7edf\u4e00\u5b9e\u9a8c\u73af\u5883\uff0c\u907f\u514d\u56e0\u4e3a\u4e0d\u540c\u64cd\u4f5c\u7cfb\u7edf\u3001\u4f9d\u8d56\u7248\u672c\u7b49\u5dee\u5f02\u5bfc\u81f4\u7684\u73af\u5883\u95ee\u9898\u3002</p> </li> <li> <p>\u5728\u5bb9\u5668\u73af\u5883\u4e2d\u5b9e\u9a8c\uff1a\u901a\u8fc7 IDE \u63d0\u4f9b\u7684 DevContainer \u529f\u80fd\u8fdb\u5165\u5bb9\u5668\u73af\u5883\uff0c\u5728\u91cc\u9762\u5b8c\u6210\u4ee3\u7801\u7684\u7f16\u5199\u3001\u6784\u5efa\u3001\u8fd0\u884c\u3001\u8c03\u8bd5\u3001\u8bc4\u6d4b\uff0c\u6700\u540e\u63d0\u4ea4\u5230\u8fdc\u7aef\u8fdb\u884c\u6700\u7ec8\u6d4b\u8bd5\u3002\u5bb9\u5668\u73af\u5883\u514d\u53bb\u4e86\u73af\u5883\u914d\u7f6e\u7684\u70e6\u607c\uff0c\u786e\u4fdd\u6240\u6709\u540c\u5b66\u7684\u73af\u5883\u4e00\u81f4\uff0c\u4e13\u6ce8\u4e8e\u5b9e\u9a8c\u672c\u8eab\u3002</p> </li> </ol> <p>\u4e0b\u56fe\u5c55\u793a\u4e86\u6574\u4e2a\u5b9e\u9a8c\u7684\u6d41\u7a0b\uff1a</p> <pre><code>---\nconfig:\n    layout: elk\n---\nflowchart LR\n    subgraph Linux/macOS \u73af\u5883\n        A1[\"\u914d\u7f6e Git\"]\n        A2[\"\u62c9\u53d6\u6e90\u7801\"]\n        A3[\"\u914d\u7f6e Docker\"]\n        A4[\"VSCode \u542f\u52a8 DevContainer\"]\n        A1 --&gt; A2 --&gt; A3 --&gt; A4\n    end\n\n    subgraph DevContainer\n        B1[\"\u5f00\u53d1\"]\n        B2[\"\u6784\u5efa&lt;br&gt;make\"]\n        B3[\"\u8fd0\u884c&lt;br&gt;make run\"]\n        B4[\"\u8c03\u8bd5&lt;br&gt;make debug\"]\n        B5[\"\u672c\u5730\u8bc4\u6d4b&lt;br&gt;make judge\"]\n        B6[\"\u63d0\u4ea4\u4ee3\u7801&lt;br&gt;git commit\"]\n        B7[\"\u5408\u5e76\u4e0b\u4e00\u4e2a\u5b9e\u9a8c\u4ee3\u7801&lt;br&gt;git merge/rebase\"]\n        B1 --&gt; B2 --&gt; B3\n        B3 -- \"\u6709\u95ee\u9898\" --&gt; B4\n        B4 --&gt; B1\n        B3 -- \"\u6ca1\u95ee\u9898\" --&gt; B5\n        B5 -- \"\u901a\u8fc7\" --&gt; B6\n        B6 --&gt; B7 --&gt; B1\n    end\n\n    subgraph ZJU Git\n        C1[\"\u8fdc\u7aef\u8bc4\u6d4b\"]\n    end\n\n    A4 --&gt; B1\n    B6 -- \"\u63a8\u9001\u4ee3\u7801&lt;br&gt;git push\" --&gt; C1</code></pre> <p>\u5728\u63a5\u4e0b\u6765\u7684\u7ae0\u8282\u4e2d\uff0c\u6211\u4eec\u4f1a\u9010\u6b65\u4ecb\u7ecd\u5982\u4f55\u5b8c\u6210\u4e0a\u8ff0\u6bcf\u4e2a\u6b65\u9aa4\uff0c\u5305\u62ec\u5fc5\u8981\u7684\u547d\u4ee4\u3001\u914d\u7f6e\u65b9\u6cd5\u4ee5\u53ca\u5e38\u89c1\u95ee\u9898\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u5e2e\u52a9\u5927\u5bb6\u987a\u5229\u5b8c\u6210\u4ece\u73af\u5883\u642d\u5efa\u5230\u5b9e\u9a8c\u63d0\u4ea4\u7684\u5b8c\u6574\u95ed\u73af\u3002</p>"},{"location":"manual/#\u524d\u7f6e\u8981\u6c42","title":"\u524d\u7f6e\u8981\u6c42","text":"<p>\u5728\u6b63\u5f0f\u5f00\u59cb\u4e4b\u524d\uff0c\u6211\u4eec\u9ed8\u8ba4\u5927\u5bb6\u5df2\u7ecf\u5177\u5907\u4ee5\u4e0b\u57fa\u7840\u6280\u80fd\uff08\u57fa\u4e8e\u5b9e\u9a8c\u8bfe\u524d\u7684\u8c03\u67e5\u95ee\u5377\uff09\uff1a</p> <ul> <li>\u62e5\u6709 Linux \u6216 macOS \u73af\u5883\uff0c\u5e76\u80fd\u5b8c\u6210\u57fa\u672c\u7684 Linux \u547d\u4ee4\u884c\u64cd\u4f5c</li> <li>\u4e86\u89e3 Git \u548c Makefile \u7684\u57fa\u672c\u7528\u6cd5</li> </ul> <p>\u7531\u4e8e\u7bc7\u5e45\u9650\u5236\uff0c\u672c\u6587\u65e0\u6cd5\u4ece\u300c\u5982\u4f55\u5b89\u88c5 Linux\u300d\u6216\u300c\u5982\u4f55\u4f7f\u7528 Git\u300d\u8fd9\u6837\u7684\u96f6\u57fa\u7840\u8bdd\u9898\u8bb2\u8d77\u3002\u5982\u679c\u4f60\u5bf9\u5176\u4e2d\u7684\u67d0\u4e9b\u5185\u5bb9\u8fd8\u4e0d\u592a\u719f\u6089\uff0c\u4e0d\u5fc5\u62c5\u5fc3\uff0c\u6211\u4eec\u5df2\u7ecf\u4e3a\u4f60\u51c6\u5907\u4e86\u8865\u5145\u5b66\u4e60\u8d44\u6e90\uff1a</p> <ul> <li>\u4ece\u672a\u4f7f\u7528\u8fc7 Git\uff1a\u5efa\u8bae\u89c2\u770b \u3010GeekHour\u3011\u4e00\u5c0f\u65f6Git\u6559\u7a0b\uff0c\u5feb\u901f\u638c\u63e1\u7248\u672c\u63a7\u5236\u7684\u57fa\u672c\u64cd\u4f5c\u3002</li> <li>\u5bf9 Makefile \u5b8c\u5168\u964c\u751f\uff1a\u63a8\u8350 \u3010GeekHour\u301120\u5206\u949fMakefile\u5149\u901f\u5165\u95e8\u6559\u7a0b\uff0c\u5e2e\u52a9\u4f60\u7406\u89e3\u5b9e\u9a8c\u4e2d\u4f1a\u7528\u5230\u7684\u6838\u5fc3\u547d\u4ee4\u3002</li> <li> <p>\u6ca1\u6709 Linux/macOS \u73af\u5883\uff1a</p> <ul> <li>\u5728 Windows \u4e0a\u5b89\u88c5 WSL\uff08\u5b98\u65b9\u63a8\u8350\uff09\uff1a\u53c2\u8003 \u5b89\u88c5 WSL\uff0c\u5728 Windows \u4e0a\u642d\u5efa\u7c7b Unix \u5f00\u53d1\u73af\u5883\u3002</li> <li>\u4f7f\u7528\u865a\u62df\u673a\u5b89\u88c5 Linux\uff1a\u5982 VMware \u6216 VirtualBox\uff0c\u9002\u5408\u5e0c\u671b\u5b8c\u6574\u4f53\u9a8c Linux \u7cfb\u7edf\u7684\u540c\u5b66\u3002</li> </ul> </li> </ul> <p>\u5982\u679c\u4f60\u4e0d\u5177\u5907\u5b9e\u9a8c\u6761\u4ef6\uff0c\u53ef\u4ee5\u8054\u7cfb\u52a9\u6559\u7533\u8bf7\u5b9e\u9a8c\u673a\u3002</p>"},{"location":"manual/#part-1\u672c\u5730\u73af\u5883\u51c6\u5907","title":"Part 1\uff1a\u672c\u5730\u73af\u5883\u51c6\u5907","text":"<p>\u63a5\u4e0b\u6765\u7684\u5185\u5bb9\u5047\u8bbe\u4f60\u5df2\u7ecf\u6709\u4e00\u4e2a Linux \u6216 macOS \u73af\u5883\u3002WSL \u7528\u6237\u8bf7\u5728 WSL \u4e2d\u64cd\u4f5c\u3002</p> <p>WSL \u7528\u6237\u4e0d\u8981\u5c06\u4ee3\u7801\u5b58\u653e\u5728 Windows \u76ee\u5f55\u4e0b</p> <p>WSL \u7528\u6237\u5e94\u8be5\u4e86\u89e3\uff1aLinux \u548c Windows \u7684\u6587\u4ef6\u7cfb\u7edf\u4e0d\u540c\uff0c\u6587\u4ef6\u6743\u9650\u3001\u6362\u884c\u7b26\u3001\u94fe\u63a5\u3001\u5927\u5c0f\u5199\u7b49\u65b9\u9762\u90fd\u5b58\u5728\u533a\u522b\u3002</p> <p>\u867d\u7136 WSL \u5c06 Windows \u76ee\u5f55\u6302\u8f7d\u5230\u4e86 <code>/mnt/c</code> \u7b49\u8def\u5f84\u4e0b\uff0c\u4f46\u8fd9\u53ea\u662f\u4e3a\u4e86\u65b9\u4fbf\u6587\u4ef6\u4e92\u8bbf\u3002\u5b98\u65b9\u5e76\u4e0d\u5efa\u8bae\u4f60\u5c06\u6587\u4ef6\u5b58\u653e\u5728\u4e00\u8fb9\uff0c\u53c8\u5728\u53e6\u4e00\u8fb9\u4f7f\u7528\u3002\u9996\u5148\u6027\u80fd\u8f83\u4f4e\uff0c\u5176\u6b21\u4ee3\u7801\u4ed3\u5e93\u7b49\u5bf9\u6587\u4ef6\u6743\u9650\u3001\u94fe\u63a5\u7b49\u6709\u8981\u6c42\u7684\u9879\u76ee\u5f88\u5bb9\u6613\u51fa\u95ee\u9898\u3002</p> <p>\u8bf7 WSL \u7528\u6237\u5728 WSL \u539f\u751f\u7684\u6587\u4ef6\u7cfb\u7edf\u4e2d\uff08\u6bd4\u5982 <code>/home/&lt;username&gt;/</code>\uff09\u5b58\u653e\u5b9e\u9a8c\u6587\u4ef6\uff0c\u4ee5\u907f\u514d\u51fa\u73b0\u5404\u79cd\u5947\u602a\u7684\u95ee\u9898\u3002</p>"},{"location":"manual/#git-\u914d\u7f6e","title":"Git \u914d\u7f6e","text":"<p>\u5982\u679c\u4f60\u5df2\u7ecf\u4f7f\u7528\u8fc7 Git\uff0c\u901a\u5e38\u4f1a\u5b8c\u6210\u4ee5\u4e0b\u914d\u7f6e\u6b65\u9aa4\uff1a</p> <ul> <li>\u914d\u7f6e SSH \u5bc6\u94a5\uff1a \u7528\u4e8e\u5b89\u5168\u5730\u62c9\u53d6\u548c\u63a8\u9001\u4ee3\u7801\u3002\u4f60\u9700\u8981\u5728\u672c\u5730\u751f\u6210 SSH \u5bc6\u94a5\u5bf9\uff0c\u5e76\u5c06\u516c\u94a5\u6dfb\u52a0\u5230 Git \u5e73\u53f0\u3002\u5bc6\u94a5\u6587\u4ef6\u9ed8\u8ba4\u4fdd\u5b58\u5728 <code>~/.ssh</code> \u76ee\u5f55\u4e0b\u3002</li> <li> <p>\u8bbe\u7f6e Git \u7528\u6237\u4fe1\u606f\uff1a \u4e3a\u4e86\u6b63\u786e\u8bb0\u5f55\u63d0\u4ea4\u5386\u53f2\uff0c\u9700\u8981\u914d\u7f6e\u7528\u6237\u540d\u548c\u90ae\u7bb1\u3002\u8fd9\u4e9b\u4fe1\u606f\u4f1a\u4fdd\u5b58\u5728 <code>~/.gitconfig</code> \u6587\u4ef6\u4e2d\u3002</p> <pre><code>git config --global user.name \"Your Name\"\ngit config --global user.email \"username@example.com\"\n</code></pre> </li> </ul> <p>\u5982\u679c\u4f60\u5bf9\u8fd9\u4e9b\u64cd\u4f5c\u6ca1\u6709\u5370\u8c61\uff0c\u8bf7\u89c2\u770b\u4e0a\u6587\u63d0\u4f9b\u7684\u5b66\u4e60\u8d44\u6e90\u3002</p> FAQ\uff1aGit \u7528\u6237\u540d\u548c\u90ae\u7bb1\u5982\u4f55\u914d\u7f6e\uff1f <p>\u5176\u5b9e\u8bbe\u6210\u4ec0\u4e48\u90fd\u6ca1\u5173\u7cfb\uff0c\u56e0\u4e3a\u4ed3\u5e93\u7684\u5730\u5740\u786e\u5b9a\uff0c\u52a9\u6559\u4f1a\u53bb\u5bf9\u5e94\u7684\u4ed3\u5e93\u770b\u4f60\u7684\u63d0\u4ea4\u3002</p> <p>Git \u5e73\u53f0\uff08\u5982 GitHub\u3001GitLab\u3001ZJU Git\uff09\u4f1a\u6839\u636e\u4f60 commit \u4e2d\u7684\u90ae\u7bb1\u6765\u5173\u8054\u5230\u4f60\u7684\u8d26\u53f7\uff0c\u4ece\u800c\u663e\u793a\u5934\u50cf\u7b49\u4fe1\u606f\u3002\u5982\u679c\u4f60\u60f3\u8ba9 commit \u663e\u793a\u6b63\u786e\u7684\u5934\u50cf\uff0c\u53ef\u4ee5\u5c06 <code>user.email</code> \u8bbe\u7f6e\u6210\u4f60\u5728 ZJU Git \u4e0a\u7ed1\u5b9a\u7684\u90ae\u7bb1\u3002</p> <p>\u5b8c\u6210\u6761\u4ef6</p> <p>Linux/macOS \u73af\u5883\u4e2d\u5b58\u5728\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <ul> <li><code>~/.gitconfig</code> \u6587\u4ef6</li> <li><code>~/.ssh</code> \u6587\u4ef6\u5939\uff0c\u5176\u4e2d\u5b58\u653e\u4e86 SSH \u5bc6\u94a5\u5bf9</li> </ul> <p>\u8fd9\u4e9b\u5185\u5bb9\u63a5\u4e0b\u6765\u4f1a\u88ab\u5bb9\u5668\u7528\u5230\uff0c\u8bf7\u52a1\u5fc5\u786e\u4fdd\u5b83\u4eec\u5b58\u5728\u3002</p>"},{"location":"manual/#zju-git-\u6e90\u7801\u62c9\u53d6","title":"ZJU Git \u6e90\u7801\u62c9\u53d6","text":"<p>\u672c\u8bfe\u7a0b\u4f7f\u7528 ZJU Git \u4f5c\u4e3a\u7edf\u4e00\u7684\u4ee3\u7801\u7ba1\u7406\u5e73\u53f0\u3002\u6bcf\u4f4d\u540c\u5b66\u90fd\u9700\u5728\u6307\u5b9a\u4ed3\u5e93\u63d0\u4ea4\u4ee3\u7801\u5e76\u5b8c\u6210\u8bc4\u6d4b\u3002\u9996\u6b21\u4f7f\u7528\u8bf7\u524d\u5f80\u767b\u5f55\u754c\u9762\u6ce8\u518c\u8d26\u53f7\u3002</p> <p>ZJU Git \u4f7f\u7528\u987b\u77e5</p> <p>\u5173\u4e8e ZJU Git \u7684\u7f51\u7edc\uff0c\u540c\u5b66\u4eec\u9700\u8981\u77e5\u6653\uff1a</p> <ul> <li>ZJU Git \u76ee\u524d\u4ec5\u9762\u5411\u6821\u5185\u670d\u52a1\uff0c\u4ec5\u6821\u5185 DNS \u6709\u89e3\u6790\u8bb0\u5f55\u3002\u5982\u679c\u4f7f\u7528\u6821\u5916 DNS \u6216\u6821\u5916\u7f51\u7edc\uff0c\u5219\u65e0\u6cd5\u8bbf\u95ee ZJU Git\u3002</li> <li>\u4e3a\u4e86\u4fdd\u969c\u7f51\u7edc\u5b89\u5168\uff0c\u5b66\u6821\u4fe1\u606f\u4e2d\u5fc3\u5c01\u7981\u4e86 RVPN \u7684 22 \u7aef\u53e3\uff0c\u56e0\u6b64\u4ec5\u80fd\u8bbf\u95ee ZJU Git \u7f51\u9875\uff0c\u65e0\u6cd5\u4f7f\u7528\u547d\u4ee4\u884c Git \u4ee5 SSH \u65b9\u5f0f\u8fde\u63a5\u3002</li> <li>\u4e3a\u6b64\uff0cZJU Git \u5f00\u653e\u4e86 2222 \u7aef\u53e3\u4f9b RVPN \u7528\u6237\u4ee5 SSH \u65b9\u5f0f\u4f7f\u7528\u3002\u6709\u6821\u5916\u7f51\u7edc\u9700\u6c42\u7684\u540c\u5b66\u8bf7\u6ce8\u610f\u8fd9\u4e00\u70b9\uff0c\u5c06\u94fe\u63a5\u66ff\u6362\u4e3a <code>ssh://git.zju.edu.cn:2222/...</code>\u3002</li> </ul> <p>\u52a9\u6559\u5df2\u4e3a\u6bcf\u4f4d\u540c\u5b66\u5206\u914d\u4e86\u79c1\u6709\u4ed3\u5e93\uff0c\u8bf7\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5c06\u4ed3\u5e93\u514b\u9686\u5230\u672c\u5730\uff1a</p> <pre><code>git clone git@git.zju.edu.cn:os/&lt;\u5b66\u671f&gt;/&lt;\u6559\u5b66\u73ed&gt;/os-&lt;\u4f60\u7684\u5b66\u53f7&gt;.git\n</code></pre> FAQ\uff1a\u514b\u9686\u4ed3\u5e93\u65f6\u51fa\u9519 <p>\u540c\u5b66\u4eec\u7684\u7f51\u7edc\u3001SSH \u548c Git \u914d\u7f6e\u975e\u5e38\u591a\u6837\uff0c\u5bfc\u81f4\u7684\u9519\u8bef\u4e5f\u975e\u5e38\u591a\u6837\u3002\u8bf7\u6839\u636e\u5177\u4f53\u9519\u8bef\u4fe1\u606f\u8fdb\u884c\u6392\u67e5\u3002</p> Failed ... via ... after ...ms <ul> <li> <p>\u73b0\u8c61\uff1a</p> <pre><code>Failed to connect to git.zju.edu.cn port 443 via 127.0.0.1 after 0 ms: Could not connect to server\n</code></pre> </li> <li> <p>\u539f\u56e0\uff1a</p> <p><code>via 127.0.0.1</code> \u8868\u660e Git \u8bd5\u56fe\u901a\u8fc7\u672c\u5730\u4ee3\u7406\u8fde\u63a5\u5230 ZJU Git\uff0c\u4f46\u8fde\u63a5\u5931\u8d25\u3002\u8bf7\u68c0\u67e5\u4f60\u7684\u4ee3\u7406\u8bbe\u7f6e\u3002</p> <p>\u4ee3\u7406\u8bbe\u7f6e\u9664\u4e86\u73af\u5883\u53d8\u91cf\uff08\u5982 <code>http_proxy</code>\u3001<code>https_proxy</code>\uff09\u5916\uff0c\u8fd8\u53ef\u80fd\u5b58\u5728\u4e8e Git \u914d\u7f6e\u4e2d\uff0c\u8fd0\u884c <code>git config --list</code> \u68c0\u67e5\u662f\u5426\u6709\u9519\u8bef\u7684\u914d\u7f6e\u3002</p> </li> <li> <p>\u89e3\u51b3\u529e\u6cd5\uff1a</p> <p>\u5220\u53bb\u76f8\u5173\u9519\u8bef\u914d\u7f6e\uff0c\u6216\u8005\u6b63\u786e\u8bbe\u7f6e\u4ee3\u7406\u3002</p> </li> </ul> Connection timed out <ul> <li> <p>\u73b0\u8c61\uff1a</p> <pre><code>ssh: connect to host git.zju.edu.cn port 22: Connection timed out\n</code></pre> </li> <li> <p>\u539f\u56e0\uff1a</p> <p>\u5982\u4e0a\u6587\u6240\u8ff0\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e00\u822c\u51fa\u73b0\u5728\u4f7f\u7528 RVPN \u7684\u540c\u5b66\u3002</p> </li> <li> <p>\u89e3\u51b3\u529e\u6cd5\uff1a</p> <p>\u4fee\u6539 Git \u94fe\u63a5\u4f7f\u7528 2222 \u7aef\u53e3\uff1a</p> <pre><code>git clone ssh://git.zju.edu.cn:2222/os/&lt;\u5b66\u671f&gt;/&lt;\u6559\u5b66\u73ed&gt;/os-&lt;\u4f60\u7684\u5b66\u53f7&gt;.git\n</code></pre> </li> </ul> Could not resolve hostname git.zju.edu.cn <ul> <li> <p>\u73b0\u8c61\uff1a</p> <pre><code>ssh: Could not resolve hostname git.zju.edu.cn: nodename nor servname provided, or not known\nfatal: Could not read from remote repository.\n</code></pre> </li> <li> <p>\u539f\u56e0\uff1a</p> <p>ZJU Git \u4ec5\u9762\u5411\u6821\u5185\u670d\u52a1\uff0c\u4ec5\u6821\u5185 DNS \u6709\u89e3\u6790\u8bb0\u5f55\u3002\u90e8\u5206\u540c\u5b66\u624b\u52a8\u5c06 DNS \u8bbe\u7f6e\u4e3a\u5176\u4ed6\u670d\u52a1\u5668\uff0c\u5bfc\u81f4 ZJU Git \u65e0\u6cd5\u89e3\u6790\u3002</p> </li> <li> <p>\u89e3\u51b3\u529e\u6cd5\uff1a</p> <p>\u5982\u679c\u4f60\u5728\u6821\u5185\uff0c\u5c06 DNS \u8bbe\u7f6e\u4e3a\u81ea\u52a8\u83b7\u53d6\uff0c\u6216\u8005\u624b\u52a8\u8bbe\u7f6e\u4e3a\u6d59\u5927\u6821\u56ed\u7f51 DNS\u3002</p> </li> </ul> not a valid repository name <ul> <li> <p>\u73b0\u8c61\uff1a</p> <pre><code>git clone git@git.zju.edu.cn:...\nfatal: remote error:\n... is not a valid repository name\nVisit https://support.github.com/ for help\n</code></pre> </li> <li> <p>\u539f\u56e0\uff1a</p> <p>\u4ece\u62a5\u9519\u53ef\u4ee5\u770b\u5230\u662f GitHub \u8fd4\u56de\u7684\u9519\u8bef\uff0c\u4f46\u6240\u7ed9\u7684\u94fe\u63a5\u4e3a ZJU Git\u3002\u8fd9\u4e00\u822c\u662f Git \u914d\u7f6e\u9519\u8bef\u5bfc\u81f4\u7684\uff0c\u8fd0\u884c <code>git config --list</code> \u68c0\u67e5\u662f\u5426\u6709\u9519\u8bef\u7684\u914d\u7f6e\u3002</p> <p>\u76ee\u524d\u53d1\u73b0\u6709\u9519\u8bef\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>core.sshcommand=ssh -T -p 443 -o Hostname=ssh.github.com\n</code></pre> </li> <li> <p>\u89e3\u51b3\u529e\u6cd5\uff1a</p> <p>\u5220\u9664\u76f8\u5173\u9519\u8bef\u914d\u7f6e\uff1a</p> <pre><code>git config --global --unset core.sshcommand\n</code></pre> </li> </ul> <p>\u5b8c\u6210\u6761\u4ef6</p> <ul> <li>\u6210\u529f\u5c06\u4ee3\u7801\u5e93\u514b\u9686\u5230 Linux/macOS \u73af\u5883\u4e2d\u3002</li> <li>\u7528 VSCode \u6253\u5f00\u4ee3\u7801\u5e93\u76ee\u5f55\uff0c\u63a5\u4e0b\u6765\u7684\u64cd\u4f5c\u53ef\u5728 VSCode \u7ec8\u7aef\u4e2d\u5b8c\u6210\u3002</li> </ul>"},{"location":"manual/#\u5b89\u88c5\u548c\u4f7f\u7528-docker","title":"\u5b89\u88c5\u548c\u4f7f\u7528 Docker","text":"<p>Docker \u57fa\u672c\u6982\u5ff5</p> <ul> <li>\u5bb9\u5668\u662f\u4e00\u79cd\u8f7b\u91cf\u7ea7\u7684\u865a\u62df\u5316\u6280\u672f\uff0cDocker \u662f\u4e00\u4e2a\u5bb9\u5668\u5e73\u53f0\u3002\u5bb9\u5668\u548c\u865a\u62df\u673a\u90fd\u80fd\u591f\u5c06\u5e94\u7528\u7a0b\u5e8f\u53ca\u5176\u4f9d\u8d56\u6253\u5305\u5728\u4e00\u4e2a\u72ec\u7acb\u7684\u73af\u5883\u4e2d\u8fd0\u884c\uff0c\u4e0e\u5bbf\u4e3b\u673a\u9694\u79bb\u5f00\u6765\u3002\u533a\u522b\u5728\u4e8e\uff0c\u865a\u62df\u673a\u9700\u8981\u5b8c\u6574\u7684\u64cd\u4f5c\u7cfb\u7edf\uff0c\u800c\u5bb9\u5668\u53ea\u9700\u8981\u5305\u542b\u5e94\u7528\u7a0b\u5e8f\u53ca\u5176\u4f9d\u8d56\uff0c\u5229\u7528\u5bbf\u4e3b\u673a\u7684\u5185\u6838\u6765\u8fd0\u884c\uff0c\u56e0\u6b64\u66f4\u52a0\u8f7b\u91cf\u548c\u9ad8\u6548\u3002</li> <li>\u52a9\u6559\u5c06\u6240\u9700\u7684\u73af\u5883\u6253\u5305\u6210\u4e00\u4e2a\u5bb9\u5668\u955c\u50cf\uff08image\uff09\uff0c\u5b58\u653e\u5230 ZJUGit \u5bb9\u5668\u6ce8\u518c\u8868\uff08registry\uff09\u3002\u540c\u5b66\u4eec\u4ece Registry \u62c9\u53d6\uff08pull\uff09 \u955c\u50cf\uff0c\u7136\u540e\u57fa\u4e8e\u8be5\u955c\u50cf\u521b\u5efa\u5e76\u542f\u52a8\u4e00\u4e2a\u5bb9\u5668\uff08container\uff09\u3002</li> </ul> <p>\u8fd9\u4e3a\u6211\u4eec\u5e26\u6765\u4e86\u4ee5\u4e0b\u597d\u5904\uff1a</p> <ul> <li>\u7b80\u5355\uff1a<ul> <li>\u540c\u5b66\u4eec\u4e0d\u7528\u624b\u52a8\u914d\u73af\u5883\u4e86\uff0c\u53ea\u9700\u8981\u914d Docker\u3002</li> <li>\u73af\u5883\u641e\u574f\u4e86\u5c31\u5220\u6389\u91cd\u5efa\u4e00\u4e2a\u65b0\u7684\uff0c\u975e\u5e38\u65b9\u4fbf\u3002</li> </ul> </li> <li>\u9694\u79bb\uff1a\u73af\u5883\u548c\u5bbf\u4e3b\u673a\u9694\u79bb\uff0c\u4e0d\u4f1a\u5f7c\u6b64\u5f71\u54cd\u548c\u6c61\u67d3\u3002</li> <li>\u4e00\u81f4\uff1a\u6240\u6709\u4eba\u7684\u73af\u5883\u90fd\u662f\u4ece\u540c\u4e00\u4e2a\u955c\u50cf\u521b\u5efa\u7684\uff0c\u907f\u514d\u4e86\u7edd\u5927\u591a\u6570\u201c\u5728\u6211\u7535\u8111\u4e0a\u80fd\u8dd1\u201d\u7684\u95ee\u9898\u3002</li> </ul> <p>\u672c\u6587\u4ec5\u4f1a\u4ecb\u7ecd\u5b9e\u9a8c\u4e2d\u5fc5\u8981\u7684 Docker \u64cd\u4f5c\u3002\u5982\u679c\u4f60\u60f3\u5b66\u4e60\u66f4\u591a\uff0c\u53ef\u4ee5\u89c2\u770b \u3010GeekHour\u301130\u5206\u949fDocker\u5165\u95e8\u6559\u7a0b\u3002</p> <p>\u8ba9\u6211\u4eec\u4ece\u5b89\u88c5 Docker \u5f00\u59cb\uff1a</p> <ul> <li>Linux \u548c WSL \u73af\u5883\u8bf7\u53c2\u8003 Docker CE | ZJU Mirror</li> <li>macOS \u63a8\u8350\u4f7f\u7528 Docker Desktop \u6216 OrbStack (\u53ef\u4ee5\u7528 Homebrew \u76f4\u63a5\u5b89\u88c5)</li> </ul> <p>\u6210\u529f\u5b89\u88c5\u5e76\u542f\u52a8 Docker \u540e\uff0c\u53ef\u4ee5\u8fd0\u884c <code>docker info</code> \u6765\u68c0\u67e5 Docker \u662f\u5426\u80fd\u6b63\u5e38\u5de5\u4f5c\u3002</p> FAQ\uff1aCannot connect to the Docker daemon <ul> <li> <p>\u73b0\u8c61\uff1a</p> <pre><code>Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?\n</code></pre> </li> <li> <p>\u539f\u56e0\uff1a</p> <p>Docker \u7684\u5de5\u4f5c\u539f\u7406\u662f\u5ba2\u6237\u7aef-\u670d\u52a1\u5668\u6a21\u5f0f\u3002\u5728\u7ec8\u7aef\u4e2d\u6267\u884c\u7684\u662f Docker CLI \u5ba2\u6237\u7aef\uff0c\u5b83\u9700\u8981\u8fde\u63a5\u5230\u670d\u52a1\u5668\u5373 Docker Daemon\uff08\u5b88\u62a4\u8fdb\u7a0b\uff09\u6765\u5b8c\u6210\u5b9e\u9645\u7684\u5de5\u4f5c\uff0c\u6bd4\u5982\u62c9\u53d6\u3001\u542f\u52a8\u5bb9\u5668\u7b49\u3002\u9519\u8bef\u4fe1\u606f\u8868\u660e Docker Daemon \u6ca1\u6709\u542f\u52a8\u3002</p> <p>\u8be5\u95ee\u9898\u5e38\u89c1\u4e8e\u5728 WSL \u4e2d\u521d\u6b21\u5b89\u88c5 Docker Engine \u7684\u573a\u666f\uff0c\u6b64\u65f6 Docker Daemon \u53ef\u80fd\u5c1a\u672a\u81ea\u52a8\u542f\u52a8\u3002</p> </li> <li> <p>\u89e3\u51b3\u529e\u6cd5\uff1a</p> <ul> <li> <p>Linux\uff1a</p> <p>\u5728\u73b0\u4ee3 Linux \u53d1\u884c\u7248\u4e2d\uff0c\u4e00\u822c\u4f7f\u7528 systemd \u6765\u7ba1\u7406\u7cfb\u7edf\u670d\u52a1\u3002\u5176\u4e2d\uff0c<code>systemctl</code> \u7528\u4e8e\u7ba1\u7406\u670d\u52a1\uff0c<code>journalctl</code> \u7528\u4e8e\u7ba1\u7406\u65e5\u5fd7\u3002</p> <pre><code># \u68c0\u67e5 Docker \u670d\u52a1\u72b6\u6001\nsudo systemctl status docker\n# \u5982\u679c\u8f93\u51fa\u4e0d\u662f active (running)\uff0c\u5219\u542f\u52a8 Docker \u670d\u52a1\nsudo systemctl enable --now docker\n# \u5982\u679c\u8f93\u51fa\u662f\u5176\u4ed6\u72b6\u6001\uff08\u5982 failed\uff09\uff0c\u53ef\u4ee5\u5c06\u65e5\u5fd7\u4fe1\u606f\u5582\u7ed9 AI \u5bfb\u6c42\u5e2e\u52a9\nsudo journalctl -u docker --no-pager | tail -n 50\n</code></pre> </li> <li> <p>WSL\uff1a</p> <p>\u5982\u679c\u4f60\u8fd0\u884c\u7684\u662f\u8f83\u8001\u7248\u672c\u7684 WSL\uff0c\u5219 systemd \u53ef\u80fd\u4e0d\u53ef\u7528\u3002\u63a8\u8350\u4f60\u6309\u7167 Use systemd to manage Linux services with WSL | Microsoft Learn \u7684\u6307\u5f15\u5347\u7ea7 WSL \u7248\u672c\uff0c\u542f\u7528 systemd\u3002</p> <p>\u5982\u679c\u4f60\u4e0d\u60f3\u5347\u7ea7\uff0c\u91cd\u542f WSL \u5e94\u8be5\u4e5f\u80fd\u89e3\u51b3\u95ee\u9898\u3002\u5728 Windows \u7ec8\u7aef\u4e2d\u6267\u884c\uff1a</p> <pre><code>wsl --shutdown\n</code></pre> <p>\u7136\u540e\u91cd\u65b0\u6253\u5f00 WSL\u3002</p> </li> <li> <p>macOS\uff1a</p> <p>\u786e\u4fdd\u4f60\u542f\u52a8\u4e86 Docker Desktop for Mac\u3002</p> </li> </ul> </li> </ul> <p>\u63a5\u4e0b\u6765\u7528\u8bfe\u7a0b\u63d0\u4f9b\u7684\u955c\u50cf\u6765\u7ec3\u4e60\u4e00\u4e9b\u5e38\u7528\u7684 Docker \u547d\u4ee4\uff1a</p> <ul> <li> <p>\u955c\u50cf\u64cd\u4f5c\uff1a</p> <ul> <li> <p>\u62c9\u53d6\u955c\u50cf\uff1a</p> <pre><code>docker pull git.zju.edu.cn:5050/zju-cs-lab/tool/sys:latest\n</code></pre> </li> <li> <p>\u67e5\u770b\u672c\u5730\u955c\u50cf\u53ca\u5176\u6458\u8981\uff08Digest\uff09\uff1a</p> <pre><code>docker images --digests\n</code></pre> <p>\u955c\u50cf\u7531 \u955c\u50cf\u540d\uff08\u5982 <code>git.zju.edu.cn:5050/zju-cs-lab/tool/sys</code>\uff09\u548c \u6807\u7b7e\uff08tag\uff09\uff08\u5982 <code>:x86_64</code>\u3001<code>:latest</code>\uff09\u7ec4\u6210\u3002\u52a9\u6559\u4f1a\u6301\u7eed\u66f4\u65b0 <code>:latest</code> \u955c\u50cf\uff0c\u4f46 \u552f\u4e00\u80fd\u4fdd\u8bc1\u955c\u50cf\u5185\u5bb9\u4e00\u81f4\u7684\u6807\u8bc6\u662f\u6458\u8981\uff08digest\uff09\uff08\u5f62\u5982 <code>sha256:...</code>\uff09\u3002</p> <p>\u5982\u679c\u52a9\u6559\u901a\u77e5\u4e86\u955c\u50cf\u66f4\u65b0\uff0c\u540c\u5b66\u4eec\u53ef\u4ee5\u68c0\u67e5\u672c\u5730\u955c\u50cf\u7684 digest\uff0c\u5982\u679c\u4e0e ZJU Git \u4e0a\u7684 digest \u4e0d\u540c\uff0c\u5219\u8bf4\u660e\u672c\u5730\u955c\u50cf\u8fc7\u671f\uff0c\u9700\u8981\u91cd\u65b0\u6267\u884c <code>docker pull</code>\u3002</p> </li> <li> <p>\u5220\u9664\u955c\u50cf\uff1a</p> <pre><code>docker rmi &lt;image_id&gt;\n</code></pre> </li> </ul> </li> <li> <p>\u5bb9\u5668\u64cd\u4f5c\uff1a</p> <ul> <li> <p>\u542f\u52a8\u5e76\u8fdb\u5165\u5bb9\u5668\uff1a</p> <pre><code>docker run -it --rm git.zju.edu.cn:5050/zju-cs-lab/tool/sys:latest fish\n# \u547d\u4ee4\u683c\u5f0f\n# docker run [OPTIONS] IMAGE [COMMAND]\n</code></pre> <p>\u8fd9\u6761\u547d\u4ee4\u4f1a\u57fa\u4e8e\u6307\u5b9a\u955c\u50cf\u521b\u5efa\u5e76\u542f\u52a8\u4e00\u4e2a\u5bb9\u5668\uff0c\u5e76\u8fdb\u5165\u5bb9\u5668\u5185\u7684 fish \u7ec8\u7aef\u3002</p> <ul> <li><code>--rm</code> \u8868\u793a\u9000\u51fa\u5bb9\u5668\u540e\u81ea\u52a8\u5220\u9664\u5b83\u3002</li> </ul> </li> <li> <p>\u8fdb\u5165\u8fd0\u884c\u4e2d\u7684\u5bb9\u5668\uff1a</p> <pre><code>docker exec -it &lt;container_id&gt; fish\n</code></pre> <p>\u8fd9\u6761\u547d\u4ee4\u4f1a\u8fdb\u5165\u4e00\u4e2a\u5df2\u7ecf\u8fd0\u884c\u7684\u5bb9\u5668\u3002</p> </li> <li> <p>\u67e5\u770b\u5bb9\u5668\uff1a</p> <pre><code>docker ps #\u6b63\u5728\u8fd0\u884c\u7684\ndocker ps -a #\u67e5\u770b\u6240\u6709\u5bb9\u5668\uff08\u5305\u62ec\u672a\u8fd0\u884c\u7684\uff09\n</code></pre> </li> <li> <p>\u505c\u6b62\u5e76\u5220\u9664\u5bb9\u5668\uff1a</p> <pre><code>docker rm -f &lt;container_id&gt;\n</code></pre> </li> </ul> </li> <li> <p>\u5176\u4ed6\u5e38\u7528\u547d\u4ee4\uff1a</p> <ul> <li> <p>\u6e05\u7406\u65e0\u7528\u7684\u955c\u50cf\u3001\u5bb9\u5668\u7b49\uff1a</p> <pre><code>docker system prune\n</code></pre> </li> </ul> </li> </ul> FAQ\uff1a\u955c\u50cf\u62c9\u53d6\u95ee\u9898 ZJU Git EOF <ul> <li> <p>\u73b0\u8c61\uff1a</p> <pre><code>Error response from daemon: Get \"https://git.zju.edu.cn:5050/v2/\": EOF\n</code></pre> </li> <li> <p>\u539f\u56e0\uff1a</p> <p>\u7f51\u7edc\u95ee\u9898\uff0cDocker Daemon \u65e0\u6cd5\u8fde\u63a5\u5230 ZJU Git\u3002\u8fd9\u5f80\u5f80\u662f\u7531\u4e8e\u4ee3\u7406\u8bbe\u7f6e\u4e0d\u6b63\u786e\u5bfc\u81f4\u7684\u3002</p> <p>\u4f7f\u7528 Windows Docker Desktop \u7684\u540c\u5b66\u53cd\u6620\uff0c\u5373\u4f7f\u81ea\u5df1\u5173\u95ed\u4e86 Clash\uff0c\u4ee3\u7406\u8bbe\u7f6e\u4e5f\u4f1a\u6b8b\u7559\u5728 Docker Desktop \u4e2d\uff0c\u8fd0\u884c <code>docker info</code> \u53ef\u4ee5\u770b\u5230\u4e0b\u9762\u7684\u5185\u5bb9\uff1a</p> <pre><code>HTTP Proxy: ...\nHTTPS Proxy: ...\n</code></pre> </li> <li> <p>\u89e3\u51b3\u529e\u6cd5\uff1a</p> <ul> <li>Windows Docker Desktop \u7528\u6237\uff1a\u5728 Docker Desktop \u8bbe\u7f6e\u754c\u9762\u8fdb\u5165 <code>Resources</code> -&gt; <code>Proxies</code>\uff0c\u6253\u5f00 <code>Manual proxy configuration</code>\uff0c\u5c06\u6240\u6709\u4ee3\u7406\u8bbe\u7f6e\u7559\u7a7a\uff0c\u7136\u540e\u70b9\u51fb <code>Apply</code>\uff0c\u91cd\u542f Docker Desktop\u3002</li> </ul> </li> </ul> <p>\u5b8c\u6210\u6761\u4ef6</p> <ul> <li>\u7406\u89e3\u5bb9\u5668\u548c Docker \u662f\u4ec0\u4e48\u3002</li> <li>\u6210\u529f\u5b89\u88c5 Docker\uff0c\u5e76\u80fd\u5728\u7ec8\u7aef\u8fd0\u884c <code>docker info</code>\u3002</li> <li>\u638c\u63e1 <code>run</code>\u3001<code>ps</code>\u3001<code>rm</code>\u3001<code>pull</code> \u7b49\u5e38\u7528 Docker \u547d\u4ee4\u3002</li> </ul>"},{"location":"manual/#\u4f7f\u7528-docker-compose","title":"\u4f7f\u7528 Docker Compose","text":"<p>\u5728\u65e5\u5e38\u5f00\u53d1\u4e2d\uff0c\u5982\u679c\u76f4\u63a5\u4f7f\u7528 <code>docker run</code> \u542f\u52a8\u5bb9\u5668\uff0c\u547d\u4ee4\u53ef\u80fd\u4f1a\u975e\u5e38\u5197\u957f\uff0c\u9700\u8981\u624b\u52a8\u6307\u5b9a\u955c\u50cf\u3001\u7aef\u53e3\u3001\u6302\u8f7d\u3001\u73af\u5883\u53d8\u91cf\u7b49\u53c2\u6570\uff0c\u65e2\u4e0d\u76f4\u89c2\uff0c\u4e5f\u4e0d\u65b9\u4fbf\u7ef4\u62a4\u3002\u4ee5\u672c\u8bfe\u7a0b\u7684\u5b9e\u9a8c\u73af\u5883\u4e3a\u4f8b\uff0c\u5b8c\u6574\u7684 <code>docker run</code> \u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code>docker run -dit \\\n    --name zju-os-code \\\n    --hostname zju-os \\\n    -v \"$(pwd)\":/zju-os/code \\\n    -v ~/.gitconfig:/root/.gitconfig:ro \\\n    -v ~/.ssh:/mnt/host_ssh:ro \\\n    -w /zju-os/code \\\n    -e UV_LINK_MODE=copy \\\n    -e TZ=Asia/Shanghai \\\n    --init \\\n    git.zju.edu.cn:5050/zju-cs-lab/tool/sys:latest \\\n    sleep infinity\n</code></pre> <p>Docker Compose \u63d0\u4f9b\u4e86\u4e00\u79cd\u66f4\u7b80\u5355\u7684\u65b9\u5f0f\uff1a\u53ea\u9700\u5728\u4e00\u4e2a <code>compose.yml</code> \u6587\u4ef6\u91cc\u5b9a\u4e49\u597d\u670d\u52a1\u3001\u955c\u50cf\u548c\u914d\u7f6e\uff0c\u4e4b\u540e\u7528\u4e00\u6761 <code>docker compose up</code> \u547d\u4ee4\u5c31\u80fd\u542f\u52a8\u6574\u4e2a\u5f00\u53d1\u73af\u5883\u3002</p> <p>\u5728\u6211\u4eec\u7684\u4ed3\u5e93\u4e2d\uff0c\u5df2\u7ecf\u4e3a\u5927\u5bb6\u51c6\u5907\u597d\u4e86 <code>compose.yml</code>\uff0c\u91cc\u9762\u5b9a\u4e49\u4e86\u5bb9\u5668\u7684\u8fd0\u884c\u65b9\u5f0f\u548c\u4e00\u4e9b\u5fc5\u8981\u7684\u914d\u7f6e\u3002\u4e0b\u9762\u662f\u4e00\u4e9b\u91cd\u8981\u7684\u914d\u7f6e\u70b9\uff0c\u540c\u5b66\u4eec\u9700\u8981\u77e5\u6089\uff1a</p> <ol> <li> <p>\u4ee3\u7801\u6302\u8f7d</p> <p>\u4ee3\u7801\u5e93\u4f1a\u88ab\u6302\u8f7d\uff08mount\uff09\u5230\u5bb9\u5668\u5185\u7684 <code>/zju-os/code</code> \u76ee\u5f55\u4e0b\u3002 \u8fd9\u610f\u5473\u7740\uff1a</p> <ul> <li>\u5bbf\u4e3b\u673a\u548c\u5bb9\u5668\u5171\u4eab\u540c\u4e00\u5957\u4ee3\u7801\u6587\u4ef6\uff0c\u4fee\u6539\u4f1a\u5b9e\u65f6\u540c\u6b65\u3002</li> <li>\u4ee3\u7801\u6587\u4ef6\u5b9e\u9645\u4ecd\u4fdd\u5b58\u5728\u5bbf\u4e3b\u673a\u4e0a\uff0c\u5220\u9664\u5bb9\u5668\u4e0d\u4f1a\u5bfc\u81f4\u4ee3\u7801\u4e22\u5931\u3002</li> </ul> <p>\u8fd9\u6837\u505a\u7684\u597d\u5904\u662f\uff0c\u5927\u5bb6\u5728\u5bb9\u5668\u5185\u5f00\u53d1\u65f6\uff0c\u65e0\u9700\u62c5\u5fc3\u6570\u636e\u6301\u4e45\u5316\u95ee\u9898\uff0c\u8c03\u8bd5\u4f53\u9a8c\u548c\u672c\u5730\u51e0\u4e4e\u4e00\u6837\u3002</p> </li> <li> <p>\u7528\u6237\u4e0e\u6587\u4ef6\u6743\u9650</p> <p>\u5bb9\u5668\u5185\u9ed8\u8ba4\u7528\u6237\u662f <code>root</code>\uff0c\u800c\u5bbf\u4e3b\u673a\u4e0a\u4f60\u4e00\u822c\u662f\u666e\u901a\u7528\u6237\u3002 \u5f53\u4f60\u5728\u5bb9\u5668\u5185\u751f\u6210\u6587\u4ef6\uff08\u6bd4\u5982\u7f16\u8bd1\u4ea7\u7269\uff09\u65f6\uff0c\u8fd9\u4e9b\u6587\u4ef6\u5728\u5bbf\u4e3b\u673a\u4e0a\u4f1a\u663e\u793a\u4e3a <code>root</code> \u6240\u6709\uff0c\u8fd9\u53ef\u80fd\u4f1a\u5bfc\u81f4\u4f60\u5728\u5bbf\u4e3b\u673a\u76f4\u63a5\u7f16\u8f91\u6216\u5220\u9664\u6587\u4ef6\u65f6\u9047\u5230\u6743\u9650\u4e0d\u8db3\u7684\u95ee\u9898\u3002</p> <p>\u89e3\u51b3\u65b9\u6cd5\uff1a\u5728\u5bbf\u4e3b\u673a\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u628a\u6587\u4ef6\u7684\u6240\u6709\u8005\u6539\u56de\u666e\u901a\u7528\u6237\uff1a</p> <pre><code>sudo chown -R &lt;username&gt;:&lt;username&gt; .\n</code></pre> <p>\u8bf7\u5c06 <code>&lt;username&gt;</code> \u66ff\u6362\u4e3a\u4f60\u5728\u5bbf\u4e3b\u673a\u4e0a\u7684\u7528\u6237\u540d\u3002</p> </li> <li> <p>Git \u548c SSH \u914d\u7f6e\u6620\u5c04</p> <p>\u7279\u522b\u5730\uff0c\u6267\u884c\u4e00\u4e9b Git \u64cd\u4f5c\u4e5f\u4f1a\u4ea7\u751f\u6587\u4ef6\uff0c\u56e0\u6b64\u4f1a\u4ea7\u751f\u8fd9\u6837\u7684\u60c5\u51b5\uff1a\u5728\u5bb9\u5668\u5185\u6267\u884c Git \u64cd\u4f5c\u540e\uff0c\u5728\u5bbf\u4e3b\u673a\u6267\u884c Git \u64cd\u4f5c\u9047\u5230 Permission Denied\u3002\u6240\u4ee5\u6211\u4eec\u5c06\u5bbf\u4e3b\u673a\u7684 Git \u548c SSH \u914d\u7f6e\u6620\u5c04\u5230\u5bb9\u5668\u5185\uff0c\u8fd9\u6837\u540c\u5b66\u4eec\u7684\u5f00\u53d1\u3001Git \u64cd\u4f5c\u90fd\u5728\u5bb9\u5668\u5185\u8fdb\u884c\uff0c\u4e0d\u7528\u56de\u5230\u5bbf\u4e3b\u673a\u4e86\u3002</p> <p>\u4e3a\u6b64\uff0c\u6211\u4eec\u5728 <code>compose.yml</code> \u4e2d\u505a\u4e86\u4ee5\u4e0b\u5904\u7406\uff1a</p> <ul> <li>\u5c06\u5bbf\u4e3b\u673a\u7684 <code>~/.gitconfig</code> \u548c <code>~/.ssh</code> \u6302\u8f7d\u5230\u5bb9\u5668\u5185\u3002</li> </ul> <p>\u8fd9\u9700\u8981\u4f60\u786e\u4fdd\u4f60\u5728\u5bbf\u4e3b\u673a\u4e0a\u5df2\u7ecf\u914d\u7f6e\u597d Git \u7528\u6237\u4fe1\u606f\u548c SSH Key\uff08\u89c1\u524d\u6587\uff09\u3002</p> </li> </ol> <p>\u540c\u5b66\u4eec\u4e5f\u9700\u8981\u4e86\u89e3\u4e00\u4e9b\u5e38\u7528\u7684 Docker Compose \u547d\u4ee4\uff1a</p> <ul> <li> <p>\u542f\u52a8\u5e76\u8fdb\u5165\u5bb9\u5668\uff1a</p> <pre><code>docker compose up -d\ndocker compose exec zju-os-code fish\n</code></pre> <p>\u8fd9\u4e24\u6761\u547d\u4ee4\u4f1a\u542f\u52a8\u5bb9\u5668\uff0c\u5e76\u8fdb\u5165\u5bb9\u5668\u5185\u7684 fish \u7ec8\u7aef\u3002</p> <ul> <li><code>-d</code> \u8868\u793a\u540e\u53f0\u8fd0\u884c\u5bb9\u5668\u3002</li> <li><code>zju-os-code</code> \u662f <code>compose.yml</code> \u4e2d\u5b9a\u4e49\u7684\u670d\u52a1\u540d\u3002</li> </ul> </li> <li> <p>\u505c\u6b62\u5e76\u5220\u9664\u5bb9\u5668\uff1a</p> <pre><code>docker compose down\n</code></pre> </li> </ul> <p>\u5b8c\u6210\u6761\u4ef6</p> <ul> <li>\u6210\u529f\u5b89\u88c5 Docker Compose\uff0c\u5e76\u80fd\u5728\u7ec8\u7aef\u8fd0\u884c <code>docker compose version</code>\u3002</li> </ul> <p>\u8fdb\u4e00\u6b65\u5730\uff0c\u8bfe\u7a0b\u4ed3\u5e93\u6839\u76ee\u5f55\u4e0b\u7684 <code>Makefile</code> \u5c06\u5e38\u7528\u64cd\u4f5c\u5305\u88c5\u4e3a Make \u76ee\u6807\uff0c\u65b9\u4fbf\u8fd0\u884c\u3002\u5b83\u4f1a\u68c0\u6d4b\u5f53\u524d\u73af\u5883\u662f\u5426\u5b58\u5728 <code>docker</code> \u547d\u4ee4\uff0c\u5982\u679c\u5b58\u5728\u5c31\u8ba4\u4e3a\u662f\u5bbf\u4e3b\u673a\uff0c\u5426\u5219\u8ba4\u4e3a\u662f\u5728\u5bb9\u5668\u5185\u8fd0\u884c\u3002\u4e0d\u540c\u73af\u5883\u4e0b\u7684\u76ee\u6807\u6709\u6240\u4e0d\u540c\uff1a</p> <ul> <li>\u5728\u5bbf\u4e3b\u673a\u4e0a<ul> <li>\uff08\u9ed8\u8ba4\u76ee\u6807\uff09<code>all</code>\uff1a\u521b\u5efa\u3001\u542f\u52a8\u5e76\u8fdb\u5165\u5bb9\u5668</li> <li><code>clean</code>\uff1a\u5220\u9664\u5bb9\u5668</li> <li><code>update</code>\uff1a\u5220\u9664\u5e76\u66f4\u65b0\u5bb9\u5668\u955c\u50cf</li> </ul> </li> <li>\u5728\u5bb9\u5668\u5185<ul> <li><code>all</code>\uff1a<code>clean</code> \u5e76\u6784\u5efa\u5185\u6838</li> <li><code>clean</code>\uff1a\u6e05\u7406\u6784\u5efa\u4ea7\u7269</li> <li><code>run</code>\uff1a\u4f7f\u7528 QEMU \u8fd0\u884c\u5185\u6838</li> <li><code>debug</code>\uff1a\u4f7f\u7528 QEMU \u8fd0\u884c\u5185\u6838\uff08\u8c03\u8bd5\uff09</li> <li><code>gdb</code>\uff1a\u542f\u52a8 GDB \u5e76\u8fde\u63a5\u5230 QEMU\uff08\u4e0e <code>debug</code> \u914d\u5408\u4f7f\u7528\uff09</li> <li><code>judge</code>\uff1a\u8fd0\u884c\u8bc4\u6d4b</li> <li><code>format</code>\uff1a\u683c\u5f0f\u5316\u4ee3\u7801\uff0c\u8bf7\u5728\u63d0\u4ea4\u4ee3\u7801\u524d\u8fd0\u884c</li> </ul> </li> </ul>"},{"location":"manual/#\u4f7f\u7528-ide-\u62c9\u8d77-devcontainer","title":"\u4f7f\u7528 IDE \u62c9\u8d77 DevContainer","text":"<p>Development containers \u662f\u4e00\u4e2a\u7531 Microsoft \u5f00\u6e90\u7684\u9879\u76ee\uff0c\u65e8\u5728\u901a\u8fc7 <code>devcontainer.json</code> \u6587\u4ef6\u5b9a\u4e49\u548c\u914d\u7f6e\u5f00\u53d1\u5bb9\u5668\u73af\u5883\u3002\u5b83\u4e0e Docker Compose \u7c7b\u4f3c\uff0c\u4f46\u4e0d\u7528\u4e8e\u547d\u4ee4\u884c\uff0c\u800c\u662f\u4e13\u6ce8\u4e8e\u5f00\u53d1\u73af\u5883\u7684\u914d\u7f6e\u548c\u96c6\u6210\uff0c\u76ee\u524d VSCode\u3001CLion \u7b49 IDE \u90fd\u652f\u6301\u5b83\u3002</p> <p>\u5728\u6211\u4eec\u7684\u4ed3\u5e93\u4e2d\uff0c\u5df2\u7ecf\u4e3a\u5927\u5bb6\u51c6\u5907\u597d\u4e86 <code>.devcontainer/devcontainer.json</code> \u6587\u4ef6\u3002\u5b83\u4f1a\u4f7f\u7528\u4e0a\u4e00\u8282\u4ecb\u7ecd\u7684 <code>compose.yml</code> \u62c9\u8d77\u5bb9\u5668\u73af\u5883\uff0c\u5e76\u81ea\u52a8\u4e3a IDE \u6267\u884c\u5404\u9879\u914d\u7f6e\u3002</p> <p>\u975e VSCode \u7528\u6237\u8bf7\u81ea\u884c\u67e5\u770b\u5bf9\u5e94 IDE \u7684\u6587\u6863\uff1a</p> <ul> <li>Dev Containers | CLion Documentation</li> <li>Supporting tools and services | DevContainers</li> </ul> <p>\u4e0b\u9762\u4ee5 VSCode \u4e3a\u4f8b\u4ecb\u7ecd\u4f7f\u7528\u6d41\u7a0b\u3002</p> <ul> <li>VSCode \u5b89\u88c5 Dev Containers \u63d2\u4ef6</li> <li>VSCode \u6253\u5f00\u5b9e\u9a8c\u4ed3\u5e93</li> <li> <p>\u53f3\u4e0b\u89d2\u53ef\u80fd\u4f1a\u51fa\u73b0\u5f00\u53d1\u5bb9\u5668\uff08Dev Container\uff09\u76f8\u5173\u7684\u5f39\u7a97\uff0c\u70b9\u51fb\u5728\u5f00\u53d1\u5bb9\u5668\u4e2d\u6253\u5f00</p> <p>\u5982\u679c\u6ca1\u6709\u5f39\u7a97\uff0c\u5219\u6309 Ctrl+Shift+P \u6253\u5f00\u547d\u4ee4\u7a97\u53e3\uff0c\u8f93\u5165 <code>reopen</code> \u627e\u5230 <code>Dev Containers: Reopen in Container</code> \u9009\u9879\uff0c\u9009\u62e9\u5b83</p> <p>Tip</p> <p>VSCode \u662f\u4ece\u5f53\u524d\u6253\u5f00\u7684\u6587\u4ef6\u5939\u627e <code>.devcontainer</code> \u7684\uff0c\u6240\u4ee5\u8bf7\u786e\u4fdd VSCode \u5f53\u524d\u6253\u5f00\u4e86\u5b9e\u9a8c\u4ed3\u5e93\u7684\u6839\u76ee\u5f55\u3002</p> <p>\u5982\u679c\u9009\u62e9 <code>Reopen in Container</code> \u540e VSCode \u5f39\u51fa\u4e86\u9009\u62e9\u5bb9\u5668\u4e4b\u7c7b\u7684\u7a97\u53e3\uff0c\u8bf4\u660e\u4f60\u6ca1\u6709\u6253\u5f00\u6b63\u786e\u7684\u76ee\u5f55\u3002\u8bf7\u5c1d\u8bd5\u5173\u95ed VSCode \u91cd\u65b0\u6253\u5f00\u3002</p> </li> <li> <p>VSCode \u5c06\u91cd\u8f7d\u7a97\u53e3\uff0c\u542f\u52a8\u5e76\u8fde\u63a5\u5230\u5bb9\u5668\uff0c\u81ea\u52a8\u5b8c\u6210\u63d2\u4ef6\u5b89\u88c5\u7b49\u914d\u7f6e\u6b65\u9aa4</p> <p>Tip</p> <p>\u53f3\u4e0b\u89d2\u5e94\u8be5\u4f1a\u6709\u5f39\u7a97\u8868\u793a\u5f00\u53d1\u5bb9\u5668\u6b63\u5728\u542f\u52a8\uff0c\u4f60\u53ef\u4ee5\u70b9\u51fb\u67e5\u770b\u65e5\u5fd7\u4e86\u89e3\u542f\u52a8\u8fdb\u5ea6\u3002</p> <p>\u5982\u679c\u6ca1\u6709\u4f60\u6267\u884c\u524d\u8ff0\u7684 <code>docker pull</code> \u7b49\u64cd\u4f5c\uff0c\u90a3\u4e48 DevContainer \u4f1a\u62c9\u53d6\u955c\u50cf\u3002\u5b9e\u9a8c\u955c\u50cf\u6bd4\u8f83\u5927\uff08\u7ea6 10G\uff09\uff0c\u4f60\u53ef\u4ee5\u7ed3\u5408\u81ea\u5df1\u7684\u7f51\u901f\u8bc4\u4f30\u4e00\u4e0b\u9700\u8981\u7684\u62c9\u53d6\u65f6\u95f4\uff0c\u8010\u5fc3\u7b49\u5f85\u3002</p> </li> </ul>"},{"location":"manual/#part-2\u5bb9\u5668\u5b9e\u9a8c\u73af\u5883","title":"Part 2\uff1a\u5bb9\u5668\u5b9e\u9a8c\u73af\u5883","text":"<p>\u73b0\u5728\u4f60\u5e94\u8be5\u5df2\u7ecf\u4f7f\u7528 IDE \u8fdb\u5165\u4e86 DevContainer \u73af\u5883\uff0c\u63a5\u4e0b\u6765\u7684\u64cd\u4f5c\u90fd\u5728\u5bb9\u5668\u5185\u8fdb\u884c\u3002</p>"},{"location":"manual/#\u6e90\u4ee3\u7801\u7ba1\u7406","title":"\u6e90\u4ee3\u7801\u7ba1\u7406","text":"<p>\u672c\u6587\u6863\u4ec5\u4f1a\u4ecb\u7ecd\u5b9e\u9a8c\u4e2d\u5fc5\u8981\u7684 Git \u77e5\u8bc6\u3002\u5982\u679c\u4f60\u60f3\u6df1\u5165\u5b66\u4e60 Git\uff0c\u53ef\u4ee5\u9605\u8bfb\u8fd9\u672c\u5b98\u65b9\u6559\u7a0b\uff1a\u82f1\u6587\u7248 Git\u3001\u4e2d\u6587\u7248 Pro Git \u4e2d\u6587\u7248\uff08\u7b2c\u4e8c\u7248\uff09\u3002</p>"},{"location":"manual/#vscode-git-\u63d2\u4ef6","title":"VSCode Git \u63d2\u4ef6","text":"<p>\u63a8\u8350\u4f7f\u7528 VSCode \u5185\u7f6e\u7684 Git\uff08\u6e90\u4ee3\u7801\u7ba1\u7406\u9762\u677f\uff09\u8fdb\u884c\u76f8\u5173\u64cd\u4f5c\uff0c\u5b98\u65b9\u6587\u6863\u89c1 Using Git source control in VS Code\u3002</p> <p>\u6b64\u5916\uff0c\u4f60\u8fd8\u53ef\u4ee5\u5b89\u88c5 Git Graph \u63d2\u4ef6\u6765\u53ef\u89c6\u5316\u5730\u67e5\u770b\u5206\u652f\u3001\u63d0\u4ea4\u7b49\u4fe1\u606f\uff0c\u8fdb\u884c Git \u64cd\u4f5c\u3002</p>"},{"location":"manual/#git-submodule","title":"Git Submodule","text":"<p>\u5b9e\u9a8c\u8bc4\u6d4b\u6846\u67b6\u4f5c\u4e3a Git Submodule \u653e\u7f6e\u5728\u8bfe\u7a0b\u4ee3\u7801\u4ed3\u5e93\u7684 <code>autograder</code> \u76ee\u5f55\u4e0b\uff0c\u6240\u4ee5\u540c\u5b66\u4eec\u9700\u8981\u4e86\u89e3 Submodule \u7684\u57fa\u672c\u4f7f\u7528\u65b9\u6cd5\uff0c\u8be6\u89c1\u5b98\u65b9\u6559\u7a0b Git - Submodules\u3002\u7b80\u5355\u6765\u8bf4\uff1a</p> <ul> <li>Submodule \u4e2d\u5185\u5bb9\u4f5c\u4e3a\u4e00\u4e2a\u72ec\u7acb\u7684 Git \u4ed3\u5e93\u7ba1\u7406\uff0c\u7236\u4ed3\u5e93\u53ea\u8bb0\u5f55 Submodule \u7684\u67d0\u4e2a\u63d0\u4ea4 ID\u3002</li> <li> <p><code>git clone</code> \u540e\u8fd8\u9700\u8981\u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u521d\u59cb\u5316\u5e76\u66f4\u65b0 Submodule\uff1a</p> <pre><code>git submodule update --init --recursive\n</code></pre> </li> </ul>"},{"location":"manual/#git-merge-\u4e0e-rebase","title":"Git Merge \u4e0e Rebase","text":"<p>\u5728\u5b9e\u9a8c\u8fc7\u7a0b\u4e2d\uff0c\u4f60\u9700\u8981\u4e0d\u65ad\u5730\u5c06\u4e0a\u6e38\u7684\u5b9e\u9a8c\u4ee3\u7801\u5408\u5e76\u5230\u81ea\u5df1\u7684\u5206\u652f\u4e2d\u3002\u5e38\u89c1\u7684\u505a\u6cd5\u6709\u4e24\u79cd\uff1aMerge \u548c Rebase\u3002</p> <ul> <li> <p>Merge\uff1a\u5c06\u4e0a\u6e38\u5206\u652f\u7684\u6700\u65b0\u63d0\u4ea4\u5408\u5e76\u5230\u5f53\u524d\u5206\u652f\uff0c\u4fdd\u7559\u4e24\u6761\u5206\u652f\u7684\u5386\u53f2\u8bb0\u5f55\uff0c\u5f62\u6210\u4e00\u4e2a\u65b0\u7684\u5408\u5e76\u63d0\u4ea4\u3002</p> <pre><code>git merge upstream/labN\n</code></pre> </li> <li> <p>Rebase\uff1a\u5c06\u5f53\u524d\u5206\u652f\u7684\u63d0\u4ea4\u201c\u642c\u8fd0\u201d\u5230\u4e0a\u6e38\u5206\u652f\u7684\u6700\u65b0\u63d0\u4ea4\u4e4b\u540e\uff0c\u5f62\u6210\u4e00\u6761\u7ebf\u6027\u7684\u63d0\u4ea4\u5386\u53f2\u3002</p> <pre><code>git rebase upstream/labN\n</code></pre> </li> </ul>"},{"location":"manual/#\u672c\u8bfe\u7a0b\u7684-git-\u5de5\u4f5c\u6d41","title":"\u672c\u8bfe\u7a0b\u7684 Git \u5de5\u4f5c\u6d41","text":"<p>\u5b9e\u9a8c\u8fc7\u7a0b\u6d89\u53ca\u4e24\u4e2a\u4ed3\u5e93\uff1a</p> <ul> <li>\u516c\u5f00\u53d1\u5e03\u4ed3\u5e93\uff1a <code>https://git.zju.edu.cn/os/code.git</code><ul> <li><code>lab0</code>\u3001<code>lab1</code>\u3001... \u5206\u652f\uff1a\u5404\u4e2a Lab \u7684\u4ee3\u7801\uff0c\u4f4d\u4e8e\u540c\u4e00\u4e2a\u7ebf\u6027\u5386\u53f2\uff08linear history\uff09\u4e0a\u3002</li> </ul> </li> <li>\u5b66\u751f\u79c1\u6709\u4ed3\u5e93\uff1a <code>git@git.zju.edu.cn:os/&lt;\u5b66\u671f&gt;/&lt;\u6559\u5b66\u73ed&gt;/os-&lt;\u4f60\u7684\u5b66\u53f7&gt;.git</code><ul> <li><code>lab0</code>\u3001<code>lab1</code>\u3001... \u5206\u652f\uff1a\u5b66\u751f\u63d0\u4ea4\u7684\u4ee3\u7801\u3002\u8fd9\u4e9b\u5206\u652f\u8bbe\u7f6e\u4e86\u4fdd\u62a4\u7b56\u7565\uff0c\u7981\u6b62\u5f3a\u5236\u63a8\u9001\uff0cDDL \u622a\u6b62\u540e\u65e0\u6cd5\u518d\u5411\u5bf9\u5e94\u5206\u652f\u63d0\u4ea4\u4ee3\u7801\uff0c\u6210\u7ee9\u8bc4\u5b9a\u4ee5\u5bf9\u5e94\u5206\u652f\u7684\u4ee3\u7801\u4e3a\u51c6\u3002</li> <li><code>lab0-makeup</code>\u3001<code>lab1-makeup</code>\u3001... \u5206\u652f\uff1a\u8865\u4ea4\u5206\u652f\uff0cDDL \u622a\u6b62\u540e\u4f60\u53ef\u4ee5\u7ee7\u7eed\u5411\u8fd9\u4e9b\u5206\u652f\u63d0\u4ea4\u4ee3\u7801\uff0c\u52a9\u6559\u4f1a\u5728\u671f\u672b\u8fdb\u884c\u7edf\u4e00\u8bc4\u5b9a</li> </ul> </li> </ul> <p>\u4e0b\u56fe\u5c55\u793a\u4e86\u672c\u8bfe\u7a0b\u7684 Git \u5de5\u4f5c\u6d41\u548c\u76f8\u5e94\u547d\u4ee4\uff1a</p> <p></p> <p>\u5176\u4e2d\u4ece\u4e0a\u6e38\u5408\u5e76\u4ee3\u7801\u7684\u6b65\u9aa4\u53ef\u80fd\u9047\u5230\u51b2\u7a81\uff0c\u4f60\u9700\u8981\u7406\u89e3\u51b2\u7a81\u90e8\u5206\u7684\u4ee3\u7801\uff0c\u5e76\u9009\u62e9\u5408\u9002\u7684\u89e3\u51b3\u529e\u6cd5\u3002</p>"},{"location":"manual/#\u5f00\u53d1","title":"\u5f00\u53d1","text":""},{"location":"manual/#clangd","title":"Clangd","text":"<p>VSCode \u81ea\u5e26\u7684 C/C++ \u63d2\u4ef6 IntelliSense \u89e3\u6790\u65f6\u5bb9\u6613\u53d7\u5230\u7cfb\u7edf\u5934\u6587\u4ef6\u7684\u5f71\u54cd\uff0c\u5bfc\u81f4\u62a5\u9519\uff0c\u5728\u5185\u6838\u7f16\u7a0b\u7b49\u7279\u6b8a\u573a\u666f\u4e0b\u8868\u73b0\u4e0d\u4f73\u3002\u6211\u4eec\u63a8\u8350\u4f7f\u7528\u5982\u4e0b\u5de5\u5177\uff1a</p> <ul> <li>clangd\uff1a\u4e00\u4e2a\u57fa\u4e8e LLVM \u7684 C/C++ \u8bed\u8a00\u670d\u52a1\u5668\uff0c\u63d0\u4f9b\u667a\u80fd\u8865\u5168\u3001\u8bed\u6cd5\u68c0\u67e5\u7b49\u529f\u80fd\u3002\u5b83\u76f4\u63a5\u4f7f\u7528\u7f16\u8bd1\u547d\u4ee4\u751f\u6210\u7684\u7f16\u8bd1\u6570\u636e\u5e93 <code>compile_commands.json</code>\uff0c\u80fd\u51c6\u786e\u5730\u89e3\u6790\u4ee3\u7801\u5173\u8054\u3002</li> <li>bear\uff1a\u4e00\u4e2a\u751f\u6210 <code>compile_commands.json</code> \u7684\u5de5\u5177\uff0c\u80fd\u5c06 Makefile \u751f\u6210\u7684\u7f16\u8bd1\u547d\u4ee4\u8f6c\u6362\u4e3a JSON \u683c\u5f0f\uff0c\u4f9b clangd \u4f7f\u7528\u3002</li> </ul> <p>\u8fd9\u4e9b\u5de5\u5177\u5df2\u7ecf\u5728\u5b9e\u9a8c\u73af\u5883\u4e2d\u914d\u7f6e\u597d\u3002</p> FAQ\uff1aclangd \u65e0\u6cd5\u6b63\u5e38\u5de5\u4f5c <ul> <li> <p>\u73b0\u8c61\uff1a</p> <p>VSCode Clangd \u63d2\u4ef6\u62a5\u9519\uff0c\u63d0\u793a\u627e\u4e0d\u5230\u5934\u6587\u4ef6\u6216\u8bed\u6cd5\u89e3\u6790\u9519\u8bef\u7b49\uff0c\u4f46\u4f60\u786e\u8ba4\u8be5\u9519\u8bef\u4e0d\u5e94\u5b58\u5728\u3002</p> </li> <li> <p>\u539f\u56e0\uff1a</p> <p>\u8fd9\u5f80\u5f80\u662f\u56e0\u4e3a Clangd \u6ca1\u6709\u91cd\u5efa\u7d22\u5f15\u3002</p> </li> <li> <p>\u89e3\u51b3\u529e\u6cd5\uff1a</p> <p>\u6309 Ctrl+Shift+P\uff0c\u8f93\u5165 <code>clangd</code>\uff0c\u70b9\u51fb <code>clangd: Restart language server</code> \u91cd\u8f7d\u8bed\u6cd5\u89e3\u6790\u5668\u3002</p> </li> </ul>"},{"location":"manual/#\u6784\u5efa\u548c\u8fd0\u884c","title":"\u6784\u5efa\u548c\u8fd0\u884c","text":""},{"location":"manual/#makefile","title":"Makefile","text":"<p>\u4e0a\u6587\u5df2\u7ecf\u63d0\u5230\uff0c\u4ed3\u5e93\u6839\u76ee\u5f55\u4e0b\u7684 <code>Makefile</code> \u5c06\u5e38\u7528\u64cd\u4f5c\u5305\u88c5\u4e3a Make \u76ee\u6807\uff0c\u65b9\u4fbf\u8fd0\u884c\u3002\u4f60\u53ef\u4ee5\u5728\u5bb9\u5668\u5185\u7684\u7ec8\u7aef\u4e2d\u76f4\u63a5\u8fd0\u884c <code>make</code> \u547d\u4ee4\u6765\u6267\u884c\u76f8\u5e94\u7684\u64cd\u4f5c\u3002</p> <ul> <li><code>all</code>\uff1a<code>clean</code> \u5e76\u6784\u5efa\u5185\u6838</li> <li><code>clean</code>\uff1a\u6e05\u7406\u6784\u5efa\u4ea7\u7269</li> <li><code>run</code>\uff1a\u4f7f\u7528 QEMU \u8fd0\u884c\u5185\u6838</li> <li><code>debug</code>\uff1a\u4f7f\u7528 QEMU \u8fd0\u884c\u5185\u6838\uff08\u8c03\u8bd5\uff09</li> <li><code>gdb</code>\uff1a\u542f\u52a8 GDB \u5e76\u8fde\u63a5\u5230 QEMU\uff08\u4e0e <code>debug</code> \u914d\u5408\u4f7f\u7528\uff09</li> <li><code>judge</code>\uff1a\u8fd0\u884c\u8bc4\u6d4b</li> <li><code>format</code>\uff1a\u683c\u5f0f\u5316\u4ee3\u7801\uff0c\u8bf7\u5728\u63d0\u4ea4\u4ee3\u7801\u524d\u8fd0\u884c</li> </ul>"},{"location":"manual/#qemu","title":"QEMU","text":"<p>\u5728 Lab0 \u4ecb\u7ecd\u3002</p>"},{"location":"manual/#\u8c03\u8bd5","title":"\u8c03\u8bd5","text":""},{"location":"manual/#gdb","title":"GDB","text":"<p>\u5728 Lab0 \u4ecb\u7ecd\u3002</p>"},{"location":"manual/#vscode-\u8c03\u8bd5\u5668","title":"VSCode \u8c03\u8bd5\u5668","text":"<p>VSCode \u81ea\u5e26\u7684\u8c03\u8bd5\u5668\u754c\u9762\u80fd\u591f\u5bf9\u63a5 GDB \u7b49\u8c03\u8bd5\u5668\uff0c\u65b9\u4fbf\u5730\u8fdb\u884c\u5404\u7c7b\u64cd\u4f5c\uff0c\u6bd4\u5982\u8bbe\u7f6e\u65ad\u70b9\u3001\u5355\u6b65\u6267\u884c\u3001\u67e5\u770b\u6570\u636e\u548c\u6c47\u7f16\u6307\u4ee4\u7b49\u3002\u5b98\u65b9\u4f7f\u7528\u6587\u6863\u89c1 Debug code with Visual Studio Code\uff0c\u5b98\u65b9\u914d\u7f6e\u6587\u6863\u89c1 Visual Studio Code debug configuration\u3002</p> <p>\u63a8\u8350\u540c\u5b66\u4eec\u4f7f\u7528 VSCode GUI \u8c03\u8bd5\uff0c\u8fd9\u6837\u4f1a\u6bd4 GDB \u547d\u4ee4\u66f4\u52a0\u9ad8\u6548\u3002\u4f46\u662f\uff0c\u5728\u865a\u62df\u5185\u5b58\u7b49\u5b9e\u9a8c\u4e2d\uff0c\u53ef\u80fd\u9047\u5230\u4ee3\u7801\u5b9e\u73b0\u4e0d\u5b8c\u5584\u5bfc\u81f4 GDB \u65e0\u6cd5\u8c03\u8bd5\uff08GDB \u53d7\u865a\u62df\u5185\u5b58\u5f71\u54cd\uff09\uff0c\u8fd9\u65f6\u5019\u8bf7\u8bb0\u5f97 QEMU Monitor \u662f\u4f60\u7684\u6551\u547d\u7a3b\u8349\u3002</p> <p>\u5728\u6211\u4eec\u7684\u4ed3\u5e93\u4e2d\uff0c\u5df2\u7ecf\u4e3a\u5927\u5bb6\u51c6\u5907\u597d\u4e86 <code>.vscode/launch.json</code>\uff0c\u91cc\u9762\u5b9a\u4e49\u4e86\u8c03\u8bd5\u914d\u7f6e\u3002</p> <p>VSCode \u7684\u5b98\u65b9\u6587\u6863\u6f14\u793a\u4e86\u8c03\u8bd5\u5668\u7684\u57fa\u672c\u4f7f\u7528\uff0c\u5305\u62ec\uff1a\u542f\u52a8\u8c03\u8bd5\u3001\u8bbe\u7f6e\u65ad\u70b9\u3001\u67e5\u770b\u6570\u636e\u7b49\u3002\u4e0b\u9762\u5bf9\u672c\u8bfe\u7a0b\u7684\u4f7f\u7528\u505a\u4e00\u4e9b\u8865\u5145\uff1a</p> <ul> <li>\u542f\u52a8\u8c03\u8bd5\uff1a\u5728\u7ec8\u7aef\u4e2d <code>make debug</code> \u542f\u52a8 QEMU\uff0c\u518d\u70b9\u51fb VSCode \u8c03\u8bd5\u5668\u7684\u542f\u52a8\u6309\u94ae\uff0cVSCode \u4f1a\u4f7f\u7528\u4ed3\u5e93\u4e2d\u7684\u914d\u7f6e\u6587\u4ef6\u542f\u52a8 <code>gdb-multiarch</code> \u8fde\u63a5\u5230 QEMU \u5e76\u8fdb\u884c\u8c03\u8bd5\u3002</li> <li>\u67e5\u770b\u6c47\u7f16\uff1aCtrl+Shift+P \u6253\u5f00\u547d\u4ee4\u9762\u677f\uff0c\u8f93\u5165 <code>assem</code> \u627e\u5230 <code>Open Disassembly View</code>\u3002</li> </ul>"},{"location":"manual/#\u672c\u5730\u8bc4\u6d4b","title":"\u672c\u5730\u8bc4\u6d4b","text":"<p>\u8bf7\u540c\u5b66\u4eec\u5728\u672c\u5730\u901a\u8fc7\u8bc4\u6d4b\u540e\u518d\u63a8\u9001\u4ee3\u7801\u5230 ZJU Git</p> <p>\u8bc4\u6d4b\u6846\u67b6\u4f5c\u4e3a Git Submodule \u653e\u7f6e\u5728\u8bfe\u7a0b\u4ee3\u7801\u4ed3\u5e93\u7684 <code>autograder</code> \u76ee\u5f55\u4e0b\u3002<code>make judge</code> \u672c\u8d28\u4e0a\u8fd0\u884c\u4e86\u4e0b\u9762\u8fd9\u6761\u547d\u4ee4\uff1a</p> <pre><code>uv --project autograder run autograder [--lab labN]\n</code></pre> <p>uv \u662f\u4e00\u4e2a\u6d41\u884c\u7684 Python \u5305\u7ba1\u7406\u5668\uff0c\u8bc4\u6d4b\u6846\u67b6\u4f7f\u7528\u5b83\u7ba1\u7406\u73af\u5883\u5e76\u8fd0\u884c\u3002</p> <p>\u4e0d\u7ed9\u5b9a\u53c2\u6570\u7684\u60c5\u51b5\u4e0b\uff0c\u8bc4\u6d4b\u6846\u67b6\u4f1a\u68c0\u67e5\u5f53\u524d\u7684 Git \u5206\u652f\u540d\u5e76\u8fd0\u884c\u5bf9\u5e94\u7684\u5b9e\u9a8c\u8bc4\u6d4b\uff08\u4f8b\u5982 <code>lab1*</code> \u5206\u652f\u4f1a\u8fd0\u884c lab1 \u7684\u8bc4\u6d4b\uff09\u3002\u4e5f\u53ef\u4ee5\u901a\u8fc7 <code>--lab</code> \u53c2\u6570\u6307\u5b9a\u8981\u8fd0\u884c\u7684\u5b9e\u9a8c\u3002</p>"},{"location":"temp/","title":"Temp","text":"<ol> <li>\u5b9e\u73b0\u6700\u5c0f\u5316\u9875\u5f02\u5e38\u5904\u7406\uff1a\u8bc6\u522b\u7f3a\u9875\u6216\u8d8a\u6743\u5f02\u5e38\uff08<code>scause</code>\uff09\uff0c\u6253\u5370\u4e0a\u4e0b\u6587\u5e76\u91c7\u53d6\u5408\u7406\u7684\u9519\u8bef\u5904\u7406\u7b56\u7565\u3002    \uff08\u672c\u5b9e\u9a8c\u53ea\u6d89\u53ca\u5185\u6838\u6001\uff0c\u7528\u6237\u6001\u4e0e ELF \u88c5\u8f7d\u5c06\u5728 Lab4 \u5b9e\u73b0\u3002\uff09</li> </ol>"},{"location":"z1-spike/","title":"\u9644\u5f55 1\uff1aSpike \u5de5\u5177\u94fe","text":""},{"location":"z1-spike/#\u9644\u5f55-1spike-\u5de5\u5177\u94fe","title":"\u9644\u5f55 1\uff1aSpike \u5de5\u5177\u94fe","text":"<p>\u611f\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u6839\u636e\u672c\u6587\u6863\u81ea\u884c\u4f7f\u7528 spike \u5de5\u5177\u94fe\u8fd0\u884c RISC-V kernel\u3002</p> <p>\u7406\u8bba\u4e0a\uff0cSpike \u548c QEMU \u7684\u8fd0\u884c\u7ed3\u679c\u5e94\u5f53\u76f8\u540c\u3002\u5982\u679c\u4f60\u53d1\u73b0\u8fd0\u884c\u7ed3\u679c\u4e0d\u540c\u3001\u51fa\u9519\u7b49\u60c5\u51b5\uff0c\u8bf7\u5411\u52a9\u6559\u53cd\u9988\u5e76\u5e26\u4e0a\u4f60\u7684\u63a2\u7a76\u7ed3\u679c\uff0c\u53ef\u4ee5\u83b7\u5f97\u52a0\u5206\u3002</p>"},{"location":"z1-spike/#\u5de5\u5177\u94fe\u7b80\u4ecb","title":"\u5de5\u5177\u94fe\u7b80\u4ecb","text":""},{"location":"z1-spike/#spike","title":"Spike","text":"<p>Spike \u662f\u4e00\u4e2a\u548c QEMU \u7c7b\u4f3c\u7684\u6307\u4ee4\u6a21\u62df\u5668\u3002\u867d\u7136\u5b83\u4e0d\u50cf QEMU \u90a3\u6837\u652f\u6301\u5404\u79cd\u6307\u4ee4\u96c6\u67b6\u6784\uff0c\u53ef\u4ee5\u6a21\u62df\u590d\u6742\u7684\u5916\u8bbe\uff0c\u4f46\u662f\u5728 RISC-V \u7684\u6a21\u62df\u548c\u652f\u6301\u4e0a\uff0cspike \u662f\u9010\u6761\u6307\u4ee4\u8fdb\u884c\u6a21\u62df\uff0c\u4e14\u4e25\u683c\u6309\u7167 RISC-V \u7684\u6307\u4ee4\u96c6\u624b\u518c\uff0c\u5bf9\u4e8e RISC-V \u7a0b\u5e8f\u7684\u68c0\u67e5\u66f4\u4e3a\u4e25\u8c28\u3002</p> <p>\u7279\u522b\u662f\u5728\u9875\u8868\u7684\u5b9e\u9a8c\u4e2d\uff0cspike \u4f1a\u4e25\u8c28\u5f97\u591a\uff0c\u63a8\u8350\u6709\u7cbe\u529b\u7684\u540c\u5b66\u989d\u5916\u7528 spike \u8fd0\u884c\u8fdb\u884c\u6d4b\u8bd5</p> <p>QEMU \u4e3a\u4e86\u8ffd\u6c42\u8fd0\u884c\u7684\u9ad8\u6548\uff0c\u5f80\u5f80\u4f1a\u5c06\u6307\u4ee4\u5206\u5757\u6253\u5305\u7f16\u8bd1\u4e3a\u5bbf\u4e3b\u673a\u6307\u4ee4\u9ad8\u6548\u8fd0\u884c\uff1b\u800c spike \u5219\u9009\u62e9\u4e86\u6839\u636e RISC-V \u6307\u4ee4\u96c6\u5145\u5206\u6a21\u62df RISC-V \u4f53\u7cfb\u7ed3\u6784\u7684\u5404\u79cd\u786c\u4ef6\uff0c\u7136\u540e\u9010\u6761\u8fd0\u884c\u6307\u4ee4\uff0c\u5e76\u4fee\u6539\u5404\u4e2a\u6a21\u62df\u786c\u4ef6\uff0c\u5f53\u7136\u8fd9\u4e5f\u4f1a\u5bfc\u81f4 spike \u8fd0\u884c\u901f\u5ea6\u6bd4 qemu \u6162\u4e00\u4e9b\u3002</p> <p>\u5982\u679c\u540c\u5b66\u4eec\u60f3\u8981\u4e86\u89e3\u4e00\u4e9b RISC-V \u673a\u5236\u7684\u5177\u4f53\u5b9e\u73b0\uff0c\u76f4\u63a5\u9605\u8bfb spike \u7684\u6e90\u7801\u4e5f\u662f\u4e0d\u9519\u7684\u9009\u62e9\u3002</p>"},{"location":"z1-spike/#openocd","title":"OpenOCD","text":"<p>OpenOCD \u662f\u4e00\u4e2a\u8c03\u8bd5\u7684\u4e2d\u95f4\u5de5\u5177\u3002\u4e00\u4e9b RISC-V \u82af\u7247\u4e3a\u4e86\u65b9\u4fbf\u786c\u4ef6\u8c03\u8bd5\u5185\u90e8\u7684\u4fe1\u606f\u4f1a\u5728\u5185\u90e8\u96c6\u6210\u4e00\u4e2a debug module\uff0c\u5e76\u5bf9\u5916\u66b4\u9732\u4e00\u4e2a JTAG \u63a5\u53e3\u3002\u8c03\u8bd5\u8005\u53ef\u4ee5\u7528 JTAG \u7ebf\u7684\u8f93\u5165\u7ebf\u5411 debug module \u8f93\u5165\u547d\u4ee4\uff0c\u5e76\u7528\u8f93\u51fa\u7ebf\u5f97\u5230\u9700\u8981\u8bfb\u53d6\u7684\u7ed3\u679c\u3002\u8fd9\u4e2a\u6307\u4ee4\u4f20\u8f93\u534f\u8bae\u662f\u590d\u6742\u7684\uff0c\u6211\u4eec\u672c\u80fd\u5730\u5e0c\u671b\u53ef\u4ee5\u6709\u4e00\u4e2a\u7b80\u5355\u7684\u547d\u4ee4\u5de5\u5177\uff0c\u6211\u4eec\u5411\u4ed6\u53d1\u9001\u8bf8\u5982 read\u3001write \u7684\u6307\u4ee4\uff0c\u5b83\u518d\u5e2e\u6211\u4eec\u8f6c\u6362\u4e3a\u6666\u6da9\u7684 DMI \u6307\u4ee4\u5e8f\u5217\uff0c\u8fd9\u4e2a\u5de5\u5177\u5c31\u662f OpenOCD\u3002</p> <p>Spike \u76f4\u63a5\u6a21\u62df\u7684\u662f\u786c\u4ef6\u8bbe\u5907\uff0c\u6240\u4ee5\u5b83\u4e5f\u76f4\u63a5\u6a21\u62df\u4e86\u4e00\u4e2a debug module\uff0c\u6307\u5b9a <code>--rbb-port</code> \u9009\u9879\u4e4b\u540e\uff0c\u5b83\u5c31\u53ef\u4ee5\u5f00\u653e\u5bf9\u5e94\u7684\u6a21\u62df JTAG \u7aef\u53e3\u7b49\u5f85\u88ab\u8fde\u63a5\u8c03\u8bd5\u3002OpenOCD \u8fde\u63a5\u8fd9\u4e2a\u7aef\u53e3\u7136\u540e\u5f00\u59cb\u8c03\u8bd5\uff0c\u4e0d\u8fc7\u5b83\u5e76\u4e0d\u77e5\u9053\u6211\u4eec\u7684 spike \u7684\u5e73\u53f0\u7c7b\u578b\u7684\u8fde\u63a5\u7c7b\u578b\uff0c\u56e0\u6b64\u9700\u8981\u6211\u4eec\u989d\u5916\u63d0\u4f9b openocd.cfg \u6587\u4ef6\uff0c\u53ea\u8981\u8fd0\u884c <code>openocd -f openocd.cfg</code>\uff0c\u5c31\u4f1a\u81ea\u52a8\u8fde\u63a5 9824 \u7aef\u53e3\uff0c\u5e76\u51c6\u5907\u8c03\u8bd5\u6211\u4eec\u7684 spike\u3002</p> <p>\u5b83\u8fde\u63a5\u4e86 remote bitbang \u7684\u7aef\u53e3\uff0c\u7136\u540e\u521b\u5efa\u4e86\u4e00\u4e2a tap \u548c target\uff0c\u5f00\u542f\u4e86 gdb \u540e\u91cd\u7f6e\u7b49\u5f85\u8c03\u8bd5\u3002\u8fd9\u6837 OpenOCD \u4f1a\u9ed8\u8ba4\u5f00\u653e 3333 \u7aef\u53e3\u7ed9 gdb \u8fde\u63a5\uff0c\u901a\u8fc7 <code>target extended-remote localhost:3333</code> \u6216\u8005 <code>tar ext :3333</code> \u5c31\u53ef\u4ee5\u8fde\u63a5\u5230 OpenOCD\u3002</p> <p>\u4e4b\u540e OpenOCD \u53ef\u4ee5\u62c5\u5f53 gdb \u548c spike \u4e4b\u95f4\u7684\u6865\u6881\u3002gdb \u63a5\u6536\u5230\u7684\u6307\u4ee4\u4f1a\u53d1\u9001\u7ed9 OpenOCD\uff0cOpenOCD \u5c06\u5b83\u8f6c\u6362\u4e3a\u5bf9\u5e94\u7684 01 \u4e32\u53d1\u9001\u7ed9 spike \u8fdb\u884c\u8c03\u8bd5\uff0c\u53cd\u4e4b\u4ea6\u7136\u3002\u4e8e\u662f\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 gdb-OpenOCD-spike \u7684\u5de5\u5177\u94fe\u5b9e\u73b0\u539f\u6765 gdb-qemu \u7684\u6548\u679c\u3002</p>"},{"location":"z1-spike/#opensbi","title":"OpenSBI","text":"<p>OpenSBI \u5927\u5bb6\u5728\u5b9e\u9a8c\u8fc7\u7a0b\u4e2d\u5e94\u8be5\u90fd\u6709\u6240\u4e86\u89e3\uff0c\u5c31\u4e0d\u4ecb\u7ecd\u5b83\u672c\u8eab\u4e86\u3002\u8fd9\u4e2a\u5de5\u5177\u94fe\u4e4b\u6240\u4ee5\u9700\u8981 OpenSBI\uff0c\u662f\u56e0\u4e3a spike \u6a21\u62df\u7684\u662f\u4e00\u53f0\u88f8\u673a\u3002\u6211\u4eec\u7684 kernel \u4e0d\u53ef\u4ee5\u76f4\u63a5\u5728\u88f8\u673a\u4e0a\u8fd0\u884c\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u989d\u5916\u7684 OpenSBI \u7684\u4ee3\u7801\u505a\u524d\u671f\u7684\u542f\u52a8\u3002</p>"},{"location":"z1-spike/#\u8fd0\u884c","title":"\u8fd0\u884c","text":"<p>\u8fd0\u884c <code>make</code> \u65f6\u6dfb\u52a0 <code>SIMULATOR=spike</code> \u9009\u9879\u5373\u53ef\uff1a</p> <pre><code>make SIMULATOR=spike run\n</code></pre>"},{"location":"z1-spike/#\u8c03\u8bd5","title":"\u8c03\u8bd5","text":"<p>\u8c03\u8bd5\u7684\u8bdd\u4e00\u5171\u9700\u8981\u4e09\u4e2a\u7ec8\u7aef\u7a97\u53e3\uff0c\u5206\u522b\u6267\u884c\uff1a</p> <ol> <li><code>make SIMULATOR=spike debug</code>\uff1a\u542f\u52a8 spike \u5e76\u7b49\u5f85\u8c03\u8bd5</li> <li><code>make ocd</code>\uff1a\u542f\u52a8 OpenOCD \u5e76\u8fde\u63a5 spike</li> <li><code>make gdb</code>\uff1a\u542f\u52a8 gdb</li> </ol> <p>\u540e\u7eed\u7684\u8c03\u8bd5\u6d41\u7a0b\u548c qemu \u7c7b\u4f3c\uff0c\u4e0d\u518d\u8d58\u8ff0\u3002</p>"},{"location":"ta/autograder/","title":"\u8bc4\u6d4b\u6846\u67b6","text":""},{"location":"ta/autograder/#\u8bc4\u6d4b\u6846\u67b6","title":"\u8bc4\u6d4b\u6846\u67b6","text":"<p>\u8bc4\u6d4b\u6846\u67b6\u4f7f\u7528\u4e86\u4e0b\u5217\u5f00\u6e90\u9879\u76ee\uff1a</p> <ul> <li>pygdbmi \u00b7 PyPI\uff1a\u4e0e GDB \u4ea4\u4e92</li> <li> <p>QEMU Python Tooling</p> <p>QEMU \u7684 Python API \u5e76\u6ca1\u6709\u72ec\u7acb\u51fa\u6765\u4f5c\u4e3a\u4e00\u4e2a\u5e93\u53d1\u5e03\u5230 PyPI \u4e0a\uff0c\u800c\u662f\u548c QEMU \u7684\u6e90\u4ee3\u7801\u653e\u5728\u4e00\u8d77\u3002\u56e0\u6b64\u6211\u4eec\u5728 Docker \u955c\u50cf\u6784\u5efa\u65f6\u7528 APT \u83b7\u53d6\u5f53\u524d\u53d1\u884c\u7248\u7684 QEMU \u6e90\u7801\uff0c\u5e76\u5728 <code>pyptoject.toml</code> \u4e2d\u6307\u5b9a\u3002</p> <p>\u6ce8\u610f\u66f4\u65b0</p> <p>QEMU Python Tooling \u5e76\u4e0d\u4fdd\u8bc1\u7a33\u5b9a\u6027\u3002\u6bcf\u5e74\u8bfe\u7a0b\u66f4\u65b0\u91cd\u6784 Docker \u955c\u50cf\u65f6\uff0c\u90fd\u9700\u8981\u68c0\u67e5\u4e00\u4e0b\u8bc4\u6d4b\u6846\u67b6\u662f\u5426\u8fd8\u80fd\u7528\u3001QEMU Python API \u662f\u5426\u6709 Breaking Change\u3002</p> <p>\u6211\u4eec\u4f7f\u7528\u4e86\u5176\u4e2d\u7684\uff1a</p> <ul> <li><code>qemu.machine</code>\uff1a\u521b\u5efa\u548c\u7ba1\u7406\u865a\u62df\u673a</li> <li><code>qemu.qmp</code>\uff1a\u4f7f\u7528 QEMU Machine Protocol (QMP) \u4e0e\u865a\u62df\u673a\u4ea4\u4e92</li> </ul> <p>\u5efa\u8bae\u9605\u8bfb\u4ee5\u4e0b\u8d44\u6599\u4e86\u89e3\u5982\u4f55\u4f7f\u7528\u8fd9\u4e9b API\uff1a</p> <ul> <li>Functional testing with Python \u2014 QEMU documentation</li> <li><code>tests/functional/riscv64/test_opensbi.py</code></li> </ul> <p>\u5176\u4ed6\u4fe1\u606f\uff1a</p> <ul> <li>QEMU \u5f00\u53d1\u8005 John Snow \u66fe\u7ecf\u4e3a QEMU Python API \u5199\u8fc7\u4e00\u4e9b\u6587\u6863\uff0c\u89c1 QEMU Python Library Documentation\uff0c\u4f46\u4e0a\u6b21\u66f4\u65b0\u5df2\u662f 2021 \u5e74\u3002</li> <li> <p>John Snow \u5c06 <code>qemu.qmp</code> \u5206\u79bb\u51fa\u6765\u6253\u5305\uff0c\u4f46 PyPI \u4e0a\u6b21\u66f4\u65b0\u5df2\u662f 2023 \u5e74\uff0c\u4e5f\u4e0d\u77e5\u9053\u4e3a\u4ec0\u4e48\u4e0d\u987a\u4fbf\u628a <code>qemu.machine</code> \u4e4b\u7c7b\u7684\u6253\u5305\u51fa\u6765\u3002</p> <p>\u6587\u6863\u89c1 qemu.qmp: QEMU Monitor Protocol Library \u2014 QEMU Monitor Protocol Library 0.0.4.dev28+gc08fb82b3 documentation\uff0cPyPI \u89c1 qemu.qmp \u00b7 PyPI\uff0c\u6e90\u7801\u4ed3\u89c1 QEMU / python-qemu-qmp \u00b7 GitLab\u3002</p> </li> </ul> </li> <li> <p>unittest \u2014 Unit testing framework \u2014 Python documentation\uff1aPython \u6807\u51c6\u5e93\u7684\u5355\u5143\u6d4b\u8bd5\u6846\u67b6</p> </li> </ul>"},{"location":"ta/autograder/#qemu","title":"QEMU","text":"<pre><code>-display none -vga none\n-chardev socket,id=mon,fd=6\n-mon chardev=mon,mode=control\n-machine virt\n-chardev socket,id=console,fd=14\n-serial chardev:console\n</code></pre> <ul> <li><code>-mon</code>\uff1a\u7ed9 QEMU Monitor \u7528\u7684</li> <li><code>-serial</code>\uff1a\u7ed9 OpenSBI \u7528\u7684\u4e32\u53e3</li> <li>\u8fd9\u4e24\u4e2a\u53c2\u6570\u7ec4\u5408\u8d77\u6765\u8d77\u5230\u548c <code>-nographic</code> \u7c7b\u4f3c\u7684\u4f5c\u7528</li> </ul>"},{"location":"ta/dev/","title":"\u6e90\u4ee3\u7801\u7ba1\u7406","text":""},{"location":"ta/dev/#\u6e90\u4ee3\u7801\u7ba1\u7406","title":"\u6e90\u4ee3\u7801\u7ba1\u7406","text":"<p>\u672c\u8bfe\u7a0b\u7684\u5f00\u53d1\u5728 ZJU Git \u4e0a\u8fdb\u884c\uff0cGitHub \u5b9a\u671f\u624b\u5de5\u540c\u6b65\u3002</p>"},{"location":"ta/dev/#\u4ed3\u5e93\u5217\u8868","title":"\u4ed3\u5e93\u5217\u8868","text":"<ul> <li> <p>\uff08\u516c\u5f00\uff09\u5b9e\u9a8c\u4ee3\u7801\u53d1\u5e03\u4ed3\u5e93 ZJU-OS/code</p> <p>\u7528\u4e8e\u53d1\u5e03\u5b9e\u9a8c\u4ee3\u7801\u3002</p> </li> <li> <p>\uff08\u79c1\u6709\uff09\u5b8c\u6574\u4ee3\u7801\u4ed3\u5e93 ZJU-OS/code-private</p> <p><code>main</code> \u5206\u652f\u5b58\u653e\u5b9e\u73b0\u4e86\u6240\u6709\u5b9e\u9a8c\u529f\u80fd\u7684\u4ee3\u7801\uff0c\u6301\u7eed\u8fdb\u884c\u6574\u4f53\u4ee3\u7801\u7684\u7ef4\u62a4\u548c\u6539\u8fdb\u3002</p> </li> </ul> <p>GitHub \u7684\u4e00\u4e9b\u7f3a\u9677</p> <ul> <li>GitHub \u4e0d\u652f\u6301 Public \u4ed3\u5e93\u7684 Private Fork\uff0c\u800c\u6211\u4eec\u5e0c\u671b\u4ece\u79c1\u6709\u4ed3\u5e93\u5230\u4ee3\u7801\u53d1\u5e03\u80fd\u8d70 PR \u6d41\u7a0b\uff0c\u786e\u4fdd\u53c2\u4e0e\u7684\u52a9\u6559\u77e5\u9053\u53d1\u5e03\u7684\u4ee3\u7801\u53d1\u751f\u4e86\u4ec0\u4e48\u53d8\u66f4\u3002</li> <li> <p>GitHub Pull Request \u4e0d\u80fd\u540c\u65f6\u652f\u6301\u4e0b\u9762\u4e24\u4e2a\u8981\u6c42\uff1a</p> <ul> <li>\u4e0d\u751f\u6210 Merge Commit</li> <li>\u4fdd\u7559 Commit \u7684 Hash</li> </ul> <p>\u8fd9\u7ed9\u591a\u4ed3\u591a\u5206\u652f\u5f00\u53d1\u9020\u6210\u4e86\u5f88\u591a\u9ebb\u70e6\u3002\u5728\u672c\u5730\u6267\u884c <code>git merge</code> \u65f6\uff0c\u5982\u679c\u53ef\u4ee5 Fast-forward \u5219\u80fd\u540c\u65f6\u6ee1\u8db3\u4e0a\u9762\u4e24\u4e2a\u8981\u6c42\uff0c\u8fd9\u6837\u6bd4\u8f83\u4f18\u96c5\uff0c\u80fd\u591f\u4fdd\u6301\u7ebf\u6027\u5386\u53f2\u3002\u4f46 GitHub \u5b9e\u9645\u4e0a\u6267\u884c\u7684\u66f4\u50cf\u662f <code>git merge --no-ff</code>\uff0c\u89c1 git - GitHub: Commit is changed after merge - Stack Overflow\u3002\u5373\u4f7f\u7528 Merge \u7684\u65b9\u5f0f\u5408\u5e76 PR\uff0c\u4e5f\u4f1a\u4ea7\u751f\u4e00\u4e2a\u591a\u4f59\u7684 Merge Commit\uff0c\u9700\u8981 Sync Fork\u3002</p> </li> </ul> <p>GitLab \u53ef\u4ee5\u6ee1\u8db3\u4e0a\u9762\u4e24\u4e2a\u8981\u6c42\u3002</p>"},{"location":"ta/dev/#\u53d1\u5e03\u6d41\u7a0b","title":"\u53d1\u5e03\u6d41\u7a0b","text":"<p>\u4e0b\u9762\u4ece\u6bcf\u5b66\u671f\u521d\u5f00\u59cb\u4ecb\u7ecd\u6d41\u7a0b\u3002\u793a\u610f\u56fe\u4e2d\u7ea2\u8272\u7684\u8282\u70b9\u662f\u643a\u5e26\u5168\u90e8\u4ee3\u7801\u7684\u63d0\u4ea4\uff0c\u4e0d\u5e94\u5f53\u516c\u5f00\u3002\u7eff\u8272\u8282\u70b9\u662f\u5b89\u5168\u7684\uff0c\u53ef\u4ee5\u516c\u5f00\u7684\u63d0\u4ea4\u3002</p> <p></p> <ul> <li> <p>\u521b\u5efa\u672c\u5b66\u671f\u7684\u53d1\u5e03\u5206\u652f <code>fa25-release</code>\uff1a\u6316\u7a7a <code>main</code> \u7684\u4ee3\u7801\uff0c\u521b\u5efa\u4e0d\u5e26\u5386\u53f2\u8bb0\u5f55\u7684\u5206\u652f\u63a8\u9001\u5230\u5b66\u751f\u4ed3\u5e93</p> <pre><code>git clone git@github.com:/ZJU-OS/code-private.git\ncd code-private\ngit remote rename origin code-private\ngit checkout -b fa25-release-clean main\n# \u6316\u7a7a\u4ee3\u7801\ngit commit -am \"fa25: init\"\ngit checkout --orphan fa25-release\ngit commit -am \"fa25: init\"\ngit push -u code-private fa25-release\n</code></pre> </li> <li> <p>\u521b\u5efa\u7a7a\u7684\u53d1\u5e03\u4ed3\u5e93\uff0c\u63a8\u9001\u7b2c\u4e00\u4e2a\u57fa\u7840\u5206\u652f <code>lab0</code>\uff08\u4ec5\u6b64\u65f6\u4e0d\u9700\u8981\u8d70 MR \u6d41\u7a0b\uff09\uff1a</p> <pre><code>git remote add code git@github.com:/ZJU-OS/code.git\ngit checkout -b lab0 fa25-release\ngit push code lab0\n</code></pre> </li> <li> <p><code>main</code> \u8fdb\u884c\u5176\u4ed6\u5f00\u53d1\u5de5\u4f5c</p> </li> <li> <p>\u53d1\u5e03 <code>labN</code>\uff1a</p> <ul> <li>\u4ee5 <code>fa25-release</code> \u4e3a\u57fa\u7840\uff08\u6b64\u65f6\u5df2\u7ecf\u53d1\u5e03\u4e86 <code>lab(N-1)</code>\uff09,\u4ece <code>main</code> \u9009\u62e9\u9700\u8981\u7684\u4ee3\u7801\u8fdb\u884c\u5408\u5e76\uff0c\u6316\u7a7a\u4e0d\u9700\u8981\u7684\u4ee3\u7801\uff0c\u8fbe\u5230 <code>labN</code> \u7684\u8fdb\u5ea6</li> <li>\u521b\u5efa GitLab Merge Request \u5408\u5e76\u5230\u5b66\u751f\u4ed3\u5e93\u7684 <code>labN</code> \u5206\u652f</li> </ul> <pre><code>git checkout fa25-release\n# \u4ee5\u5f53\u524d\u5de5\u4f5c\u76ee\u5f55\u4e3a\u57fa\u7840\uff0c\u6bd4\u8f83 main \u5206\u652f\u65b0\u589e\u54ea\u4e9b\u4ee3\u7801\ngit diff -R --compact-summary main --\n# \u4ece code-private/main \u5408\u5e76\u4ee3\u7801\u5230 code-private/fa25-release\n# \u53ef\u4ee5\u7528 git merge \u6216 git checkout\ngit merge --squash --no-commit main\ngit checkout main -- &lt;\u9700\u8981\u7684\u6587\u4ef6&gt;\n# \u624b\u5de5\u9009\u62e9\u9700\u8981\u5408\u5e76\u7684\u6587\u4ef6\uff0c\u6316\u7a7a\u5b66\u751f\u5b8c\u6210\u7684\u4ee3\u7801\n# \u53ef\u4ee5\u5206\u591a\u6b21\u63d0\u4ea4\uff0c\u66f4\u52a0\u6e05\u6670\u5730\u6dfb\u52a0\u6587\u4ef6\ngit commit -am \"labN: release\"\n# GitLab \u4e0a\u521b\u5efa Merge Request\n# \u4ece code-private/fa25-release \u5408\u5e76\u5230 code/labN\n</code></pre> </li> </ul> <p>\u5efa\u8bae\u5728 <code>.gitconfig</code> \u4e2d\u914d\u7f6e <code>difftool</code>\uff0c\u65b9\u4fbf\u7528 VSCode \u67e5\u770b\u4ee3\u7801\u53d8\u66f4\uff1a</p> ~/.gitconfig<pre><code>[diff]\n    tool = vscode\n[difftool \"vscode\"]\n    cmd = code --wait --diff $LOCAL $REMOTE\n</code></pre> <p>\u914d\u7f6e\u540e\uff0c\u53ef\u4ee5\u7528 <code>git difftool</code> \u4ee3\u66ff <code>git diff</code> \u67e5\u770b\u4ee3\u7801\u53d8\u66f4\uff1a</p> <pre><code>git difftool main --\n</code></pre> <p>\u4e0a\u9762\u8fd9\u884c\u547d\u4ee4\u4f1a\u5bf9\u6240\u6709\u6709\u5dee\u5f02\u7684\u6587\u4ef6\u9010\u4e2a\u6253\u5f00 VSCode \u7684\u5bf9\u6bd4\u754c\u9762\uff0c\u53ef\u4ee5\u5229\u7528 VSCode \u7684\u5dee\u5f02\u5408\u5e76\u529f\u80fd\u65b9\u4fbf\u5730\u5904\u7406\u53d8\u66f4\u3002\u5b8c\u6210\u4e00\u5bf9\u6587\u4ef6\u7684\u5bf9\u6bd4\u540e\uff0c\u5173\u95ed\u5bf9\u5e94\u7684 VSCode \u7a97\u683c\u5373\u53ef\u8fdb\u5165\u4e0b\u4e00\u5bf9\u6587\u4ef6\u7684\u5bf9\u6bd4\u3002</p>"},{"location":"ta/dev/#\u5f00\u53d1\u65e5\u5fd7","title":"\u5f00\u53d1\u65e5\u5fd7","text":""},{"location":"ta/dev/#lab2","title":"Lab2","text":"<p>\u9057\u7559\u5f85\u5b8c\u5584\uff1a</p> <ul> <li>\u5c06\u8c03\u5ea6\u7b97\u6cd5\u5347\u7ea7\u5230 CFS</li> <li>\u6d4b\u4f8b\u8ba1\u65f6\u6ca1\u533a\u5206\u8fdb\u7a0b\u65f6\u95f4\u548c\u5185\u6838\u65f6\u95f4\uff08\u5c31\u662f schedule \u7684\u5f00\u9500\uff09</li> <li>\u8fdb\u7a0b\u963b\u585e\u548c\u5524\u9192\u673a\u5236</li> </ul>"},{"location":"ta/tool/","title":"\u8f85\u52a9\u5de5\u5177","text":""},{"location":"ta/tool/#\u8f85\u52a9\u5de5\u5177","title":"\u8f85\u52a9\u5de5\u5177","text":"<p>\u8fd9\u662f\u52a9\u6559\u5de5\u5177\u4ed3\u5e93 ZJU-OS/tool \u7684\u6587\u6863\u3002</p>"},{"location":"ta/tool/#\u5bb9\u5668\u955c\u50cf","title":"\u5bb9\u5668\u955c\u50cf","text":"<ul> <li>\u8f6f\u4ef6\u5305\u53ea\u8981\u53d1\u884c\u7248\u6709\u5e76\u4e14\u80fd\u7528\uff0c\u5c31\u7528\u53d1\u884c\u7248\u7684\u3002</li> <li>\u6e90\u7801\u4e5f\u4ece\u53d1\u884c\u7248\u83b7\u53d6\u3002</li> </ul>"},{"location":"ta/tool/#\u591a\u5e73\u53f0\u955c\u50cf\u6784\u5efa","title":"\u591a\u5e73\u53f0\u955c\u50cf\u6784\u5efa","text":"<p>\u8bfe\u7a0b\u9700\u8981\u652f\u6301\u4f7f\u7528 amd64 \u548c arm64 \u5e73\u53f0\u7684\u5b66\u751f\u5b8c\u6210\u5b9e\u9a8c\uff0c\u56e0\u6b64\u4f7f\u7528 Multi-arch build and images, the simple way | Docker \u6784\u5efa\u591a\u5e73\u53f0\u955c\u50cf\uff0c\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <ul> <li> <p>\u5206\u522b\u5728 arm64 \u548c amd64 \u5e73\u53f0\u4e0a\u6267\u884c</p> <pre><code>make build-image\nmake push-image\n</code></pre> </li> <li> <p>\u7136\u540e\u5728\u5176\u4e2d\u4e00\u4e2a\u5730\u65b9\u6267\u884c</p> <pre><code>make push-multi\n</code></pre> <p>\u62c9\u53d6\u5728\u53e6\u4e00\u4e2a\u5e73\u53f0\u4e0a\u6784\u5efa\u7684\u955c\u50cf\uff0c\u4f7f\u7528 <code>docker manifest</code> \u5408\u6210 <code>latest</code> \u63cf\u8ff0\u6587\u4ef6\u5e76\u63a8\u9001\u3002</p> </li> </ul> <p>\u76f8\u6bd4\u7528 Tag \u533a\u5206\u4e0d\u540c\u67b6\u6784\uff0c\u8fd9\u4e48\u6298\u817e\u4e00\u756a\u53ef\u4ee5\u8ba9 Docker \u81ea\u52a8\u5339\u914d\u5230\u5bf9\u5e94\u67b6\u6784\uff0c\u955c\u50cf\u540d\u4e0d\u7528\u6307\u5b9a\u6807\u7b7e\u3002</p> <p>\u7406\u8bba\u4e0a\u6765\u8bf4\uff0c\u4f7f\u7528 Docker buildx \u7684 Multi-platform builds \u5c31\u80fd\u5728\u4e00\u4e2a\u5e73\u53f0\u4e0a\u5b8c\u6210\u6240\u6709\u6784\u5efa\uff0c\u66f4\u52a0\u7b80\u6d01\u3002\u4f46\u662f\uff1a</p> <ul> <li>\u7b14\u8005\u6ca1\u6709\u914d\u7f6e\u6210\u529f</li> <li>\u8de8\u67b6\u6784\u8fd0\u884c\u5b9e\u5728\u662f\u592a\u6162\u4e86</li> </ul> <p>\u4f46 Manifest \u662f Docker \u7684\u5b9e\u9a8c\u6027\u529f\u80fd\uff0c\u6709\u65f6\u5019\u521b\u5efa <code>latest</code> \u5e76\u4e0d\u8986\u76d6\uff0c\u633a\u5947\u602a\u7684\u3002</p>"},{"location":"ta/tool/#gitlab-ci-\u8bc4\u6d4b","title":"GitLab CI \u8bc4\u6d4b","text":"<p><code>ZJU-OS/tool</code> \u4ed3\u5e93\u4e0b\u7684 <code>zjugit-ci</code> \u5305\u542b\u4e86\u8bc4\u6d4b Runner \u5bb9\u5668\u7684\u914d\u7f6e\uff0c\u5e76\u4e14\u7528 <code>Makefile</code> \u5305\u88c5\u4e86\u5e38\u7528\u547d\u4ee4\uff1a</p> <pre><code># \uff08\u521d\u6b21\u8fd0\u884c\uff09\u6ce8\u518c Runner\nmake TOKEN= register\n# \u542f\u52a8 Runner\nmake\n</code></pre> <ul> <li>\u521d\u6b21\u8fd0\u884c\u65f6\uff0c\u53c2\u8003 Tutorial: Create, register, and run your own project runner | GitLab Docs \u83b7\u5f97 Token\u3002</li> <li> <p>\u6211\u4eec\u4f7f\u7528 Docker Executor\uff0cRun your CI/CD jobs in Docker containers | GitLab Docs</p> <p>\u76f8\u5173\u6d41\u7a0b\u603b\u7ed3\uff1a</p> <ul> <li>Prepare\uff1a<ul> <li>\u521b\u5efa\u548c\u542f\u52a8 service</li> <li>\u4f7f\u7528\u9ed8\u8ba4 Entrypoint \u542f\u52a8\u5bb9\u5668\uff0c\u7136\u540e Attach \u4e0a\u53bb</li> </ul> </li> <li>Pre-job\uff1a\u514b\u9686\u4ed3\u5e93\u3001\u7f13\u5b58\u548c artifact \u5904\u7406</li> <li> <p>Job\uff1a</p> <ul> <li>\u5c06 <code>before_script</code>\u3001<code>script</code>\u3001<code>after_script</code> \u7ec4\u5408\u6210\u4e00\u4e2a\u811a\u672c</li> <li>\u901a\u8fc7 <code>stdin</code> \u53d1\u9001\u5230\u5bb9\u5668 Shell \u6267\u884c\uff0c\u5e76\u63a5\u6536\u8f93\u51fa</li> </ul> </li> <li> <p>CI \u4ed3\u5e93\u4f1a\u88ab\u653e\u7f6e\u5728 <code>/build/&lt;path&gt;</code> \u4e0b\uff0c\u4f8b\u5982 <code>/build/os/fa25/jijiangming/os-123456</code>\u3002</p> </li> </ul> </li> </ul> <p>\u5982\u4f55\u8c03\u8bd5 CI\uff1f</p> <ul> <li>\u5728 <code>scripts</code> \u52a0\u4e2a <code>sleep 1d</code>\uff0c\u7136\u540e\u53bb\u5bbf\u4e3b\u673a attach \u5230\u5bb9\u5668</li> <li>\u4f7f\u7528 <code>docker inspect</code> \u67e5\u770b\u5bb9\u5668\u7684\u8be6\u7ec6\u4fe1\u606f</li> </ul>"},{"location":"ta/blog/1.pid0/","title":"\u64cd\u4f5c\u7cfb\u7edf\u5c0f\u8bb0\uff08\u4e00\uff09\uff1a\u4ece PID 0 \u5f00\u59cb","text":""},{"location":"ta/blog/1.pid0/#\u64cd\u4f5c\u7cfb\u7edf\u5c0f\u8bb0\u4e00\u4ece-pid-0-\u5f00\u59cb","title":"\u64cd\u4f5c\u7cfb\u7edf\u5c0f\u8bb0\uff08\u4e00\uff09\uff1a\u4ece PID 0 \u5f00\u59cb","text":"<p>\u672c\u6b21\u4f5c\u4e3a\u52a9\u6559\u5c1d\u8bd5\u91cd\u6784 OS \u5b9e\u9a8c Lab2\uff0c\u7ec8\u6781\u76ee\u6807\u662f\u60f3\u628a\u5b9e\u9a8c\u548c\u7406\u8bba\u8bfe\u7ed3\u5408\u5230\u4e00\u8d77\uff0c\u8ba9\u540c\u5b66\u4eec\u5b9e\u73b0\u7684 OS \u80fd\u6a21\u62df\u7406\u8bba\u8bfe\u4f8b\u9898\u4e2d\u8fdb\u7a0b\u5728\u4e0d\u540c\u65f6\u95f4\u5230\u8fbe\u7684\u573a\u666f\uff0c\u4ece\u800c\u80fd\u591f\u8ba1\u7b97\u81ea\u5df1\u5b9e\u73b0\u7684\u8c03\u5ea6\u7b97\u6cd5\u7684\u5e73\u5747\u7b49\u5f85\u65f6\u95f4\u3001\u5468\u8f6c\u65f6\u95f4\u548c\u54cd\u5e94\u6bd4\u7b49\u3002\u7136\u800c\uff0c\u5b9e\u73b0\u8fdb\u7a0b\u751f\u547d\u5468\u671f\u7684\u52a8\u6001\u7ba1\u7406\u5b9e\u5c5e\u4e0d\u6613\uff0c\u5149\u662f\u7406\u6e05 Linux \u5b9e\u73b0\u7684\u7ec6\u8282\u5c31\u82b1\u8d39\u4e86\u4e24\u4f4d\u52a9\u6559 3 \u5929\u7684\u65f6\u95f4\u3002\u672c\u6587\u6c47\u603b\u6211\u4eec\u5bf9 Linux \u8fdb\u7a0b\u7ba1\u7406\u7684\u7406\u89e3\uff0c\u5e76\u8bb0\u5f55 Lab2 \u91cd\u6784\u7684\u8fc7\u7a0b\u3002</p>"},{"location":"ta/blog/1.pid0/#linux-\u8fdb\u7a0b\u751f\u547d\u5468\u671f","title":"Linux \u8fdb\u7a0b\u751f\u547d\u5468\u671f","text":""},{"location":"ta/blog/1.pid0/#pid-0-\u4e0e\u521d\u59cb\u5316\u5de5\u4f5c","title":"PID 0 \u4e0e\u521d\u59cb\u5316\u5de5\u4f5c","text":"<p>\u9996\u5148\u8ba9\u6211\u4eec\u7814\u7a76 Linux \u7b2c\u4e00\u4e2a\u8fdb\u7a0b\uff08PID 0\uff09\u7684\u6267\u884c\u3002\u6574\u4f53\u7684\u987a\u5e8f\u662f\uff1a</p>      \u51fd\u6570\u8c03\u7528\u8fc7\u7a0b \u56fe\u4e2d <code>j</code> \u8868\u793a jump \u6307\u4ee4\uff0c<code>tail</code> \u8868\u793a\u5c3e\u8c03\u7528\uff0c<code>call</code> \u8868\u793a\u666e\u901a\u8c03\u7528 <ul> <li> <p><code>_start()</code></p> <p>\u8fd9\u91cc\u6211\u4eec\u5173\u6ce8 S \u6a21\u5f0f CSR \u7684\u521d\u59cb\u72b6\u6001\u3002OpenSBI \u8fdb\u5165\u5185\u6838\u65f6\uff0c<code>sstatus</code> \u4e3a <code>0x200000000</code>\uff0c\u4e5f\u5c31\u662f\u4ec5\u8bbe\u7f6e\u4e86 <code>UXL</code> \u4e3a 2\uff0864 \u4f4d\u7528\u6237\u6001\uff09\uff0c\u5176\u4ed6\u4f4d\u5747\u4e3a 0\u3002\u6b64\u540e\u6267\u884c <code>sret</code> \u5c06\u56e0\u4e3a <code>SPP=0</code> \u800c\u8fdb\u5165\u7528\u6237\u6001\u3002</p> </li> <li> <p><code>_start_kernel()</code>\uff1a\u5c06\u5199\u597d\u7684\u53d8\u91cf <code>init_task</code> \u5730\u5740\u52a0\u8f7d\u5230 <code>tp</code>\uff0c\u4ee4\u81ea\u5df1\u6210\u4e3a\u7b2c\u4e00\u4e2a task\uff08PID 0\uff09</p> arch/riscv/kernel/head.S<pre><code>la tp, init_task\nla sp, init_thread_union + THREAD_SIZE\naddi sp, sp, -PT_SIZE_ON_STACK\n</code></pre> <p>\u53d8\u91cf\u5b9a\u4e49\u5982\u4e0b\uff1a</p> init/init_task.c<pre><code>struct task_struct init_task __aligned(L1_CACHE_BYTES) = {\n#ifdef CONFIG_THREAD_INFO_IN_TASK\n    .thread_info = INIT_THREAD_INFO(init_task),\n    .stack_refcount = REFCOUNT_INIT(1),\n#endif\n    .__state = 0,\n    .stack  = init_stack,\n    // ...\n</code></pre> <p>\u5176\u4e2d\u6808\u7684\u5b9e\u73b0\u4e0e\u5177\u4f53\u67b6\u6784\u6709\u5173\uff0c\u5728\u94fe\u63a5\u5668\u811a\u672c\u4e2d\u5b9a\u4e49\uff1a</p> arch/riscv/kernel/vmlinux.lds<pre><code>__start_init_stack = .;\ninit_thread_union = .;\ninit_stack = .;\nKEEP(*(.data..init_thread_info))\n. = __start_init_stack + ((1 &lt;&lt; 12) &lt;&lt; (2 + 0));\n__end_init_stack = .;\n. = ALIGN((1 &lt;&lt; 12));\n</code></pre> </li> <li> <p><code>start_kernel()</code>\uff1a\u521d\u59cb\u5316\u5404\u9879\u8d44\u6e90\uff0c\u6700\u540e\u8c03\u7528 <code>rest_init()</code> \u521b\u5efa\u7b2c\u4e00\u4e2a\u7528\u6237\u6001\u7ebf\u7a0b\uff08PID 1\uff09\u548c\u5185\u6838\u6001\u7ebf\u7a0b\uff08PID 2\uff09</p> init/main.c<pre><code>static noinline void __ref __noreturn rest_init(void)\n{\n    pid = user_mode_thread(kernel_init, NULL, CLONE_FS);\n    pid = kernel_thread(kthreadd, NULL, NULL, CLONE_FS | CLONE_FILES);\n    kthreadd_task = find_task_by_pid_ns(pid, &amp;init_pid_ns);\n    schedule_preempt_disabled();\n    cpu_startup_entry(CPUHP_ONLINE);\n}\n</code></pre> <ul> <li><code>rest_init()</code> \u521b\u5efa\u597d <code>kernel_init</code> \u548c <code>kthreadd</code> \u540e\uff0c\u4f1a\u5148\u4e3b\u52a8\u8c03\u5ea6\u4e00\u6b21\uff08\u540d\u5b57\u91cc\u5e26 <code>schedule</code> \u7684\u51fd\u6570\u57fa\u672c\u90fd\u7528\u4e8e\u53d1\u8d77\u8c03\u5ea6\uff09\uff0c\u8ba9\u8fd9\u4e24\u4e2a\u7ebf\u7a0b\u505a\u4e00\u4e9b\u5de5\u4f5c</li> <li> <p>\u518d\u6b21\u8c03\u5ea6\u56de\u6765\u65f6\uff0c\u7ee7\u7eed\u6267\u884c\u4e0b\u9762\u7684\u51fd\u6570\uff0c\u4ee4\u81ea\u8eab\uff08PID 0\uff09\u8fdb\u5165\u7a7a\u95f2\u72b6\u6001\uff1a</p> kernel/sched/idle.c<pre><code>void cpu_startup_entry(enum cpuhp_state state)\n{\n    current-&gt;flags |= PF_IDLE;\n    arch_cpu_idle_prepare();\n    cpuhp_online_idle(state);\n    while (1)\n        do_idle();\n}\n</code></pre> <p>\u6240\u6709 CPU \u6838\u5fc3\u90fd\u4f1a\u4ece PID 0 \u62f7\u8d1d\u4e00\u4efd\uff0c\u5b58\u653e\u5230 <code>idle_threads</code> \u4f5c\u4e3a\u8be5\u6838\u5fc3\u7684\u7a7a\u95f2\u7ebf\u7a0b\u3002\u5f53\u4e00\u4e2a CPU \u4e0a\u6ca1\u6709\u53ef\u8fd0\u884c\u7684\u8fdb\u7a0b\u65f6\uff0c\u8c03\u5ea6\u5668\u4f1a\u9009\u62e9\u5bf9\u5e94\u7684\u7a7a\u95f2\u7ebf\u7a0b\u8fd0\u884c\u3002\u987e\u540d\u601d\u4e49\uff0c\u7a7a\u95f2\u7ebf\u7a0b\u5565\u4e8b\u4e0d\u5e72\uff0c\u53ea\u8d1f\u8d23\u8ba9 CPU \u5904\u4e8e\u7a7a\u95f2\u72b6\u6001\uff0c\u7b49\u5f85\u4e2d\u65ad\u6216\u8c03\u5ea6\u5668\u5524\u9192\u3002</p> </li> </ul> <p>\u8fd9\u91cc\u6709\u4e00\u5904\u5c0f\u7ec6\u8282\uff1a<code>rest_init()</code> \u5355\u72ec\u62c6\u6210\u4e00\u4e2a\u51fd\u6570\u662f\u6709\u539f\u56e0\u7684\uff0c\u53ef\u5c55\u5f00\u4e0b\u9762\u7684\u65b9\u5757\u67e5\u770b\u3002</p> rest_init() \u4e3a\u4ec0\u4e48\u8981\u5355\u72ec\u62c6\u51fa\u6765\uff1f\uff08AI \u5206\u6790\uff09 <p>\u5b83\u88ab\u5355\u72ec\u62c6\u6210\u4e00\u4e2a <code>rest_init()</code>\uff0c\u4e3b\u8981\u662f\u4e3a\u4e86\u89e3\u51b3\u201c\u4ee3\u7801\u751f\u547d\u5468\u671f\u201d\u201c\u5e76\u53d1\u65f6\u5e8f\u201d\u548c\u201c\u8bed\u4e49\u5206\u5c42\u201d\u8fd9\u4e09\u4ef6\u4e8b\u3002</p> <p>\u6838\u5fc3\u52a8\u673a</p> <ul> <li> <p>\u907f\u514d\u88ab\u56de\u6536\u7684 init \u6bb5\u4ee3\u7801\u88ab\u7ee7\u7eed\u6267\u884c\u6216\u5f15\u7528</p> <ul> <li><code>start_kernel()</code> \u6807\u6ce8\u4e3a <code>__init</code>\uff0c\u5176\u4ee3\u7801\u6240\u5728\u7684 <code>.init.text</code> \u4f1a\u5728\u5f15\u5bfc\u540e\u901a\u8fc7 <code>free_initmem()</code> \u91ca\u653e\u4ee5\u8282\u7701\u5185\u5b58\u3002</li> <li>\u4f46\u5728\u201c\u7cfb\u7edf\u6d3b\u8fc7\u6765\u201d\u4e4b\u540e\uff0c\u6211\u4eec\u8981\u521b\u5efa\u5e76\u8fd0\u884c\u5185\u6838\u7ebf\u7a0b\uff08PID 1 \u7684 <code>kernel_init</code>\u3001<code>kthreadd</code>\uff09\uff0c\u5e76\u6700\u7ec8\u8fdb\u5165 CPU \u7684 idle \u5faa\u73af\u3002\u8fd9\u4e9b\u8def\u5f84\u4e0d\u80fd\u653e\u5728\u4f1a\u88ab\u91ca\u653e\u7684 <code>.init.text</code> \u91cc\u3002</li> <li>\u6240\u4ee5\u628a\u201c\u540e\u7eed\u5de5\u4f5c\u201d\u632a\u5230\u5e38\u9a7b\u7684 <code>.text</code> \u6bb5\u4e2d\u7684 <code>rest_init()</code> \u91cc\uff0c\u786e\u4fdd\u5373\u4fbf\u91ca\u653e\u4e86 <code>.init</code> \u6bb5\uff0c\u4e5f\u4e0d\u4f1a\u8e29\u7a7a\u3002</li> <li>\u6587\u4ef6\u91cc\u5c31\u6709\u660e\u786e\u6ce8\u91ca\uff1a\u5982\u679c\u4e0d\u8fd9\u4e48\u505a\uff0c\u201croot \u7ebf\u7a0b\u548c init \u7ebf\u7a0b\u4e4b\u95f4\u53ef\u80fd\u51fa\u73b0\u7ade\u4e89\uff0c\u4f7f\u5f97 <code>start_kernel</code> \u5728 root \u7ebf\u7a0b\u8fdb\u5165 idle \u524d\u5c31\u88ab <code>free_initmem</code> \u56de\u6536\u201d\uff0c\u56e0\u6b64 <code>rest_init()</code> \u5fc5\u987b\u662f\u975e <code>__init</code>\u3002</li> </ul> </li> <li> <p>\u9632\u6b62\u7f16\u8bd1\u5668\u628a\u975e init \u7684\u903b\u8f91\u5185\u8054\u56de init \u6bb5</p> <ul> <li><code>rest_init()</code> \u88ab\u6807\u6ce8\u4e3a <code>noinline</code>\uff1a\u65e7\u7248 gcc\uff083.4\uff09\u4f1a\u628a\u5b83\u5185\u8054\u8fdb <code>start_kernel()</code>\uff0c\u90a3\u6837\u53c8\u4f1a\u628a\u672c\u5e94\u5e38\u9a7b\u7684\u4ee3\u7801\u62c9\u56de <code>.init.text</code>\uff0c\u91ca\u653e\u540e\u51fa\u4e8b\u3002</li> <li>\u901a\u8fc7 <code>noinline</code> \u5f3a\u5236\u5b83\u7559\u5728\u5e38\u9a7b\u6bb5\uff0c\u548c\u4e0a\u9762\u201c\u907f\u514d\u56de\u6536\u201d\u4e00\u8d77\u5b9e\u73b0\u5185\u5b58\u751f\u547d\u5468\u671f\u7684\u5b89\u5168\u3002</li> </ul> </li> <li> <p>\u660e\u786e\u9636\u6bb5\u8fb9\u754c\uff1a\u4ece\u201c\u5355\u6838\u3001\u5173\u4e2d\u65ad\u3001\u65e0\u8c03\u5ea6\u201d\u7684\u65e9\u671f\u5f15\u5bfc\uff0c\u8fc7\u6e21\u5230\u201c\u591a\u4efb\u52a1\u3001\u53ef\u8c03\u5ea6\u201d\u7684\u6b63\u5e38\u8fd0\u884c</p> <ul> <li><code>rest_init()</code> \u505a\u7684\u4e8b\u6b63\u597d\u662f\u201c\u7cfb\u7edf\u5df2\u53ef\u8c03\u5ea6\u201d\u4e4b\u540e\u624d\u5e94\u8be5\u505a\u7684\uff1a<ul> <li>\u7528 <code>user_mode_thread(kernel_init, \u2026)</code> \u542f\u52a8 PID 1\uff08init \u8fdb\u7a0b\u7684\u5185\u6838\u7aef\u5165\u53e3\uff09\u3002</li> <li>\u542f\u52a8 <code>kthreadd</code> \u5e76\u7528 <code>complete(&amp;kthreadd_done)</code> \u4e0e PID 1 \u540c\u6b65\uff0c\u786e\u4fdd kthread \u6846\u67b6\u51c6\u5907\u5c31\u7eea\u3002</li> <li>\u8bbe\u7f6e <code>system_state = SYSTEM_SCHEDULING</code>\uff0c\u5f00\u542f <code>might_sleep()</code>/<code>smp_processor_id()</code> \u7b49\u68c0\u67e5\u3002</li> <li>\u8ba9\u5f15\u5bfc idle \u7ebf\u7a0b\u81f3\u5c11 <code>schedule()</code> \u4e00\u6b21\uff0c\u7136\u540e\u8fdb\u5165 <code>cpu_startup_entry(CPUHP_ONLINE)</code> \u7684 idle \u5faa\u73af\u3002</li> </ul> </li> <li>\u8fd9\u4e9b\u90fd\u4f9d\u8d56\u8c03\u5ea6\u5668\u5df2\u7ecf\u521d\u59cb\u5316\u5b8c\u6210\uff0c\u4e14\u4e0d\u5e94\u518d\u5c5e\u4e8e\u201c\u65e9\u671f init\u201d\u9636\u6bb5\u3002</li> </ul> </li> </ul> <p>\u4e00\u4e9b\u5c5e\u6027\u4e0e\u7ec6\u8282\u7684\u8bbe\u8ba1\u610f\u56fe</p> <ul> <li><code>__noreturn</code>\uff1a\u4ece <code>rest_init()</code> \u4e0d\u518d\u8fd4\u56de\uff08idle \u5faa\u73af\u91cc\u5f85\u673a\uff09\uff0c\u6e05\u6670\u8868\u8fbe\u63a7\u5236\u6d41\uff0c\u5e2e\u52a9\u7f16\u8bd1\u5668\u4f18\u5316\u4e0e\u53ef\u8bfb\u6027\u3002</li> <li><code>__ref</code>\uff1a<code>rest_init()</code> \u867d\u5728\u5e38\u9a7b\u6bb5\uff0c\u4f46\u9700\u8981\u8bbf\u95ee\u4e00\u4e9b <code>__initdata</code>\uff08\u6bd4\u5982 <code>kthreadd_done</code>\uff09\uff0c\u7528 <code>__ref</code> \u6291\u5236\u201c\u6bb5\u4e0d\u5339\u914d\u201d\u544a\u8b66\uff0c\u8868\u660e\u8fd9\u662f\u6709\u610f\u4e3a\u4e4b\u4e14\u5728 free_initmem \u524d\u5b8c\u6210\u3002</li> <li>\u4eb2\u548c\u6027\u4e0e\u65f6\u5e8f\u9632\u62a4\uff1a\u5728 <code>sched_init_smp()</code> \u5b8c\u6210\u524d\uff0c\u8fc1\u79fb\u8fd8\u4e0d\u5b8c\u5168\u53ef\u9760\uff0c\u6240\u4ee5\u628a init \u8fdb\u7a0b\u56fa\u5b9a\u5728\u542f\u52a8 CPU\uff08<code>PF_NO_SETAFFINITY</code>\u3001<code>set_cpus_allowed_ptr</code>\uff09\uff0c\u907f\u514d\u65e9\u671f\u8fc1\u79fb\u5e26\u6765\u7684\u4e0d\u786e\u5b9a\u6027\u3002</li> <li>\u6982\u5ff5\u89e3\u8026\uff1a<code>start_kernel()</code> \u8d1f\u8d23\u4e00\u6b21\u6027\u3001\u53ef\u56de\u6536\u7684\u65e9\u671f\u786c\u4ef6/\u5b50\u7cfb\u7edf\u521d\u59cb\u5316\uff1b<code>rest_init()</code> \u8d1f\u8d23\u8fc7\u6e21\u5230\u591a\u4efb\u52a1\u8fd0\u884c\u65f6\u5e76\u521b\u5efa\u6700\u521d\u7684\u5185\u6838/\u7528\u6237\u7a7a\u95f4\u8fdb\u7a0b\u3002\u8fd9\u6837\u4fbf\u4e8e\u5185\u5b58\u56de\u6536\u3001\u6e05\u6670\u804c\u8d23\u548c\u7ef4\u62a4\u3002</li> </ul> <p>\u4e00\u53e5\u8bdd\u603b\u7ed3</p> <ul> <li>\u628a\u201c\u7cfb\u7edf\u6d3b\u8fc7\u6765\u540e\u7684\u5de5\u4f5c\u201d\u653e\u5728\u5355\u72ec\u4e14\u5e38\u9a7b\u7684 <code>rest_init()</code> \u91cc\uff0c\u65e2\u80fd\u5b89\u5168\u91ca\u653e <code>.init</code> \u6bb5\u4ee5\u8282\u7701\u5185\u5b58\uff0c\u53c8\u80fd\u6b63\u786e\u5730\u5207\u5165\u53ef\u8c03\u5ea6\u7684\u8fd0\u884c\u6001\uff0c\u521b\u5efa PID 1 \u4e0e <code>kthreadd</code> \u5e76\u6700\u7ec8\u8fdb\u5165 idle\uff1b\u540c\u65f6\u7528 <code>noinline</code>\u3001<code>__noreturn</code>\u3001<code>__ref</code> \u7b49\u5c5e\u6027\u786e\u4fdd\u7f16\u8bd1\u4e0e\u94fe\u63a5\u671f\u4e0d\u4f1a\u628a\u5b83\u9519\u8bef\u5730\u6298\u56de\u53ef\u56de\u6536\u7684 init \u6bb5\u6216\u7834\u574f\u63a7\u5236\u6d41\u3002</li> </ul> </li> </ul>"},{"location":"ta/blog/1.pid0/#pid-2-\u4e0e\u8fdb\u7a0b\u62f7\u8d1d","title":"PID 2 \u4e0e\u8fdb\u7a0b\u62f7\u8d1d","text":"<p>\u63a5\u4e0b\u6765\u8ba9\u6211\u4eec\u770b\u770b\u7b2c\u4e00\u4e2a\u5185\u6838\u7ebf\u7a0b\uff08PID 2\uff09\u662f\u600e\u4e48\u8fd0\u884c\u8d77\u6765\u7684\u3002</p> \u5185\u6838\u7ebf\u7a0b\u521b\u5efa\u4e0e\u8fd0\u884c kernel/fork.c<pre><code>pid_t kernel_thread(int (*fn)(void *), void *arg, const char *name,\n      unsigned long flags)\n{\n    struct kernel_clone_args args = {\n        .fn  = fn,\n        .fn_arg  = arg,\n    };\n    return kernel_clone(&amp;args);\n}\n</code></pre> arch/riscv/kernel/process.c<pre><code>int copy_thread(struct task_struct *p, const struct kernel_clone_args *args){\n   /* p-&gt;thread holds context to be restored by __switch_to() */\n   if (unlikely(args-&gt;fn)) {\n        /* Kernel thread */\n        memset(childregs, 0, sizeof(struct pt_regs));\n        /* Supervisor/Machine, irqs on: */\n        childregs-&gt;status = SR_PP | SR_PIE;\n\n        p-&gt;thread.s[0] = (unsigned long)args-&gt;fn;\n        p-&gt;thread.s[1] = (unsigned long)args-&gt;fn_arg;\n        p-&gt;thread.ra = (unsigned long)ret_from_fork_kernel_asm;\n   } else {\n        *childregs = *(current_pt_regs());\n        if (usp) /* User fork */\n            childregs-&gt;sp = usp;\n        childregs-&gt;a0 = 0; /* Return value of fork() */\n        p-&gt;thread.ra = (unsigned long)ret_from_fork_user_asm;\n   }\n   p-&gt;thread.sp = (unsigned long)childregs; /* kernel sp */\n}\n</code></pre> <ul> <li> <p>\u901a\u8fc7 <code>kernel_thread()</code> \u521b\u5efa\u7684\u90fd\u662f\u5185\u6838\u7ebf\u7a0b\uff0c\u8fd0\u884c\u5728\u5185\u6838\u6001\u3002\u56e0\u4e3a\u521b\u5efa\u65f6\u4f1a\u5e26 <code>fn</code> \u53c2\u6570\uff0c\u5728 <code>copy_thread()</code> \u4e2d\u4f1a\u8d70\u5185\u6838\u7ebf\u7a0b\u7684\u5206\u652f\uff0c\u8bbe\u7f6e\u597d <code>s[0]</code>\u3001<code>s[1]</code> \u548c <code>ra</code>\uff0c\u8ba9\u65b0\u7ebf\u7a0b\u4ece <code>ret_from_fork_kernel_asm()</code> \u8fd4\u56de\uff0c\u6267\u884c\u4f20\u5165\u7684\u51fd\u6570\u3002</p> <p>\u7a0d\u540e\u4f1a\u4ecb\u7ecd PID 1 \u4f5c\u4e3a\u5185\u6838\u7ebf\u7a0b\u662f\u5982\u4f55\u8fdb\u5165\u7528\u6237\u6001\u7684\u3002<code>copy_thread()</code> \u7684\u53e6\u4e00\u4e2a\u5206\u652f\u60c5\u51b5\u6d89\u53ca\u7cfb\u7edf\u8c03\u7528 fork\uff0c\u5c06\u5728\u540e\u7eed\u7684\u6587\u7ae0\u5206\u6790\u3002</p> </li> <li> <p><code>ret_from_fork_kernel_asm()</code> \u5728\u5b9e\u9a8c\u6587\u6863\u4e2d\u5df2\u7ecf\u7ed9\u5927\u5bb6\u5c55\u793a\u8fc7\u4e86\uff0c\u5b83\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u8e66\u5e8a\u51fd\u6570\uff0c\u8d1f\u8d23\u8df3\u8f6c\u5230 <code>ret_from_fork_kernel()</code>\u3002\u540e\u8005\u4e5f\u53ea\u662f\u7b80\u5355\u5730\u8c03\u7528 <code>fn(fn_arg)</code>\uff0c\u5bf9\u4e8e PID 2 \u6765\u8bf4\u5c31\u662f <code>kthreadd()</code>\u3002</p> </li> <li> <p><code>kthreadd()</code> \u7684\u6838\u5fc3\u662f\u4e00\u4e2a\u65e0\u9650\u5faa\u73af\uff1a</p> kernel/kthread.c<pre><code>for (;;) {\n    set_current_state(TASK_INTERRUPTIBLE);\n    if (list_empty(&amp;kthread_create_list))\n        schedule();\n    __set_current_state(TASK_RUNNING);\n\n    spin_lock(&amp;kthread_create_lock);\n    while (!list_empty(&amp;kthread_create_list)) {\n        struct kthread_create_info *create;\n\n        create = list_entry(kthread_create_list.next,\n                struct kthread_create_info, list);\n        list_del_init(&amp;create-&gt;list);\n        spin_unlock(&amp;kthread_create_lock);\n\n        create_kthread(create);\n\n        spin_lock(&amp;kthread_create_lock);\n    }\n    spin_unlock(&amp;kthread_create_lock);\n}\n</code></pre> <ul> <li>\u5185\u6838\u7ebf\u7a0b\u7684\u8bf7\u6c42\u653e\u5728\u961f\u5217\u4e2d\uff0c\u5e76\u53d1\u60c5\u51b5\u9700\u8981\u7528\u9501\u4fdd\u62a4\u3002\u8fd9\u6bb5\u4ee3\u7801\u5411\u6211\u4eec\u5c55\u793a\u4e86\u4e00\u4e2a\u6d88\u8d39\u8005\u7ebf\u7a0b\u5e94\u8be5\u5982\u4f55\u5b89\u6392\u9501\u7684\u83b7\u53d6\u548c\u91ca\u653e\uff1a\u6d89\u53ca\u9501\u4fdd\u62a4\u7684\u7684\u6570\u636e\u7ed3\u6784\u7684\u67e5\u8be2\uff08<code>list_empty()</code> \u548c\u4fee\u6539 <code>list_del_init()</code>\uff09\u7684\u6574\u4e2a\u8fc7\u7a0b\uff0c\u9700\u8981\u6301\u6709\u9501\uff1b\u800c\u6267\u884c <code>create_kthread()</code> \u8fd9\u79cd\u53ef\u80fd\u963b\u585e\u7684\u64cd\u4f5c\u65f6\uff0c\u5fc5\u987b\u5148\u91ca\u653e\u9501\uff0c\u907f\u514d\u6b7b\u9501\u3002</li> <li>\u5b83\u6c38\u8fdc\u4e0d\u4f1a\u8fd4\u56de\uff0c\u56e0\u6b64 PID 2 \u6c38\u8fdc\u4e0d\u4f1a\u8d70\u5230 <code>ret_from_exception()</code>\uff0c\u8fd9\u662f\u5b83\u4e0e PID 1 \u7684\u91cd\u8981\u533a\u522b\u3002</li> </ul> </li> </ul>"},{"location":"ta/blog/1.pid0/#pid-1-\u4e0e\u7528\u6237\u6001","title":"PID 1 \u4e0e\u7528\u6237\u6001","text":"<p>\u6700\u540e\u6211\u4eec\u6765\u770b\u770b PID 1 \u662f\u5982\u4f55\u8fdb\u5165\u7528\u6237\u6001\u7684\u3002</p> <ul> <li> <p><code>copy_thread()</code> \u4e2d\u6709\u4e00\u4e2a\u5185\u8054\u51fd\u6570\u4e3a\u6211\u4eec\u63ed\u793a\u4e86\u5185\u6838\u6808\u7684\u5185\u5b58\u5e03\u5c40\uff1a</p> arch/riscv/include/asm/processor.h<pre><code>#define task_pt_regs(tsk)      \\\n((struct pt_regs *)(task_stack_page(tsk) + THREAD_SIZE  \\\n        - ALIGN(sizeof(struct pt_regs), STACK_ALIGN)))\n</code></pre> <p></p> \u5185\u6838\u6808\u5e03\u5c40 <p></p> <p>\u5728\u5b9e\u73b0\u4e86\u7cfb\u7edf\u8c03\u7528\u548c\u7528\u6237\u6001\uff08Lab4\uff09\u540e\uff0c\u6211\u4eec\u4f1a\u77e5\u9053\u7528\u6237\u6001\u6808\u548c\u5185\u6838\u6001\u6808\u662f\u5206\u5f00\u7684\u3002\u5185\u6838\u6808\u5c06\u7528\u4e8e\uff1a</p> <ul> <li>Trap \u5904\u7406\u671f\u95f4\u5185\u6838\u4ee3\u7801\u7684\u8c03\u7528\u6808</li> <li> <p>\u8fdb\u5165 Trap \u65f6\u4fdd\u5b58\u5bc4\u5b58\u5668\u72b6\u6001\uff0c\u76f8\u5e94\u7684\u7ed3\u6784\u4f53\u4e3a <code>struct pt_regs</code></p> arch/riscv/include/asm/ptrace.h<pre><code>struct pt_regs {\n    unsigned long epc;\n    unsigned long ra;\n    unsigned long sp;\n    unsigned long gp;\n    unsigned long tp;\n    unsigned long t0;\n    unsigned long t1;\n    // ...\n    /*Supervisor/Machine CSRs */\n    unsigned long status;\n    unsigned long badaddr;\n    unsigned long cause;\n    /* a0 value before the syscall*/\n    unsigned long orig_a0;\n};\n</code></pre> </li> </ul> <p>\u8fd9\u4e00\u5e03\u5c40\u5f88\u91cd\u8981\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u7814\u7a76 Trap \u5904\u7406\u65f6\u4f1a\u7528\u5230\u3002</p> <p>\u6b64\u5916\uff0c\u5185\u6838\u7ebf\u7a0b\u8bbe\u7f6e\u4e86 <code>SR_PP | SR_PIE</code>\uff0c\u8fd9\u610f\u5473\u7740 <code>sret</code> \u5c06\u8fd4\u56de\u7528\u6237\u6001\u4e14\u5f00\u542f\u4e2d\u65ad\u3002PID 2 \u56e0\u4e3a\u6c38\u8fdc\u4e0d\u4f1a <code>sret</code> \u6240\u4ee5\u8fd9\u4e00\u70b9\u65e0\u5173\u7d27\u8981\uff0c\u4f46 PID 1 \u7528\u5230\u4e86\u8fd9\u4e00\u70b9\u3002</p> </li> <li> <p><code>kernel_init()</code> \u7684\u5185\u5bb9\uff1a</p> <ul> <li>\u7b49\u5f85 <code>kthreadd</code> \u5b8c\u6210\u521d\u59cb\u5316\u5de5\u4f5c</li> <li><code>kernel_init_freeable() -&gt; smp_init()</code>\uff1a\u542f\u52a8\u5176\u4ed6 CPU \u6838\u5fc3</li> <li> <p><code>run_init_process()</code>\uff1a\u52a0\u8f7d\u7b2c\u4e00\u4e2a\u7528\u6237\u6001\u7a0b\u5e8f</p> <p>\u73b0\u4ee3 Linux \u53d1\u884c\u7248\u7684\u7b2c\u4e00\u4e2a\u7528\u6237\u6001\u7a0b\u5e8f\u4e00\u822c\u662f systemd\uff0c\u8d1f\u8d23\u542f\u52a8\u7528\u6237\u7a7a\u95f4\u7684\u5404\u79cd\u670d\u52a1\u3002</p> </li> </ul> </li> <li> <p><code>run_init_process()</code> \u4f7f\u7528 <code>kernel_execve()</code> \u6765\u52a0\u8f7d\u7528\u6237\u6001\u7a0b\u5e8f\uff0c\u63a5\u4e0b\u6765\u7684\u6d41\u7a0b\u4e0e <code>exec</code> \u7cfb\u7edf\u8c03\u7528\u76f8\u540c\uff0c\u53ef\u4ee5\u770b\u8fd9\u7bc7\u6587\u7ae0\uff1aHow does the Linux Kernel start a Process\u3002</p> <p></p> \u7528\u6237\u6001\u7ebf\u7a0b\u521b\u5efa\u4e0e\u8fd0\u884c <p></p> <p>\u6b64\u5904\u4e0d\u5bf9\u6d41\u7a0b\u5c55\u5f00\u4ecb\u7ecd\uff0c\u4ec5\u5173\u6ce8\u5176\u4e2d\u7684\u91cd\u70b9\uff1a<code>start_thread()</code>\u3002</p> fs/binfmt_elf.c<pre><code>regs = current_pt_regs();\nSTART_THREAD(elf_ex, regs, elf_entry, bprm-&gt;p);\n</code></pre> include/linux/elf.h<pre><code>#define START_THREAD(elf_ex, regs, elf_entry, start_stack) \\\n    start_thread(regs, elf_entry, start_stack)\n</code></pre> arch/riscv/kernel/process.c<pre><code>void start_thread(struct pt_regs *regs, unsigned long pc,\n    unsigned long sp)\n{\n    regs-&gt;status = SR_PIE;\n    regs-&gt;epc = pc;\n    regs-&gt;sp = sp;\n\n    regs-&gt;status &amp;= ~SR_UXL;\n\n    if (is_compat_task())\n        regs-&gt;status |= SR_UXL_32;\n    else\n        regs-&gt;status |= SR_UXL_64;\n}\n</code></pre> <p>\u5b83\u8bbe\u7f6e\u4e86\u5b58\u653e\u5728\u5185\u6838\u6808\u9876\u7684 <code>struct pt_regs</code>\uff1a</p> <ul> <li>\u5f00\u542f\u4e86\u5176\u4e2d\u7684 <code>SR_PIE</code></li> <li><code>epc</code> \u8bbe\u7f6e\u4e3a\u7528\u6237\u7a0b\u5e8f\u7684\u5165\u53e3\u5730\u5740</li> <li><code>sp</code> \u8bbe\u7f6e\u4e3a\u7528\u6237\u7a0b\u5e8f\u7684\u7528\u6237\u6001\u6808\u5730\u5740</li> </ul> <p>\u6b64\u5916\u4e5f\u53ef\u4ee5\u53d1\u73b0\uff0cLinux \u652f\u6301 RV64 \u67b6\u6784\u4e0b\u8fd0\u884c RV32 \u7684\u7528\u6237\u6001\u7a0b\u5e8f\uff0c\u8fd9\u662f\u901a\u8fc7\u63a7\u5236 <code>sstatus</code> \u7684 <code>UXL</code> \u4f4d\u5b9e\u73b0\u7684\u3002</p> </li> <li> <p><code>ret_from_exception()</code>\uff1a</p> <p>\u4e0e <code>kthreadd()</code> \u4e0d\u540c\uff0c<code>kernel_init()</code> \u6700\u7ec8\u4f1a\u7ed3\u675f\uff0c\u8fd4\u56de\u5230\u5b83\u4f5c\u4e3a <code>fn(fn_arg)</code> \u88ab\u8c03\u7528\u7684\u5730\u65b9\uff08<code>ret_from_fork_kernel()</code>\uff09\u3002\u7136\u540e\u7ee7\u7eed\u8fd4\u56de\u5230 <code>ret_from_fork_kernel_asm()</code>\uff0c\u5b83\u63a5\u4e0b\u6765\u5c06\u8c03\u7528 <code>ret_from_exception()</code>\u3002</p> <p>\u8be5\u6c47\u7f16\u51fd\u6570\u7684\u4efb\u52a1\u662f\u4ece <code>struct pt_regs</code> \u4e2d\u6062\u590d\u5bc4\u5b58\u5668\uff0c\u5e76\u6267\u884c <code>sret</code> \u7ed3\u675f Trap \u5904\u7406\u3002</p> arch/riscv/kernel/entry.S<pre><code>SYM_CODE_START_NOALIGN(ret_from_exception)\n    REG_L s0, PT_STATUS(sp)\n    andi s0, s0, SR_SPP\n    bnez s0, 1f\n\n    /* Save unwound kernel stack pointer in thread_info */\n    addi s0, sp, PT_SIZE_ON_STACK\n    REG_S s0, TASK_TI_KERNEL_SP(tp)\n    /*\n    * Save TP into the scratch register , so we can find the kernel data\n    * structures again.\n    */\n    csrw CSR_SCRATCH, tp\n\n1:\n    REG_L a0, PT_STATUS(sp)\n    REG_L  a2, PT_EPC(sp)\n    REG_SC x0, a2, PT_EPC(sp)\n\n    csrw CSR_STATUS, a0\n    csrw CSR_EPC, a2\n\n    REG_L x1,  PT_RA(sp)\n    REG_L x3,  PT_GP(sp)\n    REG_L x4,  PT_TP(sp)\n    REG_L x5,  PT_T0(sp)\n    restore_from_x6_to_x31\n    REG_L x2,  PT_SP(sp)\n\n    sret\n</code></pre> <ul> <li>\u5b83\u9996\u5148\u68c0\u67e5 <code>sstatus.SPP</code> \u5224\u65ad\u7a0d\u540e\u5c06\u8fd4\u56de\u7684\u662f\u4ec0\u4e48\u6001\u3002\u5982\u679c\u662f\u7528\u6237\u6001\uff08PID 1 \u60c5\u51b5\uff09\u5219\u989d\u5916\u505a\u4e00\u4e9b\u5de5\u4f5c\uff1a\u4fdd\u5b58\u5185\u6838\u6808\u6307\u9488\u5230 <code>thread_info</code>\uff0c\u5e76\u5c06 <code>tp</code> \u5bc4\u5b58\u5668\u5199\u5165 <code>sscratch</code>\uff0c\u4ee5\u4fbf\u540e\u7eed\u8fdb\u5165 Trap \u65f6\u80fd\u627e\u5230\u5185\u6838\u6570\u636e\u7ed3\u6784\u3002</li> <li>\u4e0d\u7ba1\u8fd4\u56de\u7684\u662f\u4ec0\u4e48\u6001\uff0c\u90fd\u4f1a\u4ece\u5185\u6838\u6808 <code>struct pt_regs</code> \u4e2d\u6062\u590d\u6240\u6709\u5bc4\u5b58\u5668\uff0c\u5e76\u6267\u884c <code>sret</code>\u3002</li> </ul> <p>\u6ce8\u610f\u5230 <code>start_thread()</code> \u4e2d\u8bbe\u7f6e\u4e86 <code>regs-&gt;status</code>\uff0c\u4ec5 <code>SR_PIE</code> \u88ab\u7f6e\u4f4d\uff0c\u610f\u5473\u7740 <code>SR_SPP=0</code>\uff0c\u56e0\u6b64 <code>sret</code> \u5c06\u8fd4\u56de\u7528\u6237\u6001\uff0c\u5e76\u4e14\u5f00\u542f\u4e2d\u65ad\u3002</p> </li> </ul> <p>Success</p> <p>\u81f3\u6b64\uff0c\u6211\u4eec\u7406\u6e05\u4e86 Linux \u542f\u52a8\u9636\u6bb5\u6700\u91cd\u8981\u7684\u4e09\u4e2a\u8fdb\u7a0b\uff08PID 0\u30011\u30012\uff09\u7684\u6267\u884c\u6d41\u7a0b\uff0c\u7406\u89e3\u4e86\u5185\u6838\u6808\u7684\u5e03\u5c40\u548c <code>struct pt_regs</code> \u7684\u4f5c\u7528\uff0c\u5e76\u4e14\u77e5\u9053\u4e86\u5185\u6838\u7ebf\u7a0b\u548c\u7528\u6237\u6001\u7ebf\u7a0b\u7684\u533a\u522b\u3002</p>"},{"location":"ta/blog/1.pid0/#linux-trap-\u5904\u7406","title":"Linux Trap \u5904\u7406","text":"<p>Linux \u7684 Trap \u5904\u7406\u4f4d\u4e8e\u5404\u67b6\u6784\u4e0b\u7684 <code>entry.S</code>\uff0cRISC-V \u7684\u5904\u7406\u6d41\u7a0b\u68b3\u7406\u5982\u4e0b\uff1a</p> RISC-V \u67b6\u6784\u4e0b\u7684 Trap \u5904\u7406\u6d41\u7a0b <ul> <li> <p>\u4e2d\u65ad\u4e0e\u5f02\u5e38\u7684\u5206\u6d41\uff1a</p> arch/riscv/kernel/entry.S<pre><code>/*\n* MSB of cause differentiates between\n* interrupts and exceptions\n*/\n    bge s4, zero, 1f\n/* Handle interrupts */\n    call do_irq\n    j ret_from_exception\n1:\n    /*Handle other exceptions */\n    slli t0, s4, RISCV_LGPTR\n    la t1, excp_vect_table\n    la t2, excp_vect_table_end\n    add t0, t1, t0\n    /* Check if exception code lies within bounds*/\n    bgeu t0, t2, 3f\n    REG_L t1, 0(t0)\n2:  jalr t1\n    j ret_from_exception\n</code></pre> <p>\u5148\u524d\u5c06 <code>cause</code> \u8bfb\u5165\u4e86 <code>s4</code> \u5bc4\u5b58\u5668\uff0c\u8fd9\u91cc\u6839\u636e\u6700\u9ad8\u4f4d\u5224\u65ad\u662f\u4e2d\u65ad\u8fd8\u662f\u5f02\u5e38\u3002\u4e2d\u65ad\u8fdb\u5165 <code>do_irq()</code> \u5904\u7406\uff0c\u5f02\u5e38\u5219\u901a\u8fc7\u5f02\u5e38\u5411\u91cf\u8868\u5206\u6d41\u5230\u5177\u4f53\u7684\u5f02\u5e38\u5904\u7406\u51fd\u6570\u3002</p> </li> </ul>"},{"location":"ta/blog/1.pid0/#\u5f02\u5e38\u5411\u91cf\u8868","title":"\u5f02\u5e38\u5411\u91cf\u8868","text":"<p>\u5f02\u5e38\u5411\u91cf\u8868\u5728 <code>entry.S</code> \u7684\u672b\u5c3e\uff1a</p> arch/riscv/kernel/entry.S<pre><code>    .section \".rodata\"\n    .align LGREG\n    /* Exception vector table */\nSYM_DATA_START_LOCAL(excp_vect_table)\n    RISCV_PTR do_trap_insn_misaligned\n    ALT_INSN_FAULT(RISCV_PTR do_trap_insn_fault)\n    RISCV_PTR do_trap_insn_illegal\n    RISCV_PTR do_trap_break\n    RISCV_PTR do_trap_load_mi\n    #...\n    RISCV_PTR do_trap_ecall_u /* system call */\n</code></pre> <p>\u5177\u4f53\u7684\u51fd\u6570\u5b9e\u73b0\u57fa\u672c\u90fd\u5728 <code>arch/riscv/kernel/traps.c</code> \u4e2d\u3002\u4ee5\u7cfb\u7edf\u8c03\u7528\uff08ecall \u5f02\u5e38\uff09\u7684\u5904\u7406\u4e3a\u4f8b\uff0c\u4e0a\u8868\u4e2d\u4e3a <code>do_trap_ecall_u</code>\uff1a</p> arch/riscv/kernel/traps.c<pre><code>asmlinkage __visible __trap_section  __no_stack_protector\nvoid do_trap_ecall_u(struct pt_regs *regs)\n{\n    if (user_mode(regs)) {\n        long syscall = regs-&gt;a7;\n\n        regs-&gt;epc += 4;\n        regs-&gt;orig_a0 = regs-&gt;a0;\n        regs-&gt;a0 = -ENOSYS;\n\n        syscall = syscall_enter_from_user_mode(regs, syscall);\n\n        if (syscall &gt;= 0 &amp;&amp; syscall &lt; NR_syscalls)\n            syscall_handler(regs, syscall);\n\n        syscall_exit_to_user_mode(regs);\n    } else {\n        //...\n    }\n}\n</code></pre> <ul> <li> <p><code>user_mode(regs)</code> \u68c0\u67e5 <code>sstatus.SPP</code>\uff0c\u786e\u8ba4\u662f\u7528\u6237\u6001\u7684\u7cfb\u7edf\u8c03\u7528</p> arch/riscv/include/asm/ptrace.h<pre><code>#define user_mode(regs) (((regs)-&gt;status &amp; SR_PP) == 0)\n</code></pre> </li> <li> <p><code>syscall_handler()</code> \u662f\u4e00\u4e2a\u7c7b\u4f3c <code>kthread()</code> \u7684 wrapper\uff0c\u53ea\u4e0d\u8fc7\u662f\u7528\u4e8e\u7cfb\u7edf\u8c03\u7528\u7684\u8df3\u8f6c\u8868\uff1a</p> arch/riscv/include/asm/syscall.h<pre><code>typedef long (*syscall_t)(const struct pt_regs *);\nstatic inline void syscall_handler(struct pt_regs *regs, ulong syscall)\n{\n    syscall_t fn;\n    fn = sys_call_table[syscall];\n    regs-&gt;a0 = fn(regs);\n}\n</code></pre> </li> </ul>"},{"location":"ta/blog/1.pid0/#\u901a\u7528\u4e2d\u65ad\u5904\u7406irq-\u5c42","title":"\u901a\u7528\u4e2d\u65ad\u5904\u7406\uff08IRQ \u5c42\uff09","text":"<p>\u4ee5\u524d\u5b66\u300a\u64cd\u4f5c\u7cfb\u7edf\u300b\u3001\u8bfb\u300aLinux Kernel Development\u300b\u65f6\uff0c\u7b14\u8005\u6ca1\u592a\u7406\u89e3\u5916\u90e8\u4e2d\u65ad\u3001IRQ Line \u4e4b\u7c7b\u7684\u4e1c\u897f\u3002\u8fd9\u6b21\u63a2\u7a76 RISC-V \u67b6\u6784\u7684\u4e2d\u65ad\u5904\u7406\u65f6\uff0c\u624d\u660e\u767d\u8fd9\u4e9b\u6982\u5ff5\u3002</p> <p>\u4e0b\u5217\u6587\u7ae0\u5bf9 RISC-V \u67b6\u6784\u7684\u4e2d\u65ad\u5b50\u7cfb\u7edf\u505a\u4e86\u5f88\u597d\u7684\u5206\u6790\uff0c\u63a8\u8350\u9605\u8bfb\uff1a</p> <ul> <li>RISC-V \u4e2d\u65ad\u5b50\u7cfb\u7edf\u5206\u6790\u2014\u2014\u786c\u4ef6\u53ca\u5176\u521d\u59cb\u5316 - \u6cf0\u6653\u79d1\u6280</li> <li>RISC-V CLINT\u3001PLIC \u53ca\u82af\u6765 ECLIC \u4e2d\u65ad\u673a\u5236\u5206\u6790 \u2014\u2014 RISC-V \u4e2d\u65ad\u673a\u5236\uff08\u4e00\uff09_riscv clint-CSDN \u535a\u5ba2</li> </ul> <p>\u7b80\u5355\u603b\u7ed3\u4e00\u4e0b\uff1a</p> <ul> <li> <p>RISC-V \u89c4\u8303\u5b9a\u4e49\u4e86 CLINT\uff08Core-Local Interrupt Controller\uff09\u548c PLIC\uff08Platform-Level Interrupt Controller\uff09\u4e24\u79cd\u4e92\u8865\u7684\u4e2d\u65ad\u63a7\u5236\u5668\u3002\u524d\u8005\u8d1f\u8d23\u672c\u5730\u4e2d\u65ad\uff08\u5982\u5b9a\u65f6\u5668\u4e2d\u65ad\u3001\u8f6f\u4ef6\u4e2d\u65ad\uff09\uff0c\u540e\u8005\u8d1f\u8d23\u5916\u90e8\u4e2d\u65ad\uff08\u5982\u5916\u8bbe\u4e2d\u65ad\uff09\u3002PLIC \u8d1f\u8d23\u7684\u5916\u90e8\u4e2d\u65ad\u624d\u662f\u73b0\u5b9e\u4e16\u754c\u4e2d\u6700\u91cd\u8981\u7684\u4e2d\u65ad\u6765\u6e90\uff0c\u7136\u800c\u64cd\u4f5c\u7cfb\u7edf\u8bfe\u7a0b\u5e76\u4e0d\u6d89\u53ca\u5916\u8bbe\u548c\u9a71\u52a8\u7b49\u8bdd\u9898\u3002</p> <p></p> RISC-V PLIC \u8d1f\u8d23\u5916\u90e8\u4e2d\u65ad\u7684\u5904\u7406 <p></p> </li> <li> <p>\u5916\u90e8\u4e2d\u65ad\u6709\u975e\u5e38\u591a\u7684\u6765\u6e90\uff0c\u6bd4\u5982\u952e\u76d8\u3001\u9f20\u6807\u3001\u7f51\u7edc\u63a5\u53e3\u5361\u7b49\u5916\u8bbe\u90fd\u53ef\u80fd\u4ea7\u751f\u4e2d\u65ad\u4fe1\u53f7\u3002\u4e3a\u4e86\u533a\u5206\u4e0d\u540c\u6765\u6e90\u7684\u4e2d\u65ad\uff0cPLIC \u4e3a\u6bcf\u4e2a\u4e2d\u65ad\u6e90\u5206\u914d\u4e86\u4e00\u4e2a\u552f\u4e00\u7684\u4e2d\u65ad\u53f7\uff08interrupt ID\uff09\uff0c\u64cd\u4f5c\u7cfb\u7edf\u901a\u8fc7\u8bfb\u53d6 PLIC \u7684\u5bc4\u5b58\u5668\u6765\u8bc6\u522b\u548c\u5904\u7406\u8fd9\u4e9b\u4e2d\u65ad\u3002\u8fd9\u5bf9\u5e94 Linux \u4e2d\u7684 IRQ \u53f7\u3002</p> </li> </ul> <p>\u56e0\u4e3a\u8bbe\u5907\u9a71\u52a8\u7b49\u5185\u5bb9\u662f\u8de8\u67b6\u6784\u7684\uff0c\u56e0\u6b64 Linux \u521b\u9020\u4e86\u4e00\u4e2a\u7edf\u4e00\u7684 IRQ \u5c42\u6765\u5c4f\u853d\u5e95\u5c42\u786c\u4ef6\u7684\u5dee\u5f02\uff0c\u6211\u4eec\u770b\u770b IRQ \u5c42\u662f\u5982\u4f55\u8fdb\u5165\u7684\uff1a</p> RISC-V \u67b6\u6784\u4e0b\u7684 IRQ \u5904\u7406\u6d41\u7a0b <ul> <li> <p>\u5d4c\u5957\u4e2d\u65ad\u7684\u5904\u7406\uff1a</p> arch/riscv/kernel/traps.c<pre><code>static void noinstr handle_riscv_irq(struct pt_regs *regs)\n{\n    struct pt_regs *old_regs;\n\n    irq_enter_rcu();\n    old_regs = set_irq_regs(regs);\n    handle_arch_irq(regs);\n    set_irq_regs(old_regs);\n    irq_exit_rcu();\n}\n</code></pre> include/asm-generic/irq_regs.h<pre><code>static inline struct pt_regs *set_irq_regs(struct pt_regs *new_regs)\n{\n    struct pt_regs *old_regs;\n\n    old_regs = __this_cpu_read(__irq_regs);\n    __this_cpu_write(__irq_regs, new_regs);\n    return old_regs;\n}\n</code></pre> <p><code>set_irq_regs()</code> \u5c06\u5f53\u524d CPU \u7684 <code>__irq_regs</code> \u8bbe\u7f6e\u4e3a\u4f20\u5165\u7684 <code>regs</code>\uff0c\u5e76\u8fd4\u56de\u4e4b\u524d\u7684\u503c\u3002<code>__irq_regs</code> \u7528\u4e8e\u4fdd\u5b58\u5f53\u524d\u6b63\u5728\u5904\u7406\u7684\u4e2d\u65ad\u7684\u5bc4\u5b58\u5668\u72b6\u6001\uff0c\u65b9\u4fbf\u5d4c\u5957\u4e2d\u65ad\u65f6\u6062\u590d\u3002</p> <p>\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\u5728\u5185\u6838\u6001\u4e0b\u8fdb\u5165\u4e2d\u65ad\u5904\u7406\u65f6\uff0c<code>sp</code> \u6301\u7eed\u5411\u4e0b\u589e\u957f\uff0c\u5d4c\u5957\u4e2d\u65ad\u7684\u72b6\u6001\u4f1a\u88ab\u4f9d\u6b21\u538b\u5165\u5185\u6838\u6808\u4e2d\u3002\u5982\u679c\u4e2d\u65ad\u5d4c\u5957\u8fc7\u591a\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u5185\u6838\u6808\u6ea2\u51fa\u3002\u56e0\u6b64 <code>handle_exception()</code> \u4e2d\u6709\u5bf9\u5185\u6838\u6808\u6ea2\u51fa\u7684\u68c0\u67e5\u548c\u5904\u7406\uff0c\u8fd9\u91cc\u4e0d\u7ee7\u7eed\u5c55\u5f00\u3002</p> </li> <li> <p><code>handle_arch_irq</code> \u662f\u4e00\u4e2a\u51fd\u6570\u6307\u9488\u53d8\u91cf\uff1a</p> kernel/irq/handle.c<pre><code>#ifdef CONFIG_GENERIC_IRQ_MULTI_HANDLER\nvoid (*handle_arch_irq)(struct pt_regs *) __ro_after_init;\n#endif\n</code></pre> <p>\u5728\u7cfb\u7edf\u542f\u52a8\u9636\u6bb5\uff08<code>start_kernel()</code>\uff09\uff0cLinux \u5c1d\u8bd5\u5bfb\u627e\u4e2d\u65ad\u63a7\u5236\u5668\uff08<code>irqchip_init()</code>\uff09\uff0c\u7531\u5bf9\u5e94\u4e2d\u65ad\u63a7\u5236\u5668\u7684\u9a71\u52a8\u8c03\u7528 <code>set_handle_irq()</code> \u5c06\u8fd9\u4e2a\u51fd\u6570\u6307\u9488\u8bbe\u7f6e\u4e3a\u5177\u4f53\u7684\u4e2d\u65ad\u5904\u7406\u51fd\u6570\u3002</p> <p>\u4ee5 RISC-V Hart-Level Interrupt Controller (HLIC) \u4e3a\u4f8b\uff1a</p> <ul> <li>\u5176\u9a71\u52a8\u4f4d\u4e8e <code>drivers/irqchip/irq-riscv/intc.c</code>\uff0c\u5c06 <code>riscv_intc_irq()</code> \u8bbe\u7f6e\u4e3a\u4e2d\u65ad\u5904\u7406\u51fd\u6570\u3002</li> <li>\u8fd9\u4e2a\u4e2d\u65ad\u5904\u7406\u51fd\u6570\u4f1a\u4ece PLIC \u8bfb\u53d6\u4e2d\u65ad\u53f7\uff0c\u5e76\u8c03\u7528\u901a\u7528\u7684 IRQ \u5904\u7406\u51fd\u6570 <code>generic_handle_domain_irq()</code>\u3002</li> <li>\u901a\u7528 IRQ \u5c42\u5c06\u4e2d\u65ad\u5206\u53d1\u7ed9\u5177\u4f53\u7684\u8bbe\u5907\u9a71\u52a8\u7b49\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\u3002</li> </ul> </li> </ul>"},{"location":"ta/blog/1.pid0/#\u65f6\u949f\u4e2d\u65ad","title":"\u65f6\u949f\u4e2d\u65ad","text":"<p>\u672c\u8282\u4ee5\u65f6\u949f\u4e2d\u65ad\u4e3a\u4f8b\uff0c\u63a2\u7a76 IRQ \u5c42\u7684\u5904\u7406\u6d41\u7a0b\u3002\u6e90\u7801\u89c1 <code>drivers/clocksource/timer-riscv.c</code>\u3002</p> <ul> <li> <p><code>riscv_timer_init_common()</code>\uff1a\u65f6\u949f\u521d\u59cb\u5316\u3002</p> <p>\u8c03\u7528 <code>irq_find_matching_fwnode()</code>\u3001<code>irq_create_mapping()</code> \u7b49\u51fd\u6570\u4e3a\u65f6\u949f\u4e2d\u65ad\u5206\u914d IRQ \u53f7\uff0c\u5e76\u901a\u8fc7 <code>request_percpu_irq()</code> \u6ce8\u518c\u4e2d\u65ad\u5904\u7406\u51fd\u6570 <code>riscv_timer_interrupt()</code>\u3002</p> </li> <li> <p>\u4e24\u4e2a\u64cd\u63a7\u65f6\u949f\u7684\u51fd\u6570\uff1a</p> <ul> <li><code>riscv_clock_next_event()</code>\uff1a\u548c\u5b9e\u9a8c\u5185\u5bb9\u4e00\u6837\uff0c\u8c03\u7528 <code>sbi_set_timer()</code> \u6216\u76f4\u63a5\u5199 <code>stimecmp</code> \u8bbe\u7f6e\u4e0b\u4e00\u4e2a\u65f6\u949f\u4e2d\u65ad\u65f6\u95f4\u3002</li> <li><code>riscv_clock_event_stop()</code>\uff1a\u5c06\u4e0b\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\u65f6\u95f4\u8bbe\u7f6e\u4e3a\u6700\u5927\u503c\uff0c\u5373\u505c\u6b62\u65f6\u949f\u4e2d\u65ad\u3002</li> </ul> <p>\u8fd9\u4e9b\u51fd\u6570\u5728\u51e0\u4e2a\u5730\u65b9\u88ab\u8c03\u7528\uff1a</p> <ul> <li><code>riscv_timer_interrupt()</code>\uff1a\u6bcf\u4e2a\u65f6\u949f\u4e2d\u65ad\u8c03\u7528</li> <li><code>riscv_timer_dying_cpu()</code>\uff1aCPU \u4e0b\u7ebf\u65f6\u8c03\u7528\uff0c\u5173\u95ed\u65f6\u949f</li> <li><code>riscv_timer_starting_cpu()</code>\uff1aCPU \u4e0a\u7ebf\u65f6\u8c03\u7528\uff0c\u914d\u7f6e\u9996\u4e2a\u65f6\u949f\u4e2d\u65ad</li> </ul> </li> </ul> <p>Success</p> <p>\u81f3\u6b64\uff0c\u6211\u4eec\u7406\u6e05\u4e86 RISC-V \u67b6\u6784\u4e0b Linux \u7684 Trap \u5904\u7406\u6d41\u7a0b\uff0c\u7406\u89e3\u4e86\u5f02\u5e38\u5411\u91cf\u8868\u7684\u4f5c\u7528\uff0c\u8ba4\u8bc6\u4e86 IRQ \u5c42\u7684\u8bbe\u8ba1\u7406\u5ff5\uff0c\u5e76\u4e14\u4e86\u89e3\u4e86\u65f6\u949f\u4e2d\u65ad\u7684\u5904\u7406\u8fc7\u7a0b\u3002</p>"},{"location":"ta/blog/1.pid0/#linux-\u8c03\u5ea6\u4e0e\u4e0a\u4e0b\u6587\u5207\u6362","title":"Linux \u8c03\u5ea6\u4e0e\u4e0a\u4e0b\u6587\u5207\u6362","text":"<p>Linux \u7684 <code>swithc_to</code> \u903b\u8f91\u548c\u5b9e\u9a8c\u5b9e\u73b0\u7684\u6ca1\u4ec0\u4e48\u5dee\u522b\uff0c\u6574\u4f53\u6d41\u7a0b\u5982\u4e0b\uff1a</p> Linux \u4e0a\u4e0b\u6587\u5207\u6362\u6d41\u7a0b"},{"location":"ta/blog/1.pid0/#\u8c03\u5ea6\u5165\u53e3","title":"\u8c03\u5ea6\u5165\u53e3","text":"<p><code>__schedule()</code> \u662f\u8c03\u5ea6\u5668\u7684\u5165\u53e3\u3002\u4e0a\u56fe\u5df2\u7ecf\u6e05\u6670\u5730\u5c55\u73b0\u51fa\u6709\u5927\u7ea6 6 \u4e2a\u8def\u5f84\u53ef\u4ee5\u8fdb\u5165\u8c03\u5ea6\u5668\u3002\u5173\u4e8e\u8fd9\u4e9b\u8def\u5f84\u7684\u8fdb\u4e00\u6b65\u5206\u6790\uff0c\u53ef\u4ee5\u53c2\u8003\u4e0b\u5217\u6587\u7ae0\uff1a</p> <ul> <li>Linux \u8c03\u5ea6\u2014\u2014\u6982\u8ff0</li> <li>Linux schedule \u539f\u59cb\u78bc\u89e3\u8b80 - davidLei</li> </ul>"},{"location":"ta/blog/1.pid0/#\u4e0a\u4e0b\u6587\u5207\u6362\u7684\u4e2d\u65ad\u5f00\u5173","title":"\u4e0a\u4e0b\u6587\u5207\u6362\u7684\u4e2d\u65ad\u5f00\u5173","text":"<p>\u8fd9\u91cc\u91cd\u70b9\u63a2\u7a76\u4e00\u4e0b\u4e0a\u4e0b\u6587\u5207\u6362\u671f\u95f4\u4e2d\u65ad\u7684\u5f00\u542f\u4e0e\u5173\u95ed\uff0c\u5176\u5b9e\u4e0a\u56fe\u4e5f\u6807\u660e\u4e86\u3002</p> <p>\u9996\u5148\uff0cLinux \u63d0\u4f9b\u56db\u4e2a\u51fd\u6570\u7528\u4e8e\u7ba1\u7406\u4e2d\u65ad\uff1a</p> include/linux/irqflags.h<pre><code>#define local_irq_enable() do { raw_local_irq_enable(); } while (0)\n#define local_irq_disable() do { raw_local_irq_disable(); } while (0)\n#define local_irq_save(flags) do { raw_local_irq_save(flags); } while (0)\n#define local_irq_restore(flags) do { raw_local_irq_restore(flags); } while (0)\n#define safe_halt()  do { raw_safe_halt(); } while (0)\n</code></pre> <p>\u5176\u6b21\uff0c\u8c03\u5ea6\u5165\u53e3\u4e00\u5b9a\u4f1a\u65e0\u6761\u4ef6\u5730\u5173\u95ed\u4e2d\u65ad\uff1a</p> kernel/sched/core.c<pre><code>static void __sched notrace __schedule(int sched_mode)\n{\n    local_irq_disable();\n}\n</code></pre> <p>\u6700\u540e\uff0c\u5728\u4e0a\u4e0b\u6587\u5207\u6362\u5b8c\u6210\u540e\u7684 <code>finish_task_switch()</code> \u4e2d\uff0c\u4e5f\u4f1a\u901a\u8fc7 <code>raw_spin_rq_unlock_irq()</code> \u65e0\u6761\u4ef6\u5730\u8c03\u7528 <code>local_irq_enable()</code> \u5f00\u542f\u4e2d\u65ad\u3002</p> <p>\u8fd9\u91cc\u7684\u201c\u65e0\u6761\u4ef6\u201d\u6307\u7684\u662f\u8c03\u7528\u8def\u5f84\u4e0a\u6ca1\u6709\u4efb\u4f55\u5206\u652f\uff0c\u4e00\u5b9a\u4f1a\u6267\u884c\u3002\u5f53\u7136\uff0c\u4e2d\u65ad\u5f00\u5173\u7684\u524d\u540e\u8fd8\u6d89\u53ca\u5404\u7c7b\u8d44\u6e90\u7684\u52a0\u9501\u548c\u91ca\u653e\uff0c\u786e\u4fdd\u8c03\u5ea6\u5668\u5728\u591a\u6838\u73af\u5883\u4e0b\u7684\u6b63\u786e\u6027\u3002\u5173\u4e8e\u4e2d\u65ad\u5f00\u5173\u548c\u9501\u7684\u7ec6\u8282\u5c06\u5728\u4e0b\u4e00\u7bc7\u6587\u7ae0\u4e2d\u5c55\u5f00\u3002</p> <p>Success</p> <p>\u81f3\u6b64\uff0c\u6211\u4eec\u7406\u6e05\u4e86 Linux \u8c03\u5ea6\u5668\u7684\u5165\u53e3\u548c\u4e0a\u4e0b\u6587\u5207\u6362\u7684\u4e2d\u65ad\u7ba1\u7406\u903b\u8f91\u3002</p>"},{"location":"ta/blog/1.pid0/#linux-\u6e90\u7801\u9605\u8bfb\u4e0e\u8c03\u8bd5","title":"Linux \u6e90\u7801\u9605\u8bfb\u4e0e\u8c03\u8bd5","text":"<p>\u5b9e\u8bdd\u8bf4\uff0cLinux \u53d1\u5c55\u5230\u4eca\u5929\u8fd9\u4e2a\u7a0b\u5ea6\uff0c\u5373\u4f7f\u501f\u52a9 Clangd \u7b49\u5de5\u5177\u7684\u8bed\u6cd5\u5206\u6790\uff08\u5982\u8c03\u7528\u94fe\u3001\u53d8\u91cf\u8ffd\u8e2a\u7b49\uff09\uff0c\u624b\u6495\u6e90\u7801\u4e5f\u5e76\u4e0d\u5bb9\u6613\u3002\u4e0a\u6587\u4e2d\uff0c\u5bfb\u627e\u4e0a\u4e0b\u6587\u5207\u6362\u540e\u4e2d\u65ad\u7684\u5f00\u542f\u4f4d\u7f6e\u82b1\u8d39\u4e86\u7b14\u8005\u5927\u91cf\u7684\u65f6\u95f4\u3002\u6700\u7ec8\u7b14\u8005\u4e0d\u662f\u901a\u8fc7\u9605\u8bfb\u6e90\u7801\uff0c\u800c\u662f\u901a\u8fc7\u8c03\u8bd5\u5668\u89c2\u6d4b\u5bc4\u5b58\u5668\u7684\u53d8\u5316\uff0c\u624d\u627e\u5230 <code>local_irq_enable()</code> \u88ab\u8c03\u7528\u7684\u4f4d\u7f6e\u3002</p> <pre><code>watch ($sstatus &amp; 0x2) &gt;&gt; 1\n</code></pre> <p>\u5176\u5b9e\u8bbe\u7f6e\u8fd9\u4e2a\u6761\u4ef6\u65ad\u70b9\u540e\uff0cGDB \u7ed9\u51fa\u7684\u4f4d\u7f6e\u6307\u5411\u4e86 <code>fire_sched_in_preempt_notifiers()</code>\uff0c\u5e76\u4e0d\u6b63\u786e\uff0c\u504f\u540e\u4e86\u4e00\u4e9b\u3002\u6211\u63a8\u6d4b\u8fd9\u53ef\u80fd\u662f\u56e0\u4e3a QEMU \u7684 JIT \u4f18\u5316\u5bfc\u81f4\u4e00\u4e9b\u6307\u4ee4\u88ab\u5408\u5e76\u6267\u884c\uff0cGDB \u65e0\u6cd5\u7cbe\u786e\u5730\u5b9a\u4f4d\u5230 <code>watch</code> \u53d1\u751f\u53d8\u5316\u7684\u6307\u4ee4\u3002\u4f46\u8fd9\u5f88\u5927\u7a0b\u5ea6\u4e0a\u7f29\u5c0f\u4e86\u68c0\u67e5\u8303\u56f4\u3002\u901a\u8fc7\u8ba9 AI \u68c0\u67e5\u6307\u5b9a\u8303\u56f4\u7684\u4ee3\u7801\u627e\u5230\u4e86\u8c03\u7528\u4f4d\u7f6e\uff0c\u5e76\u501f\u52a9 Clangd \u7406\u6e05\u4e86\u8c03\u7528\u94fe\uff1a</p> <pre><code>finish_task_switch() -&gt; finish_lock_switch() -&gt; raw_spin_rq_unlock_irq -&gt; local_irq_enable()\n</code></pre>"},{"location":"ta/blog/1.pid0/#lab2-\u91cd\u6784\u5386\u7a0b","title":"Lab2 \u91cd\u6784\u5386\u7a0b","text":""},{"location":"ta/blog/1.pid0/#\u8001\u5b9e\u9a8c\u6846\u67b6\u7684\u4e0d\u8db3","title":"\u8001\u5b9e\u9a8c\u6846\u67b6\u7684\u4e0d\u8db3","text":"<ul> <li>\u4efb\u52a1\u662f\u9759\u6001\u7684\uff1a\u5728 <code>task_init()</code> \u4e2d\u521b\u5efa\u597d\u6240\u6709\u4efb\u52a1\uff0c\u4e0d\u652f\u6301\u52a8\u6001\u521b\u5efa\u548c\u9500\u6bc1\u4efb\u52a1\u3002</li> <li>\u672c\u8d28\u4e0a\u6ca1\u6709\u5b9e\u73b0\u5185\u6838\u62a2\u5360\uff08kenrel preemption\uff09\u3002\u8001\u5b9e\u9a8c\u6846\u67b6\u4e0d\u652f\u6301\u4e0a\u8ff0\u7684\u4efb\u52a1\u52a8\u6001\u7ba1\u7406\uff0c\u4e5f\u6ca1\u6709\u9700\u8981\u5171\u4eab\u8bbf\u95ee\u7684\u6570\u636e\u7ed3\u6784\uff08\u6bd4\u5982\u4efb\u52a1\u4fdd\u5b58\u4e3a\u56fa\u5b9a\u7684\u6570\u7ec4\uff09\uff0c\u81ea\u7136\u4e0d\u5b58\u5728\u4e34\u754c\u533a\uff0c\u4e5f\u4e0d\u9700\u8981\u89e3\u51b3\u5185\u6838\u62a2\u5360\u5bfc\u81f4\u7684\u590d\u6742\u95ee\u9898\u3002</li> </ul> <p>\u7b14\u8005\u8ba4\u4e3a\u4e0a\u9762\u4e24\u4e2a\u4e0d\u8db3\u5bfc\u81f4 Lab2 \u4e0e\u7406\u8bba\u8bfe\u4e25\u91cd\u8131\u8282\uff0c\u540c\u5b66\u4eec\u65e0\u6cd5\u5728\u5b9e\u9a8c\u4e2d\u4f53\u4f1a\u5230\u8fdb\u7a0b\u540c\u6b65\u3001\u4e34\u754c\u533a\u4fdd\u62a4\u3001\u5185\u6838\u62a2\u5360\u7b49\u91cd\u8981\u6982\u5ff5\uff0c\u4e5f\u65e0\u6cd5\u8ba4\u8bc6\u5230\u5b9e\u9645\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u8c03\u5ea6\u5668\u3001\u8c03\u5ea6\u7b97\u6cd5\u7684\u590d\u6742\u6027\u3002</p>"},{"location":"ta/blog/1.pid0/#\u573a\u666f\u4e0e\u8c03\u5ea6\u7b97\u6cd5\u7684\u9009\u62e9","title":"\u573a\u666f\u4e0e\u8c03\u5ea6\u7b97\u6cd5\u7684\u9009\u62e9","text":"<p>\u6700\u5f00\u59cb\u6211\u6ca1\u60f3\u7740\u6362\u8c03\u5ea6\u7b97\u6cd5\uff0c\u4e8e\u662f\u9009\u62e9\u4e86 PPT \u4e0a\u7684\u4f18\u5148\u7ea7\u8c03\u5ea6\u9898\u76ee\uff1a</p> Process Arrival Time Burst Time Priority P1 0 10 3 P2 1 1 1 ... ... ... ... <p>\u4f46\u4f18\u5148\u7ea7\u8c03\u5ea6\u7b97\u6cd5\u5b58\u5728\u9965\u997f\u3001\u4e0d\u516c\u5e73\u7b49\u95ee\u9898\uff0c\u65e0\u6cd5\u4e0e <code>kthread</code> \u7684\u52a8\u6001\u521b\u5efa\u673a\u5236\u5f88\u597d\u5730\u7ed3\u5408\u3002\u7b14\u8005\u6700\u521d\u5c1d\u8bd5\u4e86\u4e00\u4e0b\u4f18\u5148\u7ea7\u8c03\u5ea6\uff0c\u7ed3\u679c\u9700\u8981\u5728\u5404\u79cd\u5730\u65b9\u6dfb\u52a0\u4e3b\u52a8\u8c03\u5ea6\u3001\u6307\u5b9a\u5207\u6362\u7684\u903b\u8f91\uff0c\u8fd8\u9700\u8981\u5408\u7406\u5730\u5b89\u6392\u4efb\u52a1\u7684\u4f18\u5148\u7ea7\uff0c\u624d\u80fd\u8ba9\u5b9e\u9a8c\u7ed3\u679c\u7b26\u5408\u9884\u671f\u3002\u8fd9\u4e9b\u8bbe\u8ba1\u975e\u5e38 tricky\uff0c\u8ba9\u6574\u4e2a\u5b9e\u9a8c\u6846\u67b6\u53d8\u5f97\u96be\u4ee5\u7406\u89e3\u3002</p> <p>\u8ba8\u8bba\u540e\u6211\u4eec\u53d1\u73b0\u4f18\u5148\u7ea7\u5bf9 <code>kthread</code> \u6765\u8bf4\u662f\u6700\u5927\u7684\u95ee\u9898\u3002\u53c2\u8003 Linux \u7684 CFS \u4ee5\u516c\u5e73\u4e3a\u76ee\u6807\uff0c\u6211\u4eec\u51b3\u5b9a\u6539\u7528\u65f6\u95f4\u7247\u8f6e\u8f6c\uff08Round Robin\uff09\u8c03\u5ea6\u7b97\u6cd5\u3002</p>"},{"location":"ta/blog/1.pid0/#\u91cd\u6784\u5386\u7a0b","title":"\u91cd\u6784\u5386\u7a0b","text":"<p>\u6211\u4eec\u4ece 10 \u6708 6 \u65e5\u5f00\u59cb\u91cd\u6784 Lab2\uff0c\u76f4\u5230 10 \u6708 10 \u65e5\u7ec8\u4e8e\u7406\u6e05\u695a RISC-V \u67b6\u6784\u4e0b Linux \u5982\u4f55\u5728\u5207\u6362\u8fdb\u7a0b\u4e0a\u4e0b\u6587\u3001Trap \u5904\u7406\u7684\u8fc7\u7a0b\u4e2d\u7ba1\u7406\u5bc4\u5b58\u5668\u3001\u6808\u3001\u4e2d\u65ad\u7b49\u7ec6\u8282\u95ee\u9898\uff0c\u5269\u4e0b\u7684\u4e24\u5929\u9002\u914d\u8c03\u5ea6\u7b97\u6cd5\u548c\u8bc4\u6d4b\uff0c\u6700\u7ec8\u5728 10 \u6708 12 \u65e5\u53d1\u5e03\u4e86 Lab2\u3002\u4f46\u53d1\u5e03\u65f6\u6ca1\u6709\u5bdf\u89c9\u5230\u540c\u6b65\u95ee\u9898\uff0c\u53d1\u5e03\u540e\u7684\u4e00\u5468\u4e3a\u6b64\u66f4\u65b0\u4e86\u597d\u591a\u6b21\u4fee\u590d\u3002\u540c\u6b65\u95ee\u9898\u5c06\u5728\u4e0b\u4e00\u7bc7\u6587\u7ae0\u4ecb\u7ecd\u3002</p>"},{"location":"ta/blog/1.pid0/#\u81f4\u8c22","title":"\u81f4\u8c22","text":"<p>\u8981\u7406\u6e05 Linux \u8fdb\u7a0b\u7ba1\u7406\u7684\u7ec6\u8282\u5b9e\u5728\u662f\u4e0d\u5bb9\u6613\u3002\u611f\u8c22 @hharryz \u4e00\u8d77\u68b3\u7406\u601d\u8def\u3001\u91cd\u6784 Lab\uff0c\u611f\u8c22 @yoolc \u4e00\u8d77\u8ba8\u8bba\u548c\u5ba1\u6838\u6587\u6863\uff0c\u4ee5\u53ca @mrhaoxx \u63d0\u4f9b\u7684 VSCode GDB \u8c03\u8bd5\u7684\u914d\u7f6e\uff0c\u5e2e\u5927\u5fd9\u4e86\u3002</p>"},{"location":"ta/blog/2.sync/","title":"\u64cd\u4f5c\u7cfb\u7edf\u5c0f\u8bb0\uff08\u4e8c\uff09\uff1a\u5185\u6838\u540c\u6b65\u65b9\u6cd5","text":""},{"location":"ta/blog/2.sync/#\u64cd\u4f5c\u7cfb\u7edf\u5c0f\u8bb0\u4e8c\u5185\u6838\u540c\u6b65\u65b9\u6cd5","title":"\u64cd\u4f5c\u7cfb\u7edf\u5c0f\u8bb0\uff08\u4e8c\uff09\uff1a\u5185\u6838\u540c\u6b65\u65b9\u6cd5","text":"<p>\u672c\u6b21\u4e3a Lab 2 \u5f15\u5165\u94fe\u8868\u3001\u5185\u6838\u62a2\u5360\u65f6\uff0c\u5b8c\u5168\u5ffd\u7565\u4e86\u5355\u6838\u7cfb\u7edf\u4e2d\u7684\u4f2a\u5e76\u53d1\u95ee\u9898\uff0c\u5bfc\u81f4 Lab 2 \u53d1\u5e03\u7684\u4ee3\u7801\u5b58\u5728\u4e25\u91cd\u7684 \u7ade\u6001\u6761\u4ef6\uff08Race Condition\uff09\u6f0f\u6d1e\u3002\u672c\u6587\u63a2\u8ba8\u5982\u4f55\u5728\u5185\u6838\u4e2d\u5b9e\u73b0\u6709\u6548\u7684\u540c\u6b65\u673a\u5236\uff0c\u4ee5\u907f\u514d\u6b64\u7c7b\u95ee\u9898\u7684\u53d1\u751f\u3002\u672c\u6587\u53c2\u8003\u4e86\u300aLinux Kernel Development\u300b\u7b2c\u4e09\u7248\u7b2c 9\u300110 \u7ae0\u7684\u5f88\u591a\u5185\u5bb9\u3002</p>"},{"location":"ta/blog/2.sync/#\u95ee\u9898\u80cc\u666f\u548c\u5206\u6790","title":"\u95ee\u9898\u80cc\u666f\u548c\u5206\u6790","text":"<p>\u8fd9\u91cc\u6211\u76f4\u63a5\u6458\u5f55 Linux Kernel Development \u7684\u7ae0\u8282\u3002</p>"},{"location":"ta/blog/2.sync/#causes-of-concurrency","title":"Causes of Concurrency","text":"<p>In user-space, the need for synchronization stems from the fact that programs are scheduled preemptively at the will of the scheduler. Because a process can be preempted at any time and another process can be scheduled onto the processor, a process can be involuntarily preempted in the middle of accessing a critical region.</p> <p>If the newly scheduled process then enters the same critical region (say, if the two processes manipulate the same shared memory or write to the same file descriptor), a race condition can occur. The same problem can occur with multiple single-threaded processes sharing files, or within a single program with signals, because signals can occur asynchronously.</p> <p>This type of concurrency \u2014 in which two things do not actually happen at the same time but interleave with each other such that they might as well \u2014 is called pseudo-concurrency.</p> <p>If you have a symmetrical multiprocessing (SMP) machine, two processes can actually be executed in a critical region at the exact same time. That is called true concurrency. Although the causes and semantics of true versus pseudo concurrency are different, they both result in the same race conditions and require the same sort of protection.</p> <p>\u8fd9\u6bb5\u5185\u5bb9\u4ecb\u7ecd\u4e86\u4f2a\u5e76\u53d1\u548c\u771f\u5b9e\u5e76\u53d1\u7684\u6982\u5ff5\u3002\u5bf9\u4e8e\u672c\u8bfe\u7a0b\u5b9e\u9a8c\u7684\u5355\u6838\u7cfb\u7edf\u6765\u8bf4\uff0c\u53ea\u5b58\u5728\u4f2a\u5e76\u53d1\u7684\u95ee\u9898\u3002</p>"},{"location":"ta/blog/2.sync/#causes-of-concurrency-in-the-kernel","title":"Causes of Concurrency in the Kernel","text":"<p>The kernel has similar causes of concurrency:</p> <ul> <li>Interrupts \u2014 An interrupt can occur asynchronously at almost any time, interrupting the currently executing code.</li> <li>Softirqs and tasklets \u2014 The kernel can raise or schedule a softirq or tasklet at almost any time, interrupting the currently executing code.</li> <li>Kernel preemption \u2014 Because the kernel is preemptive, one task in the kernel can preempt another.</li> <li>Sleeping and synchronization with user-space \u2014 A task in the kernel can sleep and thus invoke the scheduler, resulting in the running of a new process.</li> <li>Symmetrical multiprocessing \u2014 Two or more processors can execute kernel code at exactly the same time.</li> </ul> <p>Kernel developers need to understand and prepare for these causes of concurrency.</p> <p>It is a major bug if:</p> <ul> <li>An interrupt occurs in the middle of code manipulating a resource, and the interrupt handler can access the same resource.</li> <li>Kernel code is preempted while accessing shared resources.</li> <li>Kernel code sleeps while inside a critical section.</li> <li>Two processors simultaneously access the same piece of data.</li> </ul> <p>With a clear picture of what data needs protection, it is not hard to provide the locking needed to keep the system stable. The hard part is identifying these conditions and realizing that to prevent concurrency, you need some form of protection.</p> <p>\u8fd9\u6bb5\u5185\u5bb9\u4ecb\u7ecd\u4e86\u5185\u6838\u4e2d\u53ef\u80fd\u5f15\u53d1\u5e76\u53d1\u7684\u51e0\u79cd\u60c5\u51b5\uff1a\u4e2d\u65ad\u3001\u8f6f\u4e2d\u65ad\u548c\u4efb\u52a1\u3001\u5185\u6838\u62a2\u5360\u3001\u7761\u7720\u548c\u7528\u6237\u7a7a\u95f4\u7684\u540c\u6b65\u3001\u591a\u6838\u7cfb\u7edf\u7b49\uff0c\u5e76\u4e14\u4e3e\u4f8b\u8bf4\u660e\u4e86\u53ef\u80fd\u5f15\u53d1\u7ade\u6001\u6761\u4ef6\u7684\u51e0\u79cd\u60c5\u51b5\u3002</p>"},{"location":"ta/blog/2.sync/#lab2-\u7684\u7ade\u6001\u6761\u4ef6\u95ee\u9898","title":"Lab2 \u7684\u7ade\u6001\u6761\u4ef6\u95ee\u9898","text":"<p>Lab 2 \u5f15\u5165\u7684\u94fe\u8868\u88ab\u5e7f\u6cdb\u7528\u4e8e\u5404\u79cd\u5185\u6838\u6570\u636e\u7ed3\u6784\u4e2d\uff0c\u4f8b\u5982\u8fdb\u7a0b\u7ba1\u7406\u4e2d\u7684\u5c31\u7eea\u961f\u5217\u548c\u5185\u6838\u7ebf\u7a0b\u7684\u521b\u5efa\u961f\u5217\u3002\u5728 Lab 2 \u521d\u59cb\u53d1\u5e03\u65f6\uff0c\u6211\u4eec\u4ec5\u8003\u8651\u4e86\u4e0a\u4e0b\u6587\u7684\u4fdd\u5b58\u4e0e\u6062\u590d\u8fc7\u7a0b\uff08\u5982 Trap \u5904\u7406\u8fc7\u7a0b\u3001<code>__switch_to</code>\uff09\u662f\u4e0d\u53ef\u4e2d\u65ad\u7684\uff0c\u5ffd\u7565\u4e86\u5171\u4eab\u6570\u636e\u7ed3\u6784\u5982 <code>kmem_cache</code>\u3001\u5404\u5904\u7684\u94fe\u8868\u7b49\u5728\u5e76\u53d1\u8bbf\u95ee\u65f6\u53ef\u80fd\u5f15\u53d1\u7684\u7ade\u6001\u6761\u4ef6\u95ee\u9898\u3002</p> <p>\u8003\u8651\u5230\u5b9e\u9a8c\u73af\u5883\u4e3a\u5355\u6838\u7cfb\u7edf\uff0c\u552f\u4e00\u7684\u5e76\u53d1\u6765\u6e90\u662f\u4e0d\u540c\u7ebf\u7a0b\u7684\u4ea4\u9519\u6267\u884c\u800c\u975e\u540c\u65f6\u6267\u884c\uff0c\u56e0\u6b64\u6211\u4eec\u6ca1\u6709\u9009\u62e9\u5b9e\u73b0\u9501\uff0c\u800c\u662f\u901a\u8fc7\u5f00\u5173\u4e2d\u65ad\u7684\u65b9\u5f0f\u6765\u5b9e\u73b0\u540c\u6b65\u63a7\u5236\u3002</p> <p>\u6700\u5f00\u59cb\uff0c\u6211\u4eec\u76f4\u63a5\u5728\u4e34\u754c\u533a\u524d\u540e\u5f00\u5173\u4e2d\u65ad\u3002\u7136\u800c\u8fd9\u53ef\u80fd\u9047\u5230\u4e34\u754c\u533a\u5d4c\u5957\u7684\u95ee\u9898\uff1a\u5982\u679c\u5728\u4e00\u4e2a\u5df2\u7ecf\u5173\u95ed\u4e2d\u65ad\u7684\u4e34\u754c\u533a\u5185\u518d\u6b21\u5173\u95ed\u4e2d\u65ad\uff0c\u540e\u7eed\u7684\u5f00\u542f\u64cd\u4f5c\u4f1a\u9519\u8bef\u5730\u91cd\u65b0\u5f00\u542f\u4e2d\u65ad\uff0c\u5bfc\u81f4\u4e4b\u524d\u7684\u4e34\u754c\u533a\u4fdd\u62a4\u5931\u6548\u3002\u6700\u7ec8\uff0c\u6211\u4eec\u91c7\u7528\u4e86 Linux \u5185\u6838\u4e2d\u7684 <code>local_irq_save()</code> \u548c <code>local_irq_restore()</code> \u65b9\u6cd5\u6765\u5904\u7406\u4e34\u754c\u533a\u5d4c\u5957\u7684\u95ee\u9898\u3002</p>"},{"location":"ta/blog/2.sync/#linux-\u7684\u540c\u6b65\u63a7\u5236","title":"Linux \u7684\u540c\u6b65\u63a7\u5236","text":"<p>Linux \u5185\u6838\u63d0\u4f9b\u7684\u540c\u6b65\u57fa\u7840\u8bbe\u7f6e\u4e0d\u518d\u4ecb\u7ecd\uff1a</p> <ul> <li>\u539f\u5b50\u64cd\u4f5c</li> <li>\u9501\uff1a<ul> <li>\u81ea\u65cb\u9501\uff08Spinlock\uff09</li> <li>\u4e92\u65a5\u9501\uff08Mutex\uff09</li> <li>\u8bfb\u5199\u9501\uff08RW Lock\uff09</li> <li>\u672c\u5730\u9501\uff08Local Lock\uff09\uff1a\u7528\u4e8e\u4fdd\u62a4 per CPU \u6570\u636e</li> </ul> </li> <li>RCU</li> </ul> <p>\u6211\u4eec\u76f4\u63a5\u5f00\u59cb\u5206\u6790\u5185\u6838\u4e2d\u7684\u540c\u6b65\u63a7\u5236\u5b9e\u4f8b\u3002</p>"},{"location":"ta/blog/2.sync/#\u4e34\u754c\u533a\u5d4c\u5957\u5904\u7406","title":"\u4e34\u754c\u533a\u5d4c\u5957\u5904\u7406","text":"<p>\u672c\u8282\u7684\u5206\u6790\u53c2\u8003\u4e86 Four short stories about <code>preempt_count()</code>\u3002\u8fd9\u7bc7\u6587\u7ae0\u4ecb\u7ecd\u4e86\u5185\u6838\u5f00\u53d1\u8005\u5173\u4e8e\u5185\u6838\u4ee3\u7801\u5728\u4e0d\u540c\u4e0a\u4e0b\u6587\u4e2d\u884c\u4e3a\u8bbe\u8ba1\u7684\u4e89\u8bba\uff0c\u503c\u5f97\u4e00\u8bfb\u3002</p> <p>\u5185\u6838\u7684\u5e76\u53d1\u6765\u6e90\u4f17\u591a\uff0c\u4e34\u754c\u533a\u7c7b\u578b\u4e5f\u4e0d\u540c\u3002\u4e3a\u4e86\u6b63\u786e\u5904\u7406\u4e34\u754c\u533a\u7684\u5d4c\u5957\uff0cLinux \u5185\u6838\u4e3a\u6bcf\u4e2a Task \u8bbe\u7f6e\u4e86\u8ba1\u6570\u5668\uff0c\u5206\u522b\u8ffd\u8e2a\uff1a</p> <ul> <li>Preempt \u7981\u7528\u7684\u5d4c\u5957\u5c42\u6570</li> <li>\u88ab\u8f6f\u4ef6\u3001\u786c\u4ef6\u548c NMI \u4e2d\u65ad\u7981\u7528\u7684\u5d4c\u5957\u5c42\u6570</li> </ul> <p>\u4e0e\u6b64\u76f8\u5173\u7684\u4e00\u5806\u8f85\u52a9\u51fd\u6570\u5982\u4e0b\uff1a</p> <pre><code>preempt_count()\nin_hardirq()\nin_nmi()\nirqs_disabled()\n...\n</code></pre> <p>\u901a\u8fc7\u8fd9\u4e2a\u8ba1\u6570\u5668\uff0c\u5185\u6838\u53ef\u4ee5\u6b63\u786e\u5730\u5904\u7406\u4e0d\u540c\u7c7b\u578b\u4e34\u754c\u533a\u7684\u5d4c\u5957\u95ee\u9898\u3002</p>"},{"location":"ta/blog/2.sync/#slab","title":"Slab","text":"<ul> <li> <p>Create\uff1a</p> <p>\u56e0\u8be5\u64cd\u4f5c\u53ef\u80fd\u66f4\u6539 Slab \u5206\u914d\u5668\u591a\u5c42\u6b21\u7684\u6570\u636e\u7ed3\u6784\uff0c\u4f7f\u7528\u4e92\u65a5\u9501\u4fdd\u62a4\u6574\u4e2a\u64cd\u4f5c\u8fc7\u7a0b\u3002</p> mm/slab_common.c<pre><code>struct kmem_cache *__kmem_cache_create_args(const char *name,\n        unsigned int object_size,\n        struct kmem_cache_args *args,\n        slab_flags_t flags)\n{\n    mutex_lock(&amp;slab_mutex);\n    //...\n    goto out_unlock;\nout_unlock:\n    mutex_unlock(&amp;slab_mutex);\n    return s;\n}\n</code></pre> </li> <li> <p>Alloc\uff1a\u652f\u6301\u5feb\u901f\u548c\u6162\u901f\u4e24\u6761\u8def\u5f84</p> <pre><code>kmem_cache_alloc()\n\u2192 slab_alloc_node()\n</code></pre> <ul> <li> <p>\u5feb\u901f\u8def\u5f84\uff1a</p> <pre><code>kfence_alloc()\n</code></pre> <p>\u4f7f\u7528\u539f\u5b50\u64cd\u4f5c\u5206\u914d\u672c\u5730 CPU \u7684\u7f13\u5b58\u5bf9\u8c61\uff0c\u65e0\u9700\u9501\u3002</p> </li> <li> <p>\u6162\u901f\u8def\u5f84\uff1a</p> <pre><code>__slab_alloc_node()\n\u2192 __slab_alloc()\n\u2192 ___slab_alloc()\n</code></pre> <p>Slab \u7f13\u5b58\u4e2d\u6709\u4e00\u4e9b per CPU \u6570\u636e\uff0c\u56e0\u6b64\u540c\u65f6\u63a7\u5236 Local Lock \u548c\u4e2d\u65ad\u6765\u9632\u6b62\u76f8\u540c CPU \u4e0a\u7684\u5e76\u53d1\u8bbf\u95ee\u3002</p> mm/slub.c<pre><code>local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);\nfreelist = get_freelist(s, slab);\nlockdep_assert_held(this_cpu_ptr(&amp;s-&gt;cpu_slab-&gt;lock));\nc-&gt;freelist = get_freepointer(s, freelist);\nlocal_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);\nreturn freelist;\n</code></pre> <p>\u5176\u4e2d\u7684 <code>get_freelist()</code> \u5185\u5bf9\u5168\u5c40/\u8282\u70b9\u7684 partial/full slab list \u52a0\u81ea\u65cb\u9501\uff0c\u9632\u6b62\u591a CPU \u5e76\u53d1\u4fee\u6539 slab \u5217\u8868\u3002</p> mm/slub.c<pre><code>bit_spin_lock(PG_locked, &amp;slab-&gt;__page_flags);\n</code></pre> </li> </ul> </li> </ul>"},{"location":"ta/blog/2.sync/#\u8c03\u5ea6","title":"\u8c03\u5ea6","text":"<p>\u8c03\u5ea6\u5668\u4e2d\u4e3b\u8981\u4fdd\u62a4\u5c31\u7eea\u961f\u5217\uff08Runqueue\uff09\u3002\u6bcf\u4e2a CPU \u6709\u4e00\u4e2a\u72ec\u7acb\u7684\u5c31\u7eea\u961f\u5217\uff0c\u7528\u4e8e\u5b58\u653e\u8be5 CPU \u4e0a\u53ef\u8fd0\u884c\u7684\u8fdb\u7a0b\u3002</p> <p><code>__schedule()</code> \u4e2d\u4f7f\u7528\u81ea\u65cb\u9501\u4fdd\u62a4\u5c31\u7eea\u961f\u5217\uff1a</p> kernel/sched/core.c<pre><code>rq_lock(rq, &amp;rf);\n</code></pre> kernel/sched/sched.h<pre><code>static inline void rq_lock(struct rq *rq, struct rq_flags *rf)\n    __acquires(rq-&gt;lock)\n{\n    raw_spin_rq_lock(rq);\n    rq_pin_lock(rq, rf);\n}\n</code></pre> <p>\u5728\u4e0a\u4e0b\u6587\u5207\u6362\uff08<code>context_switch()</code>\uff09\u5b8c\u6210\u540e\u7684 <code>finish_task_switch()</code> \u4e2d\u91ca\u653e\u9501\uff1a</p> kernel/sched/core.c<pre><code>finish_lock_switch(rq);\n</code></pre> <p>\u4e2d\u65ad\u4e5f\u505a\u4e86\u76f8\u5e94\u63a7\u5236\uff0c\u5728\u524d\u4e00\u7bc7\u6587\u7ae0\u4e2d\u4ecb\u7ecd\u8fc7\u3002</p>"},{"location":"ta/blog/3.stack_unwind/","title":"\u64cd\u4f5c\u7cfb\u7edf\u5c0f\u8bb0\uff08\u4e09\uff09\uff1a\u51fd\u6570\u5e8f\u8a00\u3001\u8c03\u8bd5\u5668\u65ad\u70b9\u4e0e\u5806\u6808\u56de\u6eaf","text":""},{"location":"ta/blog/3.stack_unwind/#\u64cd\u4f5c\u7cfb\u7edf\u5c0f\u8bb0\u4e09\u51fd\u6570\u5e8f\u8a00\u8c03\u8bd5\u5668\u65ad\u70b9\u4e0e\u5806\u6808\u56de\u6eaf","title":"\u64cd\u4f5c\u7cfb\u7edf\u5c0f\u8bb0\uff08\u4e09\uff09\uff1a\u51fd\u6570\u5e8f\u8a00\u3001\u8c03\u8bd5\u5668\u65ad\u70b9\u4e0e\u5806\u6808\u56de\u6eaf","text":"<p>\u8c03\u8bd5 OS \u5b9e\u9a8c\u4ee3\u7801\u65f6\uff0c\u5806\u6808\u56de\u6eaf\uff08stack unwind\uff09\u662f\u4e00\u4e2a\u975e\u5e38\u6709\u7528\u7684\u5de5\u5177\u3002\u6bd4\u5982\uff0c\u5982\u679c\u80fd\u5728 Trap \u5904\u7406\u65f6\u8ffd\u8e2a\u88ab\u6253\u65ad\u7684\u51fd\u6570\u8c03\u7528\u6808\uff0c\u5c31\u80fd\u66f4\u5bb9\u6613\u5730\u5b9a\u4f4d\u95ee\u9898\u3002\u7136\u800c\uff0c\u56e0\u4e3a OS \u5b9e\u9a8c\u4ee3\u7801\u6df7\u6709\u6c47\u7f16\uff0c\u60f3\u5b9e\u73b0\u5806\u6808\u56de\u6eaf\u9700\u8981\u4e00\u4e9b\u989d\u5916\u7684\u5de5\u4f5c\u3002</p> <p>\u672c\u8282\u6d89\u53ca\u7684\u77e5\u8bc6\u5728\u300a\u7f16\u8bd1\u539f\u7406\u300b\u8bfe\u7a0b\u4e2d\u4e5f\u4f1a\u7528\u5230\u3002</p>"},{"location":"ta/blog/3.stack_unwind/#\u6808\u5e27stack-frame","title":"\u6808\u5e27\uff08Stack Frame\uff09","text":"<p>\u5728\u7a0b\u5e8f\u8fd0\u884c\u65f6\uff0c\u6bcf\u4e00\u6b21\u51fd\u6570\u8c03\u7528\u90fd\u4f1a\u5728\u5185\u5b58\u7684\u6808\uff08stack\uff09\u4e0a\u5206\u914d\u4e00\u5757\u533a\u57df\uff0c\u7528\u6765\u4fdd\u5b58\u8be5\u51fd\u6570\u6267\u884c\u6240\u9700\u7684\u4e0a\u4e0b\u6587\u4fe1\u606f\uff0c\u8fd9\u5757\u533a\u57df\u5c31\u53eb\u505a\u4e00\u4e2a\u6808\u5e27\uff08stack frame\uff09\u3002</p> <p>\u4e00\u4e2a\u5178\u578b\u7684\u6808\u5e27\u901a\u5e38\u5305\u542b\u4ee5\u4e0b\u51e0\u7c7b\u5185\u5bb9\uff1a</p> <ol> <li>\u8fd4\u56de\u5730\u5740\uff08Return Address\uff09\uff1a\u51fd\u6570\u6267\u884c\u5b8c\u6bd5\u540e\u8981\u8df3\u56de\u7684\u4f4d\u7f6e\u3002</li> <li>\u524d\u4e00\u4e2a\u5e27\u6307\u9488\uff08Old Frame Pointer\uff09\uff1a\u4fdd\u5b58\u8c03\u7528\u8005\u51fd\u6570\u7684\u5e27\u6307\u9488\uff0c\u7528\u4e8e\u6062\u590d\u4e0a\u5c42\u6808\u7684\u72b6\u6001\u3002</li> <li>\u5c40\u90e8\u53d8\u91cf\uff08Local Variables\uff09\uff1a\u5f53\u524d\u51fd\u6570\u5185\u5b9a\u4e49\u7684\u53d8\u91cf\u3002</li> <li>\u88ab\u4fdd\u5b58\u7684\u5bc4\u5b58\u5668\uff08Saved Registers\uff09\uff1a\u5982\u679c\u5f53\u524d\u51fd\u6570\u4f7f\u7528\u4e86\u4e00\u4e9b\u9700\u8981\u4fdd\u62a4\u7684\u5bc4\u5b58\u5668\uff08\u5982 <code>s0</code>\u3001<code>rbx</code> \u7b49\uff09\uff0c\u4e5f\u4f1a\u628a\u5b83\u4eec\u7684\u65e7\u503c\u4fdd\u5b58\u5230\u6808\u4e2d\u3002</li> </ol> <p>RISC-V \u8c03\u7528\u7ea6\u5b9a\u5c31\u5177\u4f53\u63cf\u8ff0\u4e86\u6808\u5e27\u7684\u7ed3\u6784\u3002\u5176\u4e2d\uff0c\u6808\u5e27\u6307\u9488\uff08frame pointer\uff09\u4f5c\u4e3a\u53ef\u9009\u7684\u7ed3\u6784\uff1a</p> <p>The presence of a frame pointer is optional. If a frame pointer exists, it must reside in x8(s0); the register remains callee-saved.</p> <p>\u5f53\u4e00\u4e2a\u51fd\u6570\u88ab\u8c03\u7528\u65f6\uff0cCPU \u4f1a\uff1a</p> <ul> <li>\u628a\u8fd4\u56de\u5730\u5740\u538b\u5165\u6808\uff1b</li> <li>\u53ef\u80fd\u4fdd\u5b58\u65e7\u7684\u5e27\u6307\u9488\uff1b</li> <li>\u79fb\u52a8\u6808\u6307\u9488\uff08<code>sp</code>\uff09\u5206\u914d\u51fa\u5c40\u90e8\u53d8\u91cf\u7a7a\u95f4\uff1b</li> <li>\u66f4\u65b0\u5e27\u6307\u9488\uff08<code>fp</code> \u6216 <code>s0</code>\uff09\u3002</li> </ul> <p>\u5f53\u51fd\u6570\u8fd4\u56de\u65f6\uff0c\u6808\u5e27\u88ab\u9500\u6bc1\uff0c\u5bc4\u5b58\u5668\u548c\u6808\u6307\u9488\u6062\u590d\u5230\u8c03\u7528\u524d\u7684\u72b6\u6001\u3002</p>"},{"location":"ta/blog/3.stack_unwind/#\u5806\u6808\u56de\u6eafstack-unwinding","title":"\u5806\u6808\u56de\u6eaf\uff08Stack Unwinding\uff09","text":"<p>\u5806\u6808\u56de\u6eaf\uff08\u6216\u79f0\u201c\u6808\u56de\u6eaf\u201d\u3001\u201cstack trace\u201d\uff09\u662f\u8c03\u8bd5\u5668\u3001\u5f02\u5e38\u5904\u7406\u5668\u7b49\u5de5\u5177\u7684\u4e00\u79cd\u673a\u5236\uff0c\u7528\u6765\u4ece\u5f53\u524d\u51fd\u6570\u9010\u7ea7\u5411\u4e0a\u6062\u590d\u8c03\u7528\u8def\u5f84\u3002\u4f8b\u5982\uff0c\u5728\u7a0b\u5e8f\u5d29\u6e83\u65f6\uff0c\u8c03\u8bd5\u5668\u901a\u8fc7\u8bfb\u53d6\u6bcf\u4e00\u5c42\u51fd\u6570\u7684\u6808\u5e27\uff0c\u5c31\u80fd\u663e\u793a\u51fa\u8c03\u7528\u94fe\uff1a</p> <pre><code>#0  crash() at main.c:42\n#1  do_work() at worker.c:18\n#2  main() at main.c:10\n</code></pre> <p>\u4e3a\u4e86\u5b9e\u73b0\u8fd9\u79cd\u80fd\u529b\uff0c\u8c03\u8bd5\u5668\u9700\u8981\u77e5\u9053\uff1a</p> <ul> <li>\u5f53\u524d\u51fd\u6570\u7684\u6808\u5e27\u5728\u5185\u5b58\u4e2d\u7684\u4f4d\u7f6e\uff1b</li> <li>\u6bcf\u4e2a\u5bc4\u5b58\u5668\uff08\u5c24\u5176\u662f\u8fd4\u56de\u5730\u5740\u5bc4\u5b58\u5668\uff09\u7684\u4fdd\u5b58\u4f4d\u7f6e\uff1b</li> <li>\u5982\u4f55\u4ece\u5f53\u524d\u5e27\u6062\u590d\u5230\u4e0a\u4e00\u4e2a\u5e27\u3002</li> </ul> <p>\u8fd9\u4e9b\u4fe1\u606f\u53ef\u4ee5\u901a\u8fc7\u4e24\u79cd\u65b9\u5f0f\u83b7\u5f97\uff1a</p> <ol> <li>\u4f20\u7edf\u5e27\u6307\u9488\u6cd5\uff08frame-pointer unwinding\uff09\uff1a\u4f9d\u9760\u56fa\u5b9a\u5bc4\u5b58\u5668\uff08\u5982 <code>rbp</code>\u3001<code>s0</code>\uff09\u5f62\u6210\u94fe\u5f0f\u7ed3\u6784\uff0c\u6bcf\u4e00\u5e27\u90fd\u4fdd\u5b58\u4e0a\u4e00\u4e2a\u5e27\u6307\u9488\u3002</li> <li>CFI\uff08Call Frame Information\uff09\u6cd5\uff1a\u6c47\u7f16\u5668\u901a\u8fc7 <code>.cfi_*</code> \u6307\u4ee4\u5728\u76ee\u6807\u6587\u4ef6\u4e2d\u8bb0\u5f55\u6808\u5e27\u7ed3\u6784\u4fe1\u606f\uff0c\u8c03\u8bd5\u5668\u6216\u5f02\u5e38\u5904\u7406\u5668\u8bfb\u53d6 <code>.eh_frame</code> \u6216 <code>.debug_frame</code> \u6bb5\u4e2d\u7684 CFI \u6570\u636e\u6765\u91cd\u5efa\u8c03\u7528\u6808\u3002</li> </ol>"},{"location":"ta/blog/3.stack_unwind/#cfi-\u6c47\u7f16\u6307\u4ee4","title":"CFI \u6c47\u7f16\u6307\u4ee4","text":""},{"location":"ta/blog/3.stack_unwind/#\u51fd\u6570\u5e8f\u8a00","title":"\u51fd\u6570\u5e8f\u8a00","text":""},{"location":"ta/blog/4.board/","title":"\u64cd\u4f5c\u7cfb\u7edf\u5c0f\u8bb0\uff08\u56db\uff09\uff1a\u5185\u6838\u4e0a\u677f\u5386\u9669\u8bb0","text":""},{"location":"ta/blog/4.board/#\u64cd\u4f5c\u7cfb\u7edf\u5c0f\u8bb0\u56db\u5185\u6838\u4e0a\u677f\u5386\u9669\u8bb0","title":"\u64cd\u4f5c\u7cfb\u7edf\u5c0f\u8bb0\uff08\u56db\uff09\uff1a\u5185\u6838\u4e0a\u677f\u5386\u9669\u8bb0","text":"<p>\u5728\u672c\u6587\u5f00\u5934\uff0c\u9700\u8981\u5411\u63d0\u4f9b RISC-V \u5f00\u53d1\u7248\u7684 \u8fdb\u8fed\u65f6\u7a7a \u4ee5\u53ca\u63d0\u4f9b\u6307\u5bfc\u7684 @yoolc \u8868\u793a\u611f\u8c22\uff0c\u6ca1\u6709\u4ed6\u4eec\u5c31\u6ca1\u6709 OS \u5b9e\u9a8c\u4e0a\u677f\u7684\u53ef\u80fd\u3002</p>"},{"location":"ta/blog/4.board/#\u5f00\u53d1\u7248\u4ecb\u7ecd","title":"\u5f00\u53d1\u7248\u4ecb\u7ecd","text":""}]}